console.log('Test file is being loaded');

import { getCoverageSummary, getOutcomeCoverage } from '../utils/outcomeCoverage';

// Mock the prisma client
const mockQueryRaw = jest.fn();

jest.mock('../prisma', () => ({
  prisma: {
    $queryRaw: mockQueryRaw,
  },
}));

import { prisma } from '../prisma';

console.log('Prisma mock created');

type CoverageItem = {
  outcomeId: string;
  status: 'covered' | 'uncovered' | 'partial';
  linked: number;
  completed: number;
};

console.log('Starting test suite');

describe('Outcome Coverage', () => {
  beforeAll(() => {
    console.log('Before all tests');
  });

  afterAll(() => {
    console.log('After all tests');
  });
  describe('getCoverageSummary', () => {
    beforeEach(() => {
      console.log('Before getCoverageSummary test');
      jest.clearAllMocks();
    });

    it('should return correct summary for coverage data', () => {
      console.log('Running getCoverageSummary test');
      console.log('Running getCoverageSummary test');
      const coverage: CoverageItem[] = [
        { outcomeId: '1', status: 'covered', linked: 1, completed: 1 },
        { outcomeId: '2', status: 'uncovered', linked: 0, completed: 0 },
        { outcomeId: '3', status: 'partial', linked: 1, completed: 0 },
      ];
      
      const summary = getCoverageSummary(coverage);
      
      expect(summary).toEqual({
        total: 3,
        covered: 1,
        partial: 1,
        uncovered: 1,
      });
    });
  });

  describe('getOutcomeCoverage', () => {
    beforeEach(() => {
      console.log('Before getOutcomeCoverage test');
      jest.clearAllMocks();
    });

    it('should return uncovered status for outcome with no activities', async () => {
      console.log('Starting getOutcomeCoverage test');
      console.log('Running getOutcomeCoverage test');
      
      // Mock the database query to return no activities
      mockQueryRaw.mockImplementation((strings, ...values) => {
        // Verify the SQL template string and parameters
        expect(strings[0]).toContain('SELECT a.id, a."completedAt"');
        expect(strings[0]).toContain('FROM "Activity" a');
        expect(strings[0]).toContain('JOIN "ActivityOutcome" ao ON a.id = ao."activityId"');
        expect(strings[0]).toContain('WHERE ao."outcomeId" = ');
        expect(values[0]).toBe('TEST-1');
        return Promise.resolve([]);
      });
      
      const coverage = await getOutcomeCoverage('TEST-1');
      
      expect(coverage).toEqual({
        outcomeId: 'TEST-1',
        status: 'uncovered',
        linked: 0,
        completed: 0,
      });
      
      // Verify the query was called
      expect(mockQueryRaw).toHaveBeenCalled();
    });
  });
});
