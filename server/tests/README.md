# Database Transaction Isolation Testing System\n\nThis directory contains a comprehensive testing system that provides database transaction isolation, ensuring each test runs in complete isolation without affecting other tests.\n\n## Features\n\n- ✅ **Transaction Isolation**: Each test runs within its own transaction that is automatically rolled back\n- ✅ **Parallel Execution**: Tests can run concurrently without interference\n- ✅ **Test Data Factories**: Easy creation of test data with realistic relationships\n- ✅ **Connection Pooling**: Efficient database connection management\n- ✅ **Automatic Cleanup**: No manual cleanup required between tests\n- ✅ **Performance Optimized**: Uses SQLite WAL mode and optimized settings\n\n## File Structure\n\n```\nserver/tests/\n├── README.md              # This documentation\n├── setup-test-db.ts       # Database setup and management\n├── jest.setup.ts          # Jest hooks for transaction isolation\n├── factories.ts           # Test data factories\n├── test-utils.ts          # Testing utilities and helpers\n└── temp/                  # Temporary test databases (auto-cleaned)\n```\n\n## How It Works\n\n### 1. Database Isolation\n\nEach Jest worker gets its own isolated SQLite database:\n- **Per-worker databases**: `test_worker1_abc123.db`, `test_worker2_def456.db`, etc.\n- **Transaction savepoints**: Each test gets a savepoint that's rolled back after the test\n- **Automatic cleanup**: Database files are removed after all tests complete\n\n### 2. Transaction Lifecycle\n\n```\nbeforeAll()  → Create unique database for worker\nbeforeEach() → Create savepoint for test\n  [test runs]\nafterEach()  → Rollback to savepoint\nafterAll()   → Cleanup database files\n```\n\n### 3. Parallel Execution\n\nTests can run in parallel because:\n- Each worker has its own database file\n- SQLite WAL mode enables concurrent reads\n- Transactions provide write isolation\n\n## Usage\n\n### Basic Test Structure\n\n```typescript\nimport { describe, it, expect } from '@jest/globals';\nimport { getTestPrismaClient } from '../../tests/jest.setup';\nimport { factories } from '../../tests/factories';\n\ndescribe('My Feature', () => {\n  const prisma = getTestPrismaClient();\n\n  it('should create a subject', async () => {\n    const subject = await factories.subject.create({\n      name: 'Mathematics'\n    });\n    \n    expect(subject.id).toBeDefined();\n    expect(subject.name).toBe('Mathematics');\n  });\n\n  it('should not see data from previous test', async () => {\n    // This test runs in a fresh transaction\n    const subjects = await prisma.subject.findMany();\n    expect(subjects).toHaveLength(0);\n  });\n});\n```\n\n### Using Test Factories\n\n```typescript\nimport { factories, createTestScenario } from '../../tests/factories';\n\n// Create individual entities\nconst subject = await factories.subject.create();\nconst milestone = await factories.milestone.create({ subjectId: subject.id });\nconst activity = await factories.activity.create({ milestoneId: milestone.id });\n\n// Create bulk data\nconst subjects = await factories.subject.createMany(5);\n\n// Create complex scenarios\nconst scenario = await createTestScenario({\n  subjectCount: 2,\n  milestonesPerSubject: 3,\n  activitiesPerMilestone: 4,\n  outcomesPerActivity: 2\n});\n```\n\n### Using Test Utilities\n\n```typescript\nimport { createTestUtils, assertions } from '../../tests/test-utils';\n\nconst utils = createTestUtils();\n\n// Verify table counts\nawait utils.expectTableCount('Subject', 5);\n\n// Test within transactions (with automatic rollback)\nconst result = await utils.withTransaction(async (tx) => {\n  const subject = await tx.subject.create({ data: { name: 'Test' } });\n  return subject.id;\n}); // Transaction is automatically rolled back\n\n// Test constraints\nawait utils.testForeignKeyConstraints();\nawait utils.testUniqueConstraints();\n\n// Assert promise rejections\nawait assertions.rejectsWithMessage(\n  prisma.subject.create({ data: { name: null } }),\n  'NOT NULL constraint failed'\n);\n```\n\n### Available Factories\n\n- `factories.user.create(overrides)` - Create test users\n- `factories.subject.create(overrides)` - Create test subjects\n- `factories.milestone.create(overrides)` - Create test milestones\n- `factories.activity.create(overrides)` - Create test activities\n- `factories.outcome.create(overrides)` - Create test outcomes\n- `factories.note.create(overrides)` - Create test notes\n- `factories.calendarEvent.create(overrides)` - Create test calendar events\n\nAll factories support:\n- `create(overrides)` - Create single entity\n- `createMany(count, overrides)` - Create multiple entities\n- `build(overrides)` - Build data without saving to database\n\n## Running Tests\n\n```bash\n# Run all tests with transaction isolation\npnpm test\n\n# Run tests in parallel (recommended)\npnpm test:parallel\n\n# Run tests serially (for debugging)\npnpm test:serial\n\n# Run with coverage\npnpm test:coverage\n\n# Test the isolation system itself\npnpm test:isolation\n\n# Debug mode (more verbose output)\npnpm test:debug\n\n# Watch mode\npnpm test:watch\n```\n\n## Configuration\n\n### Jest Configuration (package.json)\n\n```json\n{\n  \"jest\": {\n    \"globalSetup\": \"<rootDir>/tests/setup-test-db.ts\",\n    \"setupFilesAfterEnv\": [\n      \"<rootDir>/jest.setup.js\",\n      \"<rootDir>/tests/jest.setup.ts\"\n    ],\n    \"maxWorkers\": \"50%\",\n    \"testTimeout\": 30000,\n    \"forceExit\": true,\n    \"detectOpenHandles\": true\n  }\n}\n```\n\n### Environment Variables\n\n- `JEST_WORKER_ID` - Automatically set by Jest for parallel execution\n- `DEBUG_TESTS` - Set to enable verbose test output\n- `DATABASE_URL` - Automatically managed by the test system\n\n## Performance Considerations\n\n### Optimizations Applied\n\n1. **SQLite WAL Mode**: Enables concurrent reads\n2. **Connection Pooling**: Reuses database connections\n3. **Savepoints**: Faster than full database resets\n4. **Parallel Workers**: Configurable based on CPU cores\n5. **Memory Databases**: Option for in-memory testing (faster but no persistence)\n\n### Benchmarks\n\nTypical performance on modern hardware:\n- **Simple CRUD test**: 10-50ms\n- **Complex scenario creation**: 100-500ms\n- **Large dataset (1000+ records)**: 1-3s\n- **Parallel execution**: 50-70% faster than serial\n\n## Troubleshooting\n\n### Common Issues\n\n1. **Database locked errors**\n   ```\n   Solution: Increase busy_timeout or reduce parallel workers\n   ```\n\n2. **Transaction rollback failures**\n   ```\n   Solution: Check for unclosed database connections\n   ```\n\n3. **Memory usage in CI**\n   ```\n   Solution: Use maxWorkers: 1 in CI environment\n   ```\n\n### Debug Mode\n\n```bash\n# Enable verbose logging\nDEBUG_TESTS=true pnpm test:debug\n\n# Check database files (not cleaned up in debug mode)\nls server/tests/temp/\n```\n\n### Manual Cleanup\n\n```bash\n# Remove temp databases manually if needed\nrm -rf server/tests/temp/\n```\n\n## Migration Guide\n\n### From Old Testing System\n\n1. **Replace direct Prisma usage**:\n   ```typescript\n   // Old\n   import { prisma } from '../src/prisma';\n   \n   // New\n   import { getTestPrismaClient } from '../../tests/jest.setup';\n   const prisma = getTestPrismaClient();\n   ```\n\n2. **Replace manual cleanup**:\n   ```typescript\n   // Old\n   afterEach(async () => {\n     await prisma.subject.deleteMany();\n     await prisma.milestone.deleteMany();\n     // ... more cleanup\n   });\n   \n   // New - automatic transaction rollback, no cleanup needed\n   ```\n\n3. **Use factories instead of manual data creation**:\n   ```typescript\n   // Old\n   const subject = await prisma.subject.create({\n     data: {\n       name: 'Test Subject',\n       // ... lots of required fields\n     }\n   });\n   \n   // New\n   const subject = await factories.subject.create({ name: 'Test Subject' });\n   ```\n\n## Best Practices\n\n1. **Use factories for data creation** - More maintainable and realistic\n2. **Test in isolation** - Don't rely on data from other tests\n3. **Use meaningful test data** - Makes debugging easier\n4. **Test constraints** - Verify database rules are enforced\n5. **Test relationships** - Ensure foreign keys work correctly\n6. **Use parallel execution** - Faster test runs\n7. **Clean test structure** - Group related tests in describe blocks\n\n## Contributing\n\nWhen adding new database models:\n\n1. Add factory in `factories.ts`\n2. Add test utilities if needed in `test-utils.ts`\n3. Add integration tests in `__tests__/`\n4. Update this documentation\n\nWhen modifying the testing system:\n\n1. Run `pnpm test:isolation` to verify isolation still works\n2. Test with both serial and parallel execution\n3. Update documentation as needed