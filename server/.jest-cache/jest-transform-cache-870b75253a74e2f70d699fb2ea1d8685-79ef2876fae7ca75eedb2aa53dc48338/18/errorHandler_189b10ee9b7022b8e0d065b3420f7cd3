e822ffd3cf1c09d33fe6b694c3624e85
import logger from '../logger';
import { ZodError } from 'zod';
export class AppError extends Error {
    statusCode;
    code;
    isOperational;
    constructor(message, statusCode, code, isOperational = true) {
        super(message);
        this.statusCode = statusCode;
        this.code = code;
        this.isOperational = isOperational;
        Error.captureStackTrace(this, this.constructor);
    }
}
export const asyncHandler = (fn) => (req, res, next) => {
    Promise.resolve(fn(req, res, next)).catch(next);
};
export function errorHandler(err, req, res, _next) {
    let statusCode = 500;
    const response = {
        error: 'Internal Server Error',
        timestamp: new Date().toISOString(),
        path: req.path,
    };
    // Log the error
    logger.error({
        err,
        method: req.method,
        path: req.path,
        query: req.query,
        ip: req.ip,
        userId: req.user?.userId,
    }, 'Request error');
    // Handle known error types
    if (err instanceof AppError) {
        statusCode = err.statusCode;
        response.error = err.message;
        response.code = err.code;
    }
    else if (err &&
        typeof err === 'object' &&
        'code' in err &&
        err.constructor.name === 'PrismaClientKnownRequestError') {
        // Handle Prisma errors
        const prismaError = err;
        switch (prismaError.code) {
            case 'P2002':
                statusCode = 409;
                response.error = 'Duplicate entry';
                response.message = 'A record with this value already exists';
                response.code = 'DUPLICATE_ENTRY';
                break;
            case 'P2025':
                statusCode = 404;
                response.error = 'Record not found';
                response.message = 'The requested record does not exist';
                response.code = 'NOT_FOUND';
                break;
            case 'P2003':
                statusCode = 400;
                response.error = 'Foreign key constraint failed';
                response.message = 'Referenced record does not exist';
                response.code = 'FOREIGN_KEY_ERROR';
                break;
            case 'P2016':
                statusCode = 400;
                response.error = 'Query interpretation error';
                response.message = 'Invalid query parameters';
                response.code = 'INVALID_QUERY';
                break;
            default:
                statusCode = 400;
                response.error = 'Database operation failed';
                response.message = err.message;
                response.code = `PRISMA_${prismaError.code}`;
        }
    }
    else if (err &&
        typeof err === 'object' &&
        err.constructor.name === 'PrismaClientValidationError') {
        statusCode = 400;
        response.error = 'Validation error';
        response.message = 'Invalid data provided';
        response.code = 'VALIDATION_ERROR';
        // Extract useful validation info if possible
        const validationMatch = err.message.match(/Argument (\w+): (.+)/);
        if (validationMatch) {
            response.details = {
                field: validationMatch[1],
                issue: validationMatch[2],
            };
        }
    }
    else if (err instanceof ZodError) {
        // Handle Zod validation errors
        statusCode = 400;
        response.error = 'Validation error';
        response.code = 'VALIDATION_ERROR';
        response.details = err.errors.map((e) => ({
            field: e.path.join('.'),
            message: e.message,
        }));
    }
    else if (err.name === 'JsonWebTokenError') {
        statusCode = 401;
        response.error = 'Invalid token';
        response.code = 'INVALID_TOKEN';
    }
    else if (err.name === 'TokenExpiredError') {
        statusCode = 401;
        response.error = 'Token expired';
        response.code = 'TOKEN_EXPIRED';
    }
    else if (err.name === 'MulterError') {
        statusCode = 400;
        response.error = 'File upload error';
        response.message = err.message;
        response.code = 'FILE_UPLOAD_ERROR';
    }
    else if (err.message.includes('CORS')) {
        statusCode = 403;
        response.error = 'CORS error';
        response.message = 'Cross-origin request blocked';
        response.code = 'CORS_ERROR';
    }
    else {
        // Generic error handling
        response.error =
            process.env.NODE_ENV === 'production' ? 'An unexpected error occurred' : err.message;
        // Don't leak stack traces in production
        if (process.env.NODE_ENV !== 'production') {
            response.details = {
                stack: err.stack,
            };
        }
    }
    res.status(statusCode).json(response);
}
// Catch unhandled routes
export function notFoundHandler(req, res) {
    res.status(404).json({
        error: 'Not Found',
        message: `Cannot ${req.method} ${req.path}`,
        code: 'ROUTE_NOT_FOUND',
        timestamp: new Date().toISOString(),
    });
}
// Common error generators
export const errors = {
    unauthorized: () => new AppError('Unauthorized', 401, 'UNAUTHORIZED'),
    forbidden: () => new AppError('Forbidden', 403, 'FORBIDDEN'),
    notFound: (resource) => new AppError(`${resource} not found`, 404, 'NOT_FOUND'),
    badRequest: (message) => new AppError(message, 400, 'BAD_REQUEST'),
    conflict: (message) => new AppError(message, 409, 'CONFLICT'),
    tooManyRequests: () => new AppError('Too many requests', 429, 'RATE_LIMIT_EXCEEDED'),
    serverError: (message = 'Internal server error') => new AppError(message, 500, 'SERVER_ERROR'),
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9taWRkbGV3YXJlL2Vycm9ySGFuZGxlci50cyIsIm1hcHBpbmdzIjoiQUFFQSxPQUFPLE1BQU0sTUFBTSxXQUFXLENBQUM7QUFDL0IsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLEtBQUssQ0FBQztBQVcvQixNQUFNLE9BQU8sUUFBUyxTQUFRLEtBQUs7SUFDakMsVUFBVSxDQUFTO0lBQ25CLElBQUksQ0FBUztJQUNiLGFBQWEsQ0FBVTtJQUV2QixZQUFZLE9BQWUsRUFBRSxVQUFrQixFQUFFLElBQVksRUFBRSxhQUFhLEdBQUcsSUFBSTtRQUNqRixLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDZixJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztRQUM3QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQztRQUVuQyxLQUFLLENBQUMsaUJBQWlCLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNsRCxDQUFDO0NBQ0Y7QUFFRCxNQUFNLENBQUMsTUFBTSxZQUFZLEdBQ3ZCLENBQUMsRUFBeUUsRUFBRSxFQUFFLENBQzlFLENBQUMsR0FBWSxFQUFFLEdBQWEsRUFBRSxJQUFrQixFQUFFLEVBQUU7SUFDbEQsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNsRCxDQUFDLENBQUM7QUFFSixNQUFNLFVBQVUsWUFBWSxDQUFDLEdBQVUsRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLEtBQW1CO0lBQ3ZGLElBQUksVUFBVSxHQUFHLEdBQUcsQ0FBQztJQUNyQixNQUFNLFFBQVEsR0FBa0I7UUFDOUIsS0FBSyxFQUFFLHVCQUF1QjtRQUM5QixTQUFTLEVBQUUs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QUFFLFdBQVc7UUFDbEIsT0FBTyxFQUFFLFVBQVUsR0FBRyxDQUFDLE1BQU0sSUFBSSxHQUFHLENBQUMsSUFBSSxFQUFFO1FBQzNDLElBQUksRUFBRSxpQkFBaUI7UUFDdkIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO0tBQ3BDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFRCwwQkFBMEI7QUFDMUIsTUFBTSxDQUFDLE1BQU0sTUFBTSxHQUFHO0lBQ3BCLFlBQVksRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLFFBQVEsQ0FBQyxjQUFjLEVBQUUsR0FBRyxFQUFFLGNBQWMsQ0FBQztJQUNyRSxTQUFTLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxRQUFRLENBQUMsV0FBVyxFQUFFLEdBQUcsRUFBRSxXQUFXLENBQUM7SUFDNUQsUUFBUSxFQUFFLENBQUMsUUFBZ0IsRUFBRSxFQUFFLENBQUMsSUFBSSxRQUFRLENBQUMsR0FBRyxRQUFRLFlBQVksRUFBRSxHQUFHLEVBQUUsV0FBVyxDQUFDO0lBQ3ZGLFVBQVUsRUFBRSxDQUFDLE9BQWUsRUFBRSxFQUFFLENBQUMsSUFBSSxRQUFRLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxhQUFhLENBQUM7SUFDMUUsUUFBUSxFQUFFLENBQUMsT0FBZSxFQUFFLEVBQUUsQ0FBQyxJQUFJLFFBQVEsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLFVBQVUsQ0FBQztJQUNyRSxlQUFlLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxRQUFRLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxFQUFFLHFCQUFxQixDQUFDO0lBQ3BGLFdBQVcsRUFBRSxDQUFDLE9BQU8sR0FBRyx1QkFBdUIsRUFBRSxFQUFFLENBQUMsSUFBSSxRQUFRLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxjQUFjLENBQUM7Q0FDL0YsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWljaGFlbG1jaXNhYWMvR2l0SHViL3RlYWNoaW5nLWVuZ2luZTIuMC9zZXJ2ZXIvc3JjL21pZGRsZXdhcmUvZXJyb3JIYW5kbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlcXVlc3QsIFJlc3BvbnNlLCBOZXh0RnVuY3Rpb24gfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB0eXBlIHsgUHJpc21hIH0gZnJvbSAnQHRlYWNoaW5nLWVuZ2luZS9kYXRhYmFzZSc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBab2RFcnJvciB9IGZyb20gJ3pvZCc7XG5cbmludGVyZmFjZSBFcnJvclJlc3BvbnNlIHtcbiAgZXJyb3I6IHN0cmluZztcbiAgbWVzc2FnZT86IHN0cmluZztcbiAgY29kZT86IHN0cmluZztcbiAgZGV0YWlscz86IHVua25vd247XG4gIHRpbWVzdGFtcD86IHN0cmluZztcbiAgcGF0aD86IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIEFwcEVycm9yIGV4dGVuZHMgRXJyb3Ige1xuICBzdGF0dXNDb2RlOiBudW1iZXI7XG4gIGNvZGU6IHN0cmluZztcbiAgaXNPcGVyYXRpb25hbDogYm9vbGVhbjtcblxuICBjb25zdHJ1Y3RvcihtZXNzYWdlOiBzdHJpbmcsIHN0YXR1c0NvZGU6IG51bWJlciwgY29kZTogc3RyaW5nLCBpc09wZXJhdGlvbmFsID0gdHJ1ZSkge1xuICAgIHN1cGVyKG1lc3NhZ2UpO1xuICAgIHRoaXMuc3RhdHVzQ29kZSA9IHN0YXR1c0NvZGU7XG4gICAgdGhpcy5jb2RlID0gY29kZTtcbiAgICB0aGlzLmlzT3BlcmF0aW9uYWwgPSBpc09wZXJhdGlvbmFsO1xuXG4gICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgdGhpcy5jb25zdHJ1Y3Rvcik7XG4gIH1cbn1cblxuZXhwb3J0IGNvbnN0IGFzeW5jSGFuZGxlciA9XG4gIChmbjogKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiBQcm9taXNlPHVua25vd24+KSA9PlxuICAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgICBQcm9taXNlLnJlc29sdmUoZm4ocmVxLCByZXMsIG5leHQpKS5jYXRjaChuZXh0KTtcbiAgfTtcblxuZXhwb3J0IGZ1bmN0aW9uIGVycm9ySGFuZGxlcihlcnI6IEVycm9yLCByZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIF9uZXh0OiBOZXh0RnVuY3Rpb24pIHtcbiAgbGV0IHN0YXR1c0NvZGUgPSA1MDA7XG4gIGNvbnN0IHJlc3BvbnNlOiBFcnJvclJlc3BvbnNlID0ge1xuICAgIGVycm9yOiAnSW50ZXJuYWwgU2VydmVyIEVycm9yJyxcbiAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICBwYXRoOiByZXEucGF0aCxcbiAgfTtcblxuICAvLyBMb2cgdGhlIGVycm9yXG4gIGxvZ2dlci5lcnJvcihcbiAgICB7XG4gICAgICBlcnIsXG4gICAgICBtZXRob2Q6IHJlcS5tZXRob2QsXG4gICAgICBwYXRoOiByZXEucGF0aCxcbiAgICAgIHF1ZXJ5OiByZXEucXVlcnksXG4gICAgICBpcDogcmVxLmlwLFxuICAgICAgdXNlcklkOiAocmVxIGFzIFJlcXVlc3QgJiB7IHVzZXI/OiB7IHVzZXJJZD86IHN0cmluZyB9IH0pLnVzZXI/LnVzZXJJZCxcbiAgICB9LFxuICAgICdSZXF1ZXN0IGVycm9yJyxcbiAgKTtcblxuICAvLyBIYW5kbGUga25vd24gZXJyb3IgdHlwZXNcbiAgaWYgKGVyciBpbnN0YW5jZW9mIEFwcEVycm9yKSB7XG4gICAgc3RhdHVzQ29kZSA9IGVyci5zdGF0dXNDb2RlO1xuICAgIHJlc3BvbnNlLmVycm9yID0gZXJyLm1lc3NhZ2U7XG4gICAgcmVzcG9uc2UuY29kZSA9IGVyci5jb2RlO1xuICB9IGVsc2UgaWYgKFxuICAgIGVyciAmJlxuICAgIHR5cGVvZiBlcnIgPT09ICdvYmplY3QnICYmXG4gICAgJ2NvZGUnIGluIGVyciAmJlxuICAgIGVyci5jb25zdHJ1Y3Rvci5uYW1lID09PSAnUHJpc21hQ2xpZW50S25vd25SZXF1ZXN0RXJyb3InXG4gICkge1xuICAgIC8vIEhhbmRsZSBQcmlzbWEgZXJyb3JzXG4gICAgY29uc3QgcHJpc21hRXJyb3IgPSBlcnIgYXMgUHJpc21hLlByaXNtYUNsaWVudEtub3duUmVxdWVzdEVycm9yO1xuICAgIHN3aXRjaCAocHJpc21hRXJyb3IuY29kZSkge1xuICAgICAgY2FzZSAnUDIwMDInOlxuICAgICAgICBzdGF0dXNDb2RlID0gNDA5O1xuICAgICAgICByZXNwb25zZS5lcnJvciA9ICdEdXBsaWNhdGUgZW50cnknO1xuICAgICAgICByZXNwb25zZS5tZXNzYWdlID0gJ0EgcmVjb3JkIHdpdGggdGhpcyB2YWx1ZSBhbHJlYWR5IGV4aXN0cyc7XG4gICAgICAgIHJlc3BvbnNlLmNvZGUgPSAnRFVQTElDQVRFX0VOVFJZJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdQMjAyNSc6XG4gICAgICAgIHN0YXR1c0NvZGUgPSA0MDQ7XG4gICAgICAgIHJlc3BvbnNlLmVycm9yID0gJ1JlY29yZCBub3QgZm91bmQnO1xuICAgICAgICByZXNwb25zZS5tZXNzYWdlID0gJ1RoZSByZXF1ZXN0ZWQgcmVjb3JkIGRvZXMgbm90IGV4aXN0JztcbiAgICAgICAgcmVzcG9uc2UuY29kZSA9ICdOT1RfRk9VTkQnO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ1AyMDAzJzpcbiAgICAgICAgc3RhdHVzQ29kZSA9IDQwMDtcbiAgICAgICAgcmVzcG9uc2UuZXJyb3IgPSAnRm9yZWlnbiBrZXkgY29uc3RyYWludCBmYWlsZWQnO1xuICAgICAgICByZXNwb25zZS5tZXNzYWdlID0gJ1JlZmVyZW5jZWQgcmVjb3JkIGRvZXMgbm90IGV4aXN0JztcbiAgICAgICAgcmVzcG9uc2UuY29kZSA9ICdGT1JFSUdOX0tFWV9FUlJPUic7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnUDIwMTYnOlxuICAgICAgICBzdGF0dXNDb2RlID0gNDAwO1xuICAgICAgICByZXNwb25zZS5lcnJvciA9ICdRdWVyeSBpbnRlcnByZXRhdGlvbiBlcnJvcic7XG4gICAgICAgIHJlc3BvbnNlLm1lc3NhZ2UgPSAnSW52YWxpZCBxdWVyeSBwYXJhbWV0ZXJzJztcbiAgICAgICAgcmVzcG9uc2UuY29kZSA9ICdJTlZBTElEX1FVRVJZJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBzdGF0dXNDb2RlID0gNDAwO1xuICAgICAgICByZXNwb25zZS5lcnJvciA9ICdEYXRhYmFzZSBvcGVyYXRpb24gZmFpbGVkJztcbiAgICAgICAgcmVzcG9uc2UubWVzc2FnZSA9IGVyci5tZXNzYWdlO1xuICAgICAgICByZXNwb25zZS5jb2RlID0gYFBSSVNNQV8ke3ByaXNtYUVycm9yLmNvZGV9YDtcbiAgICB9XG4gIH0gZWxzZSBpZiAoXG4gICAgZXJyICYmXG4gICAgdHlwZW9mIGVyciA9PT0gJ29iamVjdCcgJiZcbiAgICBlcnIuY29uc3RydWN0b3IubmFtZSA9PT0gJ1ByaXNtYUNsaWVudFZhbGlkYXRpb25FcnJvcidcbiAgKSB7XG4gICAgc3RhdHVzQ29kZSA9IDQwMDtcbiAgICByZXNwb25zZS5lcnJvciA9ICdWYWxpZGF0aW9uIGVycm9yJztcbiAgICByZXNwb25zZS5tZXNzYWdlID0gJ0ludmFsaWQgZGF0YSBwcm92aWRlZCc7XG4gICAgcmVzcG9uc2UuY29kZSA9ICdWQUxJREFUSU9OX0VSUk9SJztcblxuICAgIC8vIEV4dHJhY3QgdXNlZnVsIHZhbGlkYXRpb24gaW5mbyBpZiBwb3NzaWJsZVxuICAgIGNvbnN0IHZhbGlkYXRpb25NYXRjaCA9IGVyci5tZXNzYWdlLm1hdGNoKC9Bcmd1bWVudCAoXFx3Kyk6ICguKykvKTtcbiAgICBpZiAodmFsaWRhdGlvbk1hdGNoKSB7XG4gICAgICByZXNwb25zZS5kZXRhaWxzID0ge1xuICAgICAgICBmaWVsZDogdmFsaWRhdGlvbk1hdGNoWzFdLFxuICAgICAgICBpc3N1ZTogdmFsaWRhdGlvbk1hdGNoWzJdLFxuICAgICAgfTtcbiAgICB9XG4gIH0gZWxzZSBpZiAoZXJyIGluc3RhbmNlb2YgWm9kRXJyb3IpIHtcbiAgICAvLyBIYW5kbGUgWm9kIHZhbGlkYXRpb24gZXJyb3JzXG4gICAgc3RhdHVzQ29kZSA9IDQwMDtcbiAgICByZXNwb25zZS5lcnJvciA9ICdWYWxpZGF0aW9uIGVycm9yJztcbiAgICByZXNwb25zZS5jb2RlID0gJ1ZBTElEQVRJT05fRVJST1InO1xuICAgIHJlc3BvbnNlLmRldGFpbHMgPSBlcnIuZXJyb3JzLm1hcCgoZSkgPT4gKHtcbiAgICAgIGZpZWxkOiBlLnBhdGguam9pbignLicpLFxuICAgICAgbWVzc2FnZTogZS5tZXNzYWdlLFxuICAgIH0pKTtcbiAgfSBlbHNlIGlmIChlcnIubmFtZSA9PT0gJ0pzb25XZWJUb2tlbkVycm9yJykge1xuICAgIHN0YXR1c0NvZGUgPSA0MDE7XG4gICAgcmVzcG9uc2UuZXJyb3IgPSAnSW52YWxpZCB0b2tlbic7XG4gICAgcmVzcG9uc2UuY29kZSA9ICdJTlZBTElEX1RPS0VOJztcbiAgfSBlbHNlIGlmIChlcnIubmFtZSA9PT0gJ1Rva2VuRXhwaXJlZEVycm9yJykge1xuICAgIHN0YXR1c0NvZGUgPSA0MDE7XG4gICAgcmVzcG9uc2UuZXJyb3IgPSAnVG9rZW4gZXhwaXJlZCc7XG4gICAgcmVzcG9uc2UuY29kZSA9ICdUT0tFTl9FWFBJUkVEJztcbiAgfSBlbHNlIGlmIChlcnIubmFtZSA9PT0gJ011bHRlckVycm9yJykge1xuICAgIHN0YXR1c0NvZGUgPSA0MDA7XG4gICAgcmVzcG9uc2UuZXJyb3IgPSAnRmlsZSB1cGxvYWQgZXJyb3InO1xuICAgIHJlc3BvbnNlLm1lc3NhZ2UgPSBlcnIubWVzc2FnZTtcbiAgICByZXNwb25zZS5jb2RlID0gJ0ZJTEVfVVBMT0FEX0VSUk9SJztcbiAgfSBlbHNlIGlmIChlcnIubWVzc2FnZS5pbmNsdWRlcygnQ09SUycpKSB7XG4gICAgc3RhdHVzQ29kZSA9IDQwMztcbiAgICByZXNwb25zZS5lcnJvciA9ICdDT1JTIGVycm9yJztcbiAgICByZXNwb25zZS5tZXNzYWdlID0gJ0Nyb3NzLW9yaWdpbiByZXF1ZXN0IGJsb2NrZWQnO1xuICAgIHJlc3BvbnNlLmNvZGUgPSAnQ09SU19FUlJPUic7XG4gIH0gZWxzZSB7XG4gICAgLy8gR2VuZXJpYyBlcnJvciBoYW5kbGluZ1xuICAgIHJlc3BvbnNlLmVycm9yID1cbiAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAncHJvZHVjdGlvbicgPyAnQW4gdW5leHBlY3RlZCBlcnJvciBvY2N1cnJlZCcgOiBlcnIubWVzc2FnZTtcblxuICAgIC8vIERvbid0IGxlYWsgc3RhY2sgdHJhY2VzIGluIHByb2R1Y3Rpb25cbiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykge1xuICAgICAgcmVzcG9uc2UuZGV0YWlscyA9IHtcbiAgICAgICAgc3RhY2s6IGVyci5zdGFjayxcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgcmVzLnN0YXR1cyhzdGF0dXNDb2RlKS5qc29uKHJlc3BvbnNlKTtcbn1cblxuLy8gQ2F0Y2ggdW5oYW5kbGVkIHJvdXRlc1xuZXhwb3J0IGZ1bmN0aW9uIG5vdEZvdW5kSGFuZGxlcihyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpIHtcbiAgcmVzLnN0YXR1cyg0MDQpLmpzb24oe1xuICAgIGVycm9yOiAnTm90IEZvdW5kJyxcbiAgICBtZXNzYWdlOiBgQ2Fubm90ICR7cmVxLm1ldGhvZH0gJHtyZXEucGF0aH1gLFxuICAgIGNvZGU6ICdST1VURV9OT1RfRk9VTkQnLFxuICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICB9KTtcbn1cblxuLy8gQ29tbW9uIGVycm9yIGdlbmVyYXRvcnNcbmV4cG9ydCBjb25zdCBlcnJvcnMgPSB7XG4gIHVuYXV0aG9yaXplZDogKCkgPT4gbmV3IEFwcEVycm9yKCdVbmF1dGhvcml6ZWQnLCA0MDEsICdVTkFVVEhPUklaRUQnKSxcbiAgZm9yYmlkZGVuOiAoKSA9PiBuZXcgQXBwRXJyb3IoJ0ZvcmJpZGRlbicsIDQwMywgJ0ZPUkJJRERFTicpLFxuICBub3RGb3VuZDogKHJlc291cmNlOiBzdHJpbmcpID0+IG5ldyBBcHBFcnJvcihgJHtyZXNvdXJjZX0gbm90IGZvdW5kYCwgNDA0LCAnTk9UX0ZPVU5EJyksXG4gIGJhZFJlcXVlc3Q6IChtZXNzYWdlOiBzdHJpbmcpID0+IG5ldyBBcHBFcnJvcihtZXNzYWdlLCA0MDAsICdCQURfUkVRVUVTVCcpLFxuICBjb25mbGljdDogKG1lc3NhZ2U6IHN0cmluZykgPT4gbmV3IEFwcEVycm9yKG1lc3NhZ2UsIDQwOSwgJ0NPTkZMSUNUJyksXG4gIHRvb01hbnlSZXF1ZXN0czogKCkgPT4gbmV3IEFwcEVycm9yKCdUb28gbWFueSByZXF1ZXN0cycsIDQyOSwgJ1JBVEVfTElNSVRfRVhDRUVERUQnKSxcbiAgc2VydmVyRXJyb3I6IChtZXNzYWdlID0gJ0ludGVybmFsIHNlcnZlciBlcnJvcicpID0+IG5ldyBBcHBFcnJvcihtZXNzYWdlLCA1MDAsICdTRVJWRVJfRVJST1InKSxcbn07XG4iXSwidmVyc2lvbiI6M30=