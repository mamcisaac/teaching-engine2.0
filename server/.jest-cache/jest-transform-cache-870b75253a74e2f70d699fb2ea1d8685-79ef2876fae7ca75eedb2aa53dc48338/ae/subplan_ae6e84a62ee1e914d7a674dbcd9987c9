be1e929ff9e61441a69f5f624c8c029a
import { Router } from 'express';
import { z } from 'zod';
import { validate } from '../validation';
import { generateSubPlan } from '../services/subPlanService';
import { prisma } from '../prisma';
// Use global Express Request type with user: { id: number; email: string }
const router = Router();
// Sub-plan generation schema
const subPlanGenerateSchema = z.object({
    date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, 'Date must be in YYYY-MM-DD format'),
    days: z.number().int().min(1).max(5).default(1),
    includeGoals: z.boolean().default(true),
    includeRoutines: z.boolean().default(true),
    includePlans: z.boolean().default(true),
    anonymize: z.boolean().default(false),
    userId: z.number().int().optional(),
    saveRecord: z.boolean().default(false),
    emailTo: z.string().optional(),
    notes: z.string().max(1000).optional(),
});
/**
 * Generate substitute plan PDF
 * POST /api/sub-plan/generate
 */
router.post('/generate', validate(subPlanGenerateSchema), async (req, res, next) => {
    try {
        const userId = req.user?.id || 0;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const { date, days, includeGoals, includeRoutines, includePlans, anonymize, saveRecord, emailTo, notes } = req.body;
        // Use the authenticated user's ID if userId not provided in request
        const targetUserId = req.body.userId || userId;
        const options = {
            includeGoals,
            includeRoutines,
            includePlans,
            anonymize,
            userId: targetUserId,
        };
        const pdfBuffer = await generateSubPlan(date, days, options);
        // Save record if requested
        if (saveRecord) {
            await prisma.subPlanRecord.create({
                data: {
                    userId: targetUserId,
                    date: new Date(date),
                    daysCount: days,
                    content: { emailedTo: emailTo, options: JSON.stringify(options) },
                    includeGoals,
                    includeRoutines,
                    includePlans,
                    anonymized: anonymize,
                    notes: notes,
                },
            });
        }
        // Set PDF headers
        res.setHeader('Content-Type', 'application/pdf');
        res.setHeader('Content-Disposition', `attachment; filename="sub-plan-${date}.pdf"`);
        res.setHeader('Content-Length', pdfBuffer.length);
        res.send(pdfBuffer);
    }
    catch (error) {
        next(error);
    }
});
/**
 * Get class routines for user
 * GET /api/sub-plan/routines
 */
router.get('/routines', async (req, res, next) => {
    try {
        const userId = req.user?.id || 0;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const targetUserId = req.query.userId ? parseInt(req.query.userId, 10) : userId;
        const routines = await prisma.classRoutine.findMany({
            where: { userId: targetUserId },
            orderBy: { priority: 'desc' }, // Higher priority first
        });
        res.json(routines);
    }
    catch (error) {
        next(error);
    }
});
/**
 * Create or update class routine
 * POST /api/sub-plan/routines
 */
router.post('/routines', async (req, res, next) => {
    try {
        const userId = req.user?.id || 0;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const { id, title, description, category, timeOfDay, priority, isActive } = req.body;
        if (id) {
            // Update existing routine
            const routine = await prisma.classRoutine.update({
                where: { id: parseInt(id, 10) },
                data: {
                    title,
                    description,
                    category,
                    timeOfDay,
                    priority,
                    isActive: isActive !== undefined ? isActive : true,
                },
            });
            res.json(routine);
        }
        else {
            // Create new routine
            const routine = await prisma.classRoutine.create({
                data: {
                    userId,
                    title,
                    description,
                    category,
                    timeOfDay,
                    priority: priority || 5,
                    isActive: isActive !== undefined ? isActive : true,
                },
            });
            res.json(routine);
        }
    }
    catch (error) {
        next(error);
    }
});
/**
 * Delete class routine
 * DELETE /api/sub-plan/routines/:id
 */
router.delete('/routines/:id', async (req, res, next) => {
    try {
        const userId = req.user?.id || 0;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const routineId = parseInt(req.params.id, 10);
        await prisma.classRoutine.delete({
            where: { id: routineId },
        });
        res.json({ success: true });
    }
    catch (error) {
        next(error);
    }
});
/**
 * Get sub plan records
 * GET /api/sub-plan/records
 */
router.get('/records', async (req, res, next) => {
    try {
        const userId = req.user?.id || 0;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const targetUserId = req.query.userId ? parseInt(req.query.userId, 10) : userId;
        const records = await prisma.subPlanRecord.findMany({
            where: { userId: targetUserId },
            orderBy: { date: 'desc' },
        });
        res.json(records);
    }
    catch (error) {
        next(error);
    }
});
export default router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9yb3V0ZXMvc3ViLXBsYW4udHMiLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBbUMsTUFBTSxTQUFTLENBQUM7QUFDbEUsT0FBTyxFQUFFLENBQUMsRUFBRSxNQUFNLEtBQUssQ0FBQztBQUN4QixPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRW5DLDJFQUEyRTtBQUUzRSxNQUFNLE1BQU0sR0FBRyxNQUFNLEVBQUUsQ0FBQztBQUV4Qiw2QkFBNkI7QUFDN0IsTUFBTSxxQkFBcUIsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDO0lBQ3JDLElBQUksRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsS0FBSyxDQUFDLHFCQUFxQixFQUFFLG1DQUFtQyxDQUFDO0lBQ2xGLElBQUksRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQy9DLFlBQVksRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQztJQUN2QyxlQUFlLEVBQUUsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7SUFDMUMsWUFBWSxFQUFFLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDO0lBQ3ZDLFNBQVMsRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQztJQUNyQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdB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Q0FBQztRQUVELE1BQU0sWUFBWSxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFnQixFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7UUFFMUYsTUFBTSxPQUFPLEdBQUcsTUFBTSxNQUFNLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQztZQUNsRCxLQUFLLEVBQUUsRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFO1lBQy9CLE9BQU8sRUFBRSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUU7U0FDMUIsQ0FBQyxDQUFDO1FBRUgsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNwQixDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNkLENBQUM7QUFDSCxDQUFDLENBQUMsQ0FBQztBQUVILGVBQWUsTUFBTSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9taWNoYWVsbWNpc2FhYy9HaXRIdWIvdGVhY2hpbmctZW5naW5lMi4wL3NlcnZlci9zcmMvcm91dGVzL3N1Yi1wbGFuLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJvdXRlciwgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgeiB9IGZyb20gJ3pvZCc7XG5pbXBvcnQgeyB2YWxpZGF0ZSB9IGZyb20gJy4uL3ZhbGlkYXRpb24nO1xuaW1wb3J0IHsgZ2VuZXJhdGVTdWJQbGFuIH0gZnJvbSAnLi4vc2VydmljZXMvc3ViUGxhblNlcnZpY2UnO1xuaW1wb3J0IHsgcHJpc21hIH0gZnJvbSAnLi4vcHJpc21hJztcblxuLy8gVXNlIGdsb2JhbCBFeHByZXNzIFJlcXVlc3QgdHlwZSB3aXRoIHVzZXI6IHsgaWQ6IG51bWJlcjsgZW1haWw6IHN0cmluZyB9XG5cbmNvbnN0IHJvdXRlciA9IFJvdXRlcigpO1xuXG4vLyBTdWItcGxhbiBnZW5lcmF0aW9uIHNjaGVtYVxuY29uc3Qgc3ViUGxhbkdlbmVyYXRlU2NoZW1hID0gei5vYmplY3Qoe1xuICBkYXRlOiB6LnN0cmluZygpLnJlZ2V4KC9eXFxkezR9LVxcZHsyfS1cXGR7Mn0kLywgJ0RhdGUgbXVzdCBiZSBpbiBZWVlZLU1NLUREIGZvcm1hdCcpLFxuICBkYXlzOiB6Lm51bWJlcigpLmludCgpLm1pbigxKS5tYXgoNSkuZGVmYXVsdCgxKSxcbiAgaW5jbHVkZUdvYWxzOiB6LmJvb2xlYW4oKS5kZWZhdWx0KHRydWUpLFxuICBpbmNsdWRlUm91dGluZXM6IHouYm9vbGVhbigpLmRlZmF1bHQodHJ1ZSksXG4gIGluY2x1ZGVQbGFuczogei5ib29sZWFuKCkuZGVmYXVsdCh0cnVlKSxcbiAgYW5vbnltaXplOiB6LmJvb2xlYW4oKS5kZWZhdWx0KGZhbHNlKSxcbiAgdXNlcklkOiB6Lm51bWJlcigpLmludCgpLm9wdGlvbmFsKCksXG4gIHNhdmVSZWNvcmQ6IHouYm9vbGVhbigpLmRlZmF1bHQoZmFsc2UpLFxuICBlbWFpbFRvOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gIG5vdGVzOiB6LnN0cmluZygpLm1heCgxMDAwKS5vcHRpb25hbCgpLFxufSk7XG5cbi8qKlxuICogR2VuZXJhdGUgc3Vic3RpdHV0ZSBwbGFuIFBERlxuICogUE9TVCAvYXBpL3N1Yi1wbGFuL2dlbmVyYXRlXG4gKi9cbnJvdXRlci5wb3N0KCcvZ2VuZXJhdGUnLCB2YWxpZGF0ZShzdWJQbGFuR2VuZXJhdGVTY2hlbWEpLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlcj8uaWQgfHwgMDtcbiAgICBpZiAoIXVzZXJJZCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICdVbmF1dGhvcml6ZWQnIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHsgZGF0ZSwgZGF5cywgaW5jbHVkZUdvYWxzLCBpbmNsdWRlUm91dGluZXMsIGluY2x1ZGVQbGFucywgYW5vbnltaXplLCBzYXZlUmVjb3JkLCBlbWFpbFRvLCBub3RlcyB9ID0gcmVxLmJvZHk7XG5cbiAgICAvLyBVc2UgdGhlIGF1dGhlbnRpY2F0ZWQgdXNlcidzIElEIGlmIHVzZXJJZCBub3QgcHJvdmlkZWQgaW4gcmVxdWVzdFxuICAgIGNvbnN0IHRhcmdldFVzZXJJZCA9IHJlcS5ib2R5LnVzZXJJZCB8fCB1c2VySWQ7XG5cbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgaW5jbHVkZUdvYWxzLFxuICAgICAgaW5jbHVkZVJvdXRpbmVzLFxuICAgICAgaW5jbHVkZVBsYW5zLFxuICAgICAgYW5vbnltaXplLFxuICAgICAgdXNlcklkOiB0YXJnZXRVc2VySWQsXG4gICAgfTtcblxuICAgIGNvbnN0IHBkZkJ1ZmZlciA9IGF3YWl0IGdlbmVyYXRlU3ViUGxhbihkYXRlLCBkYXlzLCBvcHRpb25zKTtcblxuICAgIC8vIFNhdmUgcmVjb3JkIGlmIHJlcXVlc3RlZFxuICAgIGlmIChzYXZlUmVjb3JkKSB7XG4gICAgICBhd2FpdCBwcmlzbWEuc3ViUGxhblJlY29yZC5jcmVhdGUoe1xuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgdXNlcklkOiB0YXJnZXRVc2VySWQsXG4gICAgICAgICAgZGF0ZTogbmV3IERhdGUoZGF0ZSksXG4gICAgICAgICAgZGF5c0NvdW50OiBkYXlzLFxuICAgICAgICAgIGNvbnRlbnQ6IHsgZW1haWxlZFRvOiBlbWFpbFRvLCBvcHRpb25zOiBKU09OLnN0cmluZ2lmeShvcHRpb25zKSB9LFxuICAgICAgICAgIGluY2x1ZGVHb2FscyxcbiAgICAgICAgICBpbmNsdWRlUm91dGluZXMsXG4gICAgICAgICAgaW5jbHVkZVBsYW5zLFxuICAgICAgICAgIGFub255bWl6ZWQ6IGFub255bWl6ZSxcbiAgICAgICAgICBub3Rlczogbm90ZXMsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBTZXQgUERGIGhlYWRlcnNcbiAgICByZXMuc2V0SGVhZGVyKCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vcGRmJyk7XG4gICAgcmVzLnNldEhlYWRlcignQ29udGVudC1EaXNwb3NpdGlvbicsIGBhdHRhY2htZW50OyBmaWxlbmFtZT1cInN1Yi1wbGFuLSR7ZGF0ZX0ucGRmXCJgKTtcbiAgICByZXMuc2V0SGVhZGVyKCdDb250ZW50LUxlbmd0aCcsIHBkZkJ1ZmZlci5sZW5ndGgpO1xuXG4gICAgcmVzLnNlbmQocGRmQnVmZmVyKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBuZXh0KGVycm9yKTtcbiAgfVxufSk7XG5cbi8qKlxuICogR2V0IGNsYXNzIHJvdXRpbmVzIGZvciB1c2VyXG4gKiBHRVQgL2FwaS9zdWItcGxhbi9yb3V0aW5lc1xuICovXG5yb3V0ZXIuZ2V0KCcvcm91dGluZXMnLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlcj8uaWQgfHwgMDtcbiAgICBpZiAoIXVzZXJJZCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICdVbmF1dGhvcml6ZWQnIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHRhcmdldFVzZXJJZCA9IHJlcS5xdWVyeS51c2VySWQgPyBwYXJzZUludChyZXEucXVlcnkudXNlcklkIGFzIHN0cmluZywgMTApIDogdXNlcklkO1xuXG4gICAgY29uc3Qgcm91dGluZXMgPSBhd2FpdCBwcmlzbWEuY2xhc3NSb3V0aW5lLmZpbmRNYW55KHtcbiAgICAgIHdoZXJlOiB7IHVzZXJJZDogdGFyZ2V0VXNlcklkIH0sXG4gICAgICBvcmRlckJ5OiB7IHByaW9yaXR5OiAnZGVzYycgfSwgLy8gSGlnaGVyIHByaW9yaXR5IGZpcnN0XG4gICAgfSk7XG5cbiAgICByZXMuanNvbihyb3V0aW5lcyk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbmV4dChlcnJvcik7XG4gIH1cbn0pO1xuXG4vKipcbiAqIENyZWF0ZSBvciB1cGRhdGUgY2xhc3Mgcm91dGluZVxuICogUE9TVCAvYXBpL3N1Yi1wbGFuL3JvdXRpbmVzXG4gKi9cbnJvdXRlci5wb3N0KCcvcm91dGluZXMnLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlcj8uaWQgfHwgMDtcbiAgICBpZiAoIXVzZXJJZCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICdVbmF1dGhvcml6ZWQnIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHsgaWQsIHRpdGxlLCBkZXNjcmlwdGlvbiwgY2F0ZWdvcnksIHRpbWVPZkRheSwgcHJpb3JpdHksIGlzQWN0aXZlIH0gPSByZXEuYm9keTtcblxuICAgIGlmIChpZCkge1xuICAgICAgLy8gVXBkYXRlIGV4aXN0aW5nIHJvdXRpbmVcbiAgICAgIGNvbnN0IHJvdXRpbmUgPSBhd2FpdCBwcmlzbWEuY2xhc3NSb3V0aW5lLnVwZGF0ZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkOiBwYXJzZUludChpZCwgMTApIH0sXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICB0aXRsZSxcbiAgICAgICAgICBkZXNjcmlwdGlvbixcbiAgICAgICAgICBjYXRlZ29yeSxcbiAgICAgICAgICB0aW1lT2ZEYXksXG4gICAgICAgICAgcHJpb3JpdHksXG4gICAgICAgICAgaXNBY3RpdmU6IGlzQWN0aXZlICE9PSB1bmRlZmluZWQgPyBpc0FjdGl2ZSA6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICAgIHJlcy5qc29uKHJvdXRpbmUpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBDcmVhdGUgbmV3IHJvdXRpbmVcbiAgICAgIGNvbnN0IHJvdXRpbmUgPSBhd2FpdCBwcmlzbWEuY2xhc3NSb3V0aW5lLmNyZWF0ZSh7XG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgdGl0bGUsXG4gICAgICAgICAgZGVzY3JpcHRpb24sXG4gICAgICAgICAgY2F0ZWdvcnksXG4gICAgICAgICAgdGltZU9mRGF5LFxuICAgICAgICAgIHByaW9yaXR5OiBwcmlvcml0eSB8fCA1LFxuICAgICAgICAgIGlzQWN0aXZlOiBpc0FjdGl2ZSAhPT0gdW5kZWZpbmVkID8gaXNBY3RpdmUgOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgICByZXMuanNvbihyb3V0aW5lKTtcbiAgICB9XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbmV4dChlcnJvcik7XG4gIH1cbn0pO1xuXG4vKipcbiAqIERlbGV0ZSBjbGFzcyByb3V0aW5lXG4gKiBERUxFVEUgL2FwaS9zdWItcGxhbi9yb3V0aW5lcy86aWRcbiAqL1xucm91dGVyLmRlbGV0ZSgnL3JvdXRpbmVzLzppZCcsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyPy5pZCB8fCAwO1xuICAgIGlmICghdXNlcklkKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBlcnJvcjogJ1VuYXV0aG9yaXplZCcgfSk7XG4gICAgfVxuXG4gICAgY29uc3Qgcm91dGluZUlkID0gcGFyc2VJbnQocmVxLnBhcmFtcy5pZCwgMTApO1xuXG4gICAgYXdhaXQgcHJpc21hLmNsYXNzUm91dGluZS5kZWxldGUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHJvdXRpbmVJZCB9LFxuICAgIH0pO1xuXG4gICAgcmVzLmpzb24oeyBzdWNjZXNzOiB0cnVlIH0pO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIG5leHQoZXJyb3IpO1xuICB9XG59KTtcblxuLyoqXG4gKiBHZXQgc3ViIHBsYW4gcmVjb3Jkc1xuICogR0VUIC9hcGkvc3ViLXBsYW4vcmVjb3Jkc1xuICovXG5yb3V0ZXIuZ2V0KCcvcmVjb3JkcycsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyPy5pZCB8fCAwO1xuICAgIGlmICghdXNlcklkKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBlcnJvcjogJ1VuYXV0aG9yaXplZCcgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgdGFyZ2V0VXNlcklkID0gcmVxLnF1ZXJ5LnVzZXJJZCA/IHBhcnNlSW50KHJlcS5xdWVyeS51c2VySWQgYXMgc3RyaW5nLCAxMCkgOiB1c2VySWQ7XG5cbiAgICBjb25zdCByZWNvcmRzID0gYXdhaXQgcHJpc21hLnN1YlBsYW5SZWNvcmQuZmluZE1hbnkoe1xuICAgICAgd2hlcmU6IHsgdXNlcklkOiB0YXJnZXRVc2VySWQgfSxcbiAgICAgIG9yZGVyQnk6IHsgZGF0ZTogJ2Rlc2MnIH0sXG4gICAgfSk7XG5cbiAgICByZXMuanNvbihyZWNvcmRzKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBuZXh0KGVycm9yKTtcbiAgfVxufSk7XG5cbmV4cG9ydCBkZWZhdWx0IHJvdXRlcjsiXSwidmVyc2lvbiI6M30=