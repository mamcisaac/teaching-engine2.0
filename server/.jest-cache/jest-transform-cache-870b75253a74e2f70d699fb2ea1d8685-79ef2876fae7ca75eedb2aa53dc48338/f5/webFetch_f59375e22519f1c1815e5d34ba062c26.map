{"version":3,"names":["cov_2de8oqyxv8","actualCoverage","axios","JSDOM","createHash","WebFetch","cache","s","Map","cacheTime","userAgent","fetch","url","f","cacheKey","getCacheKey","cached","get","b","Date","now","timestamp","html","response","headers","timeout","maxRedirects","validateStatus","status","data","set","cleanCache","error","console","dom","fromURL","pretendToBeVisual","runScripts","resources","Promise","resolve","setTimeout","serialize","window","close","fallbackError","Error","update","digest","expiredKeys","key","entry","entries","push","delete","extractText","selector","document","element","querySelector","textContent","trim","scripts","querySelectorAll","forEach","el","remove","body","extractMeta","meta","metaTags","tag","name","getAttribute","content","title"],"sources":["/Users/michaelmcisaac/GitHub/teaching-engine2.0/server/src/utils/webFetch.ts"],"sourcesContent":["import axios from 'axios';\nimport { JSDOM } from 'jsdom';\nimport { createHash } from 'crypto';\n\ninterface CacheEntry {\n  html: string;\n  timestamp: number;\n}\n\nexport class WebFetch {\n  private cache: Map<string, CacheEntry> = new Map();\n  private readonly cacheTime = 15 * 60 * 1000; // 15 minutes\n  private readonly userAgent = 'Mozilla/5.0 (compatible; TeachingEngine/2.0; +https://teaching-engine.com)';\n  \n  async fetch(url: string): Promise<string> {\n    // Check cache first\n    const cacheKey = this.getCacheKey(url);\n    const cached = this.cache.get(cacheKey);\n    \n    if (cached && Date.now() - cached.timestamp < this.cacheTime) {\n      return cached.html;\n    }\n    \n    try {\n      // Fetch with axios\n      const response = await axios.get(url, {\n        headers: {\n          'User-Agent': this.userAgent,\n          'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',\n          'Accept-Language': 'en-US,en;q=0.5',\n          'Accept-Encoding': 'gzip, deflate',\n          'Connection': 'keep-alive',\n          'Upgrade-Insecure-Requests': '1'\n        },\n        timeout: 30000, // 30 seconds\n        maxRedirects: 5,\n        validateStatus: (status) => status < 400\n      });\n      \n      const html = response.data;\n      \n      // Cache the result\n      this.cache.set(cacheKey, {\n        html,\n        timestamp: Date.now()\n      });\n      \n      // Clean old cache entries\n      this.cleanCache();\n      \n      return html;\n    } catch (error) {\n      console.error(`Error fetching ${url}:`, error);\n      \n      // Try with JSDOM as fallback for JavaScript-heavy sites\n      try {\n        const dom = await JSDOM.fromURL(url, {\n          userAgent: this.userAgent,\n          pretendToBeVisual: true,\n          runScripts: 'dangerously',\n          resources: 'usable'\n        });\n        \n        // Wait a bit for JavaScript to load\n        await new Promise(resolve => setTimeout(resolve, 3000));\n        \n        const html = dom.serialize();\n        \n        // Cache the result\n        this.cache.set(cacheKey, {\n          html,\n          timestamp: Date.now()\n        });\n        \n        dom.window.close();\n        return html;\n      } catch (fallbackError) {\n        console.error(`Fallback fetch also failed for ${url}:`, fallbackError);\n        throw new Error(`Unable to fetch content from ${url}`);\n      }\n    }\n  }\n  \n  private getCacheKey(url: string): string {\n    return createHash('md5').update(url).digest('hex');\n  }\n  \n  private cleanCache(): void {\n    const now = Date.now();\n    const expiredKeys: string[] = [];\n    \n    for (const [key, entry] of this.cache.entries()) {\n      if (now - entry.timestamp > this.cacheTime) {\n        expiredKeys.push(key);\n      }\n    }\n    \n    for (const key of expiredKeys) {\n      this.cache.delete(key);\n    }\n  }\n  \n  // Utility method to extract text content from HTML\n  extractText(html: string, selector?: string): string {\n    const dom = new JSDOM(html);\n    const document = dom.window.document;\n    \n    if (selector) {\n      const element = document.querySelector(selector);\n      return element?.textContent?.trim() || '';\n    }\n    \n    // Remove script and style elements\n    const scripts = document.querySelectorAll('script, style');\n    scripts.forEach(el => el.remove());\n    \n    return document.body?.textContent?.trim() || '';\n  }\n  \n  // Utility method to extract meta information\n  extractMeta(html: string): Record<string, string> {\n    const dom = new JSDOM(html);\n    const document = dom.window.document;\n    const meta: Record<string, string> = {};\n    \n    // Extract common meta tags\n    const metaTags = document.querySelectorAll('meta[name], meta[property]');\n    metaTags.forEach(tag => {\n      const name = tag.getAttribute('name') || tag.getAttribute('property');\n      const content = tag.getAttribute('content');\n      if (name && content) {\n        meta[name] = content;\n      }\n    });\n    \n    // Extract title\n    const title = document.querySelector('title');\n    if (title) {\n      meta.title = title.textContent || '';\n    }\n    \n    return meta;\n  }\n}"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}