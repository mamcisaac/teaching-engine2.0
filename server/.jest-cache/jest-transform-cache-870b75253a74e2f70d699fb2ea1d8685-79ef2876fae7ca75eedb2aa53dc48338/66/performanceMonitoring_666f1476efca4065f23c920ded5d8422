d9a3ac12ba30497472881228fd33595b
import logger from '../logger';
class PerformanceMonitor {
    metrics;
    requestTimings = [];
    maxTimings = 1000; // Keep last 1000 requests
    slowRequestThreshold = 1000; // 1 second
    constructor() {
        this.metrics = {
            totalRequests: 0,
            averageResponseTime: 0,
            slowRequests: 0,
            errorRate: 0,
            requestsPerMinute: 0,
            memoryUsage: process.memoryUsage(),
            lastReset: new Date()
        };
        // Update metrics every minute
        setInterval(() => this.updateMetrics(), 60000);
    }
    middleware() {
        return (req, res, next) => {
            const startTime = process.hrtime.bigint();
            const memoryBefore = process.memoryUsage().heapUsed;
            // Override res.end to capture response time
            const originalEnd = res.end;
            res.end = function (...args) {
                const endTime = process.hrtime.bigint();
                const duration = Number(endTime - startTime) / 1000000; // Convert to milliseconds
                const memoryAfter = process.memoryUsage().heapUsed;
                // Record the request timing
                const timing = {
                    method: req.method,
                    route: req.route?.path || req.path,
                    duration,
                    statusCode: res.statusCode,
                    timestamp: new Date(),
                    memoryBefore,
                    memoryAfter
                };
                performanceMonitor.recordRequest(timing);
                // Log slow requests
                if (duration > performanceMonitor.slowRequestThreshold) {
                    logger.warn({
                        method: req.method,
                        route: timing.route,
                        duration: `${duration.toFixed(2)}ms`,
                        statusCode: res.statusCode,
                        memoryDelta: `${((memoryAfter - memoryBefore) / 1024 / 1024).toFixed(2)}MB`
                    }, 'Slow request detected');
                }
                // Call original end method and return the response
                return originalEnd.apply(this, args);
            };
            next();
        };
    }
    recordRequest(timing) {
        this.requestTimings.push(timing);
        // Keep only the most recent timings
        if (this.requestTimings.length > this.maxTimings) {
            this.requestTimings = this.requestTimings.slice(-this.maxTimings);
        }
        this.metrics.totalRequests++;
        // Update average response time (rolling average)
        const totalTime = this.metrics.averageResponseTime * (this.metrics.totalRequests - 1);
        this.metrics.averageResponseTime = (totalTime + timing.duration) / this.metrics.totalRequests;
        // Count slow requests
        if (timing.duration > this.slowRequestThreshold) {
            this.metrics.slowRequests++;
        }
        // Update error rate
        if (timing.statusCode >= 400) {
            const totalErrors = this.requestTimings.filter(t => t.statusCode >= 400).length;
            this.metrics.errorRate = (totalErrors / this.requestTimings.length) * 100;
        }
    }
    updateMetrics() {
        const now = new Date();
        const oneMinuteAgo = new Date(now.getTime() - 60000);
        // Calculate requests per minute
        const recentRequests = this.requestTimings.filter(t => t.timestamp > oneMinuteAgo);
        this.metrics.requestsPerMinute = recentRequests.length;
        // Update memory usage
        this.metrics.memoryUsage = process.memoryUsage();
        // Log performance summary every 5 minutes
        const minutesSinceReset = (now.getTime() - this.metrics.lastReset.getTime()) / (1000 * 60);
        if (minutesSinceReset >= 5) {
            this.logPerformanceSummary();
            this.resetCounters();
        }
    }
    logPerformanceSummary() {
        const summary = this.getPerformanceSummary();
        logger.info({
            performance: summary,
            memoryUsage: {
                heapUsed: `${(this.metrics.memoryUsage.heapUsed / 1024 / 1024).toFixed(2)}MB`,
                heapTotal: `${(this.metrics.memoryUsage.heapTotal / 1024 / 1024).toFixed(2)}MB`,
                external: `${(this.metrics.memoryUsage.external / 1024 / 1024).toFixed(2)}MB`,
                rss: `${(this.metrics.memoryUsage.rss / 1024 / 1024).toFixed(2)}MB`
            }
        }, 'Performance summary');
        // Warn about performance issues
        if (summary.averageResponseTime > 500) {
            logger.warn('High average response time detected');
        }
        if (summary.errorRate > 5) {
            logger.warn('High error rate detected');
        }
        if (summary.slowRequestPercentage > 10) {
            logger.warn('High percentage of slow requests detected');
        }
    }
    resetCounters() {
        this.metrics.lastReset = new Date();
        // Keep running totals but reset some metrics
        this.metrics.slowRequests = 0;
    }
    getPerformanceSummary() {
        const slowRequestPercentage = this.metrics.totalRequests > 0
            ? (this.metrics.slowRequests / this.metrics.totalRequests) * 100
            : 0;
        const recentTimings = this.requestTimings.slice(-100); // Last 100 requests
        const routeStats = this.getRouteStatistics(recentTimings);
        return {
            totalRequests: this.metrics.totalRequests,
            averageResponseTime: Math.round(this.metrics.averageResponseTime * 100) / 100,
            requestsPerMinute: this.metrics.requestsPerMinute,
            errorRate: Math.round(this.metrics.errorRate * 100) / 100,
            slowRequestPercentage: Math.round(slowRequestPercentage * 100) / 100,
            slowRequestThreshold: this.slowRequestThreshold,
            uptimeMinutes: Math.round((Date.now() - this.metrics.lastReset.getTime()) / (1000 * 60)),
            routeStats
        };
    }
    getRouteStatistics(timings) {
        const routeMap = new Map();
        for (const timing of timings) {
            const key = `${timing.method} ${timing.route}`;
            const stats = routeMap.get(key) || { count: 0, totalTime: 0, errors: 0 };
            stats.count++;
            stats.totalTime += timing.duration;
            if (timing.statusCode >= 400) {
                stats.errors++;
            }
            routeMap.set(key, stats);
        }
        const routeStats = [];
        for (const [route, stats] of routeMap.entries()) {
            routeStats.push({
                route,
                requestCount: stats.count,
                averageResponseTime: Math.round((stats.totalTime / stats.count) * 100) / 100,
                errorRate: Math.round((stats.errors / stats.count) * 100 * 100) / 100
            });
        }
        // Sort by request count descending
        return routeStats.sort((a, b) => b.requestCount - a.requestCount).slice(0, 10);
    }
    getSlowestEndpoints(limit = 10) {
        const routeMap = new Map();
        for (const timing of this.requestTimings) {
            const key = `${timing.method} ${timing.route}`;
            const stats = routeMap.get(key) || { times: [], errors: 0 };
            stats.times.push(timing.duration);
            if (timing.statusCode >= 400) {
                stats.errors++;
            }
            routeMap.set(key, stats);
        }
        const endpointStats = [];
        for (const [route, stats] of routeMap.entries()) {
            const avgTime = stats.times.reduce((a, b) => a + b, 0) / stats.times.length;
            const maxTime = Math.max(...stats.times);
            const p95Time = this.percentile(stats.times, 0.95);
            endpointStats.push({
                route,
                requestCount: stats.times.length,
                averageTime: Math.round(avgTime * 100) / 100,
                maxTime: Math.round(maxTime * 100) / 100,
                p95Time: Math.round(p95Time * 100) / 100,
                errorCount: stats.errors
            });
        }
        return endpointStats
            .sort((a, b) => b.averageTime - a.averageTime)
            .slice(0, limit);
    }
    percentile(arr, p) {
        const sorted = [...arr].sort((a, b) => a - b);
        const index = Math.ceil(sorted.length * p) - 1;
        return sorted[index] || 0;
    }
    getHealthStatus() {
        const summary = this.getPerformanceSummary();
        const memUsageMB = this.metrics.memoryUsage.heapUsed / 1024 / 1024;
        const isHealthy = summary.averageResponseTime < 1000 &&
            summary.errorRate < 10 &&
            summary.slowRequestPercentage < 20 &&
            memUsageMB < 512; // 512MB threshold
        return {
            healthy: isHealthy,
            details: {
                responseTime: summary.averageResponseTime < 1000 ? 'good' : 'slow',
                errorRate: summary.errorRate < 5 ? 'good' : summary.errorRate < 10 ? 'warning' : 'critical',
                memoryUsage: memUsageMB < 256 ? 'good' : memUsageMB < 512 ? 'warning' : 'critical',
                performance: summary
            }
        };
    }
}
// Global instance
const performanceMonitor = new PerformanceMonitor();
export { performanceMonitor };
export default performanceMonitor.middleware();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9taWRkbGV3YXJlL3BlcmZvcm1hbmNlTW9uaXRvcmluZy50cyIsIm1hcHBpbmdzIjoiQUFDQSxPQUFPLE1BQU0sTUFBTSxXQUFXLENBQUM7QUFzQi9CLE1BQU0sa0JBQWtCO0lBQ2QsT0FBTyxDQUFxQjtJQUM1QixjQUFjLEdBQW9CLEVBQUUsQ0FBQztJQUM1QixVQUFVLEdBQUcsSUFBSSxDQUFDLENBQUMsMEJBQTBCO0lBQzdDLG9CQUFvQixHQUFHLElBQUksQ0FBQyxDQUFDLFdBQVc7SUFFekQ7UUFDRSxJQUFJLENBQUMsT0FBTyxHQUFHO1lBQ2IsYUFBYSxFQUFFLENBQUM7WUFDaEIsbUJBQW1CLEVBQUUsQ0FBQztZQUN0QixZQUFZLEVBQUUsQ0FBQztZQUNmLFNBQVMsRUFBRSxDQUFDO1lBQ1osaUJBQWlCLEVBQUUsQ0FBQztZQUNwQixXQUFXLEVBQUUsT0FBTyxDQUFDLFdBQVcsRUFBRTtZQUNsQyxTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7U0FDdEIsQ0FBQztRQUVGLDhCQUE4QjtRQUM5QixXQUFXLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFFRCxVQUFVO1FBQ1IsT0FBTyxDQUFDLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBa0IsRUFBRSxFQUFFO1lBQ3pELE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDMUMsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDLFFBQVEsQ0FBQztZQUVwRCw0Q0FBNEM7WUFDNUMsTUFBTSxXQUFXLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQztZQUM1QixHQUFHLENBQUMsR0FBRyxHQUFHLFVBQXlCLEdBQUcsSUFBZTtnQkFDbkQsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLE1BQU0s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LEVBQUUsQ0FBQztBQUVwRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQztBQUM5QixlQUFlLGtCQUFrQixDQUFDLFVBQVUsRUFBRSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9taWNoYWVsbWNpc2FhYy9HaXRIdWIvdGVhY2hpbmctZW5naW5lMi4wL3NlcnZlci9zcmMvbWlkZGxld2FyZS9wZXJmb3JtYW5jZU1vbml0b3JpbmcudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuLi9sb2dnZXInO1xuXG5pbnRlcmZhY2UgUGVyZm9ybWFuY2VNZXRyaWNzIHtcbiAgdG90YWxSZXF1ZXN0czogbnVtYmVyO1xuICBhdmVyYWdlUmVzcG9uc2VUaW1lOiBudW1iZXI7XG4gIHNsb3dSZXF1ZXN0czogbnVtYmVyO1xuICBlcnJvclJhdGU6IG51bWJlcjtcbiAgcmVxdWVzdHNQZXJNaW51dGU6IG51bWJlcjtcbiAgbWVtb3J5VXNhZ2U6IE5vZGVKUy5NZW1vcnlVc2FnZTtcbiAgbGFzdFJlc2V0OiBEYXRlO1xufVxuXG5pbnRlcmZhY2UgUmVxdWVzdFRpbWluZyB7XG4gIG1ldGhvZDogc3RyaW5nO1xuICByb3V0ZTogc3RyaW5nO1xuICBkdXJhdGlvbjogbnVtYmVyO1xuICBzdGF0dXNDb2RlOiBudW1iZXI7XG4gIHRpbWVzdGFtcDogRGF0ZTtcbiAgbWVtb3J5QmVmb3JlOiBudW1iZXI7XG4gIG1lbW9yeUFmdGVyOiBudW1iZXI7XG59XG5cbmNsYXNzIFBlcmZvcm1hbmNlTW9uaXRvciB7XG4gIHByaXZhdGUgbWV0cmljczogUGVyZm9ybWFuY2VNZXRyaWNzO1xuICBwcml2YXRlIHJlcXVlc3RUaW1pbmdzOiBSZXF1ZXN0VGltaW5nW10gPSBbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBtYXhUaW1pbmdzID0gMTAwMDsgLy8gS2VlcCBsYXN0IDEwMDAgcmVxdWVzdHNcbiAgcHJpdmF0ZSByZWFkb25seSBzbG93UmVxdWVzdFRocmVzaG9sZCA9IDEwMDA7IC8vIDEgc2Vjb25kXG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5tZXRyaWNzID0ge1xuICAgICAgdG90YWxSZXF1ZXN0czogMCxcbiAgICAgIGF2ZXJhZ2VSZXNwb25zZVRpbWU6IDAsXG4gICAgICBzbG93UmVxdWVzdHM6IDAsXG4gICAgICBlcnJvclJhdGU6IDAsXG4gICAgICByZXF1ZXN0c1Blck1pbnV0ZTogMCxcbiAgICAgIG1lbW9yeVVzYWdlOiBwcm9jZXNzLm1lbW9yeVVzYWdlKCksXG4gICAgICBsYXN0UmVzZXQ6IG5ldyBEYXRlKClcbiAgICB9O1xuXG4gICAgLy8gVXBkYXRlIG1ldHJpY3MgZXZlcnkgbWludXRlXG4gICAgc2V0SW50ZXJ2YWwoKCkgPT4gdGhpcy51cGRhdGVNZXRyaWNzKCksIDYwMDAwKTtcbiAgfVxuXG4gIG1pZGRsZXdhcmUoKSB7XG4gICAgcmV0dXJuIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICAgICAgY29uc3Qgc3RhcnRUaW1lID0gcHJvY2Vzcy5ocnRpbWUuYmlnaW50KCk7XG4gICAgICBjb25zdCBtZW1vcnlCZWZvcmUgPSBwcm9jZXNzLm1lbW9yeVVzYWdlKCkuaGVhcFVzZWQ7XG5cbiAgICAgIC8vIE92ZXJyaWRlIHJlcy5lbmQgdG8gY2FwdHVyZSByZXNwb25zZSB0aW1lXG4gICAgICBjb25zdCBvcmlnaW5hbEVuZCA9IHJlcy5lbmQ7XG4gICAgICByZXMuZW5kID0gZnVuY3Rpb24odGhpczogUmVzcG9uc2UsIC4uLmFyZ3M6IHVua25vd25bXSk6IFJlc3BvbnNlIHtcbiAgICAgICAgY29uc3QgZW5kVGltZSA9IHByb2Nlc3MuaHJ0aW1lLmJpZ2ludCgpO1xuICAgICAgICBjb25zdCBkdXJhdGlvbiA9IE51bWJlcihlbmRUaW1lIC0gc3RhcnRUaW1lKSAvIDEwMDAwMDA7IC8vIENvbnZlcnQgdG8gbWlsbGlzZWNvbmRzXG4gICAgICAgIGNvbnN0IG1lbW9yeUFmdGVyID0gcHJvY2Vzcy5tZW1vcnlVc2FnZSgpLmhlYXBVc2VkO1xuXG4gICAgICAgIC8vIFJlY29yZCB0aGUgcmVxdWVzdCB0aW1pbmdcbiAgICAgICAgY29uc3QgdGltaW5nOiBSZXF1ZXN0VGltaW5nID0ge1xuICAgICAgICAgIG1ldGhvZDogcmVxLm1ldGhvZCxcbiAgICAgICAgICByb3V0ZTogcmVxLnJvdXRlPy5wYXRoIHx8IHJlcS5wYXRoLFxuICAgICAgICAgIGR1cmF0aW9uLFxuICAgICAgICAgIHN0YXR1c0NvZGU6IHJlcy5zdGF0dXNDb2RlLFxuICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgICAgICBtZW1vcnlCZWZvcmUsXG4gICAgICAgICAgbWVtb3J5QWZ0ZXJcbiAgICAgICAgfTtcblxuICAgICAgICBwZXJmb3JtYW5jZU1vbml0b3IucmVjb3JkUmVxdWVzdCh0aW1pbmcpO1xuXG4gICAgICAgIC8vIExvZyBzbG93IHJlcXVlc3RzXG4gICAgICAgIGlmIChkdXJhdGlvbiA+IHBlcmZvcm1hbmNlTW9uaXRvci5zbG93UmVxdWVzdFRocmVzaG9sZCkge1xuICAgICAgICAgIGxvZ2dlci53YXJuKHtcbiAgICAgICAgICAgIG1ldGhvZDogcmVxLm1ldGhvZCxcbiAgICAgICAgICAgIHJvdXRlOiB0aW1pbmcucm91dGUsXG4gICAgICAgICAgICBkdXJhdGlvbjogYCR7ZHVyYXRpb24udG9GaXhlZCgyKX1tc2AsXG4gICAgICAgICAgICBzdGF0dXNDb2RlOiByZXMuc3RhdHVzQ29kZSxcbiAgICAgICAgICAgIG1lbW9yeURlbHRhOiBgJHsoKG1lbW9yeUFmdGVyIC0gbWVtb3J5QmVmb3JlKSAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CYFxuICAgICAgICAgIH0sICdTbG93IHJlcXVlc3QgZGV0ZWN0ZWQnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENhbGwgb3JpZ2luYWwgZW5kIG1ldGhvZCBhbmQgcmV0dXJuIHRoZSByZXNwb25zZVxuICAgICAgICByZXR1cm4gb3JpZ2luYWxFbmQuYXBwbHkodGhpcywgYXJncykgYXMgUmVzcG9uc2U7XG4gICAgICB9O1xuXG4gICAgICBuZXh0KCk7XG4gICAgfTtcbiAgfVxuXG4gIHJlY29yZFJlcXVlc3QodGltaW5nOiBSZXF1ZXN0VGltaW5nKTogdm9pZCB7XG4gICAgdGhpcy5yZXF1ZXN0VGltaW5ncy5wdXNoKHRpbWluZyk7XG4gICAgXG4gICAgLy8gS2VlcCBvbmx5IHRoZSBtb3N0IHJlY2VudCB0aW1pbmdzXG4gICAgaWYgKHRoaXMucmVxdWVzdFRpbWluZ3MubGVuZ3RoID4gdGhpcy5tYXhUaW1pbmdzKSB7XG4gICAgICB0aGlzLnJlcXVlc3RUaW1pbmdzID0gdGhpcy5yZXF1ZXN0VGltaW5ncy5zbGljZSgtdGhpcy5tYXhUaW1pbmdzKTtcbiAgICB9XG5cbiAgICB0aGlzLm1ldHJpY3MudG90YWxSZXF1ZXN0cysrO1xuICAgIFxuICAgIC8vIFVwZGF0ZSBhdmVyYWdlIHJlc3BvbnNlIHRpbWUgKHJvbGxpbmcgYXZlcmFnZSlcbiAgICBjb25zdCB0b3RhbFRpbWUgPSB0aGlzLm1ldHJpY3MuYXZlcmFnZVJlc3BvbnNlVGltZSAqICh0aGlzLm1ldHJpY3MudG90YWxSZXF1ZXN0cyAtIDEpO1xuICAgIHRoaXMubWV0cmljcy5hdmVyYWdlUmVzcG9uc2VUaW1lID0gKHRvdGFsVGltZSArIHRpbWluZy5kdXJhdGlvbikgLyB0aGlzLm1ldHJpY3MudG90YWxSZXF1ZXN0cztcblxuICAgIC8vIENvdW50IHNsb3cgcmVxdWVzdHNcbiAgICBpZiAodGltaW5nLmR1cmF0aW9uID4gdGhpcy5zbG93UmVxdWVzdFRocmVzaG9sZCkge1xuICAgICAgdGhpcy5tZXRyaWNzLnNsb3dSZXF1ZXN0cysrO1xuICAgIH1cblxuICAgIC8vIFVwZGF0ZSBlcnJvciByYXRlXG4gICAgaWYgKHRpbWluZy5zdGF0dXNDb2RlID49IDQwMCkge1xuICAgICAgY29uc3QgdG90YWxFcnJvcnMgPSB0aGlzLnJlcXVlc3RUaW1pbmdzLmZpbHRlcih0ID0+IHQuc3RhdHVzQ29kZSA+PSA0MDApLmxlbmd0aDtcbiAgICAgIHRoaXMubWV0cmljcy5lcnJvclJhdGUgPSAodG90YWxFcnJvcnMgLyB0aGlzLnJlcXVlc3RUaW1pbmdzLmxlbmd0aCkgKiAxMDA7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVNZXRyaWNzKCk6IHZvaWQge1xuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgY29uc3Qgb25lTWludXRlQWdvID0gbmV3IERhdGUobm93LmdldFRpbWUoKSAtIDYwMDAwKTtcbiAgICBcbiAgICAvLyBDYWxjdWxhdGUgcmVxdWVzdHMgcGVyIG1pbnV0ZVxuICAgIGNvbnN0IHJlY2VudFJlcXVlc3RzID0gdGhpcy5yZXF1ZXN0VGltaW5ncy5maWx0ZXIodCA9PiB0LnRpbWVzdGFtcCA+IG9uZU1pbnV0ZUFnbyk7XG4gICAgdGhpcy5tZXRyaWNzLnJlcXVlc3RzUGVyTWludXRlID0gcmVjZW50UmVxdWVzdHMubGVuZ3RoO1xuICAgIFxuICAgIC8vIFVwZGF0ZSBtZW1vcnkgdXNhZ2VcbiAgICB0aGlzLm1ldHJpY3MubWVtb3J5VXNhZ2UgPSBwcm9jZXNzLm1lbW9yeVVzYWdlKCk7XG5cbiAgICAvLyBMb2cgcGVyZm9ybWFuY2Ugc3VtbWFyeSBldmVyeSA1IG1pbnV0ZXNcbiAgICBjb25zdCBtaW51dGVzU2luY2VSZXNldCA9IChub3cuZ2V0VGltZSgpIC0gdGhpcy5tZXRyaWNzLmxhc3RSZXNldC5nZXRUaW1lKCkpIC8gKDEwMDAgKiA2MCk7XG4gICAgaWYgKG1pbnV0ZXNTaW5jZVJlc2V0ID49IDUpIHtcbiAgICAgIHRoaXMubG9nUGVyZm9ybWFuY2VTdW1tYXJ5KCk7XG4gICAgICB0aGlzLnJlc2V0Q291bnRlcnMoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGxvZ1BlcmZvcm1hbmNlU3VtbWFyeSgpOiB2b2lkIHtcbiAgICBjb25zdCBzdW1tYXJ5ID0gdGhpcy5nZXRQZXJmb3JtYW5jZVN1bW1hcnkoKTtcbiAgICBcbiAgICBsb2dnZXIuaW5mbyh7XG4gICAgICBwZXJmb3JtYW5jZTogc3VtbWFyeSxcbiAgICAgIG1lbW9yeVVzYWdlOiB7XG4gICAgICAgIGhlYXBVc2VkOiBgJHsodGhpcy5tZXRyaWNzLm1lbW9yeVVzYWdlLmhlYXBVc2VkIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMil9TUJgLFxuICAgICAgICBoZWFwVG90YWw6IGAkeyh0aGlzLm1ldHJpY3MubWVtb3J5VXNhZ2UuaGVhcFRvdGFsIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMil9TUJgLFxuICAgICAgICBleHRlcm5hbDogYCR7KHRoaXMubWV0cmljcy5tZW1vcnlVc2FnZS5leHRlcm5hbCAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CYCxcbiAgICAgICAgcnNzOiBgJHsodGhpcy5tZXRyaWNzLm1lbW9yeVVzYWdlLnJzcyAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CYFxuICAgICAgfVxuICAgIH0sICdQZXJmb3JtYW5jZSBzdW1tYXJ5Jyk7XG5cbiAgICAvLyBXYXJuIGFib3V0IHBlcmZvcm1hbmNlIGlzc3Vlc1xuICAgIGlmIChzdW1tYXJ5LmF2ZXJhZ2VSZXNwb25zZVRpbWUgPiA1MDApIHtcbiAgICAgIGxvZ2dlci53YXJuKCdIaWdoIGF2ZXJhZ2UgcmVzcG9uc2UgdGltZSBkZXRlY3RlZCcpO1xuICAgIH1cbiAgICBcbiAgICBpZiAoc3VtbWFyeS5lcnJvclJhdGUgPiA1KSB7XG4gICAgICBsb2dnZXIud2FybignSGlnaCBlcnJvciByYXRlIGRldGVjdGVkJyk7XG4gICAgfVxuXG4gICAgaWYgKHN1bW1hcnkuc2xvd1JlcXVlc3RQZXJjZW50YWdlID4gMTApIHtcbiAgICAgIGxvZ2dlci53YXJuKCdIaWdoIHBlcmNlbnRhZ2Ugb2Ygc2xvdyByZXF1ZXN0cyBkZXRlY3RlZCcpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVzZXRDb3VudGVycygpOiB2b2lkIHtcbiAgICB0aGlzLm1ldHJpY3MubGFzdFJlc2V0ID0gbmV3IERhdGUoKTtcbiAgICAvLyBLZWVwIHJ1bm5pbmcgdG90YWxzIGJ1dCByZXNldCBzb21lIG1ldHJpY3NcbiAgICB0aGlzLm1ldHJpY3Muc2xvd1JlcXVlc3RzID0gMDtcbiAgfVxuXG4gIGdldFBlcmZvcm1hbmNlU3VtbWFyeSgpIHtcbiAgICBjb25zdCBzbG93UmVxdWVzdFBlcmNlbnRhZ2UgPSB0aGlzLm1ldHJpY3MudG90YWxSZXF1ZXN0cyA+IDAgXG4gICAgICA/ICh0aGlzLm1ldHJpY3Muc2xvd1JlcXVlc3RzIC8gdGhpcy5tZXRyaWNzLnRvdGFsUmVxdWVzdHMpICogMTAwIFxuICAgICAgOiAwO1xuXG4gICAgY29uc3QgcmVjZW50VGltaW5ncyA9IHRoaXMucmVxdWVzdFRpbWluZ3Muc2xpY2UoLTEwMCk7IC8vIExhc3QgMTAwIHJlcXVlc3RzXG4gICAgY29uc3Qgcm91dGVTdGF0cyA9IHRoaXMuZ2V0Um91dGVTdGF0aXN0aWNzKHJlY2VudFRpbWluZ3MpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHRvdGFsUmVxdWVzdHM6IHRoaXMubWV0cmljcy50b3RhbFJlcXVlc3RzLFxuICAgICAgYXZlcmFnZVJlc3BvbnNlVGltZTogTWF0aC5yb3VuZCh0aGlzLm1ldHJpY3MuYXZlcmFnZVJlc3BvbnNlVGltZSAqIDEwMCkgLyAxMDAsXG4gICAgICByZXF1ZXN0c1Blck1pbnV0ZTogdGhpcy5tZXRyaWNzLnJlcXVlc3RzUGVyTWludXRlLFxuICAgICAgZXJyb3JSYXRlOiBNYXRoLnJvdW5kKHRoaXMubWV0cmljcy5lcnJvclJhdGUgKiAxMDApIC8gMTAwLFxuICAgICAgc2xvd1JlcXVlc3RQZXJjZW50YWdlOiBNYXRoLnJvdW5kKHNsb3dSZXF1ZXN0UGVyY2VudGFnZSAqIDEwMCkgLyAxMDAsXG4gICAgICBzbG93UmVxdWVzdFRocmVzaG9sZDogdGhpcy5zbG93UmVxdWVzdFRocmVzaG9sZCxcbiAgICAgIHVwdGltZU1pbnV0ZXM6IE1hdGgucm91bmQoKERhdGUubm93KCkgLSB0aGlzLm1ldHJpY3MubGFzdFJlc2V0LmdldFRpbWUoKSkgLyAoMTAwMCAqIDYwKSksXG4gICAgICByb3V0ZVN0YXRzXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Um91dGVTdGF0aXN0aWNzKHRpbWluZ3M6IFJlcXVlc3RUaW1pbmdbXSkge1xuICAgIGNvbnN0IHJvdXRlTWFwID0gbmV3IE1hcDxzdHJpbmcsIHsgY291bnQ6IG51bWJlcjsgdG90YWxUaW1lOiBudW1iZXI7IGVycm9yczogbnVtYmVyIH0+KCk7XG4gICAgXG4gICAgZm9yIChjb25zdCB0aW1pbmcgb2YgdGltaW5ncykge1xuICAgICAgY29uc3Qga2V5ID0gYCR7dGltaW5nLm1ldGhvZH0gJHt0aW1pbmcucm91dGV9YDtcbiAgICAgIGNvbnN0IHN0YXRzID0gcm91dGVNYXAuZ2V0KGtleSkgfHwgeyBjb3VudDogMCwgdG90YWxUaW1lOiAwLCBlcnJvcnM6IDAgfTtcbiAgICAgIFxuICAgICAgc3RhdHMuY291bnQrKztcbiAgICAgIHN0YXRzLnRvdGFsVGltZSArPSB0aW1pbmcuZHVyYXRpb247XG4gICAgICBpZiAodGltaW5nLnN0YXR1c0NvZGUgPj0gNDAwKSB7XG4gICAgICAgIHN0YXRzLmVycm9ycysrO1xuICAgICAgfVxuICAgICAgXG4gICAgICByb3V0ZU1hcC5zZXQoa2V5LCBzdGF0cyk7XG4gICAgfVxuXG4gICAgY29uc3Qgcm91dGVTdGF0czogQXJyYXk8e1xuICAgICAgcm91dGU6IHN0cmluZztcbiAgICAgIHJlcXVlc3RDb3VudDogbnVtYmVyO1xuICAgICAgYXZlcmFnZVJlc3BvbnNlVGltZTogbnVtYmVyO1xuICAgICAgZXJyb3JSYXRlOiBudW1iZXI7XG4gICAgfT4gPSBbXTtcbiAgICBmb3IgKGNvbnN0IFtyb3V0ZSwgc3RhdHNdIG9mIHJvdXRlTWFwLmVudHJpZXMoKSkge1xuICAgICAgcm91dGVTdGF0cy5wdXNoKHtcbiAgICAgICAgcm91dGUsXG4gICAgICAgIHJlcXVlc3RDb3VudDogc3RhdHMuY291bnQsXG4gICAgICAgIGF2ZXJhZ2VSZXNwb25zZVRpbWU6IE1hdGgucm91bmQoKHN0YXRzLnRvdGFsVGltZSAvIHN0YXRzLmNvdW50KSAqIDEwMCkgLyAxMDAsXG4gICAgICAgIGVycm9yUmF0ZTogTWF0aC5yb3VuZCgoc3RhdHMuZXJyb3JzIC8gc3RhdHMuY291bnQpICogMTAwICogMTAwKSAvIDEwMFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gU29ydCBieSByZXF1ZXN0IGNvdW50IGRlc2NlbmRpbmdcbiAgICByZXR1cm4gcm91dGVTdGF0cy5zb3J0KChhLCBiKSA9PiBiLnJlcXVlc3RDb3VudCAtIGEucmVxdWVzdENvdW50KS5zbGljZSgwLCAxMCk7XG4gIH1cblxuICBnZXRTbG93ZXN0RW5kcG9pbnRzKGxpbWl0OiBudW1iZXIgPSAxMCkge1xuICAgIGNvbnN0IHJvdXRlTWFwID0gbmV3IE1hcDxzdHJpbmcsIHsgdGltZXM6IG51bWJlcltdOyBlcnJvcnM6IG51bWJlciB9PigpO1xuICAgIFxuICAgIGZvciAoY29uc3QgdGltaW5nIG9mIHRoaXMucmVxdWVzdFRpbWluZ3MpIHtcbiAgICAgIGNvbnN0IGtleSA9IGAke3RpbWluZy5tZXRob2R9ICR7dGltaW5nLnJvdXRlfWA7XG4gICAgICBjb25zdCBzdGF0cyA9IHJvdXRlTWFwLmdldChrZXkpIHx8IHsgdGltZXM6IFtdLCBlcnJvcnM6IDAgfTtcbiAgICAgIFxuICAgICAgc3RhdHMudGltZXMucHVzaCh0aW1pbmcuZHVyYXRpb24pO1xuICAgICAgaWYgKHRpbWluZy5zdGF0dXNDb2RlID49IDQwMCkge1xuICAgICAgICBzdGF0cy5lcnJvcnMrKztcbiAgICAgIH1cbiAgICAgIFxuICAgICAgcm91dGVNYXAuc2V0KGtleSwgc3RhdHMpO1xuICAgIH1cblxuICAgIGNvbnN0IGVuZHBvaW50U3RhdHM6IEFycmF5PHtcbiAgICAgIHJvdXRlOiBzdHJpbmc7XG4gICAgICByZXF1ZXN0Q291bnQ6IG51bWJlcjtcbiAgICAgIGF2ZXJhZ2VUaW1lOiBudW1iZXI7XG4gICAgICBtYXhUaW1lOiBudW1iZXI7XG4gICAgICBwOTVUaW1lOiBudW1iZXI7XG4gICAgICBlcnJvckNvdW50OiBudW1iZXI7XG4gICAgfT4gPSBbXTtcbiAgICBmb3IgKGNvbnN0IFtyb3V0ZSwgc3RhdHNdIG9mIHJvdXRlTWFwLmVudHJpZXMoKSkge1xuICAgICAgY29uc3QgYXZnVGltZSA9IHN0YXRzLnRpbWVzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApIC8gc3RhdHMudGltZXMubGVuZ3RoO1xuICAgICAgY29uc3QgbWF4VGltZSA9IE1hdGgubWF4KC4uLnN0YXRzLnRpbWVzKTtcbiAgICAgIGNvbnN0IHA5NVRpbWUgPSB0aGlzLnBlcmNlbnRpbGUoc3RhdHMudGltZXMsIDAuOTUpO1xuICAgICAgXG4gICAgICBlbmRwb2ludFN0YXRzLnB1c2goe1xuICAgICAgICByb3V0ZSxcbiAgICAgICAgcmVxdWVzdENvdW50OiBzdGF0cy50aW1lcy5sZW5ndGgsXG4gICAgICAgIGF2ZXJhZ2VUaW1lOiBNYXRoLnJvdW5kKGF2Z1RpbWUgKiAxMDApIC8gMTAwLFxuICAgICAgICBtYXhUaW1lOiBNYXRoLnJvdW5kKG1heFRpbWUgKiAxMDApIC8gMTAwLFxuICAgICAgICBwOTVUaW1lOiBNYXRoLnJvdW5kKHA5NVRpbWUgKiAxMDApIC8gMTAwLFxuICAgICAgICBlcnJvckNvdW50OiBzdGF0cy5lcnJvcnNcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBlbmRwb2ludFN0YXRzXG4gICAgICAuc29ydCgoYSwgYikgPT4gYi5hdmVyYWdlVGltZSAtIGEuYXZlcmFnZVRpbWUpXG4gICAgICAuc2xpY2UoMCwgbGltaXQpO1xuICB9XG5cbiAgcHJpdmF0ZSBwZXJjZW50aWxlKGFycjogbnVtYmVyW10sIHA6IG51bWJlcik6IG51bWJlciB7XG4gICAgY29uc3Qgc29ydGVkID0gWy4uLmFycl0uc29ydCgoYSwgYikgPT4gYSAtIGIpO1xuICAgIGNvbnN0IGluZGV4ID0gTWF0aC5jZWlsKHNvcnRlZC5sZW5ndGggKiBwKSAtIDE7XG4gICAgcmV0dXJuIHNvcnRlZFtpbmRleF0gfHwgMDtcbiAgfVxuXG4gIGdldEhlYWx0aFN0YXR1cygpIHtcbiAgICBjb25zdCBzdW1tYXJ5ID0gdGhpcy5nZXRQZXJmb3JtYW5jZVN1bW1hcnkoKTtcbiAgICBjb25zdCBtZW1Vc2FnZU1CID0gdGhpcy5tZXRyaWNzLm1lbW9yeVVzYWdlLmhlYXBVc2VkIC8gMTAyNCAvIDEwMjQ7XG4gICAgXG4gICAgY29uc3QgaXNIZWFsdGh5ID0gXG4gICAgICBzdW1tYXJ5LmF2ZXJhZ2VSZXNwb25zZVRpbWUgPCAxMDAwICYmXG4gICAgICBzdW1tYXJ5LmVycm9yUmF0ZSA8IDEwICYmXG4gICAgICBzdW1tYXJ5LnNsb3dSZXF1ZXN0UGVyY2VudGFnZSA8IDIwICYmXG4gICAgICBtZW1Vc2FnZU1CIDwgNTEyOyAvLyA1MTJNQiB0aHJlc2hvbGRcblxuICAgIHJldHVybiB7XG4gICAgICBoZWFsdGh5OiBpc0hlYWx0aHksXG4gICAgICBkZXRhaWxzOiB7XG4gICAgICAgIHJlc3BvbnNlVGltZTogc3VtbWFyeS5hdmVyYWdlUmVzcG9uc2VUaW1lIDwgMTAwMCA/ICdnb29kJyA6ICdzbG93JyxcbiAgICAgICAgZXJyb3JSYXRlOiBzdW1tYXJ5LmVycm9yUmF0ZSA8IDUgPyAnZ29vZCcgOiBzdW1tYXJ5LmVycm9yUmF0ZSA8IDEwID8gJ3dhcm5pbmcnIDogJ2NyaXRpY2FsJyxcbiAgICAgICAgbWVtb3J5VXNhZ2U6IG1lbVVzYWdlTUIgPCAyNTYgPyAnZ29vZCcgOiBtZW1Vc2FnZU1CIDwgNTEyID8gJ3dhcm5pbmcnIDogJ2NyaXRpY2FsJyxcbiAgICAgICAgcGVyZm9ybWFuY2U6IHN1bW1hcnlcbiAgICAgIH1cbiAgICB9O1xuICB9XG59XG5cbi8vIEdsb2JhbCBpbnN0YW5jZVxuY29uc3QgcGVyZm9ybWFuY2VNb25pdG9yID0gbmV3IFBlcmZvcm1hbmNlTW9uaXRvcigpO1xuXG5leHBvcnQgeyBwZXJmb3JtYW5jZU1vbml0b3IgfTtcbmV4cG9ydCBkZWZhdWx0IHBlcmZvcm1hbmNlTW9uaXRvci5taWRkbGV3YXJlKCk7Il0sInZlcnNpb24iOjN9