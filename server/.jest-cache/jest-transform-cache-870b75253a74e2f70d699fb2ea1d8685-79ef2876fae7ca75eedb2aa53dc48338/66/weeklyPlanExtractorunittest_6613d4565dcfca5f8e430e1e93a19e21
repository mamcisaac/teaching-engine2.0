96d5486dddf6e4e6fd892c5b2411c975
import { jest, describe, it, beforeEach, expect } from '@jest/globals';
jest.mock('../../src/services/subPlanService', () => ({
    buildSubPlanData: mockBuildSubPlanData,
}));
// Mock all the helper functions that weeklyPlanExtractor uses
jest.mock('../../src/services/weeklyPlanExtractor', () => {
    const actual = jest.requireActual('../../src/services/weeklyPlanExtractor');
    return {
        ...actual,
        extractWeeklyOverview: jest.fn().mockResolvedValue({
            subjects: [],
            unitPlans: [],
            assessments: [],
            specialEvents: []
        }),
        generateContinuityNotes: jest.fn().mockReturnValue([]),
        generateEmergencyBackupPlans: jest.fn().mockResolvedValue([])
    };
});
import { extractWeeklyPlan } from '../../src/services/weeklyPlanExtractor';
// Mock the subPlanService
const mockBuildSubPlanData = jest.fn();
describe('WeeklyPlanExtractor', () => {
    beforeEach(() => {
        jest.clearAllMocks();
    });
    describe('extractWeeklyPlan', () => {
        it('should extract weekly plan data for multiple days', async () => {
            // Mock data
            const mockSubject = {
                id: 1,
                name: 'Mathematics',
                nameEn: 'Mathematics',
                nameFr: 'Mathématiques',
            };
            const mockMilestone = {
                id: 1,
                title: 'Number Operations',
                targetDate: new Date('2024-01-31'),
                subject: mockSubject,
                activities: [],
            };
            const mockActivity = {
                id: 1,
                title: 'Addition Practice',
                milestone: { subject: mockSubject },
                outcomes: [],
            };
            const mockDailyPlan = {
                id: 1,
                date: new Date('2024-01-15'),
                items: [
                    {
                        id: 1,
                        startMin: 540, // 9:00 AM
                        activity: mockActivity,
                        slot: { subject: mockSubject },
                    },
                ],
            };
            // Setup mocks
            const mockSubPlanData = {
                date: '2024-01-15',
                schedule: [
                    { time: '09:00', activity: 'Mathematics - Addition Practice', note: 'Use manipulatives' }
                ],
                pullOuts: [],
                contacts: { 'Principal': 'Ext. 100', 'Office': 'Ext. 101' },
                outcomes: [
                    { code: 'M1.1', description: 'Add numbers to 20', subject: 'Mathematics' }
                ]
            };
            mockBuildSubPlanData.mockResolvedValue(mockSubPlanData);
            const result = await extractWeeklyPlan('2024-01-15', 3, { userId: 1 });
            expect(result).toHaveProperty('startDate', '2024-01-15');
            expect(result).toHaveProperty('days');
            expect(result.days).toHaveLength(3);
            expect(result).toHaveProperty('weeklyOverview');
            expect(result.weeklyOverview).toHaveProperty('subjects');
            expect(result.weeklyOverview).toHaveProperty('milestones');
            expect(result).toHaveProperty('continuityNotes');
            expect(result).toHaveProperty('emergencyBackupPlans');
        });
        it('should generate continuity notes between days', async () => {
            // Setup mock data for consecutive days with related activities
            const mockSubject = { id: 1, name: 'Mathematics' };
            const mockPlans = [
                {
                    id: 1,
                    date: new Date('2024-01-15'),
                    items: [
                        {
                            id: 1,
                            startMin: 540,
                            activity: {
                                id: 1,
                                title: 'Introduction to Fractions',
                                milestone: { subject: mockSubject },
                            },
                            slot: { subject: mockSubject },
                        },
                    ],
                },
                {
                    id: 2,
                    date: new Date('2024-01-16'),
                    items: [
                        {
                            id: 2,
                            startMin: 540,
                            activity: {
                                id: 2,
                                title: 'Fraction Operations',
                                milestone: { subject: mockSubject },
                            },
                            slot: { subject: mockSubject },
                        },
                    ],
                },
            ];
            // Mock different data for each day to test continuity
            mockBuildSubPlanData
                .mockResolvedValueOnce({
                date: '2024-01-15',
                schedule: [{ time: '09:00', activity: 'Addition Practice' }],
                pullOuts: [],
                contacts: {},
            })
                .mockResolvedValueOnce({
                date: '2024-01-16',
                schedule: [{ time: '09:00', activity: 'Fraction Operations' }],
                pullOuts: [],
                contacts: {},
            });
            const result = await extractWeeklyPlan('2024-01-15', 2, { userId: 1 });
            expect(result.continuityNotes).toHaveLength(2);
            const day2Notes = result.continuityNotes[1];
            expect(day2Notes.connections.length).toBeGreaterThan(0);
            expect(day2Notes.connections[0]).toContain('Mathematics');
            expect(day2Notes.connections[0]).toContain('Introduction to Fractions');
            expect(day2Notes.connections[0]).toContain('Fraction Operations');
        });
        it('should generate emergency backup plans by subject', async () => {
            const mockSubjects = [
                {
                    id: 1,
                    name: 'Mathematics',
                    activities: [
                        { id: 1, title: 'Math Review Worksheets', isFallback: true },
                        { id: 2, title: 'Number Games', isFallback: true },
                    ],
                },
                {
                    id: 2,
                    name: 'Language Arts',
                    activities: [{ id: 3, title: 'Silent Reading', isFallback: true }],
                },
            ];
            // Mock empty day data
            mockBuildSubPlanData.mockResolvedValue({
                date: '2024-01-15',
                schedule: [],
                pullOuts: [],
                contacts: {},
            });
            const result = await extractWeeklyPlan('2024-01-15', 1, { userId: 1 });
            expect(result.emergencyBackupPlans).toHaveLength(2);
            const mathPlan = result.emergencyBackupPlans.find((p) => p.subject === 'Mathematics');
            expect(mathPlan).toBeDefined();
            expect(mathPlan?.activities).toContain('Math Review Worksheets');
            expect(mathPlan?.activities).toContain('Number Games');
            expect(mathPlan?.materials).toContain('Math manipulatives');
            const langPlan = result.emergencyBackupPlans.find((p) => p.subject === 'Language Arts');
            expect(langPlan).toBeDefined();
            expect(langPlan?.activities).toContain('Silent Reading');
            expect(langPlan?.materials).toContain('Reading books');
        });
        it('should calculate subject hours and topics correctly', async () => {
            const mockSubject = { id: 1, name: 'Mathematics' };
            const mockDailyPlan = {
                id: 1,
                date: new Date('2024-01-15'),
                items: [
                    {
                        id: 1,
                        startMin: 540, // 9:00 AM - assuming 15-minute slots
                        activity: {
                            id: 1,
                            title: 'Addition',
                            milestone: { subject: mockSubject },
                            outcomes: [],
                        },
                        slot: { subject: mockSubject },
                    },
                    {
                        id: 2,
                        startMin: 555, // 9:15 AM
                        activity: {
                            id: 2,
                            title: 'Subtraction',
                            milestone: { subject: mockSubject },
                            outcomes: [],
                        },
                        slot: { subject: mockSubject },
                    },
                    {
                        id: 3,
                        startMin: 570, // 9:30 AM
                        activity: {
                            id: 3,
                            title: 'Word Problems',
                            milestone: { subject: mockSubject },
                            outcomes: [],
                        },
                        slot: { subject: mockSubject },
                    },
                ],
            };
            // Mock calculation data for testing subject hours
            mockBuildSubPlanData.mockResolvedValue({
                date: '2024-01-15',
                schedule: [
                    { time: '09:00', activity: 'Mathematics - Addition' },
                    { time: '09:15', activity: 'Mathematics - Subtraction' },
                    { time: '09:30', activity: 'Mathematics - Word Problems' }
                ],
                pullOuts: [],
                contacts: {},
                outcomes: [
                    { code: 'M1.1', description: 'Add and subtract', subject: 'Mathematics' }
                ]
            });
            const result = await extractWeeklyPlan('2024-01-15', 1, { userId: 1 });
            const mathSubject = result.weeklyOverview.subjects.find((s) => s.name === 'Mathematics');
            expect(mathSubject).toBeDefined();
            expect(mathSubject?.totalHours).toBe(0.75); // 3 slots × 0.25 hours each
            expect(mathSubject?.keyTopics).toContain('Addition');
            expect(mathSubject?.keyTopics).toContain('Subtraction');
            expect(mathSubject?.keyTopics).toContain('Word Problems');
        });
        it('should handle empty days gracefully', async () => {
            // Mock empty day
            mockBuildSubPlanData.mockResolvedValue({
                date: '2024-01-15',
                schedule: [],
                pullOuts: [],
                contacts: {},
            });
            const result = await extractWeeklyPlan('2024-01-15', 3, { userId: 1 });
            expect(result.startDate).toBe('2024-01-15');
            expect(result.days).toHaveLength(3);
            expect(result.weeklyOverview.subjects).toHaveLength(0);
            expect(result.weeklyOverview.milestones).toHaveLength(0);
            expect(result.continuityNotes).toHaveLength(3);
            expect(result.emergencyBackupPlans).toHaveLength(0);
        });
        it('should respect user options for data inclusion', async () => {
            const mockDailyPlan = {
                id: 1,
                date: new Date('2024-01-15'),
                items: [],
            };
            // Mock for user options test
            mockBuildSubPlanData.mockResolvedValue({
                date: '2024-01-15',
                schedule: [{ time: '09:00', activity: 'Test Activity' }],
                pullOuts: [],
                contacts: {},
                goals: [{ id: 1, text: 'Test goal', status: 'active' }],
                routines: [{ id: 1, title: 'Morning routine', description: 'Test', category: 'morning' }]
            });
            // Test with includeGoals: false
            const result = await extractWeeklyPlan('2024-01-15', 1, {
                userId: 1,
                includeGoals: false,
                includeRoutines: false,
                includePlans: false,
            });
            expect(result.days[0].goals).toBeUndefined();
            expect(result.days[0].routines).toBeUndefined();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3Rlc3RzL3VuaXQvd2Vla2x5UGxhbkV4dHJhY3Rvci51bml0LnRlc3QudHMiLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFLdkUsSUFBSSxDQUFDLElBQUksQ0FBQyxtQ0FBbUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ3BELGdCQUFnQixFQUFFLG9CQUFvQjtDQUN2QyxDQUFDLENBQUMsQ0FBQztBQUVKLDhEQUE4RDtBQUM5RCxJQUFJLENBQUMsSUFBSSxDQUFDLHdDQUF3QyxFQUFFLEdBQUcsRUFBRTtJQUN2RCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLHdDQUF3QyxDQUFDLENBQUM7SUFDNUUsT0FBTztRQUNMLEdBQUcsTUFBTTtRQUNULHFCQUFxQixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQztZQUNqRCxRQUFRLEVBQUUsRUFBRTtZQUNaLFNBQVMsRUFBRSxFQUFFO1lBQ2IsV0FBVyxFQUFFLEVBQUU7WUFDZixhQUFhLEVBQUUsRUFBRTtTQUNsQixDQUFDO1FBQ0YsdUJBQXVCLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQyxFQUFFLENBQUM7UUFDdEQsNEJBQTRCLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLEVBQUUsQ0FBQztLQUM5RCxDQUFDO0FBQ0osQ0FBQyxDQUFDLENBQUM7QUF0QkgsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFFM0UsMEJBQTBCO0FBQzFCLE1BQU0sb0JBQW9CLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBcUJ2QyxRQUFRLENBQUMscUJBQXFCLEVBQUUsR0FBRyxFQUFFO0lB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WUFFSCxnQ0FBZ0M7WUFDaEMsTUFBTSxNQUFNLEdBQUcsTUFBTSxpQkFBaUIsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxFQUFFO2dCQUN0RCxNQUFNLEVBQUUsQ0FBQztnQkFDVCxZQUFZLEVBQUUsS0FBSztnQkFDbkIsZUFBZSxFQUFFLEtBQUs7Z0JBQ3RCLFlBQVksRUFBRSxLQUFLO2FBQ3BCLENBQUMsQ0FBQztZQUVILE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQzdDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ2xELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWljaGFlbG1jaXNhYWMvR2l0SHViL3RlYWNoaW5nLWVuZ2luZTIuMC9zZXJ2ZXIvdGVzdHMvdW5pdC93ZWVrbHlQbGFuRXh0cmFjdG9yLnVuaXQudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBqZXN0LCBkZXNjcmliZSwgaXQsIGJlZm9yZUVhY2gsIGV4cGVjdCB9IGZyb20gJ0BqZXN0L2dsb2JhbHMnO1xuaW1wb3J0IHsgZXh0cmFjdFdlZWtseVBsYW4gfSBmcm9tICcuLi8uLi9zcmMvc2VydmljZXMvd2Vla2x5UGxhbkV4dHJhY3Rvcic7XG5cbi8vIE1vY2sgdGhlIHN1YlBsYW5TZXJ2aWNlXG5jb25zdCBtb2NrQnVpbGRTdWJQbGFuRGF0YSA9IGplc3QuZm4oKTtcbmplc3QubW9jaygnLi4vLi4vc3JjL3NlcnZpY2VzL3N1YlBsYW5TZXJ2aWNlJywgKCkgPT4gKHtcbiAgYnVpbGRTdWJQbGFuRGF0YTogbW9ja0J1aWxkU3ViUGxhbkRhdGEsXG59KSk7XG5cbi8vIE1vY2sgYWxsIHRoZSBoZWxwZXIgZnVuY3Rpb25zIHRoYXQgd2Vla2x5UGxhbkV4dHJhY3RvciB1c2VzXG5qZXN0Lm1vY2soJy4uLy4uL3NyYy9zZXJ2aWNlcy93ZWVrbHlQbGFuRXh0cmFjdG9yJywgKCkgPT4ge1xuICBjb25zdCBhY3R1YWwgPSBqZXN0LnJlcXVpcmVBY3R1YWwoJy4uLy4uL3NyYy9zZXJ2aWNlcy93ZWVrbHlQbGFuRXh0cmFjdG9yJyk7XG4gIHJldHVybiB7XG4gICAgLi4uYWN0dWFsLFxuICAgIGV4dHJhY3RXZWVrbHlPdmVydmlldzogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgIHN1YmplY3RzOiBbXSxcbiAgICAgIHVuaXRQbGFuczogW10sXG4gICAgICBhc3Nlc3NtZW50czogW10sXG4gICAgICBzcGVjaWFsRXZlbnRzOiBbXVxuICAgIH0pLFxuICAgIGdlbmVyYXRlQ29udGludWl0eU5vdGVzOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKFtdKSxcbiAgICBnZW5lcmF0ZUVtZXJnZW5jeUJhY2t1cFBsYW5zOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoW10pXG4gIH07XG59KTtcblxuZGVzY3JpYmUoJ1dlZWtseVBsYW5FeHRyYWN0b3InLCAoKSA9PiB7XG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICB9KTtcblxuICBkZXNjcmliZSgnZXh0cmFjdFdlZWtseVBsYW4nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBleHRyYWN0IHdlZWtseSBwbGFuIGRhdGEgZm9yIG11bHRpcGxlIGRheXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBNb2NrIGRhdGFcbiAgICAgIGNvbnN0IG1vY2tTdWJqZWN0ID0ge1xuICAgICAgICBpZDogMSxcbiAgICAgICAgbmFtZTogJ01hdGhlbWF0aWNzJyxcbiAgICAgICAgbmFtZUVuOiAnTWF0aGVtYXRpY3MnLFxuICAgICAgICBuYW1lRnI6ICdNYXRow6ltYXRpcXVlcycsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBtb2NrTWlsZXN0b25lID0ge1xuICAgICAgICBpZDogMSxcbiAgICAgICAgdGl0bGU6ICdOdW1iZXIgT3BlcmF0aW9ucycsXG4gICAgICAgIHRhcmdldERhdGU6IG5ldyBEYXRlKCcyMDI0LTAxLTMxJyksXG4gICAgICAgIHN1YmplY3Q6IG1vY2tTdWJqZWN0LFxuICAgICAgICBhY3Rpdml0aWVzOiBbXSxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IG1vY2tBY3Rpdml0eSA9IHtcbiAgICAgICAgaWQ6IDEsXG4gICAgICAgIHRpdGxlOiAnQWRkaXRpb24gUHJhY3RpY2UnLFxuICAgICAgICBtaWxlc3RvbmU6IHsgc3ViamVjdDogbW9ja1N1YmplY3QgfSxcbiAgICAgICAgb3V0Y29tZXM6IFtdLFxuICAgICAgfTtcblxuICAgICAgY29uc3QgbW9ja0RhaWx5UGxhbiA9IHtcbiAgICAgICAgaWQ6IDEsXG4gICAgICAgIGRhdGU6IG5ldyBEYXRlKCcyMDI0LTAxLTE1JyksXG4gICAgICAgIGl0ZW1zOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgaWQ6IDEsXG4gICAgICAgICAgICBzdGFydE1pbjogNTQwLCAvLyA5OjAwIEFNXG4gICAgICAgICAgICBhY3Rpdml0eTogbW9ja0FjdGl2aXR5LFxuICAgICAgICAgICAgc2xvdDogeyBzdWJqZWN0OiBtb2NrU3ViamVjdCB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICB9O1xuXG4gICAgICAvLyBTZXR1cCBtb2Nrc1xuICAgICAgY29uc3QgbW9ja1N1YlBsYW5EYXRhID0ge1xuICAgICAgICBkYXRlOiAnMjAyNC0wMS0xNScsXG4gICAgICAgIHNjaGVkdWxlOiBbXG4gICAgICAgICAgeyB0aW1lOiAnMDk6MDAnLCBhY3Rpdml0eTogJ01hdGhlbWF0aWNzIC0gQWRkaXRpb24gUHJhY3RpY2UnLCBub3RlOiAnVXNlIG1hbmlwdWxhdGl2ZXMnIH1cbiAgICAgICAgXSxcbiAgICAgICAgcHVsbE91dHM6IFtdLFxuICAgICAgICBjb250YWN0czogeyAnUHJpbmNpcGFsJzogJ0V4dC4gMTAwJywgJ09mZmljZSc6ICdFeHQuIDEwMScgfSxcbiAgICAgICAgb3V0Y29tZXM6IFtcbiAgICAgICAgICB7IGNvZGU6ICdNMS4xJywgZGVzY3JpcHRpb246ICdBZGQgbnVtYmVycyB0byAyMCcsIHN1YmplY3Q6ICdNYXRoZW1hdGljcycgfVxuICAgICAgICBdXG4gICAgICB9O1xuICAgICAgXG4gICAgICBtb2NrQnVpbGRTdWJQbGFuRGF0YS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrU3ViUGxhbkRhdGEpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBleHRyYWN0V2Vla2x5UGxhbignMjAyNC0wMS0xNScsIDMsIHsgdXNlcklkOiAxIH0pO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0hhdmVQcm9wZXJ0eSgnc3RhcnREYXRlJywgJzIwMjQtMDEtMTUnKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvSGF2ZVByb3BlcnR5KCdkYXlzJyk7XG4gICAgICBleHBlY3QocmVzdWx0LmRheXMpLnRvSGF2ZUxlbmd0aCgzKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvSGF2ZVByb3BlcnR5KCd3ZWVrbHlPdmVydmlldycpO1xuICAgICAgZXhwZWN0KHJlc3VsdC53ZWVrbHlPdmVydmlldykudG9IYXZlUHJvcGVydHkoJ3N1YmplY3RzJyk7XG4gICAgICBleHBlY3QocmVzdWx0LndlZWtseU92ZXJ2aWV3KS50b0hhdmVQcm9wZXJ0eSgnbWlsZXN0b25lcycpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9IYXZlUHJvcGVydHkoJ2NvbnRpbnVpdHlOb3RlcycpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9IYXZlUHJvcGVydHkoJ2VtZXJnZW5jeUJhY2t1cFBsYW5zJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGdlbmVyYXRlIGNvbnRpbnVpdHkgbm90ZXMgYmV0d2VlbiBkYXlzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gU2V0dXAgbW9jayBkYXRhIGZvciBjb25zZWN1dGl2ZSBkYXlzIHdpdGggcmVsYXRlZCBhY3Rpdml0aWVzXG4gICAgICBjb25zdCBtb2NrU3ViamVjdCA9IHsgaWQ6IDEsIG5hbWU6ICdNYXRoZW1hdGljcycgfTtcblxuICAgICAgY29uc3QgbW9ja1BsYW5zID0gW1xuICAgICAgICB7XG4gICAgICAgICAgaWQ6IDEsXG4gICAgICAgICAgZGF0ZTogbmV3IERhdGUoJzIwMjQtMDEtMTUnKSxcbiAgICAgICAgICBpdGVtczogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBpZDogMSxcbiAgICAgICAgICAgICAgc3RhcnRNaW46IDU0MCxcbiAgICAgICAgICAgICAgYWN0aXZpdHk6IHtcbiAgICAgICAgICAgICAgICBpZDogMSxcbiAgICAgICAgICAgICAgICB0aXRsZTogJ0ludHJvZHVjdGlvbiB0byBGcmFjdGlvbnMnLFxuICAgICAgICAgICAgICAgIG1pbGVzdG9uZTogeyBzdWJqZWN0OiBtb2NrU3ViamVjdCB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBzbG90OiB7IHN1YmplY3Q6IG1vY2tTdWJqZWN0IH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIF0sXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBpZDogMixcbiAgICAgICAgICBkYXRlOiBuZXcgRGF0ZSgnMjAyNC0wMS0xNicpLFxuICAgICAgICAgIGl0ZW1zOiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIGlkOiAyLFxuICAgICAgICAgICAgICBzdGFydE1pbjogNTQwLFxuICAgICAgICAgICAgICBhY3Rpdml0eToge1xuICAgICAgICAgICAgICAgIGlkOiAyLFxuICAgICAgICAgICAgICAgIHRpdGxlOiAnRnJhY3Rpb24gT3BlcmF0aW9ucycsXG4gICAgICAgICAgICAgICAgbWlsZXN0b25lOiB7IHN1YmplY3Q6IG1vY2tTdWJqZWN0IH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIHNsb3Q6IHsgc3ViamVjdDogbW9ja1N1YmplY3QgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICAgIF07XG5cbiAgICAgIC8vIE1vY2sgZGlmZmVyZW50IGRhdGEgZm9yIGVhY2ggZGF5IHRvIHRlc3QgY29udGludWl0eVxuICAgICAgbW9ja0J1aWxkU3ViUGxhbkRhdGFcbiAgICAgICAgLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7XG4gICAgICAgICAgZGF0ZTogJzIwMjQtMDEtMTUnLFxuICAgICAgICAgIHNjaGVkdWxlOiBbeyB0aW1lOiAnMDk6MDAnLCBhY3Rpdml0eTogJ0FkZGl0aW9uIFByYWN0aWNlJyB9XSxcbiAgICAgICAgICBwdWxsT3V0czogW10sXG4gICAgICAgICAgY29udGFjdHM6IHt9LFxuICAgICAgICB9KVxuICAgICAgICAubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHtcbiAgICAgICAgICBkYXRlOiAnMjAyNC0wMS0xNicsIFxuICAgICAgICAgIHNjaGVkdWxlOiBbeyB0aW1lOiAnMDk6MDAnLCBhY3Rpdml0eTogJ0ZyYWN0aW9uIE9wZXJhdGlvbnMnIH1dLFxuICAgICAgICAgIHB1bGxPdXRzOiBbXSxcbiAgICAgICAgICBjb250YWN0czoge30sXG4gICAgICAgIH0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBleHRyYWN0V2Vla2x5UGxhbignMjAyNC0wMS0xNScsIDIsIHsgdXNlcklkOiAxIH0pO1xuXG4gICAgICBleHBlY3QocmVzdWx0LmNvbnRpbnVpdHlOb3RlcykudG9IYXZlTGVuZ3RoKDIpO1xuXG4gICAgICBjb25zdCBkYXkyTm90ZXMgPSByZXN1bHQuY29udGludWl0eU5vdGVzWzFdO1xuICAgICAgZXhwZWN0KGRheTJOb3Rlcy5jb25uZWN0aW9ucy5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICAgIGV4cGVjdChkYXkyTm90ZXMuY29ubmVjdGlvbnNbMF0pLnRvQ29udGFpbignTWF0aGVtYXRpY3MnKTtcbiAgICAgIGV4cGVjdChkYXkyTm90ZXMuY29ubmVjdGlvbnNbMF0pLnRvQ29udGFpbignSW50cm9kdWN0aW9uIHRvIEZyYWN0aW9ucycpO1xuICAgICAgZXhwZWN0KGRheTJOb3Rlcy5jb25uZWN0aW9uc1swXSkudG9Db250YWluKCdGcmFjdGlvbiBPcGVyYXRpb25zJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGdlbmVyYXRlIGVtZXJnZW5jeSBiYWNrdXAgcGxhbnMgYnkgc3ViamVjdCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tTdWJqZWN0cyA9IFtcbiAgICAgICAge1xuICAgICAgICAgIGlkOiAxLFxuICAgICAgICAgIG5hbWU6ICdNYXRoZW1hdGljcycsXG4gICAgICAgICAgYWN0aXZpdGllczogW1xuICAgICAgICAgICAgeyBpZDogMSwgdGl0bGU6ICdNYXRoIFJldmlldyBXb3Jrc2hlZXRzJywgaXNGYWxsYmFjazogdHJ1ZSB9LFxuICAgICAgICAgICAgeyBpZDogMiwgdGl0bGU6ICdOdW1iZXIgR2FtZXMnLCBpc0ZhbGxiYWNrOiB0cnVlIH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGlkOiAyLFxuICAgICAgICAgIG5hbWU6ICdMYW5ndWFnZSBBcnRzJyxcbiAgICAgICAgICBhY3Rpdml0aWVzOiBbeyBpZDogMywgdGl0bGU6ICdTaWxlbnQgUmVhZGluZycsIGlzRmFsbGJhY2s6IHRydWUgfV0sXG4gICAgICAgIH0sXG4gICAgICBdO1xuXG4gICAgICAvLyBNb2NrIGVtcHR5IGRheSBkYXRhXG4gICAgICBtb2NrQnVpbGRTdWJQbGFuRGF0YS5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gICAgICAgIGRhdGU6ICcyMDI0LTAxLTE1JyxcbiAgICAgICAgc2NoZWR1bGU6IFtdLFxuICAgICAgICBwdWxsT3V0czogW10sXG4gICAgICAgIGNvbnRhY3RzOiB7fSxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBleHRyYWN0V2Vla2x5UGxhbignMjAyNC0wMS0xNScsIDEsIHsgdXNlcklkOiAxIH0pO1xuXG4gICAgICBleHBlY3QocmVzdWx0LmVtZXJnZW5jeUJhY2t1cFBsYW5zKS50b0hhdmVMZW5ndGgoMik7XG5cbiAgICAgIGNvbnN0IG1hdGhQbGFuID0gcmVzdWx0LmVtZXJnZW5jeUJhY2t1cFBsYW5zLmZpbmQoKHApID0+IHAuc3ViamVjdCA9PT0gJ01hdGhlbWF0aWNzJyk7XG4gICAgICBleHBlY3QobWF0aFBsYW4pLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QobWF0aFBsYW4/LmFjdGl2aXRpZXMpLnRvQ29udGFpbignTWF0aCBSZXZpZXcgV29ya3NoZWV0cycpO1xuICAgICAgZXhwZWN0KG1hdGhQbGFuPy5hY3Rpdml0aWVzKS50b0NvbnRhaW4oJ051bWJlciBHYW1lcycpO1xuICAgICAgZXhwZWN0KG1hdGhQbGFuPy5tYXRlcmlhbHMpLnRvQ29udGFpbignTWF0aCBtYW5pcHVsYXRpdmVzJyk7XG5cbiAgICAgIGNvbnN0IGxhbmdQbGFuID0gcmVzdWx0LmVtZXJnZW5jeUJhY2t1cFBsYW5zLmZpbmQoKHApID0+IHAuc3ViamVjdCA9PT0gJ0xhbmd1YWdlIEFydHMnKTtcbiAgICAgIGV4cGVjdChsYW5nUGxhbikudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChsYW5nUGxhbj8uYWN0aXZpdGllcykudG9Db250YWluKCdTaWxlbnQgUmVhZGluZycpO1xuICAgICAgZXhwZWN0KGxhbmdQbGFuPy5tYXRlcmlhbHMpLnRvQ29udGFpbignUmVhZGluZyBib29rcycpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBjYWxjdWxhdGUgc3ViamVjdCBob3VycyBhbmQgdG9waWNzIGNvcnJlY3RseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tTdWJqZWN0ID0geyBpZDogMSwgbmFtZTogJ01hdGhlbWF0aWNzJyB9O1xuXG4gICAgICBjb25zdCBtb2NrRGFpbHlQbGFuID0ge1xuICAgICAgICBpZDogMSxcbiAgICAgICAgZGF0ZTogbmV3IERhdGUoJzIwMjQtMDEtMTUnKSxcbiAgICAgICAgaXRlbXM6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBpZDogMSxcbiAgICAgICAgICAgIHN0YXJ0TWluOiA1NDAsIC8vIDk6MDAgQU0gLSBhc3N1bWluZyAxNS1taW51dGUgc2xvdHNcbiAgICAgICAgICAgIGFjdGl2aXR5OiB7XG4gICAgICAgICAgICAgIGlkOiAxLFxuICAgICAgICAgICAgICB0aXRsZTogJ0FkZGl0aW9uJyxcbiAgICAgICAgICAgICAgbWlsZXN0b25lOiB7IHN1YmplY3Q6IG1vY2tTdWJqZWN0IH0sXG4gICAgICAgICAgICAgIG91dGNvbWVzOiBbXSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzbG90OiB7IHN1YmplY3Q6IG1vY2tTdWJqZWN0IH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBpZDogMixcbiAgICAgICAgICAgIHN0YXJ0TWluOiA1NTUsIC8vIDk6MTUgQU1cbiAgICAgICAgICAgIGFjdGl2aXR5OiB7XG4gICAgICAgICAgICAgIGlkOiAyLFxuICAgICAgICAgICAgICB0aXRsZTogJ1N1YnRyYWN0aW9uJyxcbiAgICAgICAgICAgICAgbWlsZXN0b25lOiB7IHN1YmplY3Q6IG1vY2tTdWJqZWN0IH0sXG4gICAgICAgICAgICAgIG91dGNvbWVzOiBbXSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzbG90OiB7IHN1YmplY3Q6IG1vY2tTdWJqZWN0IH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBpZDogMyxcbiAgICAgICAgICAgIHN0YXJ0TWluOiA1NzAsIC8vIDk6MzAgQU1cbiAgICAgICAgICAgIGFjdGl2aXR5OiB7XG4gICAgICAgICAgICAgIGlkOiAzLFxuICAgICAgICAgICAgICB0aXRsZTogJ1dvcmQgUHJvYmxlbXMnLFxuICAgICAgICAgICAgICBtaWxlc3RvbmU6IHsgc3ViamVjdDogbW9ja1N1YmplY3QgfSxcbiAgICAgICAgICAgICAgb3V0Y29tZXM6IFtdLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNsb3Q6IHsgc3ViamVjdDogbW9ja1N1YmplY3QgfSxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgfTtcblxuICAgICAgLy8gTW9jayBjYWxjdWxhdGlvbiBkYXRhIGZvciB0ZXN0aW5nIHN1YmplY3QgaG91cnNcbiAgICAgIG1vY2tCdWlsZFN1YlBsYW5EYXRhLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgZGF0ZTogJzIwMjQtMDEtMTUnLFxuICAgICAgICBzY2hlZHVsZTogW1xuICAgICAgICAgIHsgdGltZTogJzA5OjAwJywgYWN0aXZpdHk6ICdNYXRoZW1hdGljcyAtIEFkZGl0aW9uJyB9LFxuICAgICAgICAgIHsgdGltZTogJzA5OjE1JywgYWN0aXZpdHk6ICdNYXRoZW1hdGljcyAtIFN1YnRyYWN0aW9uJyB9LFxuICAgICAgICAgIHsgdGltZTogJzA5OjMwJywgYWN0aXZpdHk6ICdNYXRoZW1hdGljcyAtIFdvcmQgUHJvYmxlbXMnIH1cbiAgICAgICAgXSxcbiAgICAgICAgcHVsbE91dHM6IFtdLFxuICAgICAgICBjb250YWN0czoge30sXG4gICAgICAgIG91dGNvbWVzOiBbXG4gICAgICAgICAgeyBjb2RlOiAnTTEuMScsIGRlc2NyaXB0aW9uOiAnQWRkIGFuZCBzdWJ0cmFjdCcsIHN1YmplY3Q6ICdNYXRoZW1hdGljcycgfVxuICAgICAgICBdXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZXh0cmFjdFdlZWtseVBsYW4oJzIwMjQtMDEtMTUnLCAxLCB7IHVzZXJJZDogMSB9KTtcblxuICAgICAgY29uc3QgbWF0aFN1YmplY3QgPSByZXN1bHQud2Vla2x5T3ZlcnZpZXcuc3ViamVjdHMuZmluZCgocykgPT4gcy5uYW1lID09PSAnTWF0aGVtYXRpY3MnKTtcbiAgICAgIGV4cGVjdChtYXRoU3ViamVjdCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChtYXRoU3ViamVjdD8udG90YWxIb3VycykudG9CZSgwLjc1KTsgLy8gMyBzbG90cyDDlyAwLjI1IGhvdXJzIGVhY2hcbiAgICAgIGV4cGVjdChtYXRoU3ViamVjdD8ua2V5VG9waWNzKS50b0NvbnRhaW4oJ0FkZGl0aW9uJyk7XG4gICAgICBleHBlY3QobWF0aFN1YmplY3Q/LmtleVRvcGljcykudG9Db250YWluKCdTdWJ0cmFjdGlvbicpO1xuICAgICAgZXhwZWN0KG1hdGhTdWJqZWN0Py5rZXlUb3BpY3MpLnRvQ29udGFpbignV29yZCBQcm9ibGVtcycpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgZW1wdHkgZGF5cyBncmFjZWZ1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gTW9jayBlbXB0eSBkYXlcbiAgICAgIG1vY2tCdWlsZFN1YlBsYW5EYXRhLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgZGF0ZTogJzIwMjQtMDEtMTUnLFxuICAgICAgICBzY2hlZHVsZTogW10sXG4gICAgICAgIHB1bGxPdXRzOiBbXSxcbiAgICAgICAgY29udGFjdHM6IHt9LFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGV4dHJhY3RXZWVrbHlQbGFuKCcyMDI0LTAxLTE1JywgMywgeyB1c2VySWQ6IDEgfSk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuc3RhcnREYXRlKS50b0JlKCcyMDI0LTAxLTE1Jyk7XG4gICAgICBleHBlY3QocmVzdWx0LmRheXMpLnRvSGF2ZUxlbmd0aCgzKTtcbiAgICAgIGV4cGVjdChyZXN1bHQud2Vla2x5T3ZlcnZpZXcuc3ViamVjdHMpLnRvSGF2ZUxlbmd0aCgwKTtcbiAgICAgIGV4cGVjdChyZXN1bHQud2Vla2x5T3ZlcnZpZXcubWlsZXN0b25lcykudG9IYXZlTGVuZ3RoKDApO1xuICAgICAgZXhwZWN0KHJlc3VsdC5jb250aW51aXR5Tm90ZXMpLnRvSGF2ZUxlbmd0aCgzKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuZW1lcmdlbmN5QmFja3VwUGxhbnMpLnRvSGF2ZUxlbmd0aCgwKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmVzcGVjdCB1c2VyIG9wdGlvbnMgZm9yIGRhdGEgaW5jbHVzaW9uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgbW9ja0RhaWx5UGxhbiA9IHtcbiAgICAgICAgaWQ6IDEsXG4gICAgICAgIGRhdGU6IG5ldyBEYXRlKCcyMDI0LTAxLTE1JyksXG4gICAgICAgIGl0ZW1zOiBbXSxcbiAgICAgIH07XG5cbiAgICAgIC8vIE1vY2sgZm9yIHVzZXIgb3B0aW9ucyB0ZXN0XG4gICAgICBtb2NrQnVpbGRTdWJQbGFuRGF0YS5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gICAgICAgIGRhdGU6ICcyMDI0LTAxLTE1JyxcbiAgICAgICAgc2NoZWR1bGU6IFt7IHRpbWU6ICcwOTowMCcsIGFjdGl2aXR5OiAnVGVzdCBBY3Rpdml0eScgfV0sXG4gICAgICAgIHB1bGxPdXRzOiBbXSxcbiAgICAgICAgY29udGFjdHM6IHt9LFxuICAgICAgICBnb2FsczogW3sgaWQ6IDEsIHRleHQ6ICdUZXN0IGdvYWwnLCBzdGF0dXM6ICdhY3RpdmUnIH1dLFxuICAgICAgICByb3V0aW5lczogW3sgaWQ6IDEsIHRpdGxlOiAnTW9ybmluZyByb3V0aW5lJywgZGVzY3JpcHRpb246ICdUZXN0JywgY2F0ZWdvcnk6ICdtb3JuaW5nJyB9XVxuICAgICAgfSk7XG5cbiAgICAgIC8vIFRlc3Qgd2l0aCBpbmNsdWRlR29hbHM6IGZhbHNlXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBleHRyYWN0V2Vla2x5UGxhbignMjAyNC0wMS0xNScsIDEsIHtcbiAgICAgICAgdXNlcklkOiAxLFxuICAgICAgICBpbmNsdWRlR29hbHM6IGZhbHNlLFxuICAgICAgICBpbmNsdWRlUm91dGluZXM6IGZhbHNlLFxuICAgICAgICBpbmNsdWRlUGxhbnM6IGZhbHNlLFxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuZGF5c1swXS5nb2FscykudG9CZVVuZGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5kYXlzWzBdLnJvdXRpbmVzKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=