7d3208d4bf4b73b805c5452aefcbbed9
/**
 * Express Application Factory
 * Creates and configures the Express application
 */
import express from 'express';
import cors from 'cors';
import { PrismaClient } from '@teaching-engine/database';
import { errorHandler } from '@/middleware/errorHandler';
import { rateLimiters } from '@/middleware/rateLimiter';
import { authRoutes } from '@/routes/auth';
import { userRoutes } from '@/routes/user';
export function createApp(prisma) {
    const app = express();
    // Middleware
    app.use(cors({
        origin: process.env.CLIENT_URL || 'http://localhost:5173',
        credentials: true,
    }));
    app.use(express.json());
    app.use(express.urlencoded({ extended: true }));
    // Rate limiting
    app.use('/api/auth', rateLimiters.auth);
    // Health check
    app.get('/health', (req, res) => {
        res.json({ status: 'ok', timestamp: new Date().toISOString() });
    });
    // Routes
    app.use('/api/auth', authRoutes(prisma));
    app.use('/api/user', userRoutes(prisma));
    // 404 handler
    app.use((req, res) => {
        res.status(404).json({ error: 'Route not found' });
    });
    // Error handler
    app.use(errorHandler);
    return app;
}
export async function createTestApp(prisma) {
    // Use provided prisma or create a mock
    const testPrisma = prisma || new PrismaClient();
    const app = createApp(testPrisma);
    // Add test-specific middleware
    if (process.env.NODE_ENV === 'test') {
        app.use((req, res, next) => {
            // Mock authentication for testing
            if (req.headers.authorization === 'Bearer valid.jwt.token') {
                req.user = { userId: '123' };
            }
            else if (req.headers.authorization === 'Bearer admin.token') {
                req.user = { userId: '456' };
            }
            next();
        });
    }
    return app;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9hcHAudHMiLCJtYXBwaW5ncyI6IkFBQUE7OztHQUdHO0FBRUgsT0FBTyxPQUFvQixNQUFNLFNBQVMsQ0FBQztBQUMzQyxPQUFPLElBQUksTUFBTSxNQUFNLENBQUM7QUFDeEIsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDeEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE1BQU0sVUFBVSxTQUFTLENBQUMsTUFBb0I7SUFDNUMsTUFBTSxHQUFHLEdBQUcsT0FBTyxFQUFFLENBQUM7SUFFdEIsYUFBYTtJQUNiLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQ1gsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJLHVCQUF1QjtRQUN6RCxXQUFXLEVBQUUsSUFBSTtLQUNsQixDQUFDLENBQUMsQ0FBQztJQUNKLEdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7SUFDeEIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztJQUVoRCxnQkFBZ0I7SUFDaEIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRXhDLGVBQWU7SUFDZixHQUFHLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRTtRQUM5QixHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDbEUsQ0FBQyxDQUFDLENBQUM7SUFFSCxTQUFTO0lBQ1QsR0FBRyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7SUFDekMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7SUFFekMsY0FBYztJQUNkLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUU7UUFDbkIsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsaUJBQWlCLEVBQUUsQ0FBQyxDQUFDO0lBQ3JELENBQUMsQ0FBQyxDQUFDO0lBRUgsZ0JBQWdCO0lBQ2hCLEdBQUcsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7SUFFdEIsT0FBTyxHQUFHLENBQUM7QUFDYixDQUFDO0FBRUQsTUFBTSxDQUFDLEtBQUssVUFBVSxhQUFhLENBQUMsTUFBcUI7SUFDdkQsdUNBQXVDO0lBQ3ZDLE1BQU0sVUFBVSxHQUFHLE1BQU0sSUFBSSxJQUFJLFlBQVksRUFBRSxDQUFDO0lBRWhELE1BQU0sR0FBRyxHQUFHLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUVsQywrQkFBK0I7SUFDL0IsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxNQUFNLEVBQUUsQ0FBQztRQUNwQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsRUFBRTtZQUN6QixrQ0FBa0M7WUFDbEMsSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLGFBQWEsS0FBSyx3QkFBd0IsRUFBRSxDQUFDO2dCQUMxRCxHQUF1RCxDQUFDLElBQUksR0FBRyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQztZQUNwRixDQUFDO2lCQUFNLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxhQUFhLEtBQUssb0JBQW9CLEVBQUUsQ0FBQztnQkFDN0QsR0FBdUQsQ0FBQyxJQUFJLEdBQUcsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLENBQUM7WUFDcEYsQ0FBQztZQUNELElBQUksRUFBRSxDQUFDO1FBQ1QsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsT0FBTyxHQUFHLENBQUM7QUFDYixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9taWNoYWVsbWNpc2FhYy9HaXRIdWIvdGVhY2hpbmctZW5naW5lMi4wL3NlcnZlci9zcmMvYXBwLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogRXhwcmVzcyBBcHBsaWNhdGlvbiBGYWN0b3J5XG4gKiBDcmVhdGVzIGFuZCBjb25maWd1cmVzIHRoZSBFeHByZXNzIGFwcGxpY2F0aW9uXG4gKi9cblxuaW1wb3J0IGV4cHJlc3MsIHsgRXhwcmVzcyB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IGNvcnMgZnJvbSAnY29ycyc7XG5pbXBvcnQgeyBQcmlzbWFDbGllbnQgfSBmcm9tICdAdGVhY2hpbmctZW5naW5lL2RhdGFiYXNlJztcbmltcG9ydCB7IGVycm9ySGFuZGxlciB9IGZyb20gJ0AvbWlkZGxld2FyZS9lcnJvckhhbmRsZXInO1xuaW1wb3J0IHsgcmF0ZUxpbWl0ZXJzIH0gZnJvbSAnQC9taWRkbGV3YXJlL3JhdGVMaW1pdGVyJztcbmltcG9ydCB7IGF1dGhSb3V0ZXMgfSBmcm9tICdAL3JvdXRlcy9hdXRoJztcbmltcG9ydCB7IHVzZXJSb3V0ZXMgfSBmcm9tICdAL3JvdXRlcy91c2VyJztcblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUFwcChwcmlzbWE6IFByaXNtYUNsaWVudCk6IEV4cHJlc3Mge1xuICBjb25zdCBhcHAgPSBleHByZXNzKCk7XG5cbiAgLy8gTWlkZGxld2FyZVxuICBhcHAudXNlKGNvcnMoe1xuICAgIG9yaWdpbjogcHJvY2Vzcy5lbnYuQ0xJRU5UX1VSTCB8fCAnaHR0cDovL2xvY2FsaG9zdDo1MTczJyxcbiAgICBjcmVkZW50aWFsczogdHJ1ZSxcbiAgfSkpO1xuICBhcHAudXNlKGV4cHJlc3MuanNvbigpKTtcbiAgYXBwLnVzZShleHByZXNzLnVybGVuY29kZWQoeyBleHRlbmRlZDogdHJ1ZSB9KSk7XG5cbiAgLy8gUmF0ZSBsaW1pdGluZ1xuICBhcHAudXNlKCcvYXBpL2F1dGgnLCByYXRlTGltaXRlcnMuYXV0aCk7XG5cbiAgLy8gSGVhbHRoIGNoZWNrXG4gIGFwcC5nZXQoJy9oZWFsdGgnLCAocmVxLCByZXMpID0+IHtcbiAgICByZXMuanNvbih7IHN0YXR1czogJ29rJywgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkgfSk7XG4gIH0pO1xuXG4gIC8vIFJvdXRlc1xuICBhcHAudXNlKCcvYXBpL2F1dGgnLCBhdXRoUm91dGVzKHByaXNtYSkpO1xuICBhcHAudXNlKCcvYXBpL3VzZXInLCB1c2VyUm91dGVzKHByaXNtYSkpO1xuXG4gIC8vIDQwNCBoYW5kbGVyXG4gIGFwcC51c2UoKHJlcSwgcmVzKSA9PiB7XG4gICAgcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBlcnJvcjogJ1JvdXRlIG5vdCBmb3VuZCcgfSk7XG4gIH0pO1xuXG4gIC8vIEVycm9yIGhhbmRsZXJcbiAgYXBwLnVzZShlcnJvckhhbmRsZXIpO1xuXG4gIHJldHVybiBhcHA7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVUZXN0QXBwKHByaXNtYT86IFByaXNtYUNsaWVudCk6IFByb21pc2U8RXhwcmVzcz4ge1xuICAvLyBVc2UgcHJvdmlkZWQgcHJpc21hIG9yIGNyZWF0ZSBhIG1vY2tcbiAgY29uc3QgdGVzdFByaXNtYSA9IHByaXNtYSB8fCBuZXcgUHJpc21hQ2xpZW50KCk7XG4gIFxuICBjb25zdCBhcHAgPSBjcmVhdGVBcHAodGVzdFByaXNtYSk7XG4gIFxuICAvLyBBZGQgdGVzdC1zcGVjaWZpYyBtaWRkbGV3YXJlXG4gIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Rlc3QnKSB7XG4gICAgYXBwLnVzZSgocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIC8vIE1vY2sgYXV0aGVudGljYXRpb24gZm9yIHRlc3RpbmdcbiAgICAgIGlmIChyZXEuaGVhZGVycy5hdXRob3JpemF0aW9uID09PSAnQmVhcmVyIHZhbGlkLmp3dC50b2tlbicpIHtcbiAgICAgICAgKHJlcSBhcyBleHByZXNzLlJlcXVlc3QgJiB7IHVzZXI/OiB7IHVzZXJJZDogc3RyaW5nIH0gfSkudXNlciA9IHsgdXNlcklkOiAnMTIzJyB9O1xuICAgICAgfSBlbHNlIGlmIChyZXEuaGVhZGVycy5hdXRob3JpemF0aW9uID09PSAnQmVhcmVyIGFkbWluLnRva2VuJykge1xuICAgICAgICAocmVxIGFzIGV4cHJlc3MuUmVxdWVzdCAmIHsgdXNlcj86IHsgdXNlcklkOiBzdHJpbmcgfSB9KS51c2VyID0geyB1c2VySWQ6ICc0NTYnIH07XG4gICAgICB9XG4gICAgICBuZXh0KCk7XG4gICAgfSk7XG4gIH1cbiAgXG4gIHJldHVybiBhcHA7XG59Il0sInZlcnNpb24iOjN9