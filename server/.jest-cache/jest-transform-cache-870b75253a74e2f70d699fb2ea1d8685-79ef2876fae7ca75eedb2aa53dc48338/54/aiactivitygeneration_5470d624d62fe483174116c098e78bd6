e89040cfda81cbf49acde99454da3621
import { Router } from 'express';
import { z } from 'zod';
import { authMiddleware } from '../middleware/auth';
import { AIActivityGeneratorService } from '../services/aiActivityGeneratorService';
import { ActivityDiscoveryService } from '../services/activityDiscoveryService';
const router = Router();
const aiGenerator = new AIActivityGeneratorService();
const activityService = new ActivityDiscoveryService();
// Schema for activity generation request
const generateActivitySchema = z.object({
    searchQuery: z.string().optional(),
    lessonContext: z
        .object({
        title: z.string(),
        grade: z.number().min(1).max(8),
        subject: z.string(),
        learningGoals: z.array(z.string()),
        duration: z.number().min(5).max(180),
        section: z.enum(['mindsOn', 'action', 'consolidation']).optional(),
    })
        .optional(),
    specificRequirements: z
        .object({
        activityType: z.string().optional(),
        materials: z.array(z.string()).optional(),
        groupSize: z.string().optional(),
        language: z.string().optional(),
        curriculumExpectations: z.array(z.string()).optional(),
    })
        .optional(),
    useSearchResults: z.boolean().default(true),
});
// Schema for activity enhancement request
const enhanceActivitySchema = z.object({
    activityId: z.string(),
    enhancements: z.object({
        addDifferentiation: z.boolean().optional(),
        addAssessment: z.boolean().optional(),
        adaptForGrade: z.number().min(1).max(8).optional(),
        translateTo: z.string().optional(),
        alignToCurriculum: z.array(z.string()).optional(),
    }),
});
// Schema for saving generated activity
const saveActivitySchema = z.object({
    activity: z.object({
        title: z.string(),
        description: z.string(),
        detailedInstructions: z.array(z.string()),
        duration: z.number(),
        activityType: z.string(),
        materials: z.array(z.string()),
        groupSize: z.string(),
        learningGoals: z.array(z.string()),
        assessmentSuggestions: z.array(z.string()),
        differentiation: z.object({
            support: z.array(z.string()),
            extension: z.array(z.string()),
        }),
        safetyConsiderations: z.array(z.string()).optional(),
        technologyRequirements: z.array(z.string()).optional(),
    }),
    metadata: z
        .object({
        lessonPlanId: z.string().optional(),
        basedOnActivities: z.array(z.string()).optional(),
    })
        .optional(),
});
/**
 * Generate an AI-powered activity
 */
router.post('/generate', authMiddleware, async (req, res) => {
    try {
        const params = generateActivitySchema.parse(req.body);
        let searchResults = undefined;
        // If requested, perform a search first to get inspiration
        if (params.useSearchResults && (params.searchQuery || params.lessonContext)) {
            const searchParams = {
                query: params.searchQuery || params.lessonContext?.title || '',
                gradeLevel: params.lessonContext?.grade,
                subject: params.lessonContext?.subject,
                language: params.specificRequirements?.language || 'fr',
                limit: 5,
            };
            const results = await activityService.search(searchParams, Number(req.user.id));
            searchResults = results;
        }
        // Generate the activity
        const generatedActivity = await aiGenerator.generateActivity({
            searchResults,
            lessonContext: params.lessonContext,
            specificRequirements: params.specificRequirements,
        });
        res.json({
            success: true,
            data: generatedActivity,
        });
    }
    catch (error) {
        console.error('Error generating activity:', error);
        res.status(500).json({
            success: false,
            error: 'Failed to generate activity',
        });
    }
});
/**
 * Generate multiple activity variations
 */
router.post('/generate-variations', authMiddleware, async (req, res) => {
    try {
        const params = generateActivitySchema.parse(req.body);
        const count = Math.min(req.body.count || 3, 5); // Max 5 variations
        let searchResults = undefined;
        // If requested, perform a search first
        if (params.useSearchResults && (params.searchQuery || params.lessonContext)) {
            const searchParams = {
                query: params.searchQuery || params.lessonContext?.title || '',
                gradeLevel: params.lessonContext?.grade,
                subject: params.lessonContext?.subject,
                language: params.specificRequirements?.language || 'fr',
                limit: 10,
            };
            const results = await activityService.search(searchParams, Number(req.user.id));
            searchResults = results;
        }
        // Generate variations
        const variations = await aiGenerator.generateActivityVariations({
            searchResults,
            lessonContext: params.lessonContext,
            specificRequirements: params.specificRequirements,
        }, count);
        res.json({
            success: true,
            data: {
                variations,
                count: variations.length,
            },
        });
    }
    catch (error) {
        console.error('Error generating activity variations:', error);
        res.status(500).json({
            success: false,
            error: 'Failed to generate activity variations',
        });
    }
});
/**
 * Enhance an existing activity
 */
router.post('/enhance', authMiddleware, async (req, res) => {
    try {
        const params = enhanceActivitySchema.parse(req.body);
        // Get the activity details
        const activityDetails = await activityService.getActivityDetails(params.activityId);
        if (!activityDetails) {
            return res.status(404).json({
                success: false,
                error: 'Activity not found',
            });
        }
        // Enhance the activity
        const enhancements = await aiGenerator.enhanceActivity(activityDetails, params.enhancements);
        res.json({
            success: true,
            data: enhancements,
        });
    }
    catch (error) {
        console.error('Error enhancing activity:', error);
        res.status(500).json({
            success: false,
            error: 'Failed to enhance activity',
        });
    }
});
/**
 * Save a generated activity
 */
router.post('/save', authMiddleware, async (req, res) => {
    try {
        const params = saveActivitySchema.parse(req.body);
        // Convert the activity object with proper defaults for required fields
        const activityWithDefaults = {
            title: params.activity.title,
            description: params.activity.description,
            detailedInstructions: params.activity.detailedInstructions,
            duration: params.activity.duration,
            activityType: params.activity.activityType,
            materials: params.activity.materials,
            groupSize: params.activity.groupSize,
            learningGoals: params.activity.learningGoals,
            assessmentSuggestions: params.activity.assessmentSuggestions,
            differentiation: {
                support: params.activity.differentiation.support,
                extension: params.activity.differentiation.extension,
            },
            safetyConsiderations: params.activity.safetyConsiderations,
            technologyRequirements: params.activity.technologyRequirements,
        };
        // Save the generated activity
        const savedActivity = await aiGenerator.saveGeneratedActivity(activityWithDefaults, Number(req.user.id), params.metadata);
        res.json({
            success: true,
            data: savedActivity,
        });
    }
    catch (error) {
        console.error('Error saving generated activity:', error);
        res.status(500).json({
            success: false,
            error: 'Failed to save generated activity',
        });
    }
});
export default router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9yb3V0ZXMvYWktYWN0aXZpdHktZ2VuZXJhdGlvbi50cyIsIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFxQixNQUFNLFNBQVMsQ0FBQztBQUNwRCxPQUFPLEVBQUUsQ0FBQyxFQUFFLE1BQU0sS0FBSyxDQUFDO0FBQ3hCLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRCxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUNwRixPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUVoRixNQUFNLE1BQU0sR0FBRyxNQUFNLEVBQUUsQ0FBQztBQUN4QixNQUFNLFdBQVcsR0FBRyxJQUFJLDBCQUEwQixFQUFFLENBQUM7QUFDckQsTUFBTSxlQUFlLEdBQUcsSUFBSSx3QkFBd0IsRUFBRSxDQUFDO0FBRXZELHlDQUF5QztBQUN6QyxNQUFNLHNCQUFzQixHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDdEMsV0FBVyxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLEVBQUU7SUFDbEMsYUFBYSxFQUFFLENBQUM7U0FDYixNQUFNLENBQUM7UUFDTixLQUFLLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRTtRQUNqQixLQUFLLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQy9CLE9BQU8sRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFO1FBQ25CLGFBQWEsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUNsQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDO1FB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cUIsQ0FDM0Qsb0JBQW9CLEVBQ3BCLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSyxDQUFDLEVBQUUsQ0FBQyxFQUNwQixNQUFNLENBQUMsUUFBUSxDQUNoQixDQUFDO1FBRUYsR0FBRyxDQUFDLElBQUksQ0FBQztZQUNQLE9BQU8sRUFBRSxJQUFJO1lBQ2IsSUFBSSxFQUFFLGFBQWE7U0FDcEIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLGtDQUFrQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3pELEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQ25CLE9BQU8sRUFBRSxLQUFLO1lBQ2QsS0FBSyxFQUFFLG1DQUFtQztTQUMzQyxDQUFDLENBQUM7SUFDTCxDQUFDO0FBQ0gsQ0FBQyxDQUFDLENBQUM7QUFFSCxlQUFlLE1BQU0sQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWljaGFlbG1jaXNhYWMvR2l0SHViL3RlYWNoaW5nLWVuZ2luZTIuMC9zZXJ2ZXIvc3JjL3JvdXRlcy9haS1hY3Rpdml0eS1nZW5lcmF0aW9uLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJvdXRlciwgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IHogfSBmcm9tICd6b2QnO1xuaW1wb3J0IHsgYXV0aE1pZGRsZXdhcmUgfSBmcm9tICcuLi9taWRkbGV3YXJlL2F1dGgnO1xuaW1wb3J0IHsgQUlBY3Rpdml0eUdlbmVyYXRvclNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9haUFjdGl2aXR5R2VuZXJhdG9yU2VydmljZSc7XG5pbXBvcnQgeyBBY3Rpdml0eURpc2NvdmVyeVNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9hY3Rpdml0eURpc2NvdmVyeVNlcnZpY2UnO1xuXG5jb25zdCByb3V0ZXIgPSBSb3V0ZXIoKTtcbmNvbnN0IGFpR2VuZXJhdG9yID0gbmV3IEFJQWN0aXZpdHlHZW5lcmF0b3JTZXJ2aWNlKCk7XG5jb25zdCBhY3Rpdml0eVNlcnZpY2UgPSBuZXcgQWN0aXZpdHlEaXNjb3ZlcnlTZXJ2aWNlKCk7XG5cbi8vIFNjaGVtYSBmb3IgYWN0aXZpdHkgZ2VuZXJhdGlvbiByZXF1ZXN0XG5jb25zdCBnZW5lcmF0ZUFjdGl2aXR5U2NoZW1hID0gei5vYmplY3Qoe1xuICBzZWFyY2hRdWVyeTogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuICBsZXNzb25Db250ZXh0OiB6XG4gICAgLm9iamVjdCh7XG4gICAgICB0aXRsZTogei5zdHJpbmcoKSxcbiAgICAgIGdyYWRlOiB6Lm51bWJlcigpLm1pbigxKS5tYXgoOCksXG4gICAgICBzdWJqZWN0OiB6LnN0cmluZygpLFxuICAgICAgbGVhcm5pbmdHb2Fsczogei5hcnJheSh6LnN0cmluZygpKSxcbiAgICAgIGR1cmF0aW9uOiB6Lm51bWJlcigpLm1pbig1KS5tYXgoMTgwKSxcbiAgICAgIHNlY3Rpb246IHouZW51bShbJ21pbmRzT24nLCAnYWN0aW9uJywgJ2NvbnNvbGlkYXRpb24nXSkub3B0aW9uYWwoKSxcbiAgICB9KVxuICAgIC5vcHRpb25hbCgpLFxuICBzcGVjaWZpY1JlcXVpcmVtZW50czogelxuICAgIC5vYmplY3Qoe1xuICAgICAgYWN0aXZpdHlUeXBlOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gICAgICBtYXRlcmlhbHM6IHouYXJyYXkoei5zdHJpbmcoKSkub3B0aW9uYWwoKSxcbiAgICAgIGdyb3VwU2l6ZTogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuICAgICAgbGFuZ3VhZ2U6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgICAgIGN1cnJpY3VsdW1FeHBlY3RhdGlvbnM6IHouYXJyYXkoei5zdHJpbmcoKSkub3B0aW9uYWwoKSxcbiAgICB9KVxuICAgIC5vcHRpb25hbCgpLFxuICB1c2VTZWFyY2hSZXN1bHRzOiB6LmJvb2xlYW4oKS5kZWZhdWx0KHRydWUpLFxufSk7XG5cbi8vIFNjaGVtYSBmb3IgYWN0aXZpdHkgZW5oYW5jZW1lbnQgcmVxdWVzdFxuY29uc3QgZW5oYW5jZUFjdGl2aXR5U2NoZW1hID0gei5vYmplY3Qoe1xuICBhY3Rpdml0eUlkOiB6LnN0cmluZygpLFxuICBlbmhhbmNlbWVudHM6IHoub2JqZWN0KHtcbiAgICBhZGREaWZmZXJlbnRpYXRpb246IHouYm9vbGVhbigpLm9wdGlvbmFsKCksXG4gICAgYWRkQXNzZXNzbWVudDogei5ib29sZWFuKCkub3B0aW9uYWwoKSxcbiAgICBhZGFwdEZvckdyYWRlOiB6Lm51bWJlcigpLm1pbigxKS5tYXgoOCkub3B0aW9uYWwoKSxcbiAgICB0cmFuc2xhdGVUbzogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuICAgIGFsaWduVG9DdXJyaWN1bHVtOiB6LmFycmF5KHouc3RyaW5nKCkpLm9wdGlvbmFsKCksXG4gIH0pLFxufSk7XG5cbi8vIFNjaGVtYSBmb3Igc2F2aW5nIGdlbmVyYXRlZCBhY3Rpdml0eVxuY29uc3Qgc2F2ZUFjdGl2aXR5U2NoZW1hID0gei5vYmplY3Qoe1xuICBhY3Rpdml0eTogei5vYmplY3Qoe1xuICAgIHRpdGxlOiB6LnN0cmluZygpLFxuICAgIGRlc2NyaXB0aW9uOiB6LnN0cmluZygpLFxuICAgIGRldGFpbGVkSW5zdHJ1Y3Rpb25zOiB6LmFycmF5KHouc3RyaW5nKCkpLFxuICAgIGR1cmF0aW9uOiB6Lm51bWJlcigpLFxuICAgIGFjdGl2aXR5VHlwZTogei5zdHJpbmcoKSxcbiAgICBtYXRlcmlhbHM6IHouYXJyYXkoei5zdHJpbmcoKSksXG4gICAgZ3JvdXBTaXplOiB6LnN0cmluZygpLFxuICAgIGxlYXJuaW5nR29hbHM6IHouYXJyYXkoei5zdHJpbmcoKSksXG4gICAgYXNzZXNzbWVudFN1Z2dlc3Rpb25zOiB6LmFycmF5KHouc3RyaW5nKCkpLFxuICAgIGRpZmZlcmVudGlhdGlvbjogei5vYmplY3Qoe1xuICAgICAgc3VwcG9ydDogei5hcnJheSh6LnN0cmluZygpKSxcbiAgICAgIGV4dGVuc2lvbjogei5hcnJheSh6LnN0cmluZygpKSxcbiAgICB9KSxcbiAgICBzYWZldHlDb25zaWRlcmF0aW9uczogei5hcnJheSh6LnN0cmluZygpKS5vcHRpb25hbCgpLFxuICAgIHRlY2hub2xvZ3lSZXF1aXJlbWVudHM6IHouYXJyYXkoei5zdHJpbmcoKSkub3B0aW9uYWwoKSxcbiAgfSksXG4gIG1ldGFkYXRhOiB6XG4gICAgLm9iamVjdCh7XG4gICAgICBsZXNzb25QbGFuSWQ6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgICAgIGJhc2VkT25BY3Rpdml0aWVzOiB6LmFycmF5KHouc3RyaW5nKCkpLm9wdGlvbmFsKCksXG4gICAgfSlcbiAgICAub3B0aW9uYWwoKSxcbn0pO1xuXG4vKipcbiAqIEdlbmVyYXRlIGFuIEFJLXBvd2VyZWQgYWN0aXZpdHlcbiAqL1xucm91dGVyLnBvc3QoJy9nZW5lcmF0ZScsIGF1dGhNaWRkbGV3YXJlLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgcGFyYW1zID0gZ2VuZXJhdGVBY3Rpdml0eVNjaGVtYS5wYXJzZShyZXEuYm9keSk7XG4gICAgbGV0IHNlYXJjaFJlc3VsdHMgPSB1bmRlZmluZWQ7XG5cbiAgICAvLyBJZiByZXF1ZXN0ZWQsIHBlcmZvcm0gYSBzZWFyY2ggZmlyc3QgdG8gZ2V0IGluc3BpcmF0aW9uXG4gICAgaWYgKHBhcmFtcy51c2VTZWFyY2hSZXN1bHRzICYmIChwYXJhbXMuc2VhcmNoUXVlcnkgfHwgcGFyYW1zLmxlc3NvbkNvbnRleHQpKSB7XG4gICAgICBjb25zdCBzZWFyY2hQYXJhbXMgPSB7XG4gICAgICAgIHF1ZXJ5OiBwYXJhbXMuc2VhcmNoUXVlcnkgfHwgcGFyYW1zLmxlc3NvbkNvbnRleHQ/LnRpdGxlIHx8ICcnLFxuICAgICAgICBncmFkZUxldmVsOiBwYXJhbXMubGVzc29uQ29udGV4dD8uZ3JhZGUsXG4gICAgICAgIHN1YmplY3Q6IHBhcmFtcy5sZXNzb25Db250ZXh0Py5zdWJqZWN0LFxuICAgICAgICBsYW5ndWFnZTogcGFyYW1zLnNwZWNpZmljUmVxdWlyZW1lbnRzPy5sYW5ndWFnZSB8fCAnZnInLFxuICAgICAgICBsaW1pdDogNSxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBhY3Rpdml0eVNlcnZpY2Uuc2VhcmNoKHNlYXJjaFBhcmFtcywgTnVtYmVyKHJlcS51c2VyIS5pZCkpO1xuICAgICAgc2VhcmNoUmVzdWx0cyA9IHJlc3VsdHM7XG4gICAgfVxuXG4gICAgLy8gR2VuZXJhdGUgdGhlIGFjdGl2aXR5XG4gICAgY29uc3QgZ2VuZXJhdGVkQWN0aXZpdHkgPSBhd2FpdCBhaUdlbmVyYXRvci5nZW5lcmF0ZUFjdGl2aXR5KHtcbiAgICAgIHNlYXJjaFJlc3VsdHMsXG4gICAgICBsZXNzb25Db250ZXh0OiBwYXJhbXMubGVzc29uQ29udGV4dCxcbiAgICAgIHNwZWNpZmljUmVxdWlyZW1lbnRzOiBwYXJhbXMuc3BlY2lmaWNSZXF1aXJlbWVudHMsXG4gICAgfSk7XG5cbiAgICByZXMuanNvbih7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgZGF0YTogZ2VuZXJhdGVkQWN0aXZpdHksXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgZ2VuZXJhdGluZyBhY3Rpdml0eTonLCBlcnJvcik7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBlcnJvcjogJ0ZhaWxlZCB0byBnZW5lcmF0ZSBhY3Rpdml0eScsXG4gICAgfSk7XG4gIH1cbn0pO1xuXG4vKipcbiAqIEdlbmVyYXRlIG11bHRpcGxlIGFjdGl2aXR5IHZhcmlhdGlvbnNcbiAqL1xucm91dGVyLnBvc3QoJy9nZW5lcmF0ZS12YXJpYXRpb25zJywgYXV0aE1pZGRsZXdhcmUsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBwYXJhbXMgPSBnZW5lcmF0ZUFjdGl2aXR5U2NoZW1hLnBhcnNlKHJlcS5ib2R5KTtcbiAgICBjb25zdCBjb3VudCA9IE1hdGgubWluKHJlcS5ib2R5LmNvdW50IHx8IDMsIDUpOyAvLyBNYXggNSB2YXJpYXRpb25zXG5cbiAgICBsZXQgc2VhcmNoUmVzdWx0cyA9IHVuZGVmaW5lZDtcblxuICAgIC8vIElmIHJlcXVlc3RlZCwgcGVyZm9ybSBhIHNlYXJjaCBmaXJzdFxuICAgIGlmIChwYXJhbXMudXNlU2VhcmNoUmVzdWx0cyAmJiAocGFyYW1zLnNlYXJjaFF1ZXJ5IHx8IHBhcmFtcy5sZXNzb25Db250ZXh0KSkge1xuICAgICAgY29uc3Qgc2VhcmNoUGFyYW1zID0ge1xuICAgICAgICBxdWVyeTogcGFyYW1zLnNlYXJjaFF1ZXJ5IHx8IHBhcmFtcy5sZXNzb25Db250ZXh0Py50aXRsZSB8fCAnJyxcbiAgICAgICAgZ3JhZGVMZXZlbDogcGFyYW1zLmxlc3NvbkNvbnRleHQ/LmdyYWRlLFxuICAgICAgICBzdWJqZWN0OiBwYXJhbXMubGVzc29uQ29udGV4dD8uc3ViamVjdCxcbiAgICAgICAgbGFuZ3VhZ2U6IHBhcmFtcy5zcGVjaWZpY1JlcXVpcmVtZW50cz8ubGFuZ3VhZ2UgfHwgJ2ZyJyxcbiAgICAgICAgbGltaXQ6IDEwLFxuICAgICAgfTtcblxuICAgICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IGFjdGl2aXR5U2VydmljZS5zZWFyY2goc2VhcmNoUGFyYW1zLCBOdW1iZXIocmVxLnVzZXIhLmlkKSk7XG4gICAgICBzZWFyY2hSZXN1bHRzID0gcmVzdWx0cztcbiAgICB9XG5cbiAgICAvLyBHZW5lcmF0ZSB2YXJpYXRpb25zXG4gICAgY29uc3QgdmFyaWF0aW9ucyA9IGF3YWl0IGFpR2VuZXJhdG9yLmdlbmVyYXRlQWN0aXZpdHlWYXJpYXRpb25zKFxuICAgICAge1xuICAgICAgICBzZWFyY2hSZXN1bHRzLFxuICAgICAgICBsZXNzb25Db250ZXh0OiBwYXJhbXMubGVzc29uQ29udGV4dCxcbiAgICAgICAgc3BlY2lmaWNSZXF1aXJlbWVudHM6IHBhcmFtcy5zcGVjaWZpY1JlcXVpcmVtZW50cyxcbiAgICAgIH0sXG4gICAgICBjb3VudCxcbiAgICApO1xuXG4gICAgcmVzLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgdmFyaWF0aW9ucyxcbiAgICAgICAgY291bnQ6IHZhcmlhdGlvbnMubGVuZ3RoLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBnZW5lcmF0aW5nIGFjdGl2aXR5IHZhcmlhdGlvbnM6JywgZXJyb3IpO1xuICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6ICdGYWlsZWQgdG8gZ2VuZXJhdGUgYWN0aXZpdHkgdmFyaWF0aW9ucycsXG4gICAgfSk7XG4gIH1cbn0pO1xuXG4vKipcbiAqIEVuaGFuY2UgYW4gZXhpc3RpbmcgYWN0aXZpdHlcbiAqL1xucm91dGVyLnBvc3QoJy9lbmhhbmNlJywgYXV0aE1pZGRsZXdhcmUsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBwYXJhbXMgPSBlbmhhbmNlQWN0aXZpdHlTY2hlbWEucGFyc2UocmVxLmJvZHkpO1xuXG4gICAgLy8gR2V0IHRoZSBhY3Rpdml0eSBkZXRhaWxzXG4gICAgY29uc3QgYWN0aXZpdHlEZXRhaWxzID0gYXdhaXQgYWN0aXZpdHlTZXJ2aWNlLmdldEFjdGl2aXR5RGV0YWlscyhwYXJhbXMuYWN0aXZpdHlJZCk7XG5cbiAgICBpZiAoIWFjdGl2aXR5RGV0YWlscykge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiAnQWN0aXZpdHkgbm90IGZvdW5kJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIEVuaGFuY2UgdGhlIGFjdGl2aXR5XG4gICAgY29uc3QgZW5oYW5jZW1lbnRzID0gYXdhaXQgYWlHZW5lcmF0b3IuZW5oYW5jZUFjdGl2aXR5KGFjdGl2aXR5RGV0YWlscywgcGFyYW1zLmVuaGFuY2VtZW50cyk7XG5cbiAgICByZXMuanNvbih7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgZGF0YTogZW5oYW5jZW1lbnRzLFxuICAgIH0pO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGVuaGFuY2luZyBhY3Rpdml0eTonLCBlcnJvcik7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBlcnJvcjogJ0ZhaWxlZCB0byBlbmhhbmNlIGFjdGl2aXR5JyxcbiAgICB9KTtcbiAgfVxufSk7XG5cbi8qKlxuICogU2F2ZSBhIGdlbmVyYXRlZCBhY3Rpdml0eVxuICovXG5yb3V0ZXIucG9zdCgnL3NhdmUnLCBhdXRoTWlkZGxld2FyZSwgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHBhcmFtcyA9IHNhdmVBY3Rpdml0eVNjaGVtYS5wYXJzZShyZXEuYm9keSk7XG5cbiAgICAvLyBDb252ZXJ0IHRoZSBhY3Rpdml0eSBvYmplY3Qgd2l0aCBwcm9wZXIgZGVmYXVsdHMgZm9yIHJlcXVpcmVkIGZpZWxkc1xuICAgIGNvbnN0IGFjdGl2aXR5V2l0aERlZmF1bHRzID0ge1xuICAgICAgdGl0bGU6IHBhcmFtcy5hY3Rpdml0eS50aXRsZSxcbiAgICAgIGRlc2NyaXB0aW9uOiBwYXJhbXMuYWN0aXZpdHkuZGVzY3JpcHRpb24sXG4gICAgICBkZXRhaWxlZEluc3RydWN0aW9uczogcGFyYW1zLmFjdGl2aXR5LmRldGFpbGVkSW5zdHJ1Y3Rpb25zLFxuICAgICAgZHVyYXRpb246IHBhcmFtcy5hY3Rpdml0eS5kdXJhdGlvbixcbiAgICAgIGFjdGl2aXR5VHlwZTogcGFyYW1zLmFjdGl2aXR5LmFjdGl2aXR5VHlwZSxcbiAgICAgIG1hdGVyaWFsczogcGFyYW1zLmFjdGl2aXR5Lm1hdGVyaWFscyxcbiAgICAgIGdyb3VwU2l6ZTogcGFyYW1zLmFjdGl2aXR5Lmdyb3VwU2l6ZSxcbiAgICAgIGxlYXJuaW5nR29hbHM6IHBhcmFtcy5hY3Rpdml0eS5sZWFybmluZ0dvYWxzLFxuICAgICAgYXNzZXNzbWVudFN1Z2dlc3Rpb25zOiBwYXJhbXMuYWN0aXZpdHkuYXNzZXNzbWVudFN1Z2dlc3Rpb25zLFxuICAgICAgZGlmZmVyZW50aWF0aW9uOiB7XG4gICAgICAgIHN1cHBvcnQ6IHBhcmFtcy5hY3Rpdml0eS5kaWZmZXJlbnRpYXRpb24uc3VwcG9ydCxcbiAgICAgICAgZXh0ZW5zaW9uOiBwYXJhbXMuYWN0aXZpdHkuZGlmZmVyZW50aWF0aW9uLmV4dGVuc2lvbixcbiAgICAgIH0sXG4gICAgICBzYWZldHlDb25zaWRlcmF0aW9uczogcGFyYW1zLmFjdGl2aXR5LnNhZmV0eUNvbnNpZGVyYXRpb25zLFxuICAgICAgdGVjaG5vbG9neVJlcXVpcmVtZW50czogcGFyYW1zLmFjdGl2aXR5LnRlY2hub2xvZ3lSZXF1aXJlbWVudHMsXG4gICAgfTtcblxuICAgIC8vIFNhdmUgdGhlIGdlbmVyYXRlZCBhY3Rpdml0eVxuICAgIGNvbnN0IHNhdmVkQWN0aXZpdHkgPSBhd2FpdCBhaUdlbmVyYXRvci5zYXZlR2VuZXJhdGVkQWN0aXZpdHkoXG4gICAgICBhY3Rpdml0eVdpdGhEZWZhdWx0cyxcbiAgICAgIE51bWJlcihyZXEudXNlciEuaWQpLFxuICAgICAgcGFyYW1zLm1ldGFkYXRhLFxuICAgICk7XG5cbiAgICByZXMuanNvbih7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgZGF0YTogc2F2ZWRBY3Rpdml0eSxcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBzYXZpbmcgZ2VuZXJhdGVkIGFjdGl2aXR5OicsIGVycm9yKTtcbiAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIGVycm9yOiAnRmFpbGVkIHRvIHNhdmUgZ2VuZXJhdGVkIGFjdGl2aXR5JyxcbiAgICB9KTtcbiAgfVxufSk7XG5cbmV4cG9ydCBkZWZhdWx0IHJvdXRlcjtcbiJdLCJ2ZXJzaW9uIjozfQ==