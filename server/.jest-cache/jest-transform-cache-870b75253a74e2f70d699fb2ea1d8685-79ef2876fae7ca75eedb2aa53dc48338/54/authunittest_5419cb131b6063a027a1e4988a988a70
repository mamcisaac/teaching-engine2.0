3f07c7d4de936d273cfe727d111ae825
import { describe, it, expect, beforeEach, jest } from '@jest/globals';
import jwt from 'jsonwebtoken';
import { createRequire } from 'module';
import { authMiddleware } from '../../src/middleware/auth';
const require = createRequire(import.meta.url);
describe('Auth Middleware Unit Tests', () => {
    let req;
    let res;
    let next;
    beforeEach(() => {
        req = {
            headers: {},
        };
        res = {
            status: jest.fn().mockReturnThis(),
            json: jest.fn().mockReturnThis(),
        };
        next = jest.fn();
        // Clear any previous mocks
        jest.clearAllMocks();
    });
    describe('authMiddleware', () => {
        it('should return 401 when no authorization header is provided', () => {
            authMiddleware(req, res, next);
            expect(res.status).toHaveBeenCalledWith(401);
            expect(res.json).toHaveBeenCalledWith({ error: 'Unauthorized' });
            expect(next).not.toHaveBeenCalled();
        });
        it('should return 401 when authorization header is empty', () => {
            req.headers.authorization = '';
            authMiddleware(req, res, next);
            expect(res.status).toHaveBeenCalledWith(401);
            expect(res.json).toHaveBeenCalledWith({ error: 'Unauthorized' });
            expect(next).not.toHaveBeenCalled();
        });
        it('should extract token from Bearer authorization header', () => {
            const secret = process.env.JWT_SECRET || require('crypto').randomBytes(32).toString('hex');
            const userId = '123';
            const token = jwt.sign({ userId }, secret);
            req.headers.authorization = `Bearer ${token}`;
            // Mock environment variable
            const originalEnv = process.env.JWT_SECRET;
            process.env.JWT_SECRET = secret;
            authMiddleware(req, res, next);
            expect(req.user?.userId).toBe('123');
            expect(next).toHaveBeenCalled();
            expect(res.status).not.toHaveBeenCalled();
            // Restore environment
            process.env.JWT_SECRET = originalEnv;
        });
        it('should return 500 when JWT_SECRET is not set', () => {
            const userId = '456';
            const token = jwt.sign({ userId }, 'secret'); // Any secret
            req.headers.authorization = `Bearer ${token}`;
            // Ensure JWT_SECRET is not set
            const originalEnv = process.env.JWT_SECRET;
            delete process.env.JWT_SECRET;
            authMiddleware(req, res, next);
            expect(res.status).toHaveBeenCalledWith(500);
            expect(res.json).toHaveBeenCalledWith({ error: 'Server configuration error' });
            expect(next).not.toHaveBeenCalled();
            // Restore environment
            process.env.JWT_SECRET = originalEnv;
        });
        it('should return 401 for invalid token', () => {
            req.headers.authorization = 'Bearer invalid-token';
            authMiddleware(req, res, next);
            expect(res.status).toHaveBeenCalledWith(401);
            expect(res.json).toHaveBeenCalledWith({ error: 'Unauthorized' });
            expect(next).not.toHaveBeenCalled();
            expect(req.user).toBeUndefined();
        });
        it('should return 401 for expired token', () => {
            const secret = process.env.JWT_SECRET || require('crypto').randomBytes(32).toString('hex');
            const userId = '789';
            const expiredToken = jwt.sign({ userId, exp: Math.floor(Date.now() / 1000) - 3600 }, secret); // Expired 1 hour ago
            req.headers.authorization = `Bearer ${expiredToken}`;
            const originalEnv = process.env.JWT_SECRET;
            process.env.JWT_SECRET = secret;
            authMiddleware(req, res, next);
            expect(res.status).toHaveBeenCalledWith(401);
            expect(res.json).toHaveBeenCalledWith({ error: 'Unauthorized' });
            expect(next).not.toHaveBeenCalled();
            process.env.JWT_SECRET = originalEnv;
        });
        it('should return 401 for token with wrong secret', () => {
            const userId = '101';
            const token = jwt.sign({ userId }, 'wrong-secret');
            req.headers.authorization = `Bearer ${token}`;
            const originalEnv = process.env.JWT_SECRET;
            process.env.JWT_SECRET = 'correct-secret';
            authMiddleware(req, res, next);
            expect(res.status).toHaveBeenCalledWith(401);
            expect(res.json).toHaveBeenCalledWith({ error: 'Unauthorized' });
            expect(next).not.toHaveBeenCalled();
            process.env.JWT_SECRET = originalEnv;
        });
        it('should handle Bearer token without Bearer prefix', () => {
            const secret = process.env.JWT_SECRET || require('crypto').randomBytes(32).toString('hex');
            const userId = '202';
            const token = jwt.sign({ userId }, secret);
            req.headers.authorization = token; // No "Bearer " prefix
            const originalEnv = process.env.JWT_SECRET;
            process.env.JWT_SECRET = secret;
            authMiddleware(req, res, next);
            expect(req.user?.userId).toBe('202');
            expect(next).toHaveBeenCalled();
            process.env.JWT_SECRET = originalEnv;
        });
        it('should parse string userId to integer', () => {
            const secret = process.env.JWT_SECRET || require('crypto').randomBytes(32).toString('hex');
            const userId = '999';
            const token = jwt.sign({ userId }, secret);
            req.headers.authorization = `Bearer ${token}`;
            const originalEnv = process.env.JWT_SECRET;
            process.env.JWT_SECRET = secret;
            authMiddleware(req, res, next);
            expect(req.user?.userId).toBe('999');
            expect(typeof req.user?.userId).toBe('string');
            process.env.JWT_SECRET = originalEnv;
        });
        it('should handle token with additional claims', () => {
            const secret = process.env.JWT_SECRET || require('crypto').randomBytes(32).toString('hex');
            const payload = {
                userId: '555',
                role: 'teacher',
                email: 'test@example.com',
                exp: Math.floor(Date.now() / 1000) + 3600, // Expires in 1 hour
            };
            const token = jwt.sign(payload, secret);
            req.headers.authorization = `Bearer ${token}`;
            const originalEnv = process.env.JWT_SECRET;
            process.env.JWT_SECRET = secret;
            authMiddleware(req, res, next);
            expect(req.user?.userId).toBe('555');
            expect(next).toHaveBeenCalled();
            process.env.JWT_SECRET = originalEnv;
        });
        it('should handle malformed authorization header', () => {
            const testCases = [
                'Basic dXNlcjpwYXNz', // Basic auth instead of Bearer
                'Bearer', // Bearer without token
                'Bearer ', // Bearer with only space
                'Token abc123', // Wrong prefix
                'bearer token123', // Lowercase bearer
            ];
            testCases.forEach((authHeader) => {
                // Reset mocks for each test case
                jest.clearAllMocks();
                req.headers.authorization = authHeader;
                authMiddleware(req, res, next);
                expect(res.status).toHaveBeenCalledWith(401);
                expect(res.json).toHaveBeenCalledWith({ error: 'Unauthorized' });
                expect(next).not.toHaveBeenCalled();
            });
        });
        it('should handle token with invalid userId format', () => {
            const secret = process.env.JWT_SECRET || require('crypto').randomBytes(32).toString('hex');
            const token = jwt.sign({ userId: 'not-a-number' }, secret);
            req.headers.authorization = `Bearer ${token}`;
            const originalEnv = process.env.JWT_SECRET;
            process.env.JWT_SECRET = secret;
            authMiddleware(req, res, next);
            // The middleware doesn't parse userId, it keeps it as is
            expect(req.user?.userId).toBe('not-a-number');
            expect(next).toHaveBeenCalled();
            process.env.JWT_SECRET = originalEnv;
        });
        it('should handle token without userId claim', () => {
            const secret = process.env.JWT_SECRET || require('crypto').randomBytes(32).toString('hex');
            const token = jwt.sign({ role: 'teacher', email: 'test@example.com' }, secret);
            req.headers.authorization = `Bearer ${token}`;
            const originalEnv = process.env.JWT_SECRET;
            process.env.JWT_SECRET = secret;
            authMiddleware(req, res, next);
            expect(req.user?.userId).toBeUndefined(); // userId is undefined when not present in token
            expect(next).toHaveBeenCalled();
            process.env.JWT_SECRET = originalEnv;
        });
        it('should preserve other request properties', () => {
            const secret = process.env.JWT_SECRET || require('crypto').randomBytes(32).toString('hex');
            const userId = '123';
            const token = jwt.sign({ userId }, secret);
            req.headers.authorization = `Bearer ${token}`;
            req.body = { test: 'data' };
            req.params = { id: '456' };
            req.query = { search: 'term' };
            const originalEnv = process.env.JWT_SECRET;
            process.env.JWT_SECRET = secret;
            authMiddleware(req, res, next);
            expect(req.body).toEqual({ test: 'data' });
            expect(req.params).toEqual({ id: '456' });
            expect(req.query).toEqual({ search: 'term' });
            expect(req.user?.userId).toBe('123');
            process.env.JWT_SECRET = originalEnv;
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3Rlc3RzL3VuaXQvYXV0aC51bml0LnRlc3QudHMiLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkUsT0FBTyxHQUFHLE1BQU0sY0FBYyxDQUFDO0FBQy9CLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFFdkMsT0FBTyxFQUFFLGNBQWMsRUFBb0IsTUFBTSwyQkFBMkIsQ0FBQztBQUU3RSxNQUFNLE9BQU8sR0FBRyxhQUFhLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUUvQyxRQUFRLENBQUMsNEJBQTRCLEVBQUUsR0FBRyxFQUFFO0lBQzFDLElBQUksR0FBeUIsQ0FBQztJQUM5QixJQUFJLEdBQXNCLENBQUM7SUFDM0IsSUFBSSxJQUFxQyxDQUFDO0lBRTFDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxHQUFHLEdBQUc7WUFDSixPQUFPLEVBQUUsRUFBRTtTQUNaLENBQUM7UUFDRixHQUFHLEdBQUc7WUFDSixNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGNBQWMsRUFBRTtZQUNsQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGNBQWMsRUFBRTtTQUNqQyxDQUFDO1FBQ0YsSUFBSSxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUVqQiwyQkFBMkI7UUFDM0IsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3ZCLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLGdCQUFnQixFQUFFLEdBQUcsRUFBRTtRQUM5QixFQUFFLENBQUMsNERBQTRELEVBQUUsR0FBRyxFQUFFO1lBQ3BFLGNBQWMsQ0FBQyxHQUFrQixFQUFFLEdBQWUsRUFBRSxJQUFJLENBQUMsQ0FB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QUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRXJDLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFHLFdBQVcsQ0FBQztRQUN2QyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3Rlc3RzL3VuaXQvYXV0aC51bml0LnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZGVzY3JpYmUsIGl0LCBleHBlY3QsIGJlZm9yZUVhY2gsIGplc3QgfSBmcm9tICdAamVzdC9nbG9iYWxzJztcbmltcG9ydCBqd3QgZnJvbSAnanNvbndlYnRva2VuJztcbmltcG9ydCB7IGNyZWF0ZVJlcXVpcmUgfSBmcm9tICdtb2R1bGUnO1xuaW1wb3J0IHsgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IGF1dGhNaWRkbGV3YXJlLCB0eXBlIEF1dGhSZXF1ZXN0IH0gZnJvbSAnLi4vLi4vc3JjL21pZGRsZXdhcmUvYXV0aCc7XG5cbmNvbnN0IHJlcXVpcmUgPSBjcmVhdGVSZXF1aXJlKGltcG9ydC5tZXRhLnVybCk7XG5cbmRlc2NyaWJlKCdBdXRoIE1pZGRsZXdhcmUgVW5pdCBUZXN0cycsICgpID0+IHtcbiAgbGV0IHJlcTogUGFydGlhbDxBdXRoUmVxdWVzdD47XG4gIGxldCByZXM6IFBhcnRpYWw8UmVzcG9uc2U+O1xuICBsZXQgbmV4dDogamVzdC5Nb2NrZWRGdW5jdGlvbjwoKSA9PiB2b2lkPjtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICByZXEgPSB7XG4gICAgICBoZWFkZXJzOiB7fSxcbiAgICB9O1xuICAgIHJlcyA9IHtcbiAgICAgIHN0YXR1czogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICBqc29uOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICB9O1xuICAgIG5leHQgPSBqZXN0LmZuKCk7XG5cbiAgICAvLyBDbGVhciBhbnkgcHJldmlvdXMgbW9ja3NcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2F1dGhNaWRkbGV3YXJlJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIDQwMSB3aGVuIG5vIGF1dGhvcml6YXRpb24gaGVhZGVyIGlzIHByb3ZpZGVkJywgKCkgPT4ge1xuICAgICAgYXV0aE1pZGRsZXdhcmUocmVxIGFzIEF1dGhSZXF1ZXN0LCByZXMgYXMgUmVzcG9uc2UsIG5leHQpO1xuXG4gICAgICBleHBlY3QocmVzLnN0YXR1cykudG9IYXZlQmVlbkNhbGxlZFdpdGgoNDAxKTtcbiAgICAgIGV4cGVjdChyZXMuanNvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoeyBlcnJvcjogJ1VuYXV0aG9yaXplZCcgfSk7XG4gICAgICBleHBlY3QobmV4dCkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIDQwMSB3aGVuIGF1dGhvcml6YXRpb24gaGVhZGVyIGlzIGVtcHR5JywgKCkgPT4ge1xuICAgICAgcmVxLmhlYWRlcnMhLmF1dGhvcml6YXRpb24gPSAnJztcblxuICAgICAgYXV0aE1pZGRsZXdhcmUocmVxIGFzIEF1dGhSZXF1ZXN0LCByZXMgYXMgUmVzcG9uc2UsIG5leHQpO1xuXG4gICAgICBleHBlY3QocmVzLnN0YXR1cykudG9IYXZlQmVlbkNhbGxlZFdpdGgoNDAxKTtcbiAgICAgIGV4cGVjdChyZXMuanNvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoeyBlcnJvcjogJ1VuYXV0aG9yaXplZCcgfSk7XG4gICAgICBleHBlY3QobmV4dCkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZXh0cmFjdCB0b2tlbiBmcm9tIEJlYXJlciBhdXRob3JpemF0aW9uIGhlYWRlcicsICgpID0+IHtcbiAgICAgIGNvbnN0IHNlY3JldCA9IHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgfHwgcmVxdWlyZSgnY3J5cHRvJykucmFuZG9tQnl0ZXMoMzIpLnRvU3RyaW5nKCdoZXgnKTtcbiAgICAgIGNvbnN0IHVzZXJJZCA9ICcxMjMnO1xuICAgICAgY29uc3QgdG9rZW4gPSBqd3Quc2lnbih7IHVzZXJJZCB9LCBzZWNyZXQpO1xuXG4gICAgICByZXEuaGVhZGVycyEuYXV0aG9yaXphdGlvbiA9IGBCZWFyZXIgJHt0b2tlbn1gO1xuXG4gICAgICAvLyBNb2NrIGVudmlyb25tZW50IHZhcmlhYmxlXG4gICAgICBjb25zdCBvcmlnaW5hbEVudiA9IHByb2Nlc3MuZW52LkpXVF9TRUNSRVQ7XG4gICAgICBwcm9jZXNzLmVudi5KV1RfU0VDUkVUID0gc2VjcmV0O1xuXG4gICAgICBhdXRoTWlkZGxld2FyZShyZXEgYXMgQXV0aFJlcXVlc3QsIHJlcyBhcyBSZXNwb25zZSwgbmV4dCk7XG5cbiAgICAgIGV4cGVjdChyZXEudXNlcj8udXNlcklkKS50b0JlKCcxMjMnKTtcbiAgICAgIGV4cGVjdChuZXh0KS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3QocmVzLnN0YXR1cykubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcblxuICAgICAgLy8gUmVzdG9yZSBlbnZpcm9ubWVudFxuICAgICAgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCA9IG9yaWdpbmFsRW52O1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gNTAwIHdoZW4gSldUX1NFQ1JFVCBpcyBub3Qgc2V0JywgKCkgPT4ge1xuICAgICAgY29uc3QgdXNlcklkID0gJzQ1Nic7XG4gICAgICBjb25zdCB0b2tlbiA9IGp3dC5zaWduKHsgdXNlcklkIH0sICdzZWNyZXQnKTsgLy8gQW55IHNlY3JldFxuXG4gICAgICByZXEuaGVhZGVycyEuYXV0aG9yaXphdGlvbiA9IGBCZWFyZXIgJHt0b2tlbn1gO1xuXG4gICAgICAvLyBFbnN1cmUgSldUX1NFQ1JFVCBpcyBub3Qgc2V0XG4gICAgICBjb25zdCBvcmlnaW5hbEVudiA9IHByb2Nlc3MuZW52LkpXVF9TRUNSRVQ7XG4gICAgICBkZWxldGUgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVDtcblxuICAgICAgYXV0aE1pZGRsZXdhcmUocmVxIGFzIEF1dGhSZXF1ZXN0LCByZXMgYXMgUmVzcG9uc2UsIG5leHQpO1xuXG4gICAgICBleHBlY3QocmVzLnN0YXR1cykudG9IYXZlQmVlbkNhbGxlZFdpdGgoNTAwKTtcbiAgICAgIGV4cGVjdChyZXMuanNvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoeyBlcnJvcjogJ1NlcnZlciBjb25maWd1cmF0aW9uIGVycm9yJyB9KTtcbiAgICAgIGV4cGVjdChuZXh0KS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuXG4gICAgICAvLyBSZXN0b3JlIGVudmlyb25tZW50XG4gICAgICBwcm9jZXNzLmVudi5KV1RfU0VDUkVUID0gb3JpZ2luYWxFbnY7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiA0MDEgZm9yIGludmFsaWQgdG9rZW4nLCAoKSA9PiB7XG4gICAgICByZXEuaGVhZGVycyEuYXV0aG9yaXphdGlvbiA9ICdCZWFyZXIgaW52YWxpZC10b2tlbic7XG5cbiAgICAgIGF1dGhNaWRkbGV3YXJlKHJlcSBhcyBBdXRoUmVxdWVzdCwgcmVzIGFzIFJlc3BvbnNlLCBuZXh0KTtcblxuICAgICAgZXhwZWN0KHJlcy5zdGF0dXMpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKDQwMSk7XG4gICAgICBleHBlY3QocmVzLmpzb24pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHsgZXJyb3I6ICdVbmF1dGhvcml6ZWQnIH0pO1xuICAgICAgZXhwZWN0KG5leHQpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3QocmVxLnVzZXIpLnRvQmVVbmRlZmluZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIDQwMSBmb3IgZXhwaXJlZCB0b2tlbicsICgpID0+IHtcbiAgICAgIGNvbnN0IHNlY3JldCA9IHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgfHwgcmVxdWlyZSgnY3J5cHRvJykucmFuZG9tQnl0ZXMoMzIpLnRvU3RyaW5nKCdoZXgnKTtcbiAgICAgIGNvbnN0IHVzZXJJZCA9ICc3ODknO1xuICAgICAgY29uc3QgZXhwaXJlZFRva2VuID0gand0LnNpZ24oeyB1c2VySWQsIGV4cDogTWF0aC5mbG9vcihEYXRlLm5vdygpIC8gMTAwMCkgLSAzNjAwIH0sIHNlY3JldCk7IC8vIEV4cGlyZWQgMSBob3VyIGFnb1xuXG4gICAgICByZXEuaGVhZGVycyEuYXV0aG9yaXphdGlvbiA9IGBCZWFyZXIgJHtleHBpcmVkVG9rZW59YDtcblxuICAgICAgY29uc3Qgb3JpZ2luYWxFbnYgPSBwcm9jZXNzLmVudi5KV1RfU0VDUkVUO1xuICAgICAgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCA9IHNlY3JldDtcblxuICAgICAgYXV0aE1pZGRsZXdhcmUocmVxIGFzIEF1dGhSZXF1ZXN0LCByZXMgYXMgUmVzcG9uc2UsIG5leHQpO1xuXG4gICAgICBleHBlY3QocmVzLnN0YXR1cykudG9IYXZlQmVlbkNhbGxlZFdpdGgoNDAxKTtcbiAgICAgIGV4cGVjdChyZXMuanNvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoeyBlcnJvcjogJ1VuYXV0aG9yaXplZCcgfSk7XG4gICAgICBleHBlY3QobmV4dCkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcblxuICAgICAgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCA9IG9yaWdpbmFsRW52O1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gNDAxIGZvciB0b2tlbiB3aXRoIHdyb25nIHNlY3JldCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHVzZXJJZCA9ICcxMDEnO1xuICAgICAgY29uc3QgdG9rZW4gPSBqd3Quc2lnbih7IHVzZXJJZCB9LCAnd3Jvbmctc2VjcmV0Jyk7XG5cbiAgICAgIHJlcS5oZWFkZXJzIS5hdXRob3JpemF0aW9uID0gYEJlYXJlciAke3Rva2VufWA7XG5cbiAgICAgIGNvbnN0IG9yaWdpbmFsRW52ID0gcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVDtcbiAgICAgIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgPSAnY29ycmVjdC1zZWNyZXQnO1xuXG4gICAgICBhdXRoTWlkZGxld2FyZShyZXEgYXMgQXV0aFJlcXVlc3QsIHJlcyBhcyBSZXNwb25zZSwgbmV4dCk7XG5cbiAgICAgIGV4cGVjdChyZXMuc3RhdHVzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCg0MDEpO1xuICAgICAgZXhwZWN0KHJlcy5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7IGVycm9yOiAnVW5hdXRob3JpemVkJyB9KTtcbiAgICAgIGV4cGVjdChuZXh0KS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuXG4gICAgICBwcm9jZXNzLmVudi5KV1RfU0VDUkVUID0gb3JpZ2luYWxFbnY7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBCZWFyZXIgdG9rZW4gd2l0aG91dCBCZWFyZXIgcHJlZml4JywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2VjcmV0ID0gcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCB8fCByZXF1aXJlKCdjcnlwdG8nKS5yYW5kb21CeXRlcygzMikudG9TdHJpbmcoJ2hleCcpO1xuICAgICAgY29uc3QgdXNlcklkID0gJzIwMic7XG4gICAgICBjb25zdCB0b2tlbiA9IGp3dC5zaWduKHsgdXNlcklkIH0sIHNlY3JldCk7XG5cbiAgICAgIHJlcS5oZWFkZXJzIS5hdXRob3JpemF0aW9uID0gdG9rZW47IC8vIE5vIFwiQmVhcmVyIFwiIHByZWZpeFxuXG4gICAgICBjb25zdCBvcmlnaW5hbEVudiA9IHByb2Nlc3MuZW52LkpXVF9TRUNSRVQ7XG4gICAgICBwcm9jZXNzLmVudi5KV1RfU0VDUkVUID0gc2VjcmV0O1xuXG4gICAgICBhdXRoTWlkZGxld2FyZShyZXEgYXMgQXV0aFJlcXVlc3QsIHJlcyBhcyBSZXNwb25zZSwgbmV4dCk7XG5cbiAgICAgIGV4cGVjdChyZXEudXNlcj8udXNlcklkKS50b0JlKCcyMDInKTtcbiAgICAgIGV4cGVjdChuZXh0KS50b0hhdmVCZWVuQ2FsbGVkKCk7XG5cbiAgICAgIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgPSBvcmlnaW5hbEVudjtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcGFyc2Ugc3RyaW5nIHVzZXJJZCB0byBpbnRlZ2VyJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2VjcmV0ID0gcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCB8fCByZXF1aXJlKCdjcnlwdG8nKS5yYW5kb21CeXRlcygzMikudG9TdHJpbmcoJ2hleCcpO1xuICAgICAgY29uc3QgdXNlcklkID0gJzk5OSc7XG4gICAgICBjb25zdCB0b2tlbiA9IGp3dC5zaWduKHsgdXNlcklkIH0sIHNlY3JldCk7XG5cbiAgICAgIHJlcS5oZWFkZXJzIS5hdXRob3JpemF0aW9uID0gYEJlYXJlciAke3Rva2VufWA7XG5cbiAgICAgIGNvbnN0IG9yaWdpbmFsRW52ID0gcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVDtcbiAgICAgIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgPSBzZWNyZXQ7XG5cbiAgICAgIGF1dGhNaWRkbGV3YXJlKHJlcSBhcyBBdXRoUmVxdWVzdCwgcmVzIGFzIFJlc3BvbnNlLCBuZXh0KTtcblxuICAgICAgZXhwZWN0KHJlcS51c2VyPy51c2VySWQpLnRvQmUoJzk5OScpO1xuICAgICAgZXhwZWN0KHR5cGVvZiByZXEudXNlcj8udXNlcklkKS50b0JlKCdzdHJpbmcnKTtcblxuICAgICAgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCA9IG9yaWdpbmFsRW52O1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgdG9rZW4gd2l0aCBhZGRpdGlvbmFsIGNsYWltcycsICgpID0+IHtcbiAgICAgIGNvbnN0IHNlY3JldCA9IHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgfHwgcmVxdWlyZSgnY3J5cHRvJykucmFuZG9tQnl0ZXMoMzIpLnRvU3RyaW5nKCdoZXgnKTtcbiAgICAgIGNvbnN0IHBheWxvYWQgPSB7XG4gICAgICAgIHVzZXJJZDogJzU1NScsXG4gICAgICAgIHJvbGU6ICd0ZWFjaGVyJyxcbiAgICAgICAgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyxcbiAgICAgICAgZXhwOiBNYXRoLmZsb29yKERhdGUubm93KCkgLyAxMDAwKSArIDM2MDAsIC8vIEV4cGlyZXMgaW4gMSBob3VyXG4gICAgICB9O1xuICAgICAgY29uc3QgdG9rZW4gPSBqd3Quc2lnbihwYXlsb2FkLCBzZWNyZXQpO1xuXG4gICAgICByZXEuaGVhZGVycyEuYXV0aG9yaXphdGlvbiA9IGBCZWFyZXIgJHt0b2tlbn1gO1xuXG4gICAgICBjb25zdCBvcmlnaW5hbEVudiA9IHByb2Nlc3MuZW52LkpXVF9TRUNSRVQ7XG4gICAgICBwcm9jZXNzLmVudi5KV1RfU0VDUkVUID0gc2VjcmV0O1xuXG4gICAgICBhdXRoTWlkZGxld2FyZShyZXEgYXMgQXV0aFJlcXVlc3QsIHJlcyBhcyBSZXNwb25zZSwgbmV4dCk7XG5cbiAgICAgIGV4cGVjdChyZXEudXNlcj8udXNlcklkKS50b0JlKCc1NTUnKTtcbiAgICAgIGV4cGVjdChuZXh0KS50b0hhdmVCZWVuQ2FsbGVkKCk7XG5cbiAgICAgIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgPSBvcmlnaW5hbEVudjtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIG1hbGZvcm1lZCBhdXRob3JpemF0aW9uIGhlYWRlcicsICgpID0+IHtcbiAgICAgIGNvbnN0IHRlc3RDYXNlcyA9IFtcbiAgICAgICAgJ0Jhc2ljIGRYTmxjanB3WVhOeicsIC8vIEJhc2ljIGF1dGggaW5zdGVhZCBvZiBCZWFyZXJcbiAgICAgICAgJ0JlYXJlcicsIC8vIEJlYXJlciB3aXRob3V0IHRva2VuXG4gICAgICAgICdCZWFyZXIgJywgLy8gQmVhcmVyIHdpdGggb25seSBzcGFjZVxuICAgICAgICAnVG9rZW4gYWJjMTIzJywgLy8gV3JvbmcgcHJlZml4XG4gICAgICAgICdiZWFyZXIgdG9rZW4xMjMnLCAvLyBMb3dlcmNhc2UgYmVhcmVyXG4gICAgICBdO1xuXG4gICAgICB0ZXN0Q2FzZXMuZm9yRWFjaCgoYXV0aEhlYWRlcikgPT4ge1xuICAgICAgICAvLyBSZXNldCBtb2NrcyBmb3IgZWFjaCB0ZXN0IGNhc2VcbiAgICAgICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG4gICAgICAgIHJlcS5oZWFkZXJzIS5hdXRob3JpemF0aW9uID0gYXV0aEhlYWRlcjtcblxuICAgICAgICBhdXRoTWlkZGxld2FyZShyZXEgYXMgQXV0aFJlcXVlc3QsIHJlcyBhcyBSZXNwb25zZSwgbmV4dCk7XG5cbiAgICAgICAgZXhwZWN0KHJlcy5zdGF0dXMpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKDQwMSk7XG4gICAgICAgIGV4cGVjdChyZXMuanNvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoeyBlcnJvcjogJ1VuYXV0aG9yaXplZCcgfSk7XG4gICAgICAgIGV4cGVjdChuZXh0KS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSB0b2tlbiB3aXRoIGludmFsaWQgdXNlcklkIGZvcm1hdCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHNlY3JldCA9IHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgfHwgcmVxdWlyZSgnY3J5cHRvJykucmFuZG9tQnl0ZXMoMzIpLnRvU3RyaW5nKCdoZXgnKTtcbiAgICAgIGNvbnN0IHRva2VuID0gand0LnNpZ24oeyB1c2VySWQ6ICdub3QtYS1udW1iZXInIH0sIHNlY3JldCk7XG5cbiAgICAgIHJlcS5oZWFkZXJzIS5hdXRob3JpemF0aW9uID0gYEJlYXJlciAke3Rva2VufWA7XG5cbiAgICAgIGNvbnN0IG9yaWdpbmFsRW52ID0gcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVDtcbiAgICAgIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgPSBzZWNyZXQ7XG5cbiAgICAgIGF1dGhNaWRkbGV3YXJlKHJlcSBhcyBBdXRoUmVxdWVzdCwgcmVzIGFzIFJlc3BvbnNlLCBuZXh0KTtcblxuICAgICAgLy8gVGhlIG1pZGRsZXdhcmUgZG9lc24ndCBwYXJzZSB1c2VySWQsIGl0IGtlZXBzIGl0IGFzIGlzXG4gICAgICBleHBlY3QocmVxLnVzZXI/LnVzZXJJZCkudG9CZSgnbm90LWEtbnVtYmVyJyk7XG4gICAgICBleHBlY3QobmV4dCkudG9IYXZlQmVlbkNhbGxlZCgpO1xuXG4gICAgICBwcm9jZXNzLmVudi5KV1RfU0VDUkVUID0gb3JpZ2luYWxFbnY7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSB0b2tlbiB3aXRob3V0IHVzZXJJZCBjbGFpbScsICgpID0+IHtcbiAgICAgIGNvbnN0IHNlY3JldCA9IHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgfHwgcmVxdWlyZSgnY3J5cHRvJykucmFuZG9tQnl0ZXMoMzIpLnRvU3RyaW5nKCdoZXgnKTtcbiAgICAgIGNvbnN0IHRva2VuID0gand0LnNpZ24oeyByb2xlOiAndGVhY2hlcicsIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScgfSwgc2VjcmV0KTtcblxuICAgICAgcmVxLmhlYWRlcnMhLmF1dGhvcml6YXRpb24gPSBgQmVhcmVyICR7dG9rZW59YDtcblxuICAgICAgY29uc3Qgb3JpZ2luYWxFbnYgPSBwcm9jZXNzLmVudi5KV1RfU0VDUkVUO1xuICAgICAgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCA9IHNlY3JldDtcblxuICAgICAgYXV0aE1pZGRsZXdhcmUocmVxIGFzIEF1dGhSZXF1ZXN0LCByZXMgYXMgUmVzcG9uc2UsIG5leHQpO1xuXG4gICAgICBleHBlY3QocmVxLnVzZXI/LnVzZXJJZCkudG9CZVVuZGVmaW5lZCgpOyAvLyB1c2VySWQgaXMgdW5kZWZpbmVkIHdoZW4gbm90IHByZXNlbnQgaW4gdG9rZW5cbiAgICAgIGV4cGVjdChuZXh0KS50b0hhdmVCZWVuQ2FsbGVkKCk7XG5cbiAgICAgIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgPSBvcmlnaW5hbEVudjtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcHJlc2VydmUgb3RoZXIgcmVxdWVzdCBwcm9wZXJ0aWVzJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2VjcmV0ID0gcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCB8fCByZXF1aXJlKCdjcnlwdG8nKS5yYW5kb21CeXRlcygzMikudG9TdHJpbmcoJ2hleCcpO1xuICAgICAgY29uc3QgdXNlcklkID0gJzEyMyc7XG4gICAgICBjb25zdCB0b2tlbiA9IGp3dC5zaWduKHsgdXNlcklkIH0sIHNlY3JldCk7XG5cbiAgICAgIHJlcS5oZWFkZXJzIS5hdXRob3JpemF0aW9uID0gYEJlYXJlciAke3Rva2VufWA7XG4gICAgICByZXEuYm9keSA9IHsgdGVzdDogJ2RhdGEnIH07XG4gICAgICByZXEucGFyYW1zID0geyBpZDogJzQ1NicgfTtcbiAgICAgIHJlcS5xdWVyeSA9IHsgc2VhcmNoOiAndGVybScgfTtcblxuICAgICAgY29uc3Qgb3JpZ2luYWxFbnYgPSBwcm9jZXNzLmVudi5KV1RfU0VDUkVUO1xuICAgICAgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCA9IHNlY3JldDtcblxuICAgICAgYXV0aE1pZGRsZXdhcmUocmVxIGFzIEF1dGhSZXF1ZXN0LCByZXMgYXMgUmVzcG9uc2UsIG5leHQpO1xuXG4gICAgICBleHBlY3QocmVxLmJvZHkpLnRvRXF1YWwoeyB0ZXN0OiAnZGF0YScgfSk7XG4gICAgICBleHBlY3QocmVxLnBhcmFtcykudG9FcXVhbCh7IGlkOiAnNDU2JyB9KTtcbiAgICAgIGV4cGVjdChyZXEucXVlcnkpLnRvRXF1YWwoeyBzZWFyY2g6ICd0ZXJtJyB9KTtcbiAgICAgIGV4cGVjdChyZXEudXNlcj8udXNlcklkKS50b0JlKCcxMjMnKTtcblxuICAgICAgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCA9IG9yaWdpbmFsRW52O1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9