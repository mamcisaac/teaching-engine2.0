7866a0f8a62096390ce1d7a9360b264a
/**
 * Team Collaboration Routes
 * Handles team creation, management, and collaboration features
 */
import { Router } from 'express';
import { TeamRole, InvitationStatus } from '@teaching-engine/database';
import { z } from 'zod';
import { authenticate } from '@/middleware/authenticate';
import { asyncHandler } from '@/middleware/errorHandler';
import logger from '@/logger';
import { addDays } from 'date-fns';
// Validation schemas
const createTeamSchema = z.object({
    name: z.string().min(1).max(100),
    description: z.string().optional(),
    grade: z.number().int().min(1).max(12).optional(),
    subject: z.string().optional(),
    schoolName: z.string().optional(),
    schoolBoard: z.string().optional(),
    isPublic: z.boolean().optional(),
    requiresApproval: z.boolean().optional(),
});
const updateTeamSchema = createTeamSchema.partial();
const inviteMemberSchema = z.object({
    email: z.string().email(),
    message: z.string().optional(),
    role: z.enum(['ADMIN', 'MEMBER', 'VIEWER']).optional(),
});
const respondToInvitationSchema = z.object({
    response: z.enum(['accept', 'decline']),
});
export function teamRoutes(prisma) {
    const router = Router();
    // Apply authentication to all routes
    router.use(authenticate);
    // Get all teams for the current user
    router.get('/', asyncHandler(async (req, res) => {
        const userId = req.user.id;
        const teams = await prisma.team.findMany({
            where: {
                OR: [
                    { ownerId: userId },
                    { members: { some: { userId } } },
                ],
            },
            include: {
                owner: {
                    select: { id: true, name: true, email: true },
                },
                _count: {
                    select: { members: true },
                },
            },
            orderBy: { createdAt: 'desc' },
        });
        res.json(teams);
    }));
    // Get public teams (for discovery)
    router.get('/public', asyncHandler(async (req, res) => {
        const { grade, subject, search } = req.query;
        const teams = await prisma.team.findMany({
            where: {
                isPublic: true,
                ...(grade && { grade: parseInt(grade) }),
                ...(subject && { subject: subject }),
                ...(search && {
                    OR: [
                        { name: { contains: search } },
                        { description: { contains: search } },
                    ],
                }),
            },
            include: {
                owner: {
                    select: { id: true, name: true },
                },
                _count: {
                    select: { members: true },
                },
            },
            orderBy: { createdAt: 'desc' },
            take: 50,
        });
        res.json(teams);
    }));
    // Get team by ID
    router.get('/:teamId', asyncHandler(async (req, res) => {
        const { teamId } = req.params;
        const userId = req.user.id;
        const team = await prisma.team.findUnique({
            where: { id: teamId },
            include: {
                owner: {
                    select: { id: true, name: true, email: true },
                },
                members: {
                    include: {
                        user: {
                            select: { id: true, name: true, email: true },
                        },
                    },
                    orderBy: { joinedAt: 'asc' },
                },
                _count: {
                    select: {
                        members: true,
                        sharedResources: true,
                        discussions: true,
                    },
                },
            },
        });
        if (!team) {
            return res.status(404).json({ error: 'Team not found' });
        }
        // Check if user has access
        const isMember = team.ownerId === userId ||
            team.members.some(m => m.userId === userId);
        if (!isMember && !team.isPublic && !team.allowGuests) {
            return res.status(403).json({ error: 'Access denied' });
        }
        res.json(team);
    }));
    // Create a new team
    router.post('/', asyncHandler(async (req, res) => {
        const userId = req.user.id;
        const data = createTeamSchema.parse(req.body);
        const team = await prisma.team.create({
            data: {
                name: data.name,
                description: data.description,
                grade: data.grade,
                subject: data.subject,
                schoolName: data.schoolName,
                schoolBoard: data.schoolBoard,
                isPublic: data.isPublic,
                requiresApproval: data.requiresApproval,
                owner: {
                    connect: { id: userId },
                },
                members: {
                    create: {
                        userId,
                        role: TeamRole.OWNER,
                    },
                },
            },
            include: {
                owner: {
                    select: { id: true, name: true, email: true },
                },
                members: {
                    include: {
                        user: {
                            select: { id: true, name: true, email: true },
                        },
                    },
                },
            },
        });
        logger.info(`Team created: ${team.id} by user ${userId}`);
        res.status(201).json(team);
    }));
    // Update team
    router.patch('/:teamId', asyncHandler(async (req, res) => {
        const { teamId } = req.params;
        const userId = req.user.id;
        const data = updateTeamSchema.parse(req.body);
        // Check if user is owner or admin
        const member = await prisma.teamMember.findUnique({
            where: { teamId_userId: { teamId, userId } },
        });
        if (!member || (member.role !== TeamRole.OWNER && member.role !== TeamRole.ADMIN)) {
            return res.status(403).json({ error: 'Only team owners and admins can update team settings' });
        }
        const team = await prisma.team.update({
            where: { id: teamId },
            data,
            include: {
                owner: {
                    select: { id: true, name: true, email: true },
                },
            },
        });
        res.json(team);
    }));
    // Delete team (owner only)
    router.delete('/:teamId', asyncHandler(async (req, res) => {
        const { teamId } = req.params;
        const userId = req.user.id;
        const team = await prisma.team.findUnique({
            where: { id: teamId },
        });
        if (!team) {
            return res.status(404).json({ error: 'Team not found' });
        }
        if (team.ownerId !== userId) {
            return res.status(403).json({ error: 'Only the team owner can delete the team' });
        }
        await prisma.team.delete({
            where: { id: teamId },
        });
        logger.info(`Team deleted: ${teamId} by user ${userId}`);
        res.status(204).send();
    }));
    // Invite member to team
    router.post('/:teamId/invitations', asyncHandler(async (req, res) => {
        const { teamId } = req.params;
        const userId = req.user.id;
        const { email, message, role = TeamRole.MEMBER } = inviteMemberSchema.parse(req.body);
        // Check if user can invite (owner or admin)
        const member = await prisma.teamMember.findUnique({
            where: { teamId_userId: { teamId, userId } },
        });
        if (!member || (member.role !== TeamRole.OWNER && member.role !== TeamRole.ADMIN)) {
            return res.status(403).json({ error: 'Only team owners and admins can invite members' });
        }
        // Check if user is already a member
        const existingUser = await prisma.user.findUnique({
            where: { email },
        });
        if (existingUser) {
            const existingMember = await prisma.teamMember.findUnique({
                where: { teamId_userId: { teamId, userId: existingUser.id } },
            });
            if (existingMember) {
                return res.status(409).json({ error: 'User is already a team member' });
            }
        }
        // Check for existing pending invitation
        const existingInvitation = await prisma.teamInvitation.findUnique({
            where: { teamId_email: { teamId, email } },
        });
        if (existingInvitation && existingInvitation.status === InvitationStatus.PENDING) {
            return res.status(409).json({ error: 'An invitation is already pending for this email' });
        }
        // Create invitation
        const invitation = await prisma.teamInvitation.create({
            data: {
                teamId,
                email,
                invitedById: userId,
                invitedUserId: existingUser?.id,
                message,
                role,
                expiresAt: addDays(new Date(), 7), // 7 day expiration
            },
            include: {
                team: {
                    select: { id: true, name: true },
                },
                invitedBy: {
                    select: { id: true, name: true, email: true },
                },
            },
        });
        // TODO: Send email notification
        res.status(201).json(invitation);
    }));
    // Get team invitations
    router.get('/:teamId/invitations', asyncHandler(async (req, res) => {
        const { teamId } = req.params;
        const userId = req.user.id;
        // Check if user is member
        const member = await prisma.teamMember.findUnique({
            where: { teamId_userId: { teamId, userId } },
        });
        if (!member) {
            return res.status(403).json({ error: 'Access denied' });
        }
        const invitations = await prisma.teamInvitation.findMany({
            where: {
                teamId,
                status: InvitationStatus.PENDING,
                expiresAt: { gt: new Date() },
            },
            include: {
                invitedBy: {
                    select: { id: true, name: true, email: true },
                },
                invitedUser: {
                    select: { id: true, name: true, email: true },
                },
            },
            orderBy: { createdAt: 'desc' },
        });
        res.json(invitations);
    }));
    // Get user's pending invitations
    router.get('/invitations/my', asyncHandler(async (req, res) => {
        const userId = req.user.id;
        const userEmail = req.user.email;
        const invitations = await prisma.teamInvitation.findMany({
            where: {
                OR: [
                    { invitedUserId: userId },
                    { email: userEmail },
                ],
                status: InvitationStatus.PENDING,
                expiresAt: { gt: new Date() },
            },
            include: {
                team: {
                    include: {
                        owner: {
                            select: { id: true, name: true },
                        },
                        _count: {
                            select: { members: true },
                        },
                    },
                },
                invitedBy: {
                    select: { id: true, name: true, email: true },
                },
            },
            orderBy: { createdAt: 'desc' },
        });
        res.json(invitations);
    }));
    // Respond to invitation
    router.post('/invitations/:invitationId/respond', asyncHandler(async (req, res) => {
        const { invitationId } = req.params;
        const userId = req.user.id;
        const userEmail = req.user.email;
        const { response } = respondToInvitationSchema.parse(req.body);
        const invitation = await prisma.teamInvitation.findUnique({
            where: { id: invitationId },
        });
        if (!invitation) {
            return res.status(404).json({ error: 'Invitation not found' });
        }
        // Check if invitation is for this user
        if (invitation.invitedUserId !== userId && invitation.email !== userEmail) {
            return res.status(403).json({ error: 'This invitation is not for you' });
        }
        // Check if invitation is still valid
        if (invitation.status !== InvitationStatus.PENDING) {
            return res.status(409).json({ error: 'Invitation has already been responded to' });
        }
        if (new Date() > invitation.expiresAt) {
            return res.status(409).json({ error: 'Invitation has expired' });
        }
        if (response === 'accept') {
            // Create team membership
            await prisma.$transaction(async (tx) => {
                // Update invitation
                await tx.teamInvitation.update({
                    where: { id: invitationId },
                    data: {
                        status: InvitationStatus.ACCEPTED,
                        respondedAt: new Date(),
                    },
                });
                // Create membership
                await tx.teamMember.create({
                    data: {
                        teamId: invitation.teamId,
                        userId,
                        role: invitation.role,
                    },
                });
            });
            logger.info(`User ${userId} accepted invitation to team ${invitation.teamId}`);
            res.json({ message: 'Invitation accepted successfully' });
        }
        else {
            // Decline invitation
            await prisma.teamInvitation.update({
                where: { id: invitationId },
                data: {
                    status: InvitationStatus.DECLINED,
                    respondedAt: new Date(),
                },
            });
            res.json({ message: 'Invitation declined' });
        }
    }));
    // Leave team
    router.post('/:teamId/leave', asyncHandler(async (req, res) => {
        const { teamId } = req.params;
        const userId = req.user.id;
        const member = await prisma.teamMember.findUnique({
            where: { teamId_userId: { teamId, userId } },
        });
        if (!member) {
            return res.status(404).json({ error: 'You are not a member of this team' });
        }
        if (member.role === TeamRole.OWNER) {
            return res.status(400).json({ error: 'Team owner cannot leave the team. Transfer ownership or delete the team.' });
        }
        await prisma.teamMember.delete({
            where: { id: member.id },
        });
        logger.info(`User ${userId} left team ${teamId}`);
        res.json({ message: 'Successfully left the team' });
    }));
    // Update member role
    router.patch('/:teamId/members/:memberId', asyncHandler(async (req, res) => {
        const { teamId, memberId } = req.params;
        const userId = req.user.id;
        const { role } = z.object({ role: z.enum(['ADMIN', 'MEMBER', 'VIEWER']) }).parse(req.body);
        // Check if user is owner
        const team = await prisma.team.findUnique({
            where: { id: teamId },
        });
        if (!team || team.ownerId !== userId) {
            return res.status(403).json({ error: 'Only the team owner can change member roles' });
        }
        const member = await prisma.teamMember.findFirst({
            where: { id: memberId, teamId },
        });
        if (!member) {
            return res.status(404).json({ error: 'Member not found' });
        }
        if (member.role === TeamRole.OWNER) {
            return res.status(400).json({ error: 'Cannot change owner role' });
        }
        const updatedMember = await prisma.teamMember.update({
            where: { id: memberId },
            data: { role },
            include: {
                user: {
                    select: { id: true, name: true, email: true },
                },
            },
        });
        res.json(updatedMember);
    }));
    // Remove member from team
    router.delete('/:teamId/members/:memberId', asyncHandler(async (req, res) => {
        const { teamId, memberId } = req.params;
        const userId = req.user.id;
        // Check if user is owner or admin
        const currentMember = await prisma.teamMember.findUnique({
            where: { teamId_userId: { teamId, userId } },
        });
        if (!currentMember || (currentMember.role !== TeamRole.OWNER && currentMember.role !== TeamRole.ADMIN)) {
            return res.status(403).json({ error: 'Only team owners and admins can remove members' });
        }
        const memberToRemove = await prisma.teamMember.findFirst({
            where: { id: memberId, teamId },
        });
        if (!memberToRemove) {
            return res.status(404).json({ error: 'Member not found' });
        }
        if (memberToRemove.role === TeamRole.OWNER) {
            return res.status(400).json({ error: 'Cannot remove team owner' });
        }
        await prisma.teamMember.delete({
            where: { id: memberId },
        });
        logger.info(`Member ${memberToRemove.userId} removed from team ${teamId} by user ${userId}`);
        res.status(204).send();
    }));
    return router;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9yb3V0ZXMvdGVhbXMudHMiLCJtYXBwaW5ncyI6IkFBQUE7OztHQUdHO0FBRUgsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUNqQyxPQUFPLEVBQWdCLFFBQVEsRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3JGLE9BQU8sRUFBRSxDQUFDLEVBQUUsTUFBTSxLQUFLLENBQUM7QUFDeEIsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN6RCxPQUFPLE1BQU0sTUFBTSxVQUFVLENBQUM7QUFDOUIsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUVuQyxxQkFBcUI7QUFDckIsTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDO0lBQ2hDLElBQUksRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUM7SUFDaEMsV0FBVyxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLEVBQUU7SUFDbEMsS0FBSyxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLFFBQVEsRUFBRTtJQUNqRCxPQUFPLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsRUFBRTtJQUM5QixVQUFVLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsRUFBRTtJQUNqQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsRUFBRTtJQUNsQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLE9BQU8sRUFB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RSxDQUFDO1lBQ3BCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQyxDQUFDO1FBQzdELENBQUM7UUFFRCxJQUFJLGNBQWMsQ0FBQyxJQUFJLEtBQUssUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQzNDLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsMEJBQTBCLEVBQUUsQ0FBQyxDQUFDO1FBQ3JFLENBQUM7UUFFRCxNQUFNLE1BQU0sQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDO1lBQzdCLEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRSxRQUFRLEVBQUU7U0FDeEIsQ0FBQyxDQUFDO1FBRUgsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLGNBQWMsQ0FBQyxNQUFNLHNCQUFzQixNQUFNLFlBQVksTUFBTSxFQUFFLENBQUMsQ0FBQztRQUM3RixHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3pCLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFSixPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9taWNoYWVsbWNpc2FhYy9HaXRIdWIvdGVhY2hpbmctZW5naW5lMi4wL3NlcnZlci9zcmMvcm91dGVzL3RlYW1zLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogVGVhbSBDb2xsYWJvcmF0aW9uIFJvdXRlc1xuICogSGFuZGxlcyB0ZWFtIGNyZWF0aW9uLCBtYW5hZ2VtZW50LCBhbmQgY29sbGFib3JhdGlvbiBmZWF0dXJlc1xuICovXG5cbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgUHJpc21hQ2xpZW50LCBUZWFtUm9sZSwgSW52aXRhdGlvblN0YXR1cyB9IGZyb20gJ0B0ZWFjaGluZy1lbmdpbmUvZGF0YWJhc2UnO1xuaW1wb3J0IHsgeiB9IGZyb20gJ3pvZCc7XG5pbXBvcnQgeyBhdXRoZW50aWNhdGUgfSBmcm9tICdAL21pZGRsZXdhcmUvYXV0aGVudGljYXRlJztcbmltcG9ydCB7IGFzeW5jSGFuZGxlciB9IGZyb20gJ0AvbWlkZGxld2FyZS9lcnJvckhhbmRsZXInO1xuaW1wb3J0IGxvZ2dlciBmcm9tICdAL2xvZ2dlcic7XG5pbXBvcnQgeyBhZGREYXlzIH0gZnJvbSAnZGF0ZS1mbnMnO1xuXG4vLyBWYWxpZGF0aW9uIHNjaGVtYXNcbmNvbnN0IGNyZWF0ZVRlYW1TY2hlbWEgPSB6Lm9iamVjdCh7XG4gIG5hbWU6IHouc3RyaW5nKCkubWluKDEpLm1heCgxMDApLFxuICBkZXNjcmlwdGlvbjogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuICBncmFkZTogei5udW1iZXIoKS5pbnQoKS5taW4oMSkubWF4KDEyKS5vcHRpb25hbCgpLFxuICBzdWJqZWN0OiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gIHNjaG9vbE5hbWU6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgc2Nob29sQm9hcmQ6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgaXNQdWJsaWM6IHouYm9vbGVhbigpLm9wdGlvbmFsKCksXG4gIHJlcXVpcmVzQXBwcm92YWw6IHouYm9vbGVhbigpLm9wdGlvbmFsKCksXG59KTtcblxuY29uc3QgdXBkYXRlVGVhbVNjaGVtYSA9IGNyZWF0ZVRlYW1TY2hlbWEucGFydGlhbCgpO1xuXG5jb25zdCBpbnZpdGVNZW1iZXJTY2hlbWEgPSB6Lm9iamVjdCh7XG4gIGVtYWlsOiB6LnN0cmluZygpLmVtYWlsKCksXG4gIG1lc3NhZ2U6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgcm9sZTogei5lbnVtKFsnQURNSU4nLCAnTUVNQkVSJywgJ1ZJRVdFUiddKS5vcHRpb25hbCgpLFxufSk7XG5cbmNvbnN0IHJlc3BvbmRUb0ludml0YXRpb25TY2hlbWEgPSB6Lm9iamVjdCh7XG4gIHJlc3BvbnNlOiB6LmVudW0oWydhY2NlcHQnLCAnZGVjbGluZSddKSxcbn0pO1xuXG5leHBvcnQgZnVuY3Rpb24gdGVhbVJvdXRlcyhwcmlzbWE6IFByaXNtYUNsaWVudCk6IFJvdXRlciB7XG4gIGNvbnN0IHJvdXRlciA9IFJvdXRlcigpO1xuXG4gIC8vIEFwcGx5IGF1dGhlbnRpY2F0aW9uIHRvIGFsbCByb3V0ZXNcbiAgcm91dGVyLnVzZShhdXRoZW50aWNhdGUpO1xuXG4gIC8vIEdldCBhbGwgdGVhbXMgZm9yIHRoZSBjdXJyZW50IHVzZXJcbiAgcm91dGVyLmdldCgnLycsIGFzeW5jSGFuZGxlcihhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuaWQ7XG5cbiAgICBjb25zdCB0ZWFtcyA9IGF3YWl0IHByaXNtYS50ZWFtLmZpbmRNYW55KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIE9SOiBbXG4gICAgICAgICAgeyBvd25lcklkOiB1c2VySWQgfSxcbiAgICAgICAgICB7IG1lbWJlcnM6IHsgc29tZTogeyB1c2VySWQgfSB9IH0sXG4gICAgICAgIF0sXG4gICAgICB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBvd25lcjoge1xuICAgICAgICAgIHNlbGVjdDogeyBpZDogdHJ1ZSwgbmFtZTogdHJ1ZSwgZW1haWw6IHRydWUgfSxcbiAgICAgICAgfSxcbiAgICAgICAgX2NvdW50OiB7XG4gICAgICAgICAgc2VsZWN0OiB7IG1lbWJlcnM6IHRydWUgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gICAgfSk7XG5cbiAgICByZXMuanNvbih0ZWFtcyk7XG4gIH0pKTtcblxuICAvLyBHZXQgcHVibGljIHRlYW1zIChmb3IgZGlzY292ZXJ5KVxuICByb3V0ZXIuZ2V0KCcvcHVibGljJywgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICAgIGNvbnN0IHsgZ3JhZGUsIHN1YmplY3QsIHNlYXJjaCB9ID0gcmVxLnF1ZXJ5O1xuXG4gICAgY29uc3QgdGVhbXMgPSBhd2FpdCBwcmlzbWEudGVhbS5maW5kTWFueSh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBpc1B1YmxpYzogdHJ1ZSxcbiAgICAgICAgLi4uKGdyYWRlICYmIHsgZ3JhZGU6IHBhcnNlSW50KGdyYWRlIGFzIHN0cmluZykgfSksXG4gICAgICAgIC4uLihzdWJqZWN0ICYmIHsgc3ViamVjdDogc3ViamVjdCBhcyBzdHJpbmcgfSksXG4gICAgICAgIC4uLihzZWFyY2ggJiYge1xuICAgICAgICAgIE9SOiBbXG4gICAgICAgICAgICB7IG5hbWU6IHsgY29udGFpbnM6IHNlYXJjaCBhcyBzdHJpbmcgfSB9LFxuICAgICAgICAgICAgeyBkZXNjcmlwdGlvbjogeyBjb250YWluczogc2VhcmNoIGFzIHN0cmluZyB9IH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgfSksXG4gICAgICB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBvd25lcjoge1xuICAgICAgICAgIHNlbGVjdDogeyBpZDogdHJ1ZSwgbmFtZTogdHJ1ZSB9LFxuICAgICAgICB9LFxuICAgICAgICBfY291bnQ6IHtcbiAgICAgICAgICBzZWxlY3Q6IHsgbWVtYmVyczogdHJ1ZSB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIG9yZGVyQnk6IHsgY3JlYXRlZEF0OiAnZGVzYycgfSxcbiAgICAgIHRha2U6IDUwLFxuICAgIH0pO1xuXG4gICAgcmVzLmpzb24odGVhbXMpO1xuICB9KSk7XG5cbiAgLy8gR2V0IHRlYW0gYnkgSURcbiAgcm91dGVyLmdldCgnLzp0ZWFtSWQnLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgY29uc3QgeyB0ZWFtSWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLmlkO1xuXG4gICAgY29uc3QgdGVhbSA9IGF3YWl0IHByaXNtYS50ZWFtLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHRlYW1JZCB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBvd25lcjoge1xuICAgICAgICAgIHNlbGVjdDogeyBpZDogdHJ1ZSwgbmFtZTogdHJ1ZSwgZW1haWw6IHRydWUgfSxcbiAgICAgICAgfSxcbiAgICAgICAgbWVtYmVyczoge1xuICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlLCBuYW1lOiB0cnVlLCBlbWFpbDogdHJ1ZSB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIG9yZGVyQnk6IHsgam9pbmVkQXQ6ICdhc2MnIH0sXG4gICAgICAgIH0sXG4gICAgICAgIF9jb3VudDoge1xuICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgbWVtYmVyczogdHJ1ZSxcbiAgICAgICAgICAgIHNoYXJlZFJlc291cmNlczogdHJ1ZSxcbiAgICAgICAgICAgIGRpc2N1c3Npb25zOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCF0ZWFtKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBlcnJvcjogJ1RlYW0gbm90IGZvdW5kJyB9KTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiB1c2VyIGhhcyBhY2Nlc3NcbiAgICBjb25zdCBpc01lbWJlciA9IHRlYW0ub3duZXJJZCA9PT0gdXNlcklkIHx8IFxuICAgICAgdGVhbS5tZW1iZXJzLnNvbWUobSA9PiBtLnVzZXJJZCA9PT0gdXNlcklkKTtcblxuICAgIGlmICghaXNNZW1iZXIgJiYgIXRlYW0uaXNQdWJsaWMgJiYgIXRlYW0uYWxsb3dHdWVzdHMpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnQWNjZXNzIGRlbmllZCcgfSk7XG4gICAgfVxuXG4gICAgcmVzLmpzb24odGVhbSk7XG4gIH0pKTtcblxuICAvLyBDcmVhdGUgYSBuZXcgdGVhbVxuICByb3V0ZXIucG9zdCgnLycsIGFzeW5jSGFuZGxlcihhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuaWQ7XG4gICAgY29uc3QgZGF0YSA9IGNyZWF0ZVRlYW1TY2hlbWEucGFyc2UocmVxLmJvZHkpO1xuXG4gICAgY29uc3QgdGVhbSA9IGF3YWl0IHByaXNtYS50ZWFtLmNyZWF0ZSh7XG4gICAgICBkYXRhOiB7XG4gICAgICAgIG5hbWU6IGRhdGEubmFtZSxcbiAgICAgICAgZGVzY3JpcHRpb246IGRhdGEuZGVzY3JpcHRpb24sXG4gICAgICAgIGdyYWRlOiBkYXRhLmdyYWRlLFxuICAgICAgICBzdWJqZWN0OiBkYXRhLnN1YmplY3QsXG4gICAgICAgIHNjaG9vbE5hbWU6IGRhdGEuc2Nob29sTmFtZSxcbiAgICAgICAgc2Nob29sQm9hcmQ6IGRhdGEuc2Nob29sQm9hcmQsXG4gICAgICAgIGlzUHVibGljOiBkYXRhLmlzUHVibGljLFxuICAgICAgICByZXF1aXJlc0FwcHJvdmFsOiBkYXRhLnJlcXVpcmVzQXBwcm92YWwsXG4gICAgICAgIG93bmVyOiB7XG4gICAgICAgICAgY29ubmVjdDogeyBpZDogdXNlcklkIH0sXG4gICAgICAgIH0sXG4gICAgICAgIG1lbWJlcnM6IHtcbiAgICAgICAgICBjcmVhdGU6IHtcbiAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgIHJvbGU6IFRlYW1Sb2xlLk9XTkVSLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBvd25lcjoge1xuICAgICAgICAgIHNlbGVjdDogeyBpZDogdHJ1ZSwgbmFtZTogdHJ1ZSwgZW1haWw6IHRydWUgfSxcbiAgICAgICAgfSxcbiAgICAgICAgbWVtYmVyczoge1xuICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlLCBuYW1lOiB0cnVlLCBlbWFpbDogdHJ1ZSB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGxvZ2dlci5pbmZvKGBUZWFtIGNyZWF0ZWQ6ICR7dGVhbS5pZH0gYnkgdXNlciAke3VzZXJJZH1gKTtcbiAgICByZXMuc3RhdHVzKDIwMSkuanNvbih0ZWFtKTtcbiAgfSkpO1xuXG4gIC8vIFVwZGF0ZSB0ZWFtXG4gIHJvdXRlci5wYXRjaCgnLzp0ZWFtSWQnLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgY29uc3QgeyB0ZWFtSWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLmlkO1xuICAgIGNvbnN0IGRhdGEgPSB1cGRhdGVUZWFtU2NoZW1hLnBhcnNlKHJlcS5ib2R5KTtcblxuICAgIC8vIENoZWNrIGlmIHVzZXIgaXMgb3duZXIgb3IgYWRtaW5cbiAgICBjb25zdCBtZW1iZXIgPSBhd2FpdCBwcmlzbWEudGVhbU1lbWJlci5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IHRlYW1JZF91c2VySWQ6IHsgdGVhbUlkLCB1c2VySWQgfSB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFtZW1iZXIgfHwgKG1lbWJlci5yb2xlICE9PSBUZWFtUm9sZS5PV05FUiAmJiBtZW1iZXIucm9sZSAhPT0gVGVhbVJvbGUuQURNSU4pKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ09ubHkgdGVhbSBvd25lcnMgYW5kIGFkbWlucyBjYW4gdXBkYXRlIHRlYW0gc2V0dGluZ3MnIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHRlYW0gPSBhd2FpdCBwcmlzbWEudGVhbS51cGRhdGUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHRlYW1JZCB9LFxuICAgICAgZGF0YSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgb3duZXI6IHtcbiAgICAgICAgICBzZWxlY3Q6IHsgaWQ6IHRydWUsIG5hbWU6IHRydWUsIGVtYWlsOiB0cnVlIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgcmVzLmpzb24odGVhbSk7XG4gIH0pKTtcblxuICAvLyBEZWxldGUgdGVhbSAob3duZXIgb25seSlcbiAgcm91dGVyLmRlbGV0ZSgnLzp0ZWFtSWQnLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgY29uc3QgeyB0ZWFtSWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLmlkO1xuXG4gICAgY29uc3QgdGVhbSA9IGF3YWl0IHByaXNtYS50ZWFtLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHRlYW1JZCB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCF0ZWFtKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBlcnJvcjogJ1RlYW0gbm90IGZvdW5kJyB9KTtcbiAgICB9XG5cbiAgICBpZiAodGVhbS5vd25lcklkICE9PSB1c2VySWQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnT25seSB0aGUgdGVhbSBvd25lciBjYW4gZGVsZXRlIHRoZSB0ZWFtJyB9KTtcbiAgICB9XG5cbiAgICBhd2FpdCBwcmlzbWEudGVhbS5kZWxldGUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHRlYW1JZCB9LFxuICAgIH0pO1xuXG4gICAgbG9nZ2VyLmluZm8oYFRlYW0gZGVsZXRlZDogJHt0ZWFtSWR9IGJ5IHVzZXIgJHt1c2VySWR9YCk7XG4gICAgcmVzLnN0YXR1cygyMDQpLnNlbmQoKTtcbiAgfSkpO1xuXG4gIC8vIEludml0ZSBtZW1iZXIgdG8gdGVhbVxuICByb3V0ZXIucG9zdCgnLzp0ZWFtSWQvaW52aXRhdGlvbnMnLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgY29uc3QgeyB0ZWFtSWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLmlkO1xuICAgIGNvbnN0IHsgZW1haWwsIG1lc3NhZ2UsIHJvbGUgPSBUZWFtUm9sZS5NRU1CRVIgfSA9IGludml0ZU1lbWJlclNjaGVtYS5wYXJzZShyZXEuYm9keSk7XG5cbiAgICAvLyBDaGVjayBpZiB1c2VyIGNhbiBpbnZpdGUgKG93bmVyIG9yIGFkbWluKVxuICAgIGNvbnN0IG1lbWJlciA9IGF3YWl0IHByaXNtYS50ZWFtTWVtYmVyLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgdGVhbUlkX3VzZXJJZDogeyB0ZWFtSWQsIHVzZXJJZCB9IH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIW1lbWJlciB8fCAobWVtYmVyLnJvbGUgIT09IFRlYW1Sb2xlLk9XTkVSICYmIG1lbWJlci5yb2xlICE9PSBUZWFtUm9sZS5BRE1JTikpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnT25seSB0ZWFtIG93bmVycyBhbmQgYWRtaW5zIGNhbiBpbnZpdGUgbWVtYmVycycgfSk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgdXNlciBpcyBhbHJlYWR5IGEgbWVtYmVyXG4gICAgY29uc3QgZXhpc3RpbmdVc2VyID0gYXdhaXQgcHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBlbWFpbCB9LFxuICAgIH0pO1xuXG4gICAgaWYgKGV4aXN0aW5nVXNlcikge1xuICAgICAgY29uc3QgZXhpc3RpbmdNZW1iZXIgPSBhd2FpdCBwcmlzbWEudGVhbU1lbWJlci5maW5kVW5pcXVlKHtcbiAgICAgICAgd2hlcmU6IHsgdGVhbUlkX3VzZXJJZDogeyB0ZWFtSWQsIHVzZXJJZDogZXhpc3RpbmdVc2VyLmlkIH0gfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoZXhpc3RpbmdNZW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA5KS5qc29uKHsgZXJyb3I6ICdVc2VyIGlzIGFscmVhZHkgYSB0ZWFtIG1lbWJlcicgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgZm9yIGV4aXN0aW5nIHBlbmRpbmcgaW52aXRhdGlvblxuICAgIGNvbnN0IGV4aXN0aW5nSW52aXRhdGlvbiA9IGF3YWl0IHByaXNtYS50ZWFtSW52aXRhdGlvbi5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IHRlYW1JZF9lbWFpbDogeyB0ZWFtSWQsIGVtYWlsIH0gfSxcbiAgICB9KTtcblxuICAgIGlmIChleGlzdGluZ0ludml0YXRpb24gJiYgZXhpc3RpbmdJbnZpdGF0aW9uLnN0YXR1cyA9PT0gSW52aXRhdGlvblN0YXR1cy5QRU5ESU5HKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDkpLmpzb24oeyBlcnJvcjogJ0FuIGludml0YXRpb24gaXMgYWxyZWFkeSBwZW5kaW5nIGZvciB0aGlzIGVtYWlsJyB9KTtcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgaW52aXRhdGlvblxuICAgIGNvbnN0IGludml0YXRpb24gPSBhd2FpdCBwcmlzbWEudGVhbUludml0YXRpb24uY3JlYXRlKHtcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgdGVhbUlkLFxuICAgICAgICBlbWFpbCxcbiAgICAgICAgaW52aXRlZEJ5SWQ6IHVzZXJJZCxcbiAgICAgICAgaW52aXRlZFVzZXJJZDogZXhpc3RpbmdVc2VyPy5pZCxcbiAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgcm9sZSxcbiAgICAgICAgZXhwaXJlc0F0OiBhZGREYXlzKG5ldyBEYXRlKCksIDcpLCAvLyA3IGRheSBleHBpcmF0aW9uXG4gICAgICB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICB0ZWFtOiB7XG4gICAgICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlLCBuYW1lOiB0cnVlIH0sXG4gICAgICAgIH0sXG4gICAgICAgIGludml0ZWRCeToge1xuICAgICAgICAgIHNlbGVjdDogeyBpZDogdHJ1ZSwgbmFtZTogdHJ1ZSwgZW1haWw6IHRydWUgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBUT0RPOiBTZW5kIGVtYWlsIG5vdGlmaWNhdGlvblxuXG4gICAgcmVzLnN0YXR1cygyMDEpLmpzb24oaW52aXRhdGlvbik7XG4gIH0pKTtcblxuICAvLyBHZXQgdGVhbSBpbnZpdGF0aW9uc1xuICByb3V0ZXIuZ2V0KCcvOnRlYW1JZC9pbnZpdGF0aW9ucycsIGFzeW5jSGFuZGxlcihhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICBjb25zdCB7IHRlYW1JZCB9ID0gcmVxLnBhcmFtcztcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuaWQ7XG5cbiAgICAvLyBDaGVjayBpZiB1c2VyIGlzIG1lbWJlclxuICAgIGNvbnN0IG1lbWJlciA9IGF3YWl0IHByaXNtYS50ZWFtTWVtYmVyLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgdGVhbUlkX3VzZXJJZDogeyB0ZWFtSWQsIHVzZXJJZCB9IH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIW1lbWJlcikge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgZXJyb3I6ICdBY2Nlc3MgZGVuaWVkJyB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBpbnZpdGF0aW9ucyA9IGF3YWl0IHByaXNtYS50ZWFtSW52aXRhdGlvbi5maW5kTWFueSh7XG4gICAgICB3aGVyZToge1xuICAgICAgICB0ZWFtSWQsXG4gICAgICAgIHN0YXR1czogSW52aXRhdGlvblN0YXR1cy5QRU5ESU5HLFxuICAgICAgICBleHBpcmVzQXQ6IHsgZ3Q6IG5ldyBEYXRlKCkgfSxcbiAgICAgIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIGludml0ZWRCeToge1xuICAgICAgICAgIHNlbGVjdDogeyBpZDogdHJ1ZSwgbmFtZTogdHJ1ZSwgZW1haWw6IHRydWUgfSxcbiAgICAgICAgfSxcbiAgICAgICAgaW52aXRlZFVzZXI6IHtcbiAgICAgICAgICBzZWxlY3Q6IHsgaWQ6IHRydWUsIG5hbWU6IHRydWUsIGVtYWlsOiB0cnVlIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgb3JkZXJCeTogeyBjcmVhdGVkQXQ6ICdkZXNjJyB9LFxuICAgIH0pO1xuXG4gICAgcmVzLmpzb24oaW52aXRhdGlvbnMpO1xuICB9KSk7XG5cbiAgLy8gR2V0IHVzZXIncyBwZW5kaW5nIGludml0YXRpb25zXG4gIHJvdXRlci5nZXQoJy9pbnZpdGF0aW9ucy9teScsIGFzeW5jSGFuZGxlcihhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuaWQ7XG4gICAgY29uc3QgdXNlckVtYWlsID0gcmVxLnVzZXIhLmVtYWlsO1xuXG4gICAgY29uc3QgaW52aXRhdGlvbnMgPSBhd2FpdCBwcmlzbWEudGVhbUludml0YXRpb24uZmluZE1hbnkoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgT1I6IFtcbiAgICAgICAgICB7IGludml0ZWRVc2VySWQ6IHVzZXJJZCB9LFxuICAgICAgICAgIHsgZW1haWw6IHVzZXJFbWFpbCB9LFxuICAgICAgICBdLFxuICAgICAgICBzdGF0dXM6IEludml0YXRpb25TdGF0dXMuUEVORElORyxcbiAgICAgICAgZXhwaXJlc0F0OiB7IGd0OiBuZXcgRGF0ZSgpIH0sXG4gICAgICB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICB0ZWFtOiB7XG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgb3duZXI6IHtcbiAgICAgICAgICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlLCBuYW1lOiB0cnVlIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgX2NvdW50OiB7XG4gICAgICAgICAgICAgIHNlbGVjdDogeyBtZW1iZXJzOiB0cnVlIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIGludml0ZWRCeToge1xuICAgICAgICAgIHNlbGVjdDogeyBpZDogdHJ1ZSwgbmFtZTogdHJ1ZSwgZW1haWw6IHRydWUgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gICAgfSk7XG5cbiAgICByZXMuanNvbihpbnZpdGF0aW9ucyk7XG4gIH0pKTtcblxuICAvLyBSZXNwb25kIHRvIGludml0YXRpb25cbiAgcm91dGVyLnBvc3QoJy9pbnZpdGF0aW9ucy86aW52aXRhdGlvbklkL3Jlc3BvbmQnLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgY29uc3QgeyBpbnZpdGF0aW9uSWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLmlkO1xuICAgIGNvbnN0IHVzZXJFbWFpbCA9IHJlcS51c2VyIS5lbWFpbDtcbiAgICBjb25zdCB7IHJlc3BvbnNlIH0gPSByZXNwb25kVG9JbnZpdGF0aW9uU2NoZW1hLnBhcnNlKHJlcS5ib2R5KTtcblxuICAgIGNvbnN0IGludml0YXRpb24gPSBhd2FpdCBwcmlzbWEudGVhbUludml0YXRpb24uZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBpZDogaW52aXRhdGlvbklkIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIWludml0YXRpb24pIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IGVycm9yOiAnSW52aXRhdGlvbiBub3QgZm91bmQnIH0pO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIGludml0YXRpb24gaXMgZm9yIHRoaXMgdXNlclxuICAgIGlmIChpbnZpdGF0aW9uLmludml0ZWRVc2VySWQgIT09IHVzZXJJZCAmJiBpbnZpdGF0aW9uLmVtYWlsICE9PSB1c2VyRW1haWwpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnVGhpcyBpbnZpdGF0aW9uIGlzIG5vdCBmb3IgeW91JyB9KTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiBpbnZpdGF0aW9uIGlzIHN0aWxsIHZhbGlkXG4gICAgaWYgKGludml0YXRpb24uc3RhdHVzICE9PSBJbnZpdGF0aW9uU3RhdHVzLlBFTkRJTkcpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwOSkuanNvbih7IGVycm9yOiAnSW52aXRhdGlvbiBoYXMgYWxyZWFkeSBiZWVuIHJlc3BvbmRlZCB0bycgfSk7XG4gICAgfVxuXG4gICAgaWYgKG5ldyBEYXRlKCkgPiBpbnZpdGF0aW9uLmV4cGlyZXNBdCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA5KS5qc29uKHsgZXJyb3I6ICdJbnZpdGF0aW9uIGhhcyBleHBpcmVkJyB9KTtcbiAgICB9XG5cbiAgICBpZiAocmVzcG9uc2UgPT09ICdhY2NlcHQnKSB7XG4gICAgICAvLyBDcmVhdGUgdGVhbSBtZW1iZXJzaGlwXG4gICAgICBhd2FpdCBwcmlzbWEuJHRyYW5zYWN0aW9uKGFzeW5jICh0eCkgPT4ge1xuICAgICAgICAvLyBVcGRhdGUgaW52aXRhdGlvblxuICAgICAgICBhd2FpdCB0eC50ZWFtSW52aXRhdGlvbi51cGRhdGUoe1xuICAgICAgICAgIHdoZXJlOiB7IGlkOiBpbnZpdGF0aW9uSWQgfSxcbiAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICBzdGF0dXM6IEludml0YXRpb25TdGF0dXMuQUNDRVBURUQsXG4gICAgICAgICAgICByZXNwb25kZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBDcmVhdGUgbWVtYmVyc2hpcFxuICAgICAgICBhd2FpdCB0eC50ZWFtTWVtYmVyLmNyZWF0ZSh7XG4gICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgdGVhbUlkOiBpbnZpdGF0aW9uLnRlYW1JZCxcbiAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgIHJvbGU6IGludml0YXRpb24ucm9sZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgICBsb2dnZXIuaW5mbyhgVXNlciAke3VzZXJJZH0gYWNjZXB0ZWQgaW52aXRhdGlvbiB0byB0ZWFtICR7aW52aXRhdGlvbi50ZWFtSWR9YCk7XG4gICAgICByZXMuanNvbih7IG1lc3NhZ2U6ICdJbnZpdGF0aW9uIGFjY2VwdGVkIHN1Y2Nlc3NmdWxseScgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIERlY2xpbmUgaW52aXRhdGlvblxuICAgICAgYXdhaXQgcHJpc21hLnRlYW1JbnZpdGF0aW9uLnVwZGF0ZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkOiBpbnZpdGF0aW9uSWQgfSxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIHN0YXR1czogSW52aXRhdGlvblN0YXR1cy5ERUNMSU5FRCxcbiAgICAgICAgICByZXNwb25kZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICByZXMuanNvbih7IG1lc3NhZ2U6ICdJbnZpdGF0aW9uIGRlY2xpbmVkJyB9KTtcbiAgICB9XG4gIH0pKTtcblxuICAvLyBMZWF2ZSB0ZWFtXG4gIHJvdXRlci5wb3N0KCcvOnRlYW1JZC9sZWF2ZScsIGFzeW5jSGFuZGxlcihhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICBjb25zdCB7IHRlYW1JZCB9ID0gcmVxLnBhcmFtcztcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuaWQ7XG5cbiAgICBjb25zdCBtZW1iZXIgPSBhd2FpdCBwcmlzbWEudGVhbU1lbWJlci5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IHRlYW1JZF91c2VySWQ6IHsgdGVhbUlkLCB1c2VySWQgfSB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFtZW1iZXIpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IGVycm9yOiAnWW91IGFyZSBub3QgYSBtZW1iZXIgb2YgdGhpcyB0ZWFtJyB9KTtcbiAgICB9XG5cbiAgICBpZiAobWVtYmVyLnJvbGUgPT09IFRlYW1Sb2xlLk9XTkVSKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ1RlYW0gb3duZXIgY2Fubm90IGxlYXZlIHRoZSB0ZWFtLiBUcmFuc2ZlciBvd25lcnNoaXAgb3IgZGVsZXRlIHRoZSB0ZWFtLicgfSk7XG4gICAgfVxuXG4gICAgYXdhaXQgcHJpc21hLnRlYW1NZW1iZXIuZGVsZXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiBtZW1iZXIuaWQgfSxcbiAgICB9KTtcblxuICAgIGxvZ2dlci5pbmZvKGBVc2VyICR7dXNlcklkfSBsZWZ0IHRlYW0gJHt0ZWFtSWR9YCk7XG4gICAgcmVzLmpzb24oeyBtZXNzYWdlOiAnU3VjY2Vzc2Z1bGx5IGxlZnQgdGhlIHRlYW0nIH0pO1xuICB9KSk7XG5cbiAgLy8gVXBkYXRlIG1lbWJlciByb2xlXG4gIHJvdXRlci5wYXRjaCgnLzp0ZWFtSWQvbWVtYmVycy86bWVtYmVySWQnLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgY29uc3QgeyB0ZWFtSWQsIG1lbWJlcklkIH0gPSByZXEucGFyYW1zO1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyIS5pZDtcbiAgICBjb25zdCB7IHJvbGUgfSA9IHoub2JqZWN0KHsgcm9sZTogei5lbnVtKFsnQURNSU4nLCAnTUVNQkVSJywgJ1ZJRVdFUiddKSB9KS5wYXJzZShyZXEuYm9keSk7XG5cbiAgICAvLyBDaGVjayBpZiB1c2VyIGlzIG93bmVyXG4gICAgY29uc3QgdGVhbSA9IGF3YWl0IHByaXNtYS50ZWFtLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHRlYW1JZCB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCF0ZWFtIHx8IHRlYW0ub3duZXJJZCAhPT0gdXNlcklkKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ09ubHkgdGhlIHRlYW0gb3duZXIgY2FuIGNoYW5nZSBtZW1iZXIgcm9sZXMnIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IG1lbWJlciA9IGF3YWl0IHByaXNtYS50ZWFtTWVtYmVyLmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZTogeyBpZDogbWVtYmVySWQsIHRlYW1JZCB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFtZW1iZXIpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IGVycm9yOiAnTWVtYmVyIG5vdCBmb3VuZCcgfSk7XG4gICAgfVxuXG4gICAgaWYgKG1lbWJlci5yb2xlID09PSBUZWFtUm9sZS5PV05FUikge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgZXJyb3I6ICdDYW5ub3QgY2hhbmdlIG93bmVyIHJvbGUnIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHVwZGF0ZWRNZW1iZXIgPSBhd2FpdCBwcmlzbWEudGVhbU1lbWJlci51cGRhdGUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IG1lbWJlcklkIH0sXG4gICAgICBkYXRhOiB7IHJvbGUgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgdXNlcjoge1xuICAgICAgICAgIHNlbGVjdDogeyBpZDogdHJ1ZSwgbmFtZTogdHJ1ZSwgZW1haWw6IHRydWUgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICByZXMuanNvbih1cGRhdGVkTWVtYmVyKTtcbiAgfSkpO1xuXG4gIC8vIFJlbW92ZSBtZW1iZXIgZnJvbSB0ZWFtXG4gIHJvdXRlci5kZWxldGUoJy86dGVhbUlkL21lbWJlcnMvOm1lbWJlcklkJywgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICAgIGNvbnN0IHsgdGVhbUlkLCBtZW1iZXJJZCB9ID0gcmVxLnBhcmFtcztcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuaWQ7XG5cbiAgICAvLyBDaGVjayBpZiB1c2VyIGlzIG93bmVyIG9yIGFkbWluXG4gICAgY29uc3QgY3VycmVudE1lbWJlciA9IGF3YWl0IHByaXNtYS50ZWFtTWVtYmVyLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgdGVhbUlkX3VzZXJJZDogeyB0ZWFtSWQsIHVzZXJJZCB9IH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIWN1cnJlbnRNZW1iZXIgfHwgKGN1cnJlbnRNZW1iZXIucm9sZSAhPT0gVGVhbVJvbGUuT1dORVIgJiYgY3VycmVudE1lbWJlci5yb2xlICE9PSBUZWFtUm9sZS5BRE1JTikpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnT25seSB0ZWFtIG93bmVycyBhbmQgYWRtaW5zIGNhbiByZW1vdmUgbWVtYmVycycgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgbWVtYmVyVG9SZW1vdmUgPSBhd2FpdCBwcmlzbWEudGVhbU1lbWJlci5maW5kRmlyc3Qoe1xuICAgICAgd2hlcmU6IHsgaWQ6IG1lbWJlcklkLCB0ZWFtSWQgfSxcbiAgICB9KTtcblxuICAgIGlmICghbWVtYmVyVG9SZW1vdmUpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IGVycm9yOiAnTWVtYmVyIG5vdCBmb3VuZCcgfSk7XG4gICAgfVxuXG4gICAgaWYgKG1lbWJlclRvUmVtb3ZlLnJvbGUgPT09IFRlYW1Sb2xlLk9XTkVSKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ0Nhbm5vdCByZW1vdmUgdGVhbSBvd25lcicgfSk7XG4gICAgfVxuXG4gICAgYXdhaXQgcHJpc21hLnRlYW1NZW1iZXIuZGVsZXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiBtZW1iZXJJZCB9LFxuICAgIH0pO1xuXG4gICAgbG9nZ2VyLmluZm8oYE1lbWJlciAke21lbWJlclRvUmVtb3ZlLnVzZXJJZH0gcmVtb3ZlZCBmcm9tIHRlYW0gJHt0ZWFtSWR9IGJ5IHVzZXIgJHt1c2VySWR9YCk7XG4gICAgcmVzLnN0YXR1cygyMDQpLnNlbmQoKTtcbiAgfSkpO1xuXG4gIHJldHVybiByb3V0ZXI7XG59Il0sInZlcnNpb24iOjN9