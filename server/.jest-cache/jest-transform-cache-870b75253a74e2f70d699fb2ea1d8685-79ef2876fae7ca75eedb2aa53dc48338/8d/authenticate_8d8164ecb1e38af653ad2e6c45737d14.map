{"version":3,"names":["jwt","logger","authenticate","req","res","next","cov_1gcg8x6e85","f","s","token","cookies","authToken","process","env","NODE_ENV","b","debug","hasCookies","hasAuthToken","authHeader","headers","url","startsWith","split","status","json","error","length","secret","JWT_SECRET","decoded","verify","algorithms","maxAge","userId","email","iat","now","Math","floor","Date","user","id","Number","err","TokenExpiredError","JsonWebTokenError"],"sources":["/Users/michaelmcisaac/GitHub/teaching-engine2.0/server/src/middleware/authenticate.ts"],"sourcesContent":["/**\n * Authentication Middleware\n * Extracts and validates JWT tokens from requests\n */\n\nimport { Request, Response, NextFunction } from 'express';\nimport jwt, { JwtPayload } from 'jsonwebtoken';\nimport logger from '@/logger';\n\n// Express Request type is extended in types/express.d.ts\n\nexport function authenticate(req: Request, res: Response, next: NextFunction): void {\n  try {\n    // First try to get token from httpOnly cookie\n    let token = req.cookies?.authToken;\n\n    // Debug logging (temporary)\n    if (process.env.NODE_ENV === 'development') {\n      logger.debug('Auth Debug:', {\n        hasCookies: !!req.cookies,\n        hasAuthToken: !!req.cookies?.authToken,\n        authHeader: req.headers['authorization'] ? 'present' : 'missing',\n        url: req.url,\n      });\n    }\n\n    // Fallback to Authorization header for backward compatibility\n    if (!token) {\n      const authHeader = req.headers['authorization'];\n      if (authHeader && authHeader.startsWith('Bearer ')) {\n        token = authHeader.split(' ')[1];\n      }\n    }\n\n    if (!token) {\n      res.status(401).json({ error: 'Authentication required' });\n      return;\n    }\n\n    if (token.length > 1000) {\n      // Prevent extremely long tokens\n      res.status(401).json({ error: 'Invalid token format' });\n      return;\n    }\n\n    const secret = process.env.JWT_SECRET;\n    if (!secret) {\n      logger.error('CRITICAL: JWT_SECRET environment variable not configured');\n      res.status(500).json({ error: 'Server configuration error' });\n      return;\n    }\n\n    const decoded = jwt.verify(token, secret, {\n      algorithms: ['HS256'], // Explicitly specify allowed algorithms\n      maxAge: '7d', // Maximum token age\n    }) as JwtPayload;\n\n    if (!decoded?.userId || !decoded?.email || !decoded?.iat) {\n      res.status(403).json({ error: 'Invalid token payload' });\n      return;\n    }\n\n    // Check token age (extra protection)\n    const now = Math.floor(Date.now() / 1000);\n    const maxAge = 7 * 24 * 60 * 60; // 7 days in seconds\n    if (now - decoded.iat > maxAge) {\n      res.status(403).json({ error: 'Token expired' });\n      return;\n    }\n\n    // Attach user information to request\n    req.user = {\n      id: Number(decoded.userId),\n      userId: decoded.userId,\n      email: decoded.email,\n    };\n\n    next();\n  } catch (err) {\n    if (err instanceof jwt.TokenExpiredError) {\n      res.status(403).json({ error: 'Token expired' });\n    } else if (err instanceof jwt.JsonWebTokenError) {\n      res.status(403).json({ error: 'Invalid token' });\n    } else {\n      logger.error('JWT verification error:', err);\n      res.status(403).json({ error: 'Token verification failed' });\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}