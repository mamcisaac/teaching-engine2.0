936b3ea9a8a8731cb46e7be7f6d2b37a
import { Router } from 'express';
import { workflowStateService, ETFOLevel } from '../services/workflowStateService';
const router = Router();
/**
 * GET /api/workflow/state
 * Get the current workflow state for the authenticated user
 */
router.get('/state', async (req, res) => {
    try {
        if (!req.user?.id) {
            return res.status(401).json({ error: 'User not authenticated' });
        }
        const userId = req.user.id;
        const workflowState = await workflowStateService.getUserWorkflowState(userId);
        res.json(workflowState);
    }
    catch (error) {
        console.error('Error fetching workflow state:', error);
        res.status(500).json({ error: 'Failed to fetch workflow state' });
    }
});
/**
 * GET /api/workflow/access/:level
 * Check if user can access a specific level
 */
router.get('/access/:level', async (req, res) => {
    try {
        if (!req.user?.id) {
            return res.status(401).json({ error: 'User not authenticated' });
        }
        const userId = req.user.id;
        const level = req.params.level.toUpperCase();
        if (!Object.values(ETFOLevel).includes(level)) {
            return res.status(400).json({ error: 'Invalid level' });
        }
        const access = await workflowStateService.canAccessLevel(userId, level);
        res.json(access);
    }
    catch (error) {
        console.error('Error checking level access:', error);
        res.status(500).json({ error: 'Failed to check level access' });
    }
});
/**
 * POST /api/workflow/validate
 * Validate that an entity has all required fields for its level
 */
router.post('/validate', async (req, res) => {
    try {
        if (!req.user?.id) {
            return res.status(401).json({ error: 'User not authenticated' });
        }
        const { level, entityId } = req.body;
        if (!level || !entityId) {
            return res.status(400).json({ error: 'Missing required fields: level, entityId' });
        }
        const levelEnum = level.toUpperCase();
        if (!Object.values(ETFOLevel).includes(levelEnum)) {
            return res.status(400).json({ error: 'Invalid level' });
        }
        const userId = req.user.id;
        const validation = await workflowStateService.validateLevelCompletion(userId, levelEnum, entityId);
        res.json(validation);
    }
    catch (error) {
        console.error('Error validating level completion:', error);
        res.status(500).json({ error: 'Failed to validate level completion' });
    }
});
/**
 * GET /api/workflow/metadata
 * Get metadata for all workflow levels
 */
router.get('/metadata', async (req, res) => {
    try {
        const { ETFO_LEVEL_METADATA, ETFO_LEVEL_SEQUENCE } = await import('../services/workflowStateService');
        res.json({
            levels: ETFO_LEVEL_METADATA,
            sequence: ETFO_LEVEL_SEQUENCE,
        });
    }
    catch (error) {
        console.error('Error fetching workflow metadata:', error);
        res.status(500).json({ error: 'Failed to fetch workflow metadata' });
    }
});
export default router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9yb3V0ZXMvd29ya2Zsb3ctc3RhdGUudHMiLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBVyxNQUFNLFNBQVMsQ0FBQztBQUMxQyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsU0FBUyxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFFbkYsTUFBTSxNQUFNLEdBQUcsTUFBTSxFQUFFLENBQUM7QUFFeEI7OztHQUdHO0FBQ0gsTUFBTSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFHLEVBQUUsRUFBRTtJQUMvQyxJQUFJLENBQUM7UUFDSCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxFQUFFLEVBQUUsQ0FBQztZQUNsQixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLHdCQUF3QixFQUFFLENBQUMsQ0FBQztRQUNuRSxDQUFDO1FBRUQsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7UUFDM0IsTUFBTSxhQUFhLEdBQUcsTUFBTSxvQkFBb0IsQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUU5RSxHQUFHLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQzFCLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyxnQ0FBZ0MsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN2RCxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxnQ0FBZ0MsRUFBRSxDQUFDLENBQUM7SUFDcEUsQ0FBQztBQUNILENBQUMsQ0FBQyxDQUFDO0FBRUg7OztHQUdHO0FBQ0gsTUFBTSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQUcsRUFBRSxFQUFFO0lBQ3ZELElBQUksQ0FBQztRQUNILElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLEVBQUUsRUFBRSxDQUFDO1lBQ2xCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsd0JBQXdCLEVBQUUsQ0FBQyxDQUFDO1FBQ25FLENBQUM7UUFFRCxNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztRQUMzQixNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQWUsQ0FBQztRQUUxRCxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztZQUM5QyxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLGVBQWUsRUFBRSxDQUFDLENBQUM7UUFDMUQsQ0FBQztRQUVELE1BQU0sTUFBTSxHQUFHLE1BQU0sb0JBQW9CLENBQUMsY0FBYyxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN4RSxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ25CLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyw4QkFBOEIsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNyRCxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSw4QkFBOEIsRUFBRSxDQUFDLENBQUM7SUFDbEUsQ0FBQztBQUNILENBQUMsQ0FBQyxDQUFDO0FBRUg7OztHQUdHO0FBQ0gsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFHLEVBQUUsRUFBRTtJQUNuRCxJQUFJLENBQUM7UUFDSCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxFQUFFLEVBQUUsQ0FBQztZQUNsQixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLHdCQUF3QixFQUFFLENBQUMsQ0FBQztRQUNuRSxDQUFDO1FBRUQsTUFBTSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBRXJDLElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUN4QixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLDBDQUEwQyxFQUFFLENBQUMsQ0FBQztRQUNyRixDQUFDO1FBRUQsTUFBTSxTQUFTLEdBQUcsS0FBSyxDQUFDLFdBQVcsRUFBZSxDQUFDO1FBQ25ELElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDO1lBQ2xELE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsZUFBZSxFQUFFLENBQUMsQ0FBQztRQUMxRCxDQUFDO1FBRUQsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7UUFDM0IsTUFBTSxVQUFVLEdBQUcsTUFBTSxvQkFBb0IsQ0FBQyx1QkFBdUIsQ0FDbkUsTUFBTSxFQUNOLFNBQVMsRUFDVCxRQUFRLENBQ1QsQ0FBQztRQUVGLEdBQUcsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDdkIsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLG9DQUFvQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzNELEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLHFDQUFxQyxFQUFFLENBQUMsQ0FBQztJQUN6RSxDQUFDO0FBQ0gsQ0FBQyxDQUFDLENBQUM7QUFFSDs7O0dBR0c7QUFDSCxNQUFNLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQUcsRUFBRSxFQUFFO0lBQ2xELElBQUksQ0FBQztRQUNILE1BQU0sRUFBRSxtQkFBbUIsRUFBRSxtQkFBbUIsRUFBRSxHQUFHLE1BQU0sTUFBTSxDQUMvRCxrQ0FBa0MsQ0FDbkMsQ0FBQztRQUVGLEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFDUCxNQUFNLEVBQUUsbUJBQW1CO1lBQzNCLFFBQVEsRUFBRSxtQkFBbUI7U0FDOUIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLG1DQUFtQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzFELEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLG1DQUFtQyxFQUFFLENBQUMsQ0FBQztJQUN2RSxDQUFDO0FBQ0gsQ0FBQyxDQUFDLENBQUM7QUFFSCxlQUFlLE1BQU0sQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWljaGFlbG1jaXNhYWMvR2l0SHViL3RlYWNoaW5nLWVuZ2luZTIuMC9zZXJ2ZXIvc3JjL3JvdXRlcy93b3JrZmxvdy1zdGF0ZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSb3V0ZXIsIFJlcXVlc3QgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IHdvcmtmbG93U3RhdGVTZXJ2aWNlLCBFVEZPTGV2ZWwgfSBmcm9tICcuLi9zZXJ2aWNlcy93b3JrZmxvd1N0YXRlU2VydmljZSc7XG5cbmNvbnN0IHJvdXRlciA9IFJvdXRlcigpO1xuXG4vKipcbiAqIEdFVCAvYXBpL3dvcmtmbG93L3N0YXRlXG4gKiBHZXQgdGhlIGN1cnJlbnQgd29ya2Zsb3cgc3RhdGUgZm9yIHRoZSBhdXRoZW50aWNhdGVkIHVzZXJcbiAqL1xucm91dGVyLmdldCgnL3N0YXRlJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzKSA9PiB7XG4gIHRyeSB7XG4gICAgaWYgKCFyZXEudXNlcj8uaWQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAnVXNlciBub3QgYXV0aGVudGljYXRlZCcgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIuaWQ7XG4gICAgY29uc3Qgd29ya2Zsb3dTdGF0ZSA9IGF3YWl0IHdvcmtmbG93U3RhdGVTZXJ2aWNlLmdldFVzZXJXb3JrZmxvd1N0YXRlKHVzZXJJZCk7XG5cbiAgICByZXMuanNvbih3b3JrZmxvd1N0YXRlKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBmZXRjaGluZyB3b3JrZmxvdyBzdGF0ZTonLCBlcnJvcik7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0ZhaWxlZCB0byBmZXRjaCB3b3JrZmxvdyBzdGF0ZScgfSk7XG4gIH1cbn0pO1xuXG4vKipcbiAqIEdFVCAvYXBpL3dvcmtmbG93L2FjY2Vzcy86bGV2ZWxcbiAqIENoZWNrIGlmIHVzZXIgY2FuIGFjY2VzcyBhIHNwZWNpZmljIGxldmVsXG4gKi9cbnJvdXRlci5nZXQoJy9hY2Nlc3MvOmxldmVsJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzKSA9PiB7XG4gIHRyeSB7XG4gICAgaWYgKCFyZXEudXNlcj8uaWQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAnVXNlciBub3QgYXV0aGVudGljYXRlZCcgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIuaWQ7XG4gICAgY29uc3QgbGV2ZWwgPSByZXEucGFyYW1zLmxldmVsLnRvVXBwZXJDYXNlKCkgYXMgRVRGT0xldmVsO1xuXG4gICAgaWYgKCFPYmplY3QudmFsdWVzKEVURk9MZXZlbCkuaW5jbHVkZXMobGV2ZWwpKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ0ludmFsaWQgbGV2ZWwnIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGFjY2VzcyA9IGF3YWl0IHdvcmtmbG93U3RhdGVTZXJ2aWNlLmNhbkFjY2Vzc0xldmVsKHVzZXJJZCwgbGV2ZWwpO1xuICAgIHJlcy5qc29uKGFjY2Vzcyk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgY2hlY2tpbmcgbGV2ZWwgYWNjZXNzOicsIGVycm9yKTtcbiAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiAnRmFpbGVkIHRvIGNoZWNrIGxldmVsIGFjY2VzcycgfSk7XG4gIH1cbn0pO1xuXG4vKipcbiAqIFBPU1QgL2FwaS93b3JrZmxvdy92YWxpZGF0ZVxuICogVmFsaWRhdGUgdGhhdCBhbiBlbnRpdHkgaGFzIGFsbCByZXF1aXJlZCBmaWVsZHMgZm9yIGl0cyBsZXZlbFxuICovXG5yb3V0ZXIucG9zdCgnL3ZhbGlkYXRlJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzKSA9PiB7XG4gIHRyeSB7XG4gICAgaWYgKCFyZXEudXNlcj8uaWQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAnVXNlciBub3QgYXV0aGVudGljYXRlZCcgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgeyBsZXZlbCwgZW50aXR5SWQgfSA9IHJlcS5ib2R5O1xuXG4gICAgaWYgKCFsZXZlbCB8fCAhZW50aXR5SWQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiAnTWlzc2luZyByZXF1aXJlZCBmaWVsZHM6IGxldmVsLCBlbnRpdHlJZCcgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgbGV2ZWxFbnVtID0gbGV2ZWwudG9VcHBlckNhc2UoKSBhcyBFVEZPTGV2ZWw7XG4gICAgaWYgKCFPYmplY3QudmFsdWVzKEVURk9MZXZlbCkuaW5jbHVkZXMobGV2ZWxFbnVtKSkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgZXJyb3I6ICdJbnZhbGlkIGxldmVsJyB9KTtcbiAgICB9XG5cbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlci5pZDtcbiAgICBjb25zdCB2YWxpZGF0aW9uID0gYXdhaXQgd29ya2Zsb3dTdGF0ZVNlcnZpY2UudmFsaWRhdGVMZXZlbENvbXBsZXRpb24oXG4gICAgICB1c2VySWQsXG4gICAgICBsZXZlbEVudW0sXG4gICAgICBlbnRpdHlJZCxcbiAgICApO1xuXG4gICAgcmVzLmpzb24odmFsaWRhdGlvbik7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgdmFsaWRhdGluZyBsZXZlbCBjb21wbGV0aW9uOicsIGVycm9yKTtcbiAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiAnRmFpbGVkIHRvIHZhbGlkYXRlIGxldmVsIGNvbXBsZXRpb24nIH0pO1xuICB9XG59KTtcblxuLyoqXG4gKiBHRVQgL2FwaS93b3JrZmxvdy9tZXRhZGF0YVxuICogR2V0IG1ldGFkYXRhIGZvciBhbGwgd29ya2Zsb3cgbGV2ZWxzXG4gKi9cbnJvdXRlci5nZXQoJy9tZXRhZGF0YScsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlcykgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHsgRVRGT19MRVZFTF9NRVRBREFUQSwgRVRGT19MRVZFTF9TRVFVRU5DRSB9ID0gYXdhaXQgaW1wb3J0KFxuICAgICAgJy4uL3NlcnZpY2VzL3dvcmtmbG93U3RhdGVTZXJ2aWNlJ1xuICAgICk7XG5cbiAgICByZXMuanNvbih7XG4gICAgICBsZXZlbHM6IEVURk9fTEVWRUxfTUVUQURBVEEsXG4gICAgICBzZXF1ZW5jZTogRVRGT19MRVZFTF9TRVFVRU5DRSxcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBmZXRjaGluZyB3b3JrZmxvdyBtZXRhZGF0YTonLCBlcnJvcik7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0ZhaWxlZCB0byBmZXRjaCB3b3JrZmxvdyBtZXRhZGF0YScgfSk7XG4gIH1cbn0pO1xuXG5leHBvcnQgZGVmYXVsdCByb3V0ZXI7XG4iXSwidmVyc2lvbiI6M30=