84c6f7566b7db366d5b4b9d0e079a94d
import logger from '../logger';
// Store for request counts
const requestCounts = new Map();
// Cleanup old entries periodically
setInterval(() => {
    const now = Date.now();
    for (const [key, value] of requestCounts.entries()) {
        if (value.resetTime < now) {
            requestCounts.delete(key);
        }
    }
}, 60000); // Clean up every minute
export function createRateLimiter(options) {
    const { windowMs, max, keyGenerator = (req) => {
        // Default key: IP + user ID if authenticated
        const ip = req.ip || req.connection.remoteAddress || 'unknown';
        const userId = req.user?.userId || 'anonymous';
        return `${ip}-${userId}`;
    }, message = 'Too many requests, please try again later.', skipSuccessfulRequests = false, skipFailedRequests = false, } = options;
    return (req, res, next) => {
        const key = keyGenerator(req);
        const now = Date.now();
        // Get or create entry
        let entry = requestCounts.get(key);
        if (!entry || entry.resetTime < now) {
            entry = { count: 0, resetTime: now + windowMs };
            requestCounts.set(key, entry);
        }
        // Check if limit exceeded
        if (entry.count >= max) {
            const retryAfter = Math.ceil((entry.resetTime - now) / 1000);
            logger.warn({
                key,
                endpoint: req.path,
                method: req.method,
                count: entry.count,
                max,
            }, 'Rate limit exceeded');
            res.setHeader('Retry-After', retryAfter.toString());
            res.setHeader('X-RateLimit-Limit', max.toString());
            res.setHeader('X-RateLimit-Remaining', '0');
            res.setHeader('X-RateLimit-Reset', new Date(entry.resetTime).toISOString());
            return res.status(429).json({
                error: message,
                retryAfter,
            });
        }
        // Increment counter
        entry.count++;
        // Set headers
        res.setHeader('X-RateLimit-Limit', max.toString());
        res.setHeader('X-RateLimit-Remaining', Math.max(0, max - entry.count).toString());
        res.setHeader('X-RateLimit-Reset', new Date(entry.resetTime).toISOString());
        // Handle response to optionally skip counting
        if (skipSuccessfulRequests || skipFailedRequests) {
            const originalSend = res.send;
            res.send = function (data) {
                const shouldSkip = (skipSuccessfulRequests && res.statusCode < 400) ||
                    (skipFailedRequests && res.statusCode >= 400);
                if (shouldSkip && entry) {
                    entry.count = Math.max(0, entry.count - 1);
                }
                return originalSend.call(this, data);
            };
        }
        next();
    };
}
// Pre-configured rate limiters for different use cases
export const rateLimiters = {
    // Strict limit for authentication endpoints (relaxed in test mode)
    auth: createRateLimiter({
        windowMs: 15 * 60 * 1000, // 15 minutes
        max: process.env.NODE_ENV === 'test' ? 100 : 5, // Allow more requests in test mode
        message: 'Too many authentication attempts. Please try again later.',
        skipSuccessfulRequests: true, // Only count failed attempts
    }),
    // Standard API rate limit
    api: createRateLimiter({
        windowMs: 15 * 60 * 1000, // 15 minutes
        max: 100, // 100 requests per window
    }),
    // Relaxed limit for read operations
    read: createRateLimiter({
        windowMs: 15 * 60 * 1000, // 15 minutes
        max: 200, // 200 requests per window
    }),
    // Strict limit for write operations
    write: createRateLimiter({
        windowMs: 15 * 60 * 1000, // 15 minutes
        max: 50, // 50 requests per window
    }),
    // Very strict limit for AI operations
    ai: createRateLimiter({
        windowMs: 60 * 60 * 1000, // 1 hour
        max: 20, // 20 requests per hour
        message: 'AI generation limit exceeded. Please try again later.',
    }),
    // File upload limit
    upload: createRateLimiter({
        windowMs: 60 * 60 * 1000, // 1 hour
        max: 10, // 10 uploads per hour
        message: 'File upload limit exceeded. Please try again later.',
    }),
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9taWRkbGV3YXJlL3JhdGVMaW1pdGVyLnRzIiwibWFwcGluZ3MiOiJBQUNBLE9BQU8sTUFBTSxNQUFNLFdBQVcsQ0FBQztBQVcvQiwyQkFBMkI7QUFDM0IsTUFBTSxhQUFhLEdBQUcsSUFBSSxHQUFHLEVBQWdELENBQUM7QUFFOUUsbUNBQW1DO0FBQ25DLFdBQVcsQ0FBQyxHQUFHLEVBQUU7SUFDZixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDdkIsS0FBSyxNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxJQUFJLGFBQWEsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDO1FBQ25ELElBQUksS0FBSyxDQUFDLFNBQVMsR0FBRyxHQUFHLEVBQUUsQ0FBQztZQUMxQixhQUFhLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzVCLENBQUM7SUFDSCxDQUFDO0FBQ0gsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsd0JBQXdCO0FBRW5DLE1BQU0sVUFBVSxpQkFBaUIsQ0FBQyxPQUF5QjtJQUN6RCxNQUFNLEVBQ0osUUFBUSxFQUNSLEdBQUcsRUFDSCxZQUFZLEdBQUcsQ0FBQyxHQUFHLEVBQUUsRUFBRTtRQUNyQiw2Q0FBNkM7UUFDN0MsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDLEVBQUUsSUFBSSxHQUFHLENBQUMsVUFBVSxDQUFDLGFBQWEsSUFBSSxTQUFTLENBQUM7UUFDL0QsTUFBTSxNQUFNLEdBQUksR0FBZ0QsQ0FBQyxJQUFJLEVBQUUsTUFBTSxJQUFJLFdBQVcsQ0FBQztRQUM3RixPQUFPLEdBQUcsRUFBRSxJQUFJLE1BQU0sRUFBRSxDQUFDO0lBQzNCLENBQUMsRUFDRCxPQUFPLEdBQUcsNENBQTRDLEVBQ3RELHNCQUFzQixHQUFHLEtBQUssRUFDOUIsa0JBQWtCLEdBQUcsS0FBSyxHQUMzQixHQUFHLE9BQU8sQ0FBQztJ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QjtLQUNuQyxDQUFDO0lBRUYsc0NBQXNDO0lBQ3RDLEVBQUUsRUFBRSxpQkFBaUIsQ0FBQztRQUNwQixRQUFRLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLEVBQUUsU0FBUztRQUNuQyxHQUFHLEVBQUUsRUFBRSxFQUFFLHVCQUF1QjtRQUNoQyxPQUFPLEVBQUUsdURBQXVEO0tBQ2pFLENBQUM7SUFFRixvQkFBb0I7SUFDcEIsTUFBTSxFQUFFLGlCQUFpQixDQUFDO1FBQ3hCLFFBQVEsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksRUFBRSxTQUFTO1FBQ25DLEdBQUcsRUFBRSxFQUFFLEVBQUUsc0JBQXNCO1FBQy9CLE9BQU8sRUFBRSxxREFBcUQ7S0FDL0QsQ0FBQztDQUNILENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9taWRkbGV3YXJlL3JhdGVMaW1pdGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlcXVlc3QsIFJlc3BvbnNlLCBOZXh0RnVuY3Rpb24gfSBmcm9tICdleHByZXNzJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi4vbG9nZ2VyJztcblxuaW50ZXJmYWNlIFJhdGVMaW1pdE9wdGlvbnMge1xuICB3aW5kb3dNczogbnVtYmVyOyAvLyBUaW1lIHdpbmRvdyBpbiBtaWxsaXNlY29uZHNcbiAgbWF4OiBudW1iZXI7IC8vIE1heCByZXF1ZXN0cyBwZXIgd2luZG93XG4gIGtleUdlbmVyYXRvcj86IChyZXE6IFJlcXVlc3QpID0+IHN0cmluZzsgLy8gQ3VzdG9tIGtleSBnZW5lcmF0b3JcbiAgbWVzc2FnZT86IHN0cmluZzsgLy8gRXJyb3IgbWVzc2FnZVxuICBza2lwU3VjY2Vzc2Z1bFJlcXVlc3RzPzogYm9vbGVhbjsgLy8gRG9uJ3QgY291bnQgc3VjY2Vzc2Z1bCByZXF1ZXN0c1xuICBza2lwRmFpbGVkUmVxdWVzdHM/OiBib29sZWFuOyAvLyBEb24ndCBjb3VudCBmYWlsZWQgcmVxdWVzdHNcbn1cblxuLy8gU3RvcmUgZm9yIHJlcXVlc3QgY291bnRzXG5jb25zdCByZXF1ZXN0Q291bnRzID0gbmV3IE1hcDxzdHJpbmcsIHsgY291bnQ6IG51bWJlcjsgcmVzZXRUaW1lOiBudW1iZXIgfT4oKTtcblxuLy8gQ2xlYW51cCBvbGQgZW50cmllcyBwZXJpb2RpY2FsbHlcbnNldEludGVydmFsKCgpID0+IHtcbiAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgcmVxdWVzdENvdW50cy5lbnRyaWVzKCkpIHtcbiAgICBpZiAodmFsdWUucmVzZXRUaW1lIDwgbm93KSB7XG4gICAgICByZXF1ZXN0Q291bnRzLmRlbGV0ZShrZXkpO1xuICAgIH1cbiAgfVxufSwgNjAwMDApOyAvLyBDbGVhbiB1cCBldmVyeSBtaW51dGVcblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVJhdGVMaW1pdGVyKG9wdGlvbnM6IFJhdGVMaW1pdE9wdGlvbnMpIHtcbiAgY29uc3Qge1xuICAgIHdpbmRvd01zLFxuICAgIG1heCxcbiAgICBrZXlHZW5lcmF0b3IgPSAocmVxKSA9PiB7XG4gICAgICAvLyBEZWZhdWx0IGtleTogSVAgKyB1c2VyIElEIGlmIGF1dGhlbnRpY2F0ZWRcbiAgICAgIGNvbnN0IGlwID0gcmVxLmlwIHx8IHJlcS5jb25uZWN0aW9uLnJlbW90ZUFkZHJlc3MgfHwgJ3Vua25vd24nO1xuICAgICAgY29uc3QgdXNlcklkID0gKHJlcSBhcyBSZXF1ZXN0ICYgeyB1c2VyPzogeyB1c2VySWQ/OiBzdHJpbmcgfSB9KS51c2VyPy51c2VySWQgfHwgJ2Fub255bW91cyc7XG4gICAgICByZXR1cm4gYCR7aXB9LSR7dXNlcklkfWA7XG4gICAgfSxcbiAgICBtZXNzYWdlID0gJ1RvbyBtYW55IHJlcXVlc3RzLCBwbGVhc2UgdHJ5IGFnYWluIGxhdGVyLicsXG4gICAgc2tpcFN1Y2Nlc3NmdWxSZXF1ZXN0cyA9IGZhbHNlLFxuICAgIHNraXBGYWlsZWRSZXF1ZXN0cyA9IGZhbHNlLFxuICB9ID0gb3B0aW9ucztcblxuICByZXR1cm4gKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gICAgY29uc3Qga2V5ID0ga2V5R2VuZXJhdG9yKHJlcSk7XG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICBcbiAgICAvLyBHZXQgb3IgY3JlYXRlIGVudHJ5XG4gICAgbGV0IGVudHJ5ID0gcmVxdWVzdENvdW50cy5nZXQoa2V5KTtcbiAgICBpZiAoIWVudHJ5IHx8IGVudHJ5LnJlc2V0VGltZSA8IG5vdykge1xuICAgICAgZW50cnkgPSB7IGNvdW50OiAwLCByZXNldFRpbWU6IG5vdyArIHdpbmRvd01zIH07XG4gICAgICByZXF1ZXN0Q291bnRzLnNldChrZXksIGVudHJ5KTtcbiAgICB9XG4gICAgXG4gICAgLy8gQ2hlY2sgaWYgbGltaXQgZXhjZWVkZWRcbiAgICBpZiAoZW50cnkuY291bnQgPj0gbWF4KSB7XG4gICAgICBjb25zdCByZXRyeUFmdGVyID0gTWF0aC5jZWlsKChlbnRyeS5yZXNldFRpbWUgLSBub3cpIC8gMTAwMCk7XG4gICAgICBcbiAgICAgIGxvZ2dlci53YXJuKHtcbiAgICAgICAga2V5LFxuICAgICAgICBlbmRwb2ludDogcmVxLnBhdGgsXG4gICAgICAgIG1ldGhvZDogcmVxLm1ldGhvZCxcbiAgICAgICAgY291bnQ6IGVudHJ5LmNvdW50LFxuICAgICAgICBtYXgsXG4gICAgICB9LCAnUmF0ZSBsaW1pdCBleGNlZWRlZCcpO1xuICAgICAgXG4gICAgICByZXMuc2V0SGVhZGVyKCdSZXRyeS1BZnRlcicsIHJldHJ5QWZ0ZXIudG9TdHJpbmcoKSk7XG4gICAgICByZXMuc2V0SGVhZGVyKCdYLVJhdGVMaW1pdC1MaW1pdCcsIG1heC50b1N0cmluZygpKTtcbiAgICAgIHJlcy5zZXRIZWFkZXIoJ1gtUmF0ZUxpbWl0LVJlbWFpbmluZycsICcwJyk7XG4gICAgICByZXMuc2V0SGVhZGVyKCdYLVJhdGVMaW1pdC1SZXNldCcsIG5ldyBEYXRlKGVudHJ5LnJlc2V0VGltZSkudG9JU09TdHJpbmcoKSk7XG4gICAgICBcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQyOSkuanNvbih7XG4gICAgICAgIGVycm9yOiBtZXNzYWdlLFxuICAgICAgICByZXRyeUFmdGVyLFxuICAgICAgfSk7XG4gICAgfVxuICAgIFxuICAgIC8vIEluY3JlbWVudCBjb3VudGVyXG4gICAgZW50cnkuY291bnQrKztcbiAgICBcbiAgICAvLyBTZXQgaGVhZGVyc1xuICAgIHJlcy5zZXRIZWFkZXIoJ1gtUmF0ZUxpbWl0LUxpbWl0JywgbWF4LnRvU3RyaW5nKCkpO1xuICAgIHJlcy5zZXRIZWFkZXIoJ1gtUmF0ZUxpbWl0LVJlbWFpbmluZycsIE1hdGgubWF4KDAsIG1heCAtIGVudHJ5LmNvdW50KS50b1N0cmluZygpKTtcbiAgICByZXMuc2V0SGVhZGVyKCdYLVJhdGVMaW1pdC1SZXNldCcsIG5ldyBEYXRlKGVudHJ5LnJlc2V0VGltZSkudG9JU09TdHJpbmcoKSk7XG4gICAgXG4gICAgLy8gSGFuZGxlIHJlc3BvbnNlIHRvIG9wdGlvbmFsbHkgc2tpcCBjb3VudGluZ1xuICAgIGlmIChza2lwU3VjY2Vzc2Z1bFJlcXVlc3RzIHx8IHNraXBGYWlsZWRSZXF1ZXN0cykge1xuICAgICAgY29uc3Qgb3JpZ2luYWxTZW5kID0gcmVzLnNlbmQ7XG4gICAgICByZXMuc2VuZCA9IGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgY29uc3Qgc2hvdWxkU2tpcCA9IFxuICAgICAgICAgIChza2lwU3VjY2Vzc2Z1bFJlcXVlc3RzICYmIHJlcy5zdGF0dXNDb2RlIDwgNDAwKSB8fFxuICAgICAgICAgIChza2lwRmFpbGVkUmVxdWVzdHMgJiYgcmVzLnN0YXR1c0NvZGUgPj0gNDAwKTtcbiAgICAgICAgXG4gICAgICAgIGlmIChzaG91bGRTa2lwICYmIGVudHJ5KSB7XG4gICAgICAgICAgZW50cnkuY291bnQgPSBNYXRoLm1heCgwLCBlbnRyeS5jb3VudCAtIDEpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gb3JpZ2luYWxTZW5kLmNhbGwodGhpcywgZGF0YSk7XG4gICAgICB9O1xuICAgIH1cbiAgICBcbiAgICBuZXh0KCk7XG4gIH07XG59XG5cbi8vIFByZS1jb25maWd1cmVkIHJhdGUgbGltaXRlcnMgZm9yIGRpZmZlcmVudCB1c2UgY2FzZXNcbmV4cG9ydCBjb25zdCByYXRlTGltaXRlcnMgPSB7XG4gIC8vIFN0cmljdCBsaW1pdCBmb3IgYXV0aGVudGljYXRpb24gZW5kcG9pbnRzIChyZWxheGVkIGluIHRlc3QgbW9kZSlcbiAgYXV0aDogY3JlYXRlUmF0ZUxpbWl0ZXIoe1xuICAgIHdpbmRvd01zOiAxNSAqIDYwICogMTAwMCwgLy8gMTUgbWludXRlc1xuICAgIG1heDogcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICd0ZXN0JyA/IDEwMCA6IDUsIC8vIEFsbG93IG1vcmUgcmVxdWVzdHMgaW4gdGVzdCBtb2RlXG4gICAgbWVzc2FnZTogJ1RvbyBtYW55IGF1dGhlbnRpY2F0aW9uIGF0dGVtcHRzLiBQbGVhc2UgdHJ5IGFnYWluIGxhdGVyLicsXG4gICAgc2tpcFN1Y2Nlc3NmdWxSZXF1ZXN0czogdHJ1ZSwgLy8gT25seSBjb3VudCBmYWlsZWQgYXR0ZW1wdHNcbiAgfSksXG4gIFxuICAvLyBTdGFuZGFyZCBBUEkgcmF0ZSBsaW1pdFxuICBhcGk6IGNyZWF0ZVJhdGVMaW1pdGVyKHtcbiAgICB3aW5kb3dNczogMTUgKiA2MCAqIDEwMDAsIC8vIDE1IG1pbnV0ZXNcbiAgICBtYXg6IDEwMCwgLy8gMTAwIHJlcXVlc3RzIHBlciB3aW5kb3dcbiAgfSksXG4gIFxuICAvLyBSZWxheGVkIGxpbWl0IGZvciByZWFkIG9wZXJhdGlvbnNcbiAgcmVhZDogY3JlYXRlUmF0ZUxpbWl0ZXIoe1xuICAgIHdpbmRvd01zOiAxNSAqIDYwICogMTAwMCwgLy8gMTUgbWludXRlc1xuICAgIG1heDogMjAwLCAvLyAyMDAgcmVxdWVzdHMgcGVyIHdpbmRvd1xuICB9KSxcbiAgXG4gIC8vIFN0cmljdCBsaW1pdCBmb3Igd3JpdGUgb3BlcmF0aW9uc1xuICB3cml0ZTogY3JlYXRlUmF0ZUxpbWl0ZXIoe1xuICAgIHdpbmRvd01zOiAxNSAqIDYwICogMTAwMCwgLy8gMTUgbWludXRlc1xuICAgIG1heDogNTAsIC8vIDUwIHJlcXVlc3RzIHBlciB3aW5kb3dcbiAgfSksXG4gIFxuICAvLyBWZXJ5IHN0cmljdCBsaW1pdCBmb3IgQUkgb3BlcmF0aW9uc1xuICBhaTogY3JlYXRlUmF0ZUxpbWl0ZXIoe1xuICAgIHdpbmRvd01zOiA2MCAqIDYwICogMTAwMCwgLy8gMSBob3VyXG4gICAgbWF4OiAyMCwgLy8gMjAgcmVxdWVzdHMgcGVyIGhvdXJcbiAgICBtZXNzYWdlOiAnQUkgZ2VuZXJhdGlvbiBsaW1pdCBleGNlZWRlZC4gUGxlYXNlIHRyeSBhZ2FpbiBsYXRlci4nLFxuICB9KSxcbiAgXG4gIC8vIEZpbGUgdXBsb2FkIGxpbWl0XG4gIHVwbG9hZDogY3JlYXRlUmF0ZUxpbWl0ZXIoe1xuICAgIHdpbmRvd01zOiA2MCAqIDYwICogMTAwMCwgLy8gMSBob3VyXG4gICAgbWF4OiAxMCwgLy8gMTAgdXBsb2FkcyBwZXIgaG91clxuICAgIG1lc3NhZ2U6ICdGaWxlIHVwbG9hZCBsaW1pdCBleGNlZWRlZC4gUGxlYXNlIHRyeSBhZ2FpbiBsYXRlci4nLFxuICB9KSxcbn07Il0sInZlcnNpb24iOjN9