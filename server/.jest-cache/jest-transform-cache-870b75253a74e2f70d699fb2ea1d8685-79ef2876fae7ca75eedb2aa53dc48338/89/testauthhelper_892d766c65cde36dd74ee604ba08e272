5836c6fd88d809fed0118e09c64b6ae8
import request from 'supertest';
import bcrypt from 'bcryptjs';
import jwt from 'jsonwebtoken';
import { getTestPrismaClient } from './jest.setup.js';
/**
 * Helper to create a test user and get authentication token
 */
export async function getAuthToken(app, email) {
    const prisma = getTestPrismaClient();
    // Generate unique email if not provided
    const userEmail = email || `test-${Date.now()}-${Math.random().toString(36).substring(7)}@example.com`;
    // Create a test user with hashed password
    const hashedPassword = await bcrypt.hash('testpassword', 10);
    const user = await prisma.user.create({
        data: {
            email: userEmail,
            name: 'Test User',
            password: hashedPassword,
            role: 'teacher',
        },
    });
    // Login to get token
    const loginResponse = await request(app).post('/api/login').send({
        email: userEmail,
        password: 'testpassword',
    });
    if (loginResponse.status !== 200) {
        throw new Error(`Login failed: ${loginResponse.status} ${loginResponse.text}`);
    }
    return { token: loginResponse.body.token, userId: user.id };
}
/**
 * Helper to make authenticated requests
 */
export function authRequest(app) {
    let token = null;
    let userId = null;
    return {
        async setup() {
            const authData = await getAuthToken(app);
            token = authData.token;
            userId = authData.userId;
        },
        get userId() {
            return userId;
        },
        get(url) {
            return request(app).get(url).set('Authorization', `Bearer ${token}`);
        },
        post(url) {
            return request(app).post(url).set('Authorization', `Bearer ${token}`);
        },
        put(url) {
            return request(app).put(url).set('Authorization', `Bearer ${token}`);
        },
        delete(url) {
            return request(app).delete(url).set('Authorization', `Bearer ${token}`);
        },
        patch(url) {
            return request(app).patch(url).set('Authorization', `Bearer ${token}`);
        },
    };
}
/**
 * Create a test user without going through HTTP
 */
export async function createTestUser(email) {
    const prisma = getTestPrismaClient();
    // Generate unique email if not provided
    const userEmail = email || `test-${Date.now()}-${Math.random().toString(36).substring(7)}@example.com`;
    const hashedPassword = await bcrypt.hash('testpassword', 10);
    return await prisma.user.create({
        data: {
            email: userEmail,
            name: 'Test User',
            password: hashedPassword,
            role: 'teacher',
        },
    });
}
/**
 * Create an auth token for a user ID
 */
export function createAuthToken(userId, email) {
    const secret = process.env.JWT_SECRET;
    if (!secret) {
        throw new Error('JWT_SECRET environment variable is required for testing');
    }
    return jwt.sign({ userId: userId.toString(), email }, secret, { expiresIn: '24h' });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3Rlc3RzL3Rlc3QtYXV0aC1oZWxwZXIudHMiLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxPQUFPLE1BQU0sV0FBVyxDQUFDO0FBRWhDLE9BQU8sTUFBTSxNQUFNLFVBQVUsQ0FBQztBQUM5QixPQUFPLEdBQUcsTUFBTSxjQUFjLENBQUM7QUFDL0IsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFdEQ7O0dBRUc7QUFDSCxNQUFNLENBQUMsS0FBSyxVQUFVLFlBQVksQ0FDaEMsR0FBZ0IsRUFDaEIsS0FBYztJQUVkLE1BQU0sTUFBTSxHQUFHLG1CQUFtQixFQUFFLENBQUM7SUFFckMsd0NBQXdDO0lBQ3hDLE1BQU0sU0FBUyxHQUNiLEtBQUssSUFBSSxRQUFRLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDO0lBRXZGLDBDQUEwQztJQUMxQyxNQUFNLGNBQWMsR0FBRyxNQUFNLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQzdELE1BQU0sSUFBSSxHQUFHLE1BQU0sTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDcEMsSUFBSSxFQUFFO1lBQ0osS0FBSyxFQUFFLFNBQVM7WUFDaEIsSUFBSSxFQUFFLFdBQVc7WUFDakIsUUFBUSxFQUFFLGNBQWM7WUFDeEIsSUFBSSxFQUFFLFNBQVM7U0FDaEI7S0FDRixDQUFDLENBQUM7SUFFSCxxQkFBcUI7SUFDckIsTUFBTSxhQUFhLEdBQUcsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FBQztRQUMvRCxLQUFLLEVBQUUsU0FBUztRQUNoQixRQUFRLEVBQUUsY0FBYztLQUN6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RUFBRSxLQUFhO0lBQzNELE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDO0lBQ3RDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUNaLE1BQU0sSUFBSSxLQUFLLENBQUMseURBQXlELENBQUMsQ0FBQztJQUM3RSxDQUFDO0lBQ0QsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQyxRQUFRLEVBQUUsRUFBRSxLQUFLLEVBQUUsRUFBRSxNQUFNLEVBQUUsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztBQUN0RixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9taWNoYWVsbWNpc2FhYy9HaXRIdWIvdGVhY2hpbmctZW5naW5lMi4wL3NlcnZlci90ZXN0cy90ZXN0LWF1dGgtaGVscGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCByZXF1ZXN0IGZyb20gJ3N1cGVydGVzdCc7XG5pbXBvcnQgdHlwZSB7IEFwcGxpY2F0aW9uIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgYmNyeXB0IGZyb20gJ2JjcnlwdGpzJztcbmltcG9ydCBqd3QgZnJvbSAnanNvbndlYnRva2VuJztcbmltcG9ydCB7IGdldFRlc3RQcmlzbWFDbGllbnQgfSBmcm9tICcuL2plc3Quc2V0dXAuanMnO1xuXG4vKipcbiAqIEhlbHBlciB0byBjcmVhdGUgYSB0ZXN0IHVzZXIgYW5kIGdldCBhdXRoZW50aWNhdGlvbiB0b2tlblxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0QXV0aFRva2VuKFxuICBhcHA6IEFwcGxpY2F0aW9uLFxuICBlbWFpbD86IHN0cmluZyxcbik6IFByb21pc2U8eyB0b2tlbjogc3RyaW5nOyB1c2VySWQ6IG51bWJlciB9PiB7XG4gIGNvbnN0IHByaXNtYSA9IGdldFRlc3RQcmlzbWFDbGllbnQoKTtcblxuICAvLyBHZW5lcmF0ZSB1bmlxdWUgZW1haWwgaWYgbm90IHByb3ZpZGVkXG4gIGNvbnN0IHVzZXJFbWFpbCA9XG4gICAgZW1haWwgfHwgYHRlc3QtJHtEYXRlLm5vdygpfS0ke01hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cmluZyg3KX1AZXhhbXBsZS5jb21gO1xuXG4gIC8vIENyZWF0ZSBhIHRlc3QgdXNlciB3aXRoIGhhc2hlZCBwYXNzd29yZFxuICBjb25zdCBoYXNoZWRQYXNzd29yZCA9IGF3YWl0IGJjcnlwdC5oYXNoKCd0ZXN0cGFzc3dvcmQnLCAxMCk7XG4gIGNvbnN0IHVzZXIgPSBhd2FpdCBwcmlzbWEudXNlci5jcmVhdGUoe1xuICAgIGRhdGE6IHtcbiAgICAgIGVtYWlsOiB1c2VyRW1haWwsXG4gICAgICBuYW1lOiAnVGVzdCBVc2VyJyxcbiAgICAgIHBhc3N3b3JkOiBoYXNoZWRQYXNzd29yZCxcbiAgICAgIHJvbGU6ICd0ZWFjaGVyJyxcbiAgICB9LFxuICB9KTtcblxuICAvLyBMb2dpbiB0byBnZXQgdG9rZW5cbiAgY29uc3QgbG9naW5SZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKS5wb3N0KCcvYXBpL2xvZ2luJykuc2VuZCh7XG4gICAgZW1haWw6IHVzZXJFbWFpbCxcbiAgICBwYXNzd29yZDogJ3Rlc3RwYXNzd29yZCcsXG4gIH0pO1xuXG4gIGlmIChsb2dpblJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBMb2dpbiBmYWlsZWQ6ICR7bG9naW5SZXNwb25zZS5zdGF0dXN9ICR7bG9naW5SZXNwb25zZS50ZXh0fWApO1xuICB9XG5cbiAgcmV0dXJuIHsgdG9rZW46IGxvZ2luUmVzcG9uc2UuYm9keS50b2tlbiwgdXNlcklkOiB1c2VyLmlkIH07XG59XG5cbi8qKlxuICogSGVscGVyIHRvIG1ha2UgYXV0aGVudGljYXRlZCByZXF1ZXN0c1xuICovXG5leHBvcnQgZnVuY3Rpb24gYXV0aFJlcXVlc3QoYXBwOiBBcHBsaWNhdGlvbikge1xuICBsZXQgdG9rZW46IHN0cmluZyB8IG51bGwgPSBudWxsO1xuICBsZXQgdXNlcklkOiBudW1iZXIgfCBudWxsID0gbnVsbDtcblxuICByZXR1cm4ge1xuICAgIGFzeW5jIHNldHVwKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgY29uc3QgYXV0aERhdGEgPSBhd2FpdCBnZXRBdXRoVG9rZW4oYXBwKTtcbiAgICAgIHRva2VuID0gYXV0aERhdGEudG9rZW47XG4gICAgICB1c2VySWQgPSBhdXRoRGF0YS51c2VySWQ7XG4gICAgfSxcbiAgICBnZXQgdXNlcklkKCkge1xuICAgICAgcmV0dXJuIHVzZXJJZDtcbiAgICB9LFxuICAgIGdldCh1cmw6IHN0cmluZykge1xuICAgICAgcmV0dXJuIHJlcXVlc3QoYXBwKS5nZXQodXJsKS5zZXQoJ0F1dGhvcml6YXRpb24nLCBgQmVhcmVyICR7dG9rZW59YCk7XG4gICAgfSxcbiAgICBwb3N0KHVybDogc3RyaW5nKSB7XG4gICAgICByZXR1cm4gcmVxdWVzdChhcHApLnBvc3QodXJsKS5zZXQoJ0F1dGhvcml6YXRpb24nLCBgQmVhcmVyICR7dG9rZW59YCk7XG4gICAgfSxcbiAgICBwdXQodXJsOiBzdHJpbmcpIHtcbiAgICAgIHJldHVybiByZXF1ZXN0KGFwcCkucHV0KHVybCkuc2V0KCdBdXRob3JpemF0aW9uJywgYEJlYXJlciAke3Rva2VufWApO1xuICAgIH0sXG4gICAgZGVsZXRlKHVybDogc3RyaW5nKSB7XG4gICAgICByZXR1cm4gcmVxdWVzdChhcHApLmRlbGV0ZSh1cmwpLnNldCgnQXV0aG9yaXphdGlvbicsIGBCZWFyZXIgJHt0b2tlbn1gKTtcbiAgICB9LFxuICAgIHBhdGNoKHVybDogc3RyaW5nKSB7XG4gICAgICByZXR1cm4gcmVxdWVzdChhcHApLnBhdGNoKHVybCkuc2V0KCdBdXRob3JpemF0aW9uJywgYEJlYXJlciAke3Rva2VufWApO1xuICAgIH0sXG4gIH07XG59XG5cbi8qKlxuICogQ3JlYXRlIGEgdGVzdCB1c2VyIHdpdGhvdXQgZ29pbmcgdGhyb3VnaCBIVFRQXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVUZXN0VXNlcihlbWFpbD86IHN0cmluZykge1xuICBjb25zdCBwcmlzbWEgPSBnZXRUZXN0UHJpc21hQ2xpZW50KCk7XG5cbiAgLy8gR2VuZXJhdGUgdW5pcXVlIGVtYWlsIGlmIG5vdCBwcm92aWRlZFxuICBjb25zdCB1c2VyRW1haWwgPVxuICAgIGVtYWlsIHx8IGB0ZXN0LSR7RGF0ZS5ub3coKX0tJHtNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHJpbmcoNyl9QGV4YW1wbGUuY29tYDtcblxuICBjb25zdCBoYXNoZWRQYXNzd29yZCA9IGF3YWl0IGJjcnlwdC5oYXNoKCd0ZXN0cGFzc3dvcmQnLCAxMCk7XG4gIHJldHVybiBhd2FpdCBwcmlzbWEudXNlci5jcmVhdGUoe1xuICAgIGRhdGE6IHtcbiAgICAgIGVtYWlsOiB1c2VyRW1haWwsXG4gICAgICBuYW1lOiAnVGVzdCBVc2VyJyxcbiAgICAgIHBhc3N3b3JkOiBoYXNoZWRQYXNzd29yZCxcbiAgICAgIHJvbGU6ICd0ZWFjaGVyJyxcbiAgICB9LFxuICB9KTtcbn1cblxuLyoqXG4gKiBDcmVhdGUgYW4gYXV0aCB0b2tlbiBmb3IgYSB1c2VyIElEXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVBdXRoVG9rZW4odXNlcklkOiBudW1iZXIsIGVtYWlsOiBzdHJpbmcpOiBzdHJpbmcge1xuICBjb25zdCBzZWNyZXQgPSBwcm9jZXNzLmVudi5KV1RfU0VDUkVUO1xuICBpZiAoIXNlY3JldCkge1xuICAgIHRocm93IG5ldyBFcnJvcignSldUX1NFQ1JFVCBlbnZpcm9ubWVudCB2YXJpYWJsZSBpcyByZXF1aXJlZCBmb3IgdGVzdGluZycpO1xuICB9XG4gIHJldHVybiBqd3Quc2lnbih7IHVzZXJJZDogdXNlcklkLnRvU3RyaW5nKCksIGVtYWlsIH0sIHNlY3JldCwgeyBleHBpcmVzSW46ICcyNGgnIH0pO1xufVxuIl0sInZlcnNpb24iOjN9