3f14ab2ae6018034ca1a43db2f40beba
import { Router } from 'express';
import { prisma } from '../prisma';
import { generateParentSummary, regenerateParentSummary } from '../services/parentSummaryLLM';
import { z } from 'zod';
const router = Router();
// Validation schemas
const generateSummarySchema = z.object({
    studentId: z.number().int().positive(),
    from: z.string().datetime(),
    to: z.string().datetime(),
    focus: z.array(z.string()).optional(),
});
const regenerateSummarySchema = z.object({
    originalFrench: z.string().min(1),
    originalEnglish: z.string().min(1),
    studentId: z.number().int().positive(),
    from: z.string().datetime(),
    to: z.string().datetime(),
    focus: z.array(z.string()).optional(),
    tone: z.enum(['formal', 'informal']).optional(),
});
const saveSummarySchema = z.object({
    studentId: z.number().int().positive(),
    dateFrom: z.string().datetime(),
    dateTo: z.string().datetime(),
    focus: z.array(z.string()).optional(),
    contentFr: z.string().min(1),
    contentEn: z.string().min(1),
    isDraft: z.boolean().optional(),
});
// Generate a new parent summary using AI
router.post('/generate', async (req, res, _next) => {
    try {
        const userId = req.user?.userId;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const validation = generateSummarySchema.safeParse(req.body);
        if (!validation.success) {
            return res.status(400).json({
                error: 'Invalid request data',
                details: validation.error.flatten(),
            });
        }
        const { studentId, from, to, focus } = validation.data;
        // Verify the student belongs to this teacher
        const student = await prisma.student.findFirst({
            where: {
                id: studentId,
                userId: parseInt(userId),
            },
            include: {
                // parentContacts: true, // DISABLED: Legacy model removed
                artifacts: {
                    where: {
                        createdAt: {
                            gte: new Date(from),
                            lte: new Date(to),
                        },
                    },
                },
                reflections: {
                    where: {
                        createdAt: {
                            gte: new Date(from),
                            lte: new Date(to),
                        },
                    },
                },
            },
        });
        if (!student) {
            return res.status(404).json({ error: 'Student not found' });
        }
        // Generate the summary using AI
        const summaryData = await generateParentSummary({
            student: student,
            fromDate: new Date(from),
            toDate: new Date(to),
            focusAreas: focus,
        });
        res.json(summaryData);
    }
    catch (err) {
        console.error('Error generating parent summary:', err);
        _next(err);
    }
});
// Regenerate an existing summary with variations
router.post('/regenerate', async (req, res, _next) => {
    try {
        const userId = req.user?.userId;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const validation = regenerateSummarySchema.safeParse(req.body);
        if (!validation.success) {
            return res.status(400).json({
                error: 'Invalid request data',
                details: validation.error.flatten(),
            });
        }
        const { originalFrench, originalEnglish, studentId, from, to, focus, tone } = validation.data;
        // Verify the student belongs to this teacher
        const student = await prisma.student.findFirst({
            where: {
                id: studentId,
                userId: parseInt(userId),
            },
        });
        if (!student) {
            return res.status(404).json({ error: 'Student not found' });
        }
        // Regenerate the summary with variations
        const summaryData = await regenerateParentSummary({
            originalFrench,
            originalEnglish,
            student,
            fromDate: new Date(from),
            toDate: new Date(to),
            focusAreas: focus,
            tone: tone || 'formal',
        });
        res.json(summaryData);
    }
    catch (err) {
        console.error('Error regenerating parent summary:', err);
        _next(err);
    }
});
// Save a summary to the database
router.post('/save', async (req, res, _next) => {
    try {
        const userId = req.user?.userId;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const validation = saveSummarySchema.safeParse(req.body);
        if (!validation.success) {
            return res.status(400).json({
                error: 'Invalid request data',
                details: validation.error.flatten(),
            });
        }
        const { studentId, dateFrom, dateTo, focus, contentFr, contentEn, isDraft } = validation.data;
        // Verify the student belongs to this teacher
        const student = await prisma.student.findFirst({
            where: {
                id: studentId,
                userId: parseInt(userId),
            },
        });
        if (!student) {
            return res.status(404).json({ error: 'Student not found' });
        }
        // Save the summary
        const summary = await prisma.parentSummary.create({
            data: {
                studentId,
                dateFrom: new Date(dateFrom),
                dateTo: new Date(dateTo),
                focus: JSON.stringify(focus || []),
                contentFr,
                contentEn,
                isDraft: isDraft ?? true,
            },
        });
        res.status(201).json(summary);
    }
    catch (err) {
        console.error('Error saving parent summary:', err);
        _next(err);
    }
});
// Get all summaries for a specific student
router.get('/student/:studentId', async (req, res, _next) => {
    try {
        const userId = req.user?.userId;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const studentId = parseInt(req.params.studentId);
        // Verify the student belongs to this teacher
        const student = await prisma.student.findFirst({
            where: {
                id: studentId,
                userId: parseInt(userId),
            },
        });
        if (!student) {
            return res.status(404).json({ error: 'Student not found' });
        }
        const summaries = await prisma.parentSummary.findMany({
            where: { studentId },
            orderBy: { createdAt: 'desc' },
        });
        res.json(summaries);
    }
    catch (err) {
        _next(err);
    }
});
// Update a summary
router.put('/:id', async (req, res, _next) => {
    try {
        const userId = req.user?.userId;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const summaryId = parseInt(req.params.id);
        // Verify the summary belongs to a student of this teacher
        const existingSummary = await prisma.parentSummary.findFirst({
            where: {
                id: summaryId,
                student: {
                    userId: parseInt(userId),
                },
            },
        });
        if (!existingSummary) {
            return res.status(404).json({ error: 'Summary not found' });
        }
        const summary = await prisma.parentSummary.update({
            where: { id: summaryId },
            data: req.body,
        });
        res.json(summary);
    }
    catch (err) {
        _next(err);
    }
});
// Delete a summary
router.delete('/:id', async (req, res, _next) => {
    try {
        const userId = req.user?.userId;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const summaryId = parseInt(req.params.id);
        // Verify the summary belongs to a student of this teacher
        const existingSummary = await prisma.parentSummary.findFirst({
            where: {
                id: summaryId,
                student: {
                    userId: parseInt(userId),
                },
            },
        });
        if (!existingSummary) {
            return res.status(404).json({ error: 'Summary not found' });
        }
        await prisma.parentSummary.delete({
            where: { id: summaryId },
        });
        res.status(204).send();
    }
    catch (err) {
        _next(err);
    }
});
export default router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9yb3V0ZXMvcGFyZW50U3VtbWFyeS50cyIsIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFXLE1BQU0sU0FBUyxDQUFDO0FBQzFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDbkMsT0FBTyxFQUFFLHFCQUFxQixFQUFFLHVCQUF1QixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDOUYsT0FBTyxFQUFFLENBQUMsRUFBRSxNQUFNLEtBQUssQ0FBQztBQU14QixNQUFNLE1BQU0sR0FBRyxNQUFNLEVBQUUsQ0FBQztBQUV4QixxQkFBcUI7QUFDckIsTUFBTSxxQkFBcUIsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDO0lBQ3JDLFNBQVMsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsUUFBUSxFQUFFO0lBQ3RDLElBQUksRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0lBQzNCLEVBQUUsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0lBQ3pCLEtBQUssRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLFFBQVEsRUFBRTtDQUN0QyxDQUFDLENBQUM7QUFFSCxNQUFNLHVCQUF1QixHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDdkMsY0FBYyxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ2pDLGVBQWUsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNsQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLFFBQVEsRUFBRTtJQUN0QyxJQUFJLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFB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SHViL3RlYWNoaW5nLWVuZ2luZTIuMC9zZXJ2ZXIvc3JjL3JvdXRlcy9wYXJlbnRTdW1tYXJ5LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJvdXRlciwgUmVxdWVzdCB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgcHJpc21hIH0gZnJvbSAnLi4vcHJpc21hJztcbmltcG9ydCB7IGdlbmVyYXRlUGFyZW50U3VtbWFyeSwgcmVnZW5lcmF0ZVBhcmVudFN1bW1hcnkgfSBmcm9tICcuLi9zZXJ2aWNlcy9wYXJlbnRTdW1tYXJ5TExNJztcbmltcG9ydCB7IHogfSBmcm9tICd6b2QnO1xuXG5pbnRlcmZhY2UgQXV0aGVudGljYXRlZFJlcXVlc3QgZXh0ZW5kcyBSZXF1ZXN0IHtcbiAgdXNlcj86IHsgdXNlcklkOiBzdHJpbmcgfTtcbn1cblxuY29uc3Qgcm91dGVyID0gUm91dGVyKCk7XG5cbi8vIFZhbGlkYXRpb24gc2NoZW1hc1xuY29uc3QgZ2VuZXJhdGVTdW1tYXJ5U2NoZW1hID0gei5vYmplY3Qoe1xuICBzdHVkZW50SWQ6IHoubnVtYmVyKCkuaW50KCkucG9zaXRpdmUoKSxcbiAgZnJvbTogei5zdHJpbmcoKS5kYXRldGltZSgpLFxuICB0bzogei5zdHJpbmcoKS5kYXRldGltZSgpLFxuICBmb2N1czogei5hcnJheSh6LnN0cmluZygpKS5vcHRpb25hbCgpLFxufSk7XG5cbmNvbnN0IHJlZ2VuZXJhdGVTdW1tYXJ5U2NoZW1hID0gei5vYmplY3Qoe1xuICBvcmlnaW5hbEZyZW5jaDogei5zdHJpbmcoKS5taW4oMSksXG4gIG9yaWdpbmFsRW5nbGlzaDogei5zdHJpbmcoKS5taW4oMSksXG4gIHN0dWRlbnRJZDogei5udW1iZXIoKS5pbnQoKS5wb3NpdGl2ZSgpLFxuICBmcm9tOiB6LnN0cmluZygpLmRhdGV0aW1lKCksXG4gIHRvOiB6LnN0cmluZygpLmRhdGV0aW1lKCksXG4gIGZvY3VzOiB6LmFycmF5KHouc3RyaW5nKCkpLm9wdGlvbmFsKCksXG4gIHRvbmU6IHouZW51bShbJ2Zvcm1hbCcsICdpbmZvcm1hbCddKS5vcHRpb25hbCgpLFxufSk7XG5cbmNvbnN0IHNhdmVTdW1tYXJ5U2NoZW1hID0gei5vYmplY3Qoe1xuICBzdHVkZW50SWQ6IHoubnVtYmVyKCkuaW50KCkucG9zaXRpdmUoKSxcbiAgZGF0ZUZyb206IHouc3RyaW5nKCkuZGF0ZXRpbWUoKSxcbiAgZGF0ZVRvOiB6LnN0cmluZygpLmRhdGV0aW1lKCksXG4gIGZvY3VzOiB6LmFycmF5KHouc3RyaW5nKCkpLm9wdGlvbmFsKCksXG4gIGNvbnRlbnRGcjogei5zdHJpbmcoKS5taW4oMSksXG4gIGNvbnRlbnRFbjogei5zdHJpbmcoKS5taW4oMSksXG4gIGlzRHJhZnQ6IHouYm9vbGVhbigpLm9wdGlvbmFsKCksXG59KTtcblxuLy8gR2VuZXJhdGUgYSBuZXcgcGFyZW50IHN1bW1hcnkgdXNpbmcgQUlcbnJvdXRlci5wb3N0KCcvZ2VuZXJhdGUnLCBhc3luYyAocmVxOiBBdXRoZW50aWNhdGVkUmVxdWVzdCwgcmVzLCBfbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyPy51c2VySWQ7XG4gICAgaWYgKCF1c2VySWQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAnVW5hdXRob3JpemVkJyB9KTtcbiAgICB9XG5cbiAgICBjb25zdCB2YWxpZGF0aW9uID0gZ2VuZXJhdGVTdW1tYXJ5U2NoZW1hLnNhZmVQYXJzZShyZXEuYm9keSk7XG4gICAgaWYgKCF2YWxpZGF0aW9uLnN1Y2Nlc3MpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnSW52YWxpZCByZXF1ZXN0IGRhdGEnLFxuICAgICAgICBkZXRhaWxzOiB2YWxpZGF0aW9uLmVycm9yLmZsYXR0ZW4oKSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHsgc3R1ZGVudElkLCBmcm9tLCB0bywgZm9jdXMgfSA9IHZhbGlkYXRpb24uZGF0YTtcblxuICAgIC8vIFZlcmlmeSB0aGUgc3R1ZGVudCBiZWxvbmdzIHRvIHRoaXMgdGVhY2hlclxuICAgIGNvbnN0IHN0dWRlbnQgPSBhd2FpdCBwcmlzbWEuc3R1ZGVudC5maW5kRmlyc3Qoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgaWQ6IHN0dWRlbnRJZCxcbiAgICAgICAgdXNlcklkOiBwYXJzZUludCh1c2VySWQpLFxuICAgICAgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgLy8gcGFyZW50Q29udGFjdHM6IHRydWUsIC8vIERJU0FCTEVEOiBMZWdhY3kgbW9kZWwgcmVtb3ZlZFxuICAgICAgICBhcnRpZmFjdHM6IHtcbiAgICAgICAgICB3aGVyZToge1xuICAgICAgICAgICAgY3JlYXRlZEF0OiB7XG4gICAgICAgICAgICAgIGd0ZTogbmV3IERhdGUoZnJvbSksXG4gICAgICAgICAgICAgIGx0ZTogbmV3IERhdGUodG8pLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICByZWZsZWN0aW9uczoge1xuICAgICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgICBjcmVhdGVkQXQ6IHtcbiAgICAgICAgICAgICAgZ3RlOiBuZXcgRGF0ZShmcm9tKSxcbiAgICAgICAgICAgICAgbHRlOiBuZXcgRGF0ZSh0byksXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFzdHVkZW50KSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBlcnJvcjogJ1N0dWRlbnQgbm90IGZvdW5kJyB9KTtcbiAgICB9XG5cbiAgICAvLyBHZW5lcmF0ZSB0aGUgc3VtbWFyeSB1c2luZyBBSVxuICAgIGNvbnN0IHN1bW1hcnlEYXRhID0gYXdhaXQgZ2VuZXJhdGVQYXJlbnRTdW1tYXJ5KHtcbiAgICAgIHN0dWRlbnQ6IHN0dWRlbnQsXG4gICAgICBmcm9tRGF0ZTogbmV3IERhdGUoZnJvbSksXG4gICAgICB0b0RhdGU6IG5ldyBEYXRlKHRvKSxcbiAgICAgIGZvY3VzQXJlYXM6IGZvY3VzLFxuICAgIH0pO1xuXG4gICAgcmVzLmpzb24oc3VtbWFyeURhdGEpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBnZW5lcmF0aW5nIHBhcmVudCBzdW1tYXJ5OicsIGVycik7XG4gICAgX25leHQoZXJyKTtcbiAgfVxufSk7XG5cbi8vIFJlZ2VuZXJhdGUgYW4gZXhpc3Rpbmcgc3VtbWFyeSB3aXRoIHZhcmlhdGlvbnNcbnJvdXRlci5wb3N0KCcvcmVnZW5lcmF0ZScsIGFzeW5jIChyZXE6IEF1dGhlbnRpY2F0ZWRSZXF1ZXN0LCByZXMsIF9uZXh0KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXI/LnVzZXJJZDtcbiAgICBpZiAoIXVzZXJJZCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICdVbmF1dGhvcml6ZWQnIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHZhbGlkYXRpb24gPSByZWdlbmVyYXRlU3VtbWFyeVNjaGVtYS5zYWZlUGFyc2UocmVxLmJvZHkpO1xuICAgIGlmICghdmFsaWRhdGlvbi5zdWNjZXNzKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICBlcnJvcjogJ0ludmFsaWQgcmVxdWVzdCBkYXRhJyxcbiAgICAgICAgZGV0YWlsczogdmFsaWRhdGlvbi5lcnJvci5mbGF0dGVuKCksXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCB7IG9yaWdpbmFsRnJlbmNoLCBvcmlnaW5hbEVuZ2xpc2gsIHN0dWRlbnRJZCwgZnJvbSwgdG8sIGZvY3VzLCB0b25lIH0gPSB2YWxpZGF0aW9uLmRhdGE7XG5cbiAgICAvLyBWZXJpZnkgdGhlIHN0dWRlbnQgYmVsb25ncyB0byB0aGlzIHRlYWNoZXJcbiAgICBjb25zdCBzdHVkZW50ID0gYXdhaXQgcHJpc21hLnN0dWRlbnQuZmluZEZpcnN0KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIGlkOiBzdHVkZW50SWQsXG4gICAgICAgIHVzZXJJZDogcGFyc2VJbnQodXNlcklkKSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXN0dWRlbnQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IGVycm9yOiAnU3R1ZGVudCBub3QgZm91bmQnIH0pO1xuICAgIH1cblxuICAgIC8vIFJlZ2VuZXJhdGUgdGhlIHN1bW1hcnkgd2l0aCB2YXJpYXRpb25zXG4gICAgY29uc3Qgc3VtbWFyeURhdGEgPSBhd2FpdCByZWdlbmVyYXRlUGFyZW50U3VtbWFyeSh7XG4gICAgICBvcmlnaW5hbEZyZW5jaCxcbiAgICAgIG9yaWdpbmFsRW5nbGlzaCxcbiAgICAgIHN0dWRlbnQsXG4gICAgICBmcm9tRGF0ZTogbmV3IERhdGUoZnJvbSksXG4gICAgICB0b0RhdGU6IG5ldyBEYXRlKHRvKSxcbiAgICAgIGZvY3VzQXJlYXM6IGZvY3VzLFxuICAgICAgdG9uZTogdG9uZSB8fCAnZm9ybWFsJyxcbiAgICB9KTtcblxuICAgIHJlcy5qc29uKHN1bW1hcnlEYXRhKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgcmVnZW5lcmF0aW5nIHBhcmVudCBzdW1tYXJ5OicsIGVycik7XG4gICAgX25leHQoZXJyKTtcbiAgfVxufSk7XG5cbi8vIFNhdmUgYSBzdW1tYXJ5IHRvIHRoZSBkYXRhYmFzZVxucm91dGVyLnBvc3QoJy9zYXZlJywgYXN5bmMgKHJlcTogQXV0aGVudGljYXRlZFJlcXVlc3QsIHJlcywgX25leHQpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlcj8udXNlcklkO1xuICAgIGlmICghdXNlcklkKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBlcnJvcjogJ1VuYXV0aG9yaXplZCcgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgdmFsaWRhdGlvbiA9IHNhdmVTdW1tYXJ5U2NoZW1hLnNhZmVQYXJzZShyZXEuYm9keSk7XG4gICAgaWYgKCF2YWxpZGF0aW9uLnN1Y2Nlc3MpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnSW52YWxpZCByZXF1ZXN0IGRhdGEnLFxuICAgICAgICBkZXRhaWxzOiB2YWxpZGF0aW9uLmVycm9yLmZsYXR0ZW4oKSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHsgc3R1ZGVudElkLCBkYXRlRnJvbSwgZGF0ZVRvLCBmb2N1cywgY29udGVudEZyLCBjb250ZW50RW4sIGlzRHJhZnQgfSA9IHZhbGlkYXRpb24uZGF0YTtcblxuICAgIC8vIFZlcmlmeSB0aGUgc3R1ZGVudCBiZWxvbmdzIHRvIHRoaXMgdGVhY2hlclxuICAgIGNvbnN0IHN0dWRlbnQgPSBhd2FpdCBwcmlzbWEuc3R1ZGVudC5maW5kRmlyc3Qoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgaWQ6IHN0dWRlbnRJZCxcbiAgICAgICAgdXNlcklkOiBwYXJzZUludCh1c2VySWQpLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghc3R1ZGVudCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgZXJyb3I6ICdTdHVkZW50IG5vdCBmb3VuZCcgfSk7XG4gICAgfVxuXG4gICAgLy8gU2F2ZSB0aGUgc3VtbWFyeVxuICAgIGNvbnN0IHN1bW1hcnkgPSBhd2FpdCBwcmlzbWEucGFyZW50U3VtbWFyeS5jcmVhdGUoe1xuICAgICAgZGF0YToge1xuICAgICAgICBzdHVkZW50SWQsXG4gICAgICAgIGRhdGVGcm9tOiBuZXcgRGF0ZShkYXRlRnJvbSksXG4gICAgICAgIGRhdGVUbzogbmV3IERhdGUoZGF0ZVRvKSxcbiAgICAgICAgZm9jdXM6IEpTT04uc3RyaW5naWZ5KGZvY3VzIHx8IFtdKSxcbiAgICAgICAgY29udGVudEZyLFxuICAgICAgICBjb250ZW50RW4sXG4gICAgICAgIGlzRHJhZnQ6IGlzRHJhZnQgPz8gdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICByZXMuc3RhdHVzKDIwMSkuanNvbihzdW1tYXJ5KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3Igc2F2aW5nIHBhcmVudCBzdW1tYXJ5OicsIGVycik7XG4gICAgX25leHQoZXJyKTtcbiAgfVxufSk7XG5cbi8vIEdldCBhbGwgc3VtbWFyaWVzIGZvciBhIHNwZWNpZmljIHN0dWRlbnRcbnJvdXRlci5nZXQoJy9zdHVkZW50LzpzdHVkZW50SWQnLCBhc3luYyAocmVxOiBBdXRoZW50aWNhdGVkUmVxdWVzdCwgcmVzLCBfbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyPy51c2VySWQ7XG4gICAgaWYgKCF1c2VySWQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAnVW5hdXRob3JpemVkJyB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBzdHVkZW50SWQgPSBwYXJzZUludChyZXEucGFyYW1zLnN0dWRlbnRJZCk7XG5cbiAgICAvLyBWZXJpZnkgdGhlIHN0dWRlbnQgYmVsb25ncyB0byB0aGlzIHRlYWNoZXJcbiAgICBjb25zdCBzdHVkZW50ID0gYXdhaXQgcHJpc21hLnN0dWRlbnQuZmluZEZpcnN0KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIGlkOiBzdHVkZW50SWQsXG4gICAgICAgIHVzZXJJZDogcGFyc2VJbnQodXNlcklkKSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXN0dWRlbnQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IGVycm9yOiAnU3R1ZGVudCBub3QgZm91bmQnIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHN1bW1hcmllcyA9IGF3YWl0IHByaXNtYS5wYXJlbnRTdW1tYXJ5LmZpbmRNYW55KHtcbiAgICAgIHdoZXJlOiB7IHN0dWRlbnRJZCB9LFxuICAgICAgb3JkZXJCeTogeyBjcmVhdGVkQXQ6ICdkZXNjJyB9LFxuICAgIH0pO1xuXG4gICAgcmVzLmpzb24oc3VtbWFyaWVzKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgX25leHQoZXJyKTtcbiAgfVxufSk7XG5cbi8vIFVwZGF0ZSBhIHN1bW1hcnlcbnJvdXRlci5wdXQoJy86aWQnLCBhc3luYyAocmVxOiBBdXRoZW50aWNhdGVkUmVxdWVzdCwgcmVzLCBfbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyPy51c2VySWQ7XG4gICAgaWYgKCF1c2VySWQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAnVW5hdXRob3JpemVkJyB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBzdW1tYXJ5SWQgPSBwYXJzZUludChyZXEucGFyYW1zLmlkKTtcblxuICAgIC8vIFZlcmlmeSB0aGUgc3VtbWFyeSBiZWxvbmdzIHRvIGEgc3R1ZGVudCBvZiB0aGlzIHRlYWNoZXJcbiAgICBjb25zdCBleGlzdGluZ1N1bW1hcnkgPSBhd2FpdCBwcmlzbWEucGFyZW50U3VtbWFyeS5maW5kRmlyc3Qoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgaWQ6IHN1bW1hcnlJZCxcbiAgICAgICAgc3R1ZGVudDoge1xuICAgICAgICAgIHVzZXJJZDogcGFyc2VJbnQodXNlcklkKSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIWV4aXN0aW5nU3VtbWFyeSkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgZXJyb3I6ICdTdW1tYXJ5IG5vdCBmb3VuZCcgfSk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3VtbWFyeSA9IGF3YWl0IHByaXNtYS5wYXJlbnRTdW1tYXJ5LnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyBpZDogc3VtbWFyeUlkIH0sXG4gICAgICBkYXRhOiByZXEuYm9keSxcbiAgICB9KTtcblxuICAgIHJlcy5qc29uKHN1bW1hcnkpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBfbmV4dChlcnIpO1xuICB9XG59KTtcblxuLy8gRGVsZXRlIGEgc3VtbWFyeVxucm91dGVyLmRlbGV0ZSgnLzppZCcsIGFzeW5jIChyZXE6IEF1dGhlbnRpY2F0ZWRSZXF1ZXN0LCByZXMsIF9uZXh0KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXI/LnVzZXJJZDtcbiAgICBpZiAoIXVzZXJJZCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICdVbmF1dGhvcml6ZWQnIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHN1bW1hcnlJZCA9IHBhcnNlSW50KHJlcS5wYXJhbXMuaWQpO1xuXG4gICAgLy8gVmVyaWZ5IHRoZSBzdW1tYXJ5IGJlbG9uZ3MgdG8gYSBzdHVkZW50IG9mIHRoaXMgdGVhY2hlclxuICAgIGNvbnN0IGV4aXN0aW5nU3VtbWFyeSA9IGF3YWl0IHByaXNtYS5wYXJlbnRTdW1tYXJ5LmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBpZDogc3VtbWFyeUlkLFxuICAgICAgICBzdHVkZW50OiB7XG4gICAgICAgICAgdXNlcklkOiBwYXJzZUludCh1c2VySWQpLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghZXhpc3RpbmdTdW1tYXJ5KSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBlcnJvcjogJ1N1bW1hcnkgbm90IGZvdW5kJyB9KTtcbiAgICB9XG5cbiAgICBhd2FpdCBwcmlzbWEucGFyZW50U3VtbWFyeS5kZWxldGUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHN1bW1hcnlJZCB9LFxuICAgIH0pO1xuXG4gICAgcmVzLnN0YXR1cygyMDQpLnNlbmQoKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgX25leHQoZXJyKTtcbiAgfVxufSk7XG5cbmV4cG9ydCBkZWZhdWx0IHJvdXRlcjtcbiJdLCJ2ZXJzaW9uIjozfQ==