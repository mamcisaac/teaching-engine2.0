{"file":"/Users/michaelmcisaac/GitHub/teaching-engine2.0/server/src/services/newsletterService.ts","mappings":"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","names":[],"sources":["/Users/michaelmcisaac/GitHub/teaching-engine2.0/server/src/services/newsletterService.ts"],"sourcesContent":["import { Student, DaybookEntry, StudentArtifact, StudentReflection } from '@teaching-engine/database';\nimport OpenAI from 'openai';\n\n// Newsletter types\nexport type NewsletterTone = 'friendly' | 'formal' | 'informative';\n\nexport interface NewsletterSection {\n  id: string;\n  title: string;\n  titleFr: string;\n  content: string;\n  contentFr: string;\n  isEditable: boolean;\n  order: number;\n}\n\nconst openai = new OpenAI({\n  apiKey: process.env.OPENAI_API_KEY || '',\n});\n\ninterface NewsletterGenerationOptions {\n  students: (Student & { artifacts: StudentArtifact[]; reflections: StudentReflection[] })[];\n  daybookEntries: DaybookEntry[];\n  fromDate: Date;\n  toDate: Date;\n  tone: NewsletterTone;\n  focusAreas?: string[];\n  options: {\n    includeArtifacts: boolean;\n    includeReflections: boolean;\n    includeLearningGoals: boolean;\n    includeUpcomingEvents: boolean;\n  };\n}\n\nexport async function generateNewsletterContent({\n  students,\n  daybookEntries,\n  fromDate,\n  toDate,\n  tone,\n  focusAreas = [],\n  options,\n}: NewsletterGenerationOptions) {\n  const dateRange = `${fromDate.toLocaleDateString()} to ${toDate.toLocaleDateString()}`;\n  const studentNames = students.map(s => s.firstName).join(', ');\n\n  // Prepare context for AI\n  const learningActivities = daybookEntries.map(entry => ({\n    date: entry.date,\n    notes: entry.notes,\n    whatWorked: entry.whatWorked,\n    studentEngagement: entry.studentEngagement,\n    studentSuccesses: entry.studentSuccesses,\n  }));\n\n  const studentProgress = students.map(student => ({\n    name: student.firstName,\n    artifacts: options.includeArtifacts ? student.artifacts : [],\n    reflections: options.includeReflections ? student.reflections : [],\n  }));\n\n  const toneDescriptions = {\n    friendly: 'warm, approachable, and conversational',\n    formal: 'professional, structured, and detailed',\n    informative: 'clear, factual, and educational',\n  };\n\n  const systemPrompt = `You are an elementary school teacher creating a newsletter for parents. \nYour tone should be ${toneDescriptions[tone]}. \nCreate bilingual content (English and French) for each section.\nFocus on: ${focusAreas.length > 0 ? focusAreas.join(', ') : 'overall student progress and activities'}.`;\n\n  const userPrompt = `Create a parent newsletter for the period ${dateRange} for students: ${studentNames}.\n\nLearning Activities:\n${JSON.stringify(learningActivities, null, 2)}\n\n${options.includeArtifacts || options.includeReflections ? `Student Progress:\n${JSON.stringify(studentProgress, null, 2)}` : ''}\n\nPlease create the following sections:\n1. Introduction/Overview\n2. Academic Highlights\n3. Learning Activities & Projects\n${options.includeArtifacts ? '4. Student Work Showcase' : ''}\n${options.includeReflections ? '5. Student Reflections' : ''}\n${options.includeLearningGoals ? '6. Upcoming Learning Goals' : ''}\n${options.includeUpcomingEvents ? '7. Important Dates & Events' : ''}\n8. Home Support Tips\n9. Closing Message\n\nFor each section, provide:\n- title (English)\n- titleFr (French)\n- content (English, using simple HTML for formatting)\n- contentFr (French, using simple HTML for formatting)\n\nFormat the response as a JSON array of sections.`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: 'gpt-4o-mini',\n      messages: [\n        { role: 'system', content: systemPrompt },\n        { role: 'user', content: userPrompt },\n      ],\n      temperature: tone === 'friendly' ? 0.8 : tone === 'formal' ? 0.5 : 0.6,\n      response_format: { type: 'json_object' },\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error('No content generated');\n    }\n\n    const parsed = JSON.parse(content);\n    const sections: NewsletterSection[] = (parsed.sections || []).map((section: { title?: string; titleFr?: string; content?: string; contentFr?: string }, index: number) => ({\n      id: `section-${Date.now()}-${index}`,\n      title: section.title || 'Section',\n      titleFr: section.titleFr || 'Section',\n      content: section.content || '',\n      contentFr: section.contentFr || '',\n      isEditable: true,\n      order: index,\n    }));\n\n    return { sections };\n  } catch (error) {\n    console.error('Error generating newsletter content:', error);\n    \n    // Fallback to template-based generation\n    return generateFallbackNewsletter({\n      dateRange,\n      studentNames,\n      tone,\n      focusAreas,\n      options,\n    });\n  }\n}\n\nfunction generateFallbackNewsletter({\n  dateRange,\n  studentNames,\n  tone: _tone,\n  focusAreas,\n  options,\n}: {\n  dateRange: string;\n  studentNames: string;\n  tone: NewsletterTone;\n  focusAreas: string[];\n  options: {\n    includeArtifacts: boolean;\n    includeReflections: boolean;\n    includeLearningGoals: boolean;\n    includeUpcomingEvents: boolean;\n  };\n}): { sections: NewsletterSection[] } {\n  const sections: NewsletterSection[] = [];\n  let order = 0;\n\n  // Introduction\n  sections.push({\n    id: `section-intro-${Date.now()}`,\n    title: 'Newsletter Introduction',\n    titleFr: 'Introduction du bulletin',\n    content: `<p>Dear Parents and Guardians,</p>\n<p>Welcome to our classroom newsletter for ${dateRange}. This update covers the learning journey of ${studentNames}.</p>`,\n    contentFr: `<p>Chers parents et tuteurs,</p>\n<p>Bienvenue à notre bulletin de classe pour ${dateRange}. Cette mise à jour couvre le parcours d'apprentissage de ${studentNames}.</p>`,\n    isEditable: true,\n    order: order++,\n  });\n\n  // Academic Highlights\n  sections.push({\n    id: `section-highlights-${Date.now()}`,\n    title: 'Academic Highlights',\n    titleFr: 'Points saillants académiques',\n    content: `<p>This period, our students have been working on various subjects and activities. ${focusAreas.length > 0 ? `We particularly focused on: ${focusAreas.join(', ')}.` : ''}</p>`,\n    contentFr: `<p>Au cours de cette période, nos élèves ont travaillé sur divers sujets et activités. ${focusAreas.length > 0 ? `Nous nous sommes particulièrement concentrés sur : ${focusAreas.join(', ')}.` : ''}</p>`,\n    isEditable: true,\n    order: order++,\n  });\n\n  // Learning Activities\n  sections.push({\n    id: `section-activities-${Date.now()}`,\n    title: 'Learning Activities & Projects',\n    titleFr: 'Activités d\\'apprentissage et projets',\n    content: `<p>Students engaged in hands-on learning experiences including group projects, individual assignments, and collaborative activities.</p>`,\n    contentFr: `<p>Les élèves ont participé à des expériences d'apprentissage pratiques comprenant des projets de groupe, des devoirs individuels et des activités collaboratives.</p>`,\n    isEditable: true,\n    order: order++,\n  });\n\n  if (options.includeLearningGoals) {\n    sections.push({\n      id: `section-goals-${Date.now()}`,\n      title: 'Upcoming Learning Goals',\n      titleFr: 'Objectifs d\\'apprentissage à venir',\n      content: `<p>In the coming weeks, we will be focusing on developing key skills and exploring new concepts across our curriculum.</p>`,\n      contentFr: `<p>Dans les semaines à venir, nous nous concentrerons sur le développement de compétences clés et l'exploration de nouveaux concepts dans notre programme.</p>`,\n      isEditable: true,\n      order: order++,\n    });\n  }\n\n  // Home Support\n  sections.push({\n    id: `section-support-${Date.now()}`,\n    title: 'How You Can Help at Home',\n    titleFr: 'Comment vous pouvez aider à la maison',\n    content: `<p>You can support your child's learning by:</p>\n<ul>\n  <li>Reading together daily</li>\n  <li>Practicing math facts during everyday activities</li>\n  <li>Encouraging questions and curiosity</li>\n  <li>Providing a quiet study space</li>\n</ul>`,\n    contentFr: `<p>Vous pouvez soutenir l'apprentissage de votre enfant en :</p>\n<ul>\n  <li>Lisant ensemble tous les jours</li>\n  <li>Pratiquant les faits mathématiques lors des activités quotidiennes</li>\n  <li>Encourageant les questions et la curiosité</li>\n  <li>Fournissant un espace d'étude calme</li>\n</ul>`,\n    isEditable: true,\n    order: order++,\n  });\n\n  // Closing\n  sections.push({\n    id: `section-closing-${Date.now()}`,\n    title: 'Closing Message',\n    titleFr: 'Message de clôture',\n    content: `<p>Thank you for your continued support. Please don't hesitate to reach out if you have any questions or concerns.</p>\n<p>Best regards,<br>Your Teaching Team</p>`,\n    contentFr: `<p>Merci pour votre soutien continu. N'hésitez pas à nous contacter si vous avez des questions ou des préoccupations.</p>\n<p>Cordialement,<br>Votre équipe enseignante</p>`,\n    isEditable: true,\n    order: order++,\n  });\n\n  return { sections };\n}"],"version":3}