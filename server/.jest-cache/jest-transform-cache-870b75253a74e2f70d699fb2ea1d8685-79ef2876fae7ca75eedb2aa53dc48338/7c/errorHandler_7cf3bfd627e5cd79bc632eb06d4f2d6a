8f570e2535433d113fb11a676918de62
import { Prisma } from '@prisma/client';
import logger from '../logger';
import { ZodError } from 'zod';
export class AppError extends Error {
    statusCode;
    code;
    isOperational;
    constructor(message, statusCode, code, isOperational = true) {
        super(message);
        this.statusCode = statusCode;
        this.code = code;
        this.isOperational = isOperational;
        Error.captureStackTrace(this, this.constructor);
    }
}
export const asyncHandler = (fn) => (req, res, next) => {
    Promise.resolve(fn(req, res, next)).catch(next);
};
export function errorHandler(err, req, res, _next) {
    let statusCode = 500;
    let response = {
        error: 'Internal Server Error',
        timestamp: new Date().toISOString(),
        path: req.path,
    };
    // Log the error
    logger.error({
        err,
        method: req.method,
        path: req.path,
        query: req.query,
        ip: req.ip,
        userId: req.user?.userId,
    }, 'Request error');
    // Handle known error types
    if (err instanceof AppError) {
        statusCode = err.statusCode;
        response.error = err.message;
        response.code = err.code;
    }
    else if (err instanceof Prisma.PrismaClientKnownRequestError) {
        // Handle Prisma errors
        switch (err.code) {
            case 'P2002':
                statusCode = 409;
                response.error = 'Duplicate entry';
                response.message = 'A record with this value already exists';
                response.code = 'DUPLICATE_ENTRY';
                break;
            case 'P2025':
                statusCode = 404;
                response.error = 'Record not found';
                response.message = 'The requested record does not exist';
                response.code = 'NOT_FOUND';
                break;
            case 'P2003':
                statusCode = 400;
                response.error = 'Foreign key constraint failed';
                response.message = 'Referenced record does not exist';
                response.code = 'FOREIGN_KEY_ERROR';
                break;
            case 'P2016':
                statusCode = 400;
                response.error = 'Query interpretation error';
                response.message = 'Invalid query parameters';
                response.code = 'INVALID_QUERY';
                break;
            default:
                statusCode = 400;
                response.error = 'Database operation failed';
                response.message = err.message;
                response.code = `PRISMA_${err.code}`;
        }
    }
    else if (err instanceof Prisma.PrismaClientValidationError) {
        statusCode = 400;
        response.error = 'Validation error';
        response.message = 'Invalid data provided';
        response.code = 'VALIDATION_ERROR';
        // Extract useful validation info if possible
        const validationMatch = err.message.match(/Argument (\w+): (.+)/);
        if (validationMatch) {
            response.details = {
                field: validationMatch[1],
                issue: validationMatch[2],
            };
        }
    }
    else if (err instanceof ZodError) {
        // Handle Zod validation errors
        statusCode = 400;
        response.error = 'Validation error';
        response.code = 'VALIDATION_ERROR';
        response.details = err.errors.map(e => ({
            field: e.path.join('.'),
            message: e.message,
        }));
    }
    else if (err.name === 'JsonWebTokenError') {
        statusCode = 401;
        response.error = 'Invalid token';
        response.code = 'INVALID_TOKEN';
    }
    else if (err.name === 'TokenExpiredError') {
        statusCode = 401;
        response.error = 'Token expired';
        response.code = 'TOKEN_EXPIRED';
    }
    else if (err.name === 'MulterError') {
        statusCode = 400;
        response.error = 'File upload error';
        response.message = err.message;
        response.code = 'FILE_UPLOAD_ERROR';
    }
    else if (err.message.includes('CORS')) {
        statusCode = 403;
        response.error = 'CORS error';
        response.message = 'Cross-origin request blocked';
        response.code = 'CORS_ERROR';
    }
    else {
        // Generic error handling
        response.error = process.env.NODE_ENV === 'production'
            ? 'An unexpected error occurred'
            : err.message;
        // Don't leak stack traces in production
        if (process.env.NODE_ENV !== 'production') {
            response.details = {
                stack: err.stack,
            };
        }
    }
    res.status(statusCode).json(response);
}
// Catch unhandled routes
export function notFoundHandler(req, res) {
    res.status(404).json({
        error: 'Not Found',
        message: `Cannot ${req.method} ${req.path}`,
        code: 'ROUTE_NOT_FOUND',
        timestamp: new Date().toISOString(),
    });
}
// Common error generators
export const errors = {
    unauthorized: () => new AppError('Unauthorized', 401, 'UNAUTHORIZED'),
    forbidden: () => new AppError('Forbidden', 403, 'FORBIDDEN'),
    notFound: (resource) => new AppError(`${resource} not found`, 404, 'NOT_FOUND'),
    badRequest: (message) => new AppError(message, 400, 'BAD_REQUEST'),
    conflict: (message) => new AppError(message, 409, 'CONFLICT'),
    tooManyRequests: () => new AppError('Too many requests', 429, 'RATE_LIMIT_EXCEEDED'),
    serverError: (message = 'Internal server error') => new AppError(message, 500, 'SERVER_ERROR'),
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9taWRkbGV3YXJlL2Vycm9ySGFuZGxlci50cyIsIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEMsT0FBTyxNQUFNLE1BQU0sV0FBVyxDQUFDO0FBQy9CLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxLQUFLLENBQUM7QUFXL0IsTUFBTSxPQUFPLFFBQVMsU0FBUSxLQUFLO0lBQ2pDLFVBQVUsQ0FBUztJQUNuQixJQUFJLENBQVM7SUFDYixhQUFhLENBQVU7SUFFdkIsWUFBWSxPQUFlLEVBQUUsVUFBa0IsRUFBRSxJQUFZLEVBQUUsYUFBYSxHQUFHLElBQUk7UUFDakYsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ2YsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7UUFDN0IsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUM7UUFFbkMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDbEQsQ0FBQztDQUNGO0FBRUQsTUFBTSxDQUFDLE1BQU0sWUFBWSxHQUFHLENBQUMsRUFBWSxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBa0IsRUFBRSxFQUFFO0lBQ2hHLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDbEQsQ0FBQyxDQUFDO0FBRUYsTUFBTSxVQUFVLFlBQVksQ0FBQyxHQUFVLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxLQUFtQjtJQUN2RixJQUFJLFVBQVUsR0FBRyxHQUFHLENBQUM7SUFDckIsSUFBSSxRQUFRLEdBQWtC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LElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO0tBQ3BDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFRCwwQkFBMEI7QUFDMUIsTUFBTSxDQUFDLE1BQU0sTUFBTSxHQUFHO0lBQ3BCLFlBQVksRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLFFBQVEsQ0FBQyxjQUFjLEVBQUUsR0FBRyxFQUFFLGNBQWMsQ0FBQztJQUNyRSxTQUFTLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxRQUFRLENBQUMsV0FBVyxFQUFFLEdBQUcsRUFBRSxXQUFXLENBQUM7SUFDNUQsUUFBUSxFQUFFLENBQUMsUUFBZ0IsRUFBRSxFQUFFLENBQUMsSUFBSSxRQUFRLENBQUMsR0FBRyxRQUFRLFlBQVksRUFBRSxHQUFHLEVBQUUsV0FBVyxDQUFDO0lBQ3ZGLFVBQVUsRUFBRSxDQUFDLE9BQWUsRUFBRSxFQUFFLENBQUMsSUFBSSxRQUFRLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxhQUFhLENBQUM7SUFDMUUsUUFBUSxFQUFFLENBQUMsT0FBZSxFQUFFLEVBQUUsQ0FBQyxJQUFJLFFBQVEsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLFVBQVUsQ0FBQztJQUNyRSxlQUFlLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxRQUFRLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxFQUFFLHFCQUFxQixDQUFDO0lBQ3BGLFdBQVcsRUFBRSxDQUFDLE9BQU8sR0FBRyx1QkFBdUIsRUFBRSxFQUFFLENBQUMsSUFBSSxRQUFRLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxjQUFjLENBQUM7Q0FDL0YsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWljaGFlbG1jaXNhYWMvR2l0SHViL3RlYWNoaW5nLWVuZ2luZTIuMC9zZXJ2ZXIvc3JjL21pZGRsZXdhcmUvZXJyb3JIYW5kbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlcXVlc3QsIFJlc3BvbnNlLCBOZXh0RnVuY3Rpb24gfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IFByaXNtYSB9IGZyb20gJ0BwcmlzbWEvY2xpZW50JztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IFpvZEVycm9yIH0gZnJvbSAnem9kJztcblxuaW50ZXJmYWNlIEVycm9yUmVzcG9uc2Uge1xuICBlcnJvcjogc3RyaW5nO1xuICBtZXNzYWdlPzogc3RyaW5nO1xuICBjb2RlPzogc3RyaW5nO1xuICBkZXRhaWxzPzogYW55O1xuICB0aW1lc3RhbXA/OiBzdHJpbmc7XG4gIHBhdGg/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjbGFzcyBBcHBFcnJvciBleHRlbmRzIEVycm9yIHtcbiAgc3RhdHVzQ29kZTogbnVtYmVyO1xuICBjb2RlOiBzdHJpbmc7XG4gIGlzT3BlcmF0aW9uYWw6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3IobWVzc2FnZTogc3RyaW5nLCBzdGF0dXNDb2RlOiBudW1iZXIsIGNvZGU6IHN0cmluZywgaXNPcGVyYXRpb25hbCA9IHRydWUpIHtcbiAgICBzdXBlcihtZXNzYWdlKTtcbiAgICB0aGlzLnN0YXR1c0NvZGUgPSBzdGF0dXNDb2RlO1xuICAgIHRoaXMuY29kZSA9IGNvZGU7XG4gICAgdGhpcy5pc09wZXJhdGlvbmFsID0gaXNPcGVyYXRpb25hbDtcbiAgICBcbiAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCB0aGlzLmNvbnN0cnVjdG9yKTtcbiAgfVxufVxuXG5leHBvcnQgY29uc3QgYXN5bmNIYW5kbGVyID0gKGZuOiBGdW5jdGlvbikgPT4gKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gIFByb21pc2UucmVzb2x2ZShmbihyZXEsIHJlcywgbmV4dCkpLmNhdGNoKG5leHQpO1xufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGVycm9ySGFuZGxlcihlcnI6IEVycm9yLCByZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIF9uZXh0OiBOZXh0RnVuY3Rpb24pIHtcbiAgbGV0IHN0YXR1c0NvZGUgPSA1MDA7XG4gIGxldCByZXNwb25zZTogRXJyb3JSZXNwb25zZSA9IHtcbiAgICBlcnJvcjogJ0ludGVybmFsIFNlcnZlciBFcnJvcicsXG4gICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgcGF0aDogcmVxLnBhdGgsXG4gIH07XG5cbiAgLy8gTG9nIHRoZSBlcnJvclxuICBsb2dnZXIuZXJyb3Ioe1xuICAgIGVycixcbiAgICBtZXRob2Q6IHJlcS5tZXRob2QsXG4gICAgcGF0aDogcmVxLnBhdGgsXG4gICAgcXVlcnk6IHJlcS5xdWVyeSxcbiAgICBpcDogcmVxLmlwLFxuICAgIHVzZXJJZDogKHJlcSBhcyBhbnkpLnVzZXI/LnVzZXJJZCxcbiAgfSwgJ1JlcXVlc3QgZXJyb3InKTtcblxuICAvLyBIYW5kbGUga25vd24gZXJyb3IgdHlwZXNcbiAgaWYgKGVyciBpbnN0YW5jZW9mIEFwcEVycm9yKSB7XG4gICAgc3RhdHVzQ29kZSA9IGVyci5zdGF0dXNDb2RlO1xuICAgIHJlc3BvbnNlLmVycm9yID0gZXJyLm1lc3NhZ2U7XG4gICAgcmVzcG9uc2UuY29kZSA9IGVyci5jb2RlO1xuICB9IGVsc2UgaWYgKGVyciBpbnN0YW5jZW9mIFByaXNtYS5QcmlzbWFDbGllbnRLbm93blJlcXVlc3RFcnJvcikge1xuICAgIC8vIEhhbmRsZSBQcmlzbWEgZXJyb3JzXG4gICAgc3dpdGNoIChlcnIuY29kZSkge1xuICAgICAgY2FzZSAnUDIwMDInOlxuICAgICAgICBzdGF0dXNDb2RlID0gNDA5O1xuICAgICAgICByZXNwb25zZS5lcnJvciA9ICdEdXBsaWNhdGUgZW50cnknO1xuICAgICAgICByZXNwb25zZS5tZXNzYWdlID0gJ0EgcmVjb3JkIHdpdGggdGhpcyB2YWx1ZSBhbHJlYWR5IGV4aXN0cyc7XG4gICAgICAgIHJlc3BvbnNlLmNvZGUgPSAnRFVQTElDQVRFX0VOVFJZJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdQMjAyNSc6XG4gICAgICAgIHN0YXR1c0NvZGUgPSA0MDQ7XG4gICAgICAgIHJlc3BvbnNlLmVycm9yID0gJ1JlY29yZCBub3QgZm91bmQnO1xuICAgICAgICByZXNwb25zZS5tZXNzYWdlID0gJ1RoZSByZXF1ZXN0ZWQgcmVjb3JkIGRvZXMgbm90IGV4aXN0JztcbiAgICAgICAgcmVzcG9uc2UuY29kZSA9ICdOT1RfRk9VTkQnO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ1AyMDAzJzpcbiAgICAgICAgc3RhdHVzQ29kZSA9IDQwMDtcbiAgICAgICAgcmVzcG9uc2UuZXJyb3IgPSAnRm9yZWlnbiBrZXkgY29uc3RyYWludCBmYWlsZWQnO1xuICAgICAgICByZXNwb25zZS5tZXNzYWdlID0gJ1JlZmVyZW5jZWQgcmVjb3JkIGRvZXMgbm90IGV4aXN0JztcbiAgICAgICAgcmVzcG9uc2UuY29kZSA9ICdGT1JFSUdOX0tFWV9FUlJPUic7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnUDIwMTYnOlxuICAgICAgICBzdGF0dXNDb2RlID0gNDAwO1xuICAgICAgICByZXNwb25zZS5lcnJvciA9ICdRdWVyeSBpbnRlcnByZXRhdGlvbiBlcnJvcic7XG4gICAgICAgIHJlc3BvbnNlLm1lc3NhZ2UgPSAnSW52YWxpZCBxdWVyeSBwYXJhbWV0ZXJzJztcbiAgICAgICAgcmVzcG9uc2UuY29kZSA9ICdJTlZBTElEX1FVRVJZJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBzdGF0dXNDb2RlID0gNDAwO1xuICAgICAgICByZXNwb25zZS5lcnJvciA9ICdEYXRhYmFzZSBvcGVyYXRpb24gZmFpbGVkJztcbiAgICAgICAgcmVzcG9uc2UubWVzc2FnZSA9IGVyci5tZXNzYWdlO1xuICAgICAgICByZXNwb25zZS5jb2RlID0gYFBSSVNNQV8ke2Vyci5jb2RlfWA7XG4gICAgfVxuICB9IGVsc2UgaWYgKGVyciBpbnN0YW5jZW9mIFByaXNtYS5QcmlzbWFDbGllbnRWYWxpZGF0aW9uRXJyb3IpIHtcbiAgICBzdGF0dXNDb2RlID0gNDAwO1xuICAgIHJlc3BvbnNlLmVycm9yID0gJ1ZhbGlkYXRpb24gZXJyb3InO1xuICAgIHJlc3BvbnNlLm1lc3NhZ2UgPSAnSW52YWxpZCBkYXRhIHByb3ZpZGVkJztcbiAgICByZXNwb25zZS5jb2RlID0gJ1ZBTElEQVRJT05fRVJST1InO1xuICAgIFxuICAgIC8vIEV4dHJhY3QgdXNlZnVsIHZhbGlkYXRpb24gaW5mbyBpZiBwb3NzaWJsZVxuICAgIGNvbnN0IHZhbGlkYXRpb25NYXRjaCA9IGVyci5tZXNzYWdlLm1hdGNoKC9Bcmd1bWVudCAoXFx3Kyk6ICguKykvKTtcbiAgICBpZiAodmFsaWRhdGlvbk1hdGNoKSB7XG4gICAgICByZXNwb25zZS5kZXRhaWxzID0ge1xuICAgICAgICBmaWVsZDogdmFsaWRhdGlvbk1hdGNoWzFdLFxuICAgICAgICBpc3N1ZTogdmFsaWRhdGlvbk1hdGNoWzJdLFxuICAgICAgfTtcbiAgICB9XG4gIH0gZWxzZSBpZiAoZXJyIGluc3RhbmNlb2YgWm9kRXJyb3IpIHtcbiAgICAvLyBIYW5kbGUgWm9kIHZhbGlkYXRpb24gZXJyb3JzXG4gICAgc3RhdHVzQ29kZSA9IDQwMDtcbiAgICByZXNwb25zZS5lcnJvciA9ICdWYWxpZGF0aW9uIGVycm9yJztcbiAgICByZXNwb25zZS5jb2RlID0gJ1ZBTElEQVRJT05fRVJST1InO1xuICAgIHJlc3BvbnNlLmRldGFpbHMgPSBlcnIuZXJyb3JzLm1hcChlID0+ICh7XG4gICAgICBmaWVsZDogZS5wYXRoLmpvaW4oJy4nKSxcbiAgICAgIG1lc3NhZ2U6IGUubWVzc2FnZSxcbiAgICB9KSk7XG4gIH0gZWxzZSBpZiAoZXJyLm5hbWUgPT09ICdKc29uV2ViVG9rZW5FcnJvcicpIHtcbiAgICBzdGF0dXNDb2RlID0gNDAxO1xuICAgIHJlc3BvbnNlLmVycm9yID0gJ0ludmFsaWQgdG9rZW4nO1xuICAgIHJlc3BvbnNlLmNvZGUgPSAnSU5WQUxJRF9UT0tFTic7XG4gIH0gZWxzZSBpZiAoZXJyLm5hbWUgPT09ICdUb2tlbkV4cGlyZWRFcnJvcicpIHtcbiAgICBzdGF0dXNDb2RlID0gNDAxO1xuICAgIHJlc3BvbnNlLmVycm9yID0gJ1Rva2VuIGV4cGlyZWQnO1xuICAgIHJlc3BvbnNlLmNvZGUgPSAnVE9LRU5fRVhQSVJFRCc7XG4gIH0gZWxzZSBpZiAoZXJyLm5hbWUgPT09ICdNdWx0ZXJFcnJvcicpIHtcbiAgICBzdGF0dXNDb2RlID0gNDAwO1xuICAgIHJlc3BvbnNlLmVycm9yID0gJ0ZpbGUgdXBsb2FkIGVycm9yJztcbiAgICByZXNwb25zZS5tZXNzYWdlID0gZXJyLm1lc3NhZ2U7XG4gICAgcmVzcG9uc2UuY29kZSA9ICdGSUxFX1VQTE9BRF9FUlJPUic7XG4gIH0gZWxzZSBpZiAoZXJyLm1lc3NhZ2UuaW5jbHVkZXMoJ0NPUlMnKSkge1xuICAgIHN0YXR1c0NvZGUgPSA0MDM7XG4gICAgcmVzcG9uc2UuZXJyb3IgPSAnQ09SUyBlcnJvcic7XG4gICAgcmVzcG9uc2UubWVzc2FnZSA9ICdDcm9zcy1vcmlnaW4gcmVxdWVzdCBibG9ja2VkJztcbiAgICByZXNwb25zZS5jb2RlID0gJ0NPUlNfRVJST1InO1xuICB9IGVsc2Uge1xuICAgIC8vIEdlbmVyaWMgZXJyb3IgaGFuZGxpbmdcbiAgICByZXNwb25zZS5lcnJvciA9IHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAncHJvZHVjdGlvbicgXG4gICAgICA/ICdBbiB1bmV4cGVjdGVkIGVycm9yIG9jY3VycmVkJyBcbiAgICAgIDogZXJyLm1lc3NhZ2U7XG4gICAgXG4gICAgLy8gRG9uJ3QgbGVhayBzdGFjayB0cmFjZXMgaW4gcHJvZHVjdGlvblxuICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7XG4gICAgICByZXNwb25zZS5kZXRhaWxzID0ge1xuICAgICAgICBzdGFjazogZXJyLnN0YWNrLFxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICByZXMuc3RhdHVzKHN0YXR1c0NvZGUpLmpzb24ocmVzcG9uc2UpO1xufVxuXG4vLyBDYXRjaCB1bmhhbmRsZWQgcm91dGVzXG5leHBvcnQgZnVuY3Rpb24gbm90Rm91bmRIYW5kbGVyKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkge1xuICByZXMuc3RhdHVzKDQwNCkuanNvbih7XG4gICAgZXJyb3I6ICdOb3QgRm91bmQnLFxuICAgIG1lc3NhZ2U6IGBDYW5ub3QgJHtyZXEubWV0aG9kfSAke3JlcS5wYXRofWAsXG4gICAgY29kZTogJ1JPVVRFX05PVF9GT1VORCcsXG4gICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gIH0pO1xufVxuXG4vLyBDb21tb24gZXJyb3IgZ2VuZXJhdG9yc1xuZXhwb3J0IGNvbnN0IGVycm9ycyA9IHtcbiAgdW5hdXRob3JpemVkOiAoKSA9PiBuZXcgQXBwRXJyb3IoJ1VuYXV0aG9yaXplZCcsIDQwMSwgJ1VOQVVUSE9SSVpFRCcpLFxuICBmb3JiaWRkZW46ICgpID0+IG5ldyBBcHBFcnJvcignRm9yYmlkZGVuJywgNDAzLCAnRk9SQklEREVOJyksXG4gIG5vdEZvdW5kOiAocmVzb3VyY2U6IHN0cmluZykgPT4gbmV3IEFwcEVycm9yKGAke3Jlc291cmNlfSBub3QgZm91bmRgLCA0MDQsICdOT1RfRk9VTkQnKSxcbiAgYmFkUmVxdWVzdDogKG1lc3NhZ2U6IHN0cmluZykgPT4gbmV3IEFwcEVycm9yKG1lc3NhZ2UsIDQwMCwgJ0JBRF9SRVFVRVNUJyksXG4gIGNvbmZsaWN0OiAobWVzc2FnZTogc3RyaW5nKSA9PiBuZXcgQXBwRXJyb3IobWVzc2FnZSwgNDA5LCAnQ09ORkxJQ1QnKSxcbiAgdG9vTWFueVJlcXVlc3RzOiAoKSA9PiBuZXcgQXBwRXJyb3IoJ1RvbyBtYW55IHJlcXVlc3RzJywgNDI5LCAnUkFURV9MSU1JVF9FWENFRURFRCcpLFxuICBzZXJ2ZXJFcnJvcjogKG1lc3NhZ2UgPSAnSW50ZXJuYWwgc2VydmVyIGVycm9yJykgPT4gbmV3IEFwcEVycm9yKG1lc3NhZ2UsIDUwMCwgJ1NFUlZFUl9FUlJPUicpLFxufTsiXSwidmVyc2lvbiI6M30=