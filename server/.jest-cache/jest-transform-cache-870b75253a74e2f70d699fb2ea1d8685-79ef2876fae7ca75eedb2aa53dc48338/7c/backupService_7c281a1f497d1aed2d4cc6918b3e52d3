eda868dcf384dc0caf1a78fc4f61dcfe
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import archiver from 'archiver';
import unzipper from 'unzipper';
import { S3Client, PutObjectCommand, GetObjectCommand } from '@aws-sdk/client-s3';
import cron from 'node-cron';
// Get directory name in ES module
const __filename_backup = fileURLToPath(import.meta.url);
const __dirname_backup = path.dirname(__filename_backup);
let s3 = null;
const bucket = process.env.BACKUP_BUCKET;
if (process.env.BACKUP_PROVIDER === 's3' && bucket) {
    s3 = new S3Client({ region: process.env.AWS_REGION || 'us-east-1' });
}
function getDbPath() {
    const url = process.env.DATABASE_URL || '';
    const match = url.match(/file:(.*)/);
    if (!match) {
        throw new Error('DATABASE_URL must be sqlite');
    }
    return path.resolve(process.cwd(), match[1]);
}
function getUploadsPath() {
    return path.join(__dirname_backup, '../uploads');
}
/** Create zip archive containing database and uploads */
export async function createBackup() {
    const archive = archiver('zip');
    const chunks = [];
    archive.on('data', (d) => chunks.push(d));
    const db = getDbPath();
    archive.file(db, { name: path.basename(db) });
    const uploads = getUploadsPath();
    if (fs.existsSync(uploads)) {
        archive.directory(uploads, 'uploads');
    }
    await archive.finalize();
    return Buffer.concat(chunks);
}
/** Restore database and uploads from provided zip buffer */
export async function restoreBackup(data) {
    const dir = await unzipper.Open.buffer(data);
    const db = getDbPath();
    for (const entry of dir.files) {
        const dest = entry.path === path.basename(db)
            ? db
            : path.join(getUploadsPath(), entry.path.replace(/^uploads\/?/, ''));
        await fs.promises.mkdir(path.dirname(dest), { recursive: true });
        await new Promise((res, rej) => {
            entry.stream().pipe(fs.createWriteStream(dest)).on('finish', res).on('error', rej);
        });
    }
}
/** Save backup buffer to configured provider */
export async function saveBackup(data) {
    const key = `backup-${Date.now()}.zip`;
    if (s3 && bucket) {
        await s3.send(new PutObjectCommand({ Bucket: bucket, Key: key, Body: data }));
        return `s3://${bucket}/${key}`;
    }
    const backupDir = path.join(__dirname_backup, '../backups');
    await fs.promises.mkdir(backupDir, { recursive: true });
    const file = path.join(backupDir, key);
    await fs.promises.writeFile(file, data);
    return file;
}
/** Load backup buffer from provider */
export async function loadBackup(key) {
    if (s3 && bucket && key.startsWith('s3://')) {
        const realKey = key.slice(`s3://${bucket}/`.length);
        const res = await s3.send(new GetObjectCommand({ Bucket: bucket, Key: realKey }));
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        const stream = res.Body;
        const chunks = [];
        for await (const chunk of stream)
            chunks.push(Buffer.from(chunk));
        return Buffer.concat(chunks);
    }
    return fs.promises.readFile(key);
}
/** Create backup and store using provider */
export async function runBackupJob() {
    const data = await createBackup();
    return saveBackup(data);
}
/** Schedule automatic backups using cron */
export function scheduleBackups() {
    const cronExpr = process.env.BACKUP_CRON || '0 2 * * *';
    cron.schedule(cronExpr, runBackupJob);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9zZXJ2aWNlcy9iYWNrdXBTZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLElBQUksQ0FBQztBQUNwQixPQUFPLElBQUksTUFBTSxNQUFNLENBQUM7QUFDeEIsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLEtBQUssQ0FBQztBQUNwQyxPQUFPLFFBQVEsTUFBTSxVQUFVLENBQUM7QUFDaEMsT0FBTyxRQUFRLE1BQU0sVUFBVSxDQUFDO0FBQ2hDLE9BQU8sRUFBRSxRQUFRLEVBQUUsZ0JBQWdCLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNsRixPQUFPLElBQUksTUFBTSxXQUFXLENBQUM7QUFFN0Isa0NBQWtDO0FBQ2xDLE1BQU0saUJBQWlCLEdBQUcsYUFBYSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDekQsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFFekQsSUFBSSxFQUFFLEdBQW9CLElBQUksQ0FBQztBQUMvQixNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQztBQUN6QyxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxLQUFLLElBQUksSUFBSSxNQUFNLEVBQUUsQ0FBQztJQUNuRCxFQUFFLEdBQUcsSUFBSSxRQUFRLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksV0FBVyxFQUFFLENBQUMsQ0FBQztBQUN2RSxDQUFDO0FBRUQsU0FBUyxTQUFTO0lBQ2hCLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxJQUFJLEVBQUUsQ0FBQztJQUMzQyxNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lB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LE1BQU0sS0FBSyxJQUFJLE1BQU07WUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUNsRSxPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQUNELE9BQU8sRUFBRSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDbkMsQ0FBQztBQUVELDZDQUE2QztBQUM3QyxNQUFNLENBQUMsS0FBSyxVQUFVLFlBQVk7SUFDaEMsTUFBTSxJQUFJLEdBQUcsTUFBTSxZQUFZLEVBQUUsQ0FBQztJQUNsQyxPQUFPLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUMxQixDQUFDO0FBRUQsNENBQTRDO0FBQzVDLE1BQU0sVUFBVSxlQUFlO0lBQzdCLE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxJQUFJLFdBQVcsQ0FBQztJQUN4RCxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxZQUFZLENBQUMsQ0FBQztBQUN4QyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9taWNoYWVsbWNpc2FhYy9HaXRIdWIvdGVhY2hpbmctZW5naW5lMi4wL3NlcnZlci9zcmMvc2VydmljZXMvYmFja3VwU2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBmaWxlVVJMVG9QYXRoIH0gZnJvbSAndXJsJztcbmltcG9ydCBhcmNoaXZlciBmcm9tICdhcmNoaXZlcic7XG5pbXBvcnQgdW56aXBwZXIgZnJvbSAndW56aXBwZXInO1xuaW1wb3J0IHsgUzNDbGllbnQsIFB1dE9iamVjdENvbW1hbmQsIEdldE9iamVjdENvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtczMnO1xuaW1wb3J0IGNyb24gZnJvbSAnbm9kZS1jcm9uJztcblxuLy8gR2V0IGRpcmVjdG9yeSBuYW1lIGluIEVTIG1vZHVsZVxuY29uc3QgX19maWxlbmFtZV9iYWNrdXAgPSBmaWxlVVJMVG9QYXRoKGltcG9ydC5tZXRhLnVybCk7XG5jb25zdCBfX2Rpcm5hbWVfYmFja3VwID0gcGF0aC5kaXJuYW1lKF9fZmlsZW5hbWVfYmFja3VwKTtcblxubGV0IHMzOiBTM0NsaWVudCB8IG51bGwgPSBudWxsO1xuY29uc3QgYnVja2V0ID0gcHJvY2Vzcy5lbnYuQkFDS1VQX0JVQ0tFVDtcbmlmIChwcm9jZXNzLmVudi5CQUNLVVBfUFJPVklERVIgPT09ICdzMycgJiYgYnVja2V0KSB7XG4gIHMzID0gbmV3IFMzQ2xpZW50KHsgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIHx8ICd1cy1lYXN0LTEnIH0pO1xufVxuXG5mdW5jdGlvbiBnZXREYlBhdGgoKSB7XG4gIGNvbnN0IHVybCA9IHByb2Nlc3MuZW52LkRBVEFCQVNFX1VSTCB8fCAnJztcbiAgY29uc3QgbWF0Y2ggPSB1cmwubWF0Y2goL2ZpbGU6KC4qKS8pO1xuICBpZiAoIW1hdGNoKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdEQVRBQkFTRV9VUkwgbXVzdCBiZSBzcWxpdGUnKTtcbiAgfVxuICByZXR1cm4gcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksIG1hdGNoWzFdKTtcbn1cblxuZnVuY3Rpb24gZ2V0VXBsb2Fkc1BhdGgoKSB7XG4gIHJldHVybiBwYXRoLmpvaW4oX19kaXJuYW1lX2JhY2t1cCwgJy4uL3VwbG9hZHMnKTtcbn1cblxuLyoqIENyZWF0ZSB6aXAgYXJjaGl2ZSBjb250YWluaW5nIGRhdGFiYXNlIGFuZCB1cGxvYWRzICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlQmFja3VwKCk6IFByb21pc2U8QnVmZmVyPiB7XG4gIGNvbnN0IGFyY2hpdmUgPSBhcmNoaXZlcignemlwJyk7XG4gIGNvbnN0IGNodW5rczogQnVmZmVyW10gPSBbXTtcbiAgYXJjaGl2ZS5vbignZGF0YScsIChkOiBCdWZmZXIpID0+IGNodW5rcy5wdXNoKGQpKTtcbiAgY29uc3QgZGIgPSBnZXREYlBhdGgoKTtcbiAgYXJjaGl2ZS5maWxlKGRiLCB7IG5hbWU6IHBhdGguYmFzZW5hbWUoZGIpIH0pO1xuICBjb25zdCB1cGxvYWRzID0gZ2V0VXBsb2Fkc1BhdGgoKTtcbiAgaWYgKGZzLmV4aXN0c1N5bmModXBsb2FkcykpIHtcbiAgICBhcmNoaXZlLmRpcmVjdG9yeSh1cGxvYWRzLCAndXBsb2FkcycpO1xuICB9XG4gIGF3YWl0IGFyY2hpdmUuZmluYWxpemUoKTtcbiAgcmV0dXJuIEJ1ZmZlci5jb25jYXQoY2h1bmtzKTtcbn1cblxuLyoqIFJlc3RvcmUgZGF0YWJhc2UgYW5kIHVwbG9hZHMgZnJvbSBwcm92aWRlZCB6aXAgYnVmZmVyICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVzdG9yZUJhY2t1cChkYXRhOiBCdWZmZXIpOiBQcm9taXNlPHZvaWQ+IHtcbiAgY29uc3QgZGlyID0gYXdhaXQgdW56aXBwZXIuT3Blbi5idWZmZXIoZGF0YSk7XG4gIGNvbnN0IGRiID0gZ2V0RGJQYXRoKCk7XG4gIGZvciAoY29uc3QgZW50cnkgb2YgZGlyLmZpbGVzKSB7XG4gICAgY29uc3QgZGVzdCA9XG4gICAgICBlbnRyeS5wYXRoID09PSBwYXRoLmJhc2VuYW1lKGRiKVxuICAgICAgICA/IGRiXG4gICAgICAgIDogcGF0aC5qb2luKGdldFVwbG9hZHNQYXRoKCksIGVudHJ5LnBhdGgucmVwbGFjZSgvXnVwbG9hZHNcXC8/LywgJycpKTtcbiAgICBhd2FpdCBmcy5wcm9taXNlcy5ta2RpcihwYXRoLmRpcm5hbWUoZGVzdCksIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgIGF3YWl0IG5ldyBQcm9taXNlPHZvaWQ+KChyZXMsIHJlaikgPT4ge1xuICAgICAgZW50cnkuc3RyZWFtKCkucGlwZShmcy5jcmVhdGVXcml0ZVN0cmVhbShkZXN0KSkub24oJ2ZpbmlzaCcsIHJlcykub24oJ2Vycm9yJywgcmVqKTtcbiAgICB9KTtcbiAgfVxufVxuXG4vKiogU2F2ZSBiYWNrdXAgYnVmZmVyIHRvIGNvbmZpZ3VyZWQgcHJvdmlkZXIgKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzYXZlQmFja3VwKGRhdGE6IEJ1ZmZlcik6IFByb21pc2U8c3RyaW5nPiB7XG4gIGNvbnN0IGtleSA9IGBiYWNrdXAtJHtEYXRlLm5vdygpfS56aXBgO1xuICBpZiAoczMgJiYgYnVja2V0KSB7XG4gICAgYXdhaXQgczMuc2VuZChuZXcgUHV0T2JqZWN0Q29tbWFuZCh7IEJ1Y2tldDogYnVja2V0LCBLZXk6IGtleSwgQm9keTogZGF0YSB9KSk7XG4gICAgcmV0dXJuIGBzMzovLyR7YnVja2V0fS8ke2tleX1gO1xuICB9XG4gIGNvbnN0IGJhY2t1cERpciA9IHBhdGguam9pbihfX2Rpcm5hbWVfYmFja3VwLCAnLi4vYmFja3VwcycpO1xuICBhd2FpdCBmcy5wcm9taXNlcy5ta2RpcihiYWNrdXBEaXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICBjb25zdCBmaWxlID0gcGF0aC5qb2luKGJhY2t1cERpciwga2V5KTtcbiAgYXdhaXQgZnMucHJvbWlzZXMud3JpdGVGaWxlKGZpbGUsIGRhdGEpO1xuICByZXR1cm4gZmlsZTtcbn1cblxuLyoqIExvYWQgYmFja3VwIGJ1ZmZlciBmcm9tIHByb3ZpZGVyICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbG9hZEJhY2t1cChrZXk6IHN0cmluZyk6IFByb21pc2U8QnVmZmVyPiB7XG4gIGlmIChzMyAmJiBidWNrZXQgJiYga2V5LnN0YXJ0c1dpdGgoJ3MzOi8vJykpIHtcbiAgICBjb25zdCByZWFsS2V5ID0ga2V5LnNsaWNlKGBzMzovLyR7YnVja2V0fS9gLmxlbmd0aCk7XG4gICAgY29uc3QgcmVzID0gYXdhaXQgczMuc2VuZChuZXcgR2V0T2JqZWN0Q29tbWFuZCh7IEJ1Y2tldDogYnVja2V0LCBLZXk6IHJlYWxLZXkgfSkpO1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gICAgY29uc3Qgc3RyZWFtID0gcmVzLkJvZHkgYXMgdW5rbm93biBhcyBOb2RlSlMuUmVhZGFibGVTdHJlYW07XG4gICAgY29uc3QgY2h1bmtzOiBCdWZmZXJbXSA9IFtdO1xuICAgIGZvciBhd2FpdCAoY29uc3QgY2h1bmsgb2Ygc3RyZWFtKSBjaHVua3MucHVzaChCdWZmZXIuZnJvbShjaHVuaykpO1xuICAgIHJldHVybiBCdWZmZXIuY29uY2F0KGNodW5rcyk7XG4gIH1cbiAgcmV0dXJuIGZzLnByb21pc2VzLnJlYWRGaWxlKGtleSk7XG59XG5cbi8qKiBDcmVhdGUgYmFja3VwIGFuZCBzdG9yZSB1c2luZyBwcm92aWRlciAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJ1bkJhY2t1cEpvYigpOiBQcm9taXNlPHN0cmluZz4ge1xuICBjb25zdCBkYXRhID0gYXdhaXQgY3JlYXRlQmFja3VwKCk7XG4gIHJldHVybiBzYXZlQmFja3VwKGRhdGEpO1xufVxuXG4vKiogU2NoZWR1bGUgYXV0b21hdGljIGJhY2t1cHMgdXNpbmcgY3JvbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNjaGVkdWxlQmFja3VwcygpIHtcbiAgY29uc3QgY3JvbkV4cHIgPSBwcm9jZXNzLmVudi5CQUNLVVBfQ1JPTiB8fCAnMCAyICogKiAqJztcbiAgY3Jvbi5zY2hlZHVsZShjcm9uRXhwciwgcnVuQmFja3VwSm9iKTtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==