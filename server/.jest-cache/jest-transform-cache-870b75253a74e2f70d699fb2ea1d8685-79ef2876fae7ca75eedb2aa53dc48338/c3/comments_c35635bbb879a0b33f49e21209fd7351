7b6264d76f93c16669622e49a4af1e37
/**
 * Plan Comments Routes
 * Handles commenting and feedback on shared plans
 */
import { Router } from 'express';
import { z } from 'zod';
import { authenticate } from '@/middleware/authenticate';
import { asyncHandler } from '@/middleware/errorHandler';
import logger from '@/logger';
// Validation schemas
const createCommentSchema = z.object({
    planType: z.enum(['long-range', 'unit', 'lesson', 'daybook']),
    planId: z.string(),
    content: z.string().min(1).max(5000),
    parentId: z.string().optional(),
});
const updateCommentSchema = z.object({
    content: z.string().min(1).max(5000).optional(),
    isResolved: z.boolean().optional(),
    isPinned: z.boolean().optional(),
});
export function commentRoutes(prisma) {
    const router = Router();
    // Apply authentication to all routes
    router.use(authenticate);
    // Helper function to check if user has access to comment on a plan
    async function checkCommentAccess(planType, planId, userId) {
        // Check if user owns the plan
        let isOwner = false;
        switch (planType) {
            case 'long-range': {
                const lrPlan = await prisma.longRangePlan.findUnique({
                    where: { id: planId },
                });
                isOwner = lrPlan?.userId === userId;
                break;
            }
            case 'unit': {
                const unitPlan = await prisma.unitPlan.findUnique({
                    where: { id: planId },
                });
                isOwner = unitPlan?.userId === userId;
                break;
            }
            case 'lesson': {
                const lessonPlan = await prisma.eTFOLessonPlan.findUnique({
                    where: { id: planId },
                });
                isOwner = lessonPlan?.userId === userId;
                break;
            }
            case 'daybook': {
                const daybookEntry = await prisma.daybookEntry.findUnique({
                    where: { id: planId },
                });
                isOwner = daybookEntry?.userId === userId;
                break;
            }
        }
        if (isOwner)
            return true;
        // Check if plan is shared with user and commenting is allowed
        const sharedPlan = await prisma.sharedPlan.findFirst({
            where: {
                planType,
                planId,
                OR: [{ sharedWithId: userId }, { teamId: { not: null } }],
                canComment: true,
            },
        });
        if (sharedPlan) {
            // If shared with team, check team membership
            if (sharedPlan.teamId) {
                const isMember = await prisma.teamMember.findFirst({
                    where: { teamId: sharedPlan.teamId, userId },
                });
                return !!isMember;
            }
            return true;
        }
        return false;
    }
    // Get comments for a plan
    router.get('/', asyncHandler(async (req, res) => {
        const userId = req.user.id;
        const { planType, planId } = req.query;
        if (!planType || !planId) {
            return res.status(400).json({ error: 'planType and planId are required' });
        }
        // Check access
        const hasAccess = await checkCommentAccess(planType, planId, userId);
        if (!hasAccess) {
            return res.status(403).json({ error: 'Access denied' });
        }
        const comments = await prisma.planComment.findMany({
            where: {
                planType: planType,
                planId: planId,
                parentId: null, // Only get top-level comments
            },
            include: {
                user: {
                    select: { id: true, name: true, email: true },
                },
                replies: {
                    include: {
                        user: {
                            select: { id: true, name: true, email: true },
                        },
                    },
                    orderBy: { createdAt: 'asc' },
                },
            },
            orderBy: [{ isPinned: 'desc' }, { createdAt: 'desc' }],
        });
        res.json(comments);
    }));
    // Create a comment
    router.post('/', asyncHandler(async (req, res) => {
        const userId = req.user.id;
        const { planType, planId, content, parentId } = createCommentSchema.parse(req.body);
        // Check access
        const hasAccess = await checkCommentAccess(planType, planId, userId);
        if (!hasAccess) {
            return res
                .status(403)
                .json({ error: 'You do not have permission to comment on this plan' });
        }
        // If replying to a comment, verify parent exists
        if (parentId) {
            const parentComment = await prisma.planComment.findUnique({
                where: { id: parentId },
            });
            if (!parentComment ||
                parentComment.planType !== planType ||
                parentComment.planId !== planId) {
                return res.status(400).json({ error: 'Invalid parent comment' });
            }
        }
        const comment = await prisma.planComment.create({
            data: {
                planType,
                planId,
                userId,
                content,
                parentId,
            },
            include: {
                user: {
                    select: { id: true, name: true, email: true },
                },
            },
        });
        logger.info(`Comment created on ${planType}/${planId} by user ${userId}`);
        res.status(201).json(comment);
    }));
    // Update a comment
    router.patch('/:commentId', asyncHandler(async (req, res) => {
        const { commentId } = req.params;
        const userId = req.user.id;
        const updates = updateCommentSchema.parse(req.body);
        const comment = await prisma.planComment.findUnique({
            where: { id: commentId },
        });
        if (!comment) {
            return res.status(404).json({ error: 'Comment not found' });
        }
        // Check permissions
        const isAuthor = comment.userId === userId;
        const hasAccess = await checkCommentAccess(comment.planType, comment.planId, userId);
        if (!hasAccess) {
            return res.status(403).json({ error: 'Access denied' });
        }
        // Only author can edit content
        if (updates.content !== undefined && !isAuthor) {
            return res.status(403).json({ error: 'Only the comment author can edit the content' });
        }
        // Plan owner can pin/resolve comments
        const planOwnerChecks = {
            'long-range': async () => {
                const plan = await prisma.longRangePlan.findUnique({
                    where: { id: comment.planId },
                });
                return plan?.userId === userId;
            },
            unit: async () => {
                const plan = await prisma.unitPlan.findUnique({
                    where: { id: comment.planId },
                });
                return plan?.userId === userId;
            },
            lesson: async () => {
                const plan = await prisma.eTFOLessonPlan.findUnique({
                    where: { id: comment.planId },
                });
                return plan?.userId === userId;
            },
            daybook: async () => {
                const plan = await prisma.daybookEntry.findUnique({
                    where: { id: comment.planId },
                });
                return plan?.userId === userId;
            },
        };
        const isPlanOwner = await planOwnerChecks[comment.planType]?.();
        if ((updates.isPinned !== undefined || updates.isResolved !== undefined) && !isPlanOwner) {
            return res.status(403).json({ error: 'Only the plan owner can pin or resolve comments' });
        }
        const updated = await prisma.planComment.update({
            where: { id: commentId },
            data: updates,
            include: {
                user: {
                    select: { id: true, name: true, email: true },
                },
            },
        });
        res.json(updated);
    }));
    // Delete a comment
    router.delete('/:commentId', asyncHandler(async (req, res) => {
        const { commentId } = req.params;
        const userId = req.user.id;
        const comment = await prisma.planComment.findUnique({
            where: { id: commentId },
            include: {
                _count: {
                    select: { replies: true },
                },
            },
        });
        if (!comment) {
            return res.status(404).json({ error: 'Comment not found' });
        }
        // Only author can delete their comment
        if (comment.userId !== userId) {
            return res.status(403).json({ error: 'Only the comment author can delete the comment' });
        }
        // Don't allow deletion if there are replies
        if (comment._count.replies > 0) {
            return res.status(400).json({ error: 'Cannot delete a comment with replies' });
        }
        await prisma.planComment.delete({
            where: { id: commentId },
        });
        logger.info(`Comment ${commentId} deleted by user ${userId}`);
        res.status(204).send();
    }));
    // Get comment statistics for a plan
    router.get('/stats', asyncHandler(async (req, res) => {
        const userId = req.user.id;
        const { planType, planId } = req.query;
        if (!planType || !planId) {
            return res.status(400).json({ error: 'planType and planId are required' });
        }
        // Check access
        const hasAccess = await checkCommentAccess(planType, planId, userId);
        if (!hasAccess) {
            return res.status(403).json({ error: 'Access denied' });
        }
        const [total, resolved, unresolved] = await Promise.all([
            prisma.planComment.count({
                where: {
                    planType: planType,
                    planId: planId,
                },
            }),
            prisma.planComment.count({
                where: {
                    planType: planType,
                    planId: planId,
                    isResolved: true,
                },
            }),
            prisma.planComment.count({
                where: {
                    planType: planType,
                    planId: planId,
                    isResolved: false,
                },
            }),
        ]);
        res.json({
            total,
            resolved,
            unresolved,
        });
    }));
    return router;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9yb3V0ZXMvY29tbWVudHMudHMiLCJtYXBwaW5ncyI6IkFBQUE7OztHQUdHO0FBRUgsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUVqQyxPQUFPLEVBQUUsQ0FBQyxFQUFFLE1BQU0sS0FBSyxDQUFDO0FBQ3hCLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDekQsT0FBTyxNQUFNLE1BQU0sVUFBVSxDQUFDO0FBRTlCLHFCQUFxQjtBQUNyQixNQUFNLG1CQUFtQixHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDbkMsUUFBUSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxZQUFZLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxTQUFTLENBQUMsQ0FBQztJQUM3RCxNQUFNLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRTtJQUNsQixPQUFPLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO0lBQ3BDLFFBQVEsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0NBQ2hDLENBQUMsQ0FBQztBQUVILE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUNuQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFO0lBQy9DLFVBQVUsRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsUUFBUSxFQUFFO0lBQ2xDLFFBQVEsRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsUUFBUSxFQUFFO0NBQ2pDLENBQUMsQ0FB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O1FBQ2YsTUFBTSxTQUFTLEdBQUcsTUFBTSxrQkFBa0IsQ0FBQyxRQUFrQixFQUFFLE1BQWdCLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDekYsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ2YsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxlQUFlLEVBQUUsQ0FBQyxDQUFDO1FBQzFELENBQUM7UUFFRCxNQUFNLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxVQUFVLENBQUMsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUM7WUFDdEQsTUFBTSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUM7Z0JBQ3ZCLEtBQUssRUFBRTtvQkFDTCxRQUFRLEVBQUUsUUFBa0I7b0JBQzVCLE1BQU0sRUFBRSxNQUFnQjtpQkFDekI7YUFDRixDQUFDO1lBQ0YsTUFBTSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUM7Z0JBQ3ZCLEtBQUssRUFBRTtvQkFDTCxRQUFRLEVBQUUsUUFBa0I7b0JBQzVCLE1BQU0sRUFBRSxNQUFnQjtvQkFDeEIsVUFBVSxFQUFFLElBQUk7aUJBQ2pCO2FBQ0YsQ0FBQztZQUNGLE1BQU0sQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDO2dCQUN2QixLQUFLLEVBQUU7b0JBQ0wsUUFBUSxFQUFFLFFBQWtCO29CQUM1QixNQUFNLEVBQUUsTUFBZ0I7b0JBQ3hCLFVBQVUsRUFBRSxLQUFLO2lCQUNsQjthQUNGLENBQUM7U0FDSCxDQUFDLENBQUM7UUFFSCxHQUFHLENBQUMsSUFBSSxDQUFDO1lBQ1AsS0FBSztZQUNMLFFBQVE7WUFDUixVQUFVO1NBQ1gsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUVGLE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9yb3V0ZXMvY29tbWVudHMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBQbGFuIENvbW1lbnRzIFJvdXRlc1xuICogSGFuZGxlcyBjb21tZW50aW5nIGFuZCBmZWVkYmFjayBvbiBzaGFyZWQgcGxhbnNcbiAqL1xuXG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IFByaXNtYUNsaWVudCB9IGZyb20gJ0B0ZWFjaGluZy1lbmdpbmUvZGF0YWJhc2UnO1xuaW1wb3J0IHsgeiB9IGZyb20gJ3pvZCc7XG5pbXBvcnQgeyBhdXRoZW50aWNhdGUgfSBmcm9tICdAL21pZGRsZXdhcmUvYXV0aGVudGljYXRlJztcbmltcG9ydCB7IGFzeW5jSGFuZGxlciB9IGZyb20gJ0AvbWlkZGxld2FyZS9lcnJvckhhbmRsZXInO1xuaW1wb3J0IGxvZ2dlciBmcm9tICdAL2xvZ2dlcic7XG5cbi8vIFZhbGlkYXRpb24gc2NoZW1hc1xuY29uc3QgY3JlYXRlQ29tbWVudFNjaGVtYSA9IHoub2JqZWN0KHtcbiAgcGxhblR5cGU6IHouZW51bShbJ2xvbmctcmFuZ2UnLCAndW5pdCcsICdsZXNzb24nLCAnZGF5Ym9vayddKSxcbiAgcGxhbklkOiB6LnN0cmluZygpLFxuICBjb250ZW50OiB6LnN0cmluZygpLm1pbigxKS5tYXgoNTAwMCksXG4gIHBhcmVudElkOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG59KTtcblxuY29uc3QgdXBkYXRlQ29tbWVudFNjaGVtYSA9IHoub2JqZWN0KHtcbiAgY29udGVudDogei5zdHJpbmcoKS5taW4oMSkubWF4KDUwMDApLm9wdGlvbmFsKCksXG4gIGlzUmVzb2x2ZWQ6IHouYm9vbGVhbigpLm9wdGlvbmFsKCksXG4gIGlzUGlubmVkOiB6LmJvb2xlYW4oKS5vcHRpb25hbCgpLFxufSk7XG5cbmV4cG9ydCBmdW5jdGlvbiBjb21tZW50Um91dGVzKHByaXNtYTogUHJpc21hQ2xpZW50KTogUm91dGVyIHtcbiAgY29uc3Qgcm91dGVyID0gUm91dGVyKCk7XG5cbiAgLy8gQXBwbHkgYXV0aGVudGljYXRpb24gdG8gYWxsIHJvdXRlc1xuICByb3V0ZXIudXNlKGF1dGhlbnRpY2F0ZSk7XG5cbiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNoZWNrIGlmIHVzZXIgaGFzIGFjY2VzcyB0byBjb21tZW50IG9uIGEgcGxhblxuICBhc3luYyBmdW5jdGlvbiBjaGVja0NvbW1lbnRBY2Nlc3MoXG4gICAgcGxhblR5cGU6IHN0cmluZyxcbiAgICBwbGFuSWQ6IHN0cmluZyxcbiAgICB1c2VySWQ6IG51bWJlcixcbiAgKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgLy8gQ2hlY2sgaWYgdXNlciBvd25zIHRoZSBwbGFuXG4gICAgbGV0IGlzT3duZXIgPSBmYWxzZTtcbiAgICBzd2l0Y2ggKHBsYW5UeXBlKSB7XG4gICAgICBjYXNlICdsb25nLXJhbmdlJzoge1xuICAgICAgICBjb25zdCBsclBsYW4gPSBhd2FpdCBwcmlzbWEubG9uZ1JhbmdlUGxhbi5maW5kVW5pcXVlKHtcbiAgICAgICAgICB3aGVyZTogeyBpZDogcGxhbklkIH0sXG4gICAgICAgIH0pO1xuICAgICAgICBpc093bmVyID0gbHJQbGFuPy51c2VySWQgPT09IHVzZXJJZDtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG5cbiAgICAgIGNhc2UgJ3VuaXQnOiB7XG4gICAgICAgIGNvbnN0IHVuaXRQbGFuID0gYXdhaXQgcHJpc21hLnVuaXRQbGFuLmZpbmRVbmlxdWUoe1xuICAgICAgICAgIHdoZXJlOiB7IGlkOiBwbGFuSWQgfSxcbiAgICAgICAgfSk7XG4gICAgICAgIGlzT3duZXIgPSB1bml0UGxhbj8udXNlcklkID09PSB1c2VySWQ7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuXG4gICAgICBjYXNlICdsZXNzb24nOiB7XG4gICAgICAgIGNvbnN0IGxlc3NvblBsYW4gPSBhd2FpdCBwcmlzbWEuZVRGT0xlc3NvblBsYW4uZmluZFVuaXF1ZSh7XG4gICAgICAgICAgd2hlcmU6IHsgaWQ6IHBsYW5JZCB9LFxuICAgICAgICB9KTtcbiAgICAgICAgaXNPd25lciA9IGxlc3NvblBsYW4/LnVzZXJJZCA9PT0gdXNlcklkO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cblxuICAgICAgY2FzZSAnZGF5Ym9vayc6IHtcbiAgICAgICAgY29uc3QgZGF5Ym9va0VudHJ5ID0gYXdhaXQgcHJpc21hLmRheWJvb2tFbnRyeS5maW5kVW5pcXVlKHtcbiAgICAgICAgICB3aGVyZTogeyBpZDogcGxhbklkIH0sXG4gICAgICAgIH0pO1xuICAgICAgICBpc093bmVyID0gZGF5Ym9va0VudHJ5Py51c2VySWQgPT09IHVzZXJJZDtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGlzT3duZXIpIHJldHVybiB0cnVlO1xuXG4gICAgLy8gQ2hlY2sgaWYgcGxhbiBpcyBzaGFyZWQgd2l0aCB1c2VyIGFuZCBjb21tZW50aW5nIGlzIGFsbG93ZWRcbiAgICBjb25zdCBzaGFyZWRQbGFuID0gYXdhaXQgcHJpc21hLnNoYXJlZFBsYW4uZmluZEZpcnN0KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIHBsYW5UeXBlLFxuICAgICAgICBwbGFuSWQsXG4gICAgICAgIE9SOiBbeyBzaGFyZWRXaXRoSWQ6IHVzZXJJZCB9LCB7IHRlYW1JZDogeyBub3Q6IG51bGwgfSB9XSxcbiAgICAgICAgY2FuQ29tbWVudDogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoc2hhcmVkUGxhbikge1xuICAgICAgLy8gSWYgc2hhcmVkIHdpdGggdGVhbSwgY2hlY2sgdGVhbSBtZW1iZXJzaGlwXG4gICAgICBpZiAoc2hhcmVkUGxhbi50ZWFtSWQpIHtcbiAgICAgICAgY29uc3QgaXNNZW1iZXIgPSBhd2FpdCBwcmlzbWEudGVhbU1lbWJlci5maW5kRmlyc3Qoe1xuICAgICAgICAgIHdoZXJlOiB7IHRlYW1JZDogc2hhcmVkUGxhbi50ZWFtSWQsIHVzZXJJZCB9LFxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuICEhaXNNZW1iZXI7XG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvLyBHZXQgY29tbWVudHMgZm9yIGEgcGxhblxuICByb3V0ZXIuZ2V0KFxuICAgICcvJyxcbiAgICBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuaWQ7XG4gICAgICBjb25zdCB7IHBsYW5UeXBlLCBwbGFuSWQgfSA9IHJlcS5xdWVyeTtcblxuICAgICAgaWYgKCFwbGFuVHlwZSB8fCAhcGxhbklkKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiAncGxhblR5cGUgYW5kIHBsYW5JZCBhcmUgcmVxdWlyZWQnIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBhY2Nlc3NcbiAgICAgIGNvbnN0IGhhc0FjY2VzcyA9IGF3YWl0IGNoZWNrQ29tbWVudEFjY2VzcyhwbGFuVHlwZSBhcyBzdHJpbmcsIHBsYW5JZCBhcyBzdHJpbmcsIHVzZXJJZCk7XG4gICAgICBpZiAoIWhhc0FjY2Vzcykge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ0FjY2VzcyBkZW5pZWQnIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBjb21tZW50cyA9IGF3YWl0IHByaXNtYS5wbGFuQ29tbWVudC5maW5kTWFueSh7XG4gICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgcGxhblR5cGU6IHBsYW5UeXBlIGFzIHN0cmluZyxcbiAgICAgICAgICBwbGFuSWQ6IHBsYW5JZCBhcyBzdHJpbmcsXG4gICAgICAgICAgcGFyZW50SWQ6IG51bGwsIC8vIE9ubHkgZ2V0IHRvcC1sZXZlbCBjb21tZW50c1xuICAgICAgICB9LFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlLCBuYW1lOiB0cnVlLCBlbWFpbDogdHJ1ZSB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgcmVwbGllczoge1xuICAgICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlLCBuYW1lOiB0cnVlLCBlbWFpbDogdHJ1ZSB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG9yZGVyQnk6IHsgY3JlYXRlZEF0OiAnYXNjJyB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIG9yZGVyQnk6IFt7IGlzUGlubmVkOiAnZGVzYycgfSwgeyBjcmVhdGVkQXQ6ICdkZXNjJyB9XSxcbiAgICAgIH0pO1xuXG4gICAgICByZXMuanNvbihjb21tZW50cyk7XG4gICAgfSksXG4gICk7XG5cbiAgLy8gQ3JlYXRlIGEgY29tbWVudFxuICByb3V0ZXIucG9zdChcbiAgICAnLycsXG4gICAgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICAgICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLmlkO1xuICAgICAgY29uc3QgeyBwbGFuVHlwZSwgcGxhbklkLCBjb250ZW50LCBwYXJlbnRJZCB9ID0gY3JlYXRlQ29tbWVudFNjaGVtYS5wYXJzZShyZXEuYm9keSk7XG5cbiAgICAgIC8vIENoZWNrIGFjY2Vzc1xuICAgICAgY29uc3QgaGFzQWNjZXNzID0gYXdhaXQgY2hlY2tDb21tZW50QWNjZXNzKHBsYW5UeXBlLCBwbGFuSWQsIHVzZXJJZCk7XG4gICAgICBpZiAoIWhhc0FjY2Vzcykge1xuICAgICAgICByZXR1cm4gcmVzXG4gICAgICAgICAgLnN0YXR1cyg0MDMpXG4gICAgICAgICAgLmpzb24oeyBlcnJvcjogJ1lvdSBkbyBub3QgaGF2ZSBwZXJtaXNzaW9uIHRvIGNvbW1lbnQgb24gdGhpcyBwbGFuJyB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gSWYgcmVwbHlpbmcgdG8gYSBjb21tZW50LCB2ZXJpZnkgcGFyZW50IGV4aXN0c1xuICAgICAgaWYgKHBhcmVudElkKSB7XG4gICAgICAgIGNvbnN0IHBhcmVudENvbW1lbnQgPSBhd2FpdCBwcmlzbWEucGxhbkNvbW1lbnQuZmluZFVuaXF1ZSh7XG4gICAgICAgICAgd2hlcmU6IHsgaWQ6IHBhcmVudElkIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChcbiAgICAgICAgICAhcGFyZW50Q29tbWVudCB8fFxuICAgICAgICAgIHBhcmVudENvbW1lbnQucGxhblR5cGUgIT09IHBsYW5UeXBlIHx8XG4gICAgICAgICAgcGFyZW50Q29tbWVudC5wbGFuSWQgIT09IHBsYW5JZFxuICAgICAgICApIHtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ0ludmFsaWQgcGFyZW50IGNvbW1lbnQnIH0pO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNvbW1lbnQgPSBhd2FpdCBwcmlzbWEucGxhbkNvbW1lbnQuY3JlYXRlKHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIHBsYW5UeXBlLFxuICAgICAgICAgIHBsYW5JZCxcbiAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgY29udGVudCxcbiAgICAgICAgICBwYXJlbnRJZCxcbiAgICAgICAgfSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgIHNlbGVjdDogeyBpZDogdHJ1ZSwgbmFtZTogdHJ1ZSwgZW1haWw6IHRydWUgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGxvZ2dlci5pbmZvKGBDb21tZW50IGNyZWF0ZWQgb24gJHtwbGFuVHlwZX0vJHtwbGFuSWR9IGJ5IHVzZXIgJHt1c2VySWR9YCk7XG4gICAgICByZXMuc3RhdHVzKDIwMSkuanNvbihjb21tZW50KTtcbiAgICB9KSxcbiAgKTtcblxuICAvLyBVcGRhdGUgYSBjb21tZW50XG4gIHJvdXRlci5wYXRjaChcbiAgICAnLzpjb21tZW50SWQnLFxuICAgIGFzeW5jSGFuZGxlcihhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICAgIGNvbnN0IHsgY29tbWVudElkIH0gPSByZXEucGFyYW1zO1xuICAgICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLmlkO1xuICAgICAgY29uc3QgdXBkYXRlcyA9IHVwZGF0ZUNvbW1lbnRTY2hlbWEucGFyc2UocmVxLmJvZHkpO1xuXG4gICAgICBjb25zdCBjb21tZW50ID0gYXdhaXQgcHJpc21hLnBsYW5Db21tZW50LmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyBpZDogY29tbWVudElkIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFjb21tZW50KSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IGVycm9yOiAnQ29tbWVudCBub3QgZm91bmQnIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBwZXJtaXNzaW9uc1xuICAgICAgY29uc3QgaXNBdXRob3IgPSBjb21tZW50LnVzZXJJZCA9PT0gdXNlcklkO1xuICAgICAgY29uc3QgaGFzQWNjZXNzID0gYXdhaXQgY2hlY2tDb21tZW50QWNjZXNzKGNvbW1lbnQucGxhblR5cGUsIGNvbW1lbnQucGxhbklkLCB1c2VySWQpO1xuXG4gICAgICBpZiAoIWhhc0FjY2Vzcykge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ0FjY2VzcyBkZW5pZWQnIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBPbmx5IGF1dGhvciBjYW4gZWRpdCBjb250ZW50XG4gICAgICBpZiAodXBkYXRlcy5jb250ZW50ICE9PSB1bmRlZmluZWQgJiYgIWlzQXV0aG9yKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnT25seSB0aGUgY29tbWVudCBhdXRob3IgY2FuIGVkaXQgdGhlIGNvbnRlbnQnIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBQbGFuIG93bmVyIGNhbiBwaW4vcmVzb2x2ZSBjb21tZW50c1xuICAgICAgY29uc3QgcGxhbk93bmVyQ2hlY2tzOiBSZWNvcmQ8c3RyaW5nLCAoKSA9PiBQcm9taXNlPGJvb2xlYW4+PiA9IHtcbiAgICAgICAgJ2xvbmctcmFuZ2UnOiBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgY29uc3QgcGxhbiA9IGF3YWl0IHByaXNtYS5sb25nUmFuZ2VQbGFuLmZpbmRVbmlxdWUoe1xuICAgICAgICAgICAgd2hlcmU6IHsgaWQ6IGNvbW1lbnQucGxhbklkIH0sXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcmV0dXJuIHBsYW4/LnVzZXJJZCA9PT0gdXNlcklkO1xuICAgICAgICB9LFxuICAgICAgICB1bml0OiBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgY29uc3QgcGxhbiA9IGF3YWl0IHByaXNtYS51bml0UGxhbi5maW5kVW5pcXVlKHtcbiAgICAgICAgICAgIHdoZXJlOiB7IGlkOiBjb21tZW50LnBsYW5JZCB9LFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHJldHVybiBwbGFuPy51c2VySWQgPT09IHVzZXJJZDtcbiAgICAgICAgfSxcbiAgICAgICAgbGVzc29uOiBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgY29uc3QgcGxhbiA9IGF3YWl0IHByaXNtYS5lVEZPTGVzc29uUGxhbi5maW5kVW5pcXVlKHtcbiAgICAgICAgICAgIHdoZXJlOiB7IGlkOiBjb21tZW50LnBsYW5JZCB9LFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHJldHVybiBwbGFuPy51c2VySWQgPT09IHVzZXJJZDtcbiAgICAgICAgfSxcbiAgICAgICAgZGF5Ym9vazogYXN5bmMgKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHBsYW4gPSBhd2FpdCBwcmlzbWEuZGF5Ym9va0VudHJ5LmZpbmRVbmlxdWUoe1xuICAgICAgICAgICAgd2hlcmU6IHsgaWQ6IGNvbW1lbnQucGxhbklkIH0sXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcmV0dXJuIHBsYW4/LnVzZXJJZCA9PT0gdXNlcklkO1xuICAgICAgICB9LFxuICAgICAgfTtcblxuICAgICAgY29uc3QgaXNQbGFuT3duZXIgPSBhd2FpdCBwbGFuT3duZXJDaGVja3NbY29tbWVudC5wbGFuVHlwZV0/LigpO1xuXG4gICAgICBpZiAoKHVwZGF0ZXMuaXNQaW5uZWQgIT09IHVuZGVmaW5lZCB8fCB1cGRhdGVzLmlzUmVzb2x2ZWQgIT09IHVuZGVmaW5lZCkgJiYgIWlzUGxhbk93bmVyKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnT25seSB0aGUgcGxhbiBvd25lciBjYW4gcGluIG9yIHJlc29sdmUgY29tbWVudHMnIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB1cGRhdGVkID0gYXdhaXQgcHJpc21hLnBsYW5Db21tZW50LnVwZGF0ZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkOiBjb21tZW50SWQgfSxcbiAgICAgICAgZGF0YTogdXBkYXRlcyxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgIHNlbGVjdDogeyBpZDogdHJ1ZSwgbmFtZTogdHJ1ZSwgZW1haWw6IHRydWUgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIHJlcy5qc29uKHVwZGF0ZWQpO1xuICAgIH0pLFxuICApO1xuXG4gIC8vIERlbGV0ZSBhIGNvbW1lbnRcbiAgcm91dGVyLmRlbGV0ZShcbiAgICAnLzpjb21tZW50SWQnLFxuICAgIGFzeW5jSGFuZGxlcihhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICAgIGNvbnN0IHsgY29tbWVudElkIH0gPSByZXEucGFyYW1zO1xuICAgICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLmlkO1xuXG4gICAgICBjb25zdCBjb21tZW50ID0gYXdhaXQgcHJpc21hLnBsYW5Db21tZW50LmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyBpZDogY29tbWVudElkIH0sXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICBfY291bnQ6IHtcbiAgICAgICAgICAgIHNlbGVjdDogeyByZXBsaWVzOiB0cnVlIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIWNvbW1lbnQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgZXJyb3I6ICdDb21tZW50IG5vdCBmb3VuZCcgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIE9ubHkgYXV0aG9yIGNhbiBkZWxldGUgdGhlaXIgY29tbWVudFxuICAgICAgaWYgKGNvbW1lbnQudXNlcklkICE9PSB1c2VySWQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgZXJyb3I6ICdPbmx5IHRoZSBjb21tZW50IGF1dGhvciBjYW4gZGVsZXRlIHRoZSBjb21tZW50JyB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gRG9uJ3QgYWxsb3cgZGVsZXRpb24gaWYgdGhlcmUgYXJlIHJlcGxpZXNcbiAgICAgIGlmIChjb21tZW50Ll9jb3VudC5yZXBsaWVzID4gMCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ0Nhbm5vdCBkZWxldGUgYSBjb21tZW50IHdpdGggcmVwbGllcycgfSk7XG4gICAgICB9XG5cbiAgICAgIGF3YWl0IHByaXNtYS5wbGFuQ29tbWVudC5kZWxldGUoe1xuICAgICAgICB3aGVyZTogeyBpZDogY29tbWVudElkIH0sXG4gICAgICB9KTtcblxuICAgICAgbG9nZ2VyLmluZm8oYENvbW1lbnQgJHtjb21tZW50SWR9IGRlbGV0ZWQgYnkgdXNlciAke3VzZXJJZH1gKTtcbiAgICAgIHJlcy5zdGF0dXMoMjA0KS5zZW5kKCk7XG4gICAgfSksXG4gICk7XG5cbiAgLy8gR2V0IGNvbW1lbnQgc3RhdGlzdGljcyBmb3IgYSBwbGFuXG4gIHJvdXRlci5nZXQoXG4gICAgJy9zdGF0cycsXG4gICAgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICAgICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLmlkO1xuICAgICAgY29uc3QgeyBwbGFuVHlwZSwgcGxhbklkIH0gPSByZXEucXVlcnk7XG5cbiAgICAgIGlmICghcGxhblR5cGUgfHwgIXBsYW5JZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ3BsYW5UeXBlIGFuZCBwbGFuSWQgYXJlIHJlcXVpcmVkJyB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgYWNjZXNzXG4gICAgICBjb25zdCBoYXNBY2Nlc3MgPSBhd2FpdCBjaGVja0NvbW1lbnRBY2Nlc3MocGxhblR5cGUgYXMgc3RyaW5nLCBwbGFuSWQgYXMgc3RyaW5nLCB1c2VySWQpO1xuICAgICAgaWYgKCFoYXNBY2Nlc3MpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgZXJyb3I6ICdBY2Nlc3MgZGVuaWVkJyB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgW3RvdGFsLCByZXNvbHZlZCwgdW5yZXNvbHZlZF0gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgIHByaXNtYS5wbGFuQ29tbWVudC5jb3VudCh7XG4gICAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICAgIHBsYW5UeXBlOiBwbGFuVHlwZSBhcyBzdHJpbmcsXG4gICAgICAgICAgICBwbGFuSWQ6IHBsYW5JZCBhcyBzdHJpbmcsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSksXG4gICAgICAgIHByaXNtYS5wbGFuQ29tbWVudC5jb3VudCh7XG4gICAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICAgIHBsYW5UeXBlOiBwbGFuVHlwZSBhcyBzdHJpbmcsXG4gICAgICAgICAgICBwbGFuSWQ6IHBsYW5JZCBhcyBzdHJpbmcsXG4gICAgICAgICAgICBpc1Jlc29sdmVkOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pLFxuICAgICAgICBwcmlzbWEucGxhbkNvbW1lbnQuY291bnQoe1xuICAgICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgICBwbGFuVHlwZTogcGxhblR5cGUgYXMgc3RyaW5nLFxuICAgICAgICAgICAgcGxhbklkOiBwbGFuSWQgYXMgc3RyaW5nLFxuICAgICAgICAgICAgaXNSZXNvbHZlZDogZmFsc2UsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSksXG4gICAgICBdKTtcblxuICAgICAgcmVzLmpzb24oe1xuICAgICAgICB0b3RhbCxcbiAgICAgICAgcmVzb2x2ZWQsXG4gICAgICAgIHVucmVzb2x2ZWQsXG4gICAgICB9KTtcbiAgICB9KSxcbiAgKTtcblxuICByZXR1cm4gcm91dGVyO1xufVxuIl0sInZlcnNpb24iOjN9