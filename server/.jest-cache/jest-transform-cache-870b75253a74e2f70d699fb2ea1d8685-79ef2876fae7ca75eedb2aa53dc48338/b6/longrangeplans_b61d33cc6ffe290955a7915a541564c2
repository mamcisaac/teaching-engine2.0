e46d844262c0a8f058e5d0e262b163ba
import { Router } from 'express';
import { prisma } from '../prisma';
import { validate } from '../validation';
import { z } from 'zod';
import { generateLongRangePlanDraft, generatePlanSuggestions } from '../services/aiDraftService';
const router = Router();
// Validation schemas
const longRangePlanCreateSchema = z.object({
    title: z.string().min(1),
    titleFr: z.string().optional(),
    academicYear: z.string().regex(/^\d{4}-\d{4}$/), // e.g., "2024-2025"
    term: z.string().optional(),
    grade: z.number().int().min(1).max(12),
    subject: z.string().min(1),
    description: z.string().optional(),
    descriptionFr: z.string().optional(),
    goals: z.string().optional(),
    goalsFr: z.string().optional(),
    themes: z.array(z.string()).optional(),
    expectationIds: z.array(z.string()).optional(),
    // ETFO-aligned fields
    overarchingQuestions: z.string().optional(),
    assessmentOverview: z.string().optional(),
    resourceNeeds: z.string().optional(),
    professionalGoals: z.string().optional(),
});
const longRangePlanUpdateSchema = longRangePlanCreateSchema.partial();
// Get all long-range plans for the authenticated user
router.get('/', async (req, res, _next) => {
    try {
        const userId = parseInt(req.user?.userId || '0', 10);
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const { academicYear, subject, grade } = req.query;
        const where = { userId };
        if (academicYear)
            where.academicYear = String(academicYear);
        if (subject)
            where.subject = String(subject);
        if (grade)
            where.grade = Number(grade);
        const plans = await prisma.longRangePlan.findMany({
            where,
            orderBy: [{ academicYear: 'desc' }, { subject: 'asc' }, { grade: 'asc' }],
            include: {
                _count: {
                    select: {
                        unitPlans: true,
                        expectations: true,
                    },
                },
            },
        });
        res.json(plans);
    }
    catch (err) {
        _next(err);
    }
});
// Get a single long-range plan
router.get('/:id', async (req, res, _next) => {
    try {
        const userId = parseInt(req.user?.userId || '0', 10);
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const plan = await prisma.longRangePlan.findFirst({
            where: {
                id: req.params.id,
                userId,
            },
            include: {
                expectations: {
                    include: {
                        expectation: true,
                    },
                    orderBy: {
                        expectation: { code: 'asc' },
                    },
                },
                unitPlans: {
                    orderBy: { startDate: 'asc' },
                    include: {
                        _count: {
                            select: {
                                lessonPlans: true,
                                expectations: true,
                            },
                        },
                    },
                },
            },
        });
        if (!plan) {
            return res.status(404).json({ error: 'Long-range plan not found' });
        }
        res.json(plan);
    }
    catch (err) {
        _next(err);
    }
});
// Create a new long-range plan
router.post('/', validate(longRangePlanCreateSchema), async (req, res, _next) => {
    try {
        const userId = parseInt(req.user?.userId || '0', 10);
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const { expectationIds, themes, ...planData } = req.body;
        const plan = await prisma.longRangePlan.create({
            data: {
                ...planData,
                userId,
                themes: themes || [],
            },
            include: {
                expectations: {
                    include: { expectation: true },
                },
                _count: {
                    select: { unitPlans: true },
                },
            },
        });
        // Link curriculum expectations if provided
        if (expectationIds && expectationIds.length > 0) {
            // Validate expectation IDs exist
            const validExpectations = await prisma.curriculumExpectation.findMany({
                where: { id: { in: expectationIds } },
                select: { id: true },
            });
            if (validExpectations.length !== expectationIds.length) {
                return res.status(400).json({
                    error: 'One or more curriculum expectations not found',
                    provided: expectationIds,
                    found: validExpectations.map((e) => e.id),
                });
            }
            await prisma.longRangePlanExpectation.createMany({
                data: expectationIds.map((expectationId) => ({
                    longRangePlanId: plan.id,
                    expectationId,
                })),
            });
            // Refetch with expectations
            const updatedPlan = await prisma.longRangePlan.findUnique({
                where: { id: plan.id },
                include: {
                    expectations: {
                        include: { expectation: true },
                    },
                    _count: {
                        select: { unitPlans: true },
                    },
                },
            });
            return res.status(201).json(updatedPlan);
        }
        res.status(201).json(plan);
    }
    catch (err) {
        _next(err);
    }
});
// Update a long-range plan
router.put('/:id', validate(longRangePlanUpdateSchema), async (req, res, _next) => {
    try {
        const userId = parseInt(req.user?.userId || '0', 10);
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const { expectationIds, themes, ...updateData } = req.body;
        // Verify ownership
        const existing = await prisma.longRangePlan.findFirst({
            where: { id: req.params.id, userId },
        });
        if (!existing) {
            return res.status(404).json({ error: 'Long-range plan not found' });
        }
        // Update the plan
        const plan = await prisma.longRangePlan.update({
            where: { id: req.params.id },
            data: {
                ...updateData,
                themes: themes !== undefined ? themes : existing.themes,
            },
        });
        // Update expectations if provided
        if (expectationIds !== undefined) {
            // Remove existing expectations
            await prisma.longRangePlanExpectation.deleteMany({
                where: { longRangePlanId: plan.id },
            });
            // Add new expectations
            if (expectationIds.length > 0) {
                await prisma.longRangePlanExpectation.createMany({
                    data: expectationIds.map((expectationId) => ({
                        longRangePlanId: plan.id,
                        expectationId,
                    })),
                });
            }
        }
        // Refetch with updated relationships
        const updatedPlan = await prisma.longRangePlan.findUnique({
            where: { id: plan.id },
            include: {
                expectations: {
                    include: { expectation: true },
                },
                unitPlans: {
                    orderBy: { startDate: 'asc' },
                    include: {
                        _count: {
                            select: {
                                lessonPlans: true,
                                expectations: true,
                            },
                        },
                    },
                },
            },
        });
        res.json(updatedPlan);
    }
    catch (err) {
        _next(err);
    }
});
// Delete a long-range plan
router.delete('/:id', async (req, res, _next) => {
    try {
        const userId = parseInt(req.user?.userId || '0', 10);
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        // Verify ownership and check for dependencies
        const plan = await prisma.longRangePlan.findFirst({
            where: { id: req.params.id, userId },
            include: {
                _count: { select: { unitPlans: true } },
            },
        });
        if (!plan) {
            return res.status(404).json({ error: 'Long-range plan not found' });
        }
        if (plan._count.unitPlans > 0) {
            return res.status(400).json({
                error: 'Cannot delete long-range plan with existing unit plans',
            });
        }
        await prisma.longRangePlan.delete({
            where: { id: req.params.id },
        });
        res.status(204).end();
    }
    catch (err) {
        _next(err);
    }
});
// Generate AI draft for long-range plan
router.post('/ai-draft', async (req, res, _next) => {
    try {
        const userId = parseInt(req.user?.userId || '0', 10);
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const { expectationIds, subject, grade, academicYear, termStructure } = req.body;
        if (!expectationIds || !Array.isArray(expectationIds) || expectationIds.length === 0) {
            return res.status(400).json({ error: 'Expectation IDs are required' });
        }
        // Fetch the curriculum expectations
        const expectations = await prisma.curriculumExpectation.findMany({
            where: { id: { in: expectationIds } },
        });
        if (expectations.length === 0) {
            return res.status(400).json({ error: 'No valid expectations found' });
        }
        const draft = await generateLongRangePlanDraft({
            expectations: expectations.map((exp) => ({
                code: exp.code,
                description: exp.description,
                type: 'specific', // Default to specific since we don't store this
                strand: exp.strand,
                substrand: exp.substrand || undefined,
                subject: exp.subject,
                grade: exp.grade,
            })),
            subject: subject || expectations[0].subject,
            grade: grade || expectations[0].grade,
            academicYear: academicYear || '2024-2025',
            termStructure: termStructure || 'semester',
        });
        res.json(draft);
    }
    catch (err) {
        console.error('AI draft generation error:', err);
        res.status(500).json({ error: 'Failed to generate AI draft' });
    }
});
// Generate AI suggestions for existing plan
router.post('/:id/ai-suggestions', async (req, res, _next) => {
    try {
        const userId = parseInt(req.user?.userId || '0', 10);
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const plan = await prisma.longRangePlan.findFirst({
            where: { id: req.params.id, userId },
            include: {
                expectations: { include: { expectation: true } },
            },
        });
        if (!plan) {
            return res.status(404).json({ error: 'Long-range plan not found' });
        }
        const existingContent = `
Title: ${plan.title}
Subject: ${plan.subject}
Grade: ${plan.grade}
Goals: ${plan.goals || 'None specified'}
Themes: ${Array.isArray(plan.themes) ? plan.themes.join(', ') : 'None specified'}
Expectations: ${plan.expectations.map((e) => `${e.expectation.code}: ${e.expectation.description}`).join('\n')}
    `;
        const suggestions = await generatePlanSuggestions('long-range', existingContent);
        res.json({ suggestions });
    }
    catch (err) {
        console.error('AI suggestions error:', err);
        res.status(500).json({ error: 'Failed to generate suggestions' });
    }
});
export default router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9yb3V0ZXMvbG9uZy1yYW5nZS1wbGFucy50cyIsIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFXLE1BQU0sU0FBUyxDQUFDO0FBRTFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDbkMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN6QyxPQUFPLEVBQUUsQ0FBQyxFQUFFLE1BQU0sS0FBSyxDQUFDO0FBQ3hCLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSx1QkFBdUIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBTWpHLE1BQU0sTUFBTSxHQUFHLE1BQU0sRUFBRSxDQUFDO0FBRXhCLHFCQUFxQjtBQUNyQixNQUFNLHlCQUF5QixHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDekMsS0FBSyxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ3hCLE9BQU8sRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0lBQzlCLFlBQVksRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxFQUFFLG9CQUFvQjtJQUNyRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsRUFBRTtJQUMzQixLQUFLLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO0lBQ3RDLE9BQU8sRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUMxQixXQUFXLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsRUFBRTtJQUNsQyxhQUFhLEVBQUUsQ0FBQyxDQUFDLE1BQU0s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RUFBRSxLQUFLLEVBQUUsZ0NBQWdDLEVBQUUsQ0FBQyxDQUFDO0lBQ3BFLENBQUM7QUFDSCxDQUFDLENBQUMsQ0FBQztBQUVILGVBQWUsTUFBTSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9taWNoYWVsbWNpc2FhYy9HaXRIdWIvdGVhY2hpbmctZW5naW5lMi4wL3NlcnZlci9zcmMvcm91dGVzL2xvbmctcmFuZ2UtcGxhbnMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUm91dGVyLCBSZXF1ZXN0IH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBQcmlzbWEgfSBmcm9tICcuLi9wcmlzbWEnO1xuaW1wb3J0IHsgcHJpc21hIH0gZnJvbSAnLi4vcHJpc21hJztcbmltcG9ydCB7IHZhbGlkYXRlIH0gZnJvbSAnLi4vdmFsaWRhdGlvbic7XG5pbXBvcnQgeyB6IH0gZnJvbSAnem9kJztcbmltcG9ydCB7IGdlbmVyYXRlTG9uZ1JhbmdlUGxhbkRyYWZ0LCBnZW5lcmF0ZVBsYW5TdWdnZXN0aW9ucyB9IGZyb20gJy4uL3NlcnZpY2VzL2FpRHJhZnRTZXJ2aWNlJztcblxuaW50ZXJmYWNlIEF1dGhlbnRpY2F0ZWRSZXF1ZXN0IGV4dGVuZHMgUmVxdWVzdCB7XG4gIHVzZXI/OiB7IHVzZXJJZDogc3RyaW5nIH07XG59XG5cbmNvbnN0IHJvdXRlciA9IFJvdXRlcigpO1xuXG4vLyBWYWxpZGF0aW9uIHNjaGVtYXNcbmNvbnN0IGxvbmdSYW5nZVBsYW5DcmVhdGVTY2hlbWEgPSB6Lm9iamVjdCh7XG4gIHRpdGxlOiB6LnN0cmluZygpLm1pbigxKSxcbiAgdGl0bGVGcjogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuICBhY2FkZW1pY1llYXI6IHouc3RyaW5nKCkucmVnZXgoL15cXGR7NH0tXFxkezR9JC8pLCAvLyBlLmcuLCBcIjIwMjQtMjAyNVwiXG4gIHRlcm06IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgZ3JhZGU6IHoubnVtYmVyKCkuaW50KCkubWluKDEpLm1heCgxMiksXG4gIHN1YmplY3Q6IHouc3RyaW5nKCkubWluKDEpLFxuICBkZXNjcmlwdGlvbjogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuICBkZXNjcmlwdGlvbkZyOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gIGdvYWxzOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gIGdvYWxzRnI6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgdGhlbWVzOiB6LmFycmF5KHouc3RyaW5nKCkpLm9wdGlvbmFsKCksXG4gIGV4cGVjdGF0aW9uSWRzOiB6LmFycmF5KHouc3RyaW5nKCkpLm9wdGlvbmFsKCksXG4gIC8vIEVURk8tYWxpZ25lZCBmaWVsZHNcbiAgb3ZlcmFyY2hpbmdRdWVzdGlvbnM6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgYXNzZXNzbWVudE92ZXJ2aWV3OiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gIHJlc291cmNlTmVlZHM6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgcHJvZmVzc2lvbmFsR29hbHM6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbn0pO1xuXG5jb25zdCBsb25nUmFuZ2VQbGFuVXBkYXRlU2NoZW1hID0gbG9uZ1JhbmdlUGxhbkNyZWF0ZVNjaGVtYS5wYXJ0aWFsKCk7XG5cbi8vIEdldCBhbGwgbG9uZy1yYW5nZSBwbGFucyBmb3IgdGhlIGF1dGhlbnRpY2F0ZWQgdXNlclxucm91dGVyLmdldCgnLycsIGFzeW5jIChyZXE6IEF1dGhlbnRpY2F0ZWRSZXF1ZXN0LCByZXMsIF9uZXh0KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgdXNlcklkID0gcGFyc2VJbnQocmVxLnVzZXI/LnVzZXJJZCB8fCAnMCcsIDEwKTtcbiAgICBpZiAoIXVzZXJJZCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICdVbmF1dGhvcml6ZWQnIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHsgYWNhZGVtaWNZZWFyLCBzdWJqZWN0LCBncmFkZSB9ID0gcmVxLnF1ZXJ5O1xuXG4gICAgY29uc3Qgd2hlcmU6IFByaXNtYS5Mb25nUmFuZ2VQbGFuV2hlcmVJbnB1dCA9IHsgdXNlcklkIH07XG4gICAgaWYgKGFjYWRlbWljWWVhcikgd2hlcmUuYWNhZGVtaWNZZWFyID0gU3RyaW5nKGFjYWRlbWljWWVhcik7XG4gICAgaWYgKHN1YmplY3QpIHdoZXJlLnN1YmplY3QgPSBTdHJpbmcoc3ViamVjdCk7XG4gICAgaWYgKGdyYWRlKSB3aGVyZS5ncmFkZSA9IE51bWJlcihncmFkZSk7XG5cbiAgICBjb25zdCBwbGFucyA9IGF3YWl0IHByaXNtYS5sb25nUmFuZ2VQbGFuLmZpbmRNYW55KHtcbiAgICAgIHdoZXJlLFxuICAgICAgb3JkZXJCeTogW3sgYWNhZGVtaWNZZWFyOiAnZGVzYycgfSwgeyBzdWJqZWN0OiAnYXNjJyB9LCB7IGdyYWRlOiAnYXNjJyB9XSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgX2NvdW50OiB7XG4gICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICB1bml0UGxhbnM6IHRydWUsXG4gICAgICAgICAgICBleHBlY3RhdGlvbnM6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICByZXMuanNvbihwbGFucyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIF9uZXh0KGVycik7XG4gIH1cbn0pO1xuXG4vLyBHZXQgYSBzaW5nbGUgbG9uZy1yYW5nZSBwbGFuXG5yb3V0ZXIuZ2V0KCcvOmlkJywgYXN5bmMgKHJlcTogQXV0aGVudGljYXRlZFJlcXVlc3QsIHJlcywgX25leHQpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB1c2VySWQgPSBwYXJzZUludChyZXEudXNlcj8udXNlcklkIHx8ICcwJywgMTApO1xuICAgIGlmICghdXNlcklkKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBlcnJvcjogJ1VuYXV0aG9yaXplZCcgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgcGxhbiA9IGF3YWl0IHByaXNtYS5sb25nUmFuZ2VQbGFuLmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBpZDogcmVxLnBhcmFtcy5pZCxcbiAgICAgICAgdXNlcklkLFxuICAgICAgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgZXhwZWN0YXRpb25zOiB7XG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgZXhwZWN0YXRpb246IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBvcmRlckJ5OiB7XG4gICAgICAgICAgICBleHBlY3RhdGlvbjogeyBjb2RlOiAnYXNjJyB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHVuaXRQbGFuczoge1xuICAgICAgICAgIG9yZGVyQnk6IHsgc3RhcnREYXRlOiAnYXNjJyB9LFxuICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgIF9jb3VudDoge1xuICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICBsZXNzb25QbGFuczogdHJ1ZSxcbiAgICAgICAgICAgICAgICBleHBlY3RhdGlvbnM6IHRydWUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFwbGFuKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBlcnJvcjogJ0xvbmctcmFuZ2UgcGxhbiBub3QgZm91bmQnIH0pO1xuICAgIH1cblxuICAgIHJlcy5qc29uKHBsYW4pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBfbmV4dChlcnIpO1xuICB9XG59KTtcblxuLy8gQ3JlYXRlIGEgbmV3IGxvbmctcmFuZ2UgcGxhblxucm91dGVyLnBvc3QoXG4gICcvJyxcbiAgdmFsaWRhdGUobG9uZ1JhbmdlUGxhbkNyZWF0ZVNjaGVtYSksXG4gIGFzeW5jIChyZXE6IEF1dGhlbnRpY2F0ZWRSZXF1ZXN0LCByZXMsIF9uZXh0KSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVzZXJJZCA9IHBhcnNlSW50KHJlcS51c2VyPy51c2VySWQgfHwgJzAnLCAxMCk7XG4gICAgICBpZiAoIXVzZXJJZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBlcnJvcjogJ1VuYXV0aG9yaXplZCcgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHsgZXhwZWN0YXRpb25JZHMsIHRoZW1lcywgLi4ucGxhbkRhdGEgfSA9IHJlcS5ib2R5O1xuXG4gICAgICBjb25zdCBwbGFuID0gYXdhaXQgcHJpc21hLmxvbmdSYW5nZVBsYW4uY3JlYXRlKHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIC4uLnBsYW5EYXRhLFxuICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICB0aGVtZXM6IHRoZW1lcyB8fCBbXSxcbiAgICAgICAgfSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIGV4cGVjdGF0aW9uczoge1xuICAgICAgICAgICAgaW5jbHVkZTogeyBleHBlY3RhdGlvbjogdHJ1ZSB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgX2NvdW50OiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHsgdW5pdFBsYW5zOiB0cnVlIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBMaW5rIGN1cnJpY3VsdW0gZXhwZWN0YXRpb25zIGlmIHByb3ZpZGVkXG4gICAgICBpZiAoZXhwZWN0YXRpb25JZHMgJiYgZXhwZWN0YXRpb25JZHMubGVuZ3RoID4gMCkge1xuICAgICAgICAvLyBWYWxpZGF0ZSBleHBlY3RhdGlvbiBJRHMgZXhpc3RcbiAgICAgICAgY29uc3QgdmFsaWRFeHBlY3RhdGlvbnMgPSBhd2FpdCBwcmlzbWEuY3VycmljdWx1bUV4cGVjdGF0aW9uLmZpbmRNYW55KHtcbiAgICAgICAgICB3aGVyZTogeyBpZDogeyBpbjogZXhwZWN0YXRpb25JZHMgfSB9LFxuICAgICAgICAgIHNlbGVjdDogeyBpZDogdHJ1ZSB9LFxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAodmFsaWRFeHBlY3RhdGlvbnMubGVuZ3RoICE9PSBleHBlY3RhdGlvbklkcy5sZW5ndGgpIHtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgICAgZXJyb3I6ICdPbmUgb3IgbW9yZSBjdXJyaWN1bHVtIGV4cGVjdGF0aW9ucyBub3QgZm91bmQnLFxuICAgICAgICAgICAgcHJvdmlkZWQ6IGV4cGVjdGF0aW9uSWRzLFxuICAgICAgICAgICAgZm91bmQ6IHZhbGlkRXhwZWN0YXRpb25zLm1hcCgoZSkgPT4gZS5pZCksXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCBwcmlzbWEubG9uZ1JhbmdlUGxhbkV4cGVjdGF0aW9uLmNyZWF0ZU1hbnkoe1xuICAgICAgICAgIGRhdGE6IGV4cGVjdGF0aW9uSWRzLm1hcCgoZXhwZWN0YXRpb25JZDogc3RyaW5nKSA9PiAoe1xuICAgICAgICAgICAgbG9uZ1JhbmdlUGxhbklkOiBwbGFuLmlkLFxuICAgICAgICAgICAgZXhwZWN0YXRpb25JZCxcbiAgICAgICAgICB9KSksXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFJlZmV0Y2ggd2l0aCBleHBlY3RhdGlvbnNcbiAgICAgICAgY29uc3QgdXBkYXRlZFBsYW4gPSBhd2FpdCBwcmlzbWEubG9uZ1JhbmdlUGxhbi5maW5kVW5pcXVlKHtcbiAgICAgICAgICB3aGVyZTogeyBpZDogcGxhbi5pZCB9LFxuICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgIGV4cGVjdGF0aW9uczoge1xuICAgICAgICAgICAgICBpbmNsdWRlOiB7IGV4cGVjdGF0aW9uOiB0cnVlIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgX2NvdW50OiB7XG4gICAgICAgICAgICAgIHNlbGVjdDogeyB1bml0UGxhbnM6IHRydWUgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAxKS5qc29uKHVwZGF0ZWRQbGFuKTtcbiAgICAgIH1cblxuICAgICAgcmVzLnN0YXR1cygyMDEpLmpzb24ocGxhbik7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBfbmV4dChlcnIpO1xuICAgIH1cbiAgfSxcbik7XG5cbi8vIFVwZGF0ZSBhIGxvbmctcmFuZ2UgcGxhblxucm91dGVyLnB1dChcbiAgJy86aWQnLFxuICB2YWxpZGF0ZShsb25nUmFuZ2VQbGFuVXBkYXRlU2NoZW1hKSxcbiAgYXN5bmMgKHJlcTogQXV0aGVudGljYXRlZFJlcXVlc3QsIHJlcywgX25leHQpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXNlcklkID0gcGFyc2VJbnQocmVxLnVzZXI/LnVzZXJJZCB8fCAnMCcsIDEwKTtcbiAgICAgIGlmICghdXNlcklkKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAnVW5hdXRob3JpemVkJyB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgeyBleHBlY3RhdGlvbklkcywgdGhlbWVzLCAuLi51cGRhdGVEYXRhIH0gPSByZXEuYm9keTtcblxuICAgICAgLy8gVmVyaWZ5IG93bmVyc2hpcFxuICAgICAgY29uc3QgZXhpc3RpbmcgPSBhd2FpdCBwcmlzbWEubG9uZ1JhbmdlUGxhbi5maW5kRmlyc3Qoe1xuICAgICAgICB3aGVyZTogeyBpZDogcmVxLnBhcmFtcy5pZCwgdXNlcklkIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFleGlzdGluZykge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBlcnJvcjogJ0xvbmctcmFuZ2UgcGxhbiBub3QgZm91bmQnIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBVcGRhdGUgdGhlIHBsYW5cbiAgICAgIGNvbnN0IHBsYW4gPSBhd2FpdCBwcmlzbWEubG9uZ1JhbmdlUGxhbi51cGRhdGUoe1xuICAgICAgICB3aGVyZTogeyBpZDogcmVxLnBhcmFtcy5pZCB9LFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgLi4udXBkYXRlRGF0YSxcbiAgICAgICAgICB0aGVtZXM6IHRoZW1lcyAhPT0gdW5kZWZpbmVkID8gdGhlbWVzIDogZXhpc3RpbmcudGhlbWVzLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFVwZGF0ZSBleHBlY3RhdGlvbnMgaWYgcHJvdmlkZWRcbiAgICAgIGlmIChleHBlY3RhdGlvbklkcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIC8vIFJlbW92ZSBleGlzdGluZyBleHBlY3RhdGlvbnNcbiAgICAgICAgYXdhaXQgcHJpc21hLmxvbmdSYW5nZVBsYW5FeHBlY3RhdGlvbi5kZWxldGVNYW55KHtcbiAgICAgICAgICB3aGVyZTogeyBsb25nUmFuZ2VQbGFuSWQ6IHBsYW4uaWQgfSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gQWRkIG5ldyBleHBlY3RhdGlvbnNcbiAgICAgICAgaWYgKGV4cGVjdGF0aW9uSWRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBhd2FpdCBwcmlzbWEubG9uZ1JhbmdlUGxhbkV4cGVjdGF0aW9uLmNyZWF0ZU1hbnkoe1xuICAgICAgICAgICAgZGF0YTogZXhwZWN0YXRpb25JZHMubWFwKChleHBlY3RhdGlvbklkOiBzdHJpbmcpID0+ICh7XG4gICAgICAgICAgICAgIGxvbmdSYW5nZVBsYW5JZDogcGxhbi5pZCxcbiAgICAgICAgICAgICAgZXhwZWN0YXRpb25JZCxcbiAgICAgICAgICAgIH0pKSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBSZWZldGNoIHdpdGggdXBkYXRlZCByZWxhdGlvbnNoaXBzXG4gICAgICBjb25zdCB1cGRhdGVkUGxhbiA9IGF3YWl0IHByaXNtYS5sb25nUmFuZ2VQbGFuLmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyBpZDogcGxhbi5pZCB9LFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgZXhwZWN0YXRpb25zOiB7XG4gICAgICAgICAgICBpbmNsdWRlOiB7IGV4cGVjdGF0aW9uOiB0cnVlIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICB1bml0UGxhbnM6IHtcbiAgICAgICAgICAgIG9yZGVyQnk6IHsgc3RhcnREYXRlOiAnYXNjJyB9LFxuICAgICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgICBfY291bnQ6IHtcbiAgICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICAgIGxlc3NvblBsYW5zOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgZXhwZWN0YXRpb25zOiB0cnVlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgcmVzLmpzb24odXBkYXRlZFBsYW4pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgX25leHQoZXJyKTtcbiAgICB9XG4gIH0sXG4pO1xuXG4vLyBEZWxldGUgYSBsb25nLXJhbmdlIHBsYW5cbnJvdXRlci5kZWxldGUoJy86aWQnLCBhc3luYyAocmVxOiBBdXRoZW50aWNhdGVkUmVxdWVzdCwgcmVzLCBfbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHVzZXJJZCA9IHBhcnNlSW50KHJlcS51c2VyPy51c2VySWQgfHwgJzAnLCAxMCk7XG4gICAgaWYgKCF1c2VySWQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAnVW5hdXRob3JpemVkJyB9KTtcbiAgICB9XG5cbiAgICAvLyBWZXJpZnkgb3duZXJzaGlwIGFuZCBjaGVjayBmb3IgZGVwZW5kZW5jaWVzXG4gICAgY29uc3QgcGxhbiA9IGF3YWl0IHByaXNtYS5sb25nUmFuZ2VQbGFuLmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZTogeyBpZDogcmVxLnBhcmFtcy5pZCwgdXNlcklkIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIF9jb3VudDogeyBzZWxlY3Q6IHsgdW5pdFBsYW5zOiB0cnVlIH0gfSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXBsYW4pIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IGVycm9yOiAnTG9uZy1yYW5nZSBwbGFuIG5vdCBmb3VuZCcgfSk7XG4gICAgfVxuXG4gICAgaWYgKHBsYW4uX2NvdW50LnVuaXRQbGFucyA+IDApIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnQ2Fubm90IGRlbGV0ZSBsb25nLXJhbmdlIHBsYW4gd2l0aCBleGlzdGluZyB1bml0IHBsYW5zJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGF3YWl0IHByaXNtYS5sb25nUmFuZ2VQbGFuLmRlbGV0ZSh7XG4gICAgICB3aGVyZTogeyBpZDogcmVxLnBhcmFtcy5pZCB9LFxuICAgIH0pO1xuXG4gICAgcmVzLnN0YXR1cygyMDQpLmVuZCgpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBfbmV4dChlcnIpO1xuICB9XG59KTtcblxuLy8gR2VuZXJhdGUgQUkgZHJhZnQgZm9yIGxvbmctcmFuZ2UgcGxhblxucm91dGVyLnBvc3QoJy9haS1kcmFmdCcsIGFzeW5jIChyZXE6IEF1dGhlbnRpY2F0ZWRSZXF1ZXN0LCByZXMsIF9uZXh0KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgdXNlcklkID0gcGFyc2VJbnQocmVxLnVzZXI/LnVzZXJJZCB8fCAnMCcsIDEwKTtcbiAgICBpZiAoIXVzZXJJZCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICdVbmF1dGhvcml6ZWQnIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHsgZXhwZWN0YXRpb25JZHMsIHN1YmplY3QsIGdyYWRlLCBhY2FkZW1pY1llYXIsIHRlcm1TdHJ1Y3R1cmUgfSA9IHJlcS5ib2R5O1xuXG4gICAgaWYgKCFleHBlY3RhdGlvbklkcyB8fCAhQXJyYXkuaXNBcnJheShleHBlY3RhdGlvbklkcykgfHwgZXhwZWN0YXRpb25JZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ0V4cGVjdGF0aW9uIElEcyBhcmUgcmVxdWlyZWQnIH0pO1xuICAgIH1cblxuICAgIC8vIEZldGNoIHRoZSBjdXJyaWN1bHVtIGV4cGVjdGF0aW9uc1xuICAgIGNvbnN0IGV4cGVjdGF0aW9ucyA9IGF3YWl0IHByaXNtYS5jdXJyaWN1bHVtRXhwZWN0YXRpb24uZmluZE1hbnkoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHsgaW46IGV4cGVjdGF0aW9uSWRzIH0gfSxcbiAgICB9KTtcblxuICAgIGlmIChleHBlY3RhdGlvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ05vIHZhbGlkIGV4cGVjdGF0aW9ucyBmb3VuZCcgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgZHJhZnQgPSBhd2FpdCBnZW5lcmF0ZUxvbmdSYW5nZVBsYW5EcmFmdCh7XG4gICAgICBleHBlY3RhdGlvbnM6IGV4cGVjdGF0aW9ucy5tYXAoKGV4cCkgPT4gKHtcbiAgICAgICAgY29kZTogZXhwLmNvZGUsXG4gICAgICAgIGRlc2NyaXB0aW9uOiBleHAuZGVzY3JpcHRpb24sXG4gICAgICAgIHR5cGU6ICdzcGVjaWZpYycgYXMgY29uc3QsIC8vIERlZmF1bHQgdG8gc3BlY2lmaWMgc2luY2Ugd2UgZG9uJ3Qgc3RvcmUgdGhpc1xuICAgICAgICBzdHJhbmQ6IGV4cC5zdHJhbmQsXG4gICAgICAgIHN1YnN0cmFuZDogZXhwLnN1YnN0cmFuZCB8fCB1bmRlZmluZWQsXG4gICAgICAgIHN1YmplY3Q6IGV4cC5zdWJqZWN0LFxuICAgICAgICBncmFkZTogZXhwLmdyYWRlLFxuICAgICAgfSkpLFxuICAgICAgc3ViamVjdDogc3ViamVjdCB8fCBleHBlY3RhdGlvbnNbMF0uc3ViamVjdCxcbiAgICAgIGdyYWRlOiBncmFkZSB8fCBleHBlY3RhdGlvbnNbMF0uZ3JhZGUsXG4gICAgICBhY2FkZW1pY1llYXI6IGFjYWRlbWljWWVhciB8fCAnMjAyNC0yMDI1JyxcbiAgICAgIHRlcm1TdHJ1Y3R1cmU6IHRlcm1TdHJ1Y3R1cmUgfHwgJ3NlbWVzdGVyJyxcbiAgICB9KTtcblxuICAgIHJlcy5qc29uKGRyYWZ0KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgY29uc29sZS5lcnJvcignQUkgZHJhZnQgZ2VuZXJhdGlvbiBlcnJvcjonLCBlcnIpO1xuICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgZXJyb3I6ICdGYWlsZWQgdG8gZ2VuZXJhdGUgQUkgZHJhZnQnIH0pO1xuICB9XG59KTtcblxuLy8gR2VuZXJhdGUgQUkgc3VnZ2VzdGlvbnMgZm9yIGV4aXN0aW5nIHBsYW5cbnJvdXRlci5wb3N0KCcvOmlkL2FpLXN1Z2dlc3Rpb25zJywgYXN5bmMgKHJlcTogQXV0aGVudGljYXRlZFJlcXVlc3QsIHJlcywgX25leHQpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB1c2VySWQgPSBwYXJzZUludChyZXEudXNlcj8udXNlcklkIHx8ICcwJywgMTApO1xuICAgIGlmICghdXNlcklkKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBlcnJvcjogJ1VuYXV0aG9yaXplZCcgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgcGxhbiA9IGF3YWl0IHByaXNtYS5sb25nUmFuZ2VQbGFuLmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZTogeyBpZDogcmVxLnBhcmFtcy5pZCwgdXNlcklkIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIGV4cGVjdGF0aW9uczogeyBpbmNsdWRlOiB7IGV4cGVjdGF0aW9uOiB0cnVlIH0gfSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXBsYW4pIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IGVycm9yOiAnTG9uZy1yYW5nZSBwbGFuIG5vdCBmb3VuZCcgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgZXhpc3RpbmdDb250ZW50ID0gYFxuVGl0bGU6ICR7cGxhbi50aXRsZX1cblN1YmplY3Q6ICR7cGxhbi5zdWJqZWN0fVxuR3JhZGU6ICR7cGxhbi5ncmFkZX1cbkdvYWxzOiAke3BsYW4uZ29hbHMgfHwgJ05vbmUgc3BlY2lmaWVkJ31cblRoZW1lczogJHtBcnJheS5pc0FycmF5KHBsYW4udGhlbWVzKSA/IHBsYW4udGhlbWVzLmpvaW4oJywgJykgOiAnTm9uZSBzcGVjaWZpZWQnfVxuRXhwZWN0YXRpb25zOiAke3BsYW4uZXhwZWN0YXRpb25zLm1hcCgoZSkgPT4gYCR7ZS5leHBlY3RhdGlvbi5jb2RlfTogJHtlLmV4cGVjdGF0aW9uLmRlc2NyaXB0aW9ufWApLmpvaW4oJ1xcbicpfVxuICAgIGA7XG5cbiAgICBjb25zdCBzdWdnZXN0aW9ucyA9IGF3YWl0IGdlbmVyYXRlUGxhblN1Z2dlc3Rpb25zKCdsb25nLXJhbmdlJywgZXhpc3RpbmdDb250ZW50KTtcblxuICAgIHJlcy5qc29uKHsgc3VnZ2VzdGlvbnMgfSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0FJIHN1Z2dlc3Rpb25zIGVycm9yOicsIGVycik7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0ZhaWxlZCB0byBnZW5lcmF0ZSBzdWdnZXN0aW9ucycgfSk7XG4gIH1cbn0pO1xuXG5leHBvcnQgZGVmYXVsdCByb3V0ZXI7XG4iXSwidmVyc2lvbiI6M30=