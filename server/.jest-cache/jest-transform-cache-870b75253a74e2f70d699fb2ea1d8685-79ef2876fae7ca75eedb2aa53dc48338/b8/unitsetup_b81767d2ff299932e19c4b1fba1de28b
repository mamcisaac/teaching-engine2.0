5b3b89cabd01dab478cbe9b0a3073d88
/**
 * Optimized Unit Test Setup
 * Fast, isolated setup with comprehensive mocking
 */
import { jest } from '@jest/globals';
// Mock all external dependencies upfront
jest.mock('@teaching-engine/database');
jest.mock('openai');
jest.mock('fs');
jest.mock('path');
jest.mock('canvas');
jest.mock('pdfkit');
jest.mock('pdf-parse');
jest.mock('mammoth');
jest.mock('cheerio');
jest.mock('axios');
jest.mock('node-cron');
jest.mock('handlebars');
jest.mock('html-to-docx');
jest.mock('archiver');
jest.mock('unzipper');
// Mock heavy services
jest.mock('@/services/emailService');
jest.mock('@/services/embeddingService');
jest.mock('@/services/llmService');
jest.mock('@/services/clusteringService');
jest.mock('@/services/materialGenerator');
jest.mock('@/services/aiPlanningAssistant');
// Mock logger with no-op functions for speed
jest.mock('@/logger', () => ({
    __esModule: true,
    default: {
        debug: jest.fn(),
        info: jest.fn(),
        warn: jest.fn(),
        error: jest.fn(),
        child: jest.fn(() => ({
            debug: jest.fn(),
            info: jest.fn(),
            warn: jest.fn(),
            error: jest.fn(),
        })),
    },
}));
// Set test environment
process.env.NODE_ENV = 'test';
process.env.JWT_SECRET = 'test-secret';
process.env.DATABASE_URL = 'file:./test.db';
// Performance monitoring for tests
const testMetrics = new Map();
// Hook into test lifecycle for performance monitoring
if (process.env.MONITOR_TEST_PERFORMANCE === 'true') {
    global.beforeEach(() => {
        const testName = expect.getState().currentTestName || 'unknown';
        testMetrics.set(testName, {
            start: performance.now(),
            memory: process.memoryUsage().heapUsed,
        });
    });
    global.afterEach(() => {
        const testName = expect.getState().currentTestName || 'unknown';
        const metrics = testMetrics.get(testName);
        if (metrics) {
            const duration = performance.now() - metrics.start;
            const memoryDelta = process.memoryUsage().heapUsed - metrics.memory;
            // Log slow tests
            if (duration > 100) {
                console.warn(`⚠️  Slow test: ${testName} took ${duration.toFixed(2)}ms`);
            }
            // Log memory leaks
            if (memoryDelta > 10 * 1024 * 1024) { // 10MB
                console.warn(`⚠️  Memory leak suspected: ${testName} used ${(memoryDelta / 1024 / 1024).toFixed(2)}MB`);
            }
        }
    });
}
// Clear all mocks between tests
afterEach(() => {
    jest.clearAllMocks();
});
// Export test utilities
export const getMockPrismaClient = () => {
    const { PrismaClient } = jest.requireMock('@teaching-engine/database');
    return new PrismaClient();
};
export const resetAllMocks = () => {
    jest.clearAllMocks();
    jest.resetModules();
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3Rlc3RzL3NldHVwL3VuaXQuc2V0dXAudHMiLCJtYXBwaW5ncyI6IkFBQUE7OztHQUdHO0FBRUgsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQXdDckMseUNBQXlDO0FBQ3pDLElBQUksQ0FBQyxJQUFJLENBQUMsMkJBQTJCLENBQUMsQ0FBQztBQUN2QyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ3BCLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDaEIsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNsQixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ3BCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDcEIsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUN2QixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ3JCLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDckIsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUNuQixJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBQ3ZCLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDeEIsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUMxQixJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ3RCLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7QUFFdEIsc0JBQXNCO0FBQ3RCLElBQUksQ0FBQyxJQUFJLENBQUMseUJBQXlCLENBQUMsQ0FBQztBQUNyQyxJQUFJLENBQUMsSUFBSSxDQUFDLDZCQUE2QixDQUFDLENBQUM7QUFDekMsSUFBSSxDQUFD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QUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDMUcsQ0FBQztRQUNILENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUE0Q0QsZ0NBQWdDO0FBQ2hDLFNBQVMsQ0FBQyxHQUFHLEVBQUU7SUFDYixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7QUFDdkIsQ0FBQyxDQUFDLENBQUM7QUFFSCx3QkFBd0I7QUFDeEIsTUFBTSxDQUFDLE1BQU0sbUJBQW1CLEdBQUcsR0FBRyxFQUFFO0lBQ3RDLE1BQU0sRUFBRSxZQUFZLEVBQUUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLDJCQUEyQixDQUFDLENBQUM7SUFDdkUsT0FBTyxJQUFJLFlBQVksRUFBRSxDQUFDO0FBQzVCLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxNQUFNLGFBQWEsR0FBRyxHQUFHLEVBQUU7SUFDaEMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3JCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztBQUN0QixDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3Rlc3RzL3NldHVwL3VuaXQuc2V0dXAudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBPcHRpbWl6ZWQgVW5pdCBUZXN0IFNldHVwXG4gKiBGYXN0LCBpc29sYXRlZCBzZXR1cCB3aXRoIGNvbXByZWhlbnNpdmUgbW9ja2luZ1xuICovXG5cbmltcG9ydCB7IGplc3QgfSBmcm9tICdAamVzdC9nbG9iYWxzJztcblxuLy8gU2V0IHRlc3QgZW52aXJvbm1lbnRcbnByb2Nlc3MuZW52Lk5PREVfRU5WID0gJ3Rlc3QnO1xucHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCA9ICd0ZXN0LXNlY3JldCc7XG5wcm9jZXNzLmVudi5EQVRBQkFTRV9VUkwgPSAnZmlsZTouL3Rlc3QuZGInO1xuXG4vLyBQZXJmb3JtYW5jZSBtb25pdG9yaW5nIGZvciB0ZXN0c1xuY29uc3QgdGVzdE1ldHJpY3MgPSBuZXcgTWFwPHN0cmluZywgeyBzdGFydDogbnVtYmVyOyBtZW1vcnk6IG51bWJlciB9PigpO1xuXG4vLyBIb29rIGludG8gdGVzdCBsaWZlY3ljbGUgZm9yIHBlcmZvcm1hbmNlIG1vbml0b3JpbmdcbmlmIChwcm9jZXNzLmVudi5NT05JVE9SX1RFU1RfUEVSRk9STUFOQ0UgPT09ICd0cnVlJykge1xuICBnbG9iYWwuYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgY29uc3QgdGVzdE5hbWUgPSBleHBlY3QuZ2V0U3RhdGUoKS5jdXJyZW50VGVzdE5hbWUgfHwgJ3Vua25vd24nO1xuICAgIHRlc3RNZXRyaWNzLnNldCh0ZXN0TmFtZSwge1xuICAgICAgc3RhcnQ6IHBlcmZvcm1hbmNlLm5vdygpLFxuICAgICAgbWVtb3J5OiBwcm9jZXNzLm1lbW9yeVVzYWdlKCkuaGVhcFVzZWQsXG4gICAgfSk7XG4gIH0pO1xuXG4gIGdsb2JhbC5hZnRlckVhY2goKCkgPT4ge1xuICAgIGNvbnN0IHRlc3ROYW1lID0gZXhwZWN0LmdldFN0YXRlKCkuY3VycmVudFRlc3ROYW1lIHx8ICd1bmtub3duJztcbiAgICBjb25zdCBtZXRyaWNzID0gdGVzdE1ldHJpY3MuZ2V0KHRlc3ROYW1lKTtcbiAgICBpZiAobWV0cmljcykge1xuICAgICAgY29uc3QgZHVyYXRpb24gPSBwZXJmb3JtYW5jZS5ub3coKSAtIG1ldHJpY3Muc3RhcnQ7XG4gICAgICBjb25zdCBtZW1vcnlEZWx0YSA9IHByb2Nlc3MubWVtb3J5VXNhZ2UoKS5oZWFwVXNlZCAtIG1ldHJpY3MubWVtb3J5O1xuICAgICAgXG4gICAgICAvLyBMb2cgc2xvdyB0ZXN0c1xuICAgICAgaWYgKGR1cmF0aW9uID4gMTAwKSB7XG4gICAgICAgIGNvbnNvbGUud2Fybihg4pqg77iPICBTbG93IHRlc3Q6ICR7dGVzdE5hbWV9IHRvb2sgJHtkdXJhdGlvbi50b0ZpeGVkKDIpfW1zYCk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIC8vIExvZyBtZW1vcnkgbGVha3NcbiAgICAgIGlmIChtZW1vcnlEZWx0YSA+IDEwICogMTAyNCAqIDEwMjQpIHsgLy8gMTBNQlxuICAgICAgICBjb25zb2xlLndhcm4oYOKaoO+4jyAgTWVtb3J5IGxlYWsgc3VzcGVjdGVkOiAke3Rlc3ROYW1lfSB1c2VkICR7KG1lbW9yeURlbHRhIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMil9TUJgKTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xufVxuXG4vLyBNb2NrIGFsbCBleHRlcm5hbCBkZXBlbmRlbmNpZXMgdXBmcm9udFxuamVzdC5tb2NrKCdAdGVhY2hpbmctZW5naW5lL2RhdGFiYXNlJyk7XG5qZXN0Lm1vY2soJ29wZW5haScpO1xuamVzdC5tb2NrKCdmcycpO1xuamVzdC5tb2NrKCdwYXRoJyk7XG5qZXN0Lm1vY2soJ2NhbnZhcycpO1xuamVzdC5tb2NrKCdwZGZraXQnKTtcbmplc3QubW9jaygncGRmLXBhcnNlJyk7XG5qZXN0Lm1vY2soJ21hbW1vdGgnKTtcbmplc3QubW9jaygnY2hlZXJpbycpO1xuamVzdC5tb2NrKCdheGlvcycpO1xuamVzdC5tb2NrKCdub2RlLWNyb24nKTtcbmplc3QubW9jaygnaGFuZGxlYmFycycpO1xuamVzdC5tb2NrKCdodG1sLXRvLWRvY3gnKTtcbmplc3QubW9jaygnYXJjaGl2ZXInKTtcbmplc3QubW9jaygndW56aXBwZXInKTtcblxuLy8gTW9jayBoZWF2eSBzZXJ2aWNlc1xuamVzdC5tb2NrKCdAL3NlcnZpY2VzL2VtYWlsU2VydmljZScpO1xuamVzdC5tb2NrKCdAL3NlcnZpY2VzL2VtYmVkZGluZ1NlcnZpY2UnKTtcbmplc3QubW9jaygnQC9zZXJ2aWNlcy9sbG1TZXJ2aWNlJyk7XG5qZXN0Lm1vY2soJ0Avc2VydmljZXMvY2x1c3RlcmluZ1NlcnZpY2UnKTtcbmplc3QubW9jaygnQC9zZXJ2aWNlcy9tYXRlcmlhbEdlbmVyYXRvcicpO1xuamVzdC5tb2NrKCdAL3NlcnZpY2VzL2FpUGxhbm5pbmdBc3Npc3RhbnQnKTtcblxuLy8gTW9jayBsb2dnZXIgd2l0aCBuby1vcCBmdW5jdGlvbnMgZm9yIHNwZWVkXG5qZXN0Lm1vY2soJ0AvbG9nZ2VyJywgKCkgPT4gKHtcbiAgX19lc01vZHVsZTogdHJ1ZSxcbiAgZGVmYXVsdDoge1xuICAgIGRlYnVnOiBqZXN0LmZuKCksXG4gICAgaW5mbzogamVzdC5mbigpLFxuICAgIHdhcm46IGplc3QuZm4oKSxcbiAgICBlcnJvcjogamVzdC5mbigpLFxuICAgIGNoaWxkOiBqZXN0LmZuKCgpID0+ICh7XG4gICAgICBkZWJ1ZzogamVzdC5mbigpLFxuICAgICAgaW5mbzogamVzdC5mbigpLFxuICAgICAgd2FybjogamVzdC5mbigpLFxuICAgICAgZXJyb3I6IGplc3QuZm4oKSxcbiAgICB9KSksXG4gIH0sXG59KSk7XG5cbi8vIENsZWFyIGFsbCBtb2NrcyBiZXR3ZWVuIHRlc3RzXG5hZnRlckVhY2goKCkgPT4ge1xuICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbn0pO1xuXG4vLyBFeHBvcnQgdGVzdCB1dGlsaXRpZXNcbmV4cG9ydCBjb25zdCBnZXRNb2NrUHJpc21hQ2xpZW50ID0gKCkgPT4ge1xuICBjb25zdCB7IFByaXNtYUNsaWVudCB9ID0gamVzdC5yZXF1aXJlTW9jaygnQHRlYWNoaW5nLWVuZ2luZS9kYXRhYmFzZScpO1xuICByZXR1cm4gbmV3IFByaXNtYUNsaWVudCgpO1xufTtcblxuZXhwb3J0IGNvbnN0IHJlc2V0QWxsTW9ja3MgPSAoKSA9PiB7XG4gIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICBqZXN0LnJlc2V0TW9kdWxlcygpO1xufTsiXSwidmVyc2lvbiI6M30=