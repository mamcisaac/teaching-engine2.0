2c1d19f7da1bb87f3597b672347224c1
import { Router } from 'express';
import { z } from 'zod';
import { validate, cuidSchema } from '../validation';
import { batchProcessingService } from '../services/batchProcessingService';
const router = Router();
// Validation schemas for batch operations
const unitPlanBatchSchema = z.object({
    title: z.string().min(1).max(255),
    longRangePlanId: cuidSchema(),
    description: z.string().max(2000).optional(),
    bigIdeas: z.string().max(2000).optional(),
    essentialQuestions: z.array(z.string().max(500)).max(20).optional(),
    startDate: z.string().datetime(),
    endDate: z.string().datetime(),
    estimatedHours: z.number().int().positive().max(1000).optional(),
    assessmentPlan: z.string().max(2000).optional(),
    successCriteria: z.array(z.string().max(500)).max(20).optional(),
    expectationIds: z.array(cuidSchema()).max(50).min(1),
    crossCurricularConnections: z.string().max(1000).optional(),
    learningSkills: z.array(z.string().max(100)).max(10).optional(),
    culminatingTask: z.string().max(1000).optional(),
    keyVocabulary: z.array(z.string().max(100)).max(30).optional(),
    priorKnowledge: z.string().max(1000).optional(),
    parentCommunicationPlan: z.string().max(1000).optional(),
    fieldTripsAndGuestSpeakers: z.string().max(1000).optional(),
    differentiationStrategies: z.object({
        forStruggling: z.array(z.string().max(200)).max(10).optional(),
        forAdvanced: z.array(z.string().max(200)).max(10).optional(),
        forELL: z.array(z.string().max(200)).max(10).optional(),
        forIEP: z.array(z.string().max(200)).max(10).optional(),
    }).optional(),
    indigenousPerspectives: z.string().max(1000).optional(),
    environmentalEducation: z.string().max(1000).optional(),
    socialJusticeConnections: z.string().max(1000).optional(),
    technologyIntegration: z.string().max(1000).optional(),
    communityConnections: z.string().max(1000).optional(),
});
const lessonPlanBatchSchema = z.object({
    title: z.string().min(1).max(255),
    unitPlanId: cuidSchema(),
    date: z.string().datetime(),
    duration: z.number().int().min(5).max(480),
    mindsOn: z.string().max(2000).optional(),
    action: z.string().max(2000).optional(),
    consolidation: z.string().max(2000).optional(),
    learningGoals: z.string().max(1000).optional(),
    materials: z.array(z.string().max(200)).max(30).optional(),
    grouping: z.string().max(500).optional(),
    accommodations: z.array(z.string().max(200)).max(20).optional(),
    modifications: z.array(z.string().max(200)).max(20).optional(),
    extensions: z.array(z.string().max(200)).max(20).optional(),
    assessmentType: z.enum(['diagnostic', 'formative', 'summative']).optional(),
    assessmentNotes: z.string().max(1000).optional(),
    isSubFriendly: z.boolean().default(false),
    subNotes: z.string().max(500).optional(),
    expectationIds: z.array(cuidSchema()).max(20).optional(),
});
const batchOperationSchema = z.object({
    operations: z.array(z.object({
        type: z.enum(['unit', 'lesson', 'expectation', 'resource']),
        data: z.unknown(), // Will be validated based on type
    })).max(100, 'Maximum 100 operations per batch'),
    options: z.object({
        batchSize: z.number().int().min(1).max(20).default(10),
        maxRetries: z.number().int().min(0).max(5).default(3),
        retryDelay: z.number().int().min(100).max(10000).default(1000),
    }).optional(),
});
// Add operations to batch queue
router.post('/operations', validate(batchOperationSchema), async (req, res, next) => {
    try {
        const userId = req.user?.id;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const { operations, options: _options = {} } = req.body;
        // Validate each operation based on its type
        const validatedOperations = [];
        for (const operation of operations) {
            let validatedData;
            switch (operation.type) {
                case 'unit': {
                    const unitResult = unitPlanBatchSchema.safeParse(operation.data);
                    if (!unitResult.success) {
                        return res.status(400).json({
                            error: 'Invalid unit plan data',
                            details: unitResult.error.errors,
                        });
                    }
                    validatedData = unitResult.data;
                    break;
                }
                case 'lesson': {
                    const lessonResult = lessonPlanBatchSchema.safeParse(operation.data);
                    if (!lessonResult.success) {
                        return res.status(400).json({
                            error: 'Invalid lesson plan data',
                            details: lessonResult.error.errors,
                        });
                    }
                    validatedData = lessonResult.data;
                    break;
                }
                default:
                    return res.status(400).json({
                        error: `Unsupported operation type: ${operation.type}`,
                    });
            }
            validatedOperations.push({
                type: operation.type,
                data: validatedData,
            });
        }
        // Validate the batch before adding to queue
        const validation = await batchProcessingService.validateBatch(validatedOperations.map(op => ({
            ...op,
            id: '',
            status: 'pending',
            createdAt: new Date(),
            updatedAt: new Date(),
        })));
        if (!validation.valid) {
            return res.status(400).json({
                error: 'Batch validation failed',
                details: validation.errors,
                warnings: validation.warnings,
            });
        }
        // Add operations to queue
        const operationIds = await batchProcessingService.addOperations(validatedOperations, userId.toString());
        res.status(201).json({
            message: 'Operations added to batch queue',
            operationIds,
            count: operationIds.length,
            warnings: validation.warnings,
        });
    }
    catch (error) {
        next(error);
    }
});
// Process batch operations
router.post('/process', async (req, res, next) => {
    try {
        const userId = req.user?.id;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const { batchSize = 10, maxRetries = 3, retryDelay = 1000 } = req.body;
        // Validate processing options
        if (batchSize < 1 || batchSize > 20) {
            return res.status(400).json({ error: 'Batch size must be between 1 and 20' });
        }
        if (maxRetries < 0 || maxRetries > 5) {
            return res.status(400).json({ error: 'Max retries must be between 0 and 5' });
        }
        if (retryDelay < 100 || retryDelay > 10000) {
            return res.status(400).json({ error: 'Retry delay must be between 100 and 10000 ms' });
        }
        const result = await batchProcessingService.processBatch(userId.toString(), {
            batchSize,
            maxRetries,
            retryDelay,
        });
        res.json({
            message: 'Batch processing completed',
            successful: result.successful,
            failed: result.failed,
            totalProcessed: result.successful + result.failed,
        });
    }
    catch (error) {
        if (error.message.includes('already in progress')) {
            return res.status(409).json({ error: error.message });
        }
        next(error);
    }
});
// Get batch processing status
router.get('/status', async (req, res, next) => {
    try {
        const userId = req.user?.id;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const status = batchProcessingService.getBatchStatus(userId.toString());
        res.json({
            isProcessing: status.isProcessing,
            queueLength: status.queueLength,
            operations: status.operations.map(op => ({
                id: op.id,
                type: op.type,
                status: op.status,
                progress: op.progress || 0,
                errors: op.errors || [],
                retryCount: op.retryCount || 0,
                createdAt: op.createdAt,
                updatedAt: op.updatedAt,
            })),
        });
    }
    catch (error) {
        next(error);
    }
});
// Clear completed operations
router.delete('/completed', async (req, res, next) => {
    try {
        const userId = req.user?.id;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        batchProcessingService.clearCompletedOperations(userId.toString());
        res.json({ message: 'Completed operations cleared from queue' });
    }
    catch (error) {
        next(error);
    }
});
// Health check for batch processing service
router.get('/health', async (req, res, next) => {
    try {
        const health = await batchProcessingService.healthCheck();
        res.status(health.healthy ? 200 : 503).json(health);
    }
    catch (error) {
        next(error);
    }
});
export default router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9yb3V0ZXMvYmF0Y2gtcHJvY2Vzc2luZy50cyIsIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFXLE1BQU0sU0FBUyxDQUFDO0FBQzFDLE9BQU8sRUFBRSxDQUFDLEVBQUUsTUFBTSxLQUFLLENBQUM7QUFDeEIsT0FBTyxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFHNUUsTUFBTSxNQUFNLEdBQUcsTUFBTSxFQUFFLENBQUM7QUFFeEIsMENBQTBDO0FBQzFDLE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUNuQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDO0lBQ2pDLGVBQWUsRUFBRSxVQUFVLEVBQUU7SUFDN0IsV0FBVyxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFO0lBQzVDLFFBQVEsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLFFBQVEsRUFBRTtJQUN6QyxrQkFBa0IsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsUUFBUSxFQUFFO0lBQ25FLFNBQVMsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0lBQ2hDLE9BQU8sRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0lBQzlCLGNBQWMsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLFFBQVEsRUFBRTtJQUNoRSxjQUFjLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUU7SUFDL0MsZUFBZSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxRQUFRLEVBQUU7SUFDaEUsY0FBYyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNwRCwwQkFBMEIsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLFFBQVEsRUFBRTtJQUMzRCxjQUFjLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLFFBQVEsRUFBRTtJQUMvRCxlQUFlLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUU7SUFDaEQsYUFBYSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxRQUFRLEVBQUU7SUFDOUQsY0FBYyxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFO0lBQy9DLHVCQUF1QixFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFO0lBQ3hELDBCQUEwQixFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFO0lBQzNELHlCQUF5QixFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUM7UUFDbEMsYUFBYSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxRQUFRLEVBQUU7UUFDOUQsV0FBVyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxRQUFRLEVBQUU7UUFDNUQsTUFBTSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxRQUFRLEVBQUU7UUFDdkQsTUFBTSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxRQUFRLEVBQUU7S0FDeEQsQ0FBQyxDQUFDLFFBQVEsRUFBRTtJQUNiLHNCQUFzQixFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFO0lBQ3ZELHNCQUFzQixFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFO0lBQ3ZELHdCQUF3QixFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFO0lBQ3pELHFCQUFxQixFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFO0lBQ3RELG9CQUFvQixFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFO0NBQ3RELENBQUMsQ0FBQztBQUVILE1BQU0scUJBQXFCLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUNyQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDO0lBQ2pDLFVBQVUsRUFBRSxVQUFVLEVBQUU7SUFDeEIsSUFBSSxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLEVBQUU7SUFDM0IsUUFBUSxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztJQUMxQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUU7SUFDeEMsTUFBTSxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFO0lBQ3ZDLGFBQWEsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLFFBQVEsRUFBRTtJQUM5QyxhQUFhLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUU7SUFDOUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxRQUFRLEVBQUU7SUFDMUQsUUFBUSxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxFQUFFO0lBQ3hDLGNBQWMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsUUFBUSxFQUFFO0lBQy9ELGFBQWEsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsUUFBUSxFQUFFO0lBQzlELFVBQVUsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsUUFBUSxFQUFFO0lBQzNELGNBQWMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsWUFBWSxFQUFFLFdBQVcsRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRTtJQUMzRSxlQUFlLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUU7SUFDaEQsYUFBYSxFQUFFLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDO0lBQ3pDLFFBQVEsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFFBQVEsRUFBRTtJQUN4QyxjQUFjLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxRQUFRLEVBQUU7Q0FDekQsQ0FBQyxDQUFDO0FBRUgsTUFBTSxvQkFBb0IsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDO0lBQ3BDLFVBQVUsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUNqQixDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ1AsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLGFBQWEsRUFBRSxVQUFVLENBQUMsQ0FBQztRQUMzRCxJQUFJLEVBQUUsQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLGtDQUFrQztLQUN0RCxDQUFDLENBQ0gsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLGtDQUFrQyxDQUFDO0lBQzlDLE9BQU8sRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ2hCLFNBQVMsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1FBQ3RELFVBQVUsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQ3JELFVBQVUsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDO0tBQy9ELENBQUMsQ0FBQyxRQUFRLEVBQUU7Q0FDZCxDQUFDLENBQUM7QUFFSCxnQ0FBZ0M7QUFDaEMsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsUUFBUSxDQUFDLG9CQUFvQixDQUFDLEVBQUUsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUU7SUFDM0YsSUFBSSxDQUFDO1FBQ0gsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ1osT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFDO1FBQ3pELENBQUM7UUFFRCxNQUFNLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxRQUFRLEdBQUcsRUFBRSxFQUFFLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztRQUV4RCw0Q0FBNEM7UUFDNUMsTUFBTSxtQkFBbUIsR0FBRyxFQUFFLENBQUM7UUFDL0IsS0FBSyxNQUFNLFNBQVMsSUFBSSxVQUFVLEVBQUUsQ0FBQztZQUNuQyxJQUFJLGFBQWEsQ0FBQztZQUVsQixRQUFRLFNBQVMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDdkIsS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDO29CQUNaLE1BQU0sVUFBVSxHQUFHLG1CQUFtQixDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ2pFLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLENBQUM7d0JBQ3hCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7NEJBQzFCLEtBQUssRUFBRSx3QkFBd0I7NEJBQy9CLE9BQU8sRUFBRSxVQUFVLENBQUMsS0FBSyxDQUFDLE1BQU07eUJBQ2pDLENBQUMsQ0FBQztvQkFDTCxDQUFDO29CQUNELGFBQWEsR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDO29CQUNoQyxNQUFNO2dCQUNSLENBQUM7Z0JBRUQsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDO29CQUNkLE1BQU0sWUFBWSxHQUFHLHFCQUFxQixDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ3JFLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLENBQUM7d0JBQzFCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7NEJBQzFCLEtBQUssRUFBRSwwQkFBMEI7NEJBQ2pDLE9BQU8sRUFBRSxZQUFZLENBQUMsS0FBSyxDQUFDLE1BQU07eUJBQ25DLENBQUMsQ0FBQztvQkFDTCxDQUFDO29CQUNELGFBQWEsR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDO29CQUNsQyxNQUFNO2dCQUNSLENBQUM7Z0JBRUQ7b0JBQ0UsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQzt3QkFDMUIsS0FBSyxFQUFFLCtCQUErQixTQUFTLENBQUMsSUFBSSxFQUFFO3FCQUN2RCxDQUFDLENBQUM7WUFDUCxDQUFDO1lBRUQsbUJBQW1CLENBQUMsSUFBSSxDQUFDO2dCQUN2QixJQUFJLEVBQUUsU0FBUyxDQUFDLElBQUk7Z0JBQ3BCLElBQUksRUFBRSxhQUFhO2FBQ3BCLENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCw0Q0FBNEM7UUFDNUMsTUFBTSxVQUFVLEdBQUcsTUFBTSxzQkFBc0IsQ0FBQyxhQUFhLENBQzNELG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDN0IsR0FBRyxFQUFFO1lBQ0wsRUFBRSxFQUFFLEVBQUU7WUFDTixNQUFNLEVBQUUsU0FBa0I7WUFDMUIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO1lBQ3JCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtTQUN0QixDQUFDLENBQUMsQ0FDSixDQUFDO1FBRUYsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUN0QixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUMxQixLQUFLLEVBQUUseUJBQXlCO2dCQUNoQyxPQUFPLEVBQUUsVUFBVSxDQUFDLE1BQU07Z0JBQzFCLFFBQVEsRUFBRSxVQUFVLENBQUMsUUFBUTthQUM5QixDQUFDLENBQUM7UUFDTCxDQUFDO1FBRUQsMEJBQTBCO1FBQzFCLE1BQU0sWUFBWSxHQUFHLE1BQU0sc0JBQXNCLENBQUMsYUFBYSxDQUFDLG1CQUFtQixFQUFFLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO1FBRXhHLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQ25CLE9BQU8sRUFBRSxpQ0FBaUM7WUFDMUMsWUFBWTtZQUNaLEtBQUssRUFBRSxZQUFZLENBQUMsTUFBTTtZQUMxQixRQUFRLEVBQUUsVUFBVSxDQUFDLFFBQVE7U0FDOUIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDZCxDQUFDO0FBQ0gsQ0FBQyxDQUFDLENBQUM7QUFFSCwyQkFBMkI7QUFDM0IsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUU7SUFDeEQsSUFBSSxDQUFDO1FBQ0gsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ1osT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFDO1FBQ3pELENBQUM7UUFFRCxNQUFNLEVBQUUsU0FBUyxHQUFHLEVBQUUsRUFBRSxVQUFVLEdBQUcsQ0FBQyxFQUFFLFVBQVUsR0FBRyxJQUFJLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBRXZFLDhCQUE4QjtRQUM5QixJQUFJLFNBQVMsR0FBRyxDQUFDLElBQUksU0FBUyxHQUFHLEVBQUUsRUFBRSxDQUFDO1lBQ3BDLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUscUNBQXFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2hGLENBQUM7UUFFRCxJQUFJLFVBQVUsR0FBRyxDQUFDLElBQUksVUFBVSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ3JDLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUscUNBQXFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2hGLENBQUM7UUFFRCxJQUFJLFVBQVUsR0FBRyxHQUFHLElBQUksVUFBVSxHQUFHLEtBQUssRUFBRSxDQUFDO1lBQzNDLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsOENBQThDLEVBQUUsQ0FBQyxDQUFDO1FBQ3pGLENBQUM7UUFFRCxNQUFNLE1BQU0sR0FBRyxNQUFNLHNCQUFzQixDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLEVBQUU7WUFDMUUsU0FBUztZQUNULFVBQVU7WUFDVixVQUFVO1NBQ1gsQ0FBQyxDQUFDO1FBRUgsR0FBRyxDQUFDLElBQUksQ0FBQztZQUNQLE9BQU8sRUFBRSw0QkFBNEI7WUFDckMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxVQUFVO1lBQzdCLE1BQU0sRUFBRSxNQUFNLENBQUMsTUFBTTtZQUNyQixjQUFjLEVBQUUsTUFBTSxDQUFDLFVBQVUsR0FBRyxNQUFNLENBQUMsTUFBTTtTQUNsRCxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMscUJBQXFCLENBQUMsRUFBRSxDQUFDO1lBQ2xELE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7UUFDeEQsQ0FBQztRQUNELElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNkLENBQUM7QUFDSCxDQUFDLENBQUMsQ0FBQztBQUVILDhCQUE4QjtBQUM5QixNQUFNLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsRUFBRTtJQUN0RCxJQUFJLENBQUM7UUFDSCxNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQztRQUM1QixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDWixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLGNBQWMsRUFBRSxDQUFDLENBQUM7UUFDekQsQ0FBQztRQUVELE1BQU0sTUFBTSxHQUFHLHNCQUFzQixDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztRQUV4RSxHQUFHLENBQUMsSUFBSSxDQUFDO1lBQ1AsWUFBWSxFQUFFLE1BQU0sQ0FBQyxZQUFZO1lBQ2pDLFdBQVcsRUFBRSxNQUFNLENBQUMsV0FBVztZQUMvQixVQUFVLEVBQUUsTUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUN2QyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUU7Z0JBQ1QsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJO2dCQUNiLE1BQU0sRUFBRSxFQUFFLENBQUMsTUFBTTtnQkFDakIsUUFBUSxFQUFFLEVBQUUsQ0FBQyxRQUFRLElBQUksQ0FBQztnQkFDMUIsTUFBTSxFQUFFLEVBQUUsQ0FBQyxNQUFNLElBQUksRUFBRTtnQkFDdkIsVUFBVSxFQUFFLEVBQUUsQ0FBQyxVQUFVLElBQUksQ0FBQztnQkFDOUIsU0FBUyxFQUFFLEVBQUUsQ0FBQyxTQUFTO2dCQUN2QixTQUFTLEVBQUUsRUFBRSxDQUFDLFNBQVM7YUFDeEIsQ0FBQyxDQUFDO1NBQ0osQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDZCxDQUFDO0FBQ0gsQ0FBQyxDQUFDLENBQUM7QUFFSCw2QkFBNkI7QUFDN0IsTUFBTSxDQUFDLE1BQU0sQ0FBQyxZQUFZLEVBQUUsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUU7SUFDNUQsSUFBSSxDQUFDO1FBQ0gsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ1osT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFDO1FBQ3pELENBQUM7UUFFRCxzQkFBc0IsQ0FBQyx3QkFBd0IsQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztRQUVuRSxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLHlDQUF5QyxFQUFFLENBQUMsQ0FBQztJQUNuRSxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNkLENBQUM7QUFDSCxDQUFDLENBQUMsQ0FBQztBQUVILDRDQUE0QztBQUM1QyxNQUFNLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsRUFBRTtJQUN0RCxJQUFJLENBQUM7UUFDSCxNQUFNLE1BQU0sR0FBRyxNQUFNLHNCQUFzQixDQUFDLFdBQVcsRUFBRSxDQUFDO1FBRTFELEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDZCxDQUFDO0FBQ0gsQ0FBQyxDQUFDLENBQUM7QUFFSCxlQUFlLE1BQU0sQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWljaGFlbG1jaXNhYWMvR2l0SHViL3RlYWNoaW5nLWVuZ2luZTIuMC9zZXJ2ZXIvc3JjL3JvdXRlcy9iYXRjaC1wcm9jZXNzaW5nLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJvdXRlciwgUmVxdWVzdCB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgeiB9IGZyb20gJ3pvZCc7XG5pbXBvcnQgeyB2YWxpZGF0ZSwgY3VpZFNjaGVtYSB9IGZyb20gJy4uL3ZhbGlkYXRpb24nO1xuaW1wb3J0IHsgYmF0Y2hQcm9jZXNzaW5nU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2JhdGNoUHJvY2Vzc2luZ1NlcnZpY2UnO1xuXG5cbmNvbnN0IHJvdXRlciA9IFJvdXRlcigpO1xuXG4vLyBWYWxpZGF0aW9uIHNjaGVtYXMgZm9yIGJhdGNoIG9wZXJhdGlvbnNcbmNvbnN0IHVuaXRQbGFuQmF0Y2hTY2hlbWEgPSB6Lm9iamVjdCh7XG4gIHRpdGxlOiB6LnN0cmluZygpLm1pbigxKS5tYXgoMjU1KSxcbiAgbG9uZ1JhbmdlUGxhbklkOiBjdWlkU2NoZW1hKCksXG4gIGRlc2NyaXB0aW9uOiB6LnN0cmluZygpLm1heCgyMDAwKS5vcHRpb25hbCgpLFxuICBiaWdJZGVhczogei5zdHJpbmcoKS5tYXgoMjAwMCkub3B0aW9uYWwoKSxcbiAgZXNzZW50aWFsUXVlc3Rpb25zOiB6LmFycmF5KHouc3RyaW5nKCkubWF4KDUwMCkpLm1heCgyMCkub3B0aW9uYWwoKSxcbiAgc3RhcnREYXRlOiB6LnN0cmluZygpLmRhdGV0aW1lKCksXG4gIGVuZERhdGU6IHouc3RyaW5nKCkuZGF0ZXRpbWUoKSxcbiAgZXN0aW1hdGVkSG91cnM6IHoubnVtYmVyKCkuaW50KCkucG9zaXRpdmUoKS5tYXgoMTAwMCkub3B0aW9uYWwoKSxcbiAgYXNzZXNzbWVudFBsYW46IHouc3RyaW5nKCkubWF4KDIwMDApLm9wdGlvbmFsKCksXG4gIHN1Y2Nlc3NDcml0ZXJpYTogei5hcnJheSh6LnN0cmluZygpLm1heCg1MDApKS5tYXgoMjApLm9wdGlvbmFsKCksXG4gIGV4cGVjdGF0aW9uSWRzOiB6LmFycmF5KGN1aWRTY2hlbWEoKSkubWF4KDUwKS5taW4oMSksXG4gIGNyb3NzQ3VycmljdWxhckNvbm5lY3Rpb25zOiB6LnN0cmluZygpLm1heCgxMDAwKS5vcHRpb25hbCgpLFxuICBsZWFybmluZ1NraWxsczogei5hcnJheSh6LnN0cmluZygpLm1heCgxMDApKS5tYXgoMTApLm9wdGlvbmFsKCksXG4gIGN1bG1pbmF0aW5nVGFzazogei5zdHJpbmcoKS5tYXgoMTAwMCkub3B0aW9uYWwoKSxcbiAga2V5Vm9jYWJ1bGFyeTogei5hcnJheSh6LnN0cmluZygpLm1heCgxMDApKS5tYXgoMzApLm9wdGlvbmFsKCksXG4gIHByaW9yS25vd2xlZGdlOiB6LnN0cmluZygpLm1heCgxMDAwKS5vcHRpb25hbCgpLFxuICBwYXJlbnRDb21tdW5pY2F0aW9uUGxhbjogei5zdHJpbmcoKS5tYXgoMTAwMCkub3B0aW9uYWwoKSxcbiAgZmllbGRUcmlwc0FuZEd1ZXN0U3BlYWtlcnM6IHouc3RyaW5nKCkubWF4KDEwMDApLm9wdGlvbmFsKCksXG4gIGRpZmZlcmVudGlhdGlvblN0cmF0ZWdpZXM6IHoub2JqZWN0KHtcbiAgICBmb3JTdHJ1Z2dsaW5nOiB6LmFycmF5KHouc3RyaW5nKCkubWF4KDIwMCkpLm1heCgxMCkub3B0aW9uYWwoKSxcbiAgICBmb3JBZHZhbmNlZDogei5hcnJheSh6LnN0cmluZygpLm1heCgyMDApKS5tYXgoMTApLm9wdGlvbmFsKCksXG4gICAgZm9yRUxMOiB6LmFycmF5KHouc3RyaW5nKCkubWF4KDIwMCkpLm1heCgxMCkub3B0aW9uYWwoKSxcbiAgICBmb3JJRVA6IHouYXJyYXkoei5zdHJpbmcoKS5tYXgoMjAwKSkubWF4KDEwKS5vcHRpb25hbCgpLFxuICB9KS5vcHRpb25hbCgpLFxuICBpbmRpZ2Vub3VzUGVyc3BlY3RpdmVzOiB6LnN0cmluZygpLm1heCgxMDAwKS5vcHRpb25hbCgpLFxuICBlbnZpcm9ubWVudGFsRWR1Y2F0aW9uOiB6LnN0cmluZygpLm1heCgxMDAwKS5vcHRpb25hbCgpLFxuICBzb2NpYWxKdXN0aWNlQ29ubmVjdGlvbnM6IHouc3RyaW5nKCkubWF4KDEwMDApLm9wdGlvbmFsKCksXG4gIHRlY2hub2xvZ3lJbnRlZ3JhdGlvbjogei5zdHJpbmcoKS5tYXgoMTAwMCkub3B0aW9uYWwoKSxcbiAgY29tbXVuaXR5Q29ubmVjdGlvbnM6IHouc3RyaW5nKCkubWF4KDEwMDApLm9wdGlvbmFsKCksXG59KTtcblxuY29uc3QgbGVzc29uUGxhbkJhdGNoU2NoZW1hID0gei5vYmplY3Qoe1xuICB0aXRsZTogei5zdHJpbmcoKS5taW4oMSkubWF4KDI1NSksXG4gIHVuaXRQbGFuSWQ6IGN1aWRTY2hlbWEoKSxcbiAgZGF0ZTogei5zdHJpbmcoKS5kYXRldGltZSgpLFxuICBkdXJhdGlvbjogei5udW1iZXIoKS5pbnQoKS5taW4oNSkubWF4KDQ4MCksXG4gIG1pbmRzT246IHouc3RyaW5nKCkubWF4KDIwMDApLm9wdGlvbmFsKCksXG4gIGFjdGlvbjogei5zdHJpbmcoKS5tYXgoMjAwMCkub3B0aW9uYWwoKSxcbiAgY29uc29saWRhdGlvbjogei5zdHJpbmcoKS5tYXgoMjAwMCkub3B0aW9uYWwoKSxcbiAgbGVhcm5pbmdHb2Fsczogei5zdHJpbmcoKS5tYXgoMTAwMCkub3B0aW9uYWwoKSxcbiAgbWF0ZXJpYWxzOiB6LmFycmF5KHouc3RyaW5nKCkubWF4KDIwMCkpLm1heCgzMCkub3B0aW9uYWwoKSxcbiAgZ3JvdXBpbmc6IHouc3RyaW5nKCkubWF4KDUwMCkub3B0aW9uYWwoKSxcbiAgYWNjb21tb2RhdGlvbnM6IHouYXJyYXkoei5zdHJpbmcoKS5tYXgoMjAwKSkubWF4KDIwKS5vcHRpb25hbCgpLFxuICBtb2RpZmljYXRpb25zOiB6LmFycmF5KHouc3RyaW5nKCkubWF4KDIwMCkpLm1heCgyMCkub3B0aW9uYWwoKSxcbiAgZXh0ZW5zaW9uczogei5hcnJheSh6LnN0cmluZygpLm1heCgyMDApKS5tYXgoMjApLm9wdGlvbmFsKCksXG4gIGFzc2Vzc21lbnRUeXBlOiB6LmVudW0oWydkaWFnbm9zdGljJywgJ2Zvcm1hdGl2ZScsICdzdW1tYXRpdmUnXSkub3B0aW9uYWwoKSxcbiAgYXNzZXNzbWVudE5vdGVzOiB6LnN0cmluZygpLm1heCgxMDAwKS5vcHRpb25hbCgpLFxuICBpc1N1YkZyaWVuZGx5OiB6LmJvb2xlYW4oKS5kZWZhdWx0KGZhbHNlKSxcbiAgc3ViTm90ZXM6IHouc3RyaW5nKCkubWF4KDUwMCkub3B0aW9uYWwoKSxcbiAgZXhwZWN0YXRpb25JZHM6IHouYXJyYXkoY3VpZFNjaGVtYSgpKS5tYXgoMjApLm9wdGlvbmFsKCksXG59KTtcblxuY29uc3QgYmF0Y2hPcGVyYXRpb25TY2hlbWEgPSB6Lm9iamVjdCh7XG4gIG9wZXJhdGlvbnM6IHouYXJyYXkoXG4gICAgei5vYmplY3Qoe1xuICAgICAgdHlwZTogei5lbnVtKFsndW5pdCcsICdsZXNzb24nLCAnZXhwZWN0YXRpb24nLCAncmVzb3VyY2UnXSksXG4gICAgICBkYXRhOiB6LnVua25vd24oKSwgLy8gV2lsbCBiZSB2YWxpZGF0ZWQgYmFzZWQgb24gdHlwZVxuICAgIH0pXG4gICkubWF4KDEwMCwgJ01heGltdW0gMTAwIG9wZXJhdGlvbnMgcGVyIGJhdGNoJyksXG4gIG9wdGlvbnM6IHoub2JqZWN0KHtcbiAgICBiYXRjaFNpemU6IHoubnVtYmVyKCkuaW50KCkubWluKDEpLm1heCgyMCkuZGVmYXVsdCgxMCksXG4gICAgbWF4UmV0cmllczogei5udW1iZXIoKS5pbnQoKS5taW4oMCkubWF4KDUpLmRlZmF1bHQoMyksXG4gICAgcmV0cnlEZWxheTogei5udW1iZXIoKS5pbnQoKS5taW4oMTAwKS5tYXgoMTAwMDApLmRlZmF1bHQoMTAwMCksXG4gIH0pLm9wdGlvbmFsKCksXG59KTtcblxuLy8gQWRkIG9wZXJhdGlvbnMgdG8gYmF0Y2ggcXVldWVcbnJvdXRlci5wb3N0KCcvb3BlcmF0aW9ucycsIHZhbGlkYXRlKGJhdGNoT3BlcmF0aW9uU2NoZW1hKSwgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzLCBuZXh0KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXI/LmlkO1xuICAgIGlmICghdXNlcklkKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBlcnJvcjogJ1VuYXV0aG9yaXplZCcgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgeyBvcGVyYXRpb25zLCBvcHRpb25zOiBfb3B0aW9ucyA9IHt9IH0gPSByZXEuYm9keTtcblxuICAgIC8vIFZhbGlkYXRlIGVhY2ggb3BlcmF0aW9uIGJhc2VkIG9uIGl0cyB0eXBlXG4gICAgY29uc3QgdmFsaWRhdGVkT3BlcmF0aW9ucyA9IFtdO1xuICAgIGZvciAoY29uc3Qgb3BlcmF0aW9uIG9mIG9wZXJhdGlvbnMpIHtcbiAgICAgIGxldCB2YWxpZGF0ZWREYXRhO1xuICAgICAgXG4gICAgICBzd2l0Y2ggKG9wZXJhdGlvbi50eXBlKSB7XG4gICAgICAgIGNhc2UgJ3VuaXQnOiB7XG4gICAgICAgICAgY29uc3QgdW5pdFJlc3VsdCA9IHVuaXRQbGFuQmF0Y2hTY2hlbWEuc2FmZVBhcnNlKG9wZXJhdGlvbi5kYXRhKTtcbiAgICAgICAgICBpZiAoIXVuaXRSZXN1bHQuc3VjY2Vzcykge1xuICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICAgICAgZXJyb3I6ICdJbnZhbGlkIHVuaXQgcGxhbiBkYXRhJyxcbiAgICAgICAgICAgICAgZGV0YWlsczogdW5pdFJlc3VsdC5lcnJvci5lcnJvcnMsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdmFsaWRhdGVkRGF0YSA9IHVuaXRSZXN1bHQuZGF0YTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICAgIFxuICAgICAgICBjYXNlICdsZXNzb24nOiB7XG4gICAgICAgICAgY29uc3QgbGVzc29uUmVzdWx0ID0gbGVzc29uUGxhbkJhdGNoU2NoZW1hLnNhZmVQYXJzZShvcGVyYXRpb24uZGF0YSk7XG4gICAgICAgICAgaWYgKCFsZXNzb25SZXN1bHQuc3VjY2Vzcykge1xuICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICAgICAgZXJyb3I6ICdJbnZhbGlkIGxlc3NvbiBwbGFuIGRhdGEnLFxuICAgICAgICAgICAgICBkZXRhaWxzOiBsZXNzb25SZXN1bHQuZXJyb3IuZXJyb3JzLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHZhbGlkYXRlZERhdGEgPSBsZXNzb25SZXN1bHQuZGF0YTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICAgIFxuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgICBlcnJvcjogYFVuc3VwcG9ydGVkIG9wZXJhdGlvbiB0eXBlOiAke29wZXJhdGlvbi50eXBlfWAsXG4gICAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIHZhbGlkYXRlZE9wZXJhdGlvbnMucHVzaCh7XG4gICAgICAgIHR5cGU6IG9wZXJhdGlvbi50eXBlLFxuICAgICAgICBkYXRhOiB2YWxpZGF0ZWREYXRhLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgdGhlIGJhdGNoIGJlZm9yZSBhZGRpbmcgdG8gcXVldWVcbiAgICBjb25zdCB2YWxpZGF0aW9uID0gYXdhaXQgYmF0Y2hQcm9jZXNzaW5nU2VydmljZS52YWxpZGF0ZUJhdGNoKFxuICAgICAgdmFsaWRhdGVkT3BlcmF0aW9ucy5tYXAob3AgPT4gKHtcbiAgICAgICAgLi4ub3AsXG4gICAgICAgIGlkOiAnJyxcbiAgICAgICAgc3RhdHVzOiAncGVuZGluZycgYXMgY29uc3QsXG4gICAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgfSkpXG4gICAgKTtcblxuICAgIGlmICghdmFsaWRhdGlvbi52YWxpZCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgZXJyb3I6ICdCYXRjaCB2YWxpZGF0aW9uIGZhaWxlZCcsXG4gICAgICAgIGRldGFpbHM6IHZhbGlkYXRpb24uZXJyb3JzLFxuICAgICAgICB3YXJuaW5nczogdmFsaWRhdGlvbi53YXJuaW5ncyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIEFkZCBvcGVyYXRpb25zIHRvIHF1ZXVlXG4gICAgY29uc3Qgb3BlcmF0aW9uSWRzID0gYXdhaXQgYmF0Y2hQcm9jZXNzaW5nU2VydmljZS5hZGRPcGVyYXRpb25zKHZhbGlkYXRlZE9wZXJhdGlvbnMsIHVzZXJJZC50b1N0cmluZygpKTtcblxuICAgIHJlcy5zdGF0dXMoMjAxKS5qc29uKHtcbiAgICAgIG1lc3NhZ2U6ICdPcGVyYXRpb25zIGFkZGVkIHRvIGJhdGNoIHF1ZXVlJyxcbiAgICAgIG9wZXJhdGlvbklkcyxcbiAgICAgIGNvdW50OiBvcGVyYXRpb25JZHMubGVuZ3RoLFxuICAgICAgd2FybmluZ3M6IHZhbGlkYXRpb24ud2FybmluZ3MsXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbmV4dChlcnJvcik7XG4gIH1cbn0pO1xuXG4vLyBQcm9jZXNzIGJhdGNoIG9wZXJhdGlvbnNcbnJvdXRlci5wb3N0KCcvcHJvY2VzcycsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlcywgbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyPy5pZDtcbiAgICBpZiAoIXVzZXJJZCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICdVbmF1dGhvcml6ZWQnIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHsgYmF0Y2hTaXplID0gMTAsIG1heFJldHJpZXMgPSAzLCByZXRyeURlbGF5ID0gMTAwMCB9ID0gcmVxLmJvZHk7XG5cbiAgICAvLyBWYWxpZGF0ZSBwcm9jZXNzaW5nIG9wdGlvbnNcbiAgICBpZiAoYmF0Y2hTaXplIDwgMSB8fCBiYXRjaFNpemUgPiAyMCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgZXJyb3I6ICdCYXRjaCBzaXplIG11c3QgYmUgYmV0d2VlbiAxIGFuZCAyMCcgfSk7XG4gICAgfVxuXG4gICAgaWYgKG1heFJldHJpZXMgPCAwIHx8IG1heFJldHJpZXMgPiA1KSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ01heCByZXRyaWVzIG11c3QgYmUgYmV0d2VlbiAwIGFuZCA1JyB9KTtcbiAgICB9XG5cbiAgICBpZiAocmV0cnlEZWxheSA8IDEwMCB8fCByZXRyeURlbGF5ID4gMTAwMDApIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiAnUmV0cnkgZGVsYXkgbXVzdCBiZSBiZXR3ZWVuIDEwMCBhbmQgMTAwMDAgbXMnIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGJhdGNoUHJvY2Vzc2luZ1NlcnZpY2UucHJvY2Vzc0JhdGNoKHVzZXJJZC50b1N0cmluZygpLCB7XG4gICAgICBiYXRjaFNpemUsXG4gICAgICBtYXhSZXRyaWVzLFxuICAgICAgcmV0cnlEZWxheSxcbiAgICB9KTtcblxuICAgIHJlcy5qc29uKHtcbiAgICAgIG1lc3NhZ2U6ICdCYXRjaCBwcm9jZXNzaW5nIGNvbXBsZXRlZCcsXG4gICAgICBzdWNjZXNzZnVsOiByZXN1bHQuc3VjY2Vzc2Z1bCxcbiAgICAgIGZhaWxlZDogcmVzdWx0LmZhaWxlZCxcbiAgICAgIHRvdGFsUHJvY2Vzc2VkOiByZXN1bHQuc3VjY2Vzc2Z1bCArIHJlc3VsdC5mYWlsZWQsXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgaWYgKGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ2FscmVhZHkgaW4gcHJvZ3Jlc3MnKSkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA5KS5qc29uKHsgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfSk7XG4gICAgfVxuICAgIG5leHQoZXJyb3IpO1xuICB9XG59KTtcblxuLy8gR2V0IGJhdGNoIHByb2Nlc3Npbmcgc3RhdHVzXG5yb3V0ZXIuZ2V0KCcvc3RhdHVzJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzLCBuZXh0KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXI/LmlkO1xuICAgIGlmICghdXNlcklkKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBlcnJvcjogJ1VuYXV0aG9yaXplZCcgfSk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RhdHVzID0gYmF0Y2hQcm9jZXNzaW5nU2VydmljZS5nZXRCYXRjaFN0YXR1cyh1c2VySWQudG9TdHJpbmcoKSk7XG5cbiAgICByZXMuanNvbih7XG4gICAgICBpc1Byb2Nlc3Npbmc6IHN0YXR1cy5pc1Byb2Nlc3NpbmcsXG4gICAgICBxdWV1ZUxlbmd0aDogc3RhdHVzLnF1ZXVlTGVuZ3RoLFxuICAgICAgb3BlcmF0aW9uczogc3RhdHVzLm9wZXJhdGlvbnMubWFwKG9wID0+ICh7XG4gICAgICAgIGlkOiBvcC5pZCxcbiAgICAgICAgdHlwZTogb3AudHlwZSxcbiAgICAgICAgc3RhdHVzOiBvcC5zdGF0dXMsXG4gICAgICAgIHByb2dyZXNzOiBvcC5wcm9ncmVzcyB8fCAwLFxuICAgICAgICBlcnJvcnM6IG9wLmVycm9ycyB8fCBbXSxcbiAgICAgICAgcmV0cnlDb3VudDogb3AucmV0cnlDb3VudCB8fCAwLFxuICAgICAgICBjcmVhdGVkQXQ6IG9wLmNyZWF0ZWRBdCxcbiAgICAgICAgdXBkYXRlZEF0OiBvcC51cGRhdGVkQXQsXG4gICAgICB9KSksXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbmV4dChlcnJvcik7XG4gIH1cbn0pO1xuXG4vLyBDbGVhciBjb21wbGV0ZWQgb3BlcmF0aW9uc1xucm91dGVyLmRlbGV0ZSgnL2NvbXBsZXRlZCcsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlcywgbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyPy5pZDtcbiAgICBpZiAoIXVzZXJJZCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICdVbmF1dGhvcml6ZWQnIH0pO1xuICAgIH1cblxuICAgIGJhdGNoUHJvY2Vzc2luZ1NlcnZpY2UuY2xlYXJDb21wbGV0ZWRPcGVyYXRpb25zKHVzZXJJZC50b1N0cmluZygpKTtcblxuICAgIHJlcy5qc29uKHsgbWVzc2FnZTogJ0NvbXBsZXRlZCBvcGVyYXRpb25zIGNsZWFyZWQgZnJvbSBxdWV1ZScgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbmV4dChlcnJvcik7XG4gIH1cbn0pO1xuXG4vLyBIZWFsdGggY2hlY2sgZm9yIGJhdGNoIHByb2Nlc3Npbmcgc2VydmljZVxucm91dGVyLmdldCgnL2hlYWx0aCcsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlcywgbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IGhlYWx0aCA9IGF3YWl0IGJhdGNoUHJvY2Vzc2luZ1NlcnZpY2UuaGVhbHRoQ2hlY2soKTtcbiAgICBcbiAgICByZXMuc3RhdHVzKGhlYWx0aC5oZWFsdGh5ID8gMjAwIDogNTAzKS5qc29uKGhlYWx0aCk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbmV4dChlcnJvcik7XG4gIH1cbn0pO1xuXG5leHBvcnQgZGVmYXVsdCByb3V0ZXI7Il0sInZlcnNpb24iOjN9