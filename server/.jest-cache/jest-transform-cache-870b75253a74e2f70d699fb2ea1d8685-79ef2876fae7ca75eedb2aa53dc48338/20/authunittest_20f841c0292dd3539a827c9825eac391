d1f8e014042a6bfbfa36275736381b5c
import { describe, it, expect, beforeEach, jest } from '@jest/globals';
import jwt from 'jsonwebtoken';
import { authMiddleware } from '../../src/middleware/auth';
describe('Auth Middleware Unit Tests', () => {
    let req;
    let res;
    let next;
    beforeEach(() => {
        req = {
            headers: {},
        };
        res = {
            status: jest.fn().mockReturnThis(),
            json: jest.fn().mockReturnThis(),
        };
        next = jest.fn();
        // Clear any previous mocks
        jest.clearAllMocks();
    });
    describe('authMiddleware', () => {
        it('should return 401 when no authorization header is provided', () => {
            authMiddleware(req, res, next);
            expect(res.status).toHaveBeenCalledWith(401);
            expect(res.json).toHaveBeenCalledWith({ error: 'Unauthorized' });
            expect(next).not.toHaveBeenCalled();
        });
        it('should return 401 when authorization header is empty', () => {
            req.headers.authorization = '';
            authMiddleware(req, res, next);
            expect(res.status).toHaveBeenCalledWith(401);
            expect(res.json).toHaveBeenCalledWith({ error: 'Unauthorized' });
            expect(next).not.toHaveBeenCalled();
        });
        it('should extract token from Bearer authorization header', () => {
            const secret = process.env.JWT_SECRET || require('crypto').randomBytes(32).toString('hex');
            const userId = '123';
            const token = jwt.sign({ userId }, secret);
            req.headers.authorization = `Bearer ${token}`;
            // Mock environment variable
            const originalEnv = process.env.JWT_SECRET;
            process.env.JWT_SECRET = secret;
            authMiddleware(req, res, next);
            expect(req.user?.userId).toBe('123');
            expect(next).toHaveBeenCalled();
            expect(res.status).not.toHaveBeenCalled();
            // Restore environment
            process.env.JWT_SECRET = originalEnv;
        });
        it('should use default secret when JWT_SECRET is not set', () => {
            const userId = '456';
            const token = jwt.sign({ userId }, 'secret'); // Default secret
            req.headers.authorization = `Bearer ${token}`;
            // Ensure JWT_SECRET is not set
            const originalEnv = process.env.JWT_SECRET;
            delete process.env.JWT_SECRET;
            authMiddleware(req, res, next);
            expect(req.user?.userId).toBe('456');
            expect(next).toHaveBeenCalled();
            // Restore environment
            process.env.JWT_SECRET = originalEnv;
        });
        it('should return 401 for invalid token', () => {
            req.headers.authorization = 'Bearer invalid-token';
            authMiddleware(req, res, next);
            expect(res.status).toHaveBeenCalledWith(401);
            expect(res.json).toHaveBeenCalledWith({ error: 'Unauthorized' });
            expect(next).not.toHaveBeenCalled();
            expect(req.user).toBeUndefined();
        });
        it('should return 401 for expired token', () => {
            const secret = process.env.JWT_SECRET || require('crypto').randomBytes(32).toString('hex');
            const userId = '789';
            const expiredToken = jwt.sign({ userId, exp: Math.floor(Date.now() / 1000) - 3600 }, secret); // Expired 1 hour ago
            req.headers.authorization = `Bearer ${expiredToken}`;
            const originalEnv = process.env.JWT_SECRET;
            process.env.JWT_SECRET = secret;
            authMiddleware(req, res, next);
            expect(res.status).toHaveBeenCalledWith(401);
            expect(res.json).toHaveBeenCalledWith({ error: 'Unauthorized' });
            expect(next).not.toHaveBeenCalled();
            process.env.JWT_SECRET = originalEnv;
        });
        it('should return 401 for token with wrong secret', () => {
            const userId = '101';
            const token = jwt.sign({ userId }, 'wrong-secret');
            req.headers.authorization = `Bearer ${token}`;
            const originalEnv = process.env.JWT_SECRET;
            process.env.JWT_SECRET = 'correct-secret';
            authMiddleware(req, res, next);
            expect(res.status).toHaveBeenCalledWith(401);
            expect(res.json).toHaveBeenCalledWith({ error: 'Unauthorized' });
            expect(next).not.toHaveBeenCalled();
            process.env.JWT_SECRET = originalEnv;
        });
        it('should handle Bearer token without Bearer prefix', () => {
            const secret = process.env.JWT_SECRET || require('crypto').randomBytes(32).toString('hex');
            const userId = '202';
            const token = jwt.sign({ userId }, secret);
            req.headers.authorization = token; // No "Bearer " prefix
            const originalEnv = process.env.JWT_SECRET;
            process.env.JWT_SECRET = secret;
            authMiddleware(req, res, next);
            expect(req.user?.userId).toBe('202');
            expect(next).toHaveBeenCalled();
            process.env.JWT_SECRET = originalEnv;
        });
        it('should parse string userId to integer', () => {
            const secret = process.env.JWT_SECRET || require('crypto').randomBytes(32).toString('hex');
            const userId = '999';
            const token = jwt.sign({ userId }, secret);
            req.headers.authorization = `Bearer ${token}`;
            const originalEnv = process.env.JWT_SECRET;
            process.env.JWT_SECRET = secret;
            authMiddleware(req, res, next);
            expect(req.user?.userId).toBe('999');
            expect(typeof req.user?.userId).toBe('string');
            process.env.JWT_SECRET = originalEnv;
        });
        it('should handle token with additional claims', () => {
            const secret = process.env.JWT_SECRET || require('crypto').randomBytes(32).toString('hex');
            const payload = {
                userId: '555',
                role: 'teacher',
                email: 'test@example.com',
                exp: Math.floor(Date.now() / 1000) + 3600, // Expires in 1 hour
            };
            const token = jwt.sign(payload, secret);
            req.headers.authorization = `Bearer ${token}`;
            const originalEnv = process.env.JWT_SECRET;
            process.env.JWT_SECRET = secret;
            authMiddleware(req, res, next);
            expect(req.user?.userId).toBe('555');
            expect(next).toHaveBeenCalled();
            process.env.JWT_SECRET = originalEnv;
        });
        it('should handle malformed authorization header', () => {
            const testCases = [
                'Basic dXNlcjpwYXNz', // Basic auth instead of Bearer
                'Bearer', // Bearer without token
                'Bearer ', // Bearer with only space
                'Token abc123', // Wrong prefix
                'bearer token123', // Lowercase bearer
            ];
            testCases.forEach((authHeader) => {
                // Reset mocks for each test case
                jest.clearAllMocks();
                req.headers.authorization = authHeader;
                authMiddleware(req, res, next);
                expect(res.status).toHaveBeenCalledWith(401);
                expect(res.json).toHaveBeenCalledWith({ error: 'Unauthorized' });
                expect(next).not.toHaveBeenCalled();
            });
        });
        it('should handle token with invalid userId format', () => {
            const secret = process.env.JWT_SECRET || require('crypto').randomBytes(32).toString('hex');
            const token = jwt.sign({ userId: 'not-a-number' }, secret);
            req.headers.authorization = `Bearer ${token}`;
            const originalEnv = process.env.JWT_SECRET;
            process.env.JWT_SECRET = secret;
            authMiddleware(req, res, next);
            // The middleware doesn't parse userId, it keeps it as is
            expect(req.user?.userId).toBe('not-a-number');
            expect(next).toHaveBeenCalled();
            process.env.JWT_SECRET = originalEnv;
        });
        it('should handle token without userId claim', () => {
            const secret = process.env.JWT_SECRET || require('crypto').randomBytes(32).toString('hex');
            const token = jwt.sign({ role: 'teacher', email: 'test@example.com' }, secret);
            req.headers.authorization = `Bearer ${token}`;
            const originalEnv = process.env.JWT_SECRET;
            process.env.JWT_SECRET = secret;
            authMiddleware(req, res, next);
            expect(req.user?.userId).toBeUndefined(); // userId is undefined when not present in token
            expect(next).toHaveBeenCalled();
            process.env.JWT_SECRET = originalEnv;
        });
        it('should preserve other request properties', () => {
            const secret = process.env.JWT_SECRET || require('crypto').randomBytes(32).toString('hex');
            const userId = '123';
            const token = jwt.sign({ userId }, secret);
            req.headers.authorization = `Bearer ${token}`;
            req.body = { test: 'data' };
            req.params = { id: '456' };
            req.query = { search: 'term' };
            const originalEnv = process.env.JWT_SECRET;
            process.env.JWT_SECRET = secret;
            authMiddleware(req, res, next);
            expect(req.body).toEqual({ test: 'data' });
            expect(req.params).toEqual({ id: '456' });
            expect(req.query).toEqual({ search: 'term' });
            expect(req.user?.userId).toBe('123');
            process.env.JWT_SECRET = originalEnv;
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3Rlc3RzL3VuaXQvYXV0aC51bml0LnRlc3QudHMiLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkUsT0FBTyxHQUFHLE1BQU0sY0FBYyxDQUFDO0FBRS9CLE9BQU8sRUFBRSxjQUFjLEVBQW9CLE1BQU0sMkJBQTJCLENBQUM7QUFFN0UsUUFBUSxDQUFDLDRCQUE0QixFQUFFLEdBQUcsRUFBRTtJQUMxQyxJQUFJLEdBQXlCLENBQUM7SUFDOUIsSUFBSSxHQUFzQixDQUFDO0lBQzNCLElBQUksSUFBcUMsQ0FBQztJQUUxQyxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsR0FBRyxHQUFHO1lBQ0osT0FBTyxFQUFFLEVBQUU7U0FDWixDQUFDO1FBQ0YsR0FBRyxHQUFHO1lBQ0osTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxjQUFjLEVBQUU7WUFDbEMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxjQUFjLEVBQUU7U0FDakMsQ0FBQztRQUNGLElBQUksR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7UUFFakIsMkJBQTJCO1FBQzNCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN2QixDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLEVBQUU7UUFDOUIsRUFBRSxDQUFDLDREQUE0RCxFQUFFLEdBQUcsRUFBRTtZQUNwRSxjQUFjLENBQUMsR0FBa0IsRUFBRSxHQUFlLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFFMUQsTUFBTSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUM3QyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxD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c2Vycy9taWNoYWVsbWNpc2FhYy9HaXRIdWIvdGVhY2hpbmctZW5naW5lMi4wL3NlcnZlci90ZXN0cy91bml0L2F1dGgudW5pdC50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGRlc2NyaWJlLCBpdCwgZXhwZWN0LCBiZWZvcmVFYWNoLCBqZXN0IH0gZnJvbSAnQGplc3QvZ2xvYmFscyc7XG5pbXBvcnQgand0IGZyb20gJ2pzb253ZWJ0b2tlbic7XG5pbXBvcnQgeyBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgYXV0aE1pZGRsZXdhcmUsIHR5cGUgQXV0aFJlcXVlc3QgfSBmcm9tICcuLi8uLi9zcmMvbWlkZGxld2FyZS9hdXRoJztcblxuZGVzY3JpYmUoJ0F1dGggTWlkZGxld2FyZSBVbml0IFRlc3RzJywgKCkgPT4ge1xuICBsZXQgcmVxOiBQYXJ0aWFsPEF1dGhSZXF1ZXN0PjtcbiAgbGV0IHJlczogUGFydGlhbDxSZXNwb25zZT47XG4gIGxldCBuZXh0OiBqZXN0Lk1vY2tlZEZ1bmN0aW9uPCgpID0+IHZvaWQ+O1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIHJlcSA9IHtcbiAgICAgIGhlYWRlcnM6IHt9LFxuICAgIH07XG4gICAgcmVzID0ge1xuICAgICAgc3RhdHVzOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICAgIGpzb246IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgIH07XG4gICAgbmV4dCA9IGplc3QuZm4oKTtcblxuICAgIC8vIENsZWFyIGFueSBwcmV2aW91cyBtb2Nrc1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICB9KTtcblxuICBkZXNjcmliZSgnYXV0aE1pZGRsZXdhcmUnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gNDAxIHdoZW4gbm8gYXV0aG9yaXphdGlvbiBoZWFkZXIgaXMgcHJvdmlkZWQnLCAoKSA9PiB7XG4gICAgICBhdXRoTWlkZGxld2FyZShyZXEgYXMgQXV0aFJlcXVlc3QsIHJlcyBhcyBSZXNwb25zZSwgbmV4dCk7XG5cbiAgICAgIGV4cGVjdChyZXMuc3RhdHVzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCg0MDEpO1xuICAgICAgZXhwZWN0KHJlcy5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7IGVycm9yOiAnVW5hdXRob3JpemVkJyB9KTtcbiAgICAgIGV4cGVjdChuZXh0KS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gNDAxIHdoZW4gYXV0aG9yaXphdGlvbiBoZWFkZXIgaXMgZW1wdHknLCAoKSA9PiB7XG4gICAgICByZXEuaGVhZGVycyEuYXV0aG9yaXphdGlvbiA9ICcnO1xuXG4gICAgICBhdXRoTWlkZGxld2FyZShyZXEgYXMgQXV0aFJlcXVlc3QsIHJlcyBhcyBSZXNwb25zZSwgbmV4dCk7XG5cbiAgICAgIGV4cGVjdChyZXMuc3RhdHVzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCg0MDEpO1xuICAgICAgZXhwZWN0KHJlcy5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7IGVycm9yOiAnVW5hdXRob3JpemVkJyB9KTtcbiAgICAgIGV4cGVjdChuZXh0KS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBleHRyYWN0IHRva2VuIGZyb20gQmVhcmVyIGF1dGhvcml6YXRpb24gaGVhZGVyJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2VjcmV0ID0gcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCB8fCByZXF1aXJlKCdjcnlwdG8nKS5yYW5kb21CeXRlcygzMikudG9TdHJpbmcoJ2hleCcpO1xuICAgICAgY29uc3QgdXNlcklkID0gJzEyMyc7XG4gICAgICBjb25zdCB0b2tlbiA9IGp3dC5zaWduKHsgdXNlcklkIH0sIHNlY3JldCk7XG5cbiAgICAgIHJlcS5oZWFkZXJzIS5hdXRob3JpemF0aW9uID0gYEJlYXJlciAke3Rva2VufWA7XG5cbiAgICAgIC8vIE1vY2sgZW52aXJvbm1lbnQgdmFyaWFibGVcbiAgICAgIGNvbnN0IG9yaWdpbmFsRW52ID0gcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVDtcbiAgICAgIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgPSBzZWNyZXQ7XG5cbiAgICAgIGF1dGhNaWRkbGV3YXJlKHJlcSBhcyBBdXRoUmVxdWVzdCwgcmVzIGFzIFJlc3BvbnNlLCBuZXh0KTtcblxuICAgICAgZXhwZWN0KHJlcS51c2VyPy51c2VySWQpLnRvQmUoJzEyMycpO1xuICAgICAgZXhwZWN0KG5leHQpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICAgIGV4cGVjdChyZXMuc3RhdHVzKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuXG4gICAgICAvLyBSZXN0b3JlIGVudmlyb25tZW50XG4gICAgICBwcm9jZXNzLmVudi5KV1RfU0VDUkVUID0gb3JpZ2luYWxFbnY7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHVzZSBkZWZhdWx0IHNlY3JldCB3aGVuIEpXVF9TRUNSRVQgaXMgbm90IHNldCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHVzZXJJZCA9ICc0NTYnO1xuICAgICAgY29uc3QgdG9rZW4gPSBqd3Quc2lnbih7IHVzZXJJZCB9LCAnc2VjcmV0Jyk7IC8vIERlZmF1bHQgc2VjcmV0XG5cbiAgICAgIHJlcS5oZWFkZXJzIS5hdXRob3JpemF0aW9uID0gYEJlYXJlciAke3Rva2VufWA7XG5cbiAgICAgIC8vIEVuc3VyZSBKV1RfU0VDUkVUIGlzIG5vdCBzZXRcbiAgICAgIGNvbnN0IG9yaWdpbmFsRW52ID0gcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVDtcbiAgICAgIGRlbGV0ZSBwcm9jZXNzLmVudi5KV1RfU0VDUkVUO1xuXG4gICAgICBhdXRoTWlkZGxld2FyZShyZXEgYXMgQXV0aFJlcXVlc3QsIHJlcyBhcyBSZXNwb25zZSwgbmV4dCk7XG5cbiAgICAgIGV4cGVjdChyZXEudXNlcj8udXNlcklkKS50b0JlKCc0NTYnKTtcbiAgICAgIGV4cGVjdChuZXh0KS50b0hhdmVCZWVuQ2FsbGVkKCk7XG5cbiAgICAgIC8vIFJlc3RvcmUgZW52aXJvbm1lbnRcbiAgICAgIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgPSBvcmlnaW5hbEVudjtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIDQwMSBmb3IgaW52YWxpZCB0b2tlbicsICgpID0+IHtcbiAgICAgIHJlcS5oZWFkZXJzIS5hdXRob3JpemF0aW9uID0gJ0JlYXJlciBpbnZhbGlkLXRva2VuJztcblxuICAgICAgYXV0aE1pZGRsZXdhcmUocmVxIGFzIEF1dGhSZXF1ZXN0LCByZXMgYXMgUmVzcG9uc2UsIG5leHQpO1xuXG4gICAgICBleHBlY3QocmVzLnN0YXR1cykudG9IYXZlQmVlbkNhbGxlZFdpdGgoNDAxKTtcbiAgICAgIGV4cGVjdChyZXMuanNvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoeyBlcnJvcjogJ1VuYXV0aG9yaXplZCcgfSk7XG4gICAgICBleHBlY3QobmV4dCkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICAgIGV4cGVjdChyZXEudXNlcikudG9CZVVuZGVmaW5lZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gNDAxIGZvciBleHBpcmVkIHRva2VuJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2VjcmV0ID0gcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCB8fCByZXF1aXJlKCdjcnlwdG8nKS5yYW5kb21CeXRlcygzMikudG9TdHJpbmcoJ2hleCcpO1xuICAgICAgY29uc3QgdXNlcklkID0gJzc4OSc7XG4gICAgICBjb25zdCBleHBpcmVkVG9rZW4gPSBqd3Quc2lnbih7IHVzZXJJZCwgZXhwOiBNYXRoLmZsb29yKERhdGUubm93KCkgLyAxMDAwKSAtIDM2MDAgfSwgc2VjcmV0KTsgLy8gRXhwaXJlZCAxIGhvdXIgYWdvXG5cbiAgICAgIHJlcS5oZWFkZXJzIS5hdXRob3JpemF0aW9uID0gYEJlYXJlciAke2V4cGlyZWRUb2tlbn1gO1xuXG4gICAgICBjb25zdCBvcmlnaW5hbEVudiA9IHByb2Nlc3MuZW52LkpXVF9TRUNSRVQ7XG4gICAgICBwcm9jZXNzLmVudi5KV1RfU0VDUkVUID0gc2VjcmV0O1xuXG4gICAgICBhdXRoTWlkZGxld2FyZShyZXEgYXMgQXV0aFJlcXVlc3QsIHJlcyBhcyBSZXNwb25zZSwgbmV4dCk7XG5cbiAgICAgIGV4cGVjdChyZXMuc3RhdHVzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCg0MDEpO1xuICAgICAgZXhwZWN0KHJlcy5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7IGVycm9yOiAnVW5hdXRob3JpemVkJyB9KTtcbiAgICAgIGV4cGVjdChuZXh0KS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuXG4gICAgICBwcm9jZXNzLmVudi5KV1RfU0VDUkVUID0gb3JpZ2luYWxFbnY7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiA0MDEgZm9yIHRva2VuIHdpdGggd3Jvbmcgc2VjcmV0JywgKCkgPT4ge1xuICAgICAgY29uc3QgdXNlcklkID0gJzEwMSc7XG4gICAgICBjb25zdCB0b2tlbiA9IGp3dC5zaWduKHsgdXNlcklkIH0sICd3cm9uZy1zZWNyZXQnKTtcblxuICAgICAgcmVxLmhlYWRlcnMhLmF1dGhvcml6YXRpb24gPSBgQmVhcmVyICR7dG9rZW59YDtcblxuICAgICAgY29uc3Qgb3JpZ2luYWxFbnYgPSBwcm9jZXNzLmVudi5KV1RfU0VDUkVUO1xuICAgICAgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCA9ICdjb3JyZWN0LXNlY3JldCc7XG5cbiAgICAgIGF1dGhNaWRkbGV3YXJlKHJlcSBhcyBBdXRoUmVxdWVzdCwgcmVzIGFzIFJlc3BvbnNlLCBuZXh0KTtcblxuICAgICAgZXhwZWN0KHJlcy5zdGF0dXMpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKDQwMSk7XG4gICAgICBleHBlY3QocmVzLmpzb24pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHsgZXJyb3I6ICdVbmF1dGhvcml6ZWQnIH0pO1xuICAgICAgZXhwZWN0KG5leHQpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XG5cbiAgICAgIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgPSBvcmlnaW5hbEVudjtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIEJlYXJlciB0b2tlbiB3aXRob3V0IEJlYXJlciBwcmVmaXgnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzZWNyZXQgPSBwcm9jZXNzLmVudi5KV1RfU0VDUkVUIHx8IHJlcXVpcmUoJ2NyeXB0bycpLnJhbmRvbUJ5dGVzKDMyKS50b1N0cmluZygnaGV4Jyk7XG4gICAgICBjb25zdCB1c2VySWQgPSAnMjAyJztcbiAgICAgIGNvbnN0IHRva2VuID0gand0LnNpZ24oeyB1c2VySWQgfSwgc2VjcmV0KTtcblxuICAgICAgcmVxLmhlYWRlcnMhLmF1dGhvcml6YXRpb24gPSB0b2tlbjsgLy8gTm8gXCJCZWFyZXIgXCIgcHJlZml4XG5cbiAgICAgIGNvbnN0IG9yaWdpbmFsRW52ID0gcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVDtcbiAgICAgIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgPSBzZWNyZXQ7XG5cbiAgICAgIGF1dGhNaWRkbGV3YXJlKHJlcSBhcyBBdXRoUmVxdWVzdCwgcmVzIGFzIFJlc3BvbnNlLCBuZXh0KTtcblxuICAgICAgZXhwZWN0KHJlcS51c2VyPy51c2VySWQpLnRvQmUoJzIwMicpO1xuICAgICAgZXhwZWN0KG5leHQpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcblxuICAgICAgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCA9IG9yaWdpbmFsRW52O1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBwYXJzZSBzdHJpbmcgdXNlcklkIHRvIGludGVnZXInLCAoKSA9PiB7XG4gICAgICBjb25zdCBzZWNyZXQgPSBwcm9jZXNzLmVudi5KV1RfU0VDUkVUIHx8IHJlcXVpcmUoJ2NyeXB0bycpLnJhbmRvbUJ5dGVzKDMyKS50b1N0cmluZygnaGV4Jyk7XG4gICAgICBjb25zdCB1c2VySWQgPSAnOTk5JztcbiAgICAgIGNvbnN0IHRva2VuID0gand0LnNpZ24oeyB1c2VySWQgfSwgc2VjcmV0KTtcblxuICAgICAgcmVxLmhlYWRlcnMhLmF1dGhvcml6YXRpb24gPSBgQmVhcmVyICR7dG9rZW59YDtcblxuICAgICAgY29uc3Qgb3JpZ2luYWxFbnYgPSBwcm9jZXNzLmVudi5KV1RfU0VDUkVUO1xuICAgICAgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCA9IHNlY3JldDtcblxuICAgICAgYXV0aE1pZGRsZXdhcmUocmVxIGFzIEF1dGhSZXF1ZXN0LCByZXMgYXMgUmVzcG9uc2UsIG5leHQpO1xuXG4gICAgICBleHBlY3QocmVxLnVzZXI/LnVzZXJJZCkudG9CZSgnOTk5Jyk7XG4gICAgICBleHBlY3QodHlwZW9mIHJlcS51c2VyPy51c2VySWQpLnRvQmUoJ3N0cmluZycpO1xuXG4gICAgICBwcm9jZXNzLmVudi5KV1RfU0VDUkVUID0gb3JpZ2luYWxFbnY7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSB0b2tlbiB3aXRoIGFkZGl0aW9uYWwgY2xhaW1zJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2VjcmV0ID0gcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCB8fCByZXF1aXJlKCdjcnlwdG8nKS5yYW5kb21CeXRlcygzMikudG9TdHJpbmcoJ2hleCcpO1xuICAgICAgY29uc3QgcGF5bG9hZCA9IHtcbiAgICAgICAgdXNlcklkOiAnNTU1JyxcbiAgICAgICAgcm9sZTogJ3RlYWNoZXInLFxuICAgICAgICBlbWFpbDogJ3Rlc3RAZXhhbXBsZS5jb20nLFxuICAgICAgICBleHA6IE1hdGguZmxvb3IoRGF0ZS5ub3coKSAvIDEwMDApICsgMzYwMCwgLy8gRXhwaXJlcyBpbiAxIGhvdXJcbiAgICAgIH07XG4gICAgICBjb25zdCB0b2tlbiA9IGp3dC5zaWduKHBheWxvYWQsIHNlY3JldCk7XG5cbiAgICAgIHJlcS5oZWFkZXJzIS5hdXRob3JpemF0aW9uID0gYEJlYXJlciAke3Rva2VufWA7XG5cbiAgICAgIGNvbnN0IG9yaWdpbmFsRW52ID0gcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVDtcbiAgICAgIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgPSBzZWNyZXQ7XG5cbiAgICAgIGF1dGhNaWRkbGV3YXJlKHJlcSBhcyBBdXRoUmVxdWVzdCwgcmVzIGFzIFJlc3BvbnNlLCBuZXh0KTtcblxuICAgICAgZXhwZWN0KHJlcS51c2VyPy51c2VySWQpLnRvQmUoJzU1NScpO1xuICAgICAgZXhwZWN0KG5leHQpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcblxuICAgICAgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCA9IG9yaWdpbmFsRW52O1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgbWFsZm9ybWVkIGF1dGhvcml6YXRpb24gaGVhZGVyJywgKCkgPT4ge1xuICAgICAgY29uc3QgdGVzdENhc2VzID0gW1xuICAgICAgICAnQmFzaWMgZFhObGNqcHdZWE56JywgLy8gQmFzaWMgYXV0aCBpbnN0ZWFkIG9mIEJlYXJlclxuICAgICAgICAnQmVhcmVyJywgLy8gQmVhcmVyIHdpdGhvdXQgdG9rZW5cbiAgICAgICAgJ0JlYXJlciAnLCAvLyBCZWFyZXIgd2l0aCBvbmx5IHNwYWNlXG4gICAgICAgICdUb2tlbiBhYmMxMjMnLCAvLyBXcm9uZyBwcmVmaXhcbiAgICAgICAgJ2JlYXJlciB0b2tlbjEyMycsIC8vIExvd2VyY2FzZSBiZWFyZXJcbiAgICAgIF07XG5cbiAgICAgIHRlc3RDYXNlcy5mb3JFYWNoKChhdXRoSGVhZGVyKSA9PiB7XG4gICAgICAgIC8vIFJlc2V0IG1vY2tzIGZvciBlYWNoIHRlc3QgY2FzZVxuICAgICAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgICAgICAgcmVxLmhlYWRlcnMhLmF1dGhvcml6YXRpb24gPSBhdXRoSGVhZGVyO1xuXG4gICAgICAgIGF1dGhNaWRkbGV3YXJlKHJlcSBhcyBBdXRoUmVxdWVzdCwgcmVzIGFzIFJlc3BvbnNlLCBuZXh0KTtcblxuICAgICAgICBleHBlY3QocmVzLnN0YXR1cykudG9IYXZlQmVlbkNhbGxlZFdpdGgoNDAxKTtcbiAgICAgICAgZXhwZWN0KHJlcy5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7IGVycm9yOiAnVW5hdXRob3JpemVkJyB9KTtcbiAgICAgICAgZXhwZWN0KG5leHQpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIHRva2VuIHdpdGggaW52YWxpZCB1c2VySWQgZm9ybWF0JywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2VjcmV0ID0gcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCB8fCByZXF1aXJlKCdjcnlwdG8nKS5yYW5kb21CeXRlcygzMikudG9TdHJpbmcoJ2hleCcpO1xuICAgICAgY29uc3QgdG9rZW4gPSBqd3Quc2lnbih7IHVzZXJJZDogJ25vdC1hLW51bWJlcicgfSwgc2VjcmV0KTtcblxuICAgICAgcmVxLmhlYWRlcnMhLmF1dGhvcml6YXRpb24gPSBgQmVhcmVyICR7dG9rZW59YDtcblxuICAgICAgY29uc3Qgb3JpZ2luYWxFbnYgPSBwcm9jZXNzLmVudi5KV1RfU0VDUkVUO1xuICAgICAgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCA9IHNlY3JldDtcblxuICAgICAgYXV0aE1pZGRsZXdhcmUocmVxIGFzIEF1dGhSZXF1ZXN0LCByZXMgYXMgUmVzcG9uc2UsIG5leHQpO1xuXG4gICAgICAvLyBUaGUgbWlkZGxld2FyZSBkb2Vzbid0IHBhcnNlIHVzZXJJZCwgaXQga2VlcHMgaXQgYXMgaXNcbiAgICAgIGV4cGVjdChyZXEudXNlcj8udXNlcklkKS50b0JlKCdub3QtYS1udW1iZXInKTtcbiAgICAgIGV4cGVjdChuZXh0KS50b0hhdmVCZWVuQ2FsbGVkKCk7XG5cbiAgICAgIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgPSBvcmlnaW5hbEVudjtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIHRva2VuIHdpdGhvdXQgdXNlcklkIGNsYWltJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2VjcmV0ID0gcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCB8fCByZXF1aXJlKCdjcnlwdG8nKS5yYW5kb21CeXRlcygzMikudG9TdHJpbmcoJ2hleCcpO1xuICAgICAgY29uc3QgdG9rZW4gPSBqd3Quc2lnbih7IHJvbGU6ICd0ZWFjaGVyJywgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyB9LCBzZWNyZXQpO1xuXG4gICAgICByZXEuaGVhZGVycyEuYXV0aG9yaXphdGlvbiA9IGBCZWFyZXIgJHt0b2tlbn1gO1xuXG4gICAgICBjb25zdCBvcmlnaW5hbEVudiA9IHByb2Nlc3MuZW52LkpXVF9TRUNSRVQ7XG4gICAgICBwcm9jZXNzLmVudi5KV1RfU0VDUkVUID0gc2VjcmV0O1xuXG4gICAgICBhdXRoTWlkZGxld2FyZShyZXEgYXMgQXV0aFJlcXVlc3QsIHJlcyBhcyBSZXNwb25zZSwgbmV4dCk7XG5cbiAgICAgIGV4cGVjdChyZXEudXNlcj8udXNlcklkKS50b0JlVW5kZWZpbmVkKCk7IC8vIHVzZXJJZCBpcyB1bmRlZmluZWQgd2hlbiBub3QgcHJlc2VudCBpbiB0b2tlblxuICAgICAgZXhwZWN0KG5leHQpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcblxuICAgICAgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCA9IG9yaWdpbmFsRW52O1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBwcmVzZXJ2ZSBvdGhlciByZXF1ZXN0IHByb3BlcnRpZXMnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzZWNyZXQgPSBwcm9jZXNzLmVudi5KV1RfU0VDUkVUIHx8IHJlcXVpcmUoJ2NyeXB0bycpLnJhbmRvbUJ5dGVzKDMyKS50b1N0cmluZygnaGV4Jyk7XG4gICAgICBjb25zdCB1c2VySWQgPSAnMTIzJztcbiAgICAgIGNvbnN0IHRva2VuID0gand0LnNpZ24oeyB1c2VySWQgfSwgc2VjcmV0KTtcblxuICAgICAgcmVxLmhlYWRlcnMhLmF1dGhvcml6YXRpb24gPSBgQmVhcmVyICR7dG9rZW59YDtcbiAgICAgIHJlcS5ib2R5ID0geyB0ZXN0OiAnZGF0YScgfTtcbiAgICAgIHJlcS5wYXJhbXMgPSB7IGlkOiAnNDU2JyB9O1xuICAgICAgcmVxLnF1ZXJ5ID0geyBzZWFyY2g6ICd0ZXJtJyB9O1xuXG4gICAgICBjb25zdCBvcmlnaW5hbEVudiA9IHByb2Nlc3MuZW52LkpXVF9TRUNSRVQ7XG4gICAgICBwcm9jZXNzLmVudi5KV1RfU0VDUkVUID0gc2VjcmV0O1xuXG4gICAgICBhdXRoTWlkZGxld2FyZShyZXEgYXMgQXV0aFJlcXVlc3QsIHJlcyBhcyBSZXNwb25zZSwgbmV4dCk7XG5cbiAgICAgIGV4cGVjdChyZXEuYm9keSkudG9FcXVhbCh7IHRlc3Q6ICdkYXRhJyB9KTtcbiAgICAgIGV4cGVjdChyZXEucGFyYW1zKS50b0VxdWFsKHsgaWQ6ICc0NTYnIH0pO1xuICAgICAgZXhwZWN0KHJlcS5xdWVyeSkudG9FcXVhbCh7IHNlYXJjaDogJ3Rlcm0nIH0pO1xuICAgICAgZXhwZWN0KHJlcS51c2VyPy51c2VySWQpLnRvQmUoJzEyMycpO1xuXG4gICAgICBwcm9jZXNzLmVudi5KV1RfU0VDUkVUID0gb3JpZ2luYWxFbnY7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=