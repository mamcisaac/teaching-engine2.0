e888aba25f219bad2e42a9d3a599f911
import { randomBytes } from 'crypto';
export class MailHogTestProvider {
    host = 'localhost';
    port = 1025; // SMTP port
    httpPort = 8025; // HTTP API port
    async getEmails() {
        try {
            const response = await fetch(`http://localhost:${this.httpPort}/api/v2/messages`);
            if (!response.ok) {
                throw new Error(`MailHog API responded with ${response.status}`);
            }
            const data = await response.json();
            return data.items?.map(this.parseMailHogMessage) || [];
        }
        catch (error) {
            if (error instanceof Error && error.message.includes('ECONNREFUSED')) {
                throw new Error('MailHog server not running. Start with: docker run -p 1025:1025 -p 8025:8025 mailhog/mailhog');
            }
            throw error;
        }
    }
    async clearEmails() {
        try {
            const response = await fetch(`http://localhost:${this.httpPort}/api/v1/messages`, {
                method: 'DELETE',
            });
            if (!response.ok) {
                throw new Error(`Failed to clear emails: ${response.status}`);
            }
        }
        catch (error) {
            console.warn('Failed to clear MailHog emails:', error);
        }
    }
    async waitForEmail(to, timeout = 10000) {
        const startTime = Date.now();
        while (Date.now() - startTime < timeout) {
            const emails = await this.getEmails();
            const targetEmail = emails.find(email => email.to.some(recipient => recipient.toLowerCase() === to.toLowerCase()));
            if (targetEmail) {
                return targetEmail;
            }
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        throw new Error(`No email received for ${to} within ${timeout}ms`);
    }
    parseMailHogMessage(msg) {
        const content = msg.Content;
        const headers = content.Headers;
        return {
            id: msg.ID,
            from: this.parseEmailAddress(headers.From?.[0] || ''),
            to: (headers.To || []).map(this.parseEmailAddress),
            subject: headers.Subject?.[0] || '',
            text: content.Body || '',
            html: content.MIME?.Parts?.find((part) => part.Headers['Content-Type']?.[0]?.includes('text/html'))?.Body,
            attachments: this.parseAttachments(content.MIME?.Parts || []),
            createdAt: new Date(msg.Created),
        };
    }
    parseEmailAddress(addr) {
        // Extract email from "Name <email@domain.com>" format
        const match = addr.match(/<([^>]+)>/);
        return match ? match[1] : addr;
    }
    parseAttachments(parts) {
        return parts
            .filter(part => part.Headers['Content-Disposition']?.[0]?.includes('attachment'))
            .map(part => ({
            filename: this.extractFilename(part.Headers['Content-Disposition'][0]),
            content: Buffer.from(part.Body, 'base64'),
            contentType: part.Headers['Content-Type']?.[0] || 'application/octet-stream',
        }));
    }
    extractFilename(contentDisposition) {
        const match = contentDisposition.match(/filename="([^"]+)"/);
        return match ? match[1] : 'attachment';
    }
}
// In-memory test provider for CI environments
export class InMemoryTestProvider {
    host = 'localhost';
    port = 587;
    emails = [];
    async getEmails() {
        return [...this.emails];
    }
    async clearEmails() {
        this.emails = [];
    }
    async waitForEmail(to, timeout = 5000) {
        const startTime = Date.now();
        while (Date.now() - startTime < timeout) {
            const targetEmail = this.emails.find(email => email.to.some(recipient => recipient.toLowerCase() === to.toLowerCase()));
            if (targetEmail) {
                return targetEmail;
            }
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        throw new Error(`No email received for ${to} within ${timeout}ms`);
    }
    // This method would be called by a mock email service
    addEmail(email) {
        this.emails.push({
            ...email,
            id: randomBytes(8).toString('hex'),
            createdAt: new Date(),
        });
    }
}
// Factory function to create appropriate test provider
export function createEmailTestProvider() {
    // Always use in-memory provider for tests
    if (process.env.NODE_ENV === 'test') {
        return new InMemoryTestProvider();
    }
    // Use MailHog only in development when explicitly enabled
    if (process.env.USE_MAILHOG === 'true') {
        return new MailHogTestProvider();
    }
    return new InMemoryTestProvider();
}
// Utility functions for email testing
export function generateTestEmail(domain = 'test.example.com') {
    const id = randomBytes(4).toString('hex');
    return `test-${id}@${domain}`;
}
export function expectEmailContent(email, expectedContent) {
    if (expectedContent.subject) {
        expect(email.subject).toContain(expectedContent.subject);
    }
    if (expectedContent.text) {
        expect(email.text).toContain(expectedContent.text);
    }
    if (expectedContent.html) {
        expect(email.html).toContain(expectedContent.html);
    }
    if (expectedContent.from) {
        expect(email.from).toBe(expectedContent.from);
    }
    if (expectedContent.to) {
        expectedContent.to.forEach(recipient => {
            expect(email.to).toContain(recipient);
        });
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3Rlc3RzL2hlbHBlcnMvZW1haWxUZXN0SGVscGVyLnRzIiwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxRQUFRLENBQUM7QUEyQnJDLE1BQU0sT0FBTyxtQkFBbUI7SUFDOUIsSUFBSSxHQUFHLFdBQVcsQ0FBQztJQUNuQixJQUFJLEdBQUcsSUFBSSxDQUFDLENBQUMsWUFBWTtJQUNqQixRQUFRLEdBQUcsSUFBSSxDQUFDLENBQUMsZ0JBQWdCO0lBRXpDLEtBQUssQ0FBQyxTQUFTO1FBQ2IsSUFBSSxDQUFDO1lBQ0gsTUFBTSxRQUFRLEdBQUcsTUFBTSxLQUFLLENBQUMsb0JBQW9CLElBQUksQ0FBQyxRQUFRLGtCQUFrQixDQUFDLENBQUM7WUFDbEYsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEVBQUUsQ0FBQztnQkFDakIsTUFBTSxJQUFJLEtBQUssQ0FBQyw4QkFBOEIsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7WUFDbkUsQ0FBQztZQUVELE1BQU0sSUFBSSxHQUFHLE1BQU0sUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ25DLE9BQU8sSUFBSSxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3pELENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsSUFBSSxLQUFLLFlBQVksS0FBSyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxFQUFFLENBQUM7Z0JBQ3JFLE1BQU0sSUFBSSxLQUFLLENBQUMsOEZBQThGLENBQUMsQ0FBQztZQUNsSCxDQUFDO1lBQ0QsTUFBTSxLQUFLLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztJQUVELEtBQUssQ0FBQyxXQUFXO1FBQ2YsSUFBSSxDQUFDO1lBQ0gsTUFBTSxRQUFRLEdBQUcsTUFBTSxL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QUM7SUFDaEQsQ0FBQztJQUNELElBQUksZUFBZSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3ZCLGVBQWUsQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxFQUFFO1lBQ3JDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3hDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztBQUNILENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3Rlc3RzL2hlbHBlcnMvZW1haWxUZXN0SGVscGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHJhbmRvbUJ5dGVzIH0gZnJvbSAnY3J5cHRvJztcblxuZXhwb3J0IGludGVyZmFjZSBUZXN0RW1haWxQcm92aWRlciB7XG4gIGhvc3Q6IHN0cmluZztcbiAgcG9ydDogbnVtYmVyO1xuICB1c2VyPzogc3RyaW5nO1xuICBwYXNzPzogc3RyaW5nO1xuICBnZXRFbWFpbHMoKTogUHJvbWlzZTxFbWFpbE1lc3NhZ2VbXT47XG4gIGNsZWFyRW1haWxzKCk6IFByb21pc2U8dm9pZD47XG4gIHdhaXRGb3JFbWFpbCh0bzogc3RyaW5nLCB0aW1lb3V0PzogbnVtYmVyKTogUHJvbWlzZTxFbWFpbE1lc3NhZ2U+O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEVtYWlsTWVzc2FnZSB7XG4gIGlkOiBzdHJpbmc7XG4gIGZyb206IHN0cmluZztcbiAgdG86IHN0cmluZ1tdO1xuICBzdWJqZWN0OiBzdHJpbmc7XG4gIHRleHQ6IHN0cmluZztcbiAgaHRtbD86IHN0cmluZztcbiAgYXR0YWNobWVudHM/OiBBcnJheTx7XG4gICAgZmlsZW5hbWU6IHN0cmluZztcbiAgICBjb250ZW50OiBCdWZmZXI7XG4gICAgY29udGVudFR5cGU6IHN0cmluZztcbiAgfT47XG4gIGNyZWF0ZWRBdDogRGF0ZTtcbn1cblxuZXhwb3J0IGNsYXNzIE1haWxIb2dUZXN0UHJvdmlkZXIgaW1wbGVtZW50cyBUZXN0RW1haWxQcm92aWRlciB7XG4gIGhvc3QgPSAnbG9jYWxob3N0JztcbiAgcG9ydCA9IDEwMjU7IC8vIFNNVFAgcG9ydFxuICBwcml2YXRlIGh0dHBQb3J0ID0gODAyNTsgLy8gSFRUUCBBUEkgcG9ydFxuXG4gIGFzeW5jIGdldEVtYWlscygpOiBQcm9taXNlPEVtYWlsTWVzc2FnZVtdPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goYGh0dHA6Ly9sb2NhbGhvc3Q6JHt0aGlzLmh0dHBQb3J0fS9hcGkvdjIvbWVzc2FnZXNgKTtcbiAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBNYWlsSG9nIEFQSSByZXNwb25kZWQgd2l0aCAke3Jlc3BvbnNlLnN0YXR1c31gKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcbiAgICAgIHJldHVybiBkYXRhLml0ZW1zPy5tYXAodGhpcy5wYXJzZU1haWxIb2dNZXNzYWdlKSB8fCBbXTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IgJiYgZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnRUNPTk5SRUZVU0VEJykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdNYWlsSG9nIHNlcnZlciBub3QgcnVubmluZy4gU3RhcnQgd2l0aDogZG9ja2VyIHJ1biAtcCAxMDI1OjEwMjUgLXAgODAyNTo4MDI1IG1haWxob2cvbWFpbGhvZycpO1xuICAgICAgfVxuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY2xlYXJFbWFpbHMoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goYGh0dHA6Ly9sb2NhbGhvc3Q6JHt0aGlzLmh0dHBQb3J0fS9hcGkvdjEvbWVzc2FnZXNgLCB7XG4gICAgICAgIG1ldGhvZDogJ0RFTEVURScsXG4gICAgICB9KTtcbiAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gY2xlYXIgZW1haWxzOiAke3Jlc3BvbnNlLnN0YXR1c31gKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS53YXJuKCdGYWlsZWQgdG8gY2xlYXIgTWFpbEhvZyBlbWFpbHM6JywgZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHdhaXRGb3JFbWFpbCh0bzogc3RyaW5nLCB0aW1lb3V0ID0gMTAwMDApOiBQcm9taXNlPEVtYWlsTWVzc2FnZT4ge1xuICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgXG4gICAgd2hpbGUgKERhdGUubm93KCkgLSBzdGFydFRpbWUgPCB0aW1lb3V0KSB7XG4gICAgICBjb25zdCBlbWFpbHMgPSBhd2FpdCB0aGlzLmdldEVtYWlscygpO1xuICAgICAgY29uc3QgdGFyZ2V0RW1haWwgPSBlbWFpbHMuZmluZChlbWFpbCA9PiBcbiAgICAgICAgZW1haWwudG8uc29tZShyZWNpcGllbnQgPT4gcmVjaXBpZW50LnRvTG93ZXJDYXNlKCkgPT09IHRvLnRvTG93ZXJDYXNlKCkpXG4gICAgICApO1xuICAgICAgXG4gICAgICBpZiAodGFyZ2V0RW1haWwpIHtcbiAgICAgICAgcmV0dXJuIHRhcmdldEVtYWlsO1xuICAgICAgfVxuICAgICAgXG4gICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgNTAwKSk7XG4gICAgfVxuICAgIFxuICAgIHRocm93IG5ldyBFcnJvcihgTm8gZW1haWwgcmVjZWl2ZWQgZm9yICR7dG99IHdpdGhpbiAke3RpbWVvdXR9bXNgKTtcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VNYWlsSG9nTWVzc2FnZShtc2c6IHsgSUQ6IHN0cmluZzsgQ29udGVudDogeyBIZWFkZXJzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmdbXT47IEJvZHk6IHN0cmluZzsgTUlNRT86IHsgUGFydHM6IHVua25vd25bXSB9IH07IENyZWF0ZWQ6IHN0cmluZyB9KTogRW1haWxNZXNzYWdlIHtcbiAgICBjb25zdCBjb250ZW50ID0gbXNnLkNvbnRlbnQ7XG4gICAgY29uc3QgaGVhZGVycyA9IGNvbnRlbnQuSGVhZGVycztcbiAgICBcbiAgICByZXR1cm4ge1xuICAgICAgaWQ6IG1zZy5JRCxcbiAgICAgIGZyb206IHRoaXMucGFyc2VFbWFpbEFkZHJlc3MoaGVhZGVycy5Gcm9tPy5bMF0gfHwgJycpLFxuICAgICAgdG86IChoZWFkZXJzLlRvIHx8IFtdKS5tYXAodGhpcy5wYXJzZUVtYWlsQWRkcmVzcyksXG4gICAgICBzdWJqZWN0OiBoZWFkZXJzLlN1YmplY3Q/LlswXSB8fCAnJyxcbiAgICAgIHRleHQ6IGNvbnRlbnQuQm9keSB8fCAnJyxcbiAgICAgIGh0bWw6IGNvbnRlbnQuTUlNRT8uUGFydHM/LmZpbmQoKHBhcnQ6IHVua25vd24pID0+IChwYXJ0IGFzIHsgSGVhZGVyczogUmVjb3JkPHN0cmluZywgc3RyaW5nW10+IH0pLkhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddPy5bMF0/LmluY2x1ZGVzKCd0ZXh0L2h0bWwnKSk/LkJvZHksXG4gICAgICBhdHRhY2htZW50czogdGhpcy5wYXJzZUF0dGFjaG1lbnRzKGNvbnRlbnQuTUlNRT8uUGFydHMgfHwgW10pLFxuICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZShtc2cuQ3JlYXRlZCksXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VFbWFpbEFkZHJlc3MoYWRkcjogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAvLyBFeHRyYWN0IGVtYWlsIGZyb20gXCJOYW1lIDxlbWFpbEBkb21haW4uY29tPlwiIGZvcm1hdFxuICAgIGNvbnN0IG1hdGNoID0gYWRkci5tYXRjaCgvPChbXj5dKyk+Lyk7XG4gICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiBhZGRyO1xuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZUF0dGFjaG1lbnRzKHBhcnRzOiB7IEhlYWRlcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZ1tdPjsgQm9keTogc3RyaW5nIH1bXSk6IEVtYWlsTWVzc2FnZVsnYXR0YWNobWVudHMnXSB7XG4gICAgcmV0dXJuIHBhcnRzXG4gICAgICAuZmlsdGVyKHBhcnQgPT4gcGFydC5IZWFkZXJzWydDb250ZW50LURpc3Bvc2l0aW9uJ10/LlswXT8uaW5jbHVkZXMoJ2F0dGFjaG1lbnQnKSlcbiAgICAgIC5tYXAocGFydCA9PiAoe1xuICAgICAgICBmaWxlbmFtZTogdGhpcy5leHRyYWN0RmlsZW5hbWUocGFydC5IZWFkZXJzWydDb250ZW50LURpc3Bvc2l0aW9uJ11bMF0pLFxuICAgICAgICBjb250ZW50OiBCdWZmZXIuZnJvbShwYXJ0LkJvZHksICdiYXNlNjQnKSxcbiAgICAgICAgY29udGVudFR5cGU6IHBhcnQuSGVhZGVyc1snQ29udGVudC1UeXBlJ10/LlswXSB8fCAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJyxcbiAgICAgIH0pKTtcbiAgfVxuXG4gIHByaXZhdGUgZXh0cmFjdEZpbGVuYW1lKGNvbnRlbnREaXNwb3NpdGlvbjogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCBtYXRjaCA9IGNvbnRlbnREaXNwb3NpdGlvbi5tYXRjaCgvZmlsZW5hbWU9XCIoW15cIl0rKVwiLyk7XG4gICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiAnYXR0YWNobWVudCc7XG4gIH1cbn1cblxuLy8gSW4tbWVtb3J5IHRlc3QgcHJvdmlkZXIgZm9yIENJIGVudmlyb25tZW50c1xuZXhwb3J0IGNsYXNzIEluTWVtb3J5VGVzdFByb3ZpZGVyIGltcGxlbWVudHMgVGVzdEVtYWlsUHJvdmlkZXIge1xuICBob3N0ID0gJ2xvY2FsaG9zdCc7XG4gIHBvcnQgPSA1ODc7XG4gIHByaXZhdGUgZW1haWxzOiBFbWFpbE1lc3NhZ2VbXSA9IFtdO1xuXG4gIGFzeW5jIGdldEVtYWlscygpOiBQcm9taXNlPEVtYWlsTWVzc2FnZVtdPiB7XG4gICAgcmV0dXJuIFsuLi50aGlzLmVtYWlsc107XG4gIH1cblxuICBhc3luYyBjbGVhckVtYWlscygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0aGlzLmVtYWlscyA9IFtdO1xuICB9XG5cbiAgYXN5bmMgd2FpdEZvckVtYWlsKHRvOiBzdHJpbmcsIHRpbWVvdXQgPSA1MDAwKTogUHJvbWlzZTxFbWFpbE1lc3NhZ2U+IHtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIFxuICAgIHdoaWxlIChEYXRlLm5vdygpIC0gc3RhcnRUaW1lIDwgdGltZW91dCkge1xuICAgICAgY29uc3QgdGFyZ2V0RW1haWwgPSB0aGlzLmVtYWlscy5maW5kKGVtYWlsID0+IFxuICAgICAgICBlbWFpbC50by5zb21lKHJlY2lwaWVudCA9PiByZWNpcGllbnQudG9Mb3dlckNhc2UoKSA9PT0gdG8udG9Mb3dlckNhc2UoKSlcbiAgICAgICk7XG4gICAgICBcbiAgICAgIGlmICh0YXJnZXRFbWFpbCkge1xuICAgICAgICByZXR1cm4gdGFyZ2V0RW1haWw7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAxMDApKTtcbiAgICB9XG4gICAgXG4gICAgdGhyb3cgbmV3IEVycm9yKGBObyBlbWFpbCByZWNlaXZlZCBmb3IgJHt0b30gd2l0aGluICR7dGltZW91dH1tc2ApO1xuICB9XG5cbiAgLy8gVGhpcyBtZXRob2Qgd291bGQgYmUgY2FsbGVkIGJ5IGEgbW9jayBlbWFpbCBzZXJ2aWNlXG4gIGFkZEVtYWlsKGVtYWlsOiBPbWl0PEVtYWlsTWVzc2FnZSwgJ2lkJyB8ICdjcmVhdGVkQXQnPik6IHZvaWQge1xuICAgIHRoaXMuZW1haWxzLnB1c2goe1xuICAgICAgLi4uZW1haWwsXG4gICAgICBpZDogcmFuZG9tQnl0ZXMoOCkudG9TdHJpbmcoJ2hleCcpLFxuICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgIH0pO1xuICB9XG59XG5cbi8vIEZhY3RvcnkgZnVuY3Rpb24gdG8gY3JlYXRlIGFwcHJvcHJpYXRlIHRlc3QgcHJvdmlkZXJcbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVFbWFpbFRlc3RQcm92aWRlcigpOiBUZXN0RW1haWxQcm92aWRlciB7XG4gIC8vIEFsd2F5cyB1c2UgaW4tbWVtb3J5IHByb3ZpZGVyIGZvciB0ZXN0c1xuICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICd0ZXN0Jykge1xuICAgIHJldHVybiBuZXcgSW5NZW1vcnlUZXN0UHJvdmlkZXIoKTtcbiAgfVxuICAvLyBVc2UgTWFpbEhvZyBvbmx5IGluIGRldmVsb3BtZW50IHdoZW4gZXhwbGljaXRseSBlbmFibGVkXG4gIGlmIChwcm9jZXNzLmVudi5VU0VfTUFJTEhPRyA9PT0gJ3RydWUnKSB7XG4gICAgcmV0dXJuIG5ldyBNYWlsSG9nVGVzdFByb3ZpZGVyKCk7XG4gIH1cbiAgcmV0dXJuIG5ldyBJbk1lbW9yeVRlc3RQcm92aWRlcigpO1xufVxuXG4vLyBVdGlsaXR5IGZ1bmN0aW9ucyBmb3IgZW1haWwgdGVzdGluZ1xuZXhwb3J0IGZ1bmN0aW9uIGdlbmVyYXRlVGVzdEVtYWlsKGRvbWFpbiA9ICd0ZXN0LmV4YW1wbGUuY29tJyk6IHN0cmluZyB7XG4gIGNvbnN0IGlkID0gcmFuZG9tQnl0ZXMoNCkudG9TdHJpbmcoJ2hleCcpO1xuICByZXR1cm4gYHRlc3QtJHtpZH1AJHtkb21haW59YDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGV4cGVjdEVtYWlsQ29udGVudChlbWFpbDogRW1haWxNZXNzYWdlLCBleHBlY3RlZENvbnRlbnQ6IFBhcnRpYWw8RW1haWxNZXNzYWdlPik6IHZvaWQge1xuICBpZiAoZXhwZWN0ZWRDb250ZW50LnN1YmplY3QpIHtcbiAgICBleHBlY3QoZW1haWwuc3ViamVjdCkudG9Db250YWluKGV4cGVjdGVkQ29udGVudC5zdWJqZWN0KTtcbiAgfVxuICBpZiAoZXhwZWN0ZWRDb250ZW50LnRleHQpIHtcbiAgICBleHBlY3QoZW1haWwudGV4dCkudG9Db250YWluKGV4cGVjdGVkQ29udGVudC50ZXh0KTtcbiAgfVxuICBpZiAoZXhwZWN0ZWRDb250ZW50Lmh0bWwpIHtcbiAgICBleHBlY3QoZW1haWwuaHRtbCkudG9Db250YWluKGV4cGVjdGVkQ29udGVudC5odG1sKTtcbiAgfVxuICBpZiAoZXhwZWN0ZWRDb250ZW50LmZyb20pIHtcbiAgICBleHBlY3QoZW1haWwuZnJvbSkudG9CZShleHBlY3RlZENvbnRlbnQuZnJvbSk7XG4gIH1cbiAgaWYgKGV4cGVjdGVkQ29udGVudC50bykge1xuICAgIGV4cGVjdGVkQ29udGVudC50by5mb3JFYWNoKHJlY2lwaWVudCA9PiB7XG4gICAgICBleHBlY3QoZW1haWwudG8pLnRvQ29udGFpbihyZWNpcGllbnQpO1xuICAgIH0pO1xuICB9XG59Il0sInZlcnNpb24iOjN9