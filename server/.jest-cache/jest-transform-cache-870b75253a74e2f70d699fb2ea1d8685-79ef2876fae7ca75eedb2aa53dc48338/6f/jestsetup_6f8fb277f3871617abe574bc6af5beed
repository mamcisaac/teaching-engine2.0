5a920e009ca56745b1f4d6fc0bf96ca9
import { beforeEach, afterEach, beforeAll, afterAll } from '@jest/globals';
import { testDb } from './setup-test-db';
import { randomBytes } from 'crypto';
// Store current test context
let currentTestId = null;
let currentTransactionClient = null;
/**
 * Global setup for all tests
 */
beforeAll(async () => {
    const workerId = process.env.JEST_WORKER_ID || 'default';
    try {
        // Create a unique test database for this worker
        await testDb.createTestDatabase(workerId);
        // Verify database is healthy
        const isHealthy = await testDb.isDatabaseHealthy(workerId);
        if (!isHealthy) {
            throw new Error('Test database is not healthy after creation');
        }
        // Set the test client globally so the prisma module can use it
        const globalForPrisma = globalThis;
        globalForPrisma.testPrismaClient = testDb.getPrismaClient(workerId);
    }
    catch (error) {
        console.error('Failed to setup test database:', error);
        throw error;
    }
});
/**
 * Setup before each test - start transaction
 */
beforeEach(async () => {
    // Generate unique test ID
    currentTestId = randomBytes(8).toString('hex');
    try {
        // Start a real transaction for this test
        currentTransactionClient = await testDb.startTransaction(currentTestId);
        // Update the global test client so services use the transaction
        const globalForPrisma = globalThis;
        globalForPrisma.testPrismaClient = currentTransactionClient;
    }
    catch (error) {
        console.error('Failed to start transaction for test:', error);
        throw error;
    }
});
/**
 * Cleanup after each test - reset database
 */
afterEach(async () => {
    if (currentTestId) {
        try {
            // Reset the database after each test
            const workerId = process.env.JEST_WORKER_ID || 'default';
            await testDb.resetDatabase(workerId);
            // Reset the global test client
            const globalForPrisma = globalThis;
            globalForPrisma.testPrismaClient = testDb.getPrismaClient(workerId);
        }
        catch (error) {
            console.error('Failed to reset database:', error);
        }
        finally {
            currentTestId = null;
            currentTransactionClient = null;
        }
    }
});
/**
 * Global cleanup after all tests
 */
afterAll(async () => {
    try {
        // Get connection stats for debugging if tests are in debug mode
        if (process.env.DEBUG_TESTS === 'true') {
            const workerId = process.env.JEST_WORKER_ID || 'default';
            const stats = await testDb.getConnectionStats(workerId);
            console.log('Final connection stats:', stats);
        }
        await testDb.cleanup();
    }
    catch (error) {
        console.warn('Failed to cleanup test database:', error);
    }
});
/**
 * Get the current test's Prisma client
 * This will return the transaction client if available, otherwise the base client
 */
export function getTestPrismaClient() {
    // If we have an active transaction, use that client
    if (currentTransactionClient && currentTestId) {
        return currentTransactionClient;
    }
    // Otherwise, return the base client for the worker
    const workerId = process.env.JEST_WORKER_ID || 'default';
    return testDb.getPrismaClient(workerId);
}
/**
 * Execute a database operation with retry logic
 * Useful for operations that might fail due to busy database
 */
export async function executeWithRetry(fn, retries = 3) {
    return testDb.executeWithRetry(fn, retries);
}
/**
 * Clean test database (for legacy compatibility)
 */
export async function cleanTestDatabase() {
    const workerId = process.env.JEST_WORKER_ID || 'default';
    await testDb.resetDatabase(workerId);
}
/**
 * Get current test ID (useful for debugging)
 */
export function getCurrentTestId() {
    return currentTestId;
}
/**
 * Check if we're in a transaction
 */
export function isInTransaction() {
    return currentTestId !== null && currentTransactionClient !== null;
}
/**
 * Create test data with automatic cleanup
 * The data will be automatically rolled back after the test
 */
export async function createTestData(createFn) {
    const client = getTestPrismaClient();
    if (!isInTransaction()) {
        throw new Error('createTestData must be called within a test (transaction)');
    }
    return executeWithRetry(() => createFn(client));
}
export async function seedTestData(data) {
    const client = getTestPrismaClient();
    if (!isInTransaction()) {
        throw new Error('seedTestData must be called within a test (transaction)');
    }
    return executeWithRetry(async () => {
        const created = {
            users: [],
            subjects: [],
            outcomes: [],
            activities: [],
        };
        // Create users
        if (data.users) {
            for (const userData of data.users) {
                const user = await client.user.create({ data: userData });
                created.users.push(user);
            }
        }
        // Create subjects
        if (data.subjects) {
            for (const subjectData of data.subjects) {
                const subject = await client.subject.create({ data: subjectData });
                created.subjects.push(subject);
            }
        }
        // Create outcomes
        if (data.outcomes) {
            for (const outcomeData of data.outcomes) {
                const outcome = await client.outcome.create({ data: outcomeData });
                created.outcomes.push(outcome);
            }
        }
        // Create activities
        if (data.activities) {
            for (const activityData of data.activities) {
                const activity = await client.activity.create({ data: activityData });
                created.activities.push(activity);
            }
        }
        return created;
    });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3Rlc3RzL2plc3Quc2V0dXAudHMiLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzRSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUdyQyw2QkFBNkI7QUFDN0IsSUFBSSxhQUFhLEdBQWtCLElBQUksQ0FBQztBQUN4QyxJQUFJLHdCQUF3QixHQUF3QixJQUFJLENBQUM7QUFFekQ7O0dBRUc7QUFDSCxTQUFTLENBQUMsS0FBSyxJQUFJLEVBQUU7SUFDbkIsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLElBQUksU0FBUyxDQUFDO0lBRXpELElBQUksQ0FBQztRQUNILGdEQUFnRDtRQUNoRCxNQUFNLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUUxQyw2QkFBNkI7UUFDN0IsTUFBTSxTQUFTLEdBQUcsTUFBTSxNQUFNLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDM0QsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ2YsTUFBTSxJQUFJLEtBQUssQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO1FBQ2pFLENBQUM7UUFFRCwrREFBK0Q7UUFDL0QsTUFBTSxlQUFlLEdBQUcsVUFFdkIsQ0FBQztRQUNGLGVBQWUsQ0FBQyxnQkFBZ0IsR0FBRyxNQUFNLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3RFLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyxnQ0FBZ0MsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN2RCxNQUFNLEtBQUssQ0FBQztJQUNkLENBQUM7QUFDSCxDQUFDLENBQUMsQ0FBQztBQUVIOztHQUVHO0FBQ0gsVUFBVSxDQUFDLEtBQUssSUFBSSxFQUFFO0lBQ3BCLDBCQUEwQjtJQUMxQixhQUFhLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUUvQyxJQUFJLENBQUM7UUFDSCx5Q0FBeUM7UUFDekMsd0JBQXdCLEdBQUcsTUFBTSxNQUFNLENBQUMsZ0JBQWdCLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFeEUsZ0VBQWdFO1FBQ2hFLE1BQU0sZUFBZSxHQUFHLFVBRXZCLENBQUM7UUFDRixlQUFlLENBQUMsZ0JBQWdCLEdBQUcsd0JBQXdCLENBQUM7SUFDOUQsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLHVDQUF1QyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzlELE1BQU0sS0FBSyxDQUFDO0lBQ2QsQ0FBQztBQUNILENBQUMsQ0FBQyxDQUFDO0FBRUg7O0dBRUc7QUFDSCxTQUFTLENBQUMsS0FBSyxJQUFJLEVBQUU7SUFDbkIsSUFBSSxhQUFhLEVBQUUsQ0FBQztRQUNsQixJQUFJLENBQUM7WUFDSCxxQ0FBcUM7WUFDckMsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLElBQUksU0FBUyxDQUFDO1lBQ3pELE1BQU0sTUFBTSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUVyQywrQkFBK0I7WUFDL0IsTUFBTSxlQUFlLEdBQUcsVUFFdkIsQ0FBQztZQUNGLGVBQWUsQ0FBQyxnQkFBZ0IsR0FBRyxNQUFNLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3RFLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQywyQkFBMkIsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNwRCxDQUFDO2dCQUFTLENBQUM7WUFDVCxhQUFhLEdBQUcsSUFBSSxDQUFDO1lBQ3JCLHdCQUF3QixHQUFHLElBQUksQ0FBQztRQUNsQyxDQUFDO0lBQ0gsQ0FBQztBQUNILENBQUMsQ0FBQyxDQUFDO0FBRUg7O0dBRUc7QUFDSCxRQUFRLENBQUMsS0FBSyxJQUFJLEVBQUU7SUFDbEIsSUFBSSxDQUFDO1FBQ0gsZ0VBQWdFO1FBQ2hFLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEtBQUssTUFBTSxFQUFFLENBQUM7WUFDdkMsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLElBQUksU0FBUyxDQUFDO1lBQ3pELE1BQU0sS0FBSyxHQUFHLE1BQU0sTUFBTSxDQUFDLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3hELE9BQU8sQ0FBQyxHQUFHLENBQUMseUJBQXlCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDaEQsQ0FBQztRQUVELE1BQU0sTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ3pCLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsT0FBTyxDQUFDLElBQUksQ0FBQyxrQ0FBa0MsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUMxRCxDQUFDO0FBQ0gsQ0FBQyxDQUFDLENBQUM7QUFFSDs7O0dBR0c7QUFDSCxNQUFNLFVBQVUsbUJBQW1CO0lBQ2pDLG9EQUFvRDtJQUNwRCxJQUFJLHdCQUF3QixJQUFJLGFBQWEsRUFBRSxDQUFDO1FBQzlDLE9BQU8sd0JBQXdCLENBQUM7SUFDbEMsQ0FBQztJQUVELG1EQUFtRDtJQUNuRCxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSxTQUFTLENBQUM7SUFDekQsT0FBTyxNQUFNLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQzFDLENBQUM7QUFFRDs7O0dBR0c7QUFDSCxNQUFNLENBQUMsS0FBSyxVQUFVLGdCQUFnQixDQUFJLEVBQW9CLEVBQUUsT0FBTyxHQUFHLENBQUM7SUFDekUsT0FBTyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBQzlDLENBQUM7QUFFRDs7R0FFRztBQUNILE1BQU0sQ0FBQyxLQUFLLFVBQVUsaUJBQWlCO0lBQ3JDLE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxJQUFJLFNBQVMsQ0FBQztJQUN6RCxNQUFNLE1BQU0sQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDdkMsQ0FBQztBQUVEOztHQUVHO0FBQ0gsTUFBTSxVQUFVLGdCQUFnQjtJQUM5QixPQUFPLGFBQWEsQ0FBQztBQUN2QixDQUFDO0FBRUQ7O0dBRUc7QUFDSCxNQUFNLFVBQVUsZUFBZTtJQUM3QixPQUFPLGFBQWEsS0FBSyxJQUFJLElBQUksd0JBQXdCLEtBQUssSUFBSSxDQUFDO0FBQ3JFLENBQUM7QUFFRDs7O0dBR0c7QUFDSCxNQUFNLENBQUMsS0FBSyxVQUFVLGNBQWMsQ0FDbEMsUUFBOEM7SUFFOUMsTUFBTSxNQUFNLEdBQUcsbUJBQW1CLEVBQUUsQ0FBQztJQUVyQyxJQUFJLENBQUMsZUFBZSxFQUFFLEVBQUUsQ0FBQztRQUN2QixNQUFNLElBQUksS0FBSyxDQUFDLDJEQUEyRCxDQUFDLENBQUM7SUFDL0UsQ0FBQztJQUVELE9BQU8sZ0JBQWdCLENBQUMsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7QUFDbEQsQ0FBQztBQXdCRCxNQUFNLENBQUMsS0FBSyxVQUFVLFlBQVksQ0FBQyxJQUFjO0lBQy9DLE1BQU0sTUFBTSxHQUFHLG1CQUFtQixFQUFFLENBQUM7SUFFckMsSUFBSSxDQUFDLGVBQWUsRUFBRSxFQUFFLENBQUM7UUFDdkIsTUFBTSxJQUFJLEtBQUssQ0FBQyx5REFBeUQsQ0FBQyxDQUFDO0lBQzdFLENBQUM7SUFFRCxPQUFPLGdCQUFnQixDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ2pDLE1BQU0sT0FBTyxHQUFHO1lBQ2QsS0FBSyxFQUFFLEVBQXdEO1lBQy9ELFFBQVEsRUFBRSxFQUF3RDtZQUNsRSxRQUFRLEVBQUUsRUFBOEQ7WUFDeEUsVUFBVSxFQUFFLEVBQStEO1NBQzVFLENBQUM7UUFFRixlQUFlO1FBQ2YsSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDZixLQUFLLE1BQU0sUUFBUSxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztnQkFDbEMsTUFBTSxJQUFJLEdBQUcsTUFBTSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDO2dCQUMxRCxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMzQixDQUFDO1FBQ0gsQ0FBQztRQUVELGtCQUFrQjtRQUNsQixJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNsQixLQUFLLE1BQU0sV0FBVyxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztnQkFDeEMsTUFBTSxPQUFPLEdBQUcsTUFBTSxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO2dCQUNuRSxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNqQyxDQUFDO1FBQ0gsQ0FBQztRQUVELGtCQUFrQjtRQUNsQixJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNsQixLQUFLLE1BQU0sV0FBVyxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztnQkFDeEMsTUFBTSxPQUFPLEdBQUcsTUFBTSxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO2dCQUNuRSxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNqQyxDQUFDO1FBQ0gsQ0FBQztRQUVELG9CQUFvQjtRQUNwQixJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUNwQixLQUFLLE1BQU0sWUFBWSxJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztnQkFDM0MsTUFBTSxRQUFRLEdBQUcsTUFBTSxNQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDO2dCQUN0RSxPQUFPLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNwQyxDQUFDO1FBQ0gsQ0FBQztRQUVELE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWljaGFlbG1jaXNhYWMvR2l0SHViL3RlYWNoaW5nLWVuZ2luZTIuMC9zZXJ2ZXIvdGVzdHMvamVzdC5zZXR1cC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBiZWZvcmVFYWNoLCBhZnRlckVhY2gsIGJlZm9yZUFsbCwgYWZ0ZXJBbGwgfSBmcm9tICdAamVzdC9nbG9iYWxzJztcbmltcG9ydCB7IHRlc3REYiB9IGZyb20gJy4vc2V0dXAtdGVzdC1kYic7XG5pbXBvcnQgeyByYW5kb21CeXRlcyB9IGZyb20gJ2NyeXB0byc7XG5pbXBvcnQgeyBQcmlzbWFDbGllbnQgfSBmcm9tICdAdGVhY2hpbmctZW5naW5lL2RhdGFiYXNlJztcblxuLy8gU3RvcmUgY3VycmVudCB0ZXN0IGNvbnRleHRcbmxldCBjdXJyZW50VGVzdElkOiBzdHJpbmcgfCBudWxsID0gbnVsbDtcbmxldCBjdXJyZW50VHJhbnNhY3Rpb25DbGllbnQ6IFByaXNtYUNsaWVudCB8IG51bGwgPSBudWxsO1xuXG4vKipcbiAqIEdsb2JhbCBzZXR1cCBmb3IgYWxsIHRlc3RzXG4gKi9cbmJlZm9yZUFsbChhc3luYyAoKSA9PiB7XG4gIGNvbnN0IHdvcmtlcklkID0gcHJvY2Vzcy5lbnYuSkVTVF9XT1JLRVJfSUQgfHwgJ2RlZmF1bHQnO1xuXG4gIHRyeSB7XG4gICAgLy8gQ3JlYXRlIGEgdW5pcXVlIHRlc3QgZGF0YWJhc2UgZm9yIHRoaXMgd29ya2VyXG4gICAgYXdhaXQgdGVzdERiLmNyZWF0ZVRlc3REYXRhYmFzZSh3b3JrZXJJZCk7XG5cbiAgICAvLyBWZXJpZnkgZGF0YWJhc2UgaXMgaGVhbHRoeVxuICAgIGNvbnN0IGlzSGVhbHRoeSA9IGF3YWl0IHRlc3REYi5pc0RhdGFiYXNlSGVhbHRoeSh3b3JrZXJJZCk7XG4gICAgaWYgKCFpc0hlYWx0aHkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignVGVzdCBkYXRhYmFzZSBpcyBub3QgaGVhbHRoeSBhZnRlciBjcmVhdGlvbicpO1xuICAgIH1cblxuICAgIC8vIFNldCB0aGUgdGVzdCBjbGllbnQgZ2xvYmFsbHkgc28gdGhlIHByaXNtYSBtb2R1bGUgY2FuIHVzZSBpdFxuICAgIGNvbnN0IGdsb2JhbEZvclByaXNtYSA9IGdsb2JhbFRoaXMgYXMgdW5rbm93biBhcyB7XG4gICAgICB0ZXN0UHJpc21hQ2xpZW50OiBQcmlzbWFDbGllbnQgfCB1bmRlZmluZWQ7XG4gICAgfTtcbiAgICBnbG9iYWxGb3JQcmlzbWEudGVzdFByaXNtYUNsaWVudCA9IHRlc3REYi5nZXRQcmlzbWFDbGllbnQod29ya2VySWQpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBzZXR1cCB0ZXN0IGRhdGFiYXNlOicsIGVycm9yKTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufSk7XG5cbi8qKlxuICogU2V0dXAgYmVmb3JlIGVhY2ggdGVzdCAtIHN0YXJ0IHRyYW5zYWN0aW9uXG4gKi9cbmJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAvLyBHZW5lcmF0ZSB1bmlxdWUgdGVzdCBJRFxuICBjdXJyZW50VGVzdElkID0gcmFuZG9tQnl0ZXMoOCkudG9TdHJpbmcoJ2hleCcpO1xuXG4gIHRyeSB7XG4gICAgLy8gU3RhcnQgYSByZWFsIHRyYW5zYWN0aW9uIGZvciB0aGlzIHRlc3RcbiAgICBjdXJyZW50VHJhbnNhY3Rpb25DbGllbnQgPSBhd2FpdCB0ZXN0RGIuc3RhcnRUcmFuc2FjdGlvbihjdXJyZW50VGVzdElkKTtcblxuICAgIC8vIFVwZGF0ZSB0aGUgZ2xvYmFsIHRlc3QgY2xpZW50IHNvIHNlcnZpY2VzIHVzZSB0aGUgdHJhbnNhY3Rpb25cbiAgICBjb25zdCBnbG9iYWxGb3JQcmlzbWEgPSBnbG9iYWxUaGlzIGFzIHVua25vd24gYXMge1xuICAgICAgdGVzdFByaXNtYUNsaWVudDogUHJpc21hQ2xpZW50IHwgdW5kZWZpbmVkO1xuICAgIH07XG4gICAgZ2xvYmFsRm9yUHJpc21hLnRlc3RQcmlzbWFDbGllbnQgPSBjdXJyZW50VHJhbnNhY3Rpb25DbGllbnQ7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIHN0YXJ0IHRyYW5zYWN0aW9uIGZvciB0ZXN0OicsIGVycm9yKTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufSk7XG5cbi8qKlxuICogQ2xlYW51cCBhZnRlciBlYWNoIHRlc3QgLSByZXNldCBkYXRhYmFzZVxuICovXG5hZnRlckVhY2goYXN5bmMgKCkgPT4ge1xuICBpZiAoY3VycmVudFRlc3RJZCkge1xuICAgIHRyeSB7XG4gICAgICAvLyBSZXNldCB0aGUgZGF0YWJhc2UgYWZ0ZXIgZWFjaCB0ZXN0XG4gICAgICBjb25zdCB3b3JrZXJJZCA9IHByb2Nlc3MuZW52LkpFU1RfV09SS0VSX0lEIHx8ICdkZWZhdWx0JztcbiAgICAgIGF3YWl0IHRlc3REYi5yZXNldERhdGFiYXNlKHdvcmtlcklkKTtcblxuICAgICAgLy8gUmVzZXQgdGhlIGdsb2JhbCB0ZXN0IGNsaWVudFxuICAgICAgY29uc3QgZ2xvYmFsRm9yUHJpc21hID0gZ2xvYmFsVGhpcyBhcyB1bmtub3duIGFzIHtcbiAgICAgICAgdGVzdFByaXNtYUNsaWVudDogUHJpc21hQ2xpZW50IHwgdW5kZWZpbmVkO1xuICAgICAgfTtcbiAgICAgIGdsb2JhbEZvclByaXNtYS50ZXN0UHJpc21hQ2xpZW50ID0gdGVzdERiLmdldFByaXNtYUNsaWVudCh3b3JrZXJJZCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byByZXNldCBkYXRhYmFzZTonLCBlcnJvcik7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGN1cnJlbnRUZXN0SWQgPSBudWxsO1xuICAgICAgY3VycmVudFRyYW5zYWN0aW9uQ2xpZW50ID0gbnVsbDtcbiAgICB9XG4gIH1cbn0pO1xuXG4vKipcbiAqIEdsb2JhbCBjbGVhbnVwIGFmdGVyIGFsbCB0ZXN0c1xuICovXG5hZnRlckFsbChhc3luYyAoKSA9PiB7XG4gIHRyeSB7XG4gICAgLy8gR2V0IGNvbm5lY3Rpb24gc3RhdHMgZm9yIGRlYnVnZ2luZyBpZiB0ZXN0cyBhcmUgaW4gZGVidWcgbW9kZVxuICAgIGlmIChwcm9jZXNzLmVudi5ERUJVR19URVNUUyA9PT0gJ3RydWUnKSB7XG4gICAgICBjb25zdCB3b3JrZXJJZCA9IHByb2Nlc3MuZW52LkpFU1RfV09SS0VSX0lEIHx8ICdkZWZhdWx0JztcbiAgICAgIGNvbnN0IHN0YXRzID0gYXdhaXQgdGVzdERiLmdldENvbm5lY3Rpb25TdGF0cyh3b3JrZXJJZCk7XG4gICAgICBjb25zb2xlLmxvZygnRmluYWwgY29ubmVjdGlvbiBzdGF0czonLCBzdGF0cyk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGVzdERiLmNsZWFudXAoKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLndhcm4oJ0ZhaWxlZCB0byBjbGVhbnVwIHRlc3QgZGF0YWJhc2U6JywgZXJyb3IpO1xuICB9XG59KTtcblxuLyoqXG4gKiBHZXQgdGhlIGN1cnJlbnQgdGVzdCdzIFByaXNtYSBjbGllbnRcbiAqIFRoaXMgd2lsbCByZXR1cm4gdGhlIHRyYW5zYWN0aW9uIGNsaWVudCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSB0aGUgYmFzZSBjbGllbnRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldFRlc3RQcmlzbWFDbGllbnQoKTogUHJpc21hQ2xpZW50IHtcbiAgLy8gSWYgd2UgaGF2ZSBhbiBhY3RpdmUgdHJhbnNhY3Rpb24sIHVzZSB0aGF0IGNsaWVudFxuICBpZiAoY3VycmVudFRyYW5zYWN0aW9uQ2xpZW50ICYmIGN1cnJlbnRUZXN0SWQpIHtcbiAgICByZXR1cm4gY3VycmVudFRyYW5zYWN0aW9uQ2xpZW50O1xuICB9XG5cbiAgLy8gT3RoZXJ3aXNlLCByZXR1cm4gdGhlIGJhc2UgY2xpZW50IGZvciB0aGUgd29ya2VyXG4gIGNvbnN0IHdvcmtlcklkID0gcHJvY2Vzcy5lbnYuSkVTVF9XT1JLRVJfSUQgfHwgJ2RlZmF1bHQnO1xuICByZXR1cm4gdGVzdERiLmdldFByaXNtYUNsaWVudCh3b3JrZXJJZCk7XG59XG5cbi8qKlxuICogRXhlY3V0ZSBhIGRhdGFiYXNlIG9wZXJhdGlvbiB3aXRoIHJldHJ5IGxvZ2ljXG4gKiBVc2VmdWwgZm9yIG9wZXJhdGlvbnMgdGhhdCBtaWdodCBmYWlsIGR1ZSB0byBidXN5IGRhdGFiYXNlXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBleGVjdXRlV2l0aFJldHJ5PFQ+KGZuOiAoKSA9PiBQcm9taXNlPFQ+LCByZXRyaWVzID0gMyk6IFByb21pc2U8VD4ge1xuICByZXR1cm4gdGVzdERiLmV4ZWN1dGVXaXRoUmV0cnkoZm4sIHJldHJpZXMpO1xufVxuXG4vKipcbiAqIENsZWFuIHRlc3QgZGF0YWJhc2UgKGZvciBsZWdhY3kgY29tcGF0aWJpbGl0eSlcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNsZWFuVGVzdERhdGFiYXNlKCkge1xuICBjb25zdCB3b3JrZXJJZCA9IHByb2Nlc3MuZW52LkpFU1RfV09SS0VSX0lEIHx8ICdkZWZhdWx0JztcbiAgYXdhaXQgdGVzdERiLnJlc2V0RGF0YWJhc2Uod29ya2VySWQpO1xufVxuXG4vKipcbiAqIEdldCBjdXJyZW50IHRlc3QgSUQgKHVzZWZ1bCBmb3IgZGVidWdnaW5nKVxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q3VycmVudFRlc3RJZCgpOiBzdHJpbmcgfCBudWxsIHtcbiAgcmV0dXJuIGN1cnJlbnRUZXN0SWQ7XG59XG5cbi8qKlxuICogQ2hlY2sgaWYgd2UncmUgaW4gYSB0cmFuc2FjdGlvblxuICovXG5leHBvcnQgZnVuY3Rpb24gaXNJblRyYW5zYWN0aW9uKCk6IGJvb2xlYW4ge1xuICByZXR1cm4gY3VycmVudFRlc3RJZCAhPT0gbnVsbCAmJiBjdXJyZW50VHJhbnNhY3Rpb25DbGllbnQgIT09IG51bGw7XG59XG5cbi8qKlxuICogQ3JlYXRlIHRlc3QgZGF0YSB3aXRoIGF1dG9tYXRpYyBjbGVhbnVwXG4gKiBUaGUgZGF0YSB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgcm9sbGVkIGJhY2sgYWZ0ZXIgdGhlIHRlc3RcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVRlc3REYXRhPFQ+KFxuICBjcmVhdGVGbjogKHByaXNtYTogUHJpc21hQ2xpZW50KSA9PiBQcm9taXNlPFQ+LFxuKTogUHJvbWlzZTxUPiB7XG4gIGNvbnN0IGNsaWVudCA9IGdldFRlc3RQcmlzbWFDbGllbnQoKTtcblxuICBpZiAoIWlzSW5UcmFuc2FjdGlvbigpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdjcmVhdGVUZXN0RGF0YSBtdXN0IGJlIGNhbGxlZCB3aXRoaW4gYSB0ZXN0ICh0cmFuc2FjdGlvbiknKTtcbiAgfVxuXG4gIHJldHVybiBleGVjdXRlV2l0aFJldHJ5KCgpID0+IGNyZWF0ZUZuKGNsaWVudCkpO1xufVxuXG4vKipcbiAqIFNlZWQgdGVzdCBkYXRhIGZvciB0aGUgY3VycmVudCB0ZXN0XG4gKiBUaGlzIGlzIGEgaGVscGVyIGZvciBjb21tb24gdGVzdCBkYXRhIHBhdHRlcm5zXG4gKi9cbmludGVyZmFjZSBUZXN0RGF0YSB7XG4gIHVzZXJzPzogQXJyYXk8eyBlbWFpbDogc3RyaW5nOyBwYXNzd29yZDogc3RyaW5nOyBuYW1lOiBzdHJpbmc7IHJvbGU/OiBzdHJpbmcgfT47XG4gIHN1YmplY3RzPzogQXJyYXk8eyBuYW1lOiBzdHJpbmc7IGNvZGU/OiBzdHJpbmcgfT47XG4gIG91dGNvbWVzPzogQXJyYXk8e1xuICAgIGNvZGU6IHN0cmluZztcbiAgICBkZXNjcmlwdGlvbjogc3RyaW5nO1xuICAgIHN1YmplY3Q6IHN0cmluZztcbiAgICBncmFkZTogbnVtYmVyO1xuICAgIGRvbWFpbj86IHN0cmluZztcbiAgfT47XG4gIGFjdGl2aXRpZXM/OiBBcnJheTx7XG4gICAgdGl0bGU6IHN0cmluZztcbiAgICBtaWxlc3RvbmVJZDogbnVtYmVyO1xuICAgIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuICAgIGR1cmF0aW9uPzogbnVtYmVyO1xuICB9Pjtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNlZWRUZXN0RGF0YShkYXRhOiBUZXN0RGF0YSkge1xuICBjb25zdCBjbGllbnQgPSBnZXRUZXN0UHJpc21hQ2xpZW50KCk7XG5cbiAgaWYgKCFpc0luVHJhbnNhY3Rpb24oKSkge1xuICAgIHRocm93IG5ldyBFcnJvcignc2VlZFRlc3REYXRhIG11c3QgYmUgY2FsbGVkIHdpdGhpbiBhIHRlc3QgKHRyYW5zYWN0aW9uKScpO1xuICB9XG5cbiAgcmV0dXJuIGV4ZWN1dGVXaXRoUmV0cnkoYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGNyZWF0ZWQgPSB7XG4gICAgICB1c2VyczogW10gYXMgQXJyYXk8eyBpZDogbnVtYmVyOyBlbWFpbDogc3RyaW5nOyBuYW1lOiBzdHJpbmcgfT4sXG4gICAgICBzdWJqZWN0czogW10gYXMgQXJyYXk8eyBpZDogbnVtYmVyOyBuYW1lOiBzdHJpbmc7IGNvZGU/OiBzdHJpbmcgfT4sXG4gICAgICBvdXRjb21lczogW10gYXMgQXJyYXk8eyBpZDogbnVtYmVyOyBjb2RlOiBzdHJpbmc7IGRlc2NyaXB0aW9uOiBzdHJpbmcgfT4sXG4gICAgICBhY3Rpdml0aWVzOiBbXSBhcyBBcnJheTx7IGlkOiBudW1iZXI7IHRpdGxlOiBzdHJpbmc7IG1pbGVzdG9uZUlkOiBudW1iZXIgfT4sXG4gICAgfTtcblxuICAgIC8vIENyZWF0ZSB1c2Vyc1xuICAgIGlmIChkYXRhLnVzZXJzKSB7XG4gICAgICBmb3IgKGNvbnN0IHVzZXJEYXRhIG9mIGRhdGEudXNlcnMpIHtcbiAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IGNsaWVudC51c2VyLmNyZWF0ZSh7IGRhdGE6IHVzZXJEYXRhIH0pO1xuICAgICAgICBjcmVhdGVkLnVzZXJzLnB1c2godXNlcik7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIHN1YmplY3RzXG4gICAgaWYgKGRhdGEuc3ViamVjdHMpIHtcbiAgICAgIGZvciAoY29uc3Qgc3ViamVjdERhdGEgb2YgZGF0YS5zdWJqZWN0cykge1xuICAgICAgICBjb25zdCBzdWJqZWN0ID0gYXdhaXQgY2xpZW50LnN1YmplY3QuY3JlYXRlKHsgZGF0YTogc3ViamVjdERhdGEgfSk7XG4gICAgICAgIGNyZWF0ZWQuc3ViamVjdHMucHVzaChzdWJqZWN0KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgb3V0Y29tZXNcbiAgICBpZiAoZGF0YS5vdXRjb21lcykge1xuICAgICAgZm9yIChjb25zdCBvdXRjb21lRGF0YSBvZiBkYXRhLm91dGNvbWVzKSB7XG4gICAgICAgIGNvbnN0IG91dGNvbWUgPSBhd2FpdCBjbGllbnQub3V0Y29tZS5jcmVhdGUoeyBkYXRhOiBvdXRjb21lRGF0YSB9KTtcbiAgICAgICAgY3JlYXRlZC5vdXRjb21lcy5wdXNoKG91dGNvbWUpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIENyZWF0ZSBhY3Rpdml0aWVzXG4gICAgaWYgKGRhdGEuYWN0aXZpdGllcykge1xuICAgICAgZm9yIChjb25zdCBhY3Rpdml0eURhdGEgb2YgZGF0YS5hY3Rpdml0aWVzKSB7XG4gICAgICAgIGNvbnN0IGFjdGl2aXR5ID0gYXdhaXQgY2xpZW50LmFjdGl2aXR5LmNyZWF0ZSh7IGRhdGE6IGFjdGl2aXR5RGF0YSB9KTtcbiAgICAgICAgY3JlYXRlZC5hY3Rpdml0aWVzLnB1c2goYWN0aXZpdHkpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBjcmVhdGVkO1xuICB9KTtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==