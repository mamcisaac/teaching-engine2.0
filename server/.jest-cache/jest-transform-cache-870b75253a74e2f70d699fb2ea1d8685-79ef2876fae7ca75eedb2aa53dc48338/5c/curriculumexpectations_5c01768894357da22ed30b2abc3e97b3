639bb7ed3e512f686f6fb0b1742c3c91
import { Router } from 'express';
import { prisma } from '../prisma';
import { EmbeddingService } from '../services/embeddingService';
const router = Router();
// Initialize embedding service
const embeddingService = new EmbeddingService();
// Semantic search helper function
async function semanticSearch(query, limit, filters) {
    // Generate embedding for the search query
    const queryEmbedding = await embeddingService.generateEmbedding('search-query', query);
    // Get all expectations that match filters
    const where = {};
    if (filters?.subject)
        where.subject = filters.subject;
    if (filters?.grade)
        where.grade = filters.grade;
    if (filters?.strand)
        where.strand = filters.strand;
    const allExpectations = await prisma.curriculumExpectation.findMany({
        where,
        include: {
            embedding: true,
        },
    });
    // Calculate similarities and sort by relevance
    const expectationsWithSimilarity = allExpectations
        .map((expectation) => {
        // Find the best embedding match for this expectation
        let maxSimilarity = 0;
        if (expectation.embedding) {
            const similarity = cosineSimilarity(queryEmbedding?.embedding || [], expectation.embedding.embedding);
            if (similarity > maxSimilarity) {
                maxSimilarity = similarity;
            }
        }
        return {
            ...expectation,
            similarity: maxSimilarity,
        };
    })
        .filter((exp) => exp.similarity > 0.3) // Minimum similarity threshold
        .sort((a, b) => b.similarity - a.similarity)
        .slice(0, limit);
    // Remove embeddings from response
    return expectationsWithSimilarity.map(({ embedding: _embedding, similarity, ...exp }) => ({
        ...exp,
        _similarity: similarity,
    }));
}
// Cosine similarity calculation
function cosineSimilarity(a, b) {
    if (a.length !== b.length)
        return 0;
    let dotProduct = 0;
    let normA = 0;
    let normB = 0;
    for (let i = 0; i < a.length; i++) {
        dotProduct += a[i] * b[i];
        normA += a[i] * a[i];
        normB += b[i] * b[i];
    }
    if (normA === 0 || normB === 0)
        return 0;
    return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
}
// Get all curriculum expectations with optional filtering
router.get('/', async (req, res, _next) => {
    try {
        const { subject, grade, strand, search } = req.query;
        const where = {};
        // Validate and sanitize input parameters
        if (subject && typeof subject === 'string') {
            const sanitizedSubject = String(subject).trim().slice(0, 100);
            if (sanitizedSubject)
                where.subject = sanitizedSubject;
        }
        if (grade) {
            const gradeNumber = Number(grade);
            if (!isNaN(gradeNumber) && gradeNumber >= 1 && gradeNumber <= 12) {
                where.grade = gradeNumber;
            }
        }
        if (strand && typeof strand === 'string') {
            const sanitizedStrand = String(strand).trim().slice(0, 100);
            if (sanitizedStrand)
                where.strand = sanitizedStrand;
        }
        if (search && typeof search === 'string') {
            const sanitizedSearch = String(search).trim().slice(0, 200);
            if (sanitizedSearch) {
                // Database-specific case-insensitive search
                const mode = process.env.DATABASE_URL?.includes('postgresql')
                    ? { mode: 'insensitive' }
                    : {};
                where.OR = [
                    { code: { contains: sanitizedSearch, ...mode } },
                    { description: { contains: sanitizedSearch, ...mode } },
                    { descriptionFr: { contains: sanitizedSearch, ...mode } },
                ];
            }
        }
        const expectations = await prisma.curriculumExpectation.findMany({
            where,
            orderBy: [{ subject: 'asc' }, { grade: 'asc' }, { strand: 'asc' }, { code: 'asc' }],
            include: {
                unitPlans: { select: { unitPlan: { select: { id: true, title: true } } } },
                lessonPlans: { select: { lessonPlan: { select: { id: true, title: true } } } },
            },
        });
        res.json(expectations);
    }
    catch (err) {
        _next(err);
    }
});
// Create a new curriculum expectation
router.post('/', async (req, res, _next) => {
    try {
        const { code, description, strand, substrand, grade, subject, descriptionFr } = req.body;
        if (!code || !description || !strand || !grade || !subject) {
            return res.status(400).json({
                error: 'Missing required fields: code, description, strand, grade, subject',
            });
        }
        // Validate types and lengths
        if (typeof code !== 'string' || code.length > 50 || code.length < 1) {
            return res.status(400).json({ error: 'Invalid code: must be a string between 1-50 characters' });
        }
        if (typeof description !== 'string' || description.length > 1000 || description.length < 1) {
            return res.status(400).json({ error: 'Invalid description: must be a string between 1-1000 characters' });
        }
        if (typeof strand !== 'string' || strand.length > 100 || strand.length < 1) {
            return res.status(400).json({ error: 'Invalid strand: must be a string between 1-100 characters' });
        }
        if (typeof subject !== 'string' || subject.length > 100 || subject.length < 1) {
            return res.status(400).json({ error: 'Invalid subject: must be a string between 1-100 characters' });
        }
        const gradeNumber = Number(grade);
        if (isNaN(gradeNumber) || gradeNumber < 1 || gradeNumber > 12) {
            return res.status(400).json({ error: 'Invalid grade: must be a number between 1-12' });
        }
        if (substrand && (typeof substrand !== 'string' || substrand.length > 100)) {
            return res.status(400).json({ error: 'Invalid substrand: must be a string with max 100 characters' });
        }
        if (descriptionFr && (typeof descriptionFr !== 'string' || descriptionFr.length > 1000)) {
            return res.status(400).json({ error: 'Invalid descriptionFr: must be a string with max 1000 characters' });
        }
        const expectation = await prisma.curriculumExpectation.create({
            data: {
                code: code.trim(),
                description: description.trim(),
                strand: strand.trim(),
                substrand: substrand?.trim() || null,
                grade: gradeNumber,
                subject: subject.trim(),
                descriptionFr: descriptionFr?.trim() || null,
            },
            include: {
                unitPlans: { select: { unitPlan: { select: { id: true, title: true } } } },
                lessonPlans: { select: { lessonPlan: { select: { id: true, title: true } } } },
            },
        });
        res.status(201).json(expectation);
    }
    catch (err) {
        _next(err);
    }
});
// Update a curriculum expectation
router.put('/:id', async (req, res, _next) => {
    try {
        // Validate UUID format
        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
        if (!uuidRegex.test(req.params.id)) {
            return res.status(400).json({ error: 'Invalid expectation ID format' });
        }
        const { code, description, strand, substrand, grade, subject, descriptionFr } = req.body;
        // Validate input types and lengths
        if (code && (typeof code !== 'string' || code.length > 50 || code.length < 1)) {
            return res.status(400).json({ error: 'Invalid code: must be a string between 1-50 characters' });
        }
        if (description && (typeof description !== 'string' || description.length > 1000 || description.length < 1)) {
            return res.status(400).json({ error: 'Invalid description: must be a string between 1-1000 characters' });
        }
        if (strand && (typeof strand !== 'string' || strand.length > 100 || strand.length < 1)) {
            return res.status(400).json({ error: 'Invalid strand: must be a string between 1-100 characters' });
        }
        if (subject && (typeof subject !== 'string' || subject.length > 100 || subject.length < 1)) {
            return res.status(400).json({ error: 'Invalid subject: must be a string between 1-100 characters' });
        }
        let gradeNumber;
        if (grade !== undefined) {
            gradeNumber = Number(grade);
            if (isNaN(gradeNumber) || gradeNumber < 1 || gradeNumber > 12) {
                return res.status(400).json({ error: 'Invalid grade: must be a number between 1-12' });
            }
        }
        if (substrand !== undefined && substrand !== null && (typeof substrand !== 'string' || substrand.length > 100)) {
            return res.status(400).json({ error: 'Invalid substrand: must be a string with max 100 characters' });
        }
        if (descriptionFr !== undefined && descriptionFr !== null && (typeof descriptionFr !== 'string' || descriptionFr.length > 1000)) {
            return res.status(400).json({ error: 'Invalid descriptionFr: must be a string with max 1000 characters' });
        }
        const expectation = await prisma.curriculumExpectation.update({
            where: { id: req.params.id },
            data: {
                ...(code && { code: code.trim() }),
                ...(description && { description: description.trim() }),
                ...(strand && { strand: strand.trim() }),
                ...(substrand !== undefined && { substrand: substrand?.trim() || null }),
                ...(gradeNumber !== undefined && { grade: gradeNumber }),
                ...(subject && { subject: subject.trim() }),
                ...(descriptionFr !== undefined && { descriptionFr: descriptionFr?.trim() || null }),
            },
            include: {
                unitPlans: { select: { unitPlan: { select: { id: true, title: true } } } },
                lessonPlans: { select: { lessonPlan: { select: { id: true, title: true } } } },
            },
        });
        res.json(expectation);
    }
    catch (err) {
        _next(err);
    }
});
// Delete a curriculum expectation
router.delete('/:id', async (req, res, _next) => {
    try {
        // Validate UUID format
        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
        if (!uuidRegex.test(req.params.id)) {
            return res.status(400).json({ error: 'Invalid expectation ID format' });
        }
        await prisma.curriculumExpectation.delete({
            where: { id: req.params.id },
        });
        res.status(204).send();
    }
    catch (err) {
        _next(err);
    }
});
// Get a single curriculum expectation
router.get('/:id', async (req, res, _next) => {
    try {
        // Validate UUID format
        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
        if (!uuidRegex.test(req.params.id)) {
            return res.status(400).json({ error: 'Invalid expectation ID format' });
        }
        const expectation = await prisma.curriculumExpectation.findUnique({
            where: { id: req.params.id },
            include: {
                unitPlans: {
                    include: {
                        unitPlan: {
                            include: {
                                longRangePlan: true,
                                _count: { select: { lessonPlans: true } },
                            },
                        },
                    },
                },
                lessonPlans: {
                    include: {
                        lessonPlan: {
                            include: {
                                unitPlan: { select: { id: true, title: true } },
                                daybookEntry: true,
                            },
                        },
                    },
                },
                embedding: true,
            },
        });
        if (!expectation) {
            return res.status(404).json({ error: 'Curriculum expectation not found' });
        }
        res.json(expectation);
    }
    catch (err) {
        _next(err);
    }
});
// Search curriculum expectations with semantic similarity (AI-powered)
router.post('/search', async (req, res, _next) => {
    try {
        const { query, limit = 10, filters } = req.body;
        if (!query) {
            return res.status(400).json({ error: 'Query is required' });
        }
        // Try semantic search first, fallback to text search if no embeddings
        let results;
        try {
            // Attempt semantic search using embeddings
            results = await semanticSearch(query, limit, filters);
        }
        catch (error) {
            console.log('Semantic search failed, falling back to text search:', error);
            // Fallback to text-based search with proper case-insensitive handling
            const mode = process.env.DATABASE_URL?.includes('postgresql')
                ? { mode: 'insensitive' }
                : {};
            const where = {
                OR: [
                    { code: { contains: query, ...mode } },
                    { description: { contains: query, ...mode } },
                    { descriptionFr: { contains: query, ...mode } },
                    { strand: { contains: query, ...mode } },
                ],
            };
            if (filters?.subject && typeof filters.subject === 'string') {
                const sanitizedSubject = filters.subject.trim().slice(0, 100);
                if (sanitizedSubject)
                    where.subject = sanitizedSubject;
            }
            if (filters?.grade) {
                const gradeNumber = Number(filters.grade);
                if (!isNaN(gradeNumber) && gradeNumber >= 1 && gradeNumber <= 12) {
                    where.grade = gradeNumber;
                }
            }
            results = await prisma.curriculumExpectation.findMany({
                where,
                take: limit,
                orderBy: { code: 'asc' },
            });
        }
        res.json(results);
    }
    catch (err) {
        _next(err);
    }
});
// Cluster curriculum expectations by similarity (AI-powered)
router.post('/cluster', async (req, res, _next) => {
    try {
        const { expectationIds, clusterCount = 5 } = req.body;
        if (!expectationIds || !Array.isArray(expectationIds)) {
            return res.status(400).json({ error: 'expectationIds array is required' });
        }
        // Clustering is implemented through the curriculum import system
        // This endpoint provides manual clustering for ad-hoc analysis
        const clusters = {
            message: 'Manual clustering endpoint - automated clustering available through curriculum import',
            expectationIds,
            clusterCount,
        };
        res.json(clusters);
    }
    catch (err) {
        _next(err);
    }
});
// Get curriculum coverage report
router.get('/coverage/report', async (req, res, _next) => {
    try {
        const userId = parseInt(req.user?.userId || '0', 10);
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const { startDate, endDate, subject, grade } = req.query;
        // Get all expectations for the filters
        const expectationsWhere = {};
        if (subject)
            expectationsWhere.subject = String(subject);
        if (grade)
            expectationsWhere.grade = Number(grade);
        const allExpectations = await prisma.curriculumExpectation.findMany({
            where: expectationsWhere,
            select: {
                id: true,
                code: true,
                description: true,
                strand: true,
            },
        });
        // Get covered expectations through lesson plans
        const lessonPlansWhere = {
            userId,
        };
        if (startDate || endDate) {
            lessonPlansWhere.date = {};
            if (startDate)
                lessonPlansWhere.date.gte = new Date(String(startDate));
            if (endDate)
                lessonPlansWhere.date.lte = new Date(String(endDate));
        }
        const coveredExpectations = await prisma.eTFOLessonPlanExpectation.findMany({
            where: {
                lessonPlan: lessonPlansWhere,
                expectation: expectationsWhere,
            },
            select: {
                expectationId: true,
                expectation: {
                    select: {
                        id: true,
                        code: true,
                        description: true,
                        strand: true,
                    },
                },
                lessonPlan: {
                    select: {
                        id: true,
                        title: true,
                        date: true,
                    },
                },
            },
        });
        // Calculate coverage statistics
        const coveredIds = new Set(coveredExpectations.map((ce) => ce.expectationId));
        const coverage = {
            total: allExpectations.length,
            covered: coveredIds.size,
            percentage: allExpectations.length > 0
                ? Math.round((coveredIds.size / allExpectations.length) * 100)
                : 0,
            byStrand: {},
            uncovered: allExpectations.filter((e) => !coveredIds.has(e.id)),
            details: coveredExpectations,
        };
        // Calculate coverage by strand
        for (const exp of allExpectations) {
            if (!coverage.byStrand[exp.strand]) {
                coverage.byStrand[exp.strand] = { total: 0, covered: 0 };
            }
            coverage.byStrand[exp.strand].total++;
            if (coveredIds.has(exp.id)) {
                coverage.byStrand[exp.strand].covered++;
            }
        }
        res.json(coverage);
    }
    catch (err) {
        _next(err);
    }
});
export default router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9yb3V0ZXMvY3VycmljdWx1bS1leHBlY3RhdGlvbnMudHMiLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBVyxNQUFNLFNBQVMsQ0FBQztBQUUxQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ25DLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBTWhFLE1BQU0sTUFBTSxHQUFHLE1BQU0sRUFBRSxDQUFDO0FBRXhCLCtCQUErQjtBQUMvQixNQUFNLGdCQUFnQixHQUFHLElBQUksZ0JBQWdCLEVBQUUsQ0FBQztBQUVoRCxrQ0FBa0M7QUFDbEMsS0FBSyxVQUFVLGNBQWMsQ0FDM0IsS0FBYSxFQUNiLEtBQWEsRUFDYixPQUErRDtJQUUvRCwwQ0FBMEM7SUFDMUMsTUFBTSxjQUFjLEdBQUcsTUFBTSxnQkFBZ0IsQ0FBQyxpQkFBaUIsQ0FBQyxjQUFjLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFFdkYsMENBQTBDO0lBQzFDLE1BQU0sS0FBSyxHQUEyQyxFQUFFLENBQUM7SUFDekQsSUFBSSxPQUFPLEVBQUUsT0FBTztRQUFFLEtBQUssQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQztJQUN0RCxJQUFJLE9BQU8sRUFBRSxLQUFLO1FBQUUsS0FBSyxDQUFDLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDO0lBQ2hELElBQUksT0FBTyxFQUFFLE1BQU07UUFBRSxLQUFLLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7SUFFbkQsTUFBTSxlQUFlLEdBQUcsTUFBTSxNQUFNLENBQUMscUJBQXFCLENBQUMsUUFBUSxDQUFDO1FBQ2xFLEtBQUs7UUFDTCxPQUFPLEVBQUU7WUFDUCxTQUFTLEVBQUUsSUFBSTtTQUNoQjtLQUNGLENBQUMsQ0FBQztJQUVILCtDQUErQztJQUMvQyxNQUFNLDBCQUEw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b3VyY2VzIjpbIi9Vc2Vycy9taWNoYWVsbWNpc2FhYy9HaXRIdWIvdGVhY2hpbmctZW5naW5lMi4wL3NlcnZlci9zcmMvcm91dGVzL2N1cnJpY3VsdW0tZXhwZWN0YXRpb25zLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJvdXRlciwgUmVxdWVzdCB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgUHJpc21hIH0gZnJvbSAnLi4vcHJpc21hJztcbmltcG9ydCB7IHByaXNtYSB9IGZyb20gJy4uL3ByaXNtYSc7XG5pbXBvcnQgeyBFbWJlZGRpbmdTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvZW1iZWRkaW5nU2VydmljZSc7XG5cbmludGVyZmFjZSBBdXRoZW50aWNhdGVkUmVxdWVzdCBleHRlbmRzIFJlcXVlc3Qge1xuICB1c2VyPzogeyB1c2VySWQ6IHN0cmluZyB9O1xufVxuXG5jb25zdCByb3V0ZXIgPSBSb3V0ZXIoKTtcblxuLy8gSW5pdGlhbGl6ZSBlbWJlZGRpbmcgc2VydmljZVxuY29uc3QgZW1iZWRkaW5nU2VydmljZSA9IG5ldyBFbWJlZGRpbmdTZXJ2aWNlKCk7XG5cbi8vIFNlbWFudGljIHNlYXJjaCBoZWxwZXIgZnVuY3Rpb25cbmFzeW5jIGZ1bmN0aW9uIHNlbWFudGljU2VhcmNoKFxuICBxdWVyeTogc3RyaW5nLFxuICBsaW1pdDogbnVtYmVyLFxuICBmaWx0ZXJzPzogeyBzdWJqZWN0Pzogc3RyaW5nOyBncmFkZT86IG51bWJlcjsgc3RyYW5kPzogc3RyaW5nIH0sXG4pIHtcbiAgLy8gR2VuZXJhdGUgZW1iZWRkaW5nIGZvciB0aGUgc2VhcmNoIHF1ZXJ5XG4gIGNvbnN0IHF1ZXJ5RW1iZWRkaW5nID0gYXdhaXQgZW1iZWRkaW5nU2VydmljZS5nZW5lcmF0ZUVtYmVkZGluZygnc2VhcmNoLXF1ZXJ5JywgcXVlcnkpO1xuXG4gIC8vIEdldCBhbGwgZXhwZWN0YXRpb25zIHRoYXQgbWF0Y2ggZmlsdGVyc1xuICBjb25zdCB3aGVyZTogUHJpc21hLkN1cnJpY3VsdW1FeHBlY3RhdGlvbldoZXJlSW5wdXQgPSB7fTtcbiAgaWYgKGZpbHRlcnM/LnN1YmplY3QpIHdoZXJlLnN1YmplY3QgPSBmaWx0ZXJzLnN1YmplY3Q7XG4gIGlmIChmaWx0ZXJzPy5ncmFkZSkgd2hlcmUuZ3JhZGUgPSBmaWx0ZXJzLmdyYWRlO1xuICBpZiAoZmlsdGVycz8uc3RyYW5kKSB3aGVyZS5zdHJhbmQgPSBmaWx0ZXJzLnN0cmFuZDtcblxuICBjb25zdCBhbGxFeHBlY3RhdGlvbnMgPSBhd2FpdCBwcmlzbWEuY3VycmljdWx1bUV4cGVjdGF0aW9uLmZpbmRNYW55KHtcbiAgICB3aGVyZSxcbiAgICBpbmNsdWRlOiB7XG4gICAgICBlbWJlZGRpbmc6IHRydWUsXG4gICAgfSxcbiAgfSk7XG5cbiAgLy8gQ2FsY3VsYXRlIHNpbWlsYXJpdGllcyBhbmQgc29ydCBieSByZWxldmFuY2VcbiAgY29uc3QgZXhwZWN0YXRpb25zV2l0aFNpbWlsYXJpdHkgPSBhbGxFeHBlY3RhdGlvbnNcbiAgICAubWFwKChleHBlY3RhdGlvbikgPT4ge1xuICAgICAgLy8gRmluZCB0aGUgYmVzdCBlbWJlZGRpbmcgbWF0Y2ggZm9yIHRoaXMgZXhwZWN0YXRpb25cbiAgICAgIGxldCBtYXhTaW1pbGFyaXR5ID0gMDtcblxuICAgICAgaWYgKGV4cGVjdGF0aW9uLmVtYmVkZGluZykge1xuICAgICAgICBjb25zdCBzaW1pbGFyaXR5ID0gY29zaW5lU2ltaWxhcml0eShcbiAgICAgICAgICBxdWVyeUVtYmVkZGluZz8uZW1iZWRkaW5nIHx8IFtdLFxuICAgICAgICAgIGV4cGVjdGF0aW9uLmVtYmVkZGluZy5lbWJlZGRpbmcgYXMgbnVtYmVyW10sXG4gICAgICAgICk7XG4gICAgICAgIGlmIChzaW1pbGFyaXR5ID4gbWF4U2ltaWxhcml0eSkge1xuICAgICAgICAgIG1heFNpbWlsYXJpdHkgPSBzaW1pbGFyaXR5O1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLmV4cGVjdGF0aW9uLFxuICAgICAgICBzaW1pbGFyaXR5OiBtYXhTaW1pbGFyaXR5LFxuICAgICAgfTtcbiAgICB9KVxuICAgIC5maWx0ZXIoKGV4cCkgPT4gZXhwLnNpbWlsYXJpdHkgPiAwLjMpIC8vIE1pbmltdW0gc2ltaWxhcml0eSB0aHJlc2hvbGRcbiAgICAuc29ydCgoYSwgYikgPT4gYi5zaW1pbGFyaXR5IC0gYS5zaW1pbGFyaXR5KVxuICAgIC5zbGljZSgwLCBsaW1pdCk7XG5cbiAgLy8gUmVtb3ZlIGVtYmVkZGluZ3MgZnJvbSByZXNwb25zZVxuICByZXR1cm4gZXhwZWN0YXRpb25zV2l0aFNpbWlsYXJpdHkubWFwKCh7IGVtYmVkZGluZzogX2VtYmVkZGluZywgc2ltaWxhcml0eSwgLi4uZXhwIH0pID0+ICh7XG4gICAgLi4uZXhwLFxuICAgIF9zaW1pbGFyaXR5OiBzaW1pbGFyaXR5LFxuICB9KSk7XG59XG5cbi8vIENvc2luZSBzaW1pbGFyaXR5IGNhbGN1bGF0aW9uXG5mdW5jdGlvbiBjb3NpbmVTaW1pbGFyaXR5KGE6IG51bWJlcltdLCBiOiBudW1iZXJbXSk6IG51bWJlciB7XG4gIGlmIChhLmxlbmd0aCAhPT0gYi5sZW5ndGgpIHJldHVybiAwO1xuXG4gIGxldCBkb3RQcm9kdWN0ID0gMDtcbiAgbGV0IG5vcm1BID0gMDtcbiAgbGV0IG5vcm1CID0gMDtcblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGEubGVuZ3RoOyBpKyspIHtcbiAgICBkb3RQcm9kdWN0ICs9IGFbaV0gKiBiW2ldO1xuICAgIG5vcm1BICs9IGFbaV0gKiBhW2ldO1xuICAgIG5vcm1CICs9IGJbaV0gKiBiW2ldO1xuICB9XG5cbiAgaWYgKG5vcm1BID09PSAwIHx8IG5vcm1CID09PSAwKSByZXR1cm4gMDtcblxuICByZXR1cm4gZG90UHJvZHVjdCAvIChNYXRoLnNxcnQobm9ybUEpICogTWF0aC5zcXJ0KG5vcm1CKSk7XG59XG5cbi8vIEdldCBhbGwgY3VycmljdWx1bSBleHBlY3RhdGlvbnMgd2l0aCBvcHRpb25hbCBmaWx0ZXJpbmdcbnJvdXRlci5nZXQoJy8nLCBhc3luYyAocmVxOiBBdXRoZW50aWNhdGVkUmVxdWVzdCwgcmVzLCBfbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHsgc3ViamVjdCwgZ3JhZGUsIHN0cmFuZCwgc2VhcmNoIH0gPSByZXEucXVlcnk7XG5cbiAgICBjb25zdCB3aGVyZTogUHJpc21hLkN1cnJpY3VsdW1FeHBlY3RhdGlvbldoZXJlSW5wdXQgPSB7fTtcblxuICAgIC8vIFZhbGlkYXRlIGFuZCBzYW5pdGl6ZSBpbnB1dCBwYXJhbWV0ZXJzXG4gICAgaWYgKHN1YmplY3QgJiYgdHlwZW9mIHN1YmplY3QgPT09ICdzdHJpbmcnKSB7XG4gICAgICBjb25zdCBzYW5pdGl6ZWRTdWJqZWN0ID0gU3RyaW5nKHN1YmplY3QpLnRyaW0oKS5zbGljZSgwLCAxMDApO1xuICAgICAgaWYgKHNhbml0aXplZFN1YmplY3QpIHdoZXJlLnN1YmplY3QgPSBzYW5pdGl6ZWRTdWJqZWN0O1xuICAgIH1cbiAgICBcbiAgICBpZiAoZ3JhZGUpIHtcbiAgICAgIGNvbnN0IGdyYWRlTnVtYmVyID0gTnVtYmVyKGdyYWRlKTtcbiAgICAgIGlmICghaXNOYU4oZ3JhZGVOdW1iZXIpICYmIGdyYWRlTnVtYmVyID49IDEgJiYgZ3JhZGVOdW1iZXIgPD0gMTIpIHtcbiAgICAgICAgd2hlcmUuZ3JhZGUgPSBncmFkZU51bWJlcjtcbiAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgaWYgKHN0cmFuZCAmJiB0eXBlb2Ygc3RyYW5kID09PSAnc3RyaW5nJykge1xuICAgICAgY29uc3Qgc2FuaXRpemVkU3RyYW5kID0gU3RyaW5nKHN0cmFuZCkudHJpbSgpLnNsaWNlKDAsIDEwMCk7XG4gICAgICBpZiAoc2FuaXRpemVkU3RyYW5kKSB3aGVyZS5zdHJhbmQgPSBzYW5pdGl6ZWRTdHJhbmQ7XG4gICAgfVxuICAgIGlmIChzZWFyY2ggJiYgdHlwZW9mIHNlYXJjaCA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGNvbnN0IHNhbml0aXplZFNlYXJjaCA9IFN0cmluZyhzZWFyY2gpLnRyaW0oKS5zbGljZSgwLCAyMDApO1xuICAgICAgaWYgKHNhbml0aXplZFNlYXJjaCkge1xuICAgICAgICAvLyBEYXRhYmFzZS1zcGVjaWZpYyBjYXNlLWluc2Vuc2l0aXZlIHNlYXJjaFxuICAgICAgICBjb25zdCBtb2RlID0gcHJvY2Vzcy5lbnYuREFUQUJBU0VfVVJMPy5pbmNsdWRlcygncG9zdGdyZXNxbCcpIFxuICAgICAgICAgID8geyBtb2RlOiAnaW5zZW5zaXRpdmUnIGFzIGNvbnN0IH0gXG4gICAgICAgICAgOiB7fTtcbiAgICAgICAgXG4gICAgICAgIHdoZXJlLk9SID0gW1xuICAgICAgICAgIHsgY29kZTogeyBjb250YWluczogc2FuaXRpemVkU2VhcmNoLCAuLi5tb2RlIH0gfSxcbiAgICAgICAgICB7IGRlc2NyaXB0aW9uOiB7IGNvbnRhaW5zOiBzYW5pdGl6ZWRTZWFyY2gsIC4uLm1vZGUgfSB9LFxuICAgICAgICAgIHsgZGVzY3JpcHRpb25GcjogeyBjb250YWluczogc2FuaXRpemVkU2VhcmNoLCAuLi5tb2RlIH0gfSxcbiAgICAgICAgXTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBleHBlY3RhdGlvbnMgPSBhd2FpdCBwcmlzbWEuY3VycmljdWx1bUV4cGVjdGF0aW9uLmZpbmRNYW55KHtcbiAgICAgIHdoZXJlLFxuICAgICAgb3JkZXJCeTogW3sgc3ViamVjdDogJ2FzYycgfSwgeyBncmFkZTogJ2FzYycgfSwgeyBzdHJhbmQ6ICdhc2MnIH0sIHsgY29kZTogJ2FzYycgfV0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHVuaXRQbGFuczogeyBzZWxlY3Q6IHsgdW5pdFBsYW46IHsgc2VsZWN0OiB7IGlkOiB0cnVlLCB0aXRsZTogdHJ1ZSB9IH0gfSB9LFxuICAgICAgICBsZXNzb25QbGFuczogeyBzZWxlY3Q6IHsgbGVzc29uUGxhbjogeyBzZWxlY3Q6IHsgaWQ6IHRydWUsIHRpdGxlOiB0cnVlIH0gfSB9IH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgcmVzLmpzb24oZXhwZWN0YXRpb25zKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgX25leHQoZXJyKTtcbiAgfVxufSk7XG5cbi8vIENyZWF0ZSBhIG5ldyBjdXJyaWN1bHVtIGV4cGVjdGF0aW9uXG5yb3V0ZXIucG9zdCgnLycsIGFzeW5jIChyZXE6IEF1dGhlbnRpY2F0ZWRSZXF1ZXN0LCByZXMsIF9uZXh0KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBjb2RlLCBkZXNjcmlwdGlvbiwgc3RyYW5kLCBzdWJzdHJhbmQsIGdyYWRlLCBzdWJqZWN0LCBkZXNjcmlwdGlvbkZyIH0gPSByZXEuYm9keTtcblxuICAgIGlmICghY29kZSB8fCAhZGVzY3JpcHRpb24gfHwgIXN0cmFuZCB8fCAhZ3JhZGUgfHwgIXN1YmplY3QpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnTWlzc2luZyByZXF1aXJlZCBmaWVsZHM6IGNvZGUsIGRlc2NyaXB0aW9uLCBzdHJhbmQsIGdyYWRlLCBzdWJqZWN0JyxcbiAgICAgIH0pO1xuICAgIH1cbiAgICBcbiAgICAvLyBWYWxpZGF0ZSB0eXBlcyBhbmQgbGVuZ3Roc1xuICAgIGlmICh0eXBlb2YgY29kZSAhPT0gJ3N0cmluZycgfHwgY29kZS5sZW5ndGggPiA1MCB8fCBjb2RlLmxlbmd0aCA8IDEpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiAnSW52YWxpZCBjb2RlOiBtdXN0IGJlIGEgc3RyaW5nIGJldHdlZW4gMS01MCBjaGFyYWN0ZXJzJyB9KTtcbiAgICB9XG4gICAgXG4gICAgaWYgKHR5cGVvZiBkZXNjcmlwdGlvbiAhPT0gJ3N0cmluZycgfHwgZGVzY3JpcHRpb24ubGVuZ3RoID4gMTAwMCB8fCBkZXNjcmlwdGlvbi5sZW5ndGggPCAxKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ0ludmFsaWQgZGVzY3JpcHRpb246IG11c3QgYmUgYSBzdHJpbmcgYmV0d2VlbiAxLTEwMDAgY2hhcmFjdGVycycgfSk7XG4gICAgfVxuICAgIFxuICAgIGlmICh0eXBlb2Ygc3RyYW5kICE9PSAnc3RyaW5nJyB8fCBzdHJhbmQubGVuZ3RoID4gMTAwIHx8IHN0cmFuZC5sZW5ndGggPCAxKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ0ludmFsaWQgc3RyYW5kOiBtdXN0IGJlIGEgc3RyaW5nIGJldHdlZW4gMS0xMDAgY2hhcmFjdGVycycgfSk7XG4gICAgfVxuICAgIFxuICAgIGlmICh0eXBlb2Ygc3ViamVjdCAhPT0gJ3N0cmluZycgfHwgc3ViamVjdC5sZW5ndGggPiAxMDAgfHwgc3ViamVjdC5sZW5ndGggPCAxKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ0ludmFsaWQgc3ViamVjdDogbXVzdCBiZSBhIHN0cmluZyBiZXR3ZWVuIDEtMTAwIGNoYXJhY3RlcnMnIH0pO1xuICAgIH1cbiAgICBcbiAgICBjb25zdCBncmFkZU51bWJlciA9IE51bWJlcihncmFkZSk7XG4gICAgaWYgKGlzTmFOKGdyYWRlTnVtYmVyKSB8fCBncmFkZU51bWJlciA8IDEgfHwgZ3JhZGVOdW1iZXIgPiAxMikge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgZXJyb3I6ICdJbnZhbGlkIGdyYWRlOiBtdXN0IGJlIGEgbnVtYmVyIGJldHdlZW4gMS0xMicgfSk7XG4gICAgfVxuICAgIFxuICAgIGlmIChzdWJzdHJhbmQgJiYgKHR5cGVvZiBzdWJzdHJhbmQgIT09ICdzdHJpbmcnIHx8IHN1YnN0cmFuZC5sZW5ndGggPiAxMDApKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ0ludmFsaWQgc3Vic3RyYW5kOiBtdXN0IGJlIGEgc3RyaW5nIHdpdGggbWF4IDEwMCBjaGFyYWN0ZXJzJyB9KTtcbiAgICB9XG4gICAgXG4gICAgaWYgKGRlc2NyaXB0aW9uRnIgJiYgKHR5cGVvZiBkZXNjcmlwdGlvbkZyICE9PSAnc3RyaW5nJyB8fCBkZXNjcmlwdGlvbkZyLmxlbmd0aCA+IDEwMDApKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ0ludmFsaWQgZGVzY3JpcHRpb25GcjogbXVzdCBiZSBhIHN0cmluZyB3aXRoIG1heCAxMDAwIGNoYXJhY3RlcnMnIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGV4cGVjdGF0aW9uID0gYXdhaXQgcHJpc21hLmN1cnJpY3VsdW1FeHBlY3RhdGlvbi5jcmVhdGUoe1xuICAgICAgZGF0YToge1xuICAgICAgICBjb2RlOiBjb2RlLnRyaW0oKSxcbiAgICAgICAgZGVzY3JpcHRpb246IGRlc2NyaXB0aW9uLnRyaW0oKSxcbiAgICAgICAgc3RyYW5kOiBzdHJhbmQudHJpbSgpLFxuICAgICAgICBzdWJzdHJhbmQ6IHN1YnN0cmFuZD8udHJpbSgpIHx8IG51bGwsXG4gICAgICAgIGdyYWRlOiBncmFkZU51bWJlcixcbiAgICAgICAgc3ViamVjdDogc3ViamVjdC50cmltKCksXG4gICAgICAgIGRlc2NyaXB0aW9uRnI6IGRlc2NyaXB0aW9uRnI/LnRyaW0oKSB8fCBudWxsLFxuICAgICAgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgdW5pdFBsYW5zOiB7IHNlbGVjdDogeyB1bml0UGxhbjogeyBzZWxlY3Q6IHsgaWQ6IHRydWUsIHRpdGxlOiB0cnVlIH0gfSB9IH0sXG4gICAgICAgIGxlc3NvblBsYW5zOiB7IHNlbGVjdDogeyBsZXNzb25QbGFuOiB7IHNlbGVjdDogeyBpZDogdHJ1ZSwgdGl0bGU6IHRydWUgfSB9IH0gfSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICByZXMuc3RhdHVzKDIwMSkuanNvbihleHBlY3RhdGlvbik7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIF9uZXh0KGVycik7XG4gIH1cbn0pO1xuXG4vLyBVcGRhdGUgYSBjdXJyaWN1bHVtIGV4cGVjdGF0aW9uXG5yb3V0ZXIucHV0KCcvOmlkJywgYXN5bmMgKHJlcTogQXV0aGVudGljYXRlZFJlcXVlc3QsIHJlcywgX25leHQpID0+IHtcbiAgdHJ5IHtcbiAgICAvLyBWYWxpZGF0ZSBVVUlEIGZvcm1hdFxuICAgIGNvbnN0IHV1aWRSZWdleCA9IC9eWzAtOWEtZl17OH0tWzAtOWEtZl17NH0tWzAtOWEtZl17NH0tWzAtOWEtZl17NH0tWzAtOWEtZl17MTJ9JC9pO1xuICAgIGlmICghdXVpZFJlZ2V4LnRlc3QocmVxLnBhcmFtcy5pZCkpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiAnSW52YWxpZCBleHBlY3RhdGlvbiBJRCBmb3JtYXQnIH0pO1xuICAgIH1cbiAgICBcbiAgICBjb25zdCB7IGNvZGUsIGRlc2NyaXB0aW9uLCBzdHJhbmQsIHN1YnN0cmFuZCwgZ3JhZGUsIHN1YmplY3QsIGRlc2NyaXB0aW9uRnIgfSA9IHJlcS5ib2R5O1xuICAgIFxuICAgIC8vIFZhbGlkYXRlIGlucHV0IHR5cGVzIGFuZCBsZW5ndGhzXG4gICAgaWYgKGNvZGUgJiYgKHR5cGVvZiBjb2RlICE9PSAnc3RyaW5nJyB8fCBjb2RlLmxlbmd0aCA+IDUwIHx8IGNvZGUubGVuZ3RoIDwgMSkpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiAnSW52YWxpZCBjb2RlOiBtdXN0IGJlIGEgc3RyaW5nIGJldHdlZW4gMS01MCBjaGFyYWN0ZXJzJyB9KTtcbiAgICB9XG4gICAgXG4gICAgaWYgKGRlc2NyaXB0aW9uICYmICh0eXBlb2YgZGVzY3JpcHRpb24gIT09ICdzdHJpbmcnIHx8IGRlc2NyaXB0aW9uLmxlbmd0aCA+IDEwMDAgfHwgZGVzY3JpcHRpb24ubGVuZ3RoIDwgMSkpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiAnSW52YWxpZCBkZXNjcmlwdGlvbjogbXVzdCBiZSBhIHN0cmluZyBiZXR3ZWVuIDEtMTAwMCBjaGFyYWN0ZXJzJyB9KTtcbiAgICB9XG4gICAgXG4gICAgaWYgKHN0cmFuZCAmJiAodHlwZW9mIHN0cmFuZCAhPT0gJ3N0cmluZycgfHwgc3RyYW5kLmxlbmd0aCA+IDEwMCB8fCBzdHJhbmQubGVuZ3RoIDwgMSkpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiAnSW52YWxpZCBzdHJhbmQ6IG11c3QgYmUgYSBzdHJpbmcgYmV0d2VlbiAxLTEwMCBjaGFyYWN0ZXJzJyB9KTtcbiAgICB9XG4gICAgXG4gICAgaWYgKHN1YmplY3QgJiYgKHR5cGVvZiBzdWJqZWN0ICE9PSAnc3RyaW5nJyB8fCBzdWJqZWN0Lmxlbmd0aCA+IDEwMCB8fCBzdWJqZWN0Lmxlbmd0aCA8IDEpKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ0ludmFsaWQgc3ViamVjdDogbXVzdCBiZSBhIHN0cmluZyBiZXR3ZWVuIDEtMTAwIGNoYXJhY3RlcnMnIH0pO1xuICAgIH1cbiAgICBcbiAgICBsZXQgZ3JhZGVOdW1iZXI6IG51bWJlciB8IHVuZGVmaW5lZDtcbiAgICBpZiAoZ3JhZGUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgZ3JhZGVOdW1iZXIgPSBOdW1iZXIoZ3JhZGUpO1xuICAgICAgaWYgKGlzTmFOKGdyYWRlTnVtYmVyKSB8fCBncmFkZU51bWJlciA8IDEgfHwgZ3JhZGVOdW1iZXIgPiAxMikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ0ludmFsaWQgZ3JhZGU6IG11c3QgYmUgYSBudW1iZXIgYmV0d2VlbiAxLTEyJyB9KTtcbiAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgaWYgKHN1YnN0cmFuZCAhPT0gdW5kZWZpbmVkICYmIHN1YnN0cmFuZCAhPT0gbnVsbCAmJiAodHlwZW9mIHN1YnN0cmFuZCAhPT0gJ3N0cmluZycgfHwgc3Vic3RyYW5kLmxlbmd0aCA+IDEwMCkpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiAnSW52YWxpZCBzdWJzdHJhbmQ6IG11c3QgYmUgYSBzdHJpbmcgd2l0aCBtYXggMTAwIGNoYXJhY3RlcnMnIH0pO1xuICAgIH1cbiAgICBcbiAgICBpZiAoZGVzY3JpcHRpb25GciAhPT0gdW5kZWZpbmVkICYmIGRlc2NyaXB0aW9uRnIgIT09IG51bGwgJiYgKHR5cGVvZiBkZXNjcmlwdGlvbkZyICE9PSAnc3RyaW5nJyB8fCBkZXNjcmlwdGlvbkZyLmxlbmd0aCA+IDEwMDApKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ0ludmFsaWQgZGVzY3JpcHRpb25GcjogbXVzdCBiZSBhIHN0cmluZyB3aXRoIG1heCAxMDAwIGNoYXJhY3RlcnMnIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGV4cGVjdGF0aW9uID0gYXdhaXQgcHJpc21hLmN1cnJpY3VsdW1FeHBlY3RhdGlvbi51cGRhdGUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHJlcS5wYXJhbXMuaWQgfSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgLi4uKGNvZGUgJiYgeyBjb2RlOiBjb2RlLnRyaW0oKSB9KSxcbiAgICAgICAgLi4uKGRlc2NyaXB0aW9uICYmIHsgZGVzY3JpcHRpb246IGRlc2NyaXB0aW9uLnRyaW0oKSB9KSxcbiAgICAgICAgLi4uKHN0cmFuZCAmJiB7IHN0cmFuZDogc3RyYW5kLnRyaW0oKSB9KSxcbiAgICAgICAgLi4uKHN1YnN0cmFuZCAhPT0gdW5kZWZpbmVkICYmIHsgc3Vic3RyYW5kOiBzdWJzdHJhbmQ/LnRyaW0oKSB8fCBudWxsIH0pLFxuICAgICAgICAuLi4oZ3JhZGVOdW1iZXIgIT09IHVuZGVmaW5lZCAmJiB7IGdyYWRlOiBncmFkZU51bWJlciB9KSxcbiAgICAgICAgLi4uKHN1YmplY3QgJiYgeyBzdWJqZWN0OiBzdWJqZWN0LnRyaW0oKSB9KSxcbiAgICAgICAgLi4uKGRlc2NyaXB0aW9uRnIgIT09IHVuZGVmaW5lZCAmJiB7IGRlc2NyaXB0aW9uRnI6IGRlc2NyaXB0aW9uRnI/LnRyaW0oKSB8fCBudWxsIH0pLFxuICAgICAgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgdW5pdFBsYW5zOiB7IHNlbGVjdDogeyB1bml0UGxhbjogeyBzZWxlY3Q6IHsgaWQ6IHRydWUsIHRpdGxlOiB0cnVlIH0gfSB9IH0sXG4gICAgICAgIGxlc3NvblBsYW5zOiB7IHNlbGVjdDogeyBsZXNzb25QbGFuOiB7IHNlbGVjdDogeyBpZDogdHJ1ZSwgdGl0bGU6IHRydWUgfSB9IH0gfSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICByZXMuanNvbihleHBlY3RhdGlvbik7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIF9uZXh0KGVycik7XG4gIH1cbn0pO1xuXG4vLyBEZWxldGUgYSBjdXJyaWN1bHVtIGV4cGVjdGF0aW9uXG5yb3V0ZXIuZGVsZXRlKCcvOmlkJywgYXN5bmMgKHJlcTogQXV0aGVudGljYXRlZFJlcXVlc3QsIHJlcywgX25leHQpID0+IHtcbiAgdHJ5IHtcbiAgICAvLyBWYWxpZGF0ZSBVVUlEIGZvcm1hdFxuICAgIGNvbnN0IHV1aWRSZWdleCA9IC9eWzAtOWEtZl17OH0tWzAtOWEtZl17NH0tWzAtOWEtZl17NH0tWzAtOWEtZl17NH0tWzAtOWEtZl17MTJ9JC9pO1xuICAgIGlmICghdXVpZFJlZ2V4LnRlc3QocmVxLnBhcmFtcy5pZCkpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiAnSW52YWxpZCBleHBlY3RhdGlvbiBJRCBmb3JtYXQnIH0pO1xuICAgIH1cbiAgICBcbiAgICBhd2FpdCBwcmlzbWEuY3VycmljdWx1bUV4cGVjdGF0aW9uLmRlbGV0ZSh7XG4gICAgICB3aGVyZTogeyBpZDogcmVxLnBhcmFtcy5pZCB9LFxuICAgIH0pO1xuXG4gICAgcmVzLnN0YXR1cygyMDQpLnNlbmQoKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgX25leHQoZXJyKTtcbiAgfVxufSk7XG5cbi8vIEdldCBhIHNpbmdsZSBjdXJyaWN1bHVtIGV4cGVjdGF0aW9uXG5yb3V0ZXIuZ2V0KCcvOmlkJywgYXN5bmMgKHJlcTogQXV0aGVudGljYXRlZFJlcXVlc3QsIHJlcywgX25leHQpID0+IHtcbiAgdHJ5IHtcbiAgICAvLyBWYWxpZGF0ZSBVVUlEIGZvcm1hdFxuICAgIGNvbnN0IHV1aWRSZWdleCA9IC9eWzAtOWEtZl17OH0tWzAtOWEtZl17NH0tWzAtOWEtZl17NH0tWzAtOWEtZl17NH0tWzAtOWEtZl17MTJ9JC9pO1xuICAgIGlmICghdXVpZFJlZ2V4LnRlc3QocmVxLnBhcmFtcy5pZCkpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiAnSW52YWxpZCBleHBlY3RhdGlvbiBJRCBmb3JtYXQnIH0pO1xuICAgIH1cbiAgICBcbiAgICBjb25zdCBleHBlY3RhdGlvbiA9IGF3YWl0IHByaXNtYS5jdXJyaWN1bHVtRXhwZWN0YXRpb24uZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBpZDogcmVxLnBhcmFtcy5pZCB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICB1bml0UGxhbnM6IHtcbiAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICB1bml0UGxhbjoge1xuICAgICAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICAgICAgbG9uZ1JhbmdlUGxhbjogdHJ1ZSxcbiAgICAgICAgICAgICAgICBfY291bnQ6IHsgc2VsZWN0OiB7IGxlc3NvblBsYW5zOiB0cnVlIH0gfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgbGVzc29uUGxhbnM6IHtcbiAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICBsZXNzb25QbGFuOiB7XG4gICAgICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgICAgICB1bml0UGxhbjogeyBzZWxlY3Q6IHsgaWQ6IHRydWUsIHRpdGxlOiB0cnVlIH0gfSxcbiAgICAgICAgICAgICAgICBkYXlib29rRW50cnk6IHRydWUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIGVtYmVkZGluZzogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIWV4cGVjdGF0aW9uKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBlcnJvcjogJ0N1cnJpY3VsdW0gZXhwZWN0YXRpb24gbm90IGZvdW5kJyB9KTtcbiAgICB9XG5cbiAgICByZXMuanNvbihleHBlY3RhdGlvbik7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIF9uZXh0KGVycik7XG4gIH1cbn0pO1xuXG4vLyBTZWFyY2ggY3VycmljdWx1bSBleHBlY3RhdGlvbnMgd2l0aCBzZW1hbnRpYyBzaW1pbGFyaXR5IChBSS1wb3dlcmVkKVxucm91dGVyLnBvc3QoJy9zZWFyY2gnLCBhc3luYyAocmVxOiBBdXRoZW50aWNhdGVkUmVxdWVzdCwgcmVzLCBfbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHsgcXVlcnksIGxpbWl0ID0gMTAsIGZpbHRlcnMgfSA9IHJlcS5ib2R5O1xuXG4gICAgaWYgKCFxdWVyeSkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgZXJyb3I6ICdRdWVyeSBpcyByZXF1aXJlZCcgfSk7XG4gICAgfVxuXG4gICAgLy8gVHJ5IHNlbWFudGljIHNlYXJjaCBmaXJzdCwgZmFsbGJhY2sgdG8gdGV4dCBzZWFyY2ggaWYgbm8gZW1iZWRkaW5nc1xuICAgIGxldCByZXN1bHRzO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIEF0dGVtcHQgc2VtYW50aWMgc2VhcmNoIHVzaW5nIGVtYmVkZGluZ3NcbiAgICAgIHJlc3VsdHMgPSBhd2FpdCBzZW1hbnRpY1NlYXJjaChxdWVyeSwgbGltaXQsIGZpbHRlcnMpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmxvZygnU2VtYW50aWMgc2VhcmNoIGZhaWxlZCwgZmFsbGluZyBiYWNrIHRvIHRleHQgc2VhcmNoOicsIGVycm9yKTtcblxuICAgICAgLy8gRmFsbGJhY2sgdG8gdGV4dC1iYXNlZCBzZWFyY2ggd2l0aCBwcm9wZXIgY2FzZS1pbnNlbnNpdGl2ZSBoYW5kbGluZ1xuICAgICAgY29uc3QgbW9kZSA9IHByb2Nlc3MuZW52LkRBVEFCQVNFX1VSTD8uaW5jbHVkZXMoJ3Bvc3RncmVzcWwnKSBcbiAgICAgICAgPyB7IG1vZGU6ICdpbnNlbnNpdGl2ZScgYXMgY29uc3QgfSBcbiAgICAgICAgOiB7fTtcbiAgICAgICAgXG4gICAgICBjb25zdCB3aGVyZTogUHJpc21hLkN1cnJpY3VsdW1FeHBlY3RhdGlvbldoZXJlSW5wdXQgPSB7XG4gICAgICAgIE9SOiBbXG4gICAgICAgICAgeyBjb2RlOiB7IGNvbnRhaW5zOiBxdWVyeSwgLi4ubW9kZSB9IH0sXG4gICAgICAgICAgeyBkZXNjcmlwdGlvbjogeyBjb250YWluczogcXVlcnksIC4uLm1vZGUgfSB9LFxuICAgICAgICAgIHsgZGVzY3JpcHRpb25GcjogeyBjb250YWluczogcXVlcnksIC4uLm1vZGUgfSB9LFxuICAgICAgICAgIHsgc3RyYW5kOiB7IGNvbnRhaW5zOiBxdWVyeSwgLi4ubW9kZSB9IH0sXG4gICAgICAgIF0sXG4gICAgICB9O1xuXG4gICAgICBpZiAoZmlsdGVycz8uc3ViamVjdCAmJiB0eXBlb2YgZmlsdGVycy5zdWJqZWN0ID09PSAnc3RyaW5nJykge1xuICAgICAgICBjb25zdCBzYW5pdGl6ZWRTdWJqZWN0ID0gZmlsdGVycy5zdWJqZWN0LnRyaW0oKS5zbGljZSgwLCAxMDApO1xuICAgICAgICBpZiAoc2FuaXRpemVkU3ViamVjdCkgd2hlcmUuc3ViamVjdCA9IHNhbml0aXplZFN1YmplY3Q7XG4gICAgICB9XG4gICAgICBpZiAoZmlsdGVycz8uZ3JhZGUpIHtcbiAgICAgICAgY29uc3QgZ3JhZGVOdW1iZXIgPSBOdW1iZXIoZmlsdGVycy5ncmFkZSk7XG4gICAgICAgIGlmICghaXNOYU4oZ3JhZGVOdW1iZXIpICYmIGdyYWRlTnVtYmVyID49IDEgJiYgZ3JhZGVOdW1iZXIgPD0gMTIpIHtcbiAgICAgICAgICB3aGVyZS5ncmFkZSA9IGdyYWRlTnVtYmVyO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJlc3VsdHMgPSBhd2FpdCBwcmlzbWEuY3VycmljdWx1bUV4cGVjdGF0aW9uLmZpbmRNYW55KHtcbiAgICAgICAgd2hlcmUsXG4gICAgICAgIHRha2U6IGxpbWl0LFxuICAgICAgICBvcmRlckJ5OiB7IGNvZGU6ICdhc2MnIH0sXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXMuanNvbihyZXN1bHRzKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgX25leHQoZXJyKTtcbiAgfVxufSk7XG5cbi8vIENsdXN0ZXIgY3VycmljdWx1bSBleHBlY3RhdGlvbnMgYnkgc2ltaWxhcml0eSAoQUktcG93ZXJlZClcbnJvdXRlci5wb3N0KCcvY2x1c3RlcicsIGFzeW5jIChyZXE6IEF1dGhlbnRpY2F0ZWRSZXF1ZXN0LCByZXMsIF9uZXh0KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBleHBlY3RhdGlvbklkcywgY2x1c3RlckNvdW50ID0gNSB9ID0gcmVxLmJvZHk7XG5cbiAgICBpZiAoIWV4cGVjdGF0aW9uSWRzIHx8ICFBcnJheS5pc0FycmF5KGV4cGVjdGF0aW9uSWRzKSkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgZXJyb3I6ICdleHBlY3RhdGlvbklkcyBhcnJheSBpcyByZXF1aXJlZCcgfSk7XG4gICAgfVxuXG4gICAgLy8gQ2x1c3RlcmluZyBpcyBpbXBsZW1lbnRlZCB0aHJvdWdoIHRoZSBjdXJyaWN1bHVtIGltcG9ydCBzeXN0ZW1cbiAgICAvLyBUaGlzIGVuZHBvaW50IHByb3ZpZGVzIG1hbnVhbCBjbHVzdGVyaW5nIGZvciBhZC1ob2MgYW5hbHlzaXNcbiAgICBjb25zdCBjbHVzdGVycyA9IHtcbiAgICAgIG1lc3NhZ2U6XG4gICAgICAgICdNYW51YWwgY2x1c3RlcmluZyBlbmRwb2ludCAtIGF1dG9tYXRlZCBjbHVzdGVyaW5nIGF2YWlsYWJsZSB0aHJvdWdoIGN1cnJpY3VsdW0gaW1wb3J0JyxcbiAgICAgIGV4cGVjdGF0aW9uSWRzLFxuICAgICAgY2x1c3RlckNvdW50LFxuICAgIH07XG5cbiAgICByZXMuanNvbihjbHVzdGVycyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIF9uZXh0KGVycik7XG4gIH1cbn0pO1xuXG4vLyBHZXQgY3VycmljdWx1bSBjb3ZlcmFnZSByZXBvcnRcbnJvdXRlci5nZXQoJy9jb3ZlcmFnZS9yZXBvcnQnLCBhc3luYyAocmVxOiBBdXRoZW50aWNhdGVkUmVxdWVzdCwgcmVzLCBfbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHVzZXJJZCA9IHBhcnNlSW50KHJlcS51c2VyPy51c2VySWQgfHwgJzAnLCAxMCk7XG4gICAgaWYgKCF1c2VySWQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAnVW5hdXRob3JpemVkJyB9KTtcbiAgICB9XG5cbiAgICBjb25zdCB7IHN0YXJ0RGF0ZSwgZW5kRGF0ZSwgc3ViamVjdCwgZ3JhZGUgfSA9IHJlcS5xdWVyeTtcblxuICAgIC8vIEdldCBhbGwgZXhwZWN0YXRpb25zIGZvciB0aGUgZmlsdGVyc1xuICAgIGNvbnN0IGV4cGVjdGF0aW9uc1doZXJlOiBQcmlzbWEuQ3VycmljdWx1bUV4cGVjdGF0aW9uV2hlcmVJbnB1dCA9IHt9O1xuICAgIGlmIChzdWJqZWN0KSBleHBlY3RhdGlvbnNXaGVyZS5zdWJqZWN0ID0gU3RyaW5nKHN1YmplY3QpO1xuICAgIGlmIChncmFkZSkgZXhwZWN0YXRpb25zV2hlcmUuZ3JhZGUgPSBOdW1iZXIoZ3JhZGUpO1xuXG4gICAgY29uc3QgYWxsRXhwZWN0YXRpb25zID0gYXdhaXQgcHJpc21hLmN1cnJpY3VsdW1FeHBlY3RhdGlvbi5maW5kTWFueSh7XG4gICAgICB3aGVyZTogZXhwZWN0YXRpb25zV2hlcmUsXG4gICAgICBzZWxlY3Q6IHtcbiAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgIGNvZGU6IHRydWUsXG4gICAgICAgIGRlc2NyaXB0aW9uOiB0cnVlLFxuICAgICAgICBzdHJhbmQ6IHRydWUsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gR2V0IGNvdmVyZWQgZXhwZWN0YXRpb25zIHRocm91Z2ggbGVzc29uIHBsYW5zXG4gICAgY29uc3QgbGVzc29uUGxhbnNXaGVyZTogUHJpc21hLkVURk9MZXNzb25QbGFuV2hlcmVJbnB1dCA9IHtcbiAgICAgIHVzZXJJZCxcbiAgICB9O1xuXG4gICAgaWYgKHN0YXJ0RGF0ZSB8fCBlbmREYXRlKSB7XG4gICAgICBsZXNzb25QbGFuc1doZXJlLmRhdGUgPSB7fTtcbiAgICAgIGlmIChzdGFydERhdGUpIGxlc3NvblBsYW5zV2hlcmUuZGF0ZS5ndGUgPSBuZXcgRGF0ZShTdHJpbmcoc3RhcnREYXRlKSk7XG4gICAgICBpZiAoZW5kRGF0ZSkgbGVzc29uUGxhbnNXaGVyZS5kYXRlLmx0ZSA9IG5ldyBEYXRlKFN0cmluZyhlbmREYXRlKSk7XG4gICAgfVxuXG4gICAgY29uc3QgY292ZXJlZEV4cGVjdGF0aW9ucyA9IGF3YWl0IHByaXNtYS5lVEZPTGVzc29uUGxhbkV4cGVjdGF0aW9uLmZpbmRNYW55KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIGxlc3NvblBsYW46IGxlc3NvblBsYW5zV2hlcmUsXG4gICAgICAgIGV4cGVjdGF0aW9uOiBleHBlY3RhdGlvbnNXaGVyZSxcbiAgICAgIH0sXG4gICAgICBzZWxlY3Q6IHtcbiAgICAgICAgZXhwZWN0YXRpb25JZDogdHJ1ZSxcbiAgICAgICAgZXhwZWN0YXRpb246IHtcbiAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgY29kZTogdHJ1ZSxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiB0cnVlLFxuICAgICAgICAgICAgc3RyYW5kOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIGxlc3NvblBsYW46IHtcbiAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgdGl0bGU6IHRydWUsXG4gICAgICAgICAgICBkYXRlOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gQ2FsY3VsYXRlIGNvdmVyYWdlIHN0YXRpc3RpY3NcbiAgICBjb25zdCBjb3ZlcmVkSWRzID0gbmV3IFNldChjb3ZlcmVkRXhwZWN0YXRpb25zLm1hcCgoY2UpID0+IGNlLmV4cGVjdGF0aW9uSWQpKTtcbiAgICBjb25zdCBjb3ZlcmFnZSA9IHtcbiAgICAgIHRvdGFsOiBhbGxFeHBlY3RhdGlvbnMubGVuZ3RoLFxuICAgICAgY292ZXJlZDogY292ZXJlZElkcy5zaXplLFxuICAgICAgcGVyY2VudGFnZTpcbiAgICAgICAgYWxsRXhwZWN0YXRpb25zLmxlbmd0aCA+IDBcbiAgICAgICAgICA/IE1hdGgucm91bmQoKGNvdmVyZWRJZHMuc2l6ZSAvIGFsbEV4cGVjdGF0aW9ucy5sZW5ndGgpICogMTAwKVxuICAgICAgICAgIDogMCxcbiAgICAgIGJ5U3RyYW5kOiB7fSBhcyBSZWNvcmQ8c3RyaW5nLCB7IHRvdGFsOiBudW1iZXI7IGNvdmVyZWQ6IG51bWJlciB9PixcbiAgICAgIHVuY292ZXJlZDogYWxsRXhwZWN0YXRpb25zLmZpbHRlcigoZSkgPT4gIWNvdmVyZWRJZHMuaGFzKGUuaWQpKSxcbiAgICAgIGRldGFpbHM6IGNvdmVyZWRFeHBlY3RhdGlvbnMsXG4gICAgfTtcblxuICAgIC8vIENhbGN1bGF0ZSBjb3ZlcmFnZSBieSBzdHJhbmRcbiAgICBmb3IgKGNvbnN0IGV4cCBvZiBhbGxFeHBlY3RhdGlvbnMpIHtcbiAgICAgIGlmICghY292ZXJhZ2UuYnlTdHJhbmRbZXhwLnN0cmFuZF0pIHtcbiAgICAgICAgY292ZXJhZ2UuYnlTdHJhbmRbZXhwLnN0cmFuZF0gPSB7IHRvdGFsOiAwLCBjb3ZlcmVkOiAwIH07XG4gICAgICB9XG4gICAgICBjb3ZlcmFnZS5ieVN0cmFuZFtleHAuc3RyYW5kXS50b3RhbCsrO1xuICAgICAgaWYgKGNvdmVyZWRJZHMuaGFzKGV4cC5pZCkpIHtcbiAgICAgICAgY292ZXJhZ2UuYnlTdHJhbmRbZXhwLnN0cmFuZF0uY292ZXJlZCsrO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJlcy5qc29uKGNvdmVyYWdlKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgX25leHQoZXJyKTtcbiAgfVxufSk7XG5cbmV4cG9ydCBkZWZhdWx0IHJvdXRlcjtcbiJdLCJ2ZXJzaW9uIjozfQ==