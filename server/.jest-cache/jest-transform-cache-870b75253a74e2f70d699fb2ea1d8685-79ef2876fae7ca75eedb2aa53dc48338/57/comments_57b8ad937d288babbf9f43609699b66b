bb41f7d62389095b0ceeb627658b3423
/**
 * Plan Comments Routes
 * Handles commenting and feedback on shared plans
 */
import { Router } from 'express';
import { z } from 'zod';
import { authenticate } from '@/middleware/authenticate';
import { asyncHandler } from '@/middleware/errorHandler';
import logger from '@/logger';
// Validation schemas
const createCommentSchema = z.object({
    planType: z.enum(['long-range', 'unit', 'lesson', 'daybook']),
    planId: z.string(),
    content: z.string().min(1).max(5000),
    parentId: z.string().optional(),
});
const updateCommentSchema = z.object({
    content: z.string().min(1).max(5000).optional(),
    isResolved: z.boolean().optional(),
    isPinned: z.boolean().optional(),
});
export function commentRoutes(prisma) {
    const router = Router();
    // Apply authentication to all routes
    router.use(authenticate);
    // Helper function to check if user has access to comment on a plan
    async function checkCommentAccess(planType, planId, userId) {
        // Check if user owns the plan
        let isOwner = false;
        switch (planType) {
            case 'long-range':
                const lrPlan = await prisma.longRangePlan.findUnique({
                    where: { id: planId },
                });
                isOwner = lrPlan?.userId === userId;
                break;
            case 'unit':
                const unitPlan = await prisma.unitPlan.findUnique({
                    where: { id: planId },
                });
                isOwner = unitPlan?.userId === userId;
                break;
            case 'lesson':
                const lessonPlan = await prisma.eTFOLessonPlan.findUnique({
                    where: { id: planId },
                });
                isOwner = lessonPlan?.userId === userId;
                break;
            case 'daybook':
                const daybookEntry = await prisma.daybookEntry.findUnique({
                    where: { id: planId },
                });
                isOwner = daybookEntry?.userId === userId;
                break;
        }
        if (isOwner)
            return true;
        // Check if plan is shared with user and commenting is allowed
        const sharedPlan = await prisma.sharedPlan.findFirst({
            where: {
                planType,
                planId,
                OR: [
                    { sharedWithId: userId },
                    { teamId: { not: null } },
                ],
                canComment: true,
            },
        });
        if (sharedPlan) {
            // If shared with team, check team membership
            if (sharedPlan.teamId) {
                const isMember = await prisma.teamMember.findFirst({
                    where: { teamId: sharedPlan.teamId, userId },
                });
                return !!isMember;
            }
            return true;
        }
        return false;
    }
    // Get comments for a plan
    router.get('/', asyncHandler(async (req, res) => {
        const userId = req.user.id;
        const { planType, planId } = req.query;
        if (!planType || !planId) {
            return res.status(400).json({ error: 'planType and planId are required' });
        }
        // Check access
        const hasAccess = await checkCommentAccess(planType, planId, userId);
        if (!hasAccess) {
            return res.status(403).json({ error: 'Access denied' });
        }
        const comments = await prisma.planComment.findMany({
            where: {
                planType: planType,
                planId: planId,
                parentId: null, // Only get top-level comments
            },
            include: {
                user: {
                    select: { id: true, name: true, email: true },
                },
                replies: {
                    include: {
                        user: {
                            select: { id: true, name: true, email: true },
                        },
                    },
                    orderBy: { createdAt: 'asc' },
                },
            },
            orderBy: [
                { isPinned: 'desc' },
                { createdAt: 'desc' },
            ],
        });
        res.json(comments);
    }));
    // Create a comment
    router.post('/', asyncHandler(async (req, res) => {
        const userId = req.user.id;
        const { planType, planId, content, parentId } = createCommentSchema.parse(req.body);
        // Check access
        const hasAccess = await checkCommentAccess(planType, planId, userId);
        if (!hasAccess) {
            return res.status(403).json({ error: 'You do not have permission to comment on this plan' });
        }
        // If replying to a comment, verify parent exists
        if (parentId) {
            const parentComment = await prisma.planComment.findUnique({
                where: { id: parentId },
            });
            if (!parentComment || parentComment.planType !== planType || parentComment.planId !== planId) {
                return res.status(400).json({ error: 'Invalid parent comment' });
            }
        }
        const comment = await prisma.planComment.create({
            data: {
                planType,
                planId,
                userId,
                content,
                parentId,
            },
            include: {
                user: {
                    select: { id: true, name: true, email: true },
                },
            },
        });
        logger.info(`Comment created on ${planType}/${planId} by user ${userId}`);
        res.status(201).json(comment);
    }));
    // Update a comment
    router.patch('/:commentId', asyncHandler(async (req, res) => {
        const { commentId } = req.params;
        const userId = req.user.id;
        const updates = updateCommentSchema.parse(req.body);
        const comment = await prisma.planComment.findUnique({
            where: { id: commentId },
        });
        if (!comment) {
            return res.status(404).json({ error: 'Comment not found' });
        }
        // Check permissions
        const isAuthor = comment.userId === userId;
        const hasAccess = await checkCommentAccess(comment.planType, comment.planId, userId);
        if (!hasAccess) {
            return res.status(403).json({ error: 'Access denied' });
        }
        // Only author can edit content
        if (updates.content !== undefined && !isAuthor) {
            return res.status(403).json({ error: 'Only the comment author can edit the content' });
        }
        // Plan owner can pin/resolve comments
        const planOwnerChecks = {
            'long-range': async () => {
                const plan = await prisma.longRangePlan.findUnique({
                    where: { id: comment.planId },
                });
                return plan?.userId === userId;
            },
            'unit': async () => {
                const plan = await prisma.unitPlan.findUnique({
                    where: { id: comment.planId },
                });
                return plan?.userId === userId;
            },
            'lesson': async () => {
                const plan = await prisma.eTFOLessonPlan.findUnique({
                    where: { id: comment.planId },
                });
                return plan?.userId === userId;
            },
            'daybook': async () => {
                const plan = await prisma.daybookEntry.findUnique({
                    where: { id: comment.planId },
                });
                return plan?.userId === userId;
            },
        };
        const isPlanOwner = await planOwnerChecks[comment.planType]?.();
        if ((updates.isPinned !== undefined || updates.isResolved !== undefined) && !isPlanOwner) {
            return res.status(403).json({ error: 'Only the plan owner can pin or resolve comments' });
        }
        const updated = await prisma.planComment.update({
            where: { id: commentId },
            data: updates,
            include: {
                user: {
                    select: { id: true, name: true, email: true },
                },
            },
        });
        res.json(updated);
    }));
    // Delete a comment
    router.delete('/:commentId', asyncHandler(async (req, res) => {
        const { commentId } = req.params;
        const userId = req.user.id;
        const comment = await prisma.planComment.findUnique({
            where: { id: commentId },
            include: {
                _count: {
                    select: { replies: true },
                },
            },
        });
        if (!comment) {
            return res.status(404).json({ error: 'Comment not found' });
        }
        // Only author can delete their comment
        if (comment.userId !== userId) {
            return res.status(403).json({ error: 'Only the comment author can delete the comment' });
        }
        // Don't allow deletion if there are replies
        if (comment._count.replies > 0) {
            return res.status(400).json({ error: 'Cannot delete a comment with replies' });
        }
        await prisma.planComment.delete({
            where: { id: commentId },
        });
        logger.info(`Comment ${commentId} deleted by user ${userId}`);
        res.status(204).send();
    }));
    // Get comment statistics for a plan
    router.get('/stats', asyncHandler(async (req, res) => {
        const userId = req.user.id;
        const { planType, planId } = req.query;
        if (!planType || !planId) {
            return res.status(400).json({ error: 'planType and planId are required' });
        }
        // Check access
        const hasAccess = await checkCommentAccess(planType, planId, userId);
        if (!hasAccess) {
            return res.status(403).json({ error: 'Access denied' });
        }
        const [total, resolved, unresolved] = await Promise.all([
            prisma.planComment.count({
                where: {
                    planType: planType,
                    planId: planId,
                },
            }),
            prisma.planComment.count({
                where: {
                    planType: planType,
                    planId: planId,
                    isResolved: true,
                },
            }),
            prisma.planComment.count({
                where: {
                    planType: planType,
                    planId: planId,
                    isResolved: false,
                },
            }),
        ]);
        res.json({
            total,
            resolved,
            unresolved,
        });
    }));
    return router;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9yb3V0ZXMvY29tbWVudHMudHMiLCJtYXBwaW5ncyI6IkFBQUE7OztHQUdHO0FBRUgsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUVqQyxPQUFPLEVBQUUsQ0FBQyxFQUFFLE1BQU0sS0FBSyxDQUFDO0FBQ3hCLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDekQsT0FBTyxNQUFNLE1BQU0sVUFBVSxDQUFDO0FBRTlCLHFCQUFxQjtBQUNyQixNQUFNLG1CQUFtQixHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDbkMsUUFBUSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxZQUFZLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxTQUFTLENBQUMsQ0FBQztJQUM3RCxNQUFNLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRTtJQUNsQixPQUFPLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO0lBQ3BDLFFBQVEsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0NBQ2hDLENBQUMsQ0FBQztBQUVILE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUNuQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFO0lBQy9DLFVBQVUsRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsUUFBUSxFQUFFO0lBQ2xDLFFBQVEsRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsUUFBUSxFQUFFO0NBQ2pDLENBQUMsQ0FB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RSxDQUFDO1lBQ2YsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxlQUFlLEVBQUUsQ0FBQyxDQUFDO1FBQzFELENBQUM7UUFFRCxNQUFNLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxVQUFVLENBQUMsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUM7WUFDdEQsTUFBTSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUM7Z0JBQ3ZCLEtBQUssRUFBRTtvQkFDTCxRQUFRLEVBQUUsUUFBa0I7b0JBQzVCLE1BQU0sRUFBRSxNQUFnQjtpQkFDekI7YUFDRixDQUFDO1lBQ0YsTUFBTSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUM7Z0JBQ3ZCLEtBQUssRUFBRTtvQkFDTCxRQUFRLEVBQUUsUUFBa0I7b0JBQzVCLE1BQU0sRUFBRSxNQUFnQjtvQkFDeEIsVUFBVSxFQUFFLElBQUk7aUJBQ2pCO2FBQ0YsQ0FBQztZQUNGLE1BQU0sQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDO2dCQUN2QixLQUFLLEVBQUU7b0JBQ0wsUUFBUSxFQUFFLFFBQWtCO29CQUM1QixNQUFNLEVBQUUsTUFBZ0I7b0JBQ3hCLFVBQVUsRUFBRSxLQUFLO2lCQUNsQjthQUNGLENBQUM7U0FDSCxDQUFDLENBQUM7UUFFSCxHQUFHLENBQUMsSUFBSSxDQUFDO1lBQ1AsS0FBSztZQUNMLFFBQVE7WUFDUixVQUFVO1NBQ1gsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUVKLE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9yb3V0ZXMvY29tbWVudHMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBQbGFuIENvbW1lbnRzIFJvdXRlc1xuICogSGFuZGxlcyBjb21tZW50aW5nIGFuZCBmZWVkYmFjayBvbiBzaGFyZWQgcGxhbnNcbiAqL1xuXG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IFByaXNtYUNsaWVudCB9IGZyb20gJ0B0ZWFjaGluZy1lbmdpbmUvZGF0YWJhc2UnO1xuaW1wb3J0IHsgeiB9IGZyb20gJ3pvZCc7XG5pbXBvcnQgeyBhdXRoZW50aWNhdGUgfSBmcm9tICdAL21pZGRsZXdhcmUvYXV0aGVudGljYXRlJztcbmltcG9ydCB7IGFzeW5jSGFuZGxlciB9IGZyb20gJ0AvbWlkZGxld2FyZS9lcnJvckhhbmRsZXInO1xuaW1wb3J0IGxvZ2dlciBmcm9tICdAL2xvZ2dlcic7XG5cbi8vIFZhbGlkYXRpb24gc2NoZW1hc1xuY29uc3QgY3JlYXRlQ29tbWVudFNjaGVtYSA9IHoub2JqZWN0KHtcbiAgcGxhblR5cGU6IHouZW51bShbJ2xvbmctcmFuZ2UnLCAndW5pdCcsICdsZXNzb24nLCAnZGF5Ym9vayddKSxcbiAgcGxhbklkOiB6LnN0cmluZygpLFxuICBjb250ZW50OiB6LnN0cmluZygpLm1pbigxKS5tYXgoNTAwMCksXG4gIHBhcmVudElkOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG59KTtcblxuY29uc3QgdXBkYXRlQ29tbWVudFNjaGVtYSA9IHoub2JqZWN0KHtcbiAgY29udGVudDogei5zdHJpbmcoKS5taW4oMSkubWF4KDUwMDApLm9wdGlvbmFsKCksXG4gIGlzUmVzb2x2ZWQ6IHouYm9vbGVhbigpLm9wdGlvbmFsKCksXG4gIGlzUGlubmVkOiB6LmJvb2xlYW4oKS5vcHRpb25hbCgpLFxufSk7XG5cbmV4cG9ydCBmdW5jdGlvbiBjb21tZW50Um91dGVzKHByaXNtYTogUHJpc21hQ2xpZW50KTogUm91dGVyIHtcbiAgY29uc3Qgcm91dGVyID0gUm91dGVyKCk7XG5cbiAgLy8gQXBwbHkgYXV0aGVudGljYXRpb24gdG8gYWxsIHJvdXRlc1xuICByb3V0ZXIudXNlKGF1dGhlbnRpY2F0ZSk7XG5cbiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNoZWNrIGlmIHVzZXIgaGFzIGFjY2VzcyB0byBjb21tZW50IG9uIGEgcGxhblxuICBhc3luYyBmdW5jdGlvbiBjaGVja0NvbW1lbnRBY2Nlc3MocGxhblR5cGU6IHN0cmluZywgcGxhbklkOiBzdHJpbmcsIHVzZXJJZDogbnVtYmVyKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgLy8gQ2hlY2sgaWYgdXNlciBvd25zIHRoZSBwbGFuXG4gICAgbGV0IGlzT3duZXIgPSBmYWxzZTtcbiAgICBzd2l0Y2ggKHBsYW5UeXBlKSB7XG4gICAgICBjYXNlICdsb25nLXJhbmdlJzpcbiAgICAgICAgY29uc3QgbHJQbGFuID0gYXdhaXQgcHJpc21hLmxvbmdSYW5nZVBsYW4uZmluZFVuaXF1ZSh7XG4gICAgICAgICAgd2hlcmU6IHsgaWQ6IHBsYW5JZCB9LFxuICAgICAgICB9KTtcbiAgICAgICAgaXNPd25lciA9IGxyUGxhbj8udXNlcklkID09PSB1c2VySWQ7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlICd1bml0JzpcbiAgICAgICAgY29uc3QgdW5pdFBsYW4gPSBhd2FpdCBwcmlzbWEudW5pdFBsYW4uZmluZFVuaXF1ZSh7XG4gICAgICAgICAgd2hlcmU6IHsgaWQ6IHBsYW5JZCB9LFxuICAgICAgICB9KTtcbiAgICAgICAgaXNPd25lciA9IHVuaXRQbGFuPy51c2VySWQgPT09IHVzZXJJZDtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgJ2xlc3Nvbic6XG4gICAgICAgIGNvbnN0IGxlc3NvblBsYW4gPSBhd2FpdCBwcmlzbWEuZVRGT0xlc3NvblBsYW4uZmluZFVuaXF1ZSh7XG4gICAgICAgICAgd2hlcmU6IHsgaWQ6IHBsYW5JZCB9LFxuICAgICAgICB9KTtcbiAgICAgICAgaXNPd25lciA9IGxlc3NvblBsYW4/LnVzZXJJZCA9PT0gdXNlcklkO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAnZGF5Ym9vayc6XG4gICAgICAgIGNvbnN0IGRheWJvb2tFbnRyeSA9IGF3YWl0IHByaXNtYS5kYXlib29rRW50cnkuZmluZFVuaXF1ZSh7XG4gICAgICAgICAgd2hlcmU6IHsgaWQ6IHBsYW5JZCB9LFxuICAgICAgICB9KTtcbiAgICAgICAgaXNPd25lciA9IGRheWJvb2tFbnRyeT8udXNlcklkID09PSB1c2VySWQ7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIGlmIChpc093bmVyKSByZXR1cm4gdHJ1ZTtcblxuICAgIC8vIENoZWNrIGlmIHBsYW4gaXMgc2hhcmVkIHdpdGggdXNlciBhbmQgY29tbWVudGluZyBpcyBhbGxvd2VkXG4gICAgY29uc3Qgc2hhcmVkUGxhbiA9IGF3YWl0IHByaXNtYS5zaGFyZWRQbGFuLmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBwbGFuVHlwZSxcbiAgICAgICAgcGxhbklkLFxuICAgICAgICBPUjogW1xuICAgICAgICAgIHsgc2hhcmVkV2l0aElkOiB1c2VySWQgfSxcbiAgICAgICAgICB7IHRlYW1JZDogeyBub3Q6IG51bGwgfSB9LFxuICAgICAgICBdLFxuICAgICAgICBjYW5Db21tZW50OiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmIChzaGFyZWRQbGFuKSB7XG4gICAgICAvLyBJZiBzaGFyZWQgd2l0aCB0ZWFtLCBjaGVjayB0ZWFtIG1lbWJlcnNoaXBcbiAgICAgIGlmIChzaGFyZWRQbGFuLnRlYW1JZCkge1xuICAgICAgICBjb25zdCBpc01lbWJlciA9IGF3YWl0IHByaXNtYS50ZWFtTWVtYmVyLmZpbmRGaXJzdCh7XG4gICAgICAgICAgd2hlcmU6IHsgdGVhbUlkOiBzaGFyZWRQbGFuLnRlYW1JZCwgdXNlcklkIH0sXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gISFpc01lbWJlcjtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIC8vIEdldCBjb21tZW50cyBmb3IgYSBwbGFuXG4gIHJvdXRlci5nZXQoJy8nLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLmlkO1xuICAgIGNvbnN0IHsgcGxhblR5cGUsIHBsYW5JZCB9ID0gcmVxLnF1ZXJ5O1xuXG4gICAgaWYgKCFwbGFuVHlwZSB8fCAhcGxhbklkKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ3BsYW5UeXBlIGFuZCBwbGFuSWQgYXJlIHJlcXVpcmVkJyB9KTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBhY2Nlc3NcbiAgICBjb25zdCBoYXNBY2Nlc3MgPSBhd2FpdCBjaGVja0NvbW1lbnRBY2Nlc3MocGxhblR5cGUgYXMgc3RyaW5nLCBwbGFuSWQgYXMgc3RyaW5nLCB1c2VySWQpO1xuICAgIGlmICghaGFzQWNjZXNzKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ0FjY2VzcyBkZW5pZWQnIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGNvbW1lbnRzID0gYXdhaXQgcHJpc21hLnBsYW5Db21tZW50LmZpbmRNYW55KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIHBsYW5UeXBlOiBwbGFuVHlwZSBhcyBzdHJpbmcsXG4gICAgICAgIHBsYW5JZDogcGxhbklkIGFzIHN0cmluZyxcbiAgICAgICAgcGFyZW50SWQ6IG51bGwsIC8vIE9ubHkgZ2V0IHRvcC1sZXZlbCBjb21tZW50c1xuICAgICAgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgdXNlcjoge1xuICAgICAgICAgIHNlbGVjdDogeyBpZDogdHJ1ZSwgbmFtZTogdHJ1ZSwgZW1haWw6IHRydWUgfSxcbiAgICAgICAgfSxcbiAgICAgICAgcmVwbGllczoge1xuICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlLCBuYW1lOiB0cnVlLCBlbWFpbDogdHJ1ZSB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIG9yZGVyQnk6IHsgY3JlYXRlZEF0OiAnYXNjJyB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIG9yZGVyQnk6IFtcbiAgICAgICAgeyBpc1Bpbm5lZDogJ2Rlc2MnIH0sXG4gICAgICAgIHsgY3JlYXRlZEF0OiAnZGVzYycgfSxcbiAgICAgIF0sXG4gICAgfSk7XG5cbiAgICByZXMuanNvbihjb21tZW50cyk7XG4gIH0pKTtcblxuICAvLyBDcmVhdGUgYSBjb21tZW50XG4gIHJvdXRlci5wb3N0KCcvJywgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyIS5pZDtcbiAgICBjb25zdCB7IHBsYW5UeXBlLCBwbGFuSWQsIGNvbnRlbnQsIHBhcmVudElkIH0gPSBjcmVhdGVDb21tZW50U2NoZW1hLnBhcnNlKHJlcS5ib2R5KTtcblxuICAgIC8vIENoZWNrIGFjY2Vzc1xuICAgIGNvbnN0IGhhc0FjY2VzcyA9IGF3YWl0IGNoZWNrQ29tbWVudEFjY2VzcyhwbGFuVHlwZSwgcGxhbklkLCB1c2VySWQpO1xuICAgIGlmICghaGFzQWNjZXNzKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ1lvdSBkbyBub3QgaGF2ZSBwZXJtaXNzaW9uIHRvIGNvbW1lbnQgb24gdGhpcyBwbGFuJyB9KTtcbiAgICB9XG5cbiAgICAvLyBJZiByZXBseWluZyB0byBhIGNvbW1lbnQsIHZlcmlmeSBwYXJlbnQgZXhpc3RzXG4gICAgaWYgKHBhcmVudElkKSB7XG4gICAgICBjb25zdCBwYXJlbnRDb21tZW50ID0gYXdhaXQgcHJpc21hLnBsYW5Db21tZW50LmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyBpZDogcGFyZW50SWQgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIXBhcmVudENvbW1lbnQgfHwgcGFyZW50Q29tbWVudC5wbGFuVHlwZSAhPT0gcGxhblR5cGUgfHwgcGFyZW50Q29tbWVudC5wbGFuSWQgIT09IHBsYW5JZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ0ludmFsaWQgcGFyZW50IGNvbW1lbnQnIH0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IGNvbW1lbnQgPSBhd2FpdCBwcmlzbWEucGxhbkNvbW1lbnQuY3JlYXRlKHtcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgcGxhblR5cGUsXG4gICAgICAgIHBsYW5JZCxcbiAgICAgICAgdXNlcklkLFxuICAgICAgICBjb250ZW50LFxuICAgICAgICBwYXJlbnRJZCxcbiAgICAgIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHVzZXI6IHtcbiAgICAgICAgICBzZWxlY3Q6IHsgaWQ6IHRydWUsIG5hbWU6IHRydWUsIGVtYWlsOiB0cnVlIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgbG9nZ2VyLmluZm8oYENvbW1lbnQgY3JlYXRlZCBvbiAke3BsYW5UeXBlfS8ke3BsYW5JZH0gYnkgdXNlciAke3VzZXJJZH1gKTtcbiAgICByZXMuc3RhdHVzKDIwMSkuanNvbihjb21tZW50KTtcbiAgfSkpO1xuXG4gIC8vIFVwZGF0ZSBhIGNvbW1lbnRcbiAgcm91dGVyLnBhdGNoKCcvOmNvbW1lbnRJZCcsIGFzeW5jSGFuZGxlcihhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICBjb25zdCB7IGNvbW1lbnRJZCB9ID0gcmVxLnBhcmFtcztcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuaWQ7XG4gICAgY29uc3QgdXBkYXRlcyA9IHVwZGF0ZUNvbW1lbnRTY2hlbWEucGFyc2UocmVxLmJvZHkpO1xuXG4gICAgY29uc3QgY29tbWVudCA9IGF3YWl0IHByaXNtYS5wbGFuQ29tbWVudC5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiBjb21tZW50SWQgfSxcbiAgICB9KTtcblxuICAgIGlmICghY29tbWVudCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgZXJyb3I6ICdDb21tZW50IG5vdCBmb3VuZCcgfSk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgcGVybWlzc2lvbnNcbiAgICBjb25zdCBpc0F1dGhvciA9IGNvbW1lbnQudXNlcklkID09PSB1c2VySWQ7XG4gICAgY29uc3QgaGFzQWNjZXNzID0gYXdhaXQgY2hlY2tDb21tZW50QWNjZXNzKGNvbW1lbnQucGxhblR5cGUsIGNvbW1lbnQucGxhbklkLCB1c2VySWQpO1xuXG4gICAgaWYgKCFoYXNBY2Nlc3MpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnQWNjZXNzIGRlbmllZCcgfSk7XG4gICAgfVxuXG4gICAgLy8gT25seSBhdXRob3IgY2FuIGVkaXQgY29udGVudFxuICAgIGlmICh1cGRhdGVzLmNvbnRlbnQgIT09IHVuZGVmaW5lZCAmJiAhaXNBdXRob3IpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnT25seSB0aGUgY29tbWVudCBhdXRob3IgY2FuIGVkaXQgdGhlIGNvbnRlbnQnIH0pO1xuICAgIH1cblxuICAgIC8vIFBsYW4gb3duZXIgY2FuIHBpbi9yZXNvbHZlIGNvbW1lbnRzXG4gICAgY29uc3QgcGxhbk93bmVyQ2hlY2tzOiBSZWNvcmQ8c3RyaW5nLCAoKSA9PiBQcm9taXNlPGJvb2xlYW4+PiA9IHtcbiAgICAgICdsb25nLXJhbmdlJzogYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBwbGFuID0gYXdhaXQgcHJpc21hLmxvbmdSYW5nZVBsYW4uZmluZFVuaXF1ZSh7XG4gICAgICAgICAgd2hlcmU6IHsgaWQ6IGNvbW1lbnQucGxhbklkIH0sXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gcGxhbj8udXNlcklkID09PSB1c2VySWQ7XG4gICAgICB9LFxuICAgICAgJ3VuaXQnOiBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHBsYW4gPSBhd2FpdCBwcmlzbWEudW5pdFBsYW4uZmluZFVuaXF1ZSh7XG4gICAgICAgICAgd2hlcmU6IHsgaWQ6IGNvbW1lbnQucGxhbklkIH0sXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gcGxhbj8udXNlcklkID09PSB1c2VySWQ7XG4gICAgICB9LFxuICAgICAgJ2xlc3Nvbic6IGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgcGxhbiA9IGF3YWl0IHByaXNtYS5lVEZPTGVzc29uUGxhbi5maW5kVW5pcXVlKHtcbiAgICAgICAgICB3aGVyZTogeyBpZDogY29tbWVudC5wbGFuSWQgfSxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBwbGFuPy51c2VySWQgPT09IHVzZXJJZDtcbiAgICAgIH0sXG4gICAgICAnZGF5Ym9vayc6IGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgcGxhbiA9IGF3YWl0IHByaXNtYS5kYXlib29rRW50cnkuZmluZFVuaXF1ZSh7XG4gICAgICAgICAgd2hlcmU6IHsgaWQ6IGNvbW1lbnQucGxhbklkIH0sXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gcGxhbj8udXNlcklkID09PSB1c2VySWQ7XG4gICAgICB9LFxuICAgIH07XG5cbiAgICBjb25zdCBpc1BsYW5Pd25lciA9IGF3YWl0IHBsYW5Pd25lckNoZWNrc1tjb21tZW50LnBsYW5UeXBlXT8uKCk7XG5cbiAgICBpZiAoKHVwZGF0ZXMuaXNQaW5uZWQgIT09IHVuZGVmaW5lZCB8fCB1cGRhdGVzLmlzUmVzb2x2ZWQgIT09IHVuZGVmaW5lZCkgJiYgIWlzUGxhbk93bmVyKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ09ubHkgdGhlIHBsYW4gb3duZXIgY2FuIHBpbiBvciByZXNvbHZlIGNvbW1lbnRzJyB9KTtcbiAgICB9XG5cbiAgICBjb25zdCB1cGRhdGVkID0gYXdhaXQgcHJpc21hLnBsYW5Db21tZW50LnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyBpZDogY29tbWVudElkIH0sXG4gICAgICBkYXRhOiB1cGRhdGVzLFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlLCBuYW1lOiB0cnVlLCBlbWFpbDogdHJ1ZSB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHJlcy5qc29uKHVwZGF0ZWQpO1xuICB9KSk7XG5cbiAgLy8gRGVsZXRlIGEgY29tbWVudFxuICByb3V0ZXIuZGVsZXRlKCcvOmNvbW1lbnRJZCcsIGFzeW5jSGFuZGxlcihhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICBjb25zdCB7IGNvbW1lbnRJZCB9ID0gcmVxLnBhcmFtcztcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuaWQ7XG5cbiAgICBjb25zdCBjb21tZW50ID0gYXdhaXQgcHJpc21hLnBsYW5Db21tZW50LmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IGNvbW1lbnRJZCB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBfY291bnQ6IHtcbiAgICAgICAgICBzZWxlY3Q6IHsgcmVwbGllczogdHJ1ZSB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghY29tbWVudCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgZXJyb3I6ICdDb21tZW50IG5vdCBmb3VuZCcgfSk7XG4gICAgfVxuXG4gICAgLy8gT25seSBhdXRob3IgY2FuIGRlbGV0ZSB0aGVpciBjb21tZW50XG4gICAgaWYgKGNvbW1lbnQudXNlcklkICE9PSB1c2VySWQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnT25seSB0aGUgY29tbWVudCBhdXRob3IgY2FuIGRlbGV0ZSB0aGUgY29tbWVudCcgfSk7XG4gICAgfVxuXG4gICAgLy8gRG9uJ3QgYWxsb3cgZGVsZXRpb24gaWYgdGhlcmUgYXJlIHJlcGxpZXNcbiAgICBpZiAoY29tbWVudC5fY291bnQucmVwbGllcyA+IDApIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiAnQ2Fubm90IGRlbGV0ZSBhIGNvbW1lbnQgd2l0aCByZXBsaWVzJyB9KTtcbiAgICB9XG5cbiAgICBhd2FpdCBwcmlzbWEucGxhbkNvbW1lbnQuZGVsZXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiBjb21tZW50SWQgfSxcbiAgICB9KTtcblxuICAgIGxvZ2dlci5pbmZvKGBDb21tZW50ICR7Y29tbWVudElkfSBkZWxldGVkIGJ5IHVzZXIgJHt1c2VySWR9YCk7XG4gICAgcmVzLnN0YXR1cygyMDQpLnNlbmQoKTtcbiAgfSkpO1xuXG4gIC8vIEdldCBjb21tZW50IHN0YXRpc3RpY3MgZm9yIGEgcGxhblxuICByb3V0ZXIuZ2V0KCcvc3RhdHMnLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLmlkO1xuICAgIGNvbnN0IHsgcGxhblR5cGUsIHBsYW5JZCB9ID0gcmVxLnF1ZXJ5O1xuXG4gICAgaWYgKCFwbGFuVHlwZSB8fCAhcGxhbklkKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ3BsYW5UeXBlIGFuZCBwbGFuSWQgYXJlIHJlcXVpcmVkJyB9KTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBhY2Nlc3NcbiAgICBjb25zdCBoYXNBY2Nlc3MgPSBhd2FpdCBjaGVja0NvbW1lbnRBY2Nlc3MocGxhblR5cGUgYXMgc3RyaW5nLCBwbGFuSWQgYXMgc3RyaW5nLCB1c2VySWQpO1xuICAgIGlmICghaGFzQWNjZXNzKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ0FjY2VzcyBkZW5pZWQnIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IFt0b3RhbCwgcmVzb2x2ZWQsIHVucmVzb2x2ZWRdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgcHJpc21hLnBsYW5Db21tZW50LmNvdW50KHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICBwbGFuVHlwZTogcGxhblR5cGUgYXMgc3RyaW5nLFxuICAgICAgICAgIHBsYW5JZDogcGxhbklkIGFzIHN0cmluZyxcbiAgICAgICAgfSxcbiAgICAgIH0pLFxuICAgICAgcHJpc21hLnBsYW5Db21tZW50LmNvdW50KHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICBwbGFuVHlwZTogcGxhblR5cGUgYXMgc3RyaW5nLFxuICAgICAgICAgIHBsYW5JZDogcGxhbklkIGFzIHN0cmluZyxcbiAgICAgICAgICBpc1Jlc29sdmVkOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgICBwcmlzbWEucGxhbkNvbW1lbnQuY291bnQoe1xuICAgICAgICB3aGVyZToge1xuICAgICAgICAgIHBsYW5UeXBlOiBwbGFuVHlwZSBhcyBzdHJpbmcsXG4gICAgICAgICAgcGxhbklkOiBwbGFuSWQgYXMgc3RyaW5nLFxuICAgICAgICAgIGlzUmVzb2x2ZWQ6IGZhbHNlLFxuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgXSk7XG5cbiAgICByZXMuanNvbih7XG4gICAgICB0b3RhbCxcbiAgICAgIHJlc29sdmVkLFxuICAgICAgdW5yZXNvbHZlZCxcbiAgICB9KTtcbiAgfSkpO1xuXG4gIHJldHVybiByb3V0ZXI7XG59Il0sInZlcnNpb24iOjN9