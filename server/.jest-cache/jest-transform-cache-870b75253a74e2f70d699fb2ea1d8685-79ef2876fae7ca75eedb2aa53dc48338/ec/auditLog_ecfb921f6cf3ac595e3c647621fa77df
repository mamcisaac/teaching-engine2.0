11d82e90f8feadebc24b39f9db7463e1
import logger from '../logger';
export function createAuditLog(options) {
    return async (req, res, next) => {
        const startTime = Date.now();
        const auditEntry = {
            action: options.action,
            resourceType: options.resourceType,
            resourceId: req.params.id || req.params.studentId || null,
            userId: req.user?.id || null,
            ipAddress: req.ip || req.connection.remoteAddress || 'unknown',
            userAgent: req.headers['user-agent'] || 'unknown',
            method: req.method,
            path: req.path,
            timestamp: new Date(),
            requestBody: options.includeRequestBody && !options.sensitiveData ? req.body : undefined,
            responseStatus: 0,
            duration: 0,
        };
        // Log response when it's sent
        const originalSend = res.send;
        res.send = function (data) {
            auditEntry.responseStatus = res.statusCode;
            auditEntry.duration = Date.now() - startTime;
            // Log to database asynchronously
            if (options.sensitiveData || auditEntry.responseStatus < 400) {
                logAuditEntry(auditEntry).catch(error => {
                    logger.error({ error, auditEntry }, 'Failed to create audit log entry');
                });
            }
            return originalSend.call(this, data);
        };
        next();
    };
}
async function logAuditEntry(entry) {
    try {
        // AuditLog model archived - audit logging disabled in ETFO migration
        console.log('Audit log entry (model archived):', {
            action: entry.action,
            resourceType: entry.resourceType,
            resourceId: entry.resourceId,
            userId: entry.userId,
            ipAddress: entry.ipAddress,
            userAgent: entry.userAgent,
            method: entry.method,
            path: entry.path,
            requestBody: entry.requestBody ? '[LOGGED TO CONSOLE ONLY]' : null,
            responseStatus: entry.responseStatus,
            duration: entry.duration,
            timestamp: entry.timestamp,
        });
    }
    catch (error) {
        // If audit log table doesn't exist, just log to console
        logger.warn({ entry }, 'Audit log entry (table may not exist)');
    }
}
// Pre-configured audit loggers for different operations
export const auditLoggers = {
    // Student data access
    studentView: createAuditLog({
        action: 'VIEW_STUDENT',
        resourceType: 'student',
        sensitiveData: true,
    }),
    studentCreate: createAuditLog({
        action: 'CREATE_STUDENT',
        resourceType: 'student',
        sensitiveData: true,
        includeRequestBody: true,
    }),
    studentUpdate: createAuditLog({
        action: 'UPDATE_STUDENT',
        resourceType: 'student',
        sensitiveData: true,
        includeRequestBody: true,
    }),
    studentDelete: createAuditLog({
        action: 'DELETE_STUDENT',
        resourceType: 'student',
        sensitiveData: true,
    }),
    // Parent communication
    parentSummaryView: createAuditLog({
        action: 'VIEW_PARENT_SUMMARY',
        resourceType: 'parent_summary',
        sensitiveData: true,
    }),
    parentSummaryCreate: createAuditLog({
        action: 'CREATE_PARENT_SUMMARY',
        resourceType: 'parent_summary',
        sensitiveData: true,
    }),
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9taWRkbGV3YXJlL2F1ZGl0TG9nLnRzIiwibWFwcGluZ3MiOiJBQUNBLE9BQU8sTUFBTSxNQUFNLFdBQVcsQ0FBQztBQVcvQixNQUFNLFVBQVUsY0FBYyxDQUFDLE9BQXdCO0lBQ3JELE9BQU8sS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBa0IsRUFBRSxFQUFFO1FBQy9ELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUM3QixNQUFNLFVBQVUsR0FBRztZQUNqQixNQUFNLEVBQUUsT0FBTyxDQUFDLE1BQU07WUFDdEIsWUFBWSxFQUFFLE9BQU8sQ0FBQyxZQUFZO1lBQ2xDLFVBQVUsRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLFNBQVMsSUFBSSxJQUFJO1lBQ3pELE1BQU0sRUFBRSxHQUFHLENBQUMsSUFBSSxFQUFFLEVBQUUsSUFBSSxJQUFJO1lBQzVCLFNBQVMsRUFBRSxHQUFHLENBQUMsRUFBRSxJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUMsYUFBYSxJQUFJLFNBQVM7WUFDOUQsU0FBUyxFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUksU0FBUztZQUNqRCxNQUFNLEVBQUUsR0FBRyxDQUFDLE1BQU07WUFDbEIsSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJO1lBQ2QsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO1lBQ3JCLFdBQVcsRUFBRSxPQUFPLENBQUMsa0JBQWtCLElBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxTQUFTO1lBQ3hGLGNBQWMsRUFBRSxDQUFDO1lBQ2pCLFFBQVEsRUFBRSxDQUFDO1NBQ1osQ0FBQztRQUVGLDhCQUE4QjtRQUM5QixNQUFNLFlBQVksR0FBRyxHQUFH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RixtQkFBbUIsRUFBRSxjQUFjLENBQUM7UUFDbEMsTUFBTSxFQUFFLHVCQUF1QjtRQUMvQixZQUFZLEVBQUUsZ0JBQWdCO1FBQzlCLGFBQWEsRUFBRSxJQUFJO0tBQ3BCLENBQUM7Q0FDSCxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9taWNoYWVsbWNpc2FhYy9HaXRIdWIvdGVhY2hpbmctZW5naW5lMi4wL3NlcnZlci9zcmMvbWlkZGxld2FyZS9hdWRpdExvZy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSwgTmV4dEZ1bmN0aW9uIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4uL2xvZ2dlcic7XG5cblxuaW50ZXJmYWNlIEF1ZGl0TG9nT3B0aW9ucyB7XG4gIGFjdGlvbjogc3RyaW5nO1xuICByZXNvdXJjZVR5cGU6ICdzdHVkZW50JyB8ICdwYXJlbnRfc3VtbWFyeScgfCAnbGVzc29uX3BsYW4nIHwgJ3VuaXRfcGxhbicgfCAnY3VycmljdWx1bScgfCAndXNlcic7XG4gIHNlbnNpdGl2ZURhdGE/OiBib29sZWFuO1xuICBpbmNsdWRlUmVxdWVzdEJvZHk/OiBib29sZWFuO1xuICBpbmNsdWRlUmVzcG9uc2VTdGF0dXM/OiBib29sZWFuO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlQXVkaXRMb2cob3B0aW9uczogQXVkaXRMb2dPcHRpb25zKSB7XG4gIHJldHVybiBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIGNvbnN0IGF1ZGl0RW50cnkgPSB7XG4gICAgICBhY3Rpb246IG9wdGlvbnMuYWN0aW9uLFxuICAgICAgcmVzb3VyY2VUeXBlOiBvcHRpb25zLnJlc291cmNlVHlwZSxcbiAgICAgIHJlc291cmNlSWQ6IHJlcS5wYXJhbXMuaWQgfHwgcmVxLnBhcmFtcy5zdHVkZW50SWQgfHwgbnVsbCxcbiAgICAgIHVzZXJJZDogcmVxLnVzZXI/LmlkIHx8IG51bGwsXG4gICAgICBpcEFkZHJlc3M6IHJlcS5pcCB8fCByZXEuY29ubmVjdGlvbi5yZW1vdGVBZGRyZXNzIHx8ICd1bmtub3duJyxcbiAgICAgIHVzZXJBZ2VudDogcmVxLmhlYWRlcnNbJ3VzZXItYWdlbnQnXSB8fCAndW5rbm93bicsXG4gICAgICBtZXRob2Q6IHJlcS5tZXRob2QsXG4gICAgICBwYXRoOiByZXEucGF0aCxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgIHJlcXVlc3RCb2R5OiBvcHRpb25zLmluY2x1ZGVSZXF1ZXN0Qm9keSAmJiAhb3B0aW9ucy5zZW5zaXRpdmVEYXRhID8gcmVxLmJvZHkgOiB1bmRlZmluZWQsXG4gICAgICByZXNwb25zZVN0YXR1czogMCxcbiAgICAgIGR1cmF0aW9uOiAwLFxuICAgIH07XG5cbiAgICAvLyBMb2cgcmVzcG9uc2Ugd2hlbiBpdCdzIHNlbnRcbiAgICBjb25zdCBvcmlnaW5hbFNlbmQgPSByZXMuc2VuZDtcbiAgICByZXMuc2VuZCA9IGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgIGF1ZGl0RW50cnkucmVzcG9uc2VTdGF0dXMgPSByZXMuc3RhdHVzQ29kZTtcbiAgICAgIGF1ZGl0RW50cnkuZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xuXG4gICAgICAvLyBMb2cgdG8gZGF0YWJhc2UgYXN5bmNocm9ub3VzbHlcbiAgICAgIGlmIChvcHRpb25zLnNlbnNpdGl2ZURhdGEgfHwgYXVkaXRFbnRyeS5yZXNwb25zZVN0YXR1cyA8IDQwMCkge1xuICAgICAgICBsb2dBdWRpdEVudHJ5KGF1ZGl0RW50cnkpLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoeyBlcnJvciwgYXVkaXRFbnRyeSB9LCAnRmFpbGVkIHRvIGNyZWF0ZSBhdWRpdCBsb2cgZW50cnknKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBvcmlnaW5hbFNlbmQuY2FsbCh0aGlzLCBkYXRhKTtcbiAgICB9O1xuXG4gICAgbmV4dCgpO1xuICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBsb2dBdWRpdEVudHJ5KGVudHJ5OiB7XG4gIGFjdGlvbjogc3RyaW5nO1xuICByZXNvdXJjZVR5cGU6IHN0cmluZztcbiAgcmVzb3VyY2VJZDogc3RyaW5nIHwgbnVsbDtcbiAgdXNlcklkOiBudW1iZXIgfCBudWxsO1xuICBpcEFkZHJlc3M6IHN0cmluZztcbiAgdXNlckFnZW50OiBzdHJpbmc7XG4gIG1ldGhvZDogc3RyaW5nO1xuICBwYXRoOiBzdHJpbmc7XG4gIHRpbWVzdGFtcDogRGF0ZTtcbiAgcmVxdWVzdEJvZHk/OiB1bmtub3duO1xuICByZXNwb25zZVN0YXR1czogbnVtYmVyO1xuICBkdXJhdGlvbjogbnVtYmVyO1xufSkge1xuICB0cnkge1xuICAgIC8vIEF1ZGl0TG9nIG1vZGVsIGFyY2hpdmVkIC0gYXVkaXQgbG9nZ2luZyBkaXNhYmxlZCBpbiBFVEZPIG1pZ3JhdGlvblxuICAgIGNvbnNvbGUubG9nKCdBdWRpdCBsb2cgZW50cnkgKG1vZGVsIGFyY2hpdmVkKTonLCB7XG4gICAgICBhY3Rpb246IGVudHJ5LmFjdGlvbixcbiAgICAgIHJlc291cmNlVHlwZTogZW50cnkucmVzb3VyY2VUeXBlLFxuICAgICAgcmVzb3VyY2VJZDogZW50cnkucmVzb3VyY2VJZCxcbiAgICAgIHVzZXJJZDogZW50cnkudXNlcklkLFxuICAgICAgaXBBZGRyZXNzOiBlbnRyeS5pcEFkZHJlc3MsXG4gICAgICB1c2VyQWdlbnQ6IGVudHJ5LnVzZXJBZ2VudCxcbiAgICAgIG1ldGhvZDogZW50cnkubWV0aG9kLFxuICAgICAgcGF0aDogZW50cnkucGF0aCxcbiAgICAgIHJlcXVlc3RCb2R5OiBlbnRyeS5yZXF1ZXN0Qm9keSA/ICdbTE9HR0VEIFRPIENPTlNPTEUgT05MWV0nIDogbnVsbCxcbiAgICAgIHJlc3BvbnNlU3RhdHVzOiBlbnRyeS5yZXNwb25zZVN0YXR1cyxcbiAgICAgIGR1cmF0aW9uOiBlbnRyeS5kdXJhdGlvbixcbiAgICAgIHRpbWVzdGFtcDogZW50cnkudGltZXN0YW1wLFxuICAgIH0pO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIC8vIElmIGF1ZGl0IGxvZyB0YWJsZSBkb2Vzbid0IGV4aXN0LCBqdXN0IGxvZyB0byBjb25zb2xlXG4gICAgbG9nZ2VyLndhcm4oeyBlbnRyeSB9LCAnQXVkaXQgbG9nIGVudHJ5ICh0YWJsZSBtYXkgbm90IGV4aXN0KScpO1xuICB9XG59XG5cbi8vIFByZS1jb25maWd1cmVkIGF1ZGl0IGxvZ2dlcnMgZm9yIGRpZmZlcmVudCBvcGVyYXRpb25zXG5leHBvcnQgY29uc3QgYXVkaXRMb2dnZXJzID0ge1xuICAvLyBTdHVkZW50IGRhdGEgYWNjZXNzXG4gIHN0dWRlbnRWaWV3OiBjcmVhdGVBdWRpdExvZyh7XG4gICAgYWN0aW9uOiAnVklFV19TVFVERU5UJyxcbiAgICByZXNvdXJjZVR5cGU6ICdzdHVkZW50JyxcbiAgICBzZW5zaXRpdmVEYXRhOiB0cnVlLFxuICB9KSxcbiAgXG4gIHN0dWRlbnRDcmVhdGU6IGNyZWF0ZUF1ZGl0TG9nKHtcbiAgICBhY3Rpb246ICdDUkVBVEVfU1RVREVOVCcsXG4gICAgcmVzb3VyY2VUeXBlOiAnc3R1ZGVudCcsXG4gICAgc2Vuc2l0aXZlRGF0YTogdHJ1ZSxcbiAgICBpbmNsdWRlUmVxdWVzdEJvZHk6IHRydWUsXG4gIH0pLFxuICBcbiAgc3R1ZGVudFVwZGF0ZTogY3JlYXRlQXVkaXRMb2coe1xuICAgIGFjdGlvbjogJ1VQREFURV9TVFVERU5UJyxcbiAgICByZXNvdXJjZVR5cGU6ICdzdHVkZW50JyxcbiAgICBzZW5zaXRpdmVEYXRhOiB0cnVlLFxuICAgIGluY2x1ZGVSZXF1ZXN0Qm9keTogdHJ1ZSxcbiAgfSksXG4gIFxuICBzdHVkZW50RGVsZXRlOiBjcmVhdGVBdWRpdExvZyh7XG4gICAgYWN0aW9uOiAnREVMRVRFX1NUVURFTlQnLFxuICAgIHJlc291cmNlVHlwZTogJ3N0dWRlbnQnLFxuICAgIHNlbnNpdGl2ZURhdGE6IHRydWUsXG4gIH0pLFxuICBcbiAgLy8gUGFyZW50IGNvbW11bmljYXRpb25cbiAgcGFyZW50U3VtbWFyeVZpZXc6IGNyZWF0ZUF1ZGl0TG9nKHtcbiAgICBhY3Rpb246ICdWSUVXX1BBUkVOVF9TVU1NQVJZJyxcbiAgICByZXNvdXJjZVR5cGU6ICdwYXJlbnRfc3VtbWFyeScsXG4gICAgc2Vuc2l0aXZlRGF0YTogdHJ1ZSxcbiAgfSksXG4gIFxuICBwYXJlbnRTdW1tYXJ5Q3JlYXRlOiBjcmVhdGVBdWRpdExvZyh7XG4gICAgYWN0aW9uOiAnQ1JFQVRFX1BBUkVOVF9TVU1NQVJZJyxcbiAgICByZXNvdXJjZVR5cGU6ICdwYXJlbnRfc3VtbWFyeScsXG4gICAgc2Vuc2l0aXZlRGF0YTogdHJ1ZSxcbiAgfSksXG59OyJdLCJ2ZXJzaW9uIjozfQ==