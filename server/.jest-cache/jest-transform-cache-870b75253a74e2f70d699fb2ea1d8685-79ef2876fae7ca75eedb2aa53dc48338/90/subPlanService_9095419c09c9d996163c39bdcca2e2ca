55d63147eaefe06f97bedda574f3259a
import { prisma } from '../prisma';
import PDFDocument from 'pdfkit';
import { generateSubPlanPDF } from './subPlanGenerator';
function minToTime(min) {
    const h = String(Math.floor(min / 60)).padStart(2, '0');
    const m = String(min % 60).padStart(2, '0');
    return `${h}:${m}`;
}
export async function buildSubPlanData(date, options = {}) {
    const dayStart = new Date(date);
    dayStart.setUTCHours(0, 0, 0, 0);
    const dayEnd = new Date(dayStart);
    dayEnd.setUTCDate(dayStart.getUTCDate() + 1);
    const { includeGoals = true, includeRoutines = true, includePlans = true, anonymize = false, userId = 1, } = options;
    const [plan, events, blocks, prefs, routines, studentGoals] = await Promise.all([
        // DISABLED: Legacy dailyPlan model removed in ETFO migration
        includePlans ? Promise.resolve(null) : Promise.resolve(null), // Legacy dailyPlan query disabled
        prisma.calendarEvent.findMany({
            where: { start: { lte: dayEnd }, end: { gte: dayStart } },
        }),
        prisma.unavailableBlock.findMany({ where: { date: dayStart } }),
        null, // teacherPreferences archived - preferences now in User and ClassRoutine
        includeRoutines
            ? prisma.classRoutine.findMany({
                where: { userId, isActive: true },
                orderBy: [{ priority: 'desc' }, { category: 'asc' }],
            })
            : [],
        includeGoals
            ? prisma.studentGoal.findMany({
                where: {
                    status: 'active',
                    student: { userId },
                },
                include: {
                    student: true,
                },
                take: 10, // Limit to most relevant goals
            })
            : [],
    ]);
    const schedule = [];
    if (plan) {
        for (const item of plan.items) {
            const _subjectId = item.slot?.subjectId ?? item.activity?.milestone.subjectId;
            // DISABLED: Legacy activity model removed in ETFO migration
            // const act = null; // Legacy activity queries disabled
            const act = null;
            schedule.push({ time: minToTime(item.startMin), activity: act?.title ?? '' });
        }
    }
    events.forEach((e) => schedule.push({
        time: minToTime(new Date(e.start).getUTCHours() * 60 + new Date(e.start).getUTCMinutes()),
        note: e.title,
    }));
    blocks
        .filter((b) => b.blockType === 'TEACHER_ABSENCE')
        .forEach((b) => schedule.push({ time: minToTime(b.startMin), note: b.reason }));
    schedule.sort((a, b) => a.time.localeCompare(b.time));
    const pullOuts = blocks
        .filter((b) => b.blockType === 'STUDENT_PULL_OUT')
        .map((b) => ({ time: minToTime(b.startMin), reason: b.reason }));
    const contacts = prefs?.subPlanContacts;
    // Extract all unique outcomes from activities
    const uniqueOutcomes = new Map();
    if (plan) {
        for (const item of plan.items) {
            if (item.activity?.outcomes) {
                for (const outcomeRelation of item.activity.outcomes) {
                    const outcome = outcomeRelation.outcome;
                    uniqueOutcomes.set(outcome.id, {
                        code: outcome.code,
                        description: outcome.description,
                        subject: outcome.subject,
                    });
                }
            }
        }
    }
    // Format goals with optional anonymization
    const formattedGoals = studentGoals.map((goal) => ({
        id: goal.id,
        text: goal.text,
        status: goal.status,
        studentName: anonymize ? undefined : `${goal.student.firstName} ${goal.student.lastName}`,
    }));
    // Format routines
    const formattedRoutines = routines.map((routine) => ({
        id: routine.id,
        title: routine.title,
        description: routine.description,
        category: routine.category,
        timeOfDay: routine.timeOfDay || undefined,
    }));
    // Generate fallback plan
    const fallbackPlan = prefs?.subPlanProcedures
        ? `Emergency Fallback: ${prefs.subPlanProcedures}\n\nIf technology fails or activities cannot be completed, use print materials from the substitute folder and engage students in quiet reading or journaling activities.`
        : 'If technology fails or activities cannot be completed, use print materials from the substitute folder and engage students in quiet reading or journaling activities.';
    return {
        date: dayStart.toISOString().split('T')[0],
        schedule,
        pullOuts,
        contacts: contacts || {},
        procedures: prefs?.subPlanProcedures || undefined,
        outcomes: includePlans ? Array.from(uniqueOutcomes.values()) : undefined,
        goals: includeGoals ? formattedGoals : undefined,
        routines: includeRoutines ? formattedRoutines : undefined,
        fallbackPlan,
    };
}
export async function generateSubPlan(date, days = 1, options = {}) {
    const doc = new PDFDocument();
    const chunks = [];
    doc.on('data', (c) => chunks.push(c));
    // SubstituteInfo model archived - substitute information now managed in User and ClassRoutine models
    const _info = null;
    for (let i = 0; i < days; i++) {
        if (i > 0)
            doc.addPage();
        const d = new Date(date);
        d.setUTCDate(d.getUTCDate() + i);
        const data = await buildSubPlanData(d.toISOString().slice(0, 10), options);
        await generateSubPlanPDF({
            today: data.schedule.map((s) => ({ time: s.time, activity: s.activity ?? s.note ?? '' })),
            upcoming: [],
            procedures: data.procedures || '',
            studentNotes: pullOutsText(data.pullOuts), // Allergies now managed in Student model
            emergencyContacts: formatContacts(data.contacts),
            curriculumOutcomes: data.outcomes,
            goals: data.goals,
            routines: data.routines,
            fallbackPlan: data.fallbackPlan,
        }, doc);
    }
    doc.end();
    return new Promise((resolve) => doc.on('end', () => resolve(Buffer.concat(chunks))));
}
function pullOutsText(pullOuts) {
    return pullOuts.map((p) => `${p.time} - ${p.reason}`).join('\n');
}
function formatContacts(c) {
    return Object.entries(c)
        .map(([k, v]) => `${k}: ${v}`)
        .join('\n');
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9zZXJ2aWNlcy9zdWJQbGFuU2VydmljZS50cyIsIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFVLE1BQU0sV0FBVyxDQUFDO0FBQzNDLE9BQU8sV0FBVyxNQUFNLFFBQVEsQ0FBQztBQUNqQyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQW1DeEQsU0FBUyxTQUFTLENBQUMsR0FBVztJQUM1QixNQUFNLENBQUMsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3hELE1BQU0sQ0FBQyxHQUFHLE1BQU0sQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUM1QyxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO0FBQ3JCLENBQUM7QUFVRCxNQUFNLENBQUMsS0FBSyxVQUFVLGdCQUFnQixDQUNwQyxJQUFZLEVBQ1osVUFBMEIsRUFBRTtJQUU1QixNQUFNLFFBQVEsR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNoQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ2pDLE1BQU0sTUFBTSxHQUFHLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ2xDLE1BQU0sQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLFVBQVUsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBRTdDLE1BQU0sRUFDSixZQUFZLEdBQUcsSUFBSSxFQUNuQixlQUFlLEdBQUcsSUFBSSxFQUN0QixZQUFZLEdBQUcsSUFBSSxFQUNuQixTQUFTLEdBQUcsS0FB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RUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDbkUsQ0FBQztBQUVELFNBQVMsY0FBYyxDQUFDLENBQXlCO0lBQy9DLE9BQU8sTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7U0FDckIsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO1NBQzdCLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNoQixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9taWNoYWVsbWNpc2FhYy9HaXRIdWIvdGVhY2hpbmctZW5naW5lMi4wL3NlcnZlci9zcmMvc2VydmljZXMvc3ViUGxhblNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcHJpc21hLCBQcmlzbWEgfSBmcm9tICcuLi9wcmlzbWEnO1xuaW1wb3J0IFBERkRvY3VtZW50IGZyb20gJ3BkZmtpdCc7XG5pbXBvcnQgeyBnZW5lcmF0ZVN1YlBsYW5QREYgfSBmcm9tICcuL3N1YlBsYW5HZW5lcmF0b3InO1xuXG5leHBvcnQgaW50ZXJmYWNlIFNjaGVkdWxlRW50cnkge1xuICB0aW1lOiBzdHJpbmc7XG4gIGFjdGl2aXR5Pzogc3RyaW5nO1xuICBub3RlPzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFN1YlBsYW5EYXRhIHtcbiAgZGF0ZTogc3RyaW5nO1xuICBzY2hlZHVsZTogU2NoZWR1bGVFbnRyeVtdO1xuICBwdWxsT3V0czogeyB0aW1lOiBzdHJpbmc7IHJlYXNvbjogc3RyaW5nIH1bXTtcbiAgY29udGFjdHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG4gIHByb2NlZHVyZXM/OiBzdHJpbmc7XG4gIG91dGNvbWVzPzogQXJyYXk8e1xuICAgIGNvZGU6IHN0cmluZztcbiAgICBkZXNjcmlwdGlvbjogc3RyaW5nO1xuICAgIHN1YmplY3Q6IHN0cmluZztcbiAgfT47XG4gIGdvYWxzPzogQXJyYXk8e1xuICAgIGlkOiBudW1iZXI7XG4gICAgdGV4dDogc3RyaW5nO1xuICAgIHN0YXR1czogc3RyaW5nO1xuICAgIHN0dWRlbnROYW1lPzogc3RyaW5nO1xuICB9PjtcbiAgcm91dGluZXM/OiBBcnJheTx7XG4gICAgaWQ6IG51bWJlcjtcbiAgICB0aXRsZTogc3RyaW5nO1xuICAgIGRlc2NyaXB0aW9uOiBzdHJpbmc7XG4gICAgY2F0ZWdvcnk6IHN0cmluZztcbiAgICB0aW1lT2ZEYXk/OiBzdHJpbmc7XG4gIH0+O1xuICBmYWxsYmFja1BsYW4/OiBzdHJpbmc7XG59XG5cbmZ1bmN0aW9uIG1pblRvVGltZShtaW46IG51bWJlcik6IHN0cmluZyB7XG4gIGNvbnN0IGggPSBTdHJpbmcoTWF0aC5mbG9vcihtaW4gLyA2MCkpLnBhZFN0YXJ0KDIsICcwJyk7XG4gIGNvbnN0IG0gPSBTdHJpbmcobWluICUgNjApLnBhZFN0YXJ0KDIsICcwJyk7XG4gIHJldHVybiBgJHtofToke219YDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTdWJQbGFuT3B0aW9ucyB7XG4gIGluY2x1ZGVHb2Fscz86IGJvb2xlYW47XG4gIGluY2x1ZGVSb3V0aW5lcz86IGJvb2xlYW47XG4gIGluY2x1ZGVQbGFucz86IGJvb2xlYW47XG4gIGFub255bWl6ZT86IGJvb2xlYW47XG4gIHVzZXJJZD86IG51bWJlcjtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGJ1aWxkU3ViUGxhbkRhdGEoXG4gIGRhdGU6IHN0cmluZyxcbiAgb3B0aW9uczogU3ViUGxhbk9wdGlvbnMgPSB7fSxcbik6IFByb21pc2U8U3ViUGxhbkRhdGE+IHtcbiAgY29uc3QgZGF5U3RhcnQgPSBuZXcgRGF0ZShkYXRlKTtcbiAgZGF5U3RhcnQuc2V0VVRDSG91cnMoMCwgMCwgMCwgMCk7XG4gIGNvbnN0IGRheUVuZCA9IG5ldyBEYXRlKGRheVN0YXJ0KTtcbiAgZGF5RW5kLnNldFVUQ0RhdGUoZGF5U3RhcnQuZ2V0VVRDRGF0ZSgpICsgMSk7XG5cbiAgY29uc3Qge1xuICAgIGluY2x1ZGVHb2FscyA9IHRydWUsXG4gICAgaW5jbHVkZVJvdXRpbmVzID0gdHJ1ZSxcbiAgICBpbmNsdWRlUGxhbnMgPSB0cnVlLFxuICAgIGFub255bWl6ZSA9IGZhbHNlLFxuICAgIHVzZXJJZCA9IDEsXG4gIH0gPSBvcHRpb25zO1xuXG4gIGNvbnN0IFtwbGFuLCBldmVudHMsIGJsb2NrcywgcHJlZnMsIHJvdXRpbmVzLCBzdHVkZW50R29hbHNdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgIC8vIERJU0FCTEVEOiBMZWdhY3kgZGFpbHlQbGFuIG1vZGVsIHJlbW92ZWQgaW4gRVRGTyBtaWdyYXRpb25cbiAgICBpbmNsdWRlUGxhbnMgPyBQcm9taXNlLnJlc29sdmUobnVsbCkgOiBQcm9taXNlLnJlc29sdmUobnVsbCksIC8vIExlZ2FjeSBkYWlseVBsYW4gcXVlcnkgZGlzYWJsZWRcbiAgICBwcmlzbWEuY2FsZW5kYXJFdmVudC5maW5kTWFueSh7XG4gICAgICB3aGVyZTogeyBzdGFydDogeyBsdGU6IGRheUVuZCB9LCBlbmQ6IHsgZ3RlOiBkYXlTdGFydCB9IH0sXG4gICAgfSksXG4gICAgcHJpc21hLnVuYXZhaWxhYmxlQmxvY2suZmluZE1hbnkoeyB3aGVyZTogeyBkYXRlOiBkYXlTdGFydCB9IH0pLFxuICAgIG51bGwsIC8vIHRlYWNoZXJQcmVmZXJlbmNlcyBhcmNoaXZlZCAtIHByZWZlcmVuY2VzIG5vdyBpbiBVc2VyIGFuZCBDbGFzc1JvdXRpbmVcbiAgICBpbmNsdWRlUm91dGluZXNcbiAgICAgID8gcHJpc21hLmNsYXNzUm91dGluZS5maW5kTWFueSh7XG4gICAgICAgICAgd2hlcmU6IHsgdXNlcklkLCBpc0FjdGl2ZTogdHJ1ZSB9LFxuICAgICAgICAgIG9yZGVyQnk6IFt7IHByaW9yaXR5OiAnZGVzYycgfSwgeyBjYXRlZ29yeTogJ2FzYycgfV0sXG4gICAgICAgIH0pXG4gICAgICA6IFtdLFxuICAgIGluY2x1ZGVHb2Fsc1xuICAgICAgPyBwcmlzbWEuc3R1ZGVudEdvYWwuZmluZE1hbnkoe1xuICAgICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgICBzdGF0dXM6ICdhY3RpdmUnLFxuICAgICAgICAgICAgc3R1ZGVudDogeyB1c2VySWQgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgIHN0dWRlbnQ6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgICB0YWtlOiAxMCwgLy8gTGltaXQgdG8gbW9zdCByZWxldmFudCBnb2Fsc1xuICAgICAgICB9KVxuICAgICAgOiBbXSxcbiAgXSk7XG5cbiAgY29uc3Qgc2NoZWR1bGU6IFNjaGVkdWxlRW50cnlbXSA9IFtdO1xuICBpZiAocGxhbikge1xuICAgIGZvciAoY29uc3QgaXRlbSBvZiBwbGFuLml0ZW1zKSB7XG4gICAgICBjb25zdCBfc3ViamVjdElkID0gaXRlbS5zbG90Py5zdWJqZWN0SWQgPz8gaXRlbS5hY3Rpdml0eT8ubWlsZXN0b25lLnN1YmplY3RJZDtcbiAgICAgIC8vIERJU0FCTEVEOiBMZWdhY3kgYWN0aXZpdHkgbW9kZWwgcmVtb3ZlZCBpbiBFVEZPIG1pZ3JhdGlvblxuICAgICAgLy8gY29uc3QgYWN0ID0gbnVsbDsgLy8gTGVnYWN5IGFjdGl2aXR5IHF1ZXJpZXMgZGlzYWJsZWRcbiAgICAgIGNvbnN0IGFjdCA9IG51bGw7XG4gICAgICBzY2hlZHVsZS5wdXNoKHsgdGltZTogbWluVG9UaW1lKGl0ZW0uc3RhcnRNaW4pLCBhY3Rpdml0eTogYWN0Py50aXRsZSA/PyAnJyB9KTtcbiAgICB9XG4gIH1cbiAgZXZlbnRzLmZvckVhY2goKGUpID0+XG4gICAgc2NoZWR1bGUucHVzaCh7XG4gICAgICB0aW1lOiBtaW5Ub1RpbWUobmV3IERhdGUoZS5zdGFydCkuZ2V0VVRDSG91cnMoKSAqIDYwICsgbmV3IERhdGUoZS5zdGFydCkuZ2V0VVRDTWludXRlcygpKSxcbiAgICAgIG5vdGU6IGUudGl0bGUsXG4gICAgfSksXG4gICk7XG4gIGJsb2Nrc1xuICAgIC5maWx0ZXIoKGIpID0+IGIuYmxvY2tUeXBlID09PSAnVEVBQ0hFUl9BQlNFTkNFJylcbiAgICAuZm9yRWFjaCgoYikgPT4gc2NoZWR1bGUucHVzaCh7IHRpbWU6IG1pblRvVGltZShiLnN0YXJ0TWluKSwgbm90ZTogYi5yZWFzb24gfSkpO1xuXG4gIHNjaGVkdWxlLnNvcnQoKGEsIGIpID0+IGEudGltZS5sb2NhbGVDb21wYXJlKGIudGltZSkpO1xuXG4gIGNvbnN0IHB1bGxPdXRzID0gYmxvY2tzXG4gICAgLmZpbHRlcigoYikgPT4gYi5ibG9ja1R5cGUgPT09ICdTVFVERU5UX1BVTExfT1VUJylcbiAgICAubWFwKChiKSA9PiAoeyB0aW1lOiBtaW5Ub1RpbWUoYi5zdGFydE1pbiksIHJlYXNvbjogYi5yZWFzb24gfSkpO1xuXG4gIGNvbnN0IGNvbnRhY3RzID0gcHJlZnM/LnN1YlBsYW5Db250YWN0cyBhcyBQcmlzbWEuSnNvblZhbHVlIHwgbnVsbCBhc1xuICAgIHwgUmVjb3JkPHN0cmluZywgc3RyaW5nPlxuICAgIHwgdW5kZWZpbmVkO1xuXG4gIC8vIEV4dHJhY3QgYWxsIHVuaXF1ZSBvdXRjb21lcyBmcm9tIGFjdGl2aXRpZXNcbiAgY29uc3QgdW5pcXVlT3V0Y29tZXMgPSBuZXcgTWFwPFxuICAgIHN0cmluZyxcbiAgICB7XG4gICAgICBjb2RlOiBzdHJpbmc7XG4gICAgICBkZXNjcmlwdGlvbjogc3RyaW5nO1xuICAgICAgc3ViamVjdDogc3RyaW5nO1xuICAgIH1cbiAgPigpO1xuXG4gIGlmIChwbGFuKSB7XG4gICAgZm9yIChjb25zdCBpdGVtIG9mIHBsYW4uaXRlbXMpIHtcbiAgICAgIGlmIChpdGVtLmFjdGl2aXR5Py5vdXRjb21lcykge1xuICAgICAgICBmb3IgKGNvbnN0IG91dGNvbWVSZWxhdGlvbiBvZiBpdGVtLmFjdGl2aXR5Lm91dGNvbWVzKSB7XG4gICAgICAgICAgY29uc3Qgb3V0Y29tZSA9IG91dGNvbWVSZWxhdGlvbi5vdXRjb21lO1xuICAgICAgICAgIHVuaXF1ZU91dGNvbWVzLnNldChvdXRjb21lLmlkLCB7XG4gICAgICAgICAgICBjb2RlOiBvdXRjb21lLmNvZGUsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogb3V0Y29tZS5kZXNjcmlwdGlvbixcbiAgICAgICAgICAgIHN1YmplY3Q6IG91dGNvbWUuc3ViamVjdCxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIEZvcm1hdCBnb2FscyB3aXRoIG9wdGlvbmFsIGFub255bWl6YXRpb25cbiAgY29uc3QgZm9ybWF0dGVkR29hbHMgPSBzdHVkZW50R29hbHMubWFwKChnb2FsKSA9PiAoe1xuICAgIGlkOiBnb2FsLmlkLFxuICAgIHRleHQ6IGdvYWwudGV4dCxcbiAgICBzdGF0dXM6IGdvYWwuc3RhdHVzLFxuICAgIHN0dWRlbnROYW1lOiBhbm9ueW1pemUgPyB1bmRlZmluZWQgOiBgJHtnb2FsLnN0dWRlbnQuZmlyc3ROYW1lfSAke2dvYWwuc3R1ZGVudC5sYXN0TmFtZX1gLFxuICB9KSk7XG5cbiAgLy8gRm9ybWF0IHJvdXRpbmVzXG4gIGNvbnN0IGZvcm1hdHRlZFJvdXRpbmVzID0gcm91dGluZXMubWFwKChyb3V0aW5lKSA9PiAoe1xuICAgIGlkOiByb3V0aW5lLmlkLFxuICAgIHRpdGxlOiByb3V0aW5lLnRpdGxlLFxuICAgIGRlc2NyaXB0aW9uOiByb3V0aW5lLmRlc2NyaXB0aW9uLFxuICAgIGNhdGVnb3J5OiByb3V0aW5lLmNhdGVnb3J5LFxuICAgIHRpbWVPZkRheTogcm91dGluZS50aW1lT2ZEYXkgfHwgdW5kZWZpbmVkLFxuICB9KSk7XG5cbiAgLy8gR2VuZXJhdGUgZmFsbGJhY2sgcGxhblxuICBjb25zdCBmYWxsYmFja1BsYW4gPSBwcmVmcz8uc3ViUGxhblByb2NlZHVyZXNcbiAgICA/IGBFbWVyZ2VuY3kgRmFsbGJhY2s6ICR7cHJlZnMuc3ViUGxhblByb2NlZHVyZXN9XFxuXFxuSWYgdGVjaG5vbG9neSBmYWlscyBvciBhY3Rpdml0aWVzIGNhbm5vdCBiZSBjb21wbGV0ZWQsIHVzZSBwcmludCBtYXRlcmlhbHMgZnJvbSB0aGUgc3Vic3RpdHV0ZSBmb2xkZXIgYW5kIGVuZ2FnZSBzdHVkZW50cyBpbiBxdWlldCByZWFkaW5nIG9yIGpvdXJuYWxpbmcgYWN0aXZpdGllcy5gXG4gICAgOiAnSWYgdGVjaG5vbG9neSBmYWlscyBvciBhY3Rpdml0aWVzIGNhbm5vdCBiZSBjb21wbGV0ZWQsIHVzZSBwcmludCBtYXRlcmlhbHMgZnJvbSB0aGUgc3Vic3RpdHV0ZSBmb2xkZXIgYW5kIGVuZ2FnZSBzdHVkZW50cyBpbiBxdWlldCByZWFkaW5nIG9yIGpvdXJuYWxpbmcgYWN0aXZpdGllcy4nO1xuXG4gIHJldHVybiB7XG4gICAgZGF0ZTogZGF5U3RhcnQudG9JU09TdHJpbmcoKS5zcGxpdCgnVCcpWzBdLFxuICAgIHNjaGVkdWxlLFxuICAgIHB1bGxPdXRzLFxuICAgIGNvbnRhY3RzOiBjb250YWN0cyB8fCB7fSxcbiAgICBwcm9jZWR1cmVzOiBwcmVmcz8uc3ViUGxhblByb2NlZHVyZXMgfHwgdW5kZWZpbmVkLFxuICAgIG91dGNvbWVzOiBpbmNsdWRlUGxhbnMgPyBBcnJheS5mcm9tKHVuaXF1ZU91dGNvbWVzLnZhbHVlcygpKSA6IHVuZGVmaW5lZCxcbiAgICBnb2FsczogaW5jbHVkZUdvYWxzID8gZm9ybWF0dGVkR29hbHMgOiB1bmRlZmluZWQsXG4gICAgcm91dGluZXM6IGluY2x1ZGVSb3V0aW5lcyA/IGZvcm1hdHRlZFJvdXRpbmVzIDogdW5kZWZpbmVkLFxuICAgIGZhbGxiYWNrUGxhbixcbiAgfTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdlbmVyYXRlU3ViUGxhbihcbiAgZGF0ZTogc3RyaW5nLFxuICBkYXlzID0gMSxcbiAgb3B0aW9uczogU3ViUGxhbk9wdGlvbnMgPSB7fSxcbik6IFByb21pc2U8QnVmZmVyPiB7XG4gIGNvbnN0IGRvYyA9IG5ldyBQREZEb2N1bWVudCgpO1xuICBjb25zdCBjaHVua3M6IEJ1ZmZlcltdID0gW107XG4gIGRvYy5vbignZGF0YScsIChjKSA9PiBjaHVua3MucHVzaChjKSk7XG4gIC8vIFN1YnN0aXR1dGVJbmZvIG1vZGVsIGFyY2hpdmVkIC0gc3Vic3RpdHV0ZSBpbmZvcm1hdGlvbiBub3cgbWFuYWdlZCBpbiBVc2VyIGFuZCBDbGFzc1JvdXRpbmUgbW9kZWxzXG4gIGNvbnN0IF9pbmZvID0gbnVsbDtcblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGRheXM7IGkrKykge1xuICAgIGlmIChpID4gMCkgZG9jLmFkZFBhZ2UoKTtcbiAgICBjb25zdCBkID0gbmV3IERhdGUoZGF0ZSk7XG4gICAgZC5zZXRVVENEYXRlKGQuZ2V0VVRDRGF0ZSgpICsgaSk7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IGJ1aWxkU3ViUGxhbkRhdGEoZC50b0lTT1N0cmluZygpLnNsaWNlKDAsIDEwKSwgb3B0aW9ucyk7XG5cbiAgICBhd2FpdCBnZW5lcmF0ZVN1YlBsYW5QREYoXG4gICAgICB7XG4gICAgICAgIHRvZGF5OiBkYXRhLnNjaGVkdWxlLm1hcCgocykgPT4gKHsgdGltZTogcy50aW1lLCBhY3Rpdml0eTogcy5hY3Rpdml0eSA/PyBzLm5vdGUgPz8gJycgfSkpLFxuICAgICAgICB1cGNvbWluZzogW10sXG4gICAgICAgIHByb2NlZHVyZXM6IGRhdGEucHJvY2VkdXJlcyB8fCAnJyxcbiAgICAgICAgc3R1ZGVudE5vdGVzOlxuICAgICAgICAgIHB1bGxPdXRzVGV4dChkYXRhLnB1bGxPdXRzKSwgLy8gQWxsZXJnaWVzIG5vdyBtYW5hZ2VkIGluIFN0dWRlbnQgbW9kZWxcbiAgICAgICAgZW1lcmdlbmN5Q29udGFjdHM6IGZvcm1hdENvbnRhY3RzKGRhdGEuY29udGFjdHMpLFxuICAgICAgICBjdXJyaWN1bHVtT3V0Y29tZXM6IGRhdGEub3V0Y29tZXMsXG4gICAgICAgIGdvYWxzOiBkYXRhLmdvYWxzLFxuICAgICAgICByb3V0aW5lczogZGF0YS5yb3V0aW5lcyxcbiAgICAgICAgZmFsbGJhY2tQbGFuOiBkYXRhLmZhbGxiYWNrUGxhbixcbiAgICAgIH0sXG4gICAgICBkb2MsXG4gICAgKTtcbiAgfVxuICBkb2MuZW5kKCk7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gZG9jLm9uKCdlbmQnLCAoKSA9PiByZXNvbHZlKEJ1ZmZlci5jb25jYXQoY2h1bmtzKSkpKTtcbn1cblxuZnVuY3Rpb24gcHVsbE91dHNUZXh0KHB1bGxPdXRzOiB7IHRpbWU6IHN0cmluZzsgcmVhc29uOiBzdHJpbmcgfVtdKTogc3RyaW5nIHtcbiAgcmV0dXJuIHB1bGxPdXRzLm1hcCgocCkgPT4gYCR7cC50aW1lfSAtICR7cC5yZWFzb259YCkuam9pbignXFxuJyk7XG59XG5cbmZ1bmN0aW9uIGZvcm1hdENvbnRhY3RzKGM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4pOiBzdHJpbmcge1xuICByZXR1cm4gT2JqZWN0LmVudHJpZXMoYylcbiAgICAubWFwKChbaywgdl0pID0+IGAke2t9OiAke3Z9YClcbiAgICAuam9pbignXFxuJyk7XG59XG4iXSwidmVyc2lvbiI6M30=