{"file":"/Users/michaelmcisaac/GitHub/teaching-engine2.0/server/src/services/parentSummaryLLM.ts","mappings":"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","names":[],"sources":["/Users/michaelmcisaac/GitHub/teaching-engine2.0/server/src/services/parentSummaryLLM.ts"],"sourcesContent":["import { generateContent } from './llmService';\nimport type { Student, StudentArtifact, StudentReflection } from '../prisma';\n\ninterface StudentWithData extends Student {\n  artifacts: StudentArtifact[];\n  reflections: StudentReflection[];\n}\n\ninterface GenerateParentSummaryParams {\n  student: StudentWithData;\n  fromDate: Date;\n  toDate: Date;\n  focusAreas?: string[];\n}\n\ninterface RegenerateParentSummaryParams {\n  originalFrench: string;\n  originalEnglish: string;\n  student: Student;\n  fromDate: Date;\n  toDate: Date;\n  focusAreas?: string[];\n  tone: 'formal' | 'informal';\n}\n\nexport interface ParentSummaryGeneration {\n  french: string;\n  english: string;\n}\n\nexport async function generateParentSummary({\n  student,\n  fromDate,\n  toDate,\n  focusAreas,\n}: GenerateParentSummaryParams): Promise<ParentSummaryGeneration> {\n  const formatDate = (date: Date) => date.toLocaleDateString('en-CA');\n\n  // Assessment functionality removed\n  // const assessmentSummary: Array<Record<string, unknown>> = [];\n\n  // Prepare artifacts data\n  const artifactsSummary = student.artifacts.map((artifact) => ({\n    title: artifact.title,\n    description: artifact.description,\n    createdAt: artifact.createdAt.toLocaleDateString('en-CA'),\n  }));\n\n  // Prepare reflections data\n  const reflectionsSummary = student.reflections.map((reflection) => ({\n    content: reflection.content,\n    createdAt: reflection.createdAt.toLocaleDateString('en-CA'),\n  }));\n\n  const focusText =\n    focusAreas && focusAreas.length > 0\n      ? `\\n\\nPLEASE FOCUS PARTICULARLY ON: ${focusAreas.join(', ')}`\n      : '';\n\n  const prompt = `You are an expert elementary school teacher writing a progress summary for parents. \n\nSTUDENT: ${student.firstName} ${student.lastName} (Grade ${student.grade})\nPERIOD: ${formatDate(fromDate)} to ${formatDate(toDate)}\n\nASSESSMENT RESULTS:\nNo assessments recorded for this period\n\nSTUDENT ARTIFACTS:\n${\n  artifactsSummary.length > 0\n    ? artifactsSummary\n        .map((a) => `- ${a.title} (${a.createdAt})${a.description ? `: ${a.description}` : ''}`)\n        .join('\\n')\n    : 'No artifacts recorded for this period'\n}\n\nREFLECTIONS:\n${\n  reflectionsSummary.length > 0\n    ? reflectionsSummary.map((r) => `- ${r.createdAt}: ${r.content}`).join('\\n')\n    : 'No reflections recorded for this period'\n}${focusText}\n\nPlease write a comprehensive progress summary in BOTH French and English. The summary should:\n\n1. Be warm, positive, and encouraging while being honest about areas for growth\n2. Highlight specific achievements and progress made during this period\n3. Include concrete examples from the data provided\n4. Mention next steps or areas of continued focus\n5. Be approximately 150-200 words in each language\n6. Use appropriate French Immersion teacher terminology\n\nRespond with a JSON object containing:\n{\n  \"french\": \"French summary text here...\",\n  \"english\": \"English summary text here...\"\n}\n\nMake sure the JSON is properly formatted and the content is meaningful, specific, and helpful for parents.`;\n\n  try {\n    const response = await generateContent(prompt);\n\n    // Try to parse the JSON response\n    try {\n      const parsed = JSON.parse(response);\n      if (parsed.french && parsed.english) {\n        return {\n          french: parsed.french,\n          english: parsed.english,\n        };\n      }\n    } catch (parseError) {\n      console.warn('Failed to parse LLM JSON response, falling back to text parsing');\n    }\n\n    // Fallback: try to extract French and English from text\n    const frenchMatch = response.match(/[\"']french[\"']\\s*:\\s*[\"'](.*?)[\"']/s);\n    const englishMatch = response.match(/[\"']english[\"']\\s*:\\s*[\"'](.*?)[\"']/s);\n\n    if (frenchMatch && englishMatch) {\n      return {\n        french: frenchMatch[1].replace(/\\\\n/g, '\\n').replace(/\\\\\"/g, '\"'),\n        english: englishMatch[1].replace(/\\\\n/g, '\\n').replace(/\\\\\"/g, '\"'),\n      };\n    }\n\n    // Final fallback\n    throw new Error('Could not parse summary from LLM response');\n  } catch (error) {\n    console.error('Error generating parent summary:', error);\n\n    // Provide fallback content\n    return {\n      french: `Résumé de progrès pour ${student.firstName} ${student.lastName}\\n\\nPériode: ${formatDate(fromDate)} au ${formatDate(toDate)}\\n\\n${student.firstName} continue de progresser dans ses apprentissages. Des données détaillées ont été collectées durant cette période et seront utilisées pour supporter son développement continu. Nous continuons à travailler ensemble pour assurer sa réussite académique.`,\n      english: `Progress Summary for ${student.firstName} ${student.lastName}\\n\\nPeriod: ${formatDate(fromDate)} to ${formatDate(toDate)}\\n\\n${student.firstName} continues to make progress in their learning. Detailed data has been collected during this period and will be used to support their continued development. We continue to work together to ensure their academic success.`,\n    };\n  }\n}\n\nexport async function regenerateParentSummary({\n  originalFrench,\n  originalEnglish,\n  student,\n  fromDate,\n  toDate,\n  focusAreas,\n  tone,\n}: RegenerateParentSummaryParams): Promise<ParentSummaryGeneration> {\n  const formatDate = (date: Date) => date.toLocaleDateString('en-CA');\n\n  const focusText =\n    focusAreas && focusAreas.length > 0\n      ? `\\n\\nPLEASE MAINTAIN FOCUS ON: ${focusAreas.join(', ')}`\n      : '';\n\n  const toneInstructions =\n    tone === 'formal'\n      ? 'Keep the tone professional and formal.'\n      : 'Make the tone slightly more conversational and warm while maintaining professionalism.';\n\n  const prompt = `You are an expert elementary school teacher. I need you to regenerate a parent progress summary with some variations while keeping the core message and accuracy.\n\nSTUDENT: ${student.firstName} ${student.lastName} (Grade ${student.grade})\nPERIOD: ${formatDate(fromDate)} to ${formatDate(toDate)}\n\nORIGINAL FRENCH SUMMARY:\n${originalFrench}\n\nORIGINAL ENGLISH SUMMARY:\n${originalEnglish}\n\nPlease create NEW versions of both summaries that:\n1. Maintain the same factual information and key points\n2. Use different wording and sentence structures\n3. ${toneInstructions}\n4. Keep the same approximate length\n5. Remain equally helpful and informative for parents${focusText}\n\nRespond with a JSON object containing:\n{\n  \"french\": \"New French summary here...\",\n  \"english\": \"New English summary here...\"\n}\n\nMake sure the JSON is properly formatted and the new content maintains the quality and accuracy of the original.`;\n\n  try {\n    const response = await generateContent(prompt);\n\n    // Try to parse the JSON response\n    try {\n      const parsed = JSON.parse(response);\n      if (parsed.french && parsed.english) {\n        return {\n          french: parsed.french,\n          english: parsed.english,\n        };\n      }\n    } catch (parseError) {\n      console.warn('Failed to parse LLM JSON response, falling back to text parsing');\n    }\n\n    // Fallback: try to extract French and English from text\n    const frenchMatch = response.match(/[\"']french[\"']\\s*:\\s*[\"'](.*?)[\"']/s);\n    const englishMatch = response.match(/[\"']english[\"']\\s*:\\s*[\"'](.*?)[\"']/s);\n\n    if (frenchMatch && englishMatch) {\n      return {\n        french: frenchMatch[1].replace(/\\\\n/g, '\\n').replace(/\\\\\"/g, '\"'),\n        english: englishMatch[1].replace(/\\\\n/g, '\\n').replace(/\\\\\"/g, '\"'),\n      };\n    }\n\n    // If parsing fails, return the original content\n    console.warn('Could not parse regenerated summary, returning original');\n    return {\n      french: originalFrench,\n      english: originalEnglish,\n    };\n  } catch (error) {\n    console.error('Error regenerating parent summary:', error);\n\n    // Return original content on error\n    return {\n      french: originalFrench,\n      english: originalEnglish,\n    };\n  }\n}\n"],"version":3}