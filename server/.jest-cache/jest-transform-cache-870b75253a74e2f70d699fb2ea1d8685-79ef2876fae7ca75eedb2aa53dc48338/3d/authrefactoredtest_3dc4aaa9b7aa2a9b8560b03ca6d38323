67427e8b7437d220ec800a82c31fd06a
/**
 * Refactored Auth Middleware Unit Tests
 *
 * This demonstrates the new standardized test patterns:
 * - Using the test framework utilities
 * - Consistent mocking patterns
 * - Better test isolation
 * - Clear test structure
 */
import { describe, it, expect, beforeEach, isolatedTest, AuthHelper, AssertionHelpers } from '../utils/testFramework';
import { authMiddleware } from '../../src/middleware/auth';
describe('Auth Middleware - Refactored', () => {
    const authHelper = new AuthHelper();
    let req;
    let res;
    let next;
    beforeEach(() => {
        // Clean setup for each test
        req = { headers: {} };
        res = {
            status: jest.fn().mockReturnThis(),
            json: jest.fn().mockReturnThis(),
        };
        next = jest.fn();
    });
    describe('Authorization Header Validation', () => {
        it('should reject requests without authorization header', () => {
            authMiddleware(req, res, next);
            AssertionHelpers.assertErrorResponse({ status: res.status, body: res.json }, 401, 'Unauthorized');
            expect(next).not.toHaveBeenCalled();
        });
        it('should reject requests with empty authorization header', () => {
            req.headers.authorization = '';
            authMiddleware(req, res, next);
            AssertionHelpers.assertErrorResponse({ status: res.status, body: res.json }, 401, 'Unauthorized');
            expect(next).not.toHaveBeenCalled();
        });
        it('should reject requests with malformed authorization header', () => {
            req.headers.authorization = 'InvalidFormat token';
            authMiddleware(req, res, next);
            AssertionHelpers.assertErrorResponse({ status: res.status, body: res.json }, 401, 'Unauthorized');
        });
    });
    describe('Token Validation', () => {
        isolatedTest('should accept valid JWT token', async (context) => {
            const userId = 'test-user-123';
            const token = authHelper.createToken(userId);
            req.headers.authorization = `Bearer ${token}`;
            authMiddleware(req, res, next);
            expect(req.user).toEqual({ userId });
            expect(next).toHaveBeenCalledTimes(1);
            expect(res.status).not.toHaveBeenCalled();
        });
        isolatedTest('should reject expired tokens', async (context) => {
            const userId = 'test-user-456';
            const expiredToken = authHelper.createExpiredToken(userId);
            req.headers.authorization = `Bearer ${expiredToken}`;
            authMiddleware(req, res, next);
            AssertionHelpers.assertErrorResponse({ status: res.status, body: res.json }, 401, 'Unauthorized');
            expect(req.user).toBeUndefined();
            expect(next).not.toHaveBeenCalled();
        });
        it('should reject invalid tokens', () => {
            req.headers.authorization = 'Bearer invalid-jwt-token';
            authMiddleware(req, res, next);
            AssertionHelpers.assertErrorResponse({ status: res.status, body: res.json }, 401, 'Unauthorized');
        });
        it('should reject tokens with invalid signature', () => {
            // Create token with different secret
            const jwt = require('jsonwebtoken');
            const invalidToken = jwt.sign({ userId: '789' }, 'wrong-secret');
            req.headers.authorization = `Bearer ${invalidToken}`;
            authMiddleware(req, res, next);
            AssertionHelpers.assertErrorResponse({ status: res.status, body: res.json }, 401, 'Unauthorized');
        });
    });
    describe('Token Extraction', () => {
        it('should extract user data from valid token', () => {
            const userId = 'user-789';
            const additionalClaims = { role: 'admin', email: 'admin@example.com' };
            const token = authHelper.createToken(userId, {
                expiresIn: '2h',
                issuer: 'test-suite'
            });
            // Mock JWT to include additional claims
            const jwt = require('jsonwebtoken');
            jest.spyOn(jwt, 'verify').mockImplementationOnce((token, secret, callback) => {
                callback(null, { userId, ...additionalClaims });
            });
            req.headers.authorization = `Bearer ${token}`;
            authMiddleware(req, res, next);
            expect(req.user).toEqual({ userId, ...additionalClaims });
            expect(next).toHaveBeenCalled();
        });
        it('should handle case-insensitive bearer prefix', () => {
            const userId = 'case-test-user';
            const token = authHelper.createToken(userId);
            // Test different case variations
            const bearerVariations = ['Bearer', 'BEARER', 'bearer', 'BeArEr'];
            bearerVariations.forEach(bearerPrefix => {
                req.headers.authorization = `${bearerPrefix} ${token}`;
                authMiddleware(req, res, next);
                expect(req.user?.userId).toBe(userId);
                expect(next).toHaveBeenCalled();
                // Reset for next iteration
                req.user = undefined;
                next.mockClear();
            });
        });
    });
    describe('Environment Configuration', () => {
        it('should use JWT_SECRET from environment', () => {
            const originalSecret = process.env.JWT_SECRET;
            const customSecret = 'custom-test-secret-12345';
            process.env.JWT_SECRET = customSecret;
            const userId = 'env-test-user';
            const jwt = require('jsonwebtoken');
            const token = jwt.sign({ userId }, customSecret);
            req.headers.authorization = `Bearer ${token}`;
            authMiddleware(req, res, next);
            expect(req.user?.userId).toBe(userId);
            expect(next).toHaveBeenCalled();
            // Restore original
            process.env.JWT_SECRET = originalSecret;
        });
        it('should fall back to default secret when JWT_SECRET is not set', () => {
            const originalSecret = process.env.JWT_SECRET;
            delete process.env.JWT_SECRET;
            const userId = 'fallback-test-user';
            const jwt = require('jsonwebtoken');
            const token = jwt.sign({ userId }, 'secret'); // Default fallback
            req.headers.authorization = `Bearer ${token}`;
            authMiddleware(req, res, next);
            expect(req.user?.userId).toBe(userId);
            expect(next).toHaveBeenCalled();
            // Restore original
            if (originalSecret) {
                process.env.JWT_SECRET = originalSecret;
            }
        });
    });
    describe('Error Handling', () => {
        it('should handle JWT decode errors gracefully', () => {
            const jwt = require('jsonwebtoken');
            jest.spyOn(jwt, 'verify').mockImplementationOnce(() => {
                throw new Error('JWT decode failed');
            });
            req.headers.authorization = 'Bearer some-token';
            authMiddleware(req, res, next);
            AssertionHelpers.assertErrorResponse({ status: res.status, body: res.json }, 401, 'Unauthorized');
        });
        it('should handle missing user ID in token', () => {
            const jwt = require('jsonwebtoken');
            const tokenWithoutUserId = jwt.sign({ role: 'admin' }, 'secret');
            req.headers.authorization = `Bearer ${tokenWithoutUserId}`;
            authMiddleware(req, res, next);
            // Should still pass but with incomplete user object
            expect(req.user).toBeDefined();
            expect(req.user?.userId).toBeUndefined();
            expect(next).toHaveBeenCalled();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3Rlc3RzL3VuaXQvYXV0aC5yZWZhY3RvcmVkLnRlc3QudHMiLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7O0dBUUc7QUFFSCxPQUFPLEVBQ0wsUUFBUSxFQUNSLEVBQUUsRUFDRixNQUFNLEVBQ04sVUFBVSxFQUNWLFlBQVksRUFDWixVQUFVLEVBRVYsZ0JBQWdCLEVBQ2pCLE1BQU0sd0JBQXdCLENBQUM7QUFFaEMsT0FBTyxFQUFFLGNBQWMsRUFBb0IsTUFBTSwyQkFBMkIsQ0FBQztBQUU3RSxRQUFRLENBQUMsOEJBQThCLEVBQUUsR0FBRyxFQUFFO0lBQzVDLE1BQU0sVUFBVSxHQUFHLElBQUksVUFBVSxFQUFFLENBQUM7SUFDcEMsSUFBSSxHQUF5QixDQUFDO0lBQzlCLElBQUksR0FBc0IsQ0FBQztJQUMzQixJQUFJLElBQXFDLENBQUM7SUFFMUMsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLDRCQUE0QjtRQUM1QixHQUFHLEdBQUcsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLENBQUM7UUFDdEIsR0FBRyxHQUFHO1lBQ0osTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxjQUFjLEVBQUU7WUFDbEMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxjQUFjLEVBQUU7U0FDakMsQ0FBQztRQUNGLElBQUksR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7SUFDbkIsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsaUNBQWlDLEVBQUUsR0FBRyxFQUFFO1FBQy9DLEVBQUUsQ0FBQyxxREFBcUQsRUFBRSxHQUFHLEVBQUU7WUFDN0QsY0FBYyxDQUFDLEdBQWtCLEVBQUUsR0FBZSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBRTFELGdCQUFnQixDQUFDLG1CQUFtQixDQUNsQyxFQUFFLE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxH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QyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9taWNoYWVsbWNpc2FhYy9HaXRIdWIvdGVhY2hpbmctZW5naW5lMi4wL3NlcnZlci90ZXN0cy91bml0L2F1dGgucmVmYWN0b3JlZC50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogUmVmYWN0b3JlZCBBdXRoIE1pZGRsZXdhcmUgVW5pdCBUZXN0c1xuICogXG4gKiBUaGlzIGRlbW9uc3RyYXRlcyB0aGUgbmV3IHN0YW5kYXJkaXplZCB0ZXN0IHBhdHRlcm5zOlxuICogLSBVc2luZyB0aGUgdGVzdCBmcmFtZXdvcmsgdXRpbGl0aWVzXG4gKiAtIENvbnNpc3RlbnQgbW9ja2luZyBwYXR0ZXJuc1xuICogLSBCZXR0ZXIgdGVzdCBpc29sYXRpb25cbiAqIC0gQ2xlYXIgdGVzdCBzdHJ1Y3R1cmVcbiAqL1xuXG5pbXBvcnQge1xuICBkZXNjcmliZSxcbiAgaXQsXG4gIGV4cGVjdCxcbiAgYmVmb3JlRWFjaCxcbiAgaXNvbGF0ZWRUZXN0LFxuICBBdXRoSGVscGVyLFxuICBNb2NrRmFjdG9yeSxcbiAgQXNzZXJ0aW9uSGVscGVyc1xufSBmcm9tICcuLi91dGlscy90ZXN0RnJhbWV3b3JrJztcbmltcG9ydCB7IFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBhdXRoTWlkZGxld2FyZSwgdHlwZSBBdXRoUmVxdWVzdCB9IGZyb20gJy4uLy4uL3NyYy9taWRkbGV3YXJlL2F1dGgnO1xuXG5kZXNjcmliZSgnQXV0aCBNaWRkbGV3YXJlIC0gUmVmYWN0b3JlZCcsICgpID0+IHtcbiAgY29uc3QgYXV0aEhlbHBlciA9IG5ldyBBdXRoSGVscGVyKCk7XG4gIGxldCByZXE6IFBhcnRpYWw8QXV0aFJlcXVlc3Q+O1xuICBsZXQgcmVzOiBQYXJ0aWFsPFJlc3BvbnNlPjtcbiAgbGV0IG5leHQ6IGplc3QuTW9ja2VkRnVuY3Rpb248KCkgPT4gdm9pZD47XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgLy8gQ2xlYW4gc2V0dXAgZm9yIGVhY2ggdGVzdFxuICAgIHJlcSA9IHsgaGVhZGVyczoge30gfTtcbiAgICByZXMgPSB7XG4gICAgICBzdGF0dXM6IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgICAganNvbjogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgfTtcbiAgICBuZXh0ID0gamVzdC5mbigpO1xuICB9KTtcblxuICBkZXNjcmliZSgnQXV0aG9yaXphdGlvbiBIZWFkZXIgVmFsaWRhdGlvbicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJlamVjdCByZXF1ZXN0cyB3aXRob3V0IGF1dGhvcml6YXRpb24gaGVhZGVyJywgKCkgPT4ge1xuICAgICAgYXV0aE1pZGRsZXdhcmUocmVxIGFzIEF1dGhSZXF1ZXN0LCByZXMgYXMgUmVzcG9uc2UsIG5leHQpO1xuXG4gICAgICBBc3NlcnRpb25IZWxwZXJzLmFzc2VydEVycm9yUmVzcG9uc2UoXG4gICAgICAgIHsgc3RhdHVzOiByZXMuc3RhdHVzLCBib2R5OiByZXMuanNvbiB9LFxuICAgICAgICA0MDEsXG4gICAgICAgICdVbmF1dGhvcml6ZWQnXG4gICAgICApO1xuICAgICAgZXhwZWN0KG5leHQpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJlamVjdCByZXF1ZXN0cyB3aXRoIGVtcHR5IGF1dGhvcml6YXRpb24gaGVhZGVyJywgKCkgPT4ge1xuICAgICAgcmVxLmhlYWRlcnMhLmF1dGhvcml6YXRpb24gPSAnJztcblxuICAgICAgYXV0aE1pZGRsZXdhcmUocmVxIGFzIEF1dGhSZXF1ZXN0LCByZXMgYXMgUmVzcG9uc2UsIG5leHQpO1xuXG4gICAgICBBc3NlcnRpb25IZWxwZXJzLmFzc2VydEVycm9yUmVzcG9uc2UoXG4gICAgICAgIHsgc3RhdHVzOiByZXMuc3RhdHVzLCBib2R5OiByZXMuanNvbiB9LFxuICAgICAgICA0MDEsXG4gICAgICAgICdVbmF1dGhvcml6ZWQnXG4gICAgICApO1xuICAgICAgZXhwZWN0KG5leHQpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJlamVjdCByZXF1ZXN0cyB3aXRoIG1hbGZvcm1lZCBhdXRob3JpemF0aW9uIGhlYWRlcicsICgpID0+IHtcbiAgICAgIHJlcS5oZWFkZXJzIS5hdXRob3JpemF0aW9uID0gJ0ludmFsaWRGb3JtYXQgdG9rZW4nO1xuXG4gICAgICBhdXRoTWlkZGxld2FyZShyZXEgYXMgQXV0aFJlcXVlc3QsIHJlcyBhcyBSZXNwb25zZSwgbmV4dCk7XG5cbiAgICAgIEFzc2VydGlvbkhlbHBlcnMuYXNzZXJ0RXJyb3JSZXNwb25zZShcbiAgICAgICAgeyBzdGF0dXM6IHJlcy5zdGF0dXMsIGJvZHk6IHJlcy5qc29uIH0sXG4gICAgICAgIDQwMSxcbiAgICAgICAgJ1VuYXV0aG9yaXplZCdcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdUb2tlbiBWYWxpZGF0aW9uJywgKCkgPT4ge1xuICAgIGlzb2xhdGVkVGVzdCgnc2hvdWxkIGFjY2VwdCB2YWxpZCBKV1QgdG9rZW4nLCBhc3luYyAoY29udGV4dCkgPT4ge1xuICAgICAgY29uc3QgdXNlcklkID0gJ3Rlc3QtdXNlci0xMjMnO1xuICAgICAgY29uc3QgdG9rZW4gPSBhdXRoSGVscGVyLmNyZWF0ZVRva2VuKHVzZXJJZCk7XG4gICAgICBcbiAgICAgIHJlcS5oZWFkZXJzIS5hdXRob3JpemF0aW9uID0gYEJlYXJlciAke3Rva2VufWA7XG5cbiAgICAgIGF1dGhNaWRkbGV3YXJlKHJlcSBhcyBBdXRoUmVxdWVzdCwgcmVzIGFzIFJlc3BvbnNlLCBuZXh0KTtcblxuICAgICAgZXhwZWN0KHJlcS51c2VyKS50b0VxdWFsKHsgdXNlcklkIH0pO1xuICAgICAgZXhwZWN0KG5leHQpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICAgIGV4cGVjdChyZXMuc3RhdHVzKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuXG4gICAgaXNvbGF0ZWRUZXN0KCdzaG91bGQgcmVqZWN0IGV4cGlyZWQgdG9rZW5zJywgYXN5bmMgKGNvbnRleHQpID0+IHtcbiAgICAgIGNvbnN0IHVzZXJJZCA9ICd0ZXN0LXVzZXItNDU2JztcbiAgICAgIGNvbnN0IGV4cGlyZWRUb2tlbiA9IGF1dGhIZWxwZXIuY3JlYXRlRXhwaXJlZFRva2VuKHVzZXJJZCk7XG4gICAgICBcbiAgICAgIHJlcS5oZWFkZXJzIS5hdXRob3JpemF0aW9uID0gYEJlYXJlciAke2V4cGlyZWRUb2tlbn1gO1xuXG4gICAgICBhdXRoTWlkZGxld2FyZShyZXEgYXMgQXV0aFJlcXVlc3QsIHJlcyBhcyBSZXNwb25zZSwgbmV4dCk7XG5cbiAgICAgIEFzc2VydGlvbkhlbHBlcnMuYXNzZXJ0RXJyb3JSZXNwb25zZShcbiAgICAgICAgeyBzdGF0dXM6IHJlcy5zdGF0dXMsIGJvZHk6IHJlcy5qc29uIH0sXG4gICAgICAgIDQwMSxcbiAgICAgICAgJ1VuYXV0aG9yaXplZCdcbiAgICAgICk7XG4gICAgICBleHBlY3QocmVxLnVzZXIpLnRvQmVVbmRlZmluZWQoKTtcbiAgICAgIGV4cGVjdChuZXh0KS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZWplY3QgaW52YWxpZCB0b2tlbnMnLCAoKSA9PiB7XG4gICAgICByZXEuaGVhZGVycyEuYXV0aG9yaXphdGlvbiA9ICdCZWFyZXIgaW52YWxpZC1qd3QtdG9rZW4nO1xuXG4gICAgICBhdXRoTWlkZGxld2FyZShyZXEgYXMgQXV0aFJlcXVlc3QsIHJlcyBhcyBSZXNwb25zZSwgbmV4dCk7XG5cbiAgICAgIEFzc2VydGlvbkhlbHBlcnMuYXNzZXJ0RXJyb3JSZXNwb25zZShcbiAgICAgICAgeyBzdGF0dXM6IHJlcy5zdGF0dXMsIGJvZHk6IHJlcy5qc29uIH0sXG4gICAgICAgIDQwMSxcbiAgICAgICAgJ1VuYXV0aG9yaXplZCdcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJlamVjdCB0b2tlbnMgd2l0aCBpbnZhbGlkIHNpZ25hdHVyZScsICgpID0+IHtcbiAgICAgIC8vIENyZWF0ZSB0b2tlbiB3aXRoIGRpZmZlcmVudCBzZWNyZXRcbiAgICAgIGNvbnN0IGp3dCA9IHJlcXVpcmUoJ2pzb253ZWJ0b2tlbicpO1xuICAgICAgY29uc3QgaW52YWxpZFRva2VuID0gand0LnNpZ24oeyB1c2VySWQ6ICc3ODknIH0sICd3cm9uZy1zZWNyZXQnKTtcbiAgICAgIFxuICAgICAgcmVxLmhlYWRlcnMhLmF1dGhvcml6YXRpb24gPSBgQmVhcmVyICR7aW52YWxpZFRva2VufWA7XG5cbiAgICAgIGF1dGhNaWRkbGV3YXJlKHJlcSBhcyBBdXRoUmVxdWVzdCwgcmVzIGFzIFJlc3BvbnNlLCBuZXh0KTtcblxuICAgICAgQXNzZXJ0aW9uSGVscGVycy5hc3NlcnRFcnJvclJlc3BvbnNlKFxuICAgICAgICB7IHN0YXR1czogcmVzLnN0YXR1cywgYm9keTogcmVzLmpzb24gfSxcbiAgICAgICAgNDAxLFxuICAgICAgICAnVW5hdXRob3JpemVkJ1xuICAgICAgKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1Rva2VuIEV4dHJhY3Rpb24nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBleHRyYWN0IHVzZXIgZGF0YSBmcm9tIHZhbGlkIHRva2VuJywgKCkgPT4ge1xuICAgICAgY29uc3QgdXNlcklkID0gJ3VzZXItNzg5JztcbiAgICAgIGNvbnN0IGFkZGl0aW9uYWxDbGFpbXMgPSB7IHJvbGU6ICdhZG1pbicsIGVtYWlsOiAnYWRtaW5AZXhhbXBsZS5jb20nIH07XG4gICAgICBjb25zdCB0b2tlbiA9IGF1dGhIZWxwZXIuY3JlYXRlVG9rZW4odXNlcklkLCB7XG4gICAgICAgIGV4cGlyZXNJbjogJzJoJyxcbiAgICAgICAgaXNzdWVyOiAndGVzdC1zdWl0ZSdcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICAvLyBNb2NrIEpXVCB0byBpbmNsdWRlIGFkZGl0aW9uYWwgY2xhaW1zXG4gICAgICBjb25zdCBqd3QgPSByZXF1aXJlKCdqc29ud2VidG9rZW4nKTtcbiAgICAgIGplc3Quc3B5T24oand0LCAndmVyaWZ5JykubW9ja0ltcGxlbWVudGF0aW9uT25jZSgodG9rZW4sIHNlY3JldCwgY2FsbGJhY2spID0+IHtcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgeyB1c2VySWQsIC4uLmFkZGl0aW9uYWxDbGFpbXMgfSk7XG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgcmVxLmhlYWRlcnMhLmF1dGhvcml6YXRpb24gPSBgQmVhcmVyICR7dG9rZW59YDtcblxuICAgICAgYXV0aE1pZGRsZXdhcmUocmVxIGFzIEF1dGhSZXF1ZXN0LCByZXMgYXMgUmVzcG9uc2UsIG5leHQpO1xuXG4gICAgICBleHBlY3QocmVxLnVzZXIpLnRvRXF1YWwoeyB1c2VySWQsIC4uLmFkZGl0aW9uYWxDbGFpbXMgfSk7XG4gICAgICBleHBlY3QobmV4dCkudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgY2FzZS1pbnNlbnNpdGl2ZSBiZWFyZXIgcHJlZml4JywgKCkgPT4ge1xuICAgICAgY29uc3QgdXNlcklkID0gJ2Nhc2UtdGVzdC11c2VyJztcbiAgICAgIGNvbnN0IHRva2VuID0gYXV0aEhlbHBlci5jcmVhdGVUb2tlbih1c2VySWQpO1xuICAgICAgXG4gICAgICAvLyBUZXN0IGRpZmZlcmVudCBjYXNlIHZhcmlhdGlvbnNcbiAgICAgIGNvbnN0IGJlYXJlclZhcmlhdGlvbnMgPSBbJ0JlYXJlcicsICdCRUFSRVInLCAnYmVhcmVyJywgJ0JlQXJFciddO1xuICAgICAgXG4gICAgICBiZWFyZXJWYXJpYXRpb25zLmZvckVhY2goYmVhcmVyUHJlZml4ID0+IHtcbiAgICAgICAgcmVxLmhlYWRlcnMhLmF1dGhvcml6YXRpb24gPSBgJHtiZWFyZXJQcmVmaXh9ICR7dG9rZW59YDtcbiAgICAgICAgXG4gICAgICAgIGF1dGhNaWRkbGV3YXJlKHJlcSBhcyBBdXRoUmVxdWVzdCwgcmVzIGFzIFJlc3BvbnNlLCBuZXh0KTtcbiAgICAgICAgXG4gICAgICAgIGV4cGVjdChyZXEudXNlcj8udXNlcklkKS50b0JlKHVzZXJJZCk7XG4gICAgICAgIGV4cGVjdChuZXh0KS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICAgIFxuICAgICAgICAvLyBSZXNldCBmb3IgbmV4dCBpdGVyYXRpb25cbiAgICAgICAgcmVxLnVzZXIgPSB1bmRlZmluZWQ7XG4gICAgICAgIG5leHQubW9ja0NsZWFyKCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0Vudmlyb25tZW50IENvbmZpZ3VyYXRpb24nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCB1c2UgSldUX1NFQ1JFVCBmcm9tIGVudmlyb25tZW50JywgKCkgPT4ge1xuICAgICAgY29uc3Qgb3JpZ2luYWxTZWNyZXQgPSBwcm9jZXNzLmVudi5KV1RfU0VDUkVUO1xuICAgICAgY29uc3QgY3VzdG9tU2VjcmV0ID0gJ2N1c3RvbS10ZXN0LXNlY3JldC0xMjM0NSc7XG4gICAgICBwcm9jZXNzLmVudi5KV1RfU0VDUkVUID0gY3VzdG9tU2VjcmV0O1xuXG4gICAgICBjb25zdCB1c2VySWQgPSAnZW52LXRlc3QtdXNlcic7XG4gICAgICBjb25zdCBqd3QgPSByZXF1aXJlKCdqc29ud2VidG9rZW4nKTtcbiAgICAgIGNvbnN0IHRva2VuID0gand0LnNpZ24oeyB1c2VySWQgfSwgY3VzdG9tU2VjcmV0KTtcbiAgICAgIFxuICAgICAgcmVxLmhlYWRlcnMhLmF1dGhvcml6YXRpb24gPSBgQmVhcmVyICR7dG9rZW59YDtcblxuICAgICAgYXV0aE1pZGRsZXdhcmUocmVxIGFzIEF1dGhSZXF1ZXN0LCByZXMgYXMgUmVzcG9uc2UsIG5leHQpO1xuXG4gICAgICBleHBlY3QocmVxLnVzZXI/LnVzZXJJZCkudG9CZSh1c2VySWQpO1xuICAgICAgZXhwZWN0KG5leHQpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcblxuICAgICAgLy8gUmVzdG9yZSBvcmlnaW5hbFxuICAgICAgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCA9IG9yaWdpbmFsU2VjcmV0O1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBmYWxsIGJhY2sgdG8gZGVmYXVsdCBzZWNyZXQgd2hlbiBKV1RfU0VDUkVUIGlzIG5vdCBzZXQnLCAoKSA9PiB7XG4gICAgICBjb25zdCBvcmlnaW5hbFNlY3JldCA9IHByb2Nlc3MuZW52LkpXVF9TRUNSRVQ7XG4gICAgICBkZWxldGUgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVDtcblxuICAgICAgY29uc3QgdXNlcklkID0gJ2ZhbGxiYWNrLXRlc3QtdXNlcic7XG4gICAgICBjb25zdCBqd3QgPSByZXF1aXJlKCdqc29ud2VidG9rZW4nKTtcbiAgICAgIGNvbnN0IHRva2VuID0gand0LnNpZ24oeyB1c2VySWQgfSwgJ3NlY3JldCcpOyAvLyBEZWZhdWx0IGZhbGxiYWNrXG4gICAgICBcbiAgICAgIHJlcS5oZWFkZXJzIS5hdXRob3JpemF0aW9uID0gYEJlYXJlciAke3Rva2VufWA7XG5cbiAgICAgIGF1dGhNaWRkbGV3YXJlKHJlcSBhcyBBdXRoUmVxdWVzdCwgcmVzIGFzIFJlc3BvbnNlLCBuZXh0KTtcblxuICAgICAgZXhwZWN0KHJlcS51c2VyPy51c2VySWQpLnRvQmUodXNlcklkKTtcbiAgICAgIGV4cGVjdChuZXh0KS50b0hhdmVCZWVuQ2FsbGVkKCk7XG5cbiAgICAgIC8vIFJlc3RvcmUgb3JpZ2luYWxcbiAgICAgIGlmIChvcmlnaW5hbFNlY3JldCkge1xuICAgICAgICBwcm9jZXNzLmVudi5KV1RfU0VDUkVUID0gb3JpZ2luYWxTZWNyZXQ7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdFcnJvciBIYW5kbGluZycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBKV1QgZGVjb2RlIGVycm9ycyBncmFjZWZ1bGx5JywgKCkgPT4ge1xuICAgICAgY29uc3Qgand0ID0gcmVxdWlyZSgnanNvbndlYnRva2VuJyk7XG4gICAgICBqZXN0LnNweU9uKGp3dCwgJ3ZlcmlmeScpLm1vY2tJbXBsZW1lbnRhdGlvbk9uY2UoKCkgPT4ge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0pXVCBkZWNvZGUgZmFpbGVkJyk7XG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgcmVxLmhlYWRlcnMhLmF1dGhvcml6YXRpb24gPSAnQmVhcmVyIHNvbWUtdG9rZW4nO1xuXG4gICAgICBhdXRoTWlkZGxld2FyZShyZXEgYXMgQXV0aFJlcXVlc3QsIHJlcyBhcyBSZXNwb25zZSwgbmV4dCk7XG5cbiAgICAgIEFzc2VydGlvbkhlbHBlcnMuYXNzZXJ0RXJyb3JSZXNwb25zZShcbiAgICAgICAgeyBzdGF0dXM6IHJlcy5zdGF0dXMsIGJvZHk6IHJlcy5qc29uIH0sXG4gICAgICAgIDQwMSxcbiAgICAgICAgJ1VuYXV0aG9yaXplZCdcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBtaXNzaW5nIHVzZXIgSUQgaW4gdG9rZW4nLCAoKSA9PiB7XG4gICAgICBjb25zdCBqd3QgPSByZXF1aXJlKCdqc29ud2VidG9rZW4nKTtcbiAgICAgIGNvbnN0IHRva2VuV2l0aG91dFVzZXJJZCA9IGp3dC5zaWduKHsgcm9sZTogJ2FkbWluJyB9LCAnc2VjcmV0Jyk7XG4gICAgICBcbiAgICAgIHJlcS5oZWFkZXJzIS5hdXRob3JpemF0aW9uID0gYEJlYXJlciAke3Rva2VuV2l0aG91dFVzZXJJZH1gO1xuXG4gICAgICBhdXRoTWlkZGxld2FyZShyZXEgYXMgQXV0aFJlcXVlc3QsIHJlcyBhcyBSZXNwb25zZSwgbmV4dCk7XG5cbiAgICAgIC8vIFNob3VsZCBzdGlsbCBwYXNzIGJ1dCB3aXRoIGluY29tcGxldGUgdXNlciBvYmplY3RcbiAgICAgIGV4cGVjdChyZXEudXNlcikudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChyZXEudXNlcj8udXNlcklkKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgICBleHBlY3QobmV4dCkudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuICB9KTtcbn0pOyJdLCJ2ZXJzaW9uIjozfQ==