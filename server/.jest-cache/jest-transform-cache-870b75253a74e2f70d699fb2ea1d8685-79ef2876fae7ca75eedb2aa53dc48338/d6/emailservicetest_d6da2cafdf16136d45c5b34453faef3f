75280c6d8ac1c1f412f4f4af537e580c
import { describe, beforeAll, afterAll, beforeEach, it, expect, jest } from '@jest/globals';
import { authRequest } from '../test-auth-helper';
import { getTestPrismaClient } from '../jest.setup';
import { getTestEmailService, resetTestEmailService } from '../helpers/testEmailService';
import { generateTestEmail, expectEmailContent } from '../helpers/emailTestHelper';
import { randomBytes } from 'crypto';
import bcrypt from 'bcryptjs';
import { app } from '../../src/index';
import { setEmailHandler, clearEmailHandler } from '../../src/services/emailService';
// Increase test timeout for email tests
jest.setTimeout(60000);
describe('Email Service Integration Tests', () => {
    let testEmailService;
    let teacherToken;
    let testUser;
    let user;
    let prisma;
    const auth = authRequest(app);
    beforeAll(async () => {
        prisma = getTestPrismaClient();
        await auth.setup();
        testEmailService = getTestEmailService();
        // Set up email handler to capture emails in tests
        setEmailHandler(async (to, subject, text, html, attachment) => {
            await testEmailService.sendEmail(to, subject, text, html, attachment
                ? {
                    filename: attachment.filename,
                    content: attachment.content,
                }
                : undefined);
        });
        // Create test user
        const id = randomBytes(4).toString('hex');
        testUser = {
            email: `teacher-${id}@example.com`,
            password: `password-${id}`,
            name: `Teacher ${id}`,
            role: 'teacher',
        };
        const hashedPassword = await bcrypt.hash(testUser.password, 10);
        user = await prisma.user.create({
            data: {
                email: testUser.email,
                password: hashedPassword,
                name: testUser.name,
                role: testUser.role,
            },
        });
        // Get auth token
        const loginRes = await auth.post('/api/login').send({
            email: testUser.email,
            password: testUser.password,
        });
        teacherToken = loginRes.body.token;
    });
    afterAll(async () => {
        try {
            await prisma.user.deleteMany({ where: { email: testUser.email } });
            clearEmailHandler();
            await resetTestEmailService();
        }
        catch (error) {
            console.error('Error during cleanup:', error);
        }
        finally {
            await prisma.$disconnect();
        }
    });
    beforeEach(async () => {
        await testEmailService.clearEmails();
        // Clear any existing test data
        await prisma.parentContact.deleteMany();
        await prisma.student.deleteMany();
        await prisma.newsletter.deleteMany();
        // Ensure user exists after cleanup
        const currentUser = await prisma.user.findUnique({ where: { id: user.id } });
        if (!currentUser) {
            const hashedPassword = await bcrypt.hash(testUser.password, 10);
            await prisma.user.create({
                data: {
                    id: user.id,
                    email: testUser.email,
                    password: hashedPassword,
                    name: testUser.name,
                    role: testUser.role,
                },
            });
        }
    });
    describe('Newsletter Email Tests', () => {
        it('sends newsletter with PDF attachment to parent contacts', async () => {
            // Create test students and parent contacts
            const student1 = await prisma.student.create({
                data: { firstName: 'John', lastName: 'Jr', grade: 1, userId: user.id },
            });
            const student2 = await prisma.student.create({
                data: { firstName: 'Jane', lastName: 'Jr', grade: 1, userId: user.id },
            });
            const parentContacts = [
                {
                    name: 'John Parent',
                    email: generateTestEmail(),
                    studentId: student1.id,
                },
                {
                    name: 'Jane Parent',
                    email: generateTestEmail(),
                    studentId: student2.id,
                },
            ];
            await Promise.all(parentContacts.map((contact) => prisma.parentContact.create({ data: contact })));
            // Create newsletter
            const newsletter = await prisma.newsletter.create({
                data: {
                    title: 'Weekly Newsletter - Test Edition',
                    content: '<h1>Weekly Newsletter</h1><p>This is a test newsletter with important updates.</p>',
                },
            });
            // Send newsletter
            const sendRes = await auth
                .post(`/api/newsletters/${newsletter.id}/send`)
                .set('Authorization', `Bearer ${teacherToken}`);
            expect(sendRes.status).toBe(200);
            expect(sendRes.body.sent).toBe(2);
            // Verify emails were sent
            const emails = await testEmailService.getEmails();
            expect(emails).toHaveLength(2);
            // Check first email
            const firstEmail = emails.find((email) => email.to.includes(parentContacts[0].email));
            expect(firstEmail).toBeDefined();
            expectEmailContent(firstEmail, {
                subject: 'Weekly Newsletter - Test Edition',
                text: 'Please see the attached newsletter.',
            });
            // Verify PDF attachment
            expect(firstEmail.attachments).toHaveLength(1);
            const attachment = firstEmail.attachments[0];
            expect(attachment.filename).toBe('newsletter.pdf');
            expect(attachment.contentType).toContain('pdf');
            expect(attachment.content).toBeInstanceOf(Buffer);
            expect(attachment.content.length).toBeGreaterThan(0);
        });
        it('handles newsletter sending with no parent contacts', async () => {
            // Create newsletter without any parent contacts
            const newsletter = await prisma.newsletter.create({
                data: {
                    title: 'Empty Newsletter',
                    content: '<p>Test content</p>',
                },
            });
            const sendRes = await auth
                .post(`/api/newsletters/${newsletter.id}/send`)
                .set('Authorization', `Bearer ${teacherToken}`);
            expect(sendRes.status).toBe(200);
            expect(sendRes.body.sent).toBe(0);
            // Verify no emails were sent
            const emails = await testEmailService.getEmails();
            expect(emails).toHaveLength(0);
        });
        it('handles newsletter sending failures gracefully', async () => {
            // Create students and parent contacts with invalid email format
            const validStudent = await prisma.student.create({
                data: { firstName: 'Valid', lastName: 'Student', grade: 1, userId: user.id },
            });
            const invalidStudent = await prisma.student.create({
                data: { firstName: 'Invalid', lastName: 'Student', grade: 1, userId: user.id },
            });
            const parentContacts = [
                {
                    name: 'Valid Parent',
                    email: generateTestEmail(),
                    studentId: validStudent.id,
                },
                {
                    name: 'Invalid Parent',
                    email: 'invalid-email',
                    studentId: invalidStudent.id,
                },
            ];
            await Promise.all(parentContacts.map((contact) => prisma.parentContact.create({ data: contact })));
            const newsletter = await prisma.newsletter.create({
                data: {
                    title: 'Test Newsletter',
                    content: '<p>Test content</p>',
                },
            });
            // Newsletter sending should not fail completely
            const sendRes = await auth
                .post(`/api/newsletters/${newsletter.id}/send`)
                .set('Authorization', `Bearer ${teacherToken}`);
            expect(sendRes.status).toBe(200);
            // Should report attempted sends even if some fail
            expect(sendRes.body.sent).toBe(2);
        });
    });
    describe('Bulk Email Operations', () => {
        it('sends bulk emails to multiple recipients', async () => {
            const recipients = [generateTestEmail(), generateTestEmail(), generateTestEmail()];
            const subject = 'Bulk Email Test';
            const text = 'This is a bulk email test message';
            const result = await testEmailService.sendBulkEmails(recipients, subject, text);
            expect(result.sent).toBe(3);
            expect(result.failed).toHaveLength(0);
            // Verify all emails were sent
            const emails = await testEmailService.getEmails();
            expect(emails).toHaveLength(3);
            recipients.forEach((recipient) => {
                const email = emails.find((e) => e.to.includes(recipient));
                expect(email).toBeDefined();
                expectEmailContent(email, {
                    subject,
                    text,
                });
            });
        });
        it('handles partial failures in bulk email sending', async () => {
            const validRecipients = [generateTestEmail(), generateTestEmail()];
            const invalidRecipients = ['invalid-email-1', 'invalid-email-2'];
            const allRecipients = [...validRecipients, ...invalidRecipients];
            const result = await testEmailService.sendBulkEmails(allRecipients, 'Bulk Test', 'Test message');
            // Should have some successes and some failures
            expect(result.sent).toBeGreaterThan(0);
            expect(result.failed).toHaveLength(2);
            expect(result.failed).toEqual(expect.arrayContaining(invalidRecipients));
        });
    });
    describe('Email Retry Mechanism', () => {
        it('retries failed email sends', async () => {
            const recipient = generateTestEmail();
            const subject = 'Retry Test';
            const text = 'This email should be retried';
            // First attempt should succeed after retries
            await expect(testEmailService.sendEmailWithRetry(recipient, subject, text, undefined, 3, 100)).resolves.not.toThrow();
            // Verify email was eventually sent
            const emails = await testEmailService.getEmails();
            expect(emails).toHaveLength(1);
            expectEmailContent(emails[0], {
                to: [recipient],
                subject,
                text,
            });
        });
        /**
         * @todo This test uses jest.spyOn and should test real retry behavior
         * @mocked sendEmail - prevents testing actual retry mechanism with real email service
         * @not-fully-implemented - should test retries with actual network failures
         */
        it('fails after maximum retry attempts', async () => {
            // Mock the send function to always fail
            const originalSend = testEmailService.sendEmail;
            jest.spyOn(testEmailService, 'sendEmail').mockRejectedValue(new Error('Network error'));
            const recipient = generateTestEmail();
            await expect(testEmailService.sendEmailWithRetry(recipient, 'Fail Test', 'Should fail', undefined, 2, 50)).rejects.toThrow('Failed to send email after 2 attempts');
            // Restore original function
            jest.spyOn(testEmailService, 'sendEmail').mockImplementation(originalSend);
        });
    });
    describe('Email Content and Formatting', () => {
        it('preserves email content formatting', async () => {
            const recipient = generateTestEmail();
            const subject = 'Formatting Test';
            const text = `This is a multi-line email
      
      With proper formatting:
      - Bullet point 1
      - Bullet point 2
      
      And special characters: áéíóú & <symbols>`;
            await testEmailService.sendEmail(recipient, subject, text);
            const emails = await testEmailService.getEmails();
            expect(emails).toHaveLength(1);
            const email = emails[0];
            expect(email.text).toBe(text);
            expect(email.subject).toBe(subject);
        });
        it('handles HTML content in newsletters', async () => {
            const htmlStudent = await prisma.student.create({
                data: { firstName: 'HTML', lastName: 'Student', grade: 1, userId: user.id },
            });
            await prisma.parentContact.create({
                data: {
                    name: 'HTML Parent',
                    email: generateTestEmail(),
                    studentId: htmlStudent.id,
                },
            });
            const htmlContent = `
        <html>
          <body>
            <h1 style="color: blue;">Weekly Newsletter</h1>
            <p>This newsletter contains <strong>HTML formatting</strong>.</p>
            <ul>
              <li>Item 1</li>
              <li>Item 2</li>
            </ul>
          </body>
        </html>
      `;
            const newsletter = await prisma.newsletter.create({
                data: {
                    title: 'HTML Newsletter',
                    content: htmlContent,
                },
            });
            await auth
                .post(`/api/newsletters/${newsletter.id}/send`)
                .set('Authorization', `Bearer ${teacherToken}`);
            const emails = await testEmailService.getEmails();
            expect(emails).toHaveLength(1);
            const email = emails[0];
            expect(email.html || email.text).toContain('Weekly Newsletter');
            expect(email.html || email.text).toContain('HTML formatting');
        });
        it('handles Unicode characters correctly', async () => {
            const recipient = generateTestEmail();
            const subject = 'Unicode Test: émojis 🎉 français';
            const text = 'Bonjour! Voici un test avec des caractères spéciaux: àáâãäåæçèéêë 🌟';
            await testEmailService.sendEmail(recipient, subject, text);
            const emails = await testEmailService.getEmails();
            expect(emails).toHaveLength(1);
            const email = emails[0];
            expect(email.subject).toBe(subject);
            expect(email.text).toBe(text);
        });
    });
    describe('Email Attachment Handling', () => {
        it('handles PDF attachments correctly', async () => {
            const recipient = generateTestEmail();
            const subject = 'PDF Test';
            const text = 'Email with PDF attachment';
            // Create a simple PDF buffer (mock PDF content)
            const pdfContent = Buffer.from('%PDF-1.4\n1 0 obj\n<< /Type /Catalog /Pages 2 0 R >>\nendobj\n%%EOF');
            const attachment = {
                filename: 'test-document.pdf',
                content: pdfContent,
            };
            await testEmailService.sendEmail(recipient, subject, text, undefined, attachment);
            const emails = await testEmailService.getEmails();
            expect(emails).toHaveLength(1);
            const email = emails[0];
            expect(email.attachments).toHaveLength(1);
            const receivedAttachment = email.attachments[0];
            expect(receivedAttachment.filename).toBe('test-document.pdf');
            expect(receivedAttachment.content).toEqual(pdfContent);
            expect(receivedAttachment.contentType).toContain('pdf');
        });
        it('handles multiple attachments', async () => {
            const recipient = generateTestEmail();
            const subject = 'Multiple Attachments Test';
            const text = 'Email with multiple attachments';
            // For this test, we'll simulate multiple attachments by sending multiple emails
            // In a real scenario, you'd modify the sendEmail function to accept multiple attachments
            const attachment1 = {
                filename: 'document1.pdf',
                content: Buffer.from('PDF content 1'),
            };
            const attachment2 = {
                filename: 'document2.pdf',
                content: Buffer.from('PDF content 2'),
            };
            // Send first email with first attachment
            await testEmailService.sendEmail(recipient, subject + ' 1', text, undefined, attachment1);
            // Send second email with second attachment
            await testEmailService.sendEmail(recipient, subject + ' 2', text, undefined, attachment2);
            const emails = await testEmailService.getEmails();
            expect(emails).toHaveLength(2);
            // Verify both attachments were sent correctly
            const email1 = emails.find((e) => e.subject.includes('1'));
            const email2 = emails.find((e) => e.subject.includes('2'));
            expect(email1?.attachments?.[0].filename).toBe('document1.pdf');
            expect(email2?.attachments?.[0].filename).toBe('document2.pdf');
        });
        it('handles attachment encoding correctly', async () => {
            const recipient = generateTestEmail();
            const subject = 'Encoding Test';
            const text = 'Email with binary attachment';
            // Create binary content with various byte values
            const binaryContent = Buffer.from([0, 1, 2, 3, 255, 254, 253, 252, 127, 128, 129]);
            const attachment = {
                filename: 'binary-file.bin',
                content: binaryContent,
            };
            await testEmailService.sendEmail(recipient, subject, text, undefined, attachment);
            const emails = await testEmailService.getEmails();
            expect(emails).toHaveLength(1);
            const email = emails[0];
            const receivedAttachment = email.attachments[0];
            expect(receivedAttachment.content).toEqual(binaryContent);
        });
        it('handles empty attachments gracefully', async () => {
            const recipient = generateTestEmail();
            const subject = 'Empty Attachment Test';
            const text = 'Email with empty attachment';
            const attachment = {
                filename: 'empty-file.txt',
                content: Buffer.alloc(0), // Empty buffer
            };
            await testEmailService.sendEmail(recipient, subject, text, undefined, attachment);
            const emails = await testEmailService.getEmails();
            expect(emails).toHaveLength(1);
            const email = emails[0];
            expect(email.attachments).toHaveLength(1);
            expect(email.attachments[0].content).toHaveLength(0);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3Rlc3RzL2ludGVncmF0aW9uL2VtYWlsLXNlcnZpY2UudGVzdC50cyIsIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzVGLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDcEQsT0FBTyxFQUFFLG1CQUFtQixFQUFFLHFCQUFxQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDekYsT0FBTyxFQUFFLGlCQUFpQixFQUFFLGtCQUFrQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDbkYsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUNyQyxPQUFPLE1BQU0sTUFBTSxVQUFVLENBQUM7QUFDOUIsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3RDLE9BQU8sRUFBRSxlQUFlLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUVyRix3Q0FBd0M7QUFDeEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUV2QixRQUFRLENBQUMsaUNBQWlDLEVBQUUsR0FBRyxFQUFFO0lBQy9DLElBQUksZ0JBQXdELENBQUM7SUFDN0QsSUFBSSxZQUFvQixDQUFDO0lBQ3pCLElBQUksUUFLSCxDQUFDO0lBQ0YsSUFBSSxJQUErRCxDQUFDO0lBQ3BFLElBQUksTUFBOEMsQ0FBQztJQUNuRCxNQUFNLElBQUksR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7SUFFOUIsU0FBUyxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ25CLE1BQU0sR0FBRyxtQkFBbUIsRUFBRSxDQUFDO1FB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QyxDQUFDO1lBQzFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsV0FBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4RCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3Rlc3RzL2ludGVncmF0aW9uL2VtYWlsLXNlcnZpY2UudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBkZXNjcmliZSwgYmVmb3JlQWxsLCBhZnRlckFsbCwgYmVmb3JlRWFjaCwgaXQsIGV4cGVjdCwgamVzdCB9IGZyb20gJ0BqZXN0L2dsb2JhbHMnO1xuaW1wb3J0IHsgYXV0aFJlcXVlc3QgfSBmcm9tICcuLi90ZXN0LWF1dGgtaGVscGVyJztcbmltcG9ydCB7IGdldFRlc3RQcmlzbWFDbGllbnQgfSBmcm9tICcuLi9qZXN0LnNldHVwJztcbmltcG9ydCB7IGdldFRlc3RFbWFpbFNlcnZpY2UsIHJlc2V0VGVzdEVtYWlsU2VydmljZSB9IGZyb20gJy4uL2hlbHBlcnMvdGVzdEVtYWlsU2VydmljZSc7XG5pbXBvcnQgeyBnZW5lcmF0ZVRlc3RFbWFpbCwgZXhwZWN0RW1haWxDb250ZW50IH0gZnJvbSAnLi4vaGVscGVycy9lbWFpbFRlc3RIZWxwZXInO1xuaW1wb3J0IHsgcmFuZG9tQnl0ZXMgfSBmcm9tICdjcnlwdG8nO1xuaW1wb3J0IGJjcnlwdCBmcm9tICdiY3J5cHRqcyc7XG5pbXBvcnQgeyBhcHAgfSBmcm9tICcuLi8uLi9zcmMvaW5kZXgnO1xuaW1wb3J0IHsgc2V0RW1haWxIYW5kbGVyLCBjbGVhckVtYWlsSGFuZGxlciB9IGZyb20gJy4uLy4uL3NyYy9zZXJ2aWNlcy9lbWFpbFNlcnZpY2UnO1xuXG4vLyBJbmNyZWFzZSB0ZXN0IHRpbWVvdXQgZm9yIGVtYWlsIHRlc3RzXG5qZXN0LnNldFRpbWVvdXQoNjAwMDApO1xuXG5kZXNjcmliZSgnRW1haWwgU2VydmljZSBJbnRlZ3JhdGlvbiBUZXN0cycsICgpID0+IHtcbiAgbGV0IHRlc3RFbWFpbFNlcnZpY2U6IFJldHVyblR5cGU8dHlwZW9mIGdldFRlc3RFbWFpbFNlcnZpY2U+O1xuICBsZXQgdGVhY2hlclRva2VuOiBzdHJpbmc7XG4gIGxldCB0ZXN0VXNlcjoge1xuICAgIGVtYWlsOiBzdHJpbmc7XG4gICAgcGFzc3dvcmQ6IHN0cmluZztcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgcm9sZTogJ3RlYWNoZXInO1xuICB9O1xuICBsZXQgdXNlcjogeyBpZDogbnVtYmVyOyBlbWFpbDogc3RyaW5nOyBuYW1lOiBzdHJpbmc7IHJvbGU6IHN0cmluZyB9O1xuICBsZXQgcHJpc21hOiBSZXR1cm5UeXBlPHR5cGVvZiBnZXRUZXN0UHJpc21hQ2xpZW50PjtcbiAgY29uc3QgYXV0aCA9IGF1dGhSZXF1ZXN0KGFwcCk7XG5cbiAgYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcbiAgICBwcmlzbWEgPSBnZXRUZXN0UHJpc21hQ2xpZW50KCk7XG4gICAgYXdhaXQgYXV0aC5zZXR1cCgpO1xuICAgIHRlc3RFbWFpbFNlcnZpY2UgPSBnZXRUZXN0RW1haWxTZXJ2aWNlKCk7XG5cbiAgICAvLyBTZXQgdXAgZW1haWwgaGFuZGxlciB0byBjYXB0dXJlIGVtYWlscyBpbiB0ZXN0c1xuICAgIHNldEVtYWlsSGFuZGxlcihhc3luYyAodG8sIHN1YmplY3QsIHRleHQsIGh0bWwsIGF0dGFjaG1lbnQpID0+IHtcbiAgICAgIGF3YWl0IHRlc3RFbWFpbFNlcnZpY2Uuc2VuZEVtYWlsKFxuICAgICAgICB0byxcbiAgICAgICAgc3ViamVjdCxcbiAgICAgICAgdGV4dCxcbiAgICAgICAgaHRtbCxcbiAgICAgICAgYXR0YWNobWVudFxuICAgICAgICAgID8ge1xuICAgICAgICAgICAgICBmaWxlbmFtZTogYXR0YWNobWVudC5maWxlbmFtZSxcbiAgICAgICAgICAgICAgY29udGVudDogYXR0YWNobWVudC5jb250ZW50LFxuICAgICAgICAgICAgfVxuICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIC8vIENyZWF0ZSB0ZXN0IHVzZXJcbiAgICBjb25zdCBpZCA9IHJhbmRvbUJ5dGVzKDQpLnRvU3RyaW5nKCdoZXgnKTtcbiAgICB0ZXN0VXNlciA9IHtcbiAgICAgIGVtYWlsOiBgdGVhY2hlci0ke2lkfUBleGFtcGxlLmNvbWAsXG4gICAgICBwYXNzd29yZDogYHBhc3N3b3JkLSR7aWR9YCxcbiAgICAgIG5hbWU6IGBUZWFjaGVyICR7aWR9YCxcbiAgICAgIHJvbGU6ICd0ZWFjaGVyJyxcbiAgICB9O1xuXG4gICAgY29uc3QgaGFzaGVkUGFzc3dvcmQgPSBhd2FpdCBiY3J5cHQuaGFzaCh0ZXN0VXNlci5wYXNzd29yZCwgMTApO1xuICAgIHVzZXIgPSBhd2FpdCBwcmlzbWEudXNlci5jcmVhdGUoe1xuICAgICAgZGF0YToge1xuICAgICAgICBlbWFpbDogdGVzdFVzZXIuZW1haWwsXG4gICAgICAgIHBhc3N3b3JkOiBoYXNoZWRQYXNzd29yZCxcbiAgICAgICAgbmFtZTogdGVzdFVzZXIubmFtZSxcbiAgICAgICAgcm9sZTogdGVzdFVzZXIucm9sZSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBHZXQgYXV0aCB0b2tlblxuICAgIGNvbnN0IGxvZ2luUmVzID0gYXdhaXQgYXV0aC5wb3N0KCcvYXBpL2xvZ2luJykuc2VuZCh7XG4gICAgICBlbWFpbDogdGVzdFVzZXIuZW1haWwsXG4gICAgICBwYXNzd29yZDogdGVzdFVzZXIucGFzc3dvcmQsXG4gICAgfSk7XG5cbiAgICB0ZWFjaGVyVG9rZW4gPSBsb2dpblJlcy5ib2R5LnRva2VuO1xuICB9KTtcblxuICBhZnRlckFsbChhc3luYyAoKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHByaXNtYS51c2VyLmRlbGV0ZU1hbnkoeyB3aGVyZTogeyBlbWFpbDogdGVzdFVzZXIuZW1haWwgfSB9KTtcbiAgICAgIGNsZWFyRW1haWxIYW5kbGVyKCk7XG4gICAgICBhd2FpdCByZXNldFRlc3RFbWFpbFNlcnZpY2UoKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgZHVyaW5nIGNsZWFudXA6JywgZXJyb3IpO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBhd2FpdCBwcmlzbWEuJGRpc2Nvbm5lY3QoKTtcbiAgICB9XG4gIH0pO1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IHRlc3RFbWFpbFNlcnZpY2UuY2xlYXJFbWFpbHMoKTtcbiAgICAvLyBDbGVhciBhbnkgZXhpc3RpbmcgdGVzdCBkYXRhXG4gICAgYXdhaXQgcHJpc21hLnBhcmVudENvbnRhY3QuZGVsZXRlTWFueSgpO1xuICAgIGF3YWl0IHByaXNtYS5zdHVkZW50LmRlbGV0ZU1hbnkoKTtcbiAgICBhd2FpdCBwcmlzbWEubmV3c2xldHRlci5kZWxldGVNYW55KCk7XG5cbiAgICAvLyBFbnN1cmUgdXNlciBleGlzdHMgYWZ0ZXIgY2xlYW51cFxuICAgIGNvbnN0IGN1cnJlbnRVc2VyID0gYXdhaXQgcHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7IHdoZXJlOiB7IGlkOiB1c2VyLmlkIH0gfSk7XG4gICAgaWYgKCFjdXJyZW50VXNlcikge1xuICAgICAgY29uc3QgaGFzaGVkUGFzc3dvcmQgPSBhd2FpdCBiY3J5cHQuaGFzaCh0ZXN0VXNlci5wYXNzd29yZCwgMTApO1xuICAgICAgYXdhaXQgcHJpc21hLnVzZXIuY3JlYXRlKHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGlkOiB1c2VyLmlkLFxuICAgICAgICAgIGVtYWlsOiB0ZXN0VXNlci5lbWFpbCxcbiAgICAgICAgICBwYXNzd29yZDogaGFzaGVkUGFzc3dvcmQsXG4gICAgICAgICAgbmFtZTogdGVzdFVzZXIubmFtZSxcbiAgICAgICAgICByb2xlOiB0ZXN0VXNlci5yb2xlLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcblxuICBkZXNjcmliZSgnTmV3c2xldHRlciBFbWFpbCBUZXN0cycsICgpID0+IHtcbiAgICBpdCgnc2VuZHMgbmV3c2xldHRlciB3aXRoIFBERiBhdHRhY2htZW50IHRvIHBhcmVudCBjb250YWN0cycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIENyZWF0ZSB0ZXN0IHN0dWRlbnRzIGFuZCBwYXJlbnQgY29udGFjdHNcbiAgICAgIGNvbnN0IHN0dWRlbnQxID0gYXdhaXQgcHJpc21hLnN0dWRlbnQuY3JlYXRlKHtcbiAgICAgICAgZGF0YTogeyBmaXJzdE5hbWU6ICdKb2huJywgbGFzdE5hbWU6ICdKcicsIGdyYWRlOiAxLCB1c2VySWQ6IHVzZXIuaWQgfSxcbiAgICAgIH0pO1xuICAgICAgY29uc3Qgc3R1ZGVudDIgPSBhd2FpdCBwcmlzbWEuc3R1ZGVudC5jcmVhdGUoe1xuICAgICAgICBkYXRhOiB7IGZpcnN0TmFtZTogJ0phbmUnLCBsYXN0TmFtZTogJ0pyJywgZ3JhZGU6IDEsIHVzZXJJZDogdXNlci5pZCB9LFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHBhcmVudENvbnRhY3RzID0gW1xuICAgICAgICB7XG4gICAgICAgICAgbmFtZTogJ0pvaG4gUGFyZW50JyxcbiAgICAgICAgICBlbWFpbDogZ2VuZXJhdGVUZXN0RW1haWwoKSxcbiAgICAgICAgICBzdHVkZW50SWQ6IHN0dWRlbnQxLmlkLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgbmFtZTogJ0phbmUgUGFyZW50JyxcbiAgICAgICAgICBlbWFpbDogZ2VuZXJhdGVUZXN0RW1haWwoKSxcbiAgICAgICAgICBzdHVkZW50SWQ6IHN0dWRlbnQyLmlkLFxuICAgICAgICB9LFxuICAgICAgXTtcblxuICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgIHBhcmVudENvbnRhY3RzLm1hcCgoY29udGFjdCkgPT4gcHJpc21hLnBhcmVudENvbnRhY3QuY3JlYXRlKHsgZGF0YTogY29udGFjdCB9KSksXG4gICAgICApO1xuXG4gICAgICAvLyBDcmVhdGUgbmV3c2xldHRlclxuICAgICAgY29uc3QgbmV3c2xldHRlciA9IGF3YWl0IHByaXNtYS5uZXdzbGV0dGVyLmNyZWF0ZSh7XG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICB0aXRsZTogJ1dlZWtseSBOZXdzbGV0dGVyIC0gVGVzdCBFZGl0aW9uJyxcbiAgICAgICAgICBjb250ZW50OlxuICAgICAgICAgICAgJzxoMT5XZWVrbHkgTmV3c2xldHRlcjwvaDE+PHA+VGhpcyBpcyBhIHRlc3QgbmV3c2xldHRlciB3aXRoIGltcG9ydGFudCB1cGRhdGVzLjwvcD4nLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFNlbmQgbmV3c2xldHRlclxuICAgICAgY29uc3Qgc2VuZFJlcyA9IGF3YWl0IGF1dGhcbiAgICAgICAgLnBvc3QoYC9hcGkvbmV3c2xldHRlcnMvJHtuZXdzbGV0dGVyLmlkfS9zZW5kYClcbiAgICAgICAgLnNldCgnQXV0aG9yaXphdGlvbicsIGBCZWFyZXIgJHt0ZWFjaGVyVG9rZW59YCk7XG5cbiAgICAgIGV4cGVjdChzZW5kUmVzLnN0YXR1cykudG9CZSgyMDApO1xuICAgICAgZXhwZWN0KHNlbmRSZXMuYm9keS5zZW50KS50b0JlKDIpO1xuXG4gICAgICAvLyBWZXJpZnkgZW1haWxzIHdlcmUgc2VudFxuICAgICAgY29uc3QgZW1haWxzID0gYXdhaXQgdGVzdEVtYWlsU2VydmljZS5nZXRFbWFpbHMoKTtcbiAgICAgIGV4cGVjdChlbWFpbHMpLnRvSGF2ZUxlbmd0aCgyKTtcblxuICAgICAgLy8gQ2hlY2sgZmlyc3QgZW1haWxcbiAgICAgIGNvbnN0IGZpcnN0RW1haWwgPSBlbWFpbHMuZmluZCgoZW1haWwpID0+IGVtYWlsLnRvLmluY2x1ZGVzKHBhcmVudENvbnRhY3RzWzBdLmVtYWlsKSk7XG4gICAgICBleHBlY3QoZmlyc3RFbWFpbCkudG9CZURlZmluZWQoKTtcblxuICAgICAgZXhwZWN0RW1haWxDb250ZW50KGZpcnN0RW1haWwhLCB7XG4gICAgICAgIHN1YmplY3Q6ICdXZWVrbHkgTmV3c2xldHRlciAtIFRlc3QgRWRpdGlvbicsXG4gICAgICAgIHRleHQ6ICdQbGVhc2Ugc2VlIHRoZSBhdHRhY2hlZCBuZXdzbGV0dGVyLicsXG4gICAgICB9KTtcblxuICAgICAgLy8gVmVyaWZ5IFBERiBhdHRhY2htZW50XG4gICAgICBleHBlY3QoZmlyc3RFbWFpbCEuYXR0YWNobWVudHMpLnRvSGF2ZUxlbmd0aCgxKTtcbiAgICAgIGNvbnN0IGF0dGFjaG1lbnQgPSBmaXJzdEVtYWlsIS5hdHRhY2htZW50cyFbMF07XG4gICAgICBleHBlY3QoYXR0YWNobWVudC5maWxlbmFtZSkudG9CZSgnbmV3c2xldHRlci5wZGYnKTtcbiAgICAgIGV4cGVjdChhdHRhY2htZW50LmNvbnRlbnRUeXBlKS50b0NvbnRhaW4oJ3BkZicpO1xuICAgICAgZXhwZWN0KGF0dGFjaG1lbnQuY29udGVudCkudG9CZUluc3RhbmNlT2YoQnVmZmVyKTtcbiAgICAgIGV4cGVjdChhdHRhY2htZW50LmNvbnRlbnQubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XG4gICAgfSk7XG5cbiAgICBpdCgnaGFuZGxlcyBuZXdzbGV0dGVyIHNlbmRpbmcgd2l0aCBubyBwYXJlbnQgY29udGFjdHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBDcmVhdGUgbmV3c2xldHRlciB3aXRob3V0IGFueSBwYXJlbnQgY29udGFjdHNcbiAgICAgIGNvbnN0IG5ld3NsZXR0ZXIgPSBhd2FpdCBwcmlzbWEubmV3c2xldHRlci5jcmVhdGUoe1xuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgdGl0bGU6ICdFbXB0eSBOZXdzbGV0dGVyJyxcbiAgICAgICAgICBjb250ZW50OiAnPHA+VGVzdCBjb250ZW50PC9wPicsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgY29uc3Qgc2VuZFJlcyA9IGF3YWl0IGF1dGhcbiAgICAgICAgLnBvc3QoYC9hcGkvbmV3c2xldHRlcnMvJHtuZXdzbGV0dGVyLmlkfS9zZW5kYClcbiAgICAgICAgLnNldCgnQXV0aG9yaXphdGlvbicsIGBCZWFyZXIgJHt0ZWFjaGVyVG9rZW59YCk7XG5cbiAgICAgIGV4cGVjdChzZW5kUmVzLnN0YXR1cykudG9CZSgyMDApO1xuICAgICAgZXhwZWN0KHNlbmRSZXMuYm9keS5zZW50KS50b0JlKDApO1xuXG4gICAgICAvLyBWZXJpZnkgbm8gZW1haWxzIHdlcmUgc2VudFxuICAgICAgY29uc3QgZW1haWxzID0gYXdhaXQgdGVzdEVtYWlsU2VydmljZS5nZXRFbWFpbHMoKTtcbiAgICAgIGV4cGVjdChlbWFpbHMpLnRvSGF2ZUxlbmd0aCgwKTtcbiAgICB9KTtcblxuICAgIGl0KCdoYW5kbGVzIG5ld3NsZXR0ZXIgc2VuZGluZyBmYWlsdXJlcyBncmFjZWZ1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQ3JlYXRlIHN0dWRlbnRzIGFuZCBwYXJlbnQgY29udGFjdHMgd2l0aCBpbnZhbGlkIGVtYWlsIGZvcm1hdFxuICAgICAgY29uc3QgdmFsaWRTdHVkZW50ID0gYXdhaXQgcHJpc21hLnN0dWRlbnQuY3JlYXRlKHtcbiAgICAgICAgZGF0YTogeyBmaXJzdE5hbWU6ICdWYWxpZCcsIGxhc3ROYW1lOiAnU3R1ZGVudCcsIGdyYWRlOiAxLCB1c2VySWQ6IHVzZXIuaWQgfSxcbiAgICAgIH0pO1xuICAgICAgY29uc3QgaW52YWxpZFN0dWRlbnQgPSBhd2FpdCBwcmlzbWEuc3R1ZGVudC5jcmVhdGUoe1xuICAgICAgICBkYXRhOiB7IGZpcnN0TmFtZTogJ0ludmFsaWQnLCBsYXN0TmFtZTogJ1N0dWRlbnQnLCBncmFkZTogMSwgdXNlcklkOiB1c2VyLmlkIH0sXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcGFyZW50Q29udGFjdHMgPSBbXG4gICAgICAgIHtcbiAgICAgICAgICBuYW1lOiAnVmFsaWQgUGFyZW50JyxcbiAgICAgICAgICBlbWFpbDogZ2VuZXJhdGVUZXN0RW1haWwoKSxcbiAgICAgICAgICBzdHVkZW50SWQ6IHZhbGlkU3R1ZGVudC5pZCxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIG5hbWU6ICdJbnZhbGlkIFBhcmVudCcsXG4gICAgICAgICAgZW1haWw6ICdpbnZhbGlkLWVtYWlsJyxcbiAgICAgICAgICBzdHVkZW50SWQ6IGludmFsaWRTdHVkZW50LmlkLFxuICAgICAgICB9LFxuICAgICAgXTtcblxuICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgIHBhcmVudENvbnRhY3RzLm1hcCgoY29udGFjdCkgPT4gcHJpc21hLnBhcmVudENvbnRhY3QuY3JlYXRlKHsgZGF0YTogY29udGFjdCB9KSksXG4gICAgICApO1xuXG4gICAgICBjb25zdCBuZXdzbGV0dGVyID0gYXdhaXQgcHJpc21hLm5ld3NsZXR0ZXIuY3JlYXRlKHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIHRpdGxlOiAnVGVzdCBOZXdzbGV0dGVyJyxcbiAgICAgICAgICBjb250ZW50OiAnPHA+VGVzdCBjb250ZW50PC9wPicsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgLy8gTmV3c2xldHRlciBzZW5kaW5nIHNob3VsZCBub3QgZmFpbCBjb21wbGV0ZWx5XG4gICAgICBjb25zdCBzZW5kUmVzID0gYXdhaXQgYXV0aFxuICAgICAgICAucG9zdChgL2FwaS9uZXdzbGV0dGVycy8ke25ld3NsZXR0ZXIuaWR9L3NlbmRgKVxuICAgICAgICAuc2V0KCdBdXRob3JpemF0aW9uJywgYEJlYXJlciAke3RlYWNoZXJUb2tlbn1gKTtcblxuICAgICAgZXhwZWN0KHNlbmRSZXMuc3RhdHVzKS50b0JlKDIwMCk7XG4gICAgICAvLyBTaG91bGQgcmVwb3J0IGF0dGVtcHRlZCBzZW5kcyBldmVuIGlmIHNvbWUgZmFpbFxuICAgICAgZXhwZWN0KHNlbmRSZXMuYm9keS5zZW50KS50b0JlKDIpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnQnVsayBFbWFpbCBPcGVyYXRpb25zJywgKCkgPT4ge1xuICAgIGl0KCdzZW5kcyBidWxrIGVtYWlscyB0byBtdWx0aXBsZSByZWNpcGllbnRzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVjaXBpZW50cyA9IFtnZW5lcmF0ZVRlc3RFbWFpbCgpLCBnZW5lcmF0ZVRlc3RFbWFpbCgpLCBnZW5lcmF0ZVRlc3RFbWFpbCgpXTtcblxuICAgICAgY29uc3Qgc3ViamVjdCA9ICdCdWxrIEVtYWlsIFRlc3QnO1xuICAgICAgY29uc3QgdGV4dCA9ICdUaGlzIGlzIGEgYnVsayBlbWFpbCB0ZXN0IG1lc3NhZ2UnO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0ZXN0RW1haWxTZXJ2aWNlLnNlbmRCdWxrRW1haWxzKHJlY2lwaWVudHMsIHN1YmplY3QsIHRleHQpO1xuXG4gICAgICBleHBlY3QocmVzdWx0LnNlbnQpLnRvQmUoMyk7XG4gICAgICBleHBlY3QocmVzdWx0LmZhaWxlZCkudG9IYXZlTGVuZ3RoKDApO1xuXG4gICAgICAvLyBWZXJpZnkgYWxsIGVtYWlscyB3ZXJlIHNlbnRcbiAgICAgIGNvbnN0IGVtYWlscyA9IGF3YWl0IHRlc3RFbWFpbFNlcnZpY2UuZ2V0RW1haWxzKCk7XG4gICAgICBleHBlY3QoZW1haWxzKS50b0hhdmVMZW5ndGgoMyk7XG5cbiAgICAgIHJlY2lwaWVudHMuZm9yRWFjaCgocmVjaXBpZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IGVtYWlsID0gZW1haWxzLmZpbmQoKGUpID0+IGUudG8uaW5jbHVkZXMocmVjaXBpZW50KSk7XG4gICAgICAgIGV4cGVjdChlbWFpbCkudG9CZURlZmluZWQoKTtcbiAgICAgICAgZXhwZWN0RW1haWxDb250ZW50KGVtYWlsISwge1xuICAgICAgICAgIHN1YmplY3QsXG4gICAgICAgICAgdGV4dCxcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdoYW5kbGVzIHBhcnRpYWwgZmFpbHVyZXMgaW4gYnVsayBlbWFpbCBzZW5kaW5nJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgdmFsaWRSZWNpcGllbnRzID0gW2dlbmVyYXRlVGVzdEVtYWlsKCksIGdlbmVyYXRlVGVzdEVtYWlsKCldO1xuICAgICAgY29uc3QgaW52YWxpZFJlY2lwaWVudHMgPSBbJ2ludmFsaWQtZW1haWwtMScsICdpbnZhbGlkLWVtYWlsLTInXTtcbiAgICAgIGNvbnN0IGFsbFJlY2lwaWVudHMgPSBbLi4udmFsaWRSZWNpcGllbnRzLCAuLi5pbnZhbGlkUmVjaXBpZW50c107XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRlc3RFbWFpbFNlcnZpY2Uuc2VuZEJ1bGtFbWFpbHMoXG4gICAgICAgIGFsbFJlY2lwaWVudHMsXG4gICAgICAgICdCdWxrIFRlc3QnLFxuICAgICAgICAnVGVzdCBtZXNzYWdlJyxcbiAgICAgICk7XG5cbiAgICAgIC8vIFNob3VsZCBoYXZlIHNvbWUgc3VjY2Vzc2VzIGFuZCBzb21lIGZhaWx1cmVzXG4gICAgICBleHBlY3QocmVzdWx0LnNlbnQpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuZmFpbGVkKS50b0hhdmVMZW5ndGgoMik7XG4gICAgICBleHBlY3QocmVzdWx0LmZhaWxlZCkudG9FcXVhbChleHBlY3QuYXJyYXlDb250YWluaW5nKGludmFsaWRSZWNpcGllbnRzKSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdFbWFpbCBSZXRyeSBNZWNoYW5pc20nLCAoKSA9PiB7XG4gICAgaXQoJ3JldHJpZXMgZmFpbGVkIGVtYWlsIHNlbmRzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVjaXBpZW50ID0gZ2VuZXJhdGVUZXN0RW1haWwoKTtcbiAgICAgIGNvbnN0IHN1YmplY3QgPSAnUmV0cnkgVGVzdCc7XG4gICAgICBjb25zdCB0ZXh0ID0gJ1RoaXMgZW1haWwgc2hvdWxkIGJlIHJldHJpZWQnO1xuXG4gICAgICAvLyBGaXJzdCBhdHRlbXB0IHNob3VsZCBzdWNjZWVkIGFmdGVyIHJldHJpZXNcbiAgICAgIGF3YWl0IGV4cGVjdChcbiAgICAgICAgdGVzdEVtYWlsU2VydmljZS5zZW5kRW1haWxXaXRoUmV0cnkocmVjaXBpZW50LCBzdWJqZWN0LCB0ZXh0LCB1bmRlZmluZWQsIDMsIDEwMCksXG4gICAgICApLnJlc29sdmVzLm5vdC50b1Rocm93KCk7XG5cbiAgICAgIC8vIFZlcmlmeSBlbWFpbCB3YXMgZXZlbnR1YWxseSBzZW50XG4gICAgICBjb25zdCBlbWFpbHMgPSBhd2FpdCB0ZXN0RW1haWxTZXJ2aWNlLmdldEVtYWlscygpO1xuICAgICAgZXhwZWN0KGVtYWlscykudG9IYXZlTGVuZ3RoKDEpO1xuICAgICAgZXhwZWN0RW1haWxDb250ZW50KGVtYWlsc1swXSwge1xuICAgICAgICB0bzogW3JlY2lwaWVudF0sXG4gICAgICAgIHN1YmplY3QsXG4gICAgICAgIHRleHQsXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIC8qKlxuICAgICAqIEB0b2RvIFRoaXMgdGVzdCB1c2VzIGplc3Quc3B5T24gYW5kIHNob3VsZCB0ZXN0IHJlYWwgcmV0cnkgYmVoYXZpb3JcbiAgICAgKiBAbW9ja2VkIHNlbmRFbWFpbCAtIHByZXZlbnRzIHRlc3RpbmcgYWN0dWFsIHJldHJ5IG1lY2hhbmlzbSB3aXRoIHJlYWwgZW1haWwgc2VydmljZVxuICAgICAqIEBub3QtZnVsbHktaW1wbGVtZW50ZWQgLSBzaG91bGQgdGVzdCByZXRyaWVzIHdpdGggYWN0dWFsIG5ldHdvcmsgZmFpbHVyZXNcbiAgICAgKi9cbiAgICBpdCgnZmFpbHMgYWZ0ZXIgbWF4aW11bSByZXRyeSBhdHRlbXB0cycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIE1vY2sgdGhlIHNlbmQgZnVuY3Rpb24gdG8gYWx3YXlzIGZhaWxcbiAgICAgIGNvbnN0IG9yaWdpbmFsU2VuZCA9IHRlc3RFbWFpbFNlcnZpY2Uuc2VuZEVtYWlsO1xuICAgICAgamVzdC5zcHlPbih0ZXN0RW1haWxTZXJ2aWNlLCAnc2VuZEVtYWlsJykubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKCdOZXR3b3JrIGVycm9yJykpO1xuXG4gICAgICBjb25zdCByZWNpcGllbnQgPSBnZW5lcmF0ZVRlc3RFbWFpbCgpO1xuXG4gICAgICBhd2FpdCBleHBlY3QoXG4gICAgICAgIHRlc3RFbWFpbFNlcnZpY2Uuc2VuZEVtYWlsV2l0aFJldHJ5KFxuICAgICAgICAgIHJlY2lwaWVudCxcbiAgICAgICAgICAnRmFpbCBUZXN0JyxcbiAgICAgICAgICAnU2hvdWxkIGZhaWwnLFxuICAgICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgICAyLFxuICAgICAgICAgIDUwLFxuICAgICAgICApLFxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coJ0ZhaWxlZCB0byBzZW5kIGVtYWlsIGFmdGVyIDIgYXR0ZW1wdHMnKTtcblxuICAgICAgLy8gUmVzdG9yZSBvcmlnaW5hbCBmdW5jdGlvblxuICAgICAgamVzdC5zcHlPbih0ZXN0RW1haWxTZXJ2aWNlLCAnc2VuZEVtYWlsJykubW9ja0ltcGxlbWVudGF0aW9uKG9yaWdpbmFsU2VuZCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdFbWFpbCBDb250ZW50IGFuZCBGb3JtYXR0aW5nJywgKCkgPT4ge1xuICAgIGl0KCdwcmVzZXJ2ZXMgZW1haWwgY29udGVudCBmb3JtYXR0aW5nJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVjaXBpZW50ID0gZ2VuZXJhdGVUZXN0RW1haWwoKTtcbiAgICAgIGNvbnN0IHN1YmplY3QgPSAnRm9ybWF0dGluZyBUZXN0JztcbiAgICAgIGNvbnN0IHRleHQgPSBgVGhpcyBpcyBhIG11bHRpLWxpbmUgZW1haWxcbiAgICAgIFxuICAgICAgV2l0aCBwcm9wZXIgZm9ybWF0dGluZzpcbiAgICAgIC0gQnVsbGV0IHBvaW50IDFcbiAgICAgIC0gQnVsbGV0IHBvaW50IDJcbiAgICAgIFxuICAgICAgQW5kIHNwZWNpYWwgY2hhcmFjdGVyczogw6HDqcOtw7PDuiAmIDxzeW1ib2xzPmA7XG5cbiAgICAgIGF3YWl0IHRlc3RFbWFpbFNlcnZpY2Uuc2VuZEVtYWlsKHJlY2lwaWVudCwgc3ViamVjdCwgdGV4dCk7XG5cbiAgICAgIGNvbnN0IGVtYWlscyA9IGF3YWl0IHRlc3RFbWFpbFNlcnZpY2UuZ2V0RW1haWxzKCk7XG4gICAgICBleHBlY3QoZW1haWxzKS50b0hhdmVMZW5ndGgoMSk7XG5cbiAgICAgIGNvbnN0IGVtYWlsID0gZW1haWxzWzBdO1xuICAgICAgZXhwZWN0KGVtYWlsLnRleHQpLnRvQmUodGV4dCk7XG4gICAgICBleHBlY3QoZW1haWwuc3ViamVjdCkudG9CZShzdWJqZWN0KTtcbiAgICB9KTtcblxuICAgIGl0KCdoYW5kbGVzIEhUTUwgY29udGVudCBpbiBuZXdzbGV0dGVycycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGh0bWxTdHVkZW50ID0gYXdhaXQgcHJpc21hLnN0dWRlbnQuY3JlYXRlKHtcbiAgICAgICAgZGF0YTogeyBmaXJzdE5hbWU6ICdIVE1MJywgbGFzdE5hbWU6ICdTdHVkZW50JywgZ3JhZGU6IDEsIHVzZXJJZDogdXNlci5pZCB9LFxuICAgICAgfSk7XG4gICAgICBhd2FpdCBwcmlzbWEucGFyZW50Q29udGFjdC5jcmVhdGUoe1xuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgbmFtZTogJ0hUTUwgUGFyZW50JyxcbiAgICAgICAgICBlbWFpbDogZ2VuZXJhdGVUZXN0RW1haWwoKSxcbiAgICAgICAgICBzdHVkZW50SWQ6IGh0bWxTdHVkZW50LmlkLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGh0bWxDb250ZW50ID0gYFxuICAgICAgICA8aHRtbD5cbiAgICAgICAgICA8Ym9keT5cbiAgICAgICAgICAgIDxoMSBzdHlsZT1cImNvbG9yOiBibHVlO1wiPldlZWtseSBOZXdzbGV0dGVyPC9oMT5cbiAgICAgICAgICAgIDxwPlRoaXMgbmV3c2xldHRlciBjb250YWlucyA8c3Ryb25nPkhUTUwgZm9ybWF0dGluZzwvc3Ryb25nPi48L3A+XG4gICAgICAgICAgICA8dWw+XG4gICAgICAgICAgICAgIDxsaT5JdGVtIDE8L2xpPlxuICAgICAgICAgICAgICA8bGk+SXRlbSAyPC9saT5cbiAgICAgICAgICAgIDwvdWw+XG4gICAgICAgICAgPC9ib2R5PlxuICAgICAgICA8L2h0bWw+XG4gICAgICBgO1xuXG4gICAgICBjb25zdCBuZXdzbGV0dGVyID0gYXdhaXQgcHJpc21hLm5ld3NsZXR0ZXIuY3JlYXRlKHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIHRpdGxlOiAnSFRNTCBOZXdzbGV0dGVyJyxcbiAgICAgICAgICBjb250ZW50OiBodG1sQ29udGVudCxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBhd2FpdCBhdXRoXG4gICAgICAgIC5wb3N0KGAvYXBpL25ld3NsZXR0ZXJzLyR7bmV3c2xldHRlci5pZH0vc2VuZGApXG4gICAgICAgIC5zZXQoJ0F1dGhvcml6YXRpb24nLCBgQmVhcmVyICR7dGVhY2hlclRva2VufWApO1xuXG4gICAgICBjb25zdCBlbWFpbHMgPSBhd2FpdCB0ZXN0RW1haWxTZXJ2aWNlLmdldEVtYWlscygpO1xuICAgICAgZXhwZWN0KGVtYWlscykudG9IYXZlTGVuZ3RoKDEpO1xuXG4gICAgICBjb25zdCBlbWFpbCA9IGVtYWlsc1swXTtcbiAgICAgIGV4cGVjdChlbWFpbC5odG1sIHx8IGVtYWlsLnRleHQpLnRvQ29udGFpbignV2Vla2x5IE5ld3NsZXR0ZXInKTtcbiAgICAgIGV4cGVjdChlbWFpbC5odG1sIHx8IGVtYWlsLnRleHQpLnRvQ29udGFpbignSFRNTCBmb3JtYXR0aW5nJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnaGFuZGxlcyBVbmljb2RlIGNoYXJhY3RlcnMgY29ycmVjdGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVjaXBpZW50ID0gZ2VuZXJhdGVUZXN0RW1haWwoKTtcbiAgICAgIGNvbnN0IHN1YmplY3QgPSAnVW5pY29kZSBUZXN0OiDDqW1vamlzIPCfjokgZnJhbsOnYWlzJztcbiAgICAgIGNvbnN0IHRleHQgPSAnQm9uam91ciEgVm9pY2kgdW4gdGVzdCBhdmVjIGRlcyBjYXJhY3TDqHJlcyBzcMOpY2lhdXg6IMOgw6HDosOjw6TDpcOmw6fDqMOpw6rDqyDwn4yfJztcblxuICAgICAgYXdhaXQgdGVzdEVtYWlsU2VydmljZS5zZW5kRW1haWwocmVjaXBpZW50LCBzdWJqZWN0LCB0ZXh0KTtcblxuICAgICAgY29uc3QgZW1haWxzID0gYXdhaXQgdGVzdEVtYWlsU2VydmljZS5nZXRFbWFpbHMoKTtcbiAgICAgIGV4cGVjdChlbWFpbHMpLnRvSGF2ZUxlbmd0aCgxKTtcblxuICAgICAgY29uc3QgZW1haWwgPSBlbWFpbHNbMF07XG4gICAgICBleHBlY3QoZW1haWwuc3ViamVjdCkudG9CZShzdWJqZWN0KTtcbiAgICAgIGV4cGVjdChlbWFpbC50ZXh0KS50b0JlKHRleHQpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnRW1haWwgQXR0YWNobWVudCBIYW5kbGluZycsICgpID0+IHtcbiAgICBpdCgnaGFuZGxlcyBQREYgYXR0YWNobWVudHMgY29ycmVjdGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVjaXBpZW50ID0gZ2VuZXJhdGVUZXN0RW1haWwoKTtcbiAgICAgIGNvbnN0IHN1YmplY3QgPSAnUERGIFRlc3QnO1xuICAgICAgY29uc3QgdGV4dCA9ICdFbWFpbCB3aXRoIFBERiBhdHRhY2htZW50JztcblxuICAgICAgLy8gQ3JlYXRlIGEgc2ltcGxlIFBERiBidWZmZXIgKG1vY2sgUERGIGNvbnRlbnQpXG4gICAgICBjb25zdCBwZGZDb250ZW50ID0gQnVmZmVyLmZyb20oXG4gICAgICAgICclUERGLTEuNFxcbjEgMCBvYmpcXG48PCAvVHlwZSAvQ2F0YWxvZyAvUGFnZXMgMiAwIFIgPj5cXG5lbmRvYmpcXG4lJUVPRicsXG4gICAgICApO1xuICAgICAgY29uc3QgYXR0YWNobWVudCA9IHtcbiAgICAgICAgZmlsZW5hbWU6ICd0ZXN0LWRvY3VtZW50LnBkZicsXG4gICAgICAgIGNvbnRlbnQ6IHBkZkNvbnRlbnQsXG4gICAgICB9O1xuXG4gICAgICBhd2FpdCB0ZXN0RW1haWxTZXJ2aWNlLnNlbmRFbWFpbChyZWNpcGllbnQsIHN1YmplY3QsIHRleHQsIHVuZGVmaW5lZCwgYXR0YWNobWVudCk7XG5cbiAgICAgIGNvbnN0IGVtYWlscyA9IGF3YWl0IHRlc3RFbWFpbFNlcnZpY2UuZ2V0RW1haWxzKCk7XG4gICAgICBleHBlY3QoZW1haWxzKS50b0hhdmVMZW5ndGgoMSk7XG5cbiAgICAgIGNvbnN0IGVtYWlsID0gZW1haWxzWzBdO1xuICAgICAgZXhwZWN0KGVtYWlsLmF0dGFjaG1lbnRzKS50b0hhdmVMZW5ndGgoMSk7XG5cbiAgICAgIGNvbnN0IHJlY2VpdmVkQXR0YWNobWVudCA9IGVtYWlsLmF0dGFjaG1lbnRzIVswXTtcbiAgICAgIGV4cGVjdChyZWNlaXZlZEF0dGFjaG1lbnQuZmlsZW5hbWUpLnRvQmUoJ3Rlc3QtZG9jdW1lbnQucGRmJyk7XG4gICAgICBleHBlY3QocmVjZWl2ZWRBdHRhY2htZW50LmNvbnRlbnQpLnRvRXF1YWwocGRmQ29udGVudCk7XG4gICAgICBleHBlY3QocmVjZWl2ZWRBdHRhY2htZW50LmNvbnRlbnRUeXBlKS50b0NvbnRhaW4oJ3BkZicpO1xuICAgIH0pO1xuXG4gICAgaXQoJ2hhbmRsZXMgbXVsdGlwbGUgYXR0YWNobWVudHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZWNpcGllbnQgPSBnZW5lcmF0ZVRlc3RFbWFpbCgpO1xuICAgICAgY29uc3Qgc3ViamVjdCA9ICdNdWx0aXBsZSBBdHRhY2htZW50cyBUZXN0JztcbiAgICAgIGNvbnN0IHRleHQgPSAnRW1haWwgd2l0aCBtdWx0aXBsZSBhdHRhY2htZW50cyc7XG5cbiAgICAgIC8vIEZvciB0aGlzIHRlc3QsIHdlJ2xsIHNpbXVsYXRlIG11bHRpcGxlIGF0dGFjaG1lbnRzIGJ5IHNlbmRpbmcgbXVsdGlwbGUgZW1haWxzXG4gICAgICAvLyBJbiBhIHJlYWwgc2NlbmFyaW8sIHlvdSdkIG1vZGlmeSB0aGUgc2VuZEVtYWlsIGZ1bmN0aW9uIHRvIGFjY2VwdCBtdWx0aXBsZSBhdHRhY2htZW50c1xuICAgICAgY29uc3QgYXR0YWNobWVudDEgPSB7XG4gICAgICAgIGZpbGVuYW1lOiAnZG9jdW1lbnQxLnBkZicsXG4gICAgICAgIGNvbnRlbnQ6IEJ1ZmZlci5mcm9tKCdQREYgY29udGVudCAxJyksXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBhdHRhY2htZW50MiA9IHtcbiAgICAgICAgZmlsZW5hbWU6ICdkb2N1bWVudDIucGRmJyxcbiAgICAgICAgY29udGVudDogQnVmZmVyLmZyb20oJ1BERiBjb250ZW50IDInKSxcbiAgICAgIH07XG5cbiAgICAgIC8vIFNlbmQgZmlyc3QgZW1haWwgd2l0aCBmaXJzdCBhdHRhY2htZW50XG4gICAgICBhd2FpdCB0ZXN0RW1haWxTZXJ2aWNlLnNlbmRFbWFpbChyZWNpcGllbnQsIHN1YmplY3QgKyAnIDEnLCB0ZXh0LCB1bmRlZmluZWQsIGF0dGFjaG1lbnQxKTtcblxuICAgICAgLy8gU2VuZCBzZWNvbmQgZW1haWwgd2l0aCBzZWNvbmQgYXR0YWNobWVudFxuICAgICAgYXdhaXQgdGVzdEVtYWlsU2VydmljZS5zZW5kRW1haWwocmVjaXBpZW50LCBzdWJqZWN0ICsgJyAyJywgdGV4dCwgdW5kZWZpbmVkLCBhdHRhY2htZW50Mik7XG5cbiAgICAgIGNvbnN0IGVtYWlscyA9IGF3YWl0IHRlc3RFbWFpbFNlcnZpY2UuZ2V0RW1haWxzKCk7XG4gICAgICBleHBlY3QoZW1haWxzKS50b0hhdmVMZW5ndGgoMik7XG5cbiAgICAgIC8vIFZlcmlmeSBib3RoIGF0dGFjaG1lbnRzIHdlcmUgc2VudCBjb3JyZWN0bHlcbiAgICAgIGNvbnN0IGVtYWlsMSA9IGVtYWlscy5maW5kKChlKSA9PiBlLnN1YmplY3QuaW5jbHVkZXMoJzEnKSk7XG4gICAgICBjb25zdCBlbWFpbDIgPSBlbWFpbHMuZmluZCgoZSkgPT4gZS5zdWJqZWN0LmluY2x1ZGVzKCcyJykpO1xuXG4gICAgICBleHBlY3QoZW1haWwxPy5hdHRhY2htZW50cz8uWzBdLmZpbGVuYW1lKS50b0JlKCdkb2N1bWVudDEucGRmJyk7XG4gICAgICBleHBlY3QoZW1haWwyPy5hdHRhY2htZW50cz8uWzBdLmZpbGVuYW1lKS50b0JlKCdkb2N1bWVudDIucGRmJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnaGFuZGxlcyBhdHRhY2htZW50IGVuY29kaW5nIGNvcnJlY3RseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHJlY2lwaWVudCA9IGdlbmVyYXRlVGVzdEVtYWlsKCk7XG4gICAgICBjb25zdCBzdWJqZWN0ID0gJ0VuY29kaW5nIFRlc3QnO1xuICAgICAgY29uc3QgdGV4dCA9ICdFbWFpbCB3aXRoIGJpbmFyeSBhdHRhY2htZW50JztcblxuICAgICAgLy8gQ3JlYXRlIGJpbmFyeSBjb250ZW50IHdpdGggdmFyaW91cyBieXRlIHZhbHVlc1xuICAgICAgY29uc3QgYmluYXJ5Q29udGVudCA9IEJ1ZmZlci5mcm9tKFswLCAxLCAyLCAzLCAyNTUsIDI1NCwgMjUzLCAyNTIsIDEyNywgMTI4LCAxMjldKTtcbiAgICAgIGNvbnN0IGF0dGFjaG1lbnQgPSB7XG4gICAgICAgIGZpbGVuYW1lOiAnYmluYXJ5LWZpbGUuYmluJyxcbiAgICAgICAgY29udGVudDogYmluYXJ5Q29udGVudCxcbiAgICAgIH07XG5cbiAgICAgIGF3YWl0IHRlc3RFbWFpbFNlcnZpY2Uuc2VuZEVtYWlsKHJlY2lwaWVudCwgc3ViamVjdCwgdGV4dCwgdW5kZWZpbmVkLCBhdHRhY2htZW50KTtcblxuICAgICAgY29uc3QgZW1haWxzID0gYXdhaXQgdGVzdEVtYWlsU2VydmljZS5nZXRFbWFpbHMoKTtcbiAgICAgIGV4cGVjdChlbWFpbHMpLnRvSGF2ZUxlbmd0aCgxKTtcblxuICAgICAgY29uc3QgZW1haWwgPSBlbWFpbHNbMF07XG4gICAgICBjb25zdCByZWNlaXZlZEF0dGFjaG1lbnQgPSBlbWFpbC5hdHRhY2htZW50cyFbMF07XG4gICAgICBleHBlY3QocmVjZWl2ZWRBdHRhY2htZW50LmNvbnRlbnQpLnRvRXF1YWwoYmluYXJ5Q29udGVudCk7XG4gICAgfSk7XG5cbiAgICBpdCgnaGFuZGxlcyBlbXB0eSBhdHRhY2htZW50cyBncmFjZWZ1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVjaXBpZW50ID0gZ2VuZXJhdGVUZXN0RW1haWwoKTtcbiAgICAgIGNvbnN0IHN1YmplY3QgPSAnRW1wdHkgQXR0YWNobWVudCBUZXN0JztcbiAgICAgIGNvbnN0IHRleHQgPSAnRW1haWwgd2l0aCBlbXB0eSBhdHRhY2htZW50JztcblxuICAgICAgY29uc3QgYXR0YWNobWVudCA9IHtcbiAgICAgICAgZmlsZW5hbWU6ICdlbXB0eS1maWxlLnR4dCcsXG4gICAgICAgIGNvbnRlbnQ6IEJ1ZmZlci5hbGxvYygwKSwgLy8gRW1wdHkgYnVmZmVyXG4gICAgICB9O1xuXG4gICAgICBhd2FpdCB0ZXN0RW1haWxTZXJ2aWNlLnNlbmRFbWFpbChyZWNpcGllbnQsIHN1YmplY3QsIHRleHQsIHVuZGVmaW5lZCwgYXR0YWNobWVudCk7XG5cbiAgICAgIGNvbnN0IGVtYWlscyA9IGF3YWl0IHRlc3RFbWFpbFNlcnZpY2UuZ2V0RW1haWxzKCk7XG4gICAgICBleHBlY3QoZW1haWxzKS50b0hhdmVMZW5ndGgoMSk7XG5cbiAgICAgIGNvbnN0IGVtYWlsID0gZW1haWxzWzBdO1xuICAgICAgZXhwZWN0KGVtYWlsLmF0dGFjaG1lbnRzKS50b0hhdmVMZW5ndGgoMSk7XG4gICAgICBleHBlY3QoZW1haWwuYXR0YWNobWVudHMhWzBdLmNvbnRlbnQpLnRvSGF2ZUxlbmd0aCgwKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==