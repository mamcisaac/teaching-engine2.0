7b11cf8e9e9b189350fa30a4d11a2899
/**
 * User Routes
 * Handles user profile and account management
 */
import { Router } from 'express';
import { z } from 'zod';
import bcrypt from 'bcryptjs';
import { asyncHandler } from '@/middleware/errorHandler';
// Authentication middleware available if needed
import { validatePassword, hashPassword } from '@/services/authService';
// Use global Express Request type with user: { id: number; email: string }
const updatePasswordSchema = z.object({
    currentPassword: z.string().min(1),
    newPassword: z.string().min(8),
});
export function userRoutes(prisma) {
    const router = Router();
    // Get user profile
    router.get('/profile', asyncHandler(async (req, res) => {
        const userId = req.user.id;
        const user = await prisma.user.findUnique({
            where: { id: userId },
            select: {
                id: true,
                email: true,
                name: true,
                role: true,
            },
        });
        if (!user) {
            return res.status(404).json({ error: 'User not found' });
        }
        res.json(user);
    }));
    // Update password
    router.put('/password', asyncHandler(async (req, res) => {
        const userId = req.user.id;
        const { currentPassword, newPassword } = updatePasswordSchema.parse(req.body);
        // Validate new password
        await validatePassword(newPassword);
        // Get user with password
        const user = await prisma.user.findUnique({
            where: { id: userId },
        });
        if (!user) {
            return res.status(404).json({ error: 'User not found' });
        }
        // Verify current password
        const isValidPassword = await bcrypt.compare(currentPassword, user.password);
        if (!isValidPassword) {
            return res.status(401).json({ error: 'Current password is incorrect' });
        }
        // Hash new password
        const hashedPassword = await hashPassword(newPassword);
        // Update password
        await prisma.user.update({
            where: { id: userId },
            data: { password: hashedPassword },
        });
        res.json({ message: 'Password updated successfully' });
    }));
    // Create user (admin only)
    router.post('/create', asyncHandler(async (req, res) => {
        const userRole = req.user?.role;
        if (userRole !== 'ADMIN') {
            return res.status(403).json({ error: 'Forbidden' });
        }
        const { email, name, role } = req.body;
        // Sanitize input
        const sanitizedName = name.replace(/<[^>]*>/g, ''); // Remove HTML tags
        const user = await prisma.user.create({
            data: {
                email,
                name: sanitizedName,
                role: role || 'USER',
                password: await hashPassword('TempPassword123!'), // Temporary password
            },
        });
        const { password: _, ...userWithoutPassword } = user;
        res.status(201).json(userWithoutPassword);
    }));
    // Data validation endpoint
    router.post('/data/validate', asyncHandler(async (req, res) => {
        const data = req.body;
        // Type validation
        if (data.age !== undefined && typeof data.age !== 'number') {
            return res.status(400).json({ error: 'Invalid data type: age must be a number' });
        }
        if (data.active !== undefined && typeof data.active !== 'boolean') {
            return res.status(400).json({ error: 'Invalid data type: active must be a boolean' });
        }
        if (data.tags !== undefined && !Array.isArray(data.tags)) {
            return res.status(400).json({ error: 'Invalid data type: tags must be an array' });
        }
        if (data.metadata !== undefined && typeof data.metadata !== 'object') {
            return res.status(400).json({ error: 'Invalid data type: metadata must be an object' });
        }
        res.json({ valid: true });
    }));
    return router;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9yb3V0ZXMvdXNlci50cyIsIm1hcHBpbmdzIjoiQUFBQTs7O0dBR0c7QUFFSCxPQUFPLEVBQUUsTUFBTSxFQUFXLE1BQU0sU0FBUyxDQUFDO0FBRTFDLE9BQU8sRUFBRSxDQUFDLEVBQUUsTUFBTSxLQUFLLENBQUM7QUFDeEIsT0FBTyxNQUFNLE1BQU0sVUFBVSxDQUFDO0FBQzlCLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN6RCxnREFBZ0Q7QUFDaEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLFlBQVksRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRXhFLDJFQUEyRTtBQUUzRSxNQUFNLG9CQUFvQixHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDcEMsZUFBZSxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ2xDLFdBQVcsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztDQUMvQixDQUFDLENBQUM7QUFFSCxNQUFNLFVBQVUsVUFBVSxDQUFDLE1BQW9CO0lBQzdDLE1BQU0sTUFBTSxHQUFHLE1BQU0sRUFBRSxDQUFDO0lBRXhCLG1CQUFtQjtJQUNuQixNQUFNLENBQUMsR0FBRyxDQUNSLFVBQVUsRUFDVixZQUFZLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRTtRQUM5QixNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsSUFBSyxDQUFDLEVBQUUsQ0FBQztRQUU1QixNQUFNLElBQUksR0FBRyxNQUFNLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO1lBQ3hDLEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUU7WUFDckIsTUFBTSxFQUFFO2dCQUNOLEVBQUUsRUFBRSxJQUFJO2dCQUNSLEtBQUssRUFBRSxJQUFJO2dCQUNYLElB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QUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQ3pELE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsMENBQTBDLEVBQUUsQ0FBQyxDQUFDO1FBQ3JGLENBQUM7UUFFRCxJQUFJLElBQUksQ0FBQyxRQUFRLEtBQUssU0FBUyxJQUFJLE9BQU8sSUFBSSxDQUFDLFFBQVEsS0FBSyxRQUFRLEVBQUUsQ0FBQztZQUNyRSxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLCtDQUErQyxFQUFFLENBQUMsQ0FBQztRQUMxRixDQUFDO1FBRUQsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQzVCLENBQUMsQ0FBQyxDQUNILENBQUM7SUFFRixPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9taWNoYWVsbWNpc2FhYy9HaXRIdWIvdGVhY2hpbmctZW5naW5lMi4wL3NlcnZlci9zcmMvcm91dGVzL3VzZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBVc2VyIFJvdXRlc1xuICogSGFuZGxlcyB1c2VyIHByb2ZpbGUgYW5kIGFjY291bnQgbWFuYWdlbWVudFxuICovXG5cbmltcG9ydCB7IFJvdXRlciwgUmVxdWVzdCB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgUHJpc21hQ2xpZW50IH0gZnJvbSAnQHRlYWNoaW5nLWVuZ2luZS9kYXRhYmFzZSc7XG5pbXBvcnQgeyB6IH0gZnJvbSAnem9kJztcbmltcG9ydCBiY3J5cHQgZnJvbSAnYmNyeXB0anMnO1xuaW1wb3J0IHsgYXN5bmNIYW5kbGVyIH0gZnJvbSAnQC9taWRkbGV3YXJlL2Vycm9ySGFuZGxlcic7XG4vLyBBdXRoZW50aWNhdGlvbiBtaWRkbGV3YXJlIGF2YWlsYWJsZSBpZiBuZWVkZWRcbmltcG9ydCB7IHZhbGlkYXRlUGFzc3dvcmQsIGhhc2hQYXNzd29yZCB9IGZyb20gJ0Avc2VydmljZXMvYXV0aFNlcnZpY2UnO1xuXG4vLyBVc2UgZ2xvYmFsIEV4cHJlc3MgUmVxdWVzdCB0eXBlIHdpdGggdXNlcjogeyBpZDogbnVtYmVyOyBlbWFpbDogc3RyaW5nIH1cblxuY29uc3QgdXBkYXRlUGFzc3dvcmRTY2hlbWEgPSB6Lm9iamVjdCh7XG4gIGN1cnJlbnRQYXNzd29yZDogei5zdHJpbmcoKS5taW4oMSksXG4gIG5ld1Bhc3N3b3JkOiB6LnN0cmluZygpLm1pbig4KSxcbn0pO1xuXG5leHBvcnQgZnVuY3Rpb24gdXNlclJvdXRlcyhwcmlzbWE6IFByaXNtYUNsaWVudCk6IFJvdXRlciB7XG4gIGNvbnN0IHJvdXRlciA9IFJvdXRlcigpO1xuXG4gIC8vIEdldCB1c2VyIHByb2ZpbGVcbiAgcm91dGVyLmdldChcbiAgICAnL3Byb2ZpbGUnLFxuICAgIGFzeW5jSGFuZGxlcihhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyIS5pZDtcblxuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHByaXNtYS51c2VyLmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyBpZDogdXNlcklkIH0sXG4gICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgIGVtYWlsOiB0cnVlLFxuICAgICAgICAgIG5hbWU6IHRydWUsXG4gICAgICAgICAgcm9sZTogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIXVzZXIpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgZXJyb3I6ICdVc2VyIG5vdCBmb3VuZCcgfSk7XG4gICAgICB9XG5cbiAgICAgIHJlcy5qc29uKHVzZXIpO1xuICAgIH0pLFxuICApO1xuXG4gIC8vIFVwZGF0ZSBwYXNzd29yZFxuICByb3V0ZXIucHV0KFxuICAgICcvcGFzc3dvcmQnLFxuICAgIGFzeW5jSGFuZGxlcihhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyIS5pZDtcbiAgICAgIGNvbnN0IHsgY3VycmVudFBhc3N3b3JkLCBuZXdQYXNzd29yZCB9ID0gdXBkYXRlUGFzc3dvcmRTY2hlbWEucGFyc2UocmVxLmJvZHkpO1xuXG4gICAgICAvLyBWYWxpZGF0ZSBuZXcgcGFzc3dvcmRcbiAgICAgIGF3YWl0IHZhbGlkYXRlUGFzc3dvcmQobmV3UGFzc3dvcmQpO1xuXG4gICAgICAvLyBHZXQgdXNlciB3aXRoIHBhc3N3b3JkXG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgcHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkOiB1c2VySWQgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIXVzZXIpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgZXJyb3I6ICdVc2VyIG5vdCBmb3VuZCcgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIFZlcmlmeSBjdXJyZW50IHBhc3N3b3JkXG4gICAgICBjb25zdCBpc1ZhbGlkUGFzc3dvcmQgPSBhd2FpdCBiY3J5cHQuY29tcGFyZShjdXJyZW50UGFzc3dvcmQsIHVzZXIucGFzc3dvcmQpO1xuICAgICAgaWYgKCFpc1ZhbGlkUGFzc3dvcmQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICdDdXJyZW50IHBhc3N3b3JkIGlzIGluY29ycmVjdCcgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIEhhc2ggbmV3IHBhc3N3b3JkXG4gICAgICBjb25zdCBoYXNoZWRQYXNzd29yZCA9IGF3YWl0IGhhc2hQYXNzd29yZChuZXdQYXNzd29yZCk7XG5cbiAgICAgIC8vIFVwZGF0ZSBwYXNzd29yZFxuICAgICAgYXdhaXQgcHJpc21hLnVzZXIudXBkYXRlKHtcbiAgICAgICAgd2hlcmU6IHsgaWQ6IHVzZXJJZCB9LFxuICAgICAgICBkYXRhOiB7IHBhc3N3b3JkOiBoYXNoZWRQYXNzd29yZCB9LFxuICAgICAgfSk7XG5cbiAgICAgIHJlcy5qc29uKHsgbWVzc2FnZTogJ1Bhc3N3b3JkIHVwZGF0ZWQgc3VjY2Vzc2Z1bGx5JyB9KTtcbiAgICB9KSxcbiAgKTtcblxuICAvLyBDcmVhdGUgdXNlciAoYWRtaW4gb25seSlcbiAgcm91dGVyLnBvc3QoXG4gICAgJy9jcmVhdGUnLFxuICAgIGFzeW5jSGFuZGxlcihhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICAgIGNvbnN0IHVzZXJSb2xlID0gKHJlcSBhcyBSZXF1ZXN0ICYgeyB1c2VyPzogeyByb2xlPzogc3RyaW5nIH0gfSkudXNlcj8ucm9sZTtcblxuICAgICAgaWYgKHVzZXJSb2xlICE9PSAnQURNSU4nKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnRm9yYmlkZGVuJyB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgeyBlbWFpbCwgbmFtZSwgcm9sZSB9ID0gcmVxLmJvZHk7XG5cbiAgICAgIC8vIFNhbml0aXplIGlucHV0XG4gICAgICBjb25zdCBzYW5pdGl6ZWROYW1lID0gbmFtZS5yZXBsYWNlKC88W14+XSo+L2csICcnKTsgLy8gUmVtb3ZlIEhUTUwgdGFnc1xuXG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgcHJpc21hLnVzZXIuY3JlYXRlKHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGVtYWlsLFxuICAgICAgICAgIG5hbWU6IHNhbml0aXplZE5hbWUsXG4gICAgICAgICAgcm9sZTogcm9sZSB8fCAnVVNFUicsXG4gICAgICAgICAgcGFzc3dvcmQ6IGF3YWl0IGhhc2hQYXNzd29yZCgnVGVtcFBhc3N3b3JkMTIzIScpLCAvLyBUZW1wb3JhcnkgcGFzc3dvcmRcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCB7IHBhc3N3b3JkOiBfLCAuLi51c2VyV2l0aG91dFBhc3N3b3JkIH0gPSB1c2VyO1xuICAgICAgcmVzLnN0YXR1cygyMDEpLmpzb24odXNlcldpdGhvdXRQYXNzd29yZCk7XG4gICAgfSksXG4gICk7XG5cbiAgLy8gRGF0YSB2YWxpZGF0aW9uIGVuZHBvaW50XG4gIHJvdXRlci5wb3N0KFxuICAgICcvZGF0YS92YWxpZGF0ZScsXG4gICAgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICAgICAgY29uc3QgZGF0YSA9IHJlcS5ib2R5O1xuXG4gICAgICAvLyBUeXBlIHZhbGlkYXRpb25cbiAgICAgIGlmIChkYXRhLmFnZSAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBkYXRhLmFnZSAhPT0gJ251bWJlcicpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgZXJyb3I6ICdJbnZhbGlkIGRhdGEgdHlwZTogYWdlIG11c3QgYmUgYSBudW1iZXInIH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAoZGF0YS5hY3RpdmUgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgZGF0YS5hY3RpdmUgIT09ICdib29sZWFuJykge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ0ludmFsaWQgZGF0YSB0eXBlOiBhY3RpdmUgbXVzdCBiZSBhIGJvb2xlYW4nIH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAoZGF0YS50YWdzICE9PSB1bmRlZmluZWQgJiYgIUFycmF5LmlzQXJyYXkoZGF0YS50YWdzKSkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ0ludmFsaWQgZGF0YSB0eXBlOiB0YWdzIG11c3QgYmUgYW4gYXJyYXknIH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAoZGF0YS5tZXRhZGF0YSAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBkYXRhLm1ldGFkYXRhICE9PSAnb2JqZWN0Jykge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ0ludmFsaWQgZGF0YSB0eXBlOiBtZXRhZGF0YSBtdXN0IGJlIGFuIG9iamVjdCcgfSk7XG4gICAgICB9XG5cbiAgICAgIHJlcy5qc29uKHsgdmFsaWQ6IHRydWUgfSk7XG4gICAgfSksXG4gICk7XG5cbiAgcmV0dXJuIHJvdXRlcjtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==