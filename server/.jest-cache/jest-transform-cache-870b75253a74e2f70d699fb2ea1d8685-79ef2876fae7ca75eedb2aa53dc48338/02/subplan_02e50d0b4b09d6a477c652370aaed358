91c1525fe3e3ca6ac8345bebdb48f0d8
import { Router } from 'express';
import { z } from 'zod';
import { validate } from '../validation';
import { generateSubPlan } from '../services/subPlanService';
import { prisma } from '../prisma';
// Use global Express Request type with user: { id: number; email: string }
const router = Router();
// Sub-plan generation schema
const subPlanGenerateSchema = z.object({
    date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, 'Date must be in YYYY-MM-DD format'),
    days: z.number().int().min(1).max(5).default(1),
    includeGoals: z.boolean().default(true),
    includeRoutines: z.boolean().default(true),
    includePlans: z.boolean().default(true),
    anonymize: z.boolean().default(false),
    userId: z.number().int().optional(),
    saveRecord: z.boolean().default(false),
    emailTo: z.string().optional(),
    notes: z.string().max(1000).optional(),
});
/**
 * Generate substitute plan PDF
 * POST /api/sub-plan/generate
 */
router.post('/generate', validate(subPlanGenerateSchema), async (req, res, next) => {
    try {
        const userId = req.user?.id || 0;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const { date, days, includeGoals, includeRoutines, includePlans, anonymize, saveRecord, emailTo, notes, } = req.body;
        // Use the authenticated user's ID if userId not provided in request
        const targetUserId = req.body.userId || userId;
        const options = {
            includeGoals,
            includeRoutines,
            includePlans,
            anonymize,
            userId: targetUserId,
        };
        const pdfBuffer = await generateSubPlan(date, days, options);
        // Save record if requested
        if (saveRecord) {
            await prisma.subPlanRecord.create({
                data: {
                    userId: targetUserId,
                    date: new Date(date),
                    daysCount: days,
                    content: { emailedTo: emailTo, options: JSON.stringify(options) },
                    includeGoals,
                    includeRoutines,
                    includePlans,
                    anonymized: anonymize,
                    notes: notes,
                },
            });
        }
        // Set PDF headers
        res.setHeader('Content-Type', 'application/pdf');
        res.setHeader('Content-Disposition', `attachment; filename="sub-plan-${date}.pdf"`);
        res.setHeader('Content-Length', pdfBuffer.length);
        res.send(pdfBuffer);
    }
    catch (error) {
        next(error);
    }
});
/**
 * Get class routines for user
 * GET /api/sub-plan/routines
 */
router.get('/routines', async (req, res, next) => {
    try {
        const userId = req.user?.id || 0;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const targetUserId = req.query.userId ? parseInt(req.query.userId, 10) : userId;
        const routines = await prisma.classRoutine.findMany({
            where: { userId: targetUserId },
            orderBy: { priority: 'desc' }, // Higher priority first
        });
        res.json(routines);
    }
    catch (error) {
        next(error);
    }
});
/**
 * Create or update class routine
 * POST /api/sub-plan/routines
 */
router.post('/routines', async (req, res, next) => {
    try {
        const userId = req.user?.id || 0;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const { id, title, description, category, timeOfDay, priority, isActive } = req.body;
        if (id) {
            // Update existing routine
            const routine = await prisma.classRoutine.update({
                where: { id: parseInt(id, 10) },
                data: {
                    title,
                    description,
                    category,
                    timeOfDay,
                    priority,
                    isActive: isActive !== undefined ? isActive : true,
                },
            });
            res.json(routine);
        }
        else {
            // Create new routine
            const routine = await prisma.classRoutine.create({
                data: {
                    userId,
                    title,
                    description,
                    category,
                    timeOfDay,
                    priority: priority || 5,
                    isActive: isActive !== undefined ? isActive : true,
                },
            });
            res.json(routine);
        }
    }
    catch (error) {
        next(error);
    }
});
/**
 * Delete class routine
 * DELETE /api/sub-plan/routines/:id
 */
router.delete('/routines/:id', async (req, res, next) => {
    try {
        const userId = req.user?.id || 0;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const routineId = parseInt(req.params.id, 10);
        await prisma.classRoutine.delete({
            where: { id: routineId },
        });
        res.json({ success: true });
    }
    catch (error) {
        next(error);
    }
});
/**
 * Get sub plan records
 * GET /api/sub-plan/records
 */
router.get('/records', async (req, res, next) => {
    try {
        const userId = req.user?.id || 0;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const targetUserId = req.query.userId ? parseInt(req.query.userId, 10) : userId;
        const records = await prisma.subPlanRecord.findMany({
            where: { userId: targetUserId },
            orderBy: { date: 'desc' },
        });
        res.json(records);
    }
    catch (error) {
        next(error);
    }
});
export default router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9yb3V0ZXMvc3ViLXBsYW4udHMiLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBbUMsTUFBTSxTQUFTLENBQUM7QUFDbEUsT0FBTyxFQUFFLENBQUMsRUFBRSxNQUFNLEtBQUssQ0FBQztBQUN4QixPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRW5DLDJFQUEyRTtBQUUzRSxNQUFNLE1BQU0sR0FBRyxNQUFNLEVBQUUsQ0FBQztBQUV4Qiw2QkFBNkI7QUFDN0IsTUFBTSxxQkFBcUIsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDO0lBQ3JDLElBQUksRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsS0FBSyxDQUFDLHFCQUFxQixFQUFFLG1DQUFtQyxDQUFDO0lBQ2xGLElBQUksRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQy9DLFlBQVksRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQztJQUN2QyxlQUFlLEVBQUUsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7SUFDMUMsWUFBWSxFQUFFLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDO0lBQ3ZDLFNBQVMsRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQztJQUNyQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdB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Q0FBQztRQUVELE1BQU0sWUFBWSxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFnQixFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7UUFFMUYsTUFBTSxPQUFPLEdBQUcsTUFBTSxNQUFNLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQztZQUNsRCxLQUFLLEVBQUUsRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFO1lBQy9CLE9BQU8sRUFBRSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUU7U0FDMUIsQ0FBQyxDQUFDO1FBRUgsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNwQixDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNkLENBQUM7QUFDSCxDQUFDLENBQUMsQ0FBQztBQUVILGVBQWUsTUFBTSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9taWNoYWVsbWNpc2FhYy9HaXRIdWIvdGVhY2hpbmctZW5naW5lMi4wL3NlcnZlci9zcmMvcm91dGVzL3N1Yi1wbGFuLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJvdXRlciwgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgeiB9IGZyb20gJ3pvZCc7XG5pbXBvcnQgeyB2YWxpZGF0ZSB9IGZyb20gJy4uL3ZhbGlkYXRpb24nO1xuaW1wb3J0IHsgZ2VuZXJhdGVTdWJQbGFuIH0gZnJvbSAnLi4vc2VydmljZXMvc3ViUGxhblNlcnZpY2UnO1xuaW1wb3J0IHsgcHJpc21hIH0gZnJvbSAnLi4vcHJpc21hJztcblxuLy8gVXNlIGdsb2JhbCBFeHByZXNzIFJlcXVlc3QgdHlwZSB3aXRoIHVzZXI6IHsgaWQ6IG51bWJlcjsgZW1haWw6IHN0cmluZyB9XG5cbmNvbnN0IHJvdXRlciA9IFJvdXRlcigpO1xuXG4vLyBTdWItcGxhbiBnZW5lcmF0aW9uIHNjaGVtYVxuY29uc3Qgc3ViUGxhbkdlbmVyYXRlU2NoZW1hID0gei5vYmplY3Qoe1xuICBkYXRlOiB6LnN0cmluZygpLnJlZ2V4KC9eXFxkezR9LVxcZHsyfS1cXGR7Mn0kLywgJ0RhdGUgbXVzdCBiZSBpbiBZWVlZLU1NLUREIGZvcm1hdCcpLFxuICBkYXlzOiB6Lm51bWJlcigpLmludCgpLm1pbigxKS5tYXgoNSkuZGVmYXVsdCgxKSxcbiAgaW5jbHVkZUdvYWxzOiB6LmJvb2xlYW4oKS5kZWZhdWx0KHRydWUpLFxuICBpbmNsdWRlUm91dGluZXM6IHouYm9vbGVhbigpLmRlZmF1bHQodHJ1ZSksXG4gIGluY2x1ZGVQbGFuczogei5ib29sZWFuKCkuZGVmYXVsdCh0cnVlKSxcbiAgYW5vbnltaXplOiB6LmJvb2xlYW4oKS5kZWZhdWx0KGZhbHNlKSxcbiAgdXNlcklkOiB6Lm51bWJlcigpLmludCgpLm9wdGlvbmFsKCksXG4gIHNhdmVSZWNvcmQ6IHouYm9vbGVhbigpLmRlZmF1bHQoZmFsc2UpLFxuICBlbWFpbFRvOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gIG5vdGVzOiB6LnN0cmluZygpLm1heCgxMDAwKS5vcHRpb25hbCgpLFxufSk7XG5cbi8qKlxuICogR2VuZXJhdGUgc3Vic3RpdHV0ZSBwbGFuIFBERlxuICogUE9TVCAvYXBpL3N1Yi1wbGFuL2dlbmVyYXRlXG4gKi9cbnJvdXRlci5wb3N0KFxuICAnL2dlbmVyYXRlJyxcbiAgdmFsaWRhdGUoc3ViUGxhbkdlbmVyYXRlU2NoZW1hKSxcbiAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyPy5pZCB8fCAwO1xuICAgICAgaWYgKCF1c2VySWQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICdVbmF1dGhvcml6ZWQnIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB7XG4gICAgICAgIGRhdGUsXG4gICAgICAgIGRheXMsXG4gICAgICAgIGluY2x1ZGVHb2FscyxcbiAgICAgICAgaW5jbHVkZVJvdXRpbmVzLFxuICAgICAgICBpbmNsdWRlUGxhbnMsXG4gICAgICAgIGFub255bWl6ZSxcbiAgICAgICAgc2F2ZVJlY29yZCxcbiAgICAgICAgZW1haWxUbyxcbiAgICAgICAgbm90ZXMsXG4gICAgICB9ID0gcmVxLmJvZHk7XG5cbiAgICAgIC8vIFVzZSB0aGUgYXV0aGVudGljYXRlZCB1c2VyJ3MgSUQgaWYgdXNlcklkIG5vdCBwcm92aWRlZCBpbiByZXF1ZXN0XG4gICAgICBjb25zdCB0YXJnZXRVc2VySWQgPSByZXEuYm9keS51c2VySWQgfHwgdXNlcklkO1xuXG4gICAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgICBpbmNsdWRlR29hbHMsXG4gICAgICAgIGluY2x1ZGVSb3V0aW5lcyxcbiAgICAgICAgaW5jbHVkZVBsYW5zLFxuICAgICAgICBhbm9ueW1pemUsXG4gICAgICAgIHVzZXJJZDogdGFyZ2V0VXNlcklkLFxuICAgICAgfTtcblxuICAgICAgY29uc3QgcGRmQnVmZmVyID0gYXdhaXQgZ2VuZXJhdGVTdWJQbGFuKGRhdGUsIGRheXMsIG9wdGlvbnMpO1xuXG4gICAgICAvLyBTYXZlIHJlY29yZCBpZiByZXF1ZXN0ZWRcbiAgICAgIGlmIChzYXZlUmVjb3JkKSB7XG4gICAgICAgIGF3YWl0IHByaXNtYS5zdWJQbGFuUmVjb3JkLmNyZWF0ZSh7XG4gICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgdXNlcklkOiB0YXJnZXRVc2VySWQsXG4gICAgICAgICAgICBkYXRlOiBuZXcgRGF0ZShkYXRlKSxcbiAgICAgICAgICAgIGRheXNDb3VudDogZGF5cyxcbiAgICAgICAgICAgIGNvbnRlbnQ6IHsgZW1haWxlZFRvOiBlbWFpbFRvLCBvcHRpb25zOiBKU09OLnN0cmluZ2lmeShvcHRpb25zKSB9LFxuICAgICAgICAgICAgaW5jbHVkZUdvYWxzLFxuICAgICAgICAgICAgaW5jbHVkZVJvdXRpbmVzLFxuICAgICAgICAgICAgaW5jbHVkZVBsYW5zLFxuICAgICAgICAgICAgYW5vbnltaXplZDogYW5vbnltaXplLFxuICAgICAgICAgICAgbm90ZXM6IG5vdGVzLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBTZXQgUERGIGhlYWRlcnNcbiAgICAgIHJlcy5zZXRIZWFkZXIoJ0NvbnRlbnQtVHlwZScsICdhcHBsaWNhdGlvbi9wZGYnKTtcbiAgICAgIHJlcy5zZXRIZWFkZXIoJ0NvbnRlbnQtRGlzcG9zaXRpb24nLCBgYXR0YWNobWVudDsgZmlsZW5hbWU9XCJzdWItcGxhbi0ke2RhdGV9LnBkZlwiYCk7XG4gICAgICByZXMuc2V0SGVhZGVyKCdDb250ZW50LUxlbmd0aCcsIHBkZkJ1ZmZlci5sZW5ndGgpO1xuXG4gICAgICByZXMuc2VuZChwZGZCdWZmZXIpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBuZXh0KGVycm9yKTtcbiAgICB9XG4gIH0sXG4pO1xuXG4vKipcbiAqIEdldCBjbGFzcyByb3V0aW5lcyBmb3IgdXNlclxuICogR0VUIC9hcGkvc3ViLXBsYW4vcm91dGluZXNcbiAqL1xucm91dGVyLmdldCgnL3JvdXRpbmVzJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXI/LmlkIHx8IDA7XG4gICAgaWYgKCF1c2VySWQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAnVW5hdXRob3JpemVkJyB9KTtcbiAgICB9XG5cbiAgICBjb25zdCB0YXJnZXRVc2VySWQgPSByZXEucXVlcnkudXNlcklkID8gcGFyc2VJbnQocmVxLnF1ZXJ5LnVzZXJJZCBhcyBzdHJpbmcsIDEwKSA6IHVzZXJJZDtcblxuICAgIGNvbnN0IHJvdXRpbmVzID0gYXdhaXQgcHJpc21hLmNsYXNzUm91dGluZS5maW5kTWFueSh7XG4gICAgICB3aGVyZTogeyB1c2VySWQ6IHRhcmdldFVzZXJJZCB9LFxuICAgICAgb3JkZXJCeTogeyBwcmlvcml0eTogJ2Rlc2MnIH0sIC8vIEhpZ2hlciBwcmlvcml0eSBmaXJzdFxuICAgIH0pO1xuXG4gICAgcmVzLmpzb24ocm91dGluZXMpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIG5leHQoZXJyb3IpO1xuICB9XG59KTtcblxuLyoqXG4gKiBDcmVhdGUgb3IgdXBkYXRlIGNsYXNzIHJvdXRpbmVcbiAqIFBPU1QgL2FwaS9zdWItcGxhbi9yb3V0aW5lc1xuICovXG5yb3V0ZXIucG9zdCgnL3JvdXRpbmVzJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXI/LmlkIHx8IDA7XG4gICAgaWYgKCF1c2VySWQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAnVW5hdXRob3JpemVkJyB9KTtcbiAgICB9XG5cbiAgICBjb25zdCB7IGlkLCB0aXRsZSwgZGVzY3JpcHRpb24sIGNhdGVnb3J5LCB0aW1lT2ZEYXksIHByaW9yaXR5LCBpc0FjdGl2ZSB9ID0gcmVxLmJvZHk7XG5cbiAgICBpZiAoaWQpIHtcbiAgICAgIC8vIFVwZGF0ZSBleGlzdGluZyByb3V0aW5lXG4gICAgICBjb25zdCByb3V0aW5lID0gYXdhaXQgcHJpc21hLmNsYXNzUm91dGluZS51cGRhdGUoe1xuICAgICAgICB3aGVyZTogeyBpZDogcGFyc2VJbnQoaWQsIDEwKSB9LFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgdGl0bGUsXG4gICAgICAgICAgZGVzY3JpcHRpb24sXG4gICAgICAgICAgY2F0ZWdvcnksXG4gICAgICAgICAgdGltZU9mRGF5LFxuICAgICAgICAgIHByaW9yaXR5LFxuICAgICAgICAgIGlzQWN0aXZlOiBpc0FjdGl2ZSAhPT0gdW5kZWZpbmVkID8gaXNBY3RpdmUgOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgICByZXMuanNvbihyb3V0aW5lKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gQ3JlYXRlIG5ldyByb3V0aW5lXG4gICAgICBjb25zdCByb3V0aW5lID0gYXdhaXQgcHJpc21hLmNsYXNzUm91dGluZS5jcmVhdGUoe1xuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgdXNlcklkLFxuICAgICAgICAgIHRpdGxlLFxuICAgICAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgICAgIGNhdGVnb3J5LFxuICAgICAgICAgIHRpbWVPZkRheSxcbiAgICAgICAgICBwcmlvcml0eTogcHJpb3JpdHkgfHwgNSxcbiAgICAgICAgICBpc0FjdGl2ZTogaXNBY3RpdmUgIT09IHVuZGVmaW5lZCA/IGlzQWN0aXZlIDogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgICAgcmVzLmpzb24ocm91dGluZSk7XG4gICAgfVxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIG5leHQoZXJyb3IpO1xuICB9XG59KTtcblxuLyoqXG4gKiBEZWxldGUgY2xhc3Mgcm91dGluZVxuICogREVMRVRFIC9hcGkvc3ViLXBsYW4vcm91dGluZXMvOmlkXG4gKi9cbnJvdXRlci5kZWxldGUoJy9yb3V0aW5lcy86aWQnLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlcj8uaWQgfHwgMDtcbiAgICBpZiAoIXVzZXJJZCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICdVbmF1dGhvcml6ZWQnIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHJvdXRpbmVJZCA9IHBhcnNlSW50KHJlcS5wYXJhbXMuaWQsIDEwKTtcblxuICAgIGF3YWl0IHByaXNtYS5jbGFzc1JvdXRpbmUuZGVsZXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiByb3V0aW5lSWQgfSxcbiAgICB9KTtcblxuICAgIHJlcy5qc29uKHsgc3VjY2VzczogdHJ1ZSB9KTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBuZXh0KGVycm9yKTtcbiAgfVxufSk7XG5cbi8qKlxuICogR2V0IHN1YiBwbGFuIHJlY29yZHNcbiAqIEdFVCAvYXBpL3N1Yi1wbGFuL3JlY29yZHNcbiAqL1xucm91dGVyLmdldCgnL3JlY29yZHMnLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlcj8uaWQgfHwgMDtcbiAgICBpZiAoIXVzZXJJZCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICdVbmF1dGhvcml6ZWQnIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHRhcmdldFVzZXJJZCA9IHJlcS5xdWVyeS51c2VySWQgPyBwYXJzZUludChyZXEucXVlcnkudXNlcklkIGFzIHN0cmluZywgMTApIDogdXNlcklkO1xuXG4gICAgY29uc3QgcmVjb3JkcyA9IGF3YWl0IHByaXNtYS5zdWJQbGFuUmVjb3JkLmZpbmRNYW55KHtcbiAgICAgIHdoZXJlOiB7IHVzZXJJZDogdGFyZ2V0VXNlcklkIH0sXG4gICAgICBvcmRlckJ5OiB7IGRhdGU6ICdkZXNjJyB9LFxuICAgIH0pO1xuXG4gICAgcmVzLmpzb24ocmVjb3Jkcyk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbmV4dChlcnJvcik7XG4gIH1cbn0pO1xuXG5leHBvcnQgZGVmYXVsdCByb3V0ZXI7XG4iXSwidmVyc2lvbiI6M30=