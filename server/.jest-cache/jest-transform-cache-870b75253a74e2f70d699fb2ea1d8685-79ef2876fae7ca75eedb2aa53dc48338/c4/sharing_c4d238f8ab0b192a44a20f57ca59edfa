bab98e6e22853f4fc7b10a713976b754
/**
 * Plan Sharing Routes
 * Handles sharing of lesson plans, units, and other planning resources
 */
import { Router } from 'express';
import { z } from 'zod';
import { authenticate } from '@/middleware/authenticate';
import { asyncHandler } from '@/middleware/errorHandler';
import logger from '@/logger';
import { addDays } from 'date-fns';
// Validation schemas
const sharePlanSchema = z.object({
    planType: z.enum(['long-range', 'unit', 'lesson', 'daybook']),
    planId: z.string(),
    shareWith: z.union([
        z.object({
            type: z.literal('user'),
            email: z.string().email(),
        }),
        z.object({
            type: z.literal('team'),
            teamId: z.string(),
        }),
        z.object({
            type: z.literal('link'),
            expiresInDays: z.number().int().min(1).max(365).optional(),
        }),
    ]),
    permissions: z.object({
        canEdit: z.boolean().optional(),
        canCopy: z.boolean().optional(),
        canComment: z.boolean().optional(),
        canReshare: z.boolean().optional(),
    }).optional(),
    message: z.string().optional(),
});
const updateSharePermissionsSchema = z.object({
    canEdit: z.boolean().optional(),
    canCopy: z.boolean().optional(),
    canComment: z.boolean().optional(),
    canReshare: z.boolean().optional(),
});
export function sharingRoutes(prisma) {
    const router = Router();
    // Apply authentication to all routes
    router.use(authenticate);
    // Helper function to check plan ownership
    async function checkPlanOwnership(planType, planId, userId) {
        switch (planType) {
            case 'long-range':
                const lrPlan = await prisma.longRangePlan.findUnique({
                    where: { id: planId },
                });
                return lrPlan?.userId === userId;
            case 'unit':
                const unitPlan = await prisma.unitPlan.findUnique({
                    where: { id: planId },
                });
                return unitPlan?.userId === userId;
            case 'lesson':
                const lessonPlan = await prisma.eTFOLessonPlan.findUnique({
                    where: { id: planId },
                });
                return lessonPlan?.userId === userId;
            case 'daybook':
                const daybookEntry = await prisma.daybookEntry.findUnique({
                    where: { id: planId },
                });
                return daybookEntry?.userId === userId;
            default:
                return false;
        }
    }
    // Get all shared plans (both sent and received)
    router.get('/plans', asyncHandler(async (req, res) => {
        const userId = req.user.id;
        const { type, direction } = req.query;
        const whereClause = {};
        if (direction === 'sent') {
            whereClause.sharedById = userId;
        }
        else if (direction === 'received') {
            whereClause.sharedWithId = userId;
        }
        else {
            whereClause.OR = [
                { sharedById: userId },
                { sharedWithId: userId },
            ];
        }
        if (type) {
            whereClause.planType = type;
        }
        const sharedPlans = await prisma.sharedPlan.findMany({
            where: whereClause,
            include: {
                sharedBy: {
                    select: { id: true, name: true, email: true },
                },
                sharedWith: {
                    select: { id: true, name: true, email: true },
                },
            },
            orderBy: { sharedAt: 'desc' },
        });
        // Fetch plan details for each shared plan
        const plansWithDetails = await Promise.all(sharedPlans.map(async (share) => {
            let planDetails = null;
            switch (share.planType) {
                case 'long-range':
                    planDetails = await prisma.longRangePlan.findUnique({
                        where: { id: share.planId },
                        select: { id: true, title: true, academicYear: true, grade: true, subject: true },
                    });
                    break;
                case 'unit':
                    planDetails = await prisma.unitPlan.findUnique({
                        where: { id: share.planId },
                        select: { id: true, title: true, startDate: true, endDate: true },
                    });
                    break;
                case 'lesson':
                    planDetails = await prisma.eTFOLessonPlan.findUnique({
                        where: { id: share.planId },
                        select: { id: true, title: true, date: true, grade: true, subject: true },
                    });
                    break;
                case 'daybook':
                    planDetails = await prisma.daybookEntry.findUnique({
                        where: { id: share.planId },
                        select: { id: true, date: true },
                    });
                    break;
            }
            return {
                ...share,
                planDetails,
            };
        }));
        res.json(plansWithDetails);
    }));
    // Share a plan
    router.post('/plans', asyncHandler(async (req, res) => {
        const userId = req.user.id;
        const { planType, planId, shareWith, permissions = {}, message } = sharePlanSchema.parse(req.body);
        // Check if user owns the plan
        const isOwner = await checkPlanOwnership(planType, planId, userId);
        if (!isOwner) {
            return res.status(403).json({ error: 'You do not have permission to share this plan' });
        }
        let sharedPlan;
        if (shareWith.type === 'user') {
            // Share with specific user
            const targetUser = await prisma.user.findUnique({
                where: { email: shareWith.email },
            });
            if (!targetUser) {
                return res.status(404).json({ error: 'User not found' });
            }
            if (targetUser.id === userId) {
                return res.status(400).json({ error: 'Cannot share with yourself' });
            }
            // Check if already shared
            const existingShare = await prisma.sharedPlan.findFirst({
                where: {
                    planType,
                    planId,
                    sharedById: userId,
                    sharedWithId: targetUser.id,
                },
            });
            if (existingShare) {
                return res.status(409).json({ error: 'Plan is already shared with this user' });
            }
            sharedPlan = await prisma.sharedPlan.create({
                data: {
                    planType,
                    planId,
                    sharedById: userId,
                    sharedWithId: targetUser.id,
                    ...permissions,
                    message,
                },
                include: {
                    sharedBy: {
                        select: { id: true, name: true, email: true },
                    },
                    sharedWith: {
                        select: { id: true, name: true, email: true },
                    },
                },
            });
            // TODO: Send email notification
        }
        else if (shareWith.type === 'team') {
            // Share with team
            const team = await prisma.team.findUnique({
                where: { id: shareWith.teamId },
            });
            if (!team) {
                return res.status(404).json({ error: 'Team not found' });
            }
            // Check if user is a member of the team
            const isMember = await prisma.teamMember.findUnique({
                where: { teamId_userId: { teamId: shareWith.teamId, userId } },
            });
            if (!isMember) {
                return res.status(403).json({ error: 'You must be a team member to share with the team' });
            }
            sharedPlan = await prisma.sharedPlan.create({
                data: {
                    planType,
                    planId,
                    sharedById: userId,
                    teamId: shareWith.teamId,
                    ...permissions,
                    message,
                },
                include: {
                    sharedBy: {
                        select: { id: true, name: true, email: true },
                    },
                },
            });
        }
        else {
            // Create public sharing link
            const expiresAt = shareWith.expiresInDays
                ? addDays(new Date(), shareWith.expiresInDays)
                : undefined;
            sharedPlan = await prisma.sharedPlan.create({
                data: {
                    planType,
                    planId,
                    sharedById: userId,
                    isPublicLink: true,
                    linkExpiresAt: expiresAt,
                    ...permissions,
                    message,
                },
                include: {
                    sharedBy: {
                        select: { id: true, name: true, email: true },
                    },
                },
            });
        }
        logger.info(`Plan shared: ${planType}/${planId} by user ${userId}`);
        res.status(201).json(sharedPlan);
    }));
    // Get shared plan by share code
    router.get('/plans/:shareCode', asyncHandler(async (req, res) => {
        const { shareCode } = req.params;
        const userId = req.user.id;
        const sharedPlan = await prisma.sharedPlan.findUnique({
            where: { shareCode },
            include: {
                sharedBy: {
                    select: { id: true, name: true, email: true },
                },
            },
        });
        if (!sharedPlan) {
            return res.status(404).json({ error: 'Shared plan not found' });
        }
        // Check access permissions
        const hasAccess = sharedPlan.isPublicLink ||
            sharedPlan.sharedById === userId ||
            sharedPlan.sharedWithId === userId;
        if (!hasAccess && sharedPlan.teamId) {
            // Check team membership
            const isMember = await prisma.teamMember.findFirst({
                where: { teamId: sharedPlan.teamId, userId },
            });
            if (!isMember) {
                return res.status(403).json({ error: 'Access denied' });
            }
        }
        else if (!hasAccess) {
            return res.status(403).json({ error: 'Access denied' });
        }
        // Check if link has expired
        if (sharedPlan.linkExpiresAt && new Date() > sharedPlan.linkExpiresAt) {
            return res.status(410).json({ error: 'Share link has expired' });
        }
        // Update view count
        await prisma.sharedPlan.update({
            where: { id: sharedPlan.id },
            data: {
                viewCount: { increment: 1 },
                lastViewedAt: new Date(),
            },
        });
        // Fetch plan details
        let planDetails = null;
        switch (sharedPlan.planType) {
            case 'long-range':
                planDetails = await prisma.longRangePlan.findUnique({
                    where: { id: sharedPlan.planId },
                    include: {
                        expectations: {
                            include: { expectation: true },
                        },
                        unitPlans: {
                            select: { id: true, title: true, startDate: true, endDate: true },
                        },
                    },
                });
                break;
            case 'unit':
                planDetails = await prisma.unitPlan.findUnique({
                    where: { id: sharedPlan.planId },
                    include: {
                        expectations: {
                            include: { expectation: true },
                        },
                        lessonPlans: {
                            select: { id: true, title: true, date: true },
                        },
                        resources: true,
                    },
                });
                break;
            case 'lesson':
                planDetails = await prisma.eTFOLessonPlan.findUnique({
                    where: { id: sharedPlan.planId },
                    include: {
                        expectations: {
                            include: { expectation: true },
                        },
                        resources: true,
                    },
                });
                break;
            case 'daybook':
                planDetails = await prisma.daybookEntry.findUnique({
                    where: { id: sharedPlan.planId },
                    include: {
                        expectations: {
                            include: { expectation: true },
                        },
                    },
                });
                break;
        }
        res.json({
            share: sharedPlan,
            plan: planDetails,
        });
    }));
    // Update share permissions
    router.patch('/plans/:shareId', asyncHandler(async (req, res) => {
        const { shareId } = req.params;
        const userId = req.user.id;
        const updates = updateSharePermissionsSchema.parse(req.body);
        const sharedPlan = await prisma.sharedPlan.findUnique({
            where: { id: shareId },
        });
        if (!sharedPlan) {
            return res.status(404).json({ error: 'Shared plan not found' });
        }
        // Only the sharer can update permissions
        if (sharedPlan.sharedById !== userId) {
            return res.status(403).json({ error: 'Only the plan owner can update share permissions' });
        }
        const updated = await prisma.sharedPlan.update({
            where: { id: shareId },
            data: updates,
            include: {
                sharedBy: {
                    select: { id: true, name: true, email: true },
                },
                sharedWith: {
                    select: { id: true, name: true, email: true },
                },
            },
        });
        res.json(updated);
    }));
    // Revoke share
    router.delete('/plans/:shareId', asyncHandler(async (req, res) => {
        const { shareId } = req.params;
        const userId = req.user.id;
        const sharedPlan = await prisma.sharedPlan.findUnique({
            where: { id: shareId },
        });
        if (!sharedPlan) {
            return res.status(404).json({ error: 'Shared plan not found' });
        }
        // Only the sharer can revoke
        if (sharedPlan.sharedById !== userId) {
            return res.status(403).json({ error: 'Only the plan owner can revoke sharing' });
        }
        await prisma.sharedPlan.delete({
            where: { id: shareId },
        });
        logger.info(`Share revoked: ${shareId} by user ${userId}`);
        res.status(204).send();
    }));
    // Copy shared plan
    router.post('/plans/:shareCode/copy', asyncHandler(async (req, res) => {
        const { shareCode } = req.params;
        const userId = req.user.id;
        const sharedPlan = await prisma.sharedPlan.findUnique({
            where: { shareCode },
        });
        if (!sharedPlan) {
            return res.status(404).json({ error: 'Shared plan not found' });
        }
        // Check if user has copy permission
        if (!sharedPlan.canCopy) {
            return res.status(403).json({ error: 'Copying this plan is not allowed' });
        }
        // Check access
        const hasAccess = sharedPlan.isPublicLink ||
            sharedPlan.sharedWithId === userId;
        if (!hasAccess && sharedPlan.teamId) {
            const isMember = await prisma.teamMember.findFirst({
                where: { teamId: sharedPlan.teamId, userId },
            });
            if (!isMember) {
                return res.status(403).json({ error: 'Access denied' });
            }
        }
        else if (!hasAccess) {
            return res.status(403).json({ error: 'Access denied' });
        }
        // Copy the plan based on type
        let copiedPlan;
        switch (sharedPlan.planType) {
            case 'lesson':
                const originalLesson = await prisma.eTFOLessonPlan.findUnique({
                    where: { id: sharedPlan.planId },
                    include: {
                        expectations: true,
                        resources: true,
                    },
                });
                if (!originalLesson) {
                    return res.status(404).json({ error: 'Original plan not found' });
                }
                // Get user's unit plans to select from
                const userUnitPlans = await prisma.unitPlan.findMany({
                    where: { userId },
                    select: { id: true },
                    take: 1,
                });
                if (userUnitPlans.length === 0) {
                    return res.status(400).json({ error: 'You need at least one unit plan to copy lessons' });
                }
                copiedPlan = await prisma.eTFOLessonPlan.create({
                    data: {
                        userId,
                        title: `${originalLesson.title} (Copy)`,
                        unitPlanId: userUnitPlans[0].id, // TODO: Allow user to select unit
                        grade: originalLesson.grade,
                        subject: originalLesson.subject,
                        language: originalLesson.language,
                        date: new Date(),
                        duration: originalLesson.duration,
                        mindsOn: originalLesson.mindsOn,
                        action: originalLesson.action,
                        consolidation: originalLesson.consolidation,
                        learningGoals: originalLesson.learningGoals,
                        materials: originalLesson.materials,
                        grouping: originalLesson.grouping,
                        titleFr: originalLesson.titleFr,
                        mindsOnFr: originalLesson.mindsOnFr,
                        actionFr: originalLesson.actionFr,
                        consolidationFr: originalLesson.consolidationFr,
                        learningGoalsFr: originalLesson.learningGoalsFr,
                        accommodations: originalLesson.accommodations,
                        modifications: originalLesson.modifications,
                        extensions: originalLesson.extensions,
                        assessmentType: originalLesson.assessmentType,
                        assessmentNotes: originalLesson.assessmentNotes,
                        isSubFriendly: originalLesson.isSubFriendly,
                        subNotes: originalLesson.subNotes,
                        expectations: {
                            create: originalLesson.expectations.map(e => ({
                                expectationId: e.expectationId,
                            })),
                        },
                    },
                });
                break;
            // TODO: Implement copying for other plan types
            default:
                return res.status(400).json({ error: 'Copying this plan type is not yet supported' });
        }
        // Update copy count
        await prisma.sharedPlan.update({
            where: { id: sharedPlan.id },
            data: { copyCount: { increment: 1 } },
        });
        logger.info(`Plan copied: ${sharedPlan.planType}/${sharedPlan.planId} by user ${userId}`);
        res.status(201).json(copiedPlan);
    }));
    return router;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9yb3V0ZXMvc2hhcmluZy50cyIsIm1hcHBpbmdzIjoiQUFBQTs7O0dBR0c7QUFFSCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRWpDLE9BQU8sRUFBRSxDQUFDLEVBQUUsTUFBTSxLQUFLLENBQUM7QUFDeEIsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN6RCxPQUFPLE1BQU0sTUFBTSxVQUFVLENBQUM7QUFDOUIsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUVuQyxxQkFBcUI7QUFDckIsTUFBTSxlQUFlLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUMvQixRQUFRLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLFlBQVksRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQzdELE1BQU0sRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFO0lBQ2xCLFNBQVMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDO1FBQ2pCLENBQUMsQ0FBQyxNQUFNLENBQUM7WUFDUCxJQUFJLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUM7WUFDdkIsS0FBSyxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxLQUFLLEVBQUU7U0FDMUIsQ0FBQztRQUNGLENBQUMsQ0FBQyxNQUFNLENBQUM7WUFDUCxJQUFJLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUM7WUFDdkIsTUFBTSxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUU7U0FDbkIsQ0FBQztRQUNGLENBQUMsQ0FBQyxNQUFNLENBQUM7WUFDUCxJQUFJLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUM7WUFDdkIsYUFBYSxFQUFFLENB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N0IsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUFFLFVBQVUsQ0FBQyxFQUFFLEVBQUU7WUFDNUIsSUFBSSxFQUFFLEVBQUUsU0FBUyxFQUFFLEVBQUUsU0FBUyxFQUFFLENBQUMsRUFBRSxFQUFFO1NBQ3RDLENBQUMsQ0FBQztRQUVILE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLFVBQVUsQ0FBQyxRQUFRLElBQUksVUFBVSxDQUFDLE1BQU0sWUFBWSxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBQzFGLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ25DLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFSixPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9taWNoYWVsbWNpc2FhYy9HaXRIdWIvdGVhY2hpbmctZW5naW5lMi4wL3NlcnZlci9zcmMvcm91dGVzL3NoYXJpbmcudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBQbGFuIFNoYXJpbmcgUm91dGVzXG4gKiBIYW5kbGVzIHNoYXJpbmcgb2YgbGVzc29uIHBsYW5zLCB1bml0cywgYW5kIG90aGVyIHBsYW5uaW5nIHJlc291cmNlc1xuICovXG5cbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgUHJpc21hQ2xpZW50IH0gZnJvbSAnQHRlYWNoaW5nLWVuZ2luZS9kYXRhYmFzZSc7XG5pbXBvcnQgeyB6IH0gZnJvbSAnem9kJztcbmltcG9ydCB7IGF1dGhlbnRpY2F0ZSB9IGZyb20gJ0AvbWlkZGxld2FyZS9hdXRoZW50aWNhdGUnO1xuaW1wb3J0IHsgYXN5bmNIYW5kbGVyIH0gZnJvbSAnQC9taWRkbGV3YXJlL2Vycm9ySGFuZGxlcic7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJ0AvbG9nZ2VyJztcbmltcG9ydCB7IGFkZERheXMgfSBmcm9tICdkYXRlLWZucyc7XG5cbi8vIFZhbGlkYXRpb24gc2NoZW1hc1xuY29uc3Qgc2hhcmVQbGFuU2NoZW1hID0gei5vYmplY3Qoe1xuICBwbGFuVHlwZTogei5lbnVtKFsnbG9uZy1yYW5nZScsICd1bml0JywgJ2xlc3NvbicsICdkYXlib29rJ10pLFxuICBwbGFuSWQ6IHouc3RyaW5nKCksXG4gIHNoYXJlV2l0aDogei51bmlvbihbXG4gICAgei5vYmplY3Qoe1xuICAgICAgdHlwZTogei5saXRlcmFsKCd1c2VyJyksXG4gICAgICBlbWFpbDogei5zdHJpbmcoKS5lbWFpbCgpLFxuICAgIH0pLFxuICAgIHoub2JqZWN0KHtcbiAgICAgIHR5cGU6IHoubGl0ZXJhbCgndGVhbScpLFxuICAgICAgdGVhbUlkOiB6LnN0cmluZygpLFxuICAgIH0pLFxuICAgIHoub2JqZWN0KHtcbiAgICAgIHR5cGU6IHoubGl0ZXJhbCgnbGluaycpLFxuICAgICAgZXhwaXJlc0luRGF5czogei5udW1iZXIoKS5pbnQoKS5taW4oMSkubWF4KDM2NSkub3B0aW9uYWwoKSxcbiAgICB9KSxcbiAgXSksXG4gIHBlcm1pc3Npb25zOiB6Lm9iamVjdCh7XG4gICAgY2FuRWRpdDogei5ib29sZWFuKCkub3B0aW9uYWwoKSxcbiAgICBjYW5Db3B5OiB6LmJvb2xlYW4oKS5vcHRpb25hbCgpLFxuICAgIGNhbkNvbW1lbnQ6IHouYm9vbGVhbigpLm9wdGlvbmFsKCksXG4gICAgY2FuUmVzaGFyZTogei5ib29sZWFuKCkub3B0aW9uYWwoKSxcbiAgfSkub3B0aW9uYWwoKSxcbiAgbWVzc2FnZTogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxufSk7XG5cbmNvbnN0IHVwZGF0ZVNoYXJlUGVybWlzc2lvbnNTY2hlbWEgPSB6Lm9iamVjdCh7XG4gIGNhbkVkaXQ6IHouYm9vbGVhbigpLm9wdGlvbmFsKCksXG4gIGNhbkNvcHk6IHouYm9vbGVhbigpLm9wdGlvbmFsKCksXG4gIGNhbkNvbW1lbnQ6IHouYm9vbGVhbigpLm9wdGlvbmFsKCksXG4gIGNhblJlc2hhcmU6IHouYm9vbGVhbigpLm9wdGlvbmFsKCksXG59KTtcblxuZXhwb3J0IGZ1bmN0aW9uIHNoYXJpbmdSb3V0ZXMocHJpc21hOiBQcmlzbWFDbGllbnQpOiBSb3V0ZXIge1xuICBjb25zdCByb3V0ZXIgPSBSb3V0ZXIoKTtcblxuICAvLyBBcHBseSBhdXRoZW50aWNhdGlvbiB0byBhbGwgcm91dGVzXG4gIHJvdXRlci51c2UoYXV0aGVudGljYXRlKTtcblxuICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gY2hlY2sgcGxhbiBvd25lcnNoaXBcbiAgYXN5bmMgZnVuY3Rpb24gY2hlY2tQbGFuT3duZXJzaGlwKHBsYW5UeXBlOiBzdHJpbmcsIHBsYW5JZDogc3RyaW5nLCB1c2VySWQ6IG51bWJlcik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHN3aXRjaCAocGxhblR5cGUpIHtcbiAgICAgIGNhc2UgJ2xvbmctcmFuZ2UnOlxuICAgICAgICBjb25zdCBsclBsYW4gPSBhd2FpdCBwcmlzbWEubG9uZ1JhbmdlUGxhbi5maW5kVW5pcXVlKHtcbiAgICAgICAgICB3aGVyZTogeyBpZDogcGxhbklkIH0sXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gbHJQbGFuPy51c2VySWQgPT09IHVzZXJJZDtcblxuICAgICAgY2FzZSAndW5pdCc6XG4gICAgICAgIGNvbnN0IHVuaXRQbGFuID0gYXdhaXQgcHJpc21hLnVuaXRQbGFuLmZpbmRVbmlxdWUoe1xuICAgICAgICAgIHdoZXJlOiB7IGlkOiBwbGFuSWQgfSxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB1bml0UGxhbj8udXNlcklkID09PSB1c2VySWQ7XG5cbiAgICAgIGNhc2UgJ2xlc3Nvbic6XG4gICAgICAgIGNvbnN0IGxlc3NvblBsYW4gPSBhd2FpdCBwcmlzbWEuZVRGT0xlc3NvblBsYW4uZmluZFVuaXF1ZSh7XG4gICAgICAgICAgd2hlcmU6IHsgaWQ6IHBsYW5JZCB9LFxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGxlc3NvblBsYW4/LnVzZXJJZCA9PT0gdXNlcklkO1xuXG4gICAgICBjYXNlICdkYXlib29rJzpcbiAgICAgICAgY29uc3QgZGF5Ym9va0VudHJ5ID0gYXdhaXQgcHJpc21hLmRheWJvb2tFbnRyeS5maW5kVW5pcXVlKHtcbiAgICAgICAgICB3aGVyZTogeyBpZDogcGxhbklkIH0sXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gZGF5Ym9va0VudHJ5Py51c2VySWQgPT09IHVzZXJJZDtcblxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIC8vIEdldCBhbGwgc2hhcmVkIHBsYW5zIChib3RoIHNlbnQgYW5kIHJlY2VpdmVkKVxuICByb3V0ZXIuZ2V0KCcvcGxhbnMnLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLmlkO1xuICAgIGNvbnN0IHsgdHlwZSwgZGlyZWN0aW9uIH0gPSByZXEucXVlcnk7XG5cbiAgICBjb25zdCB3aGVyZUNsYXVzZTogYW55ID0ge307XG4gICAgXG4gICAgaWYgKGRpcmVjdGlvbiA9PT0gJ3NlbnQnKSB7XG4gICAgICB3aGVyZUNsYXVzZS5zaGFyZWRCeUlkID0gdXNlcklkO1xuICAgIH0gZWxzZSBpZiAoZGlyZWN0aW9uID09PSAncmVjZWl2ZWQnKSB7XG4gICAgICB3aGVyZUNsYXVzZS5zaGFyZWRXaXRoSWQgPSB1c2VySWQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHdoZXJlQ2xhdXNlLk9SID0gW1xuICAgICAgICB7IHNoYXJlZEJ5SWQ6IHVzZXJJZCB9LFxuICAgICAgICB7IHNoYXJlZFdpdGhJZDogdXNlcklkIH0sXG4gICAgICBdO1xuICAgIH1cblxuICAgIGlmICh0eXBlKSB7XG4gICAgICB3aGVyZUNsYXVzZS5wbGFuVHlwZSA9IHR5cGU7XG4gICAgfVxuXG4gICAgY29uc3Qgc2hhcmVkUGxhbnMgPSBhd2FpdCBwcmlzbWEuc2hhcmVkUGxhbi5maW5kTWFueSh7XG4gICAgICB3aGVyZTogd2hlcmVDbGF1c2UsXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHNoYXJlZEJ5OiB7XG4gICAgICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlLCBuYW1lOiB0cnVlLCBlbWFpbDogdHJ1ZSB9LFxuICAgICAgICB9LFxuICAgICAgICBzaGFyZWRXaXRoOiB7XG4gICAgICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlLCBuYW1lOiB0cnVlLCBlbWFpbDogdHJ1ZSB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIG9yZGVyQnk6IHsgc2hhcmVkQXQ6ICdkZXNjJyB9LFxuICAgIH0pO1xuXG4gICAgLy8gRmV0Y2ggcGxhbiBkZXRhaWxzIGZvciBlYWNoIHNoYXJlZCBwbGFuXG4gICAgY29uc3QgcGxhbnNXaXRoRGV0YWlscyA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgc2hhcmVkUGxhbnMubWFwKGFzeW5jIChzaGFyZSkgPT4ge1xuICAgICAgICBsZXQgcGxhbkRldGFpbHMgPSBudWxsO1xuXG4gICAgICAgIHN3aXRjaCAoc2hhcmUucGxhblR5cGUpIHtcbiAgICAgICAgICBjYXNlICdsb25nLXJhbmdlJzpcbiAgICAgICAgICAgIHBsYW5EZXRhaWxzID0gYXdhaXQgcHJpc21hLmxvbmdSYW5nZVBsYW4uZmluZFVuaXF1ZSh7XG4gICAgICAgICAgICAgIHdoZXJlOiB7IGlkOiBzaGFyZS5wbGFuSWQgfSxcbiAgICAgICAgICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlLCB0aXRsZTogdHJ1ZSwgYWNhZGVtaWNZZWFyOiB0cnVlLCBncmFkZTogdHJ1ZSwgc3ViamVjdDogdHJ1ZSB9LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgIGNhc2UgJ3VuaXQnOlxuICAgICAgICAgICAgcGxhbkRldGFpbHMgPSBhd2FpdCBwcmlzbWEudW5pdFBsYW4uZmluZFVuaXF1ZSh7XG4gICAgICAgICAgICAgIHdoZXJlOiB7IGlkOiBzaGFyZS5wbGFuSWQgfSxcbiAgICAgICAgICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlLCB0aXRsZTogdHJ1ZSwgc3RhcnREYXRlOiB0cnVlLCBlbmREYXRlOiB0cnVlIH0sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgY2FzZSAnbGVzc29uJzpcbiAgICAgICAgICAgIHBsYW5EZXRhaWxzID0gYXdhaXQgcHJpc21hLmVURk9MZXNzb25QbGFuLmZpbmRVbmlxdWUoe1xuICAgICAgICAgICAgICB3aGVyZTogeyBpZDogc2hhcmUucGxhbklkIH0sXG4gICAgICAgICAgICAgIHNlbGVjdDogeyBpZDogdHJ1ZSwgdGl0bGU6IHRydWUsIGRhdGU6IHRydWUsIGdyYWRlOiB0cnVlLCBzdWJqZWN0OiB0cnVlIH0sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgY2FzZSAnZGF5Ym9vayc6XG4gICAgICAgICAgICBwbGFuRGV0YWlscyA9IGF3YWl0IHByaXNtYS5kYXlib29rRW50cnkuZmluZFVuaXF1ZSh7XG4gICAgICAgICAgICAgIHdoZXJlOiB7IGlkOiBzaGFyZS5wbGFuSWQgfSxcbiAgICAgICAgICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlLCBkYXRlOiB0cnVlIH0sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAuLi5zaGFyZSxcbiAgICAgICAgICBwbGFuRGV0YWlscyxcbiAgICAgICAgfTtcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIHJlcy5qc29uKHBsYW5zV2l0aERldGFpbHMpO1xuICB9KSk7XG5cbiAgLy8gU2hhcmUgYSBwbGFuXG4gIHJvdXRlci5wb3N0KCcvcGxhbnMnLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLmlkO1xuICAgIGNvbnN0IHsgcGxhblR5cGUsIHBsYW5JZCwgc2hhcmVXaXRoLCBwZXJtaXNzaW9ucyA9IHt9LCBtZXNzYWdlIH0gPSBzaGFyZVBsYW5TY2hlbWEucGFyc2UocmVxLmJvZHkpO1xuXG4gICAgLy8gQ2hlY2sgaWYgdXNlciBvd25zIHRoZSBwbGFuXG4gICAgY29uc3QgaXNPd25lciA9IGF3YWl0IGNoZWNrUGxhbk93bmVyc2hpcChwbGFuVHlwZSwgcGxhbklkLCB1c2VySWQpO1xuICAgIGlmICghaXNPd25lcikge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgZXJyb3I6ICdZb3UgZG8gbm90IGhhdmUgcGVybWlzc2lvbiB0byBzaGFyZSB0aGlzIHBsYW4nIH0pO1xuICAgIH1cblxuICAgIGxldCBzaGFyZWRQbGFuO1xuXG4gICAgaWYgKHNoYXJlV2l0aC50eXBlID09PSAndXNlcicpIHtcbiAgICAgIC8vIFNoYXJlIHdpdGggc3BlY2lmaWMgdXNlclxuICAgICAgY29uc3QgdGFyZ2V0VXNlciA9IGF3YWl0IHByaXNtYS51c2VyLmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyBlbWFpbDogc2hhcmVXaXRoLmVtYWlsIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCF0YXJnZXRVc2VyKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IGVycm9yOiAnVXNlciBub3QgZm91bmQnIH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAodGFyZ2V0VXNlci5pZCA9PT0gdXNlcklkKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiAnQ2Fubm90IHNoYXJlIHdpdGggeW91cnNlbGYnIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBpZiBhbHJlYWR5IHNoYXJlZFxuICAgICAgY29uc3QgZXhpc3RpbmdTaGFyZSA9IGF3YWl0IHByaXNtYS5zaGFyZWRQbGFuLmZpbmRGaXJzdCh7XG4gICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgcGxhblR5cGUsXG4gICAgICAgICAgcGxhbklkLFxuICAgICAgICAgIHNoYXJlZEJ5SWQ6IHVzZXJJZCxcbiAgICAgICAgICBzaGFyZWRXaXRoSWQ6IHRhcmdldFVzZXIuaWQsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKGV4aXN0aW5nU2hhcmUpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA5KS5qc29uKHsgZXJyb3I6ICdQbGFuIGlzIGFscmVhZHkgc2hhcmVkIHdpdGggdGhpcyB1c2VyJyB9KTtcbiAgICAgIH1cblxuICAgICAgc2hhcmVkUGxhbiA9IGF3YWl0IHByaXNtYS5zaGFyZWRQbGFuLmNyZWF0ZSh7XG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBwbGFuVHlwZSxcbiAgICAgICAgICBwbGFuSWQsXG4gICAgICAgICAgc2hhcmVkQnlJZDogdXNlcklkLFxuICAgICAgICAgIHNoYXJlZFdpdGhJZDogdGFyZ2V0VXNlci5pZCxcbiAgICAgICAgICAuLi5wZXJtaXNzaW9ucyxcbiAgICAgICAgICBtZXNzYWdlLFxuICAgICAgICB9LFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgc2hhcmVkQnk6IHtcbiAgICAgICAgICAgIHNlbGVjdDogeyBpZDogdHJ1ZSwgbmFtZTogdHJ1ZSwgZW1haWw6IHRydWUgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHNoYXJlZFdpdGg6IHtcbiAgICAgICAgICAgIHNlbGVjdDogeyBpZDogdHJ1ZSwgbmFtZTogdHJ1ZSwgZW1haWw6IHRydWUgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFRPRE86IFNlbmQgZW1haWwgbm90aWZpY2F0aW9uXG4gICAgfSBlbHNlIGlmIChzaGFyZVdpdGgudHlwZSA9PT0gJ3RlYW0nKSB7XG4gICAgICAvLyBTaGFyZSB3aXRoIHRlYW1cbiAgICAgIGNvbnN0IHRlYW0gPSBhd2FpdCBwcmlzbWEudGVhbS5maW5kVW5pcXVlKHtcbiAgICAgICAgd2hlcmU6IHsgaWQ6IHNoYXJlV2l0aC50ZWFtSWQgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIXRlYW0pIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgZXJyb3I6ICdUZWFtIG5vdCBmb3VuZCcgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIGlmIHVzZXIgaXMgYSBtZW1iZXIgb2YgdGhlIHRlYW1cbiAgICAgIGNvbnN0IGlzTWVtYmVyID0gYXdhaXQgcHJpc21hLnRlYW1NZW1iZXIuZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7IHRlYW1JZF91c2VySWQ6IHsgdGVhbUlkOiBzaGFyZVdpdGgudGVhbUlkLCB1c2VySWQgfSB9LFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghaXNNZW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgZXJyb3I6ICdZb3UgbXVzdCBiZSBhIHRlYW0gbWVtYmVyIHRvIHNoYXJlIHdpdGggdGhlIHRlYW0nIH0pO1xuICAgICAgfVxuXG4gICAgICBzaGFyZWRQbGFuID0gYXdhaXQgcHJpc21hLnNoYXJlZFBsYW4uY3JlYXRlKHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIHBsYW5UeXBlLFxuICAgICAgICAgIHBsYW5JZCxcbiAgICAgICAgICBzaGFyZWRCeUlkOiB1c2VySWQsXG4gICAgICAgICAgdGVhbUlkOiBzaGFyZVdpdGgudGVhbUlkLFxuICAgICAgICAgIC4uLnBlcm1pc3Npb25zLFxuICAgICAgICAgIG1lc3NhZ2UsXG4gICAgICAgIH0sXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICBzaGFyZWRCeToge1xuICAgICAgICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlLCBuYW1lOiB0cnVlLCBlbWFpbDogdHJ1ZSB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gQ3JlYXRlIHB1YmxpYyBzaGFyaW5nIGxpbmtcbiAgICAgIGNvbnN0IGV4cGlyZXNBdCA9IHNoYXJlV2l0aC5leHBpcmVzSW5EYXlzXG4gICAgICAgID8gYWRkRGF5cyhuZXcgRGF0ZSgpLCBzaGFyZVdpdGguZXhwaXJlc0luRGF5cylcbiAgICAgICAgOiB1bmRlZmluZWQ7XG5cbiAgICAgIHNoYXJlZFBsYW4gPSBhd2FpdCBwcmlzbWEuc2hhcmVkUGxhbi5jcmVhdGUoe1xuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgcGxhblR5cGUsXG4gICAgICAgICAgcGxhbklkLFxuICAgICAgICAgIHNoYXJlZEJ5SWQ6IHVzZXJJZCxcbiAgICAgICAgICBpc1B1YmxpY0xpbms6IHRydWUsXG4gICAgICAgICAgbGlua0V4cGlyZXNBdDogZXhwaXJlc0F0LFxuICAgICAgICAgIC4uLnBlcm1pc3Npb25zLFxuICAgICAgICAgIG1lc3NhZ2UsXG4gICAgICAgIH0sXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICBzaGFyZWRCeToge1xuICAgICAgICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlLCBuYW1lOiB0cnVlLCBlbWFpbDogdHJ1ZSB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBsb2dnZXIuaW5mbyhgUGxhbiBzaGFyZWQ6ICR7cGxhblR5cGV9LyR7cGxhbklkfSBieSB1c2VyICR7dXNlcklkfWApO1xuICAgIHJlcy5zdGF0dXMoMjAxKS5qc29uKHNoYXJlZFBsYW4pO1xuICB9KSk7XG5cbiAgLy8gR2V0IHNoYXJlZCBwbGFuIGJ5IHNoYXJlIGNvZGVcbiAgcm91dGVyLmdldCgnL3BsYW5zLzpzaGFyZUNvZGUnLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgY29uc3QgeyBzaGFyZUNvZGUgfSA9IHJlcS5wYXJhbXM7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLmlkO1xuXG4gICAgY29uc3Qgc2hhcmVkUGxhbiA9IGF3YWl0IHByaXNtYS5zaGFyZWRQbGFuLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgc2hhcmVDb2RlIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHNoYXJlZEJ5OiB7XG4gICAgICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlLCBuYW1lOiB0cnVlLCBlbWFpbDogdHJ1ZSB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghc2hhcmVkUGxhbikge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgZXJyb3I6ICdTaGFyZWQgcGxhbiBub3QgZm91bmQnIH0pO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGFjY2VzcyBwZXJtaXNzaW9uc1xuICAgIGNvbnN0IGhhc0FjY2VzcyA9IHNoYXJlZFBsYW4uaXNQdWJsaWNMaW5rIHx8XG4gICAgICBzaGFyZWRQbGFuLnNoYXJlZEJ5SWQgPT09IHVzZXJJZCB8fFxuICAgICAgc2hhcmVkUGxhbi5zaGFyZWRXaXRoSWQgPT09IHVzZXJJZDtcblxuICAgIGlmICghaGFzQWNjZXNzICYmIHNoYXJlZFBsYW4udGVhbUlkKSB7XG4gICAgICAvLyBDaGVjayB0ZWFtIG1lbWJlcnNoaXBcbiAgICAgIGNvbnN0IGlzTWVtYmVyID0gYXdhaXQgcHJpc21hLnRlYW1NZW1iZXIuZmluZEZpcnN0KHtcbiAgICAgICAgd2hlcmU6IHsgdGVhbUlkOiBzaGFyZWRQbGFuLnRlYW1JZCwgdXNlcklkIH0sXG4gICAgICB9KTtcbiAgICAgIGlmICghaXNNZW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgZXJyb3I6ICdBY2Nlc3MgZGVuaWVkJyB9KTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKCFoYXNBY2Nlc3MpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnQWNjZXNzIGRlbmllZCcgfSk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgbGluayBoYXMgZXhwaXJlZFxuICAgIGlmIChzaGFyZWRQbGFuLmxpbmtFeHBpcmVzQXQgJiYgbmV3IERhdGUoKSA+IHNoYXJlZFBsYW4ubGlua0V4cGlyZXNBdCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDEwKS5qc29uKHsgZXJyb3I6ICdTaGFyZSBsaW5rIGhhcyBleHBpcmVkJyB9KTtcbiAgICB9XG5cbiAgICAvLyBVcGRhdGUgdmlldyBjb3VudFxuICAgIGF3YWl0IHByaXNtYS5zaGFyZWRQbGFuLnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyBpZDogc2hhcmVkUGxhbi5pZCB9LFxuICAgICAgZGF0YToge1xuICAgICAgICB2aWV3Q291bnQ6IHsgaW5jcmVtZW50OiAxIH0sXG4gICAgICAgIGxhc3RWaWV3ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBGZXRjaCBwbGFuIGRldGFpbHNcbiAgICBsZXQgcGxhbkRldGFpbHMgPSBudWxsO1xuXG4gICAgc3dpdGNoIChzaGFyZWRQbGFuLnBsYW5UeXBlKSB7XG4gICAgICBjYXNlICdsb25nLXJhbmdlJzpcbiAgICAgICAgcGxhbkRldGFpbHMgPSBhd2FpdCBwcmlzbWEubG9uZ1JhbmdlUGxhbi5maW5kVW5pcXVlKHtcbiAgICAgICAgICB3aGVyZTogeyBpZDogc2hhcmVkUGxhbi5wbGFuSWQgfSxcbiAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICBleHBlY3RhdGlvbnM6IHtcbiAgICAgICAgICAgICAgaW5jbHVkZTogeyBleHBlY3RhdGlvbjogdHJ1ZSB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHVuaXRQbGFuczoge1xuICAgICAgICAgICAgICBzZWxlY3Q6IHsgaWQ6IHRydWUsIHRpdGxlOiB0cnVlLCBzdGFydERhdGU6IHRydWUsIGVuZERhdGU6IHRydWUgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlICd1bml0JzpcbiAgICAgICAgcGxhbkRldGFpbHMgPSBhd2FpdCBwcmlzbWEudW5pdFBsYW4uZmluZFVuaXF1ZSh7XG4gICAgICAgICAgd2hlcmU6IHsgaWQ6IHNoYXJlZFBsYW4ucGxhbklkIH0sXG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgZXhwZWN0YXRpb25zOiB7XG4gICAgICAgICAgICAgIGluY2x1ZGU6IHsgZXhwZWN0YXRpb246IHRydWUgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBsZXNzb25QbGFuczoge1xuICAgICAgICAgICAgICBzZWxlY3Q6IHsgaWQ6IHRydWUsIHRpdGxlOiB0cnVlLCBkYXRlOiB0cnVlIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcmVzb3VyY2VzOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAnbGVzc29uJzpcbiAgICAgICAgcGxhbkRldGFpbHMgPSBhd2FpdCBwcmlzbWEuZVRGT0xlc3NvblBsYW4uZmluZFVuaXF1ZSh7XG4gICAgICAgICAgd2hlcmU6IHsgaWQ6IHNoYXJlZFBsYW4ucGxhbklkIH0sXG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgZXhwZWN0YXRpb25zOiB7XG4gICAgICAgICAgICAgIGluY2x1ZGU6IHsgZXhwZWN0YXRpb246IHRydWUgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICByZXNvdXJjZXM6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlICdkYXlib29rJzpcbiAgICAgICAgcGxhbkRldGFpbHMgPSBhd2FpdCBwcmlzbWEuZGF5Ym9va0VudHJ5LmZpbmRVbmlxdWUoe1xuICAgICAgICAgIHdoZXJlOiB7IGlkOiBzaGFyZWRQbGFuLnBsYW5JZCB9LFxuICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgIGV4cGVjdGF0aW9uczoge1xuICAgICAgICAgICAgICBpbmNsdWRlOiB7IGV4cGVjdGF0aW9uOiB0cnVlIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICByZXMuanNvbih7XG4gICAgICBzaGFyZTogc2hhcmVkUGxhbixcbiAgICAgIHBsYW46IHBsYW5EZXRhaWxzLFxuICAgIH0pO1xuICB9KSk7XG5cbiAgLy8gVXBkYXRlIHNoYXJlIHBlcm1pc3Npb25zXG4gIHJvdXRlci5wYXRjaCgnL3BsYW5zLzpzaGFyZUlkJywgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICAgIGNvbnN0IHsgc2hhcmVJZCB9ID0gcmVxLnBhcmFtcztcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuaWQ7XG4gICAgY29uc3QgdXBkYXRlcyA9IHVwZGF0ZVNoYXJlUGVybWlzc2lvbnNTY2hlbWEucGFyc2UocmVxLmJvZHkpO1xuXG4gICAgY29uc3Qgc2hhcmVkUGxhbiA9IGF3YWl0IHByaXNtYS5zaGFyZWRQbGFuLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHNoYXJlSWQgfSxcbiAgICB9KTtcblxuICAgIGlmICghc2hhcmVkUGxhbikge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgZXJyb3I6ICdTaGFyZWQgcGxhbiBub3QgZm91bmQnIH0pO1xuICAgIH1cblxuICAgIC8vIE9ubHkgdGhlIHNoYXJlciBjYW4gdXBkYXRlIHBlcm1pc3Npb25zXG4gICAgaWYgKHNoYXJlZFBsYW4uc2hhcmVkQnlJZCAhPT0gdXNlcklkKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ09ubHkgdGhlIHBsYW4gb3duZXIgY2FuIHVwZGF0ZSBzaGFyZSBwZXJtaXNzaW9ucycgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgdXBkYXRlZCA9IGF3YWl0IHByaXNtYS5zaGFyZWRQbGFuLnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyBpZDogc2hhcmVJZCB9LFxuICAgICAgZGF0YTogdXBkYXRlcyxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgc2hhcmVkQnk6IHtcbiAgICAgICAgICBzZWxlY3Q6IHsgaWQ6IHRydWUsIG5hbWU6IHRydWUsIGVtYWlsOiB0cnVlIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHNoYXJlZFdpdGg6IHtcbiAgICAgICAgICBzZWxlY3Q6IHsgaWQ6IHRydWUsIG5hbWU6IHRydWUsIGVtYWlsOiB0cnVlIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgcmVzLmpzb24odXBkYXRlZCk7XG4gIH0pKTtcblxuICAvLyBSZXZva2Ugc2hhcmVcbiAgcm91dGVyLmRlbGV0ZSgnL3BsYW5zLzpzaGFyZUlkJywgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICAgIGNvbnN0IHsgc2hhcmVJZCB9ID0gcmVxLnBhcmFtcztcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuaWQ7XG5cbiAgICBjb25zdCBzaGFyZWRQbGFuID0gYXdhaXQgcHJpc21hLnNoYXJlZFBsYW4uZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBpZDogc2hhcmVJZCB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFzaGFyZWRQbGFuKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBlcnJvcjogJ1NoYXJlZCBwbGFuIG5vdCBmb3VuZCcgfSk7XG4gICAgfVxuXG4gICAgLy8gT25seSB0aGUgc2hhcmVyIGNhbiByZXZva2VcbiAgICBpZiAoc2hhcmVkUGxhbi5zaGFyZWRCeUlkICE9PSB1c2VySWQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnT25seSB0aGUgcGxhbiBvd25lciBjYW4gcmV2b2tlIHNoYXJpbmcnIH0pO1xuICAgIH1cblxuICAgIGF3YWl0IHByaXNtYS5zaGFyZWRQbGFuLmRlbGV0ZSh7XG4gICAgICB3aGVyZTogeyBpZDogc2hhcmVJZCB9LFxuICAgIH0pO1xuXG4gICAgbG9nZ2VyLmluZm8oYFNoYXJlIHJldm9rZWQ6ICR7c2hhcmVJZH0gYnkgdXNlciAke3VzZXJJZH1gKTtcbiAgICByZXMuc3RhdHVzKDIwNCkuc2VuZCgpO1xuICB9KSk7XG5cbiAgLy8gQ29weSBzaGFyZWQgcGxhblxuICByb3V0ZXIucG9zdCgnL3BsYW5zLzpzaGFyZUNvZGUvY29weScsIGFzeW5jSGFuZGxlcihhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICBjb25zdCB7IHNoYXJlQ29kZSB9ID0gcmVxLnBhcmFtcztcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuaWQ7XG5cbiAgICBjb25zdCBzaGFyZWRQbGFuID0gYXdhaXQgcHJpc21hLnNoYXJlZFBsYW4uZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBzaGFyZUNvZGUgfSxcbiAgICB9KTtcblxuICAgIGlmICghc2hhcmVkUGxhbikge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgZXJyb3I6ICdTaGFyZWQgcGxhbiBub3QgZm91bmQnIH0pO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHVzZXIgaGFzIGNvcHkgcGVybWlzc2lvblxuICAgIGlmICghc2hhcmVkUGxhbi5jYW5Db3B5KSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ0NvcHlpbmcgdGhpcyBwbGFuIGlzIG5vdCBhbGxvd2VkJyB9KTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBhY2Nlc3NcbiAgICBjb25zdCBoYXNBY2Nlc3MgPSBzaGFyZWRQbGFuLmlzUHVibGljTGluayB8fFxuICAgICAgc2hhcmVkUGxhbi5zaGFyZWRXaXRoSWQgPT09IHVzZXJJZDtcblxuICAgIGlmICghaGFzQWNjZXNzICYmIHNoYXJlZFBsYW4udGVhbUlkKSB7XG4gICAgICBjb25zdCBpc01lbWJlciA9IGF3YWl0IHByaXNtYS50ZWFtTWVtYmVyLmZpbmRGaXJzdCh7XG4gICAgICAgIHdoZXJlOiB7IHRlYW1JZDogc2hhcmVkUGxhbi50ZWFtSWQsIHVzZXJJZCB9LFxuICAgICAgfSk7XG4gICAgICBpZiAoIWlzTWVtYmVyKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnQWNjZXNzIGRlbmllZCcgfSk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmICghaGFzQWNjZXNzKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ0FjY2VzcyBkZW5pZWQnIH0pO1xuICAgIH1cblxuICAgIC8vIENvcHkgdGhlIHBsYW4gYmFzZWQgb24gdHlwZVxuICAgIGxldCBjb3BpZWRQbGFuO1xuXG4gICAgc3dpdGNoIChzaGFyZWRQbGFuLnBsYW5UeXBlKSB7XG4gICAgICBjYXNlICdsZXNzb24nOlxuICAgICAgICBjb25zdCBvcmlnaW5hbExlc3NvbiA9IGF3YWl0IHByaXNtYS5lVEZPTGVzc29uUGxhbi5maW5kVW5pcXVlKHtcbiAgICAgICAgICB3aGVyZTogeyBpZDogc2hhcmVkUGxhbi5wbGFuSWQgfSxcbiAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICBleHBlY3RhdGlvbnM6IHRydWUsXG4gICAgICAgICAgICByZXNvdXJjZXM6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKCFvcmlnaW5hbExlc3Nvbikge1xuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IGVycm9yOiAnT3JpZ2luYWwgcGxhbiBub3QgZm91bmQnIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gR2V0IHVzZXIncyB1bml0IHBsYW5zIHRvIHNlbGVjdCBmcm9tXG4gICAgICAgIGNvbnN0IHVzZXJVbml0UGxhbnMgPSBhd2FpdCBwcmlzbWEudW5pdFBsYW4uZmluZE1hbnkoe1xuICAgICAgICAgIHdoZXJlOiB7IHVzZXJJZCB9LFxuICAgICAgICAgIHNlbGVjdDogeyBpZDogdHJ1ZSB9LFxuICAgICAgICAgIHRha2U6IDEsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICh1c2VyVW5pdFBsYW5zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiAnWW91IG5lZWQgYXQgbGVhc3Qgb25lIHVuaXQgcGxhbiB0byBjb3B5IGxlc3NvbnMnIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgY29waWVkUGxhbiA9IGF3YWl0IHByaXNtYS5lVEZPTGVzc29uUGxhbi5jcmVhdGUoe1xuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgIHRpdGxlOiBgJHtvcmlnaW5hbExlc3Nvbi50aXRsZX0gKENvcHkpYCxcbiAgICAgICAgICAgIHVuaXRQbGFuSWQ6IHVzZXJVbml0UGxhbnNbMF0uaWQsIC8vIFRPRE86IEFsbG93IHVzZXIgdG8gc2VsZWN0IHVuaXRcbiAgICAgICAgICAgIGdyYWRlOiBvcmlnaW5hbExlc3Nvbi5ncmFkZSxcbiAgICAgICAgICAgIHN1YmplY3Q6IG9yaWdpbmFsTGVzc29uLnN1YmplY3QsXG4gICAgICAgICAgICBsYW5ndWFnZTogb3JpZ2luYWxMZXNzb24ubGFuZ3VhZ2UsXG4gICAgICAgICAgICBkYXRlOiBuZXcgRGF0ZSgpLFxuICAgICAgICAgICAgZHVyYXRpb246IG9yaWdpbmFsTGVzc29uLmR1cmF0aW9uLFxuICAgICAgICAgICAgbWluZHNPbjogb3JpZ2luYWxMZXNzb24ubWluZHNPbixcbiAgICAgICAgICAgIGFjdGlvbjogb3JpZ2luYWxMZXNzb24uYWN0aW9uLFxuICAgICAgICAgICAgY29uc29saWRhdGlvbjogb3JpZ2luYWxMZXNzb24uY29uc29saWRhdGlvbixcbiAgICAgICAgICAgIGxlYXJuaW5nR29hbHM6IG9yaWdpbmFsTGVzc29uLmxlYXJuaW5nR29hbHMsXG4gICAgICAgICAgICBtYXRlcmlhbHM6IG9yaWdpbmFsTGVzc29uLm1hdGVyaWFscyxcbiAgICAgICAgICAgIGdyb3VwaW5nOiBvcmlnaW5hbExlc3Nvbi5ncm91cGluZyxcbiAgICAgICAgICAgIHRpdGxlRnI6IG9yaWdpbmFsTGVzc29uLnRpdGxlRnIsXG4gICAgICAgICAgICBtaW5kc09uRnI6IG9yaWdpbmFsTGVzc29uLm1pbmRzT25GcixcbiAgICAgICAgICAgIGFjdGlvbkZyOiBvcmlnaW5hbExlc3Nvbi5hY3Rpb25GcixcbiAgICAgICAgICAgIGNvbnNvbGlkYXRpb25Gcjogb3JpZ2luYWxMZXNzb24uY29uc29saWRhdGlvbkZyLFxuICAgICAgICAgICAgbGVhcm5pbmdHb2Fsc0ZyOiBvcmlnaW5hbExlc3Nvbi5sZWFybmluZ0dvYWxzRnIsXG4gICAgICAgICAgICBhY2NvbW1vZGF0aW9uczogb3JpZ2luYWxMZXNzb24uYWNjb21tb2RhdGlvbnMsXG4gICAgICAgICAgICBtb2RpZmljYXRpb25zOiBvcmlnaW5hbExlc3Nvbi5tb2RpZmljYXRpb25zLFxuICAgICAgICAgICAgZXh0ZW5zaW9uczogb3JpZ2luYWxMZXNzb24uZXh0ZW5zaW9ucyxcbiAgICAgICAgICAgIGFzc2Vzc21lbnRUeXBlOiBvcmlnaW5hbExlc3Nvbi5hc3Nlc3NtZW50VHlwZSxcbiAgICAgICAgICAgIGFzc2Vzc21lbnROb3Rlczogb3JpZ2luYWxMZXNzb24uYXNzZXNzbWVudE5vdGVzLFxuICAgICAgICAgICAgaXNTdWJGcmllbmRseTogb3JpZ2luYWxMZXNzb24uaXNTdWJGcmllbmRseSxcbiAgICAgICAgICAgIHN1Yk5vdGVzOiBvcmlnaW5hbExlc3Nvbi5zdWJOb3RlcyxcbiAgICAgICAgICAgIGV4cGVjdGF0aW9uczoge1xuICAgICAgICAgICAgICBjcmVhdGU6IG9yaWdpbmFsTGVzc29uLmV4cGVjdGF0aW9ucy5tYXAoZSA9PiAoe1xuICAgICAgICAgICAgICAgIGV4cGVjdGF0aW9uSWQ6IGUuZXhwZWN0YXRpb25JZCxcbiAgICAgICAgICAgICAgfSkpLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIC8vIFRPRE86IEltcGxlbWVudCBjb3B5aW5nIGZvciBvdGhlciBwbGFuIHR5cGVzXG5cbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiAnQ29weWluZyB0aGlzIHBsYW4gdHlwZSBpcyBub3QgeWV0IHN1cHBvcnRlZCcgfSk7XG4gICAgfVxuXG4gICAgLy8gVXBkYXRlIGNvcHkgY291bnRcbiAgICBhd2FpdCBwcmlzbWEuc2hhcmVkUGxhbi51cGRhdGUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHNoYXJlZFBsYW4uaWQgfSxcbiAgICAgIGRhdGE6IHsgY29weUNvdW50OiB7IGluY3JlbWVudDogMSB9IH0sXG4gICAgfSk7XG5cbiAgICBsb2dnZXIuaW5mbyhgUGxhbiBjb3BpZWQ6ICR7c2hhcmVkUGxhbi5wbGFuVHlwZX0vJHtzaGFyZWRQbGFuLnBsYW5JZH0gYnkgdXNlciAke3VzZXJJZH1gKTtcbiAgICByZXMuc3RhdHVzKDIwMSkuanNvbihjb3BpZWRQbGFuKTtcbiAgfSkpO1xuXG4gIHJldHVybiByb3V0ZXI7XG59Il0sInZlcnNpb24iOjN9