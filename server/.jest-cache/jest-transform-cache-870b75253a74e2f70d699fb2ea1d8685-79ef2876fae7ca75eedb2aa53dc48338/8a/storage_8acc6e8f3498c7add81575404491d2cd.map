{"version":3,"names":["cov_1zgiqk4sz4","actualCoverage","fs","path","fileURLToPath","__filename_storage","s","import","meta","url","__dirname_storage","dirname","s3Client","bucket","process","env","AWS_BUCKET_NAME","b","AWS_ACCESS_KEY_ID","AWS_SECRET_ACCESS_KEY","S3Client","require","region","AWS_REGION","localDir","join","saveFile","filename","buffer","f","PutObjectCommand","key","Date","now","send","Bucket","Key","Body","mkdir","recursive","filePath","writeFile"],"sources":["/Users/michaelmcisaac/GitHub/teaching-engine2.0/server/src/storage.ts"],"sourcesContent":["import fs from 'fs/promises';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\n\nconst __filename_storage = fileURLToPath(import.meta.url);\nconst __dirname_storage = path.dirname(__filename_storage);\n\n// use any to avoid requiring aws-sdk types when not installed\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nlet s3Client: unknown = null;\nconst bucket = process.env.AWS_BUCKET_NAME;\nif (bucket && process.env.AWS_ACCESS_KEY_ID && process.env.AWS_SECRET_ACCESS_KEY) {\n  // eslint-disable-next-line @typescript-eslint/no-var-requires\n  const { S3Client } = require('@aws-sdk/client-s3');\n  s3Client = new S3Client({ region: process.env.AWS_REGION || 'us-east-1' });\n}\n\nconst localDir = path.join(__dirname_storage, '../uploads');\n\n/**\n * Save a file to either local disk or S3 depending on env config.\n * @param filename output file name\n * @param buffer file contents\n * @returns public URL to the stored file\n */\nexport async function saveFile(filename: string, buffer: Buffer): Promise<string> {\n  if (s3Client && bucket) {\n    // eslint-disable-next-line @typescript-eslint/no-var-requires\n    const { PutObjectCommand } = require('@aws-sdk/client-s3');\n    const key = `${Date.now()}-${filename}`;\n    await (s3Client as { send: (command: unknown) => Promise<unknown> }).send(\n      new PutObjectCommand({ Bucket: bucket, Key: key, Body: buffer }),\n    );\n    return `https://${bucket}.s3.amazonaws.com/${key}`;\n  }\n  await fs.mkdir(localDir, { recursive: true });\n  const filePath = path.join(localDir, filename);\n  await fs.writeFile(filePath, buffer);\n  return `/uploads/${filename}`;\n}\n"],"mappings":"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","ignoreList":[]}