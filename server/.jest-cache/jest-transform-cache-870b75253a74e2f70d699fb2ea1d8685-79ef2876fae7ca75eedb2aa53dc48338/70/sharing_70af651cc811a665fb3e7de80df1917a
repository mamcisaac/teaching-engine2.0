57d2d4896947146e5d03103bfc9bd946
/**
 * Plan Sharing Routes
 * Handles sharing of lesson plans, units, and other planning resources
 */
import { Router } from 'express';
import { z } from 'zod';
import { authenticate } from '@/middleware/authenticate';
import { asyncHandler } from '@/middleware/errorHandler';
import logger from '@/logger';
import { addDays } from 'date-fns';
// Validation schemas
const sharePlanSchema = z.object({
    planType: z.enum(['long-range', 'unit', 'lesson', 'daybook']),
    planId: z.string(),
    shareWith: z.union([
        z.object({
            type: z.literal('user'),
            email: z.string().email(),
        }),
        z.object({
            type: z.literal('team'),
            teamId: z.string(),
        }),
        z.object({
            type: z.literal('link'),
            expiresInDays: z.number().int().min(1).max(365).optional(),
        }),
    ]),
    permissions: z.object({
        canEdit: z.boolean().optional(),
        canCopy: z.boolean().optional(),
        canComment: z.boolean().optional(),
        canReshare: z.boolean().optional(),
    }).optional(),
    message: z.string().optional(),
});
const updateSharePermissionsSchema = z.object({
    canEdit: z.boolean().optional(),
    canCopy: z.boolean().optional(),
    canComment: z.boolean().optional(),
    canReshare: z.boolean().optional(),
});
export function sharingRoutes(prisma) {
    const router = Router();
    // Apply authentication to all routes
    router.use(authenticate);
    // Helper function to check plan ownership
    async function checkPlanOwnership(planType, planId, userId) {
        switch (planType) {
            case 'long-range': {
                const lrPlan = await prisma.longRangePlan.findUnique({
                    where: { id: planId },
                });
                return lrPlan?.userId === userId;
            }
            case 'unit': {
                const unitPlan = await prisma.unitPlan.findUnique({
                    where: { id: planId },
                });
                return unitPlan?.userId === userId;
            }
            case 'lesson': {
                const lessonPlan = await prisma.eTFOLessonPlan.findUnique({
                    where: { id: planId },
                });
                return lessonPlan?.userId === userId;
            }
            case 'daybook': {
                const daybookEntry = await prisma.daybookEntry.findUnique({
                    where: { id: planId },
                });
                return daybookEntry?.userId === userId;
            }
            default:
                return false;
        }
    }
    // Get all shared plans (both sent and received)
    router.get('/plans', asyncHandler(async (req, res) => {
        const userId = req.user.id;
        const { type, direction } = req.query;
        const whereClause = {};
        if (direction === 'sent') {
            whereClause.sharedById = userId;
        }
        else if (direction === 'received') {
            whereClause.sharedWithId = userId;
        }
        else {
            whereClause.OR = [
                { sharedById: userId },
                { sharedWithId: userId },
            ];
        }
        if (type) {
            whereClause.planType = type;
        }
        const sharedPlans = await prisma.sharedPlan.findMany({
            where: whereClause,
            include: {
                sharedBy: {
                    select: { id: true, name: true, email: true },
                },
                sharedWith: {
                    select: { id: true, name: true, email: true },
                },
            },
            orderBy: { sharedAt: 'desc' },
        });
        // Fetch plan details for each shared plan
        const plansWithDetails = await Promise.all(sharedPlans.map(async (share) => {
            let planDetails = null;
            switch (share.planType) {
                case 'long-range':
                    planDetails = await prisma.longRangePlan.findUnique({
                        where: { id: share.planId },
                        select: { id: true, title: true, academicYear: true, grade: true, subject: true },
                    });
                    break;
                case 'unit':
                    planDetails = await prisma.unitPlan.findUnique({
                        where: { id: share.planId },
                        select: { id: true, title: true, startDate: true, endDate: true },
                    });
                    break;
                case 'lesson':
                    planDetails = await prisma.eTFOLessonPlan.findUnique({
                        where: { id: share.planId },
                        select: { id: true, title: true, date: true, grade: true, subject: true },
                    });
                    break;
                case 'daybook':
                    planDetails = await prisma.daybookEntry.findUnique({
                        where: { id: share.planId },
                        select: { id: true, date: true },
                    });
                    break;
            }
            return {
                ...share,
                planDetails,
            };
        }));
        res.json(plansWithDetails);
    }));
    // Share a plan
    router.post('/plans', asyncHandler(async (req, res) => {
        const userId = req.user.id;
        const { planType, planId, shareWith, permissions = {}, message } = sharePlanSchema.parse(req.body);
        // Check if user owns the plan
        const isOwner = await checkPlanOwnership(planType, planId, userId);
        if (!isOwner) {
            return res.status(403).json({ error: 'You do not have permission to share this plan' });
        }
        let sharedPlan;
        if (shareWith.type === 'user') {
            // Share with specific user
            const targetUser = await prisma.user.findUnique({
                where: { email: shareWith.email },
            });
            if (!targetUser) {
                return res.status(404).json({ error: 'User not found' });
            }
            if (targetUser.id === userId) {
                return res.status(400).json({ error: 'Cannot share with yourself' });
            }
            // Check if already shared
            const existingShare = await prisma.sharedPlan.findFirst({
                where: {
                    planType,
                    planId,
                    sharedById: userId,
                    sharedWithId: targetUser.id,
                },
            });
            if (existingShare) {
                return res.status(409).json({ error: 'Plan is already shared with this user' });
            }
            sharedPlan = await prisma.sharedPlan.create({
                data: {
                    planType,
                    planId,
                    sharedById: userId,
                    sharedWithId: targetUser.id,
                    ...permissions,
                    message,
                },
                include: {
                    sharedBy: {
                        select: { id: true, name: true, email: true },
                    },
                    sharedWith: {
                        select: { id: true, name: true, email: true },
                    },
                },
            });
            // TODO: Send email notification
        }
        else if (shareWith.type === 'team') {
            // Share with team
            const team = await prisma.team.findUnique({
                where: { id: shareWith.teamId },
            });
            if (!team) {
                return res.status(404).json({ error: 'Team not found' });
            }
            // Check if user is a member of the team
            const isMember = await prisma.teamMember.findUnique({
                where: { teamId_userId: { teamId: shareWith.teamId, userId } },
            });
            if (!isMember) {
                return res.status(403).json({ error: 'You must be a team member to share with the team' });
            }
            sharedPlan = await prisma.sharedPlan.create({
                data: {
                    planType,
                    planId,
                    sharedById: userId,
                    teamId: shareWith.teamId,
                    ...permissions,
                    message,
                },
                include: {
                    sharedBy: {
                        select: { id: true, name: true, email: true },
                    },
                },
            });
        }
        else {
            // Create public sharing link
            const expiresAt = shareWith.expiresInDays
                ? addDays(new Date(), shareWith.expiresInDays)
                : undefined;
            sharedPlan = await prisma.sharedPlan.create({
                data: {
                    planType,
                    planId,
                    sharedById: userId,
                    isPublicLink: true,
                    linkExpiresAt: expiresAt,
                    ...permissions,
                    message,
                },
                include: {
                    sharedBy: {
                        select: { id: true, name: true, email: true },
                    },
                },
            });
        }
        logger.info(`Plan shared: ${planType}/${planId} by user ${userId}`);
        res.status(201).json(sharedPlan);
    }));
    // Get shared plan by share code
    router.get('/plans/:shareCode', asyncHandler(async (req, res) => {
        const { shareCode } = req.params;
        const userId = req.user.id;
        const sharedPlan = await prisma.sharedPlan.findUnique({
            where: { shareCode },
            include: {
                sharedBy: {
                    select: { id: true, name: true, email: true },
                },
            },
        });
        if (!sharedPlan) {
            return res.status(404).json({ error: 'Shared plan not found' });
        }
        // Check access permissions
        const hasAccess = sharedPlan.isPublicLink ||
            sharedPlan.sharedById === userId ||
            sharedPlan.sharedWithId === userId;
        if (!hasAccess && sharedPlan.teamId) {
            // Check team membership
            const isMember = await prisma.teamMember.findFirst({
                where: { teamId: sharedPlan.teamId, userId },
            });
            if (!isMember) {
                return res.status(403).json({ error: 'Access denied' });
            }
        }
        else if (!hasAccess) {
            return res.status(403).json({ error: 'Access denied' });
        }
        // Check if link has expired
        if (sharedPlan.linkExpiresAt && new Date() > sharedPlan.linkExpiresAt) {
            return res.status(410).json({ error: 'Share link has expired' });
        }
        // Update view count
        await prisma.sharedPlan.update({
            where: { id: sharedPlan.id },
            data: {
                viewCount: { increment: 1 },
                lastViewedAt: new Date(),
            },
        });
        // Fetch plan details
        let planDetails = null;
        switch (sharedPlan.planType) {
            case 'long-range':
                planDetails = await prisma.longRangePlan.findUnique({
                    where: { id: sharedPlan.planId },
                    include: {
                        expectations: {
                            include: { expectation: true },
                        },
                        unitPlans: {
                            select: { id: true, title: true, startDate: true, endDate: true },
                        },
                    },
                });
                break;
            case 'unit':
                planDetails = await prisma.unitPlan.findUnique({
                    where: { id: sharedPlan.planId },
                    include: {
                        expectations: {
                            include: { expectation: true },
                        },
                        lessonPlans: {
                            select: { id: true, title: true, date: true },
                        },
                        resources: true,
                    },
                });
                break;
            case 'lesson':
                planDetails = await prisma.eTFOLessonPlan.findUnique({
                    where: { id: sharedPlan.planId },
                    include: {
                        expectations: {
                            include: { expectation: true },
                        },
                        resources: true,
                    },
                });
                break;
            case 'daybook':
                planDetails = await prisma.daybookEntry.findUnique({
                    where: { id: sharedPlan.planId },
                    include: {
                        expectations: {
                            include: { expectation: true },
                        },
                    },
                });
                break;
        }
        res.json({
            share: sharedPlan,
            plan: planDetails,
        });
    }));
    // Update share permissions
    router.patch('/plans/:shareId', asyncHandler(async (req, res) => {
        const { shareId } = req.params;
        const userId = req.user.id;
        const updates = updateSharePermissionsSchema.parse(req.body);
        const sharedPlan = await prisma.sharedPlan.findUnique({
            where: { id: shareId },
        });
        if (!sharedPlan) {
            return res.status(404).json({ error: 'Shared plan not found' });
        }
        // Only the sharer can update permissions
        if (sharedPlan.sharedById !== userId) {
            return res.status(403).json({ error: 'Only the plan owner can update share permissions' });
        }
        const updated = await prisma.sharedPlan.update({
            where: { id: shareId },
            data: updates,
            include: {
                sharedBy: {
                    select: { id: true, name: true, email: true },
                },
                sharedWith: {
                    select: { id: true, name: true, email: true },
                },
            },
        });
        res.json(updated);
    }));
    // Revoke share
    router.delete('/plans/:shareId', asyncHandler(async (req, res) => {
        const { shareId } = req.params;
        const userId = req.user.id;
        const sharedPlan = await prisma.sharedPlan.findUnique({
            where: { id: shareId },
        });
        if (!sharedPlan) {
            return res.status(404).json({ error: 'Shared plan not found' });
        }
        // Only the sharer can revoke
        if (sharedPlan.sharedById !== userId) {
            return res.status(403).json({ error: 'Only the plan owner can revoke sharing' });
        }
        await prisma.sharedPlan.delete({
            where: { id: shareId },
        });
        logger.info(`Share revoked: ${shareId} by user ${userId}`);
        res.status(204).send();
    }));
    // Copy shared plan
    router.post('/plans/:shareCode/copy', asyncHandler(async (req, res) => {
        const { shareCode } = req.params;
        const userId = req.user.id;
        const sharedPlan = await prisma.sharedPlan.findUnique({
            where: { shareCode },
        });
        if (!sharedPlan) {
            return res.status(404).json({ error: 'Shared plan not found' });
        }
        // Check if user has copy permission
        if (!sharedPlan.canCopy) {
            return res.status(403).json({ error: 'Copying this plan is not allowed' });
        }
        // Check access
        const hasAccess = sharedPlan.isPublicLink ||
            sharedPlan.sharedWithId === userId;
        if (!hasAccess && sharedPlan.teamId) {
            const isMember = await prisma.teamMember.findFirst({
                where: { teamId: sharedPlan.teamId, userId },
            });
            if (!isMember) {
                return res.status(403).json({ error: 'Access denied' });
            }
        }
        else if (!hasAccess) {
            return res.status(403).json({ error: 'Access denied' });
        }
        // Copy the plan based on type
        let copiedPlan;
        switch (sharedPlan.planType) {
            case 'lesson': {
                const originalLesson = await prisma.eTFOLessonPlan.findUnique({
                    where: { id: sharedPlan.planId },
                    include: {
                        expectations: true,
                        resources: true,
                    },
                });
                if (!originalLesson) {
                    return res.status(404).json({ error: 'Original plan not found' });
                }
                // Get user's unit plans to select from
                const userUnitPlans = await prisma.unitPlan.findMany({
                    where: { userId },
                    select: { id: true },
                    take: 1,
                });
                if (userUnitPlans.length === 0) {
                    return res.status(400).json({ error: 'You need at least one unit plan to copy lessons' });
                }
                copiedPlan = await prisma.eTFOLessonPlan.create({
                    data: {
                        userId,
                        title: `${originalLesson.title} (Copy)`,
                        unitPlanId: userUnitPlans[0].id, // TODO: Allow user to select unit
                        grade: originalLesson.grade,
                        subject: originalLesson.subject,
                        language: originalLesson.language,
                        date: new Date(),
                        duration: originalLesson.duration,
                        mindsOn: originalLesson.mindsOn,
                        action: originalLesson.action,
                        consolidation: originalLesson.consolidation,
                        learningGoals: originalLesson.learningGoals,
                        materials: originalLesson.materials,
                        grouping: originalLesson.grouping,
                        titleFr: originalLesson.titleFr,
                        mindsOnFr: originalLesson.mindsOnFr,
                        actionFr: originalLesson.actionFr,
                        consolidationFr: originalLesson.consolidationFr,
                        learningGoalsFr: originalLesson.learningGoalsFr,
                        accommodations: originalLesson.accommodations,
                        modifications: originalLesson.modifications,
                        extensions: originalLesson.extensions,
                        assessmentType: originalLesson.assessmentType,
                        assessmentNotes: originalLesson.assessmentNotes,
                        isSubFriendly: originalLesson.isSubFriendly,
                        subNotes: originalLesson.subNotes,
                        expectations: {
                            create: originalLesson.expectations.map(e => ({
                                expectationId: e.expectationId,
                            })),
                        },
                    },
                });
                break;
            }
            // TODO: Implement copying for other plan types
            default:
                return res.status(400).json({ error: 'Copying this plan type is not yet supported' });
        }
        // Update copy count
        await prisma.sharedPlan.update({
            where: { id: sharedPlan.id },
            data: { copyCount: { increment: 1 } },
        });
        logger.info(`Plan copied: ${sharedPlan.planType}/${sharedPlan.planId} by user ${userId}`);
        res.status(201).json(copiedPlan);
    }));
    return router;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9yb3V0ZXMvc2hhcmluZy50cyIsIm1hcHBpbmdzIjoiQUFBQTs7O0dBR0c7QUFFSCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRWpDLE9BQU8sRUFBRSxDQUFDLEVBQUUsTUFBTSxLQUFLLENBQUM7QUFDeEIsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN6RCxPQUFPLE1BQU0sTUFBTSxVQUFVLENBQUM7QUFDOUIsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUVuQyxxQkFBcUI7QUFDckIsTUFBTSxlQUFlLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUMvQixRQUFRLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLFlBQVksRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQzdELE1BQU0sRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFO0lBQ2xCLFNBQVMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDO1FBQ2pCLENBQUMsQ0FBQyxNQUFNLENBQUM7WUFDUCxJQUFJLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUM7WUFDdkIsS0FBSyxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxLQUFLLEVBQUU7U0FDMUIsQ0FBQztRQUNGLENBQUMsQ0FBQyxNQUFNLENBQUM7WUFDUCxJQUFJLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUM7WUFDdkIsTUFBTSxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUU7U0FDbkIsQ0FBQztRQUNGLENBQUMsQ0FBQyxNQUFNLENBQUM7WUFDUCxJQUFJLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUM7WUFDdkIsYUFBYSxFQUFFLENB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QUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSw2Q0FBNkMsRUFBRSxDQUFDLENBQUM7UUFDMUYsQ0FBQztRQUVELG9CQUFvQjtRQUNwQixNQUFNLE1BQU0sQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDO1lBQzdCLEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRSxVQUFVLENBQUMsRUFBRSxFQUFFO1lBQzVCLElBQUksRUFBRSxFQUFFLFNBQVMsRUFBRSxFQUFFLFNBQVMsRUFBRSxDQUFDLEVBQUUsRUFBRTtTQUN0QyxDQUFDLENBQUM7UUFFSCxNQUFNLENBQUMsSUFBSSxDQUFDLGdCQUFnQixVQUFVLENBQUMsUUFBUSxJQUFJLFVBQVUsQ0FBQyxNQUFNLFlBQVksTUFBTSxFQUFFLENBQUMsQ0FBQztRQUMxRixHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNuQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRUosT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWljaGFlbG1jaXNhYWMvR2l0SHViL3RlYWNoaW5nLWVuZ2luZTIuMC9zZXJ2ZXIvc3JjL3JvdXRlcy9zaGFyaW5nLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogUGxhbiBTaGFyaW5nIFJvdXRlc1xuICogSGFuZGxlcyBzaGFyaW5nIG9mIGxlc3NvbiBwbGFucywgdW5pdHMsIGFuZCBvdGhlciBwbGFubmluZyByZXNvdXJjZXNcbiAqL1xuXG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IFByaXNtYUNsaWVudCB9IGZyb20gJ0B0ZWFjaGluZy1lbmdpbmUvZGF0YWJhc2UnO1xuaW1wb3J0IHsgeiB9IGZyb20gJ3pvZCc7XG5pbXBvcnQgeyBhdXRoZW50aWNhdGUgfSBmcm9tICdAL21pZGRsZXdhcmUvYXV0aGVudGljYXRlJztcbmltcG9ydCB7IGFzeW5jSGFuZGxlciB9IGZyb20gJ0AvbWlkZGxld2FyZS9lcnJvckhhbmRsZXInO1xuaW1wb3J0IGxvZ2dlciBmcm9tICdAL2xvZ2dlcic7XG5pbXBvcnQgeyBhZGREYXlzIH0gZnJvbSAnZGF0ZS1mbnMnO1xuXG4vLyBWYWxpZGF0aW9uIHNjaGVtYXNcbmNvbnN0IHNoYXJlUGxhblNjaGVtYSA9IHoub2JqZWN0KHtcbiAgcGxhblR5cGU6IHouZW51bShbJ2xvbmctcmFuZ2UnLCAndW5pdCcsICdsZXNzb24nLCAnZGF5Ym9vayddKSxcbiAgcGxhbklkOiB6LnN0cmluZygpLFxuICBzaGFyZVdpdGg6IHoudW5pb24oW1xuICAgIHoub2JqZWN0KHtcbiAgICAgIHR5cGU6IHoubGl0ZXJhbCgndXNlcicpLFxuICAgICAgZW1haWw6IHouc3RyaW5nKCkuZW1haWwoKSxcbiAgICB9KSxcbiAgICB6Lm9iamVjdCh7XG4gICAgICB0eXBlOiB6LmxpdGVyYWwoJ3RlYW0nKSxcbiAgICAgIHRlYW1JZDogei5zdHJpbmcoKSxcbiAgICB9KSxcbiAgICB6Lm9iamVjdCh7XG4gICAgICB0eXBlOiB6LmxpdGVyYWwoJ2xpbmsnKSxcbiAgICAgIGV4cGlyZXNJbkRheXM6IHoubnVtYmVyKCkuaW50KCkubWluKDEpLm1heCgzNjUpLm9wdGlvbmFsKCksXG4gICAgfSksXG4gIF0pLFxuICBwZXJtaXNzaW9uczogei5vYmplY3Qoe1xuICAgIGNhbkVkaXQ6IHouYm9vbGVhbigpLm9wdGlvbmFsKCksXG4gICAgY2FuQ29weTogei5ib29sZWFuKCkub3B0aW9uYWwoKSxcbiAgICBjYW5Db21tZW50OiB6LmJvb2xlYW4oKS5vcHRpb25hbCgpLFxuICAgIGNhblJlc2hhcmU6IHouYm9vbGVhbigpLm9wdGlvbmFsKCksXG4gIH0pLm9wdGlvbmFsKCksXG4gIG1lc3NhZ2U6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbn0pO1xuXG5jb25zdCB1cGRhdGVTaGFyZVBlcm1pc3Npb25zU2NoZW1hID0gei5vYmplY3Qoe1xuICBjYW5FZGl0OiB6LmJvb2xlYW4oKS5vcHRpb25hbCgpLFxuICBjYW5Db3B5OiB6LmJvb2xlYW4oKS5vcHRpb25hbCgpLFxuICBjYW5Db21tZW50OiB6LmJvb2xlYW4oKS5vcHRpb25hbCgpLFxuICBjYW5SZXNoYXJlOiB6LmJvb2xlYW4oKS5vcHRpb25hbCgpLFxufSk7XG5cbmV4cG9ydCBmdW5jdGlvbiBzaGFyaW5nUm91dGVzKHByaXNtYTogUHJpc21hQ2xpZW50KTogUm91dGVyIHtcbiAgY29uc3Qgcm91dGVyID0gUm91dGVyKCk7XG5cbiAgLy8gQXBwbHkgYXV0aGVudGljYXRpb24gdG8gYWxsIHJvdXRlc1xuICByb3V0ZXIudXNlKGF1dGhlbnRpY2F0ZSk7XG5cbiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNoZWNrIHBsYW4gb3duZXJzaGlwXG4gIGFzeW5jIGZ1bmN0aW9uIGNoZWNrUGxhbk93bmVyc2hpcChwbGFuVHlwZTogc3RyaW5nLCBwbGFuSWQ6IHN0cmluZywgdXNlcklkOiBudW1iZXIpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBzd2l0Y2ggKHBsYW5UeXBlKSB7XG4gICAgICBjYXNlICdsb25nLXJhbmdlJzoge1xuICAgICAgICBjb25zdCBsclBsYW4gPSBhd2FpdCBwcmlzbWEubG9uZ1JhbmdlUGxhbi5maW5kVW5pcXVlKHtcbiAgICAgICAgICB3aGVyZTogeyBpZDogcGxhbklkIH0sXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gbHJQbGFuPy51c2VySWQgPT09IHVzZXJJZDtcbiAgICAgIH1cblxuICAgICAgY2FzZSAndW5pdCc6IHtcbiAgICAgICAgY29uc3QgdW5pdFBsYW4gPSBhd2FpdCBwcmlzbWEudW5pdFBsYW4uZmluZFVuaXF1ZSh7XG4gICAgICAgICAgd2hlcmU6IHsgaWQ6IHBsYW5JZCB9LFxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHVuaXRQbGFuPy51c2VySWQgPT09IHVzZXJJZDtcbiAgICAgIH1cblxuICAgICAgY2FzZSAnbGVzc29uJzoge1xuICAgICAgICBjb25zdCBsZXNzb25QbGFuID0gYXdhaXQgcHJpc21hLmVURk9MZXNzb25QbGFuLmZpbmRVbmlxdWUoe1xuICAgICAgICAgIHdoZXJlOiB7IGlkOiBwbGFuSWQgfSxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBsZXNzb25QbGFuPy51c2VySWQgPT09IHVzZXJJZDtcbiAgICAgIH1cblxuICAgICAgY2FzZSAnZGF5Ym9vayc6IHtcbiAgICAgICAgY29uc3QgZGF5Ym9va0VudHJ5ID0gYXdhaXQgcHJpc21hLmRheWJvb2tFbnRyeS5maW5kVW5pcXVlKHtcbiAgICAgICAgICB3aGVyZTogeyBpZDogcGxhbklkIH0sXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gZGF5Ym9va0VudHJ5Py51c2VySWQgPT09IHVzZXJJZDtcbiAgICAgIH1cblxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIC8vIEdldCBhbGwgc2hhcmVkIHBsYW5zIChib3RoIHNlbnQgYW5kIHJlY2VpdmVkKVxuICByb3V0ZXIuZ2V0KCcvcGxhbnMnLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIhLmlkO1xuICAgIGNvbnN0IHsgdHlwZSwgZGlyZWN0aW9uIH0gPSByZXEucXVlcnk7XG5cbiAgICBjb25zdCB3aGVyZUNsYXVzZTogUmVjb3JkPHN0cmluZywgdW5rbm93bj4gPSB7fTtcbiAgICBcbiAgICBpZiAoZGlyZWN0aW9uID09PSAnc2VudCcpIHtcbiAgICAgIHdoZXJlQ2xhdXNlLnNoYXJlZEJ5SWQgPSB1c2VySWQ7XG4gICAgfSBlbHNlIGlmIChkaXJlY3Rpb24gPT09ICdyZWNlaXZlZCcpIHtcbiAgICAgIHdoZXJlQ2xhdXNlLnNoYXJlZFdpdGhJZCA9IHVzZXJJZDtcbiAgICB9IGVsc2Uge1xuICAgICAgd2hlcmVDbGF1c2UuT1IgPSBbXG4gICAgICAgIHsgc2hhcmVkQnlJZDogdXNlcklkIH0sXG4gICAgICAgIHsgc2hhcmVkV2l0aElkOiB1c2VySWQgfSxcbiAgICAgIF07XG4gICAgfVxuXG4gICAgaWYgKHR5cGUpIHtcbiAgICAgIHdoZXJlQ2xhdXNlLnBsYW5UeXBlID0gdHlwZTtcbiAgICB9XG5cbiAgICBjb25zdCBzaGFyZWRQbGFucyA9IGF3YWl0IHByaXNtYS5zaGFyZWRQbGFuLmZpbmRNYW55KHtcbiAgICAgIHdoZXJlOiB3aGVyZUNsYXVzZSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgc2hhcmVkQnk6IHtcbiAgICAgICAgICBzZWxlY3Q6IHsgaWQ6IHRydWUsIG5hbWU6IHRydWUsIGVtYWlsOiB0cnVlIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHNoYXJlZFdpdGg6IHtcbiAgICAgICAgICBzZWxlY3Q6IHsgaWQ6IHRydWUsIG5hbWU6IHRydWUsIGVtYWlsOiB0cnVlIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgb3JkZXJCeTogeyBzaGFyZWRBdDogJ2Rlc2MnIH0sXG4gICAgfSk7XG5cbiAgICAvLyBGZXRjaCBwbGFuIGRldGFpbHMgZm9yIGVhY2ggc2hhcmVkIHBsYW5cbiAgICBjb25zdCBwbGFuc1dpdGhEZXRhaWxzID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICBzaGFyZWRQbGFucy5tYXAoYXN5bmMgKHNoYXJlKSA9PiB7XG4gICAgICAgIGxldCBwbGFuRGV0YWlscyA9IG51bGw7XG5cbiAgICAgICAgc3dpdGNoIChzaGFyZS5wbGFuVHlwZSkge1xuICAgICAgICAgIGNhc2UgJ2xvbmctcmFuZ2UnOlxuICAgICAgICAgICAgcGxhbkRldGFpbHMgPSBhd2FpdCBwcmlzbWEubG9uZ1JhbmdlUGxhbi5maW5kVW5pcXVlKHtcbiAgICAgICAgICAgICAgd2hlcmU6IHsgaWQ6IHNoYXJlLnBsYW5JZCB9LFxuICAgICAgICAgICAgICBzZWxlY3Q6IHsgaWQ6IHRydWUsIHRpdGxlOiB0cnVlLCBhY2FkZW1pY1llYXI6IHRydWUsIGdyYWRlOiB0cnVlLCBzdWJqZWN0OiB0cnVlIH0sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgY2FzZSAndW5pdCc6XG4gICAgICAgICAgICBwbGFuRGV0YWlscyA9IGF3YWl0IHByaXNtYS51bml0UGxhbi5maW5kVW5pcXVlKHtcbiAgICAgICAgICAgICAgd2hlcmU6IHsgaWQ6IHNoYXJlLnBsYW5JZCB9LFxuICAgICAgICAgICAgICBzZWxlY3Q6IHsgaWQ6IHRydWUsIHRpdGxlOiB0cnVlLCBzdGFydERhdGU6IHRydWUsIGVuZERhdGU6IHRydWUgfSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICBjYXNlICdsZXNzb24nOlxuICAgICAgICAgICAgcGxhbkRldGFpbHMgPSBhd2FpdCBwcmlzbWEuZVRGT0xlc3NvblBsYW4uZmluZFVuaXF1ZSh7XG4gICAgICAgICAgICAgIHdoZXJlOiB7IGlkOiBzaGFyZS5wbGFuSWQgfSxcbiAgICAgICAgICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlLCB0aXRsZTogdHJ1ZSwgZGF0ZTogdHJ1ZSwgZ3JhZGU6IHRydWUsIHN1YmplY3Q6IHRydWUgfSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICBjYXNlICdkYXlib29rJzpcbiAgICAgICAgICAgIHBsYW5EZXRhaWxzID0gYXdhaXQgcHJpc21hLmRheWJvb2tFbnRyeS5maW5kVW5pcXVlKHtcbiAgICAgICAgICAgICAgd2hlcmU6IHsgaWQ6IHNoYXJlLnBsYW5JZCB9LFxuICAgICAgICAgICAgICBzZWxlY3Q6IHsgaWQ6IHRydWUsIGRhdGU6IHRydWUgfSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIC4uLnNoYXJlLFxuICAgICAgICAgIHBsYW5EZXRhaWxzLFxuICAgICAgICB9O1xuICAgICAgfSlcbiAgICApO1xuXG4gICAgcmVzLmpzb24ocGxhbnNXaXRoRGV0YWlscyk7XG4gIH0pKTtcblxuICAvLyBTaGFyZSBhIHBsYW5cbiAgcm91dGVyLnBvc3QoJy9wbGFucycsIGFzeW5jSGFuZGxlcihhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuaWQ7XG4gICAgY29uc3QgeyBwbGFuVHlwZSwgcGxhbklkLCBzaGFyZVdpdGgsIHBlcm1pc3Npb25zID0ge30sIG1lc3NhZ2UgfSA9IHNoYXJlUGxhblNjaGVtYS5wYXJzZShyZXEuYm9keSk7XG5cbiAgICAvLyBDaGVjayBpZiB1c2VyIG93bnMgdGhlIHBsYW5cbiAgICBjb25zdCBpc093bmVyID0gYXdhaXQgY2hlY2tQbGFuT3duZXJzaGlwKHBsYW5UeXBlLCBwbGFuSWQsIHVzZXJJZCk7XG4gICAgaWYgKCFpc093bmVyKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ1lvdSBkbyBub3QgaGF2ZSBwZXJtaXNzaW9uIHRvIHNoYXJlIHRoaXMgcGxhbicgfSk7XG4gICAgfVxuXG4gICAgbGV0IHNoYXJlZFBsYW47XG5cbiAgICBpZiAoc2hhcmVXaXRoLnR5cGUgPT09ICd1c2VyJykge1xuICAgICAgLy8gU2hhcmUgd2l0aCBzcGVjaWZpYyB1c2VyXG4gICAgICBjb25zdCB0YXJnZXRVc2VyID0gYXdhaXQgcHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7IGVtYWlsOiBzaGFyZVdpdGguZW1haWwgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIXRhcmdldFVzZXIpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgZXJyb3I6ICdVc2VyIG5vdCBmb3VuZCcgfSk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0YXJnZXRVc2VyLmlkID09PSB1c2VySWQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgZXJyb3I6ICdDYW5ub3Qgc2hhcmUgd2l0aCB5b3Vyc2VsZicgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIGlmIGFscmVhZHkgc2hhcmVkXG4gICAgICBjb25zdCBleGlzdGluZ1NoYXJlID0gYXdhaXQgcHJpc21hLnNoYXJlZFBsYW4uZmluZEZpcnN0KHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICBwbGFuVHlwZSxcbiAgICAgICAgICBwbGFuSWQsXG4gICAgICAgICAgc2hhcmVkQnlJZDogdXNlcklkLFxuICAgICAgICAgIHNoYXJlZFdpdGhJZDogdGFyZ2V0VXNlci5pZCxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoZXhpc3RpbmdTaGFyZSkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDkpLmpzb24oeyBlcnJvcjogJ1BsYW4gaXMgYWxyZWFkeSBzaGFyZWQgd2l0aCB0aGlzIHVzZXInIH0pO1xuICAgICAgfVxuXG4gICAgICBzaGFyZWRQbGFuID0gYXdhaXQgcHJpc21hLnNoYXJlZFBsYW4uY3JlYXRlKHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIHBsYW5UeXBlLFxuICAgICAgICAgIHBsYW5JZCxcbiAgICAgICAgICBzaGFyZWRCeUlkOiB1c2VySWQsXG4gICAgICAgICAgc2hhcmVkV2l0aElkOiB0YXJnZXRVc2VyLmlkLFxuICAgICAgICAgIC4uLnBlcm1pc3Npb25zLFxuICAgICAgICAgIG1lc3NhZ2UsXG4gICAgICAgIH0sXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICBzaGFyZWRCeToge1xuICAgICAgICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlLCBuYW1lOiB0cnVlLCBlbWFpbDogdHJ1ZSB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgc2hhcmVkV2l0aDoge1xuICAgICAgICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlLCBuYW1lOiB0cnVlLCBlbWFpbDogdHJ1ZSB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgLy8gVE9ETzogU2VuZCBlbWFpbCBub3RpZmljYXRpb25cbiAgICB9IGVsc2UgaWYgKHNoYXJlV2l0aC50eXBlID09PSAndGVhbScpIHtcbiAgICAgIC8vIFNoYXJlIHdpdGggdGVhbVxuICAgICAgY29uc3QgdGVhbSA9IGF3YWl0IHByaXNtYS50ZWFtLmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyBpZDogc2hhcmVXaXRoLnRlYW1JZCB9LFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghdGVhbSkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBlcnJvcjogJ1RlYW0gbm90IGZvdW5kJyB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgaWYgdXNlciBpcyBhIG1lbWJlciBvZiB0aGUgdGVhbVxuICAgICAgY29uc3QgaXNNZW1iZXIgPSBhd2FpdCBwcmlzbWEudGVhbU1lbWJlci5maW5kVW5pcXVlKHtcbiAgICAgICAgd2hlcmU6IHsgdGVhbUlkX3VzZXJJZDogeyB0ZWFtSWQ6IHNoYXJlV2l0aC50ZWFtSWQsIHVzZXJJZCB9IH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFpc01lbWJlcikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ1lvdSBtdXN0IGJlIGEgdGVhbSBtZW1iZXIgdG8gc2hhcmUgd2l0aCB0aGUgdGVhbScgfSk7XG4gICAgICB9XG5cbiAgICAgIHNoYXJlZFBsYW4gPSBhd2FpdCBwcmlzbWEuc2hhcmVkUGxhbi5jcmVhdGUoe1xuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgcGxhblR5cGUsXG4gICAgICAgICAgcGxhbklkLFxuICAgICAgICAgIHNoYXJlZEJ5SWQ6IHVzZXJJZCxcbiAgICAgICAgICB0ZWFtSWQ6IHNoYXJlV2l0aC50ZWFtSWQsXG4gICAgICAgICAgLi4ucGVybWlzc2lvbnMsXG4gICAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgfSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIHNoYXJlZEJ5OiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHsgaWQ6IHRydWUsIG5hbWU6IHRydWUsIGVtYWlsOiB0cnVlIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBDcmVhdGUgcHVibGljIHNoYXJpbmcgbGlua1xuICAgICAgY29uc3QgZXhwaXJlc0F0ID0gc2hhcmVXaXRoLmV4cGlyZXNJbkRheXNcbiAgICAgICAgPyBhZGREYXlzKG5ldyBEYXRlKCksIHNoYXJlV2l0aC5leHBpcmVzSW5EYXlzKVxuICAgICAgICA6IHVuZGVmaW5lZDtcblxuICAgICAgc2hhcmVkUGxhbiA9IGF3YWl0IHByaXNtYS5zaGFyZWRQbGFuLmNyZWF0ZSh7XG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBwbGFuVHlwZSxcbiAgICAgICAgICBwbGFuSWQsXG4gICAgICAgICAgc2hhcmVkQnlJZDogdXNlcklkLFxuICAgICAgICAgIGlzUHVibGljTGluazogdHJ1ZSxcbiAgICAgICAgICBsaW5rRXhwaXJlc0F0OiBleHBpcmVzQXQsXG4gICAgICAgICAgLi4ucGVybWlzc2lvbnMsXG4gICAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgfSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIHNoYXJlZEJ5OiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHsgaWQ6IHRydWUsIG5hbWU6IHRydWUsIGVtYWlsOiB0cnVlIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGxvZ2dlci5pbmZvKGBQbGFuIHNoYXJlZDogJHtwbGFuVHlwZX0vJHtwbGFuSWR9IGJ5IHVzZXIgJHt1c2VySWR9YCk7XG4gICAgcmVzLnN0YXR1cygyMDEpLmpzb24oc2hhcmVkUGxhbik7XG4gIH0pKTtcblxuICAvLyBHZXQgc2hhcmVkIHBsYW4gYnkgc2hhcmUgY29kZVxuICByb3V0ZXIuZ2V0KCcvcGxhbnMvOnNoYXJlQ29kZScsIGFzeW5jSGFuZGxlcihhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICBjb25zdCB7IHNoYXJlQ29kZSB9ID0gcmVxLnBhcmFtcztcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciEuaWQ7XG5cbiAgICBjb25zdCBzaGFyZWRQbGFuID0gYXdhaXQgcHJpc21hLnNoYXJlZFBsYW4uZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBzaGFyZUNvZGUgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgc2hhcmVkQnk6IHtcbiAgICAgICAgICBzZWxlY3Q6IHsgaWQ6IHRydWUsIG5hbWU6IHRydWUsIGVtYWlsOiB0cnVlIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFzaGFyZWRQbGFuKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBlcnJvcjogJ1NoYXJlZCBwbGFuIG5vdCBmb3VuZCcgfSk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgYWNjZXNzIHBlcm1pc3Npb25zXG4gICAgY29uc3QgaGFzQWNjZXNzID0gc2hhcmVkUGxhbi5pc1B1YmxpY0xpbmsgfHxcbiAgICAgIHNoYXJlZFBsYW4uc2hhcmVkQnlJZCA9PT0gdXNlcklkIHx8XG4gICAgICBzaGFyZWRQbGFuLnNoYXJlZFdpdGhJZCA9PT0gdXNlcklkO1xuXG4gICAgaWYgKCFoYXNBY2Nlc3MgJiYgc2hhcmVkUGxhbi50ZWFtSWQpIHtcbiAgICAgIC8vIENoZWNrIHRlYW0gbWVtYmVyc2hpcFxuICAgICAgY29uc3QgaXNNZW1iZXIgPSBhd2FpdCBwcmlzbWEudGVhbU1lbWJlci5maW5kRmlyc3Qoe1xuICAgICAgICB3aGVyZTogeyB0ZWFtSWQ6IHNoYXJlZFBsYW4udGVhbUlkLCB1c2VySWQgfSxcbiAgICAgIH0pO1xuICAgICAgaWYgKCFpc01lbWJlcikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ0FjY2VzcyBkZW5pZWQnIH0pO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoIWhhc0FjY2Vzcykge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgZXJyb3I6ICdBY2Nlc3MgZGVuaWVkJyB9KTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiBsaW5rIGhhcyBleHBpcmVkXG4gICAgaWYgKHNoYXJlZFBsYW4ubGlua0V4cGlyZXNBdCAmJiBuZXcgRGF0ZSgpID4gc2hhcmVkUGxhbi5saW5rRXhwaXJlc0F0KSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MTApLmpzb24oeyBlcnJvcjogJ1NoYXJlIGxpbmsgaGFzIGV4cGlyZWQnIH0pO1xuICAgIH1cblxuICAgIC8vIFVwZGF0ZSB2aWV3IGNvdW50XG4gICAgYXdhaXQgcHJpc21hLnNoYXJlZFBsYW4udXBkYXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiBzaGFyZWRQbGFuLmlkIH0sXG4gICAgICBkYXRhOiB7XG4gICAgICAgIHZpZXdDb3VudDogeyBpbmNyZW1lbnQ6IDEgfSxcbiAgICAgICAgbGFzdFZpZXdlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIEZldGNoIHBsYW4gZGV0YWlsc1xuICAgIGxldCBwbGFuRGV0YWlscyA9IG51bGw7XG5cbiAgICBzd2l0Y2ggKHNoYXJlZFBsYW4ucGxhblR5cGUpIHtcbiAgICAgIGNhc2UgJ2xvbmctcmFuZ2UnOlxuICAgICAgICBwbGFuRGV0YWlscyA9IGF3YWl0IHByaXNtYS5sb25nUmFuZ2VQbGFuLmZpbmRVbmlxdWUoe1xuICAgICAgICAgIHdoZXJlOiB7IGlkOiBzaGFyZWRQbGFuLnBsYW5JZCB9LFxuICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgIGV4cGVjdGF0aW9uczoge1xuICAgICAgICAgICAgICBpbmNsdWRlOiB7IGV4cGVjdGF0aW9uOiB0cnVlIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdW5pdFBsYW5zOiB7XG4gICAgICAgICAgICAgIHNlbGVjdDogeyBpZDogdHJ1ZSwgdGl0bGU6IHRydWUsIHN0YXJ0RGF0ZTogdHJ1ZSwgZW5kRGF0ZTogdHJ1ZSB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgJ3VuaXQnOlxuICAgICAgICBwbGFuRGV0YWlscyA9IGF3YWl0IHByaXNtYS51bml0UGxhbi5maW5kVW5pcXVlKHtcbiAgICAgICAgICB3aGVyZTogeyBpZDogc2hhcmVkUGxhbi5wbGFuSWQgfSxcbiAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICBleHBlY3RhdGlvbnM6IHtcbiAgICAgICAgICAgICAgaW5jbHVkZTogeyBleHBlY3RhdGlvbjogdHJ1ZSB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGxlc3NvblBsYW5zOiB7XG4gICAgICAgICAgICAgIHNlbGVjdDogeyBpZDogdHJ1ZSwgdGl0bGU6IHRydWUsIGRhdGU6IHRydWUgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICByZXNvdXJjZXM6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlICdsZXNzb24nOlxuICAgICAgICBwbGFuRGV0YWlscyA9IGF3YWl0IHByaXNtYS5lVEZPTGVzc29uUGxhbi5maW5kVW5pcXVlKHtcbiAgICAgICAgICB3aGVyZTogeyBpZDogc2hhcmVkUGxhbi5wbGFuSWQgfSxcbiAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICBleHBlY3RhdGlvbnM6IHtcbiAgICAgICAgICAgICAgaW5jbHVkZTogeyBleHBlY3RhdGlvbjogdHJ1ZSB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHJlc291cmNlczogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgJ2RheWJvb2snOlxuICAgICAgICBwbGFuRGV0YWlscyA9IGF3YWl0IHByaXNtYS5kYXlib29rRW50cnkuZmluZFVuaXF1ZSh7XG4gICAgICAgICAgd2hlcmU6IHsgaWQ6IHNoYXJlZFBsYW4ucGxhbklkIH0sXG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgZXhwZWN0YXRpb25zOiB7XG4gICAgICAgICAgICAgIGluY2x1ZGU6IHsgZXhwZWN0YXRpb246IHRydWUgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIHJlcy5qc29uKHtcbiAgICAgIHNoYXJlOiBzaGFyZWRQbGFuLFxuICAgICAgcGxhbjogcGxhbkRldGFpbHMsXG4gICAgfSk7XG4gIH0pKTtcblxuICAvLyBVcGRhdGUgc2hhcmUgcGVybWlzc2lvbnNcbiAgcm91dGVyLnBhdGNoKCcvcGxhbnMvOnNoYXJlSWQnLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgY29uc3QgeyBzaGFyZUlkIH0gPSByZXEucGFyYW1zO1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyIS5pZDtcbiAgICBjb25zdCB1cGRhdGVzID0gdXBkYXRlU2hhcmVQZXJtaXNzaW9uc1NjaGVtYS5wYXJzZShyZXEuYm9keSk7XG5cbiAgICBjb25zdCBzaGFyZWRQbGFuID0gYXdhaXQgcHJpc21hLnNoYXJlZFBsYW4uZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBpZDogc2hhcmVJZCB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFzaGFyZWRQbGFuKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBlcnJvcjogJ1NoYXJlZCBwbGFuIG5vdCBmb3VuZCcgfSk7XG4gICAgfVxuXG4gICAgLy8gT25seSB0aGUgc2hhcmVyIGNhbiB1cGRhdGUgcGVybWlzc2lvbnNcbiAgICBpZiAoc2hhcmVkUGxhbi5zaGFyZWRCeUlkICE9PSB1c2VySWQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnT25seSB0aGUgcGxhbiBvd25lciBjYW4gdXBkYXRlIHNoYXJlIHBlcm1pc3Npb25zJyB9KTtcbiAgICB9XG5cbiAgICBjb25zdCB1cGRhdGVkID0gYXdhaXQgcHJpc21hLnNoYXJlZFBsYW4udXBkYXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiBzaGFyZUlkIH0sXG4gICAgICBkYXRhOiB1cGRhdGVzLFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBzaGFyZWRCeToge1xuICAgICAgICAgIHNlbGVjdDogeyBpZDogdHJ1ZSwgbmFtZTogdHJ1ZSwgZW1haWw6IHRydWUgfSxcbiAgICAgICAgfSxcbiAgICAgICAgc2hhcmVkV2l0aDoge1xuICAgICAgICAgIHNlbGVjdDogeyBpZDogdHJ1ZSwgbmFtZTogdHJ1ZSwgZW1haWw6IHRydWUgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICByZXMuanNvbih1cGRhdGVkKTtcbiAgfSkpO1xuXG4gIC8vIFJldm9rZSBzaGFyZVxuICByb3V0ZXIuZGVsZXRlKCcvcGxhbnMvOnNoYXJlSWQnLCBhc3luY0hhbmRsZXIoYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgY29uc3QgeyBzaGFyZUlkIH0gPSByZXEucGFyYW1zO1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyIS5pZDtcblxuICAgIGNvbnN0IHNoYXJlZFBsYW4gPSBhd2FpdCBwcmlzbWEuc2hhcmVkUGxhbi5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiBzaGFyZUlkIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXNoYXJlZFBsYW4pIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IGVycm9yOiAnU2hhcmVkIHBsYW4gbm90IGZvdW5kJyB9KTtcbiAgICB9XG5cbiAgICAvLyBPbmx5IHRoZSBzaGFyZXIgY2FuIHJldm9rZVxuICAgIGlmIChzaGFyZWRQbGFuLnNoYXJlZEJ5SWQgIT09IHVzZXJJZCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgZXJyb3I6ICdPbmx5IHRoZSBwbGFuIG93bmVyIGNhbiByZXZva2Ugc2hhcmluZycgfSk7XG4gICAgfVxuXG4gICAgYXdhaXQgcHJpc21hLnNoYXJlZFBsYW4uZGVsZXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiBzaGFyZUlkIH0sXG4gICAgfSk7XG5cbiAgICBsb2dnZXIuaW5mbyhgU2hhcmUgcmV2b2tlZDogJHtzaGFyZUlkfSBieSB1c2VyICR7dXNlcklkfWApO1xuICAgIHJlcy5zdGF0dXMoMjA0KS5zZW5kKCk7XG4gIH0pKTtcblxuICAvLyBDb3B5IHNoYXJlZCBwbGFuXG4gIHJvdXRlci5wb3N0KCcvcGxhbnMvOnNoYXJlQ29kZS9jb3B5JywgYXN5bmNIYW5kbGVyKGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICAgIGNvbnN0IHsgc2hhcmVDb2RlIH0gPSByZXEucGFyYW1zO1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyIS5pZDtcblxuICAgIGNvbnN0IHNoYXJlZFBsYW4gPSBhd2FpdCBwcmlzbWEuc2hhcmVkUGxhbi5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IHNoYXJlQ29kZSB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFzaGFyZWRQbGFuKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBlcnJvcjogJ1NoYXJlZCBwbGFuIG5vdCBmb3VuZCcgfSk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgdXNlciBoYXMgY29weSBwZXJtaXNzaW9uXG4gICAgaWYgKCFzaGFyZWRQbGFuLmNhbkNvcHkpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnQ29weWluZyB0aGlzIHBsYW4gaXMgbm90IGFsbG93ZWQnIH0pO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGFjY2Vzc1xuICAgIGNvbnN0IGhhc0FjY2VzcyA9IHNoYXJlZFBsYW4uaXNQdWJsaWNMaW5rIHx8XG4gICAgICBzaGFyZWRQbGFuLnNoYXJlZFdpdGhJZCA9PT0gdXNlcklkO1xuXG4gICAgaWYgKCFoYXNBY2Nlc3MgJiYgc2hhcmVkUGxhbi50ZWFtSWQpIHtcbiAgICAgIGNvbnN0IGlzTWVtYmVyID0gYXdhaXQgcHJpc21hLnRlYW1NZW1iZXIuZmluZEZpcnN0KHtcbiAgICAgICAgd2hlcmU6IHsgdGVhbUlkOiBzaGFyZWRQbGFuLnRlYW1JZCwgdXNlcklkIH0sXG4gICAgICB9KTtcbiAgICAgIGlmICghaXNNZW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgZXJyb3I6ICdBY2Nlc3MgZGVuaWVkJyB9KTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKCFoYXNBY2Nlc3MpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnQWNjZXNzIGRlbmllZCcgfSk7XG4gICAgfVxuXG4gICAgLy8gQ29weSB0aGUgcGxhbiBiYXNlZCBvbiB0eXBlXG4gICAgbGV0IGNvcGllZFBsYW47XG5cbiAgICBzd2l0Y2ggKHNoYXJlZFBsYW4ucGxhblR5cGUpIHtcbiAgICAgIGNhc2UgJ2xlc3Nvbic6IHtcbiAgICAgICAgY29uc3Qgb3JpZ2luYWxMZXNzb24gPSBhd2FpdCBwcmlzbWEuZVRGT0xlc3NvblBsYW4uZmluZFVuaXF1ZSh7XG4gICAgICAgICAgd2hlcmU6IHsgaWQ6IHNoYXJlZFBsYW4ucGxhbklkIH0sXG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgZXhwZWN0YXRpb25zOiB0cnVlLFxuICAgICAgICAgICAgcmVzb3VyY2VzOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICghb3JpZ2luYWxMZXNzb24pIHtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBlcnJvcjogJ09yaWdpbmFsIHBsYW4gbm90IGZvdW5kJyB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEdldCB1c2VyJ3MgdW5pdCBwbGFucyB0byBzZWxlY3QgZnJvbVxuICAgICAgICBjb25zdCB1c2VyVW5pdFBsYW5zID0gYXdhaXQgcHJpc21hLnVuaXRQbGFuLmZpbmRNYW55KHtcbiAgICAgICAgICB3aGVyZTogeyB1c2VySWQgfSxcbiAgICAgICAgICBzZWxlY3Q6IHsgaWQ6IHRydWUgfSxcbiAgICAgICAgICB0YWtlOiAxLFxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAodXNlclVuaXRQbGFucy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ1lvdSBuZWVkIGF0IGxlYXN0IG9uZSB1bml0IHBsYW4gdG8gY29weSBsZXNzb25zJyB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvcGllZFBsYW4gPSBhd2FpdCBwcmlzbWEuZVRGT0xlc3NvblBsYW4uY3JlYXRlKHtcbiAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICB0aXRsZTogYCR7b3JpZ2luYWxMZXNzb24udGl0bGV9IChDb3B5KWAsXG4gICAgICAgICAgICB1bml0UGxhbklkOiB1c2VyVW5pdFBsYW5zWzBdLmlkLCAvLyBUT0RPOiBBbGxvdyB1c2VyIHRvIHNlbGVjdCB1bml0XG4gICAgICAgICAgICBncmFkZTogb3JpZ2luYWxMZXNzb24uZ3JhZGUsXG4gICAgICAgICAgICBzdWJqZWN0OiBvcmlnaW5hbExlc3Nvbi5zdWJqZWN0LFxuICAgICAgICAgICAgbGFuZ3VhZ2U6IG9yaWdpbmFsTGVzc29uLmxhbmd1YWdlLFxuICAgICAgICAgICAgZGF0ZTogbmV3IERhdGUoKSxcbiAgICAgICAgICAgIGR1cmF0aW9uOiBvcmlnaW5hbExlc3Nvbi5kdXJhdGlvbixcbiAgICAgICAgICAgIG1pbmRzT246IG9yaWdpbmFsTGVzc29uLm1pbmRzT24sXG4gICAgICAgICAgICBhY3Rpb246IG9yaWdpbmFsTGVzc29uLmFjdGlvbixcbiAgICAgICAgICAgIGNvbnNvbGlkYXRpb246IG9yaWdpbmFsTGVzc29uLmNvbnNvbGlkYXRpb24sXG4gICAgICAgICAgICBsZWFybmluZ0dvYWxzOiBvcmlnaW5hbExlc3Nvbi5sZWFybmluZ0dvYWxzLFxuICAgICAgICAgICAgbWF0ZXJpYWxzOiBvcmlnaW5hbExlc3Nvbi5tYXRlcmlhbHMsXG4gICAgICAgICAgICBncm91cGluZzogb3JpZ2luYWxMZXNzb24uZ3JvdXBpbmcsXG4gICAgICAgICAgICB0aXRsZUZyOiBvcmlnaW5hbExlc3Nvbi50aXRsZUZyLFxuICAgICAgICAgICAgbWluZHNPbkZyOiBvcmlnaW5hbExlc3Nvbi5taW5kc09uRnIsXG4gICAgICAgICAgICBhY3Rpb25Gcjogb3JpZ2luYWxMZXNzb24uYWN0aW9uRnIsXG4gICAgICAgICAgICBjb25zb2xpZGF0aW9uRnI6IG9yaWdpbmFsTGVzc29uLmNvbnNvbGlkYXRpb25GcixcbiAgICAgICAgICAgIGxlYXJuaW5nR29hbHNGcjogb3JpZ2luYWxMZXNzb24ubGVhcm5pbmdHb2Fsc0ZyLFxuICAgICAgICAgICAgYWNjb21tb2RhdGlvbnM6IG9yaWdpbmFsTGVzc29uLmFjY29tbW9kYXRpb25zLFxuICAgICAgICAgICAgbW9kaWZpY2F0aW9uczogb3JpZ2luYWxMZXNzb24ubW9kaWZpY2F0aW9ucyxcbiAgICAgICAgICAgIGV4dGVuc2lvbnM6IG9yaWdpbmFsTGVzc29uLmV4dGVuc2lvbnMsXG4gICAgICAgICAgICBhc3Nlc3NtZW50VHlwZTogb3JpZ2luYWxMZXNzb24uYXNzZXNzbWVudFR5cGUsXG4gICAgICAgICAgICBhc3Nlc3NtZW50Tm90ZXM6IG9yaWdpbmFsTGVzc29uLmFzc2Vzc21lbnROb3RlcyxcbiAgICAgICAgICAgIGlzU3ViRnJpZW5kbHk6IG9yaWdpbmFsTGVzc29uLmlzU3ViRnJpZW5kbHksXG4gICAgICAgICAgICBzdWJOb3Rlczogb3JpZ2luYWxMZXNzb24uc3ViTm90ZXMsXG4gICAgICAgICAgICBleHBlY3RhdGlvbnM6IHtcbiAgICAgICAgICAgICAgY3JlYXRlOiBvcmlnaW5hbExlc3Nvbi5leHBlY3RhdGlvbnMubWFwKGUgPT4gKHtcbiAgICAgICAgICAgICAgICBleHBlY3RhdGlvbklkOiBlLmV4cGVjdGF0aW9uSWQsXG4gICAgICAgICAgICAgIH0pKSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuXG4gICAgICAvLyBUT0RPOiBJbXBsZW1lbnQgY29weWluZyBmb3Igb3RoZXIgcGxhbiB0eXBlc1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgZXJyb3I6ICdDb3B5aW5nIHRoaXMgcGxhbiB0eXBlIGlzIG5vdCB5ZXQgc3VwcG9ydGVkJyB9KTtcbiAgICB9XG5cbiAgICAvLyBVcGRhdGUgY29weSBjb3VudFxuICAgIGF3YWl0IHByaXNtYS5zaGFyZWRQbGFuLnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyBpZDogc2hhcmVkUGxhbi5pZCB9LFxuICAgICAgZGF0YTogeyBjb3B5Q291bnQ6IHsgaW5jcmVtZW50OiAxIH0gfSxcbiAgICB9KTtcblxuICAgIGxvZ2dlci5pbmZvKGBQbGFuIGNvcGllZDogJHtzaGFyZWRQbGFuLnBsYW5UeXBlfS8ke3NoYXJlZFBsYW4ucGxhbklkfSBieSB1c2VyICR7dXNlcklkfWApO1xuICAgIHJlcy5zdGF0dXMoMjAxKS5qc29uKGNvcGllZFBsYW4pO1xuICB9KSk7XG5cbiAgcmV0dXJuIHJvdXRlcjtcbn0iXSwidmVyc2lvbiI6M30=