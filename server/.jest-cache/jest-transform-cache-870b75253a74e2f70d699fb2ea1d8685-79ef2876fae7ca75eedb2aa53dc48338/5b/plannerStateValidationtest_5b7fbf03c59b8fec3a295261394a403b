9db5c78354059b010c112b69cafef4a3
import { describe, it, expect, beforeEach, afterEach } from '@jest/globals';
import request from 'supertest';
import express from 'express';
import plannerStateRouter from '../../src/routes/planner-state';
import { prisma } from '../../src/prisma';
const app = express();
app.use(express.json());
// Mock authenticated user middleware
app.use((req, res, next) => {
    req.user = { userId: '1' };
    next();
});
app.use('/api/planner', plannerStateRouter);
describe('State Management Agent Security Tests', () => {
    beforeEach(async () => {
        // Clean database before each test
        await prisma.weeklyPlannerState.deleteMany();
    });
    afterEach(async () => {
        // Clean up after each test
        await prisma.weeklyPlannerState.deleteMany();
    });
    describe('JSON Injection Prevention', () => {
        it('should reject malicious script injection in draftChanges', async () => {
            const maliciousPayload = {
                defaultView: 'week',
                draftChanges: {
                    title: '<script>alert("XSS")</script>',
                    content: 'javascript:void(0)',
                    changes: {
                        '<script>': 'malicious value'
                    }
                }
            };
            const response = await request(app)
                .put('/api/planner/state')
                .send(maliciousPayload)
                .expect(200);
            // Verify script tags are sanitized
            expect(response.body.draftChanges.title).not.toContain('<script>');
            expect(response.body.draftChanges.title).not.toContain('alert');
            expect(response.body.draftChanges.content).not.toContain('javascript:');
        });
        it('should enforce size limits on draft changes', async () => {
            const oversizedPayload = {
                defaultView: 'week',
                draftChanges: {
                    title: 'A'.repeat(300), // Exceeds 200 char limit
                    content: 'B'.repeat(15000), // Exceeds 10000 char limit
                }
            };
            await request(app)
                .put('/api/planner/state')
                .send(oversizedPayload)
                .expect(400); // Should be rejected by validation
        });
        it('should reject prototype pollution attempts', async () => {
            const pollutionPayload = {
                defaultView: 'week',
                '__proto__': { isAdmin: true },
                draftChanges: {
                    '__proto__': { polluted: true }
                }
            };
            await request(app)
                .put('/api/planner/state')
                .send(pollutionPayload)
                .expect(400); // Should be rejected by strict schema
        });
    });
    describe('CSRF Protection', () => {
        it('should block requests without proper origin', async () => {
            await request(app)
                .put('/api/planner/state')
                .set('Origin', 'http://evil.com')
                .send({ defaultView: 'week' })
                .expect(403);
        });
        it('should allow requests from allowed origins', async () => {
            await request(app)
                .put('/api/planner/state')
                .set('Origin', 'http://localhost:5173')
                .send({ defaultView: 'week' })
                .expect(200);
        });
        it('should block requests without origin or referer', async () => {
            await request(app)
                .put('/api/planner/state')
                .send({ defaultView: 'week' })
                .expect(403);
        });
    });
    describe('Rate Limiting', () => {
        it('should enforce rate limits on state updates', async () => {
            const payload = { defaultView: 'week' };
            // Make rapid requests to test rate limiting
            const requests = Array(110).fill(0).map(() => request(app)
                .put('/api/planner/state')
                .set('Origin', 'http://localhost:5173')
                .send(payload));
            const responses = await Promise.all(requests);
            // Should have some rate-limited responses (429 status)
            const rateLimited = responses.filter(r => r.status === 429);
            expect(rateLimited.length).toBeGreaterThan(0);
        });
    });
    describe('Data Validation', () => {
        it('should validate enum values strictly', async () => {
            const invalidPayload = {
                defaultView: 'invalid_view',
                timeSlotDuration: 45, // Not in allowed [15, 30, 60]
                theme: 'rainbow'
            };
            await request(app)
                .put('/api/planner/state')
                .set('Origin', 'http://localhost:5173')
                .send(invalidPayload)
                .expect(400);
        });
        it('should validate working hours format', async () => {
            const invalidHours = {
                defaultView: 'week',
                workingHours: {
                    start: '25:00', // Invalid time
                    end: 'not-a-time'
                }
            };
            await request(app)
                .put('/api/planner/state')
                .set('Origin', 'http://localhost:5173')
                .send(invalidHours)
                .expect(400);
        });
        it('should validate autoSaveInterval bounds', async () => {
            const invalidInterval = {
                defaultView: 'week',
                autoSaveInterval: 500 // Exceeds max of 300
            };
            await request(app)
                .put('/api/planner/state')
                .set('Origin', 'http://localhost:5173')
                .send(invalidInterval)
                .expect(400);
        });
    });
    describe('Memory Limits', () => {
        it('should enforce maxHistorySize limits', async () => {
            const oversizedHistory = {
                defaultView: 'week',
                maxHistorySize: 150 // Exceeds max of 100
            };
            await request(app)
                .put('/api/planner/state')
                .set('Origin', 'http://localhost:5173')
                .send(oversizedHistory)
                .expect(400);
        });
        it('should limit offline data array size', async () => {
            const largeOfflineData = {
                defaultView: 'week',
                offlineData: {
                    pendingChanges: Array(60).fill({
                        planId: 'test',
                        title: 'test'
                    })
                }
            };
            await request(app)
                .put('/api/planner/state')
                .set('Origin', 'http://localhost:5173')
                .send(largeOfflineData)
                .expect(400);
        });
    });
    describe('Response Security', () => {
        it('should return sanitized data in responses', async () => {
            // First create state with potentially dangerous content
            const payload = {
                defaultView: 'week',
                lastActiveView: '<img src=x onerror=alert(1)>',
                draftChanges: {
                    title: '<b>Bold Title</b>',
                    content: 'Normal content'
                }
            };
            const response = await request(app)
                .put('/api/planner/state')
                .set('Origin', 'http://localhost:5173')
                .send(payload)
                .expect(200);
            // Verify response is sanitized
            expect(response.body.lastActiveView).not.toContain('<img');
            expect(response.body.lastActiveView).not.toContain('onerror');
            expect(response.body.draftChanges.title).not.toContain('<b>');
        });
        it('should parse JSON fields correctly in responses', async () => {
            const payload = {
                defaultView: 'week',
                workingHours: { start: '09:00', end: '17:00' },
                draftChanges: { title: 'Test Title' }
            };
            const response = await request(app)
                .put('/api/planner/state')
                .set('Origin', 'http://localhost:5173')
                .send(payload)
                .expect(200);
            // Verify JSON fields are properly parsed objects, not strings
            expect(typeof response.body.workingHours).toBe('object');
            expect(response.body.workingHours.start).toBe('09:00');
            expect(typeof response.body.draftChanges).toBe('object');
            expect(response.body.draftChanges.title).toBe('Test Title');
        });
    });
    describe('Database Security', () => {
        it('should store data securely in database', async () => {
            const payload = {
                defaultView: 'week',
                workingHours: { start: '08:00', end: '16:00' },
                draftChanges: { title: 'Secure Title' }
            };
            await request(app)
                .put('/api/planner/state')
                .set('Origin', 'http://localhost:5173')
                .send(payload)
                .expect(200);
            // Verify data is stored as JSON strings in database
            const dbRecord = await prisma.weeklyPlannerState.findFirst({
                where: { userId: 1 }
            });
            expect(typeof dbRecord?.workingHours).toBe('string');
            expect(typeof dbRecord?.draftChanges).toBe('string');
            // Verify JSON is valid
            const parsedHours = JSON.parse(dbRecord.workingHours);
            expect(parsedHours.start).toBe('08:00');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3Rlc3RzL3VuaXQvcGxhbm5lclN0YXRlVmFsaWRhdGlvbi50ZXN0LnRzIiwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzVFLE9BQU8sT0FBTyxNQUFNLFdBQVcsQ0FBQztBQUNoQyxPQUFPLE9BQU8sTUFBTSxTQUFTLENBQUM7QUFDOUIsT0FBTyxrQkFBa0IsTUFBTSxnQ0FBZ0MsQ0FBQztBQUNoRSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFFMUMsTUFBTSxHQUFHLEdBQUcsT0FBTyxFQUFFLENBQUM7QUFDdEIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztBQUV4QixxQ0FBcUM7QUFDckMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQVEsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUU7SUFDOUIsR0FBRyxDQUFDLElBQUksR0FBRyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQztJQUMzQixJQUFJLEVBQUUsQ0FBQztBQUNULENBQUMsQ0FBQyxDQUFDO0FBRUgsR0FBRyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztBQUU1QyxRQUFRLENBQUMsdUNBQXVDLEVBQUUsR0FBRyxFQUFFO0lBQ3JELFVBQVUsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNwQixrQ0FBa0M7UUFDbEMsTUFBTSxNQUFNLENBQUMsa0JBQWtCLENBQUMsVUFBVSxFQUFFLENBQUM7SUFDL0MsQ0FBQyxDQUFDLENBQUM7SUFFSCxTQUFTLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDbkIsMkJBQTJCO1FBQzNCLE1BQU0sTUFBTSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsRUFBRSxDQUFD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LEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsT0FBTyxFQUFFO2dCQUM5QyxZQUFZLEVBQUUsRUFBRSxLQUFLLEVBQUUsY0FBYyxFQUFFO2FBQ3hDLENBQUM7WUFFRixNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUM7aUJBQ2YsR0FBRyxDQUFDLG9CQUFvQixDQUFDO2lCQUN6QixHQUFHLENBQUMsUUFBUSxFQUFFLHVCQUF1QixDQUFDO2lCQUN0QyxJQUFJLENBQUMsT0FBTyxDQUFDO2lCQUNiLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUVmLG9EQUFvRDtZQUNwRCxNQUFNLFFBQVEsR0FBRyxNQUFNLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxTQUFTLENBQUM7Z0JBQ3pELEtBQUssRUFBRSxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUU7YUFDckIsQ0FBQyxDQUFDO1lBRUgsTUFBTSxDQUFDLE9BQU8sUUFBUSxFQUFFLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNyRCxNQUFNLENBQUMsT0FBTyxRQUFRLEVBQUUsWUFBWSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRXJELHVCQUF1QjtZQUN2QixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVMsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUN2RCxNQUFNLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMxQyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3Rlc3RzL3VuaXQvcGxhbm5lclN0YXRlVmFsaWRhdGlvbi50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGRlc2NyaWJlLCBpdCwgZXhwZWN0LCBiZWZvcmVFYWNoLCBhZnRlckVhY2ggfSBmcm9tICdAamVzdC9nbG9iYWxzJztcbmltcG9ydCByZXF1ZXN0IGZyb20gJ3N1cGVydGVzdCc7XG5pbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCBwbGFubmVyU3RhdGVSb3V0ZXIgZnJvbSAnLi4vLi4vc3JjL3JvdXRlcy9wbGFubmVyLXN0YXRlJztcbmltcG9ydCB7IHByaXNtYSB9IGZyb20gJy4uLy4uL3NyYy9wcmlzbWEnO1xuXG5jb25zdCBhcHAgPSBleHByZXNzKCk7XG5hcHAudXNlKGV4cHJlc3MuanNvbigpKTtcblxuLy8gTW9jayBhdXRoZW50aWNhdGVkIHVzZXIgbWlkZGxld2FyZVxuYXBwLnVzZSgocmVxOiBhbnksIHJlcywgbmV4dCkgPT4ge1xuICByZXEudXNlciA9IHsgdXNlcklkOiAnMScgfTtcbiAgbmV4dCgpO1xufSk7XG5cbmFwcC51c2UoJy9hcGkvcGxhbm5lcicsIHBsYW5uZXJTdGF0ZVJvdXRlcik7XG5cbmRlc2NyaWJlKCdTdGF0ZSBNYW5hZ2VtZW50IEFnZW50IFNlY3VyaXR5IFRlc3RzJywgKCkgPT4ge1xuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICAvLyBDbGVhbiBkYXRhYmFzZSBiZWZvcmUgZWFjaCB0ZXN0XG4gICAgYXdhaXQgcHJpc21hLndlZWtseVBsYW5uZXJTdGF0ZS5kZWxldGVNYW55KCk7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaChhc3luYyAoKSA9PiB7XG4gICAgLy8gQ2xlYW4gdXAgYWZ0ZXIgZWFjaCB0ZXN0XG4gICAgYXdhaXQgcHJpc21hLndlZWtseVBsYW5uZXJTdGF0ZS5kZWxldGVNYW55KCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdKU09OIEluamVjdGlvbiBQcmV2ZW50aW9uJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmVqZWN0IG1hbGljaW91cyBzY3JpcHQgaW5qZWN0aW9uIGluIGRyYWZ0Q2hhbmdlcycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG1hbGljaW91c1BheWxvYWQgPSB7XG4gICAgICAgIGRlZmF1bHRWaWV3OiAnd2VlaycsXG4gICAgICAgIGRyYWZ0Q2hhbmdlczoge1xuICAgICAgICAgIHRpdGxlOiAnPHNjcmlwdD5hbGVydChcIlhTU1wiKTwvc2NyaXB0PicsXG4gICAgICAgICAgY29udGVudDogJ2phdmFzY3JpcHQ6dm9pZCgwKScsXG4gICAgICAgICAgY2hhbmdlczoge1xuICAgICAgICAgICAgJzxzY3JpcHQ+JzogJ21hbGljaW91cyB2YWx1ZSdcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5wdXQoJy9hcGkvcGxhbm5lci9zdGF0ZScpXG4gICAgICAgIC5zZW5kKG1hbGljaW91c1BheWxvYWQpXG4gICAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgICAgLy8gVmVyaWZ5IHNjcmlwdCB0YWdzIGFyZSBzYW5pdGl6ZWRcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LmRyYWZ0Q2hhbmdlcy50aXRsZSkubm90LnRvQ29udGFpbignPHNjcmlwdD4nKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LmRyYWZ0Q2hhbmdlcy50aXRsZSkubm90LnRvQ29udGFpbignYWxlcnQnKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LmRyYWZ0Q2hhbmdlcy5jb250ZW50KS5ub3QudG9Db250YWluKCdqYXZhc2NyaXB0OicpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBlbmZvcmNlIHNpemUgbGltaXRzIG9uIGRyYWZ0IGNoYW5nZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBvdmVyc2l6ZWRQYXlsb2FkID0ge1xuICAgICAgICBkZWZhdWx0VmlldzogJ3dlZWsnLFxuICAgICAgICBkcmFmdENoYW5nZXM6IHtcbiAgICAgICAgICB0aXRsZTogJ0EnLnJlcGVhdCgzMDApLCAvLyBFeGNlZWRzIDIwMCBjaGFyIGxpbWl0XG4gICAgICAgICAgY29udGVudDogJ0InLnJlcGVhdCgxNTAwMCksIC8vIEV4Y2VlZHMgMTAwMDAgY2hhciBsaW1pdFxuICAgICAgICB9XG4gICAgICB9O1xuXG4gICAgICBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLnB1dCgnL2FwaS9wbGFubmVyL3N0YXRlJylcbiAgICAgICAgLnNlbmQob3ZlcnNpemVkUGF5bG9hZClcbiAgICAgICAgLmV4cGVjdCg0MDApOyAvLyBTaG91bGQgYmUgcmVqZWN0ZWQgYnkgdmFsaWRhdGlvblxuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZWplY3QgcHJvdG90eXBlIHBvbGx1dGlvbiBhdHRlbXB0cycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHBvbGx1dGlvblBheWxvYWQgPSB7XG4gICAgICAgIGRlZmF1bHRWaWV3OiAnd2VlaycsXG4gICAgICAgICdfX3Byb3RvX18nOiB7IGlzQWRtaW46IHRydWUgfSxcbiAgICAgICAgZHJhZnRDaGFuZ2VzOiB7XG4gICAgICAgICAgJ19fcHJvdG9fXyc6IHsgcG9sbHV0ZWQ6IHRydWUgfVxuICAgICAgICB9XG4gICAgICB9O1xuXG4gICAgICBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLnB1dCgnL2FwaS9wbGFubmVyL3N0YXRlJylcbiAgICAgICAgLnNlbmQocG9sbHV0aW9uUGF5bG9hZClcbiAgICAgICAgLmV4cGVjdCg0MDApOyAvLyBTaG91bGQgYmUgcmVqZWN0ZWQgYnkgc3RyaWN0IHNjaGVtYVxuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnQ1NSRiBQcm90ZWN0aW9uJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgYmxvY2sgcmVxdWVzdHMgd2l0aG91dCBwcm9wZXIgb3JpZ2luJywgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5wdXQoJy9hcGkvcGxhbm5lci9zdGF0ZScpXG4gICAgICAgIC5zZXQoJ09yaWdpbicsICdodHRwOi8vZXZpbC5jb20nKVxuICAgICAgICAuc2VuZCh7IGRlZmF1bHRWaWV3OiAnd2VlaycgfSlcbiAgICAgICAgLmV4cGVjdCg0MDMpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBhbGxvdyByZXF1ZXN0cyBmcm9tIGFsbG93ZWQgb3JpZ2lucycsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAucHV0KCcvYXBpL3BsYW5uZXIvc3RhdGUnKVxuICAgICAgICAuc2V0KCdPcmlnaW4nLCAnaHR0cDovL2xvY2FsaG9zdDo1MTczJylcbiAgICAgICAgLnNlbmQoeyBkZWZhdWx0VmlldzogJ3dlZWsnIH0pXG4gICAgICAgIC5leHBlY3QoMjAwKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgYmxvY2sgcmVxdWVzdHMgd2l0aG91dCBvcmlnaW4gb3IgcmVmZXJlcicsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAucHV0KCcvYXBpL3BsYW5uZXIvc3RhdGUnKVxuICAgICAgICAuc2VuZCh7IGRlZmF1bHRWaWV3OiAnd2VlaycgfSlcbiAgICAgICAgLmV4cGVjdCg0MDMpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnUmF0ZSBMaW1pdGluZycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGVuZm9yY2UgcmF0ZSBsaW1pdHMgb24gc3RhdGUgdXBkYXRlcycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHBheWxvYWQgPSB7IGRlZmF1bHRWaWV3OiAnd2VlaycgfTtcbiAgICAgIFxuICAgICAgLy8gTWFrZSByYXBpZCByZXF1ZXN0cyB0byB0ZXN0IHJhdGUgbGltaXRpbmdcbiAgICAgIGNvbnN0IHJlcXVlc3RzID0gQXJyYXkoMTEwKS5maWxsKDApLm1hcCgoKSA9PiBcbiAgICAgICAgcmVxdWVzdChhcHApXG4gICAgICAgICAgLnB1dCgnL2FwaS9wbGFubmVyL3N0YXRlJylcbiAgICAgICAgICAuc2V0KCdPcmlnaW4nLCAnaHR0cDovL2xvY2FsaG9zdDo1MTczJylcbiAgICAgICAgICAuc2VuZChwYXlsb2FkKVxuICAgICAgKTtcblxuICAgICAgY29uc3QgcmVzcG9uc2VzID0gYXdhaXQgUHJvbWlzZS5hbGwocmVxdWVzdHMpO1xuICAgICAgXG4gICAgICAvLyBTaG91bGQgaGF2ZSBzb21lIHJhdGUtbGltaXRlZCByZXNwb25zZXMgKDQyOSBzdGF0dXMpXG4gICAgICBjb25zdCByYXRlTGltaXRlZCA9IHJlc3BvbnNlcy5maWx0ZXIociA9PiByLnN0YXR1cyA9PT0gNDI5KTtcbiAgICAgIGV4cGVjdChyYXRlTGltaXRlZC5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0RhdGEgVmFsaWRhdGlvbicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHZhbGlkYXRlIGVudW0gdmFsdWVzIHN0cmljdGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaW52YWxpZFBheWxvYWQgPSB7XG4gICAgICAgIGRlZmF1bHRWaWV3OiAnaW52YWxpZF92aWV3JyxcbiAgICAgICAgdGltZVNsb3REdXJhdGlvbjogNDUsIC8vIE5vdCBpbiBhbGxvd2VkIFsxNSwgMzAsIDYwXVxuICAgICAgICB0aGVtZTogJ3JhaW5ib3cnXG4gICAgICB9O1xuXG4gICAgICBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLnB1dCgnL2FwaS9wbGFubmVyL3N0YXRlJylcbiAgICAgICAgLnNldCgnT3JpZ2luJywgJ2h0dHA6Ly9sb2NhbGhvc3Q6NTE3MycpXG4gICAgICAgIC5zZW5kKGludmFsaWRQYXlsb2FkKVxuICAgICAgICAuZXhwZWN0KDQwMCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHZhbGlkYXRlIHdvcmtpbmcgaG91cnMgZm9ybWF0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaW52YWxpZEhvdXJzID0ge1xuICAgICAgICBkZWZhdWx0VmlldzogJ3dlZWsnLFxuICAgICAgICB3b3JraW5nSG91cnM6IHtcbiAgICAgICAgICBzdGFydDogJzI1OjAwJywgLy8gSW52YWxpZCB0aW1lXG4gICAgICAgICAgZW5kOiAnbm90LWEtdGltZSdcbiAgICAgICAgfVxuICAgICAgfTtcblxuICAgICAgYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5wdXQoJy9hcGkvcGxhbm5lci9zdGF0ZScpXG4gICAgICAgIC5zZXQoJ09yaWdpbicsICdodHRwOi8vbG9jYWxob3N0OjUxNzMnKVxuICAgICAgICAuc2VuZChpbnZhbGlkSG91cnMpXG4gICAgICAgIC5leHBlY3QoNDAwKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdmFsaWRhdGUgYXV0b1NhdmVJbnRlcnZhbCBib3VuZHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBpbnZhbGlkSW50ZXJ2YWwgPSB7XG4gICAgICAgIGRlZmF1bHRWaWV3OiAnd2VlaycsXG4gICAgICAgIGF1dG9TYXZlSW50ZXJ2YWw6IDUwMCAvLyBFeGNlZWRzIG1heCBvZiAzMDBcbiAgICAgIH07XG5cbiAgICAgIGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAucHV0KCcvYXBpL3BsYW5uZXIvc3RhdGUnKVxuICAgICAgICAuc2V0KCdPcmlnaW4nLCAnaHR0cDovL2xvY2FsaG9zdDo1MTczJylcbiAgICAgICAgLnNlbmQoaW52YWxpZEludGVydmFsKVxuICAgICAgICAuZXhwZWN0KDQwMCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdNZW1vcnkgTGltaXRzJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZW5mb3JjZSBtYXhIaXN0b3J5U2l6ZSBsaW1pdHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBvdmVyc2l6ZWRIaXN0b3J5ID0ge1xuICAgICAgICBkZWZhdWx0VmlldzogJ3dlZWsnLFxuICAgICAgICBtYXhIaXN0b3J5U2l6ZTogMTUwIC8vIEV4Y2VlZHMgbWF4IG9mIDEwMFxuICAgICAgfTtcblxuICAgICAgYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5wdXQoJy9hcGkvcGxhbm5lci9zdGF0ZScpXG4gICAgICAgIC5zZXQoJ09yaWdpbicsICdodHRwOi8vbG9jYWxob3N0OjUxNzMnKVxuICAgICAgICAuc2VuZChvdmVyc2l6ZWRIaXN0b3J5KVxuICAgICAgICAuZXhwZWN0KDQwMCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGxpbWl0IG9mZmxpbmUgZGF0YSBhcnJheSBzaXplJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgbGFyZ2VPZmZsaW5lRGF0YSA9IHtcbiAgICAgICAgZGVmYXVsdFZpZXc6ICd3ZWVrJyxcbiAgICAgICAgb2ZmbGluZURhdGE6IHtcbiAgICAgICAgICBwZW5kaW5nQ2hhbmdlczogQXJyYXkoNjApLmZpbGwoeyAvLyBFeGNlZWRzIG1heCBvZiA1MFxuICAgICAgICAgICAgcGxhbklkOiAndGVzdCcsXG4gICAgICAgICAgICB0aXRsZTogJ3Rlc3QnXG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgfTtcblxuICAgICAgYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5wdXQoJy9hcGkvcGxhbm5lci9zdGF0ZScpXG4gICAgICAgIC5zZXQoJ09yaWdpbicsICdodHRwOi8vbG9jYWxob3N0OjUxNzMnKVxuICAgICAgICAuc2VuZChsYXJnZU9mZmxpbmVEYXRhKVxuICAgICAgICAuZXhwZWN0KDQwMCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdSZXNwb25zZSBTZWN1cml0eScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJldHVybiBzYW5pdGl6ZWQgZGF0YSBpbiByZXNwb25zZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBGaXJzdCBjcmVhdGUgc3RhdGUgd2l0aCBwb3RlbnRpYWxseSBkYW5nZXJvdXMgY29udGVudFxuICAgICAgY29uc3QgcGF5bG9hZCA9IHtcbiAgICAgICAgZGVmYXVsdFZpZXc6ICd3ZWVrJyxcbiAgICAgICAgbGFzdEFjdGl2ZVZpZXc6ICc8aW1nIHNyYz14IG9uZXJyb3I9YWxlcnQoMSk+JyxcbiAgICAgICAgZHJhZnRDaGFuZ2VzOiB7XG4gICAgICAgICAgdGl0bGU6ICc8Yj5Cb2xkIFRpdGxlPC9iPicsXG4gICAgICAgICAgY29udGVudDogJ05vcm1hbCBjb250ZW50J1xuICAgICAgICB9XG4gICAgICB9O1xuXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAucHV0KCcvYXBpL3BsYW5uZXIvc3RhdGUnKVxuICAgICAgICAuc2V0KCdPcmlnaW4nLCAnaHR0cDovL2xvY2FsaG9zdDo1MTczJylcbiAgICAgICAgLnNlbmQocGF5bG9hZClcbiAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICAvLyBWZXJpZnkgcmVzcG9uc2UgaXMgc2FuaXRpemVkXG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5sYXN0QWN0aXZlVmlldykubm90LnRvQ29udGFpbignPGltZycpO1xuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkubGFzdEFjdGl2ZVZpZXcpLm5vdC50b0NvbnRhaW4oJ29uZXJyb3InKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LmRyYWZ0Q2hhbmdlcy50aXRsZSkubm90LnRvQ29udGFpbignPGI+Jyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHBhcnNlIEpTT04gZmllbGRzIGNvcnJlY3RseSBpbiByZXNwb25zZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBwYXlsb2FkID0ge1xuICAgICAgICBkZWZhdWx0VmlldzogJ3dlZWsnLFxuICAgICAgICB3b3JraW5nSG91cnM6IHsgc3RhcnQ6ICcwOTowMCcsIGVuZDogJzE3OjAwJyB9LFxuICAgICAgICBkcmFmdENoYW5nZXM6IHsgdGl0bGU6ICdUZXN0IFRpdGxlJyB9XG4gICAgICB9O1xuXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAucHV0KCcvYXBpL3BsYW5uZXIvc3RhdGUnKVxuICAgICAgICAuc2V0KCdPcmlnaW4nLCAnaHR0cDovL2xvY2FsaG9zdDo1MTczJylcbiAgICAgICAgLnNlbmQocGF5bG9hZClcbiAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICAvLyBWZXJpZnkgSlNPTiBmaWVsZHMgYXJlIHByb3Blcmx5IHBhcnNlZCBvYmplY3RzLCBub3Qgc3RyaW5nc1xuICAgICAgZXhwZWN0KHR5cGVvZiByZXNwb25zZS5ib2R5LndvcmtpbmdIb3VycykudG9CZSgnb2JqZWN0Jyk7XG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS53b3JraW5nSG91cnMuc3RhcnQpLnRvQmUoJzA5OjAwJyk7XG4gICAgICBleHBlY3QodHlwZW9mIHJlc3BvbnNlLmJvZHkuZHJhZnRDaGFuZ2VzKS50b0JlKCdvYmplY3QnKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LmRyYWZ0Q2hhbmdlcy50aXRsZSkudG9CZSgnVGVzdCBUaXRsZScpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnRGF0YWJhc2UgU2VjdXJpdHknLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBzdG9yZSBkYXRhIHNlY3VyZWx5IGluIGRhdGFiYXNlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcGF5bG9hZCA9IHtcbiAgICAgICAgZGVmYXVsdFZpZXc6ICd3ZWVrJyxcbiAgICAgICAgd29ya2luZ0hvdXJzOiB7IHN0YXJ0OiAnMDg6MDAnLCBlbmQ6ICcxNjowMCcgfSxcbiAgICAgICAgZHJhZnRDaGFuZ2VzOiB7IHRpdGxlOiAnU2VjdXJlIFRpdGxlJyB9XG4gICAgICB9O1xuXG4gICAgICBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLnB1dCgnL2FwaS9wbGFubmVyL3N0YXRlJylcbiAgICAgICAgLnNldCgnT3JpZ2luJywgJ2h0dHA6Ly9sb2NhbGhvc3Q6NTE3MycpXG4gICAgICAgIC5zZW5kKHBheWxvYWQpXG4gICAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgICAgLy8gVmVyaWZ5IGRhdGEgaXMgc3RvcmVkIGFzIEpTT04gc3RyaW5ncyBpbiBkYXRhYmFzZVxuICAgICAgY29uc3QgZGJSZWNvcmQgPSBhd2FpdCBwcmlzbWEud2Vla2x5UGxhbm5lclN0YXRlLmZpbmRGaXJzdCh7XG4gICAgICAgIHdoZXJlOiB7IHVzZXJJZDogMSB9XG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0KHR5cGVvZiBkYlJlY29yZD8ud29ya2luZ0hvdXJzKS50b0JlKCdzdHJpbmcnKTtcbiAgICAgIGV4cGVjdCh0eXBlb2YgZGJSZWNvcmQ/LmRyYWZ0Q2hhbmdlcykudG9CZSgnc3RyaW5nJyk7XG4gICAgICBcbiAgICAgIC8vIFZlcmlmeSBKU09OIGlzIHZhbGlkXG4gICAgICBjb25zdCBwYXJzZWRIb3VycyA9IEpTT04ucGFyc2UoZGJSZWNvcmQhLndvcmtpbmdIb3Vycyk7XG4gICAgICBleHBlY3QocGFyc2VkSG91cnMuc3RhcnQpLnRvQmUoJzA4OjAwJyk7XG4gICAgfSk7XG4gIH0pO1xufSk7Il0sInZlcnNpb24iOjN9