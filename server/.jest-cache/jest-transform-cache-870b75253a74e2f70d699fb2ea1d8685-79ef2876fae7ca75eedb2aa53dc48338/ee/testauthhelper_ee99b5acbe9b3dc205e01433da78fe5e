bc4d07d448a1510a89ab2970b7d8446b
import request from 'supertest';
import bcrypt from 'bcryptjs';
import jwt from 'jsonwebtoken';
import { getTestPrismaClient } from './jest.setup.js';
/**
 * Helper to create a test user and get authentication token
 */
export async function getAuthToken(app, email) {
    const prisma = getTestPrismaClient();
    // Generate unique email if not provided
    const userEmail = email || `test-${Date.now()}-${Math.random().toString(36).substring(7)}@example.com`;
    // Create a test user with hashed password
    const hashedPassword = await bcrypt.hash('testpassword', 10);
    const user = await prisma.user.create({
        data: {
            email: userEmail,
            name: 'Test User',
            password: hashedPassword,
            role: 'teacher',
        },
    });
    // Login to get token
    const loginResponse = await request(app).post('/api/login').send({
        email: userEmail,
        password: 'testpassword',
    });
    if (loginResponse.status !== 200) {
        throw new Error(`Login failed: ${loginResponse.status} ${loginResponse.text}`);
    }
    return { token: loginResponse.body.token, userId: user.id };
}
/**
 * Helper to make authenticated requests
 */
export function authRequest(app) {
    let token = null;
    let userId = null;
    return {
        async setup() {
            const authData = await getAuthToken(app);
            token = authData.token;
            userId = authData.userId;
        },
        get userId() {
            return userId;
        },
        get(url) {
            return request(app).get(url).set('Authorization', `Bearer ${token}`);
        },
        post(url) {
            return request(app).post(url).set('Authorization', `Bearer ${token}`);
        },
        put(url) {
            return request(app).put(url).set('Authorization', `Bearer ${token}`);
        },
        delete(url) {
            return request(app).delete(url).set('Authorization', `Bearer ${token}`);
        },
        patch(url) {
            return request(app).patch(url).set('Authorization', `Bearer ${token}`);
        },
    };
}
/**
 * Create a test user without going through HTTP
 */
export async function createTestUser(email) {
    const prisma = getTestPrismaClient();
    // Generate unique email if not provided
    const userEmail = email || `test-${Date.now()}-${Math.random().toString(36).substring(7)}@example.com`;
    const hashedPassword = await bcrypt.hash('testpassword', 10);
    return await prisma.user.create({
        data: {
            email: userEmail,
            name: 'Test User',
            password: hashedPassword,
            role: 'teacher',
        },
    });
}
/**
 * Create an auth token for a user ID
 */
export function createAuthToken(userId, email) {
    const secret = process.env.JWT_SECRET;
    if (!secret) {
        throw new Error('JWT_SECRET environment variable is required for testing');
    }
    return jwt.sign({ userId: userId.toString(), email }, secret, { expiresIn: '24h' });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3Rlc3RzL3Rlc3QtYXV0aC1oZWxwZXIudHMiLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxPQUFPLE1BQU0sV0FBVyxDQUFDO0FBRWhDLE9BQU8sTUFBTSxNQUFNLFVBQVUsQ0FBQztBQUM5QixPQUFPLEdBQUcsTUFBTSxjQUFjLENBQUM7QUFDL0IsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFdEQ7O0dBRUc7QUFDSCxNQUFNLENBQUMsS0FBSyxVQUFVLFlBQVksQ0FBQyxHQUFnQixFQUFFLEtBQWM7SUFDakUsTUFBTSxNQUFNLEdBQUcsbUJBQW1CLEVBQUUsQ0FBQztJQUVyQyx3Q0FBd0M7SUFDeEMsTUFBTSxTQUFTLEdBQUcsS0FBSyxJQUFJLFFBQVEsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUM7SUFFdkcsMENBQTBDO0lBQzFDLE1BQU0sY0FBYyxHQUFHLE1BQU0sTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDN0QsTUFBTSxJQUFJLEdBQUcsTUFBTSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUNwQyxJQUFJLEVBQUU7WUFDSixLQUFLLEVBQUUsU0FBUztZQUNoQixJQUFJLEVBQUUsV0FBVztZQUNqQixRQUFRLEVBQUUsY0FBYztZQUN4QixJQUFJLEVBQUUsU0FBUztTQUNoQjtLQUNGLENBQUMsQ0FBQztJQUVILHFCQUFxQjtJQUNyQixNQUFNLGFBQWEsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQy9ELEtBQUssRUFBRSxTQUFTO1FBQ2hCLFFBQVEsRUFBRSxjQUFjO0tBQ3pC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QUFFLEtBQWE7SUFDM0QsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUM7SUFDdEMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ1osTUFBTSxJQUFJLEtBQUssQ0FBQyx5REFBeUQsQ0FBQyxDQUFDO0lBQzdFLENBQUM7SUFDRCxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLFFBQVEsRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFFLE1BQU0sRUFBRSxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO0FBQ3RGLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3Rlc3RzL3Rlc3QtYXV0aC1oZWxwZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHJlcXVlc3QgZnJvbSAnc3VwZXJ0ZXN0JztcbmltcG9ydCB0eXBlIHsgQXBwbGljYXRpb24gfSBmcm9tICdleHByZXNzJztcbmltcG9ydCBiY3J5cHQgZnJvbSAnYmNyeXB0anMnO1xuaW1wb3J0IGp3dCBmcm9tICdqc29ud2VidG9rZW4nO1xuaW1wb3J0IHsgZ2V0VGVzdFByaXNtYUNsaWVudCB9IGZyb20gJy4vamVzdC5zZXR1cC5qcyc7XG5cbi8qKlxuICogSGVscGVyIHRvIGNyZWF0ZSBhIHRlc3QgdXNlciBhbmQgZ2V0IGF1dGhlbnRpY2F0aW9uIHRva2VuXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRBdXRoVG9rZW4oYXBwOiBBcHBsaWNhdGlvbiwgZW1haWw/OiBzdHJpbmcpOiBQcm9taXNlPHsgdG9rZW46IHN0cmluZzsgdXNlcklkOiBudW1iZXIgfT4ge1xuICBjb25zdCBwcmlzbWEgPSBnZXRUZXN0UHJpc21hQ2xpZW50KCk7XG5cbiAgLy8gR2VuZXJhdGUgdW5pcXVlIGVtYWlsIGlmIG5vdCBwcm92aWRlZFxuICBjb25zdCB1c2VyRW1haWwgPSBlbWFpbCB8fCBgdGVzdC0ke0RhdGUubm93KCl9LSR7TWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyaW5nKDcpfUBleGFtcGxlLmNvbWA7XG5cbiAgLy8gQ3JlYXRlIGEgdGVzdCB1c2VyIHdpdGggaGFzaGVkIHBhc3N3b3JkXG4gIGNvbnN0IGhhc2hlZFBhc3N3b3JkID0gYXdhaXQgYmNyeXB0Lmhhc2goJ3Rlc3RwYXNzd29yZCcsIDEwKTtcbiAgY29uc3QgdXNlciA9IGF3YWl0IHByaXNtYS51c2VyLmNyZWF0ZSh7XG4gICAgZGF0YToge1xuICAgICAgZW1haWw6IHVzZXJFbWFpbCxcbiAgICAgIG5hbWU6ICdUZXN0IFVzZXInLFxuICAgICAgcGFzc3dvcmQ6IGhhc2hlZFBhc3N3b3JkLFxuICAgICAgcm9sZTogJ3RlYWNoZXInLFxuICAgIH0sXG4gIH0pO1xuXG4gIC8vIExvZ2luIHRvIGdldCB0b2tlblxuICBjb25zdCBsb2dpblJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApLnBvc3QoJy9hcGkvbG9naW4nKS5zZW5kKHtcbiAgICBlbWFpbDogdXNlckVtYWlsLFxuICAgIHBhc3N3b3JkOiAndGVzdHBhc3N3b3JkJyxcbiAgfSk7XG5cbiAgaWYgKGxvZ2luUmVzcG9uc2Uuc3RhdHVzICE9PSAyMDApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYExvZ2luIGZhaWxlZDogJHtsb2dpblJlc3BvbnNlLnN0YXR1c30gJHtsb2dpblJlc3BvbnNlLnRleHR9YCk7XG4gIH1cblxuICByZXR1cm4geyB0b2tlbjogbG9naW5SZXNwb25zZS5ib2R5LnRva2VuLCB1c2VySWQ6IHVzZXIuaWQgfTtcbn1cblxuLyoqXG4gKiBIZWxwZXIgdG8gbWFrZSBhdXRoZW50aWNhdGVkIHJlcXVlc3RzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBhdXRoUmVxdWVzdChhcHA6IEFwcGxpY2F0aW9uKSB7XG4gIGxldCB0b2tlbjogc3RyaW5nIHwgbnVsbCA9IG51bGw7XG4gIGxldCB1c2VySWQ6IG51bWJlciB8IG51bGwgPSBudWxsO1xuXG4gIHJldHVybiB7XG4gICAgYXN5bmMgc2V0dXAoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICBjb25zdCBhdXRoRGF0YSA9IGF3YWl0IGdldEF1dGhUb2tlbihhcHApO1xuICAgICAgdG9rZW4gPSBhdXRoRGF0YS50b2tlbjtcbiAgICAgIHVzZXJJZCA9IGF1dGhEYXRhLnVzZXJJZDtcbiAgICB9LFxuICAgIGdldCB1c2VySWQoKSB7XG4gICAgICByZXR1cm4gdXNlcklkO1xuICAgIH0sXG4gICAgZ2V0KHVybDogc3RyaW5nKSB7XG4gICAgICByZXR1cm4gcmVxdWVzdChhcHApLmdldCh1cmwpLnNldCgnQXV0aG9yaXphdGlvbicsIGBCZWFyZXIgJHt0b2tlbn1gKTtcbiAgICB9LFxuICAgIHBvc3QodXJsOiBzdHJpbmcpIHtcbiAgICAgIHJldHVybiByZXF1ZXN0KGFwcCkucG9zdCh1cmwpLnNldCgnQXV0aG9yaXphdGlvbicsIGBCZWFyZXIgJHt0b2tlbn1gKTtcbiAgICB9LFxuICAgIHB1dCh1cmw6IHN0cmluZykge1xuICAgICAgcmV0dXJuIHJlcXVlc3QoYXBwKS5wdXQodXJsKS5zZXQoJ0F1dGhvcml6YXRpb24nLCBgQmVhcmVyICR7dG9rZW59YCk7XG4gICAgfSxcbiAgICBkZWxldGUodXJsOiBzdHJpbmcpIHtcbiAgICAgIHJldHVybiByZXF1ZXN0KGFwcCkuZGVsZXRlKHVybCkuc2V0KCdBdXRob3JpemF0aW9uJywgYEJlYXJlciAke3Rva2VufWApO1xuICAgIH0sXG4gICAgcGF0Y2godXJsOiBzdHJpbmcpIHtcbiAgICAgIHJldHVybiByZXF1ZXN0KGFwcCkucGF0Y2godXJsKS5zZXQoJ0F1dGhvcml6YXRpb24nLCBgQmVhcmVyICR7dG9rZW59YCk7XG4gICAgfSxcbiAgfTtcbn1cblxuLyoqXG4gKiBDcmVhdGUgYSB0ZXN0IHVzZXIgd2l0aG91dCBnb2luZyB0aHJvdWdoIEhUVFBcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVRlc3RVc2VyKGVtYWlsPzogc3RyaW5nKSB7XG4gIGNvbnN0IHByaXNtYSA9IGdldFRlc3RQcmlzbWFDbGllbnQoKTtcbiAgXG4gIC8vIEdlbmVyYXRlIHVuaXF1ZSBlbWFpbCBpZiBub3QgcHJvdmlkZWRcbiAgY29uc3QgdXNlckVtYWlsID0gZW1haWwgfHwgYHRlc3QtJHtEYXRlLm5vdygpfS0ke01hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cmluZyg3KX1AZXhhbXBsZS5jb21gO1xuICBcbiAgY29uc3QgaGFzaGVkUGFzc3dvcmQgPSBhd2FpdCBiY3J5cHQuaGFzaCgndGVzdHBhc3N3b3JkJywgMTApO1xuICByZXR1cm4gYXdhaXQgcHJpc21hLnVzZXIuY3JlYXRlKHtcbiAgICBkYXRhOiB7XG4gICAgICBlbWFpbDogdXNlckVtYWlsLFxuICAgICAgbmFtZTogJ1Rlc3QgVXNlcicsXG4gICAgICBwYXNzd29yZDogaGFzaGVkUGFzc3dvcmQsXG4gICAgICByb2xlOiAndGVhY2hlcicsXG4gICAgfSxcbiAgfSk7XG59XG5cbi8qKlxuICogQ3JlYXRlIGFuIGF1dGggdG9rZW4gZm9yIGEgdXNlciBJRFxuICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlQXV0aFRva2VuKHVzZXJJZDogbnVtYmVyLCBlbWFpbDogc3RyaW5nKTogc3RyaW5nIHtcbiAgY29uc3Qgc2VjcmV0ID0gcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVDtcbiAgaWYgKCFzZWNyZXQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0pXVF9TRUNSRVQgZW52aXJvbm1lbnQgdmFyaWFibGUgaXMgcmVxdWlyZWQgZm9yIHRlc3RpbmcnKTtcbiAgfVxuICByZXR1cm4gand0LnNpZ24oeyB1c2VySWQ6IHVzZXJJZC50b1N0cmluZygpLCBlbWFpbCB9LCBzZWNyZXQsIHsgZXhwaXJlc0luOiAnMjRoJyB9KTtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==