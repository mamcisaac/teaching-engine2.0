9eaddc9809db77ab47dfec74048318b0
import logger from '../logger';
// Store for request counts
const requestCounts = new Map();
// Cleanup old entries periodically
setInterval(() => {
    const now = Date.now();
    for (const [key, value] of requestCounts.entries()) {
        if (value.resetTime < now) {
            requestCounts.delete(key);
        }
    }
}, 60000); // Clean up every minute
export function createRateLimiter(options) {
    const { windowMs, max, keyGenerator = (req) => {
        // Default key: IP + user ID if authenticated
        const ip = req.ip || req.connection.remoteAddress || 'unknown';
        const userId = req.user?.userId || 'anonymous';
        return `${ip}-${userId}`;
    }, message = 'Too many requests, please try again later.', skipSuccessfulRequests = false, skipFailedRequests = false, } = options;
    return (req, res, next) => {
        const key = keyGenerator(req);
        const now = Date.now();
        // Get or create entry
        let entry = requestCounts.get(key);
        if (!entry || entry.resetTime < now) {
            entry = { count: 0, resetTime: now + windowMs };
            requestCounts.set(key, entry);
        }
        // Check if limit exceeded
        if (entry.count >= max) {
            const retryAfter = Math.ceil((entry.resetTime - now) / 1000);
            logger.warn({
                key,
                endpoint: req.path,
                method: req.method,
                count: entry.count,
                max,
            }, 'Rate limit exceeded');
            res.setHeader('Retry-After', retryAfter.toString());
            res.setHeader('X-RateLimit-Limit', max.toString());
            res.setHeader('X-RateLimit-Remaining', '0');
            res.setHeader('X-RateLimit-Reset', new Date(entry.resetTime).toISOString());
            return res.status(429).json({
                error: message,
                retryAfter,
            });
        }
        // Increment counter
        entry.count++;
        // Set headers
        res.setHeader('X-RateLimit-Limit', max.toString());
        res.setHeader('X-RateLimit-Remaining', Math.max(0, max - entry.count).toString());
        res.setHeader('X-RateLimit-Reset', new Date(entry.resetTime).toISOString());
        // Handle response to optionally skip counting
        if (skipSuccessfulRequests || skipFailedRequests) {
            const originalSend = res.send;
            res.send = function (data) {
                const shouldSkip = (skipSuccessfulRequests && res.statusCode < 400) ||
                    (skipFailedRequests && res.statusCode >= 400);
                if (shouldSkip && entry) {
                    entry.count = Math.max(0, entry.count - 1);
                }
                return originalSend.call(this, data);
            };
        }
        next();
    };
}
// Function to clear rate limit for a specific key (useful for development/testing)
export function clearRateLimit(key) {
    requestCounts.delete(key);
}
// Function to clear all rate limits (useful for testing)
export function clearAllRateLimits() {
    requestCounts.clear();
}
// Pre-configured rate limiters for different use cases
export const rateLimiters = {
    // Strict limit for authentication endpoints (relaxed in test mode)
    auth: createRateLimiter({
        windowMs: 15 * 60 * 1000, // 15 minutes
        max: process.env.NODE_ENV === 'test' || process.env.NODE_ENV === 'development' ? 100 : 5, // Allow more requests in test/dev mode
        message: 'Too many authentication attempts. Please try again later.',
        skipSuccessfulRequests: true, // Only count failed attempts
    }),
    // Standard API rate limit
    api: createRateLimiter({
        windowMs: 15 * 60 * 1000, // 15 minutes
        max: 100, // 100 requests per window
    }),
    // Relaxed limit for read operations
    read: createRateLimiter({
        windowMs: 15 * 60 * 1000, // 15 minutes
        max: 200, // 200 requests per window
    }),
    // Strict limit for write operations
    write: createRateLimiter({
        windowMs: 15 * 60 * 1000, // 15 minutes
        max: 50, // 50 requests per window
    }),
    // Very strict limit for AI operations
    ai: createRateLimiter({
        windowMs: 60 * 60 * 1000, // 1 hour
        max: 20, // 20 requests per hour
        message: 'AI generation limit exceeded. Please try again later.',
    }),
    // File upload limit
    upload: createRateLimiter({
        windowMs: 60 * 60 * 1000, // 1 hour
        max: 10, // 10 uploads per hour
        message: 'File upload limit exceeded. Please try again later.',
    }),
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9taWRkbGV3YXJlL3JhdGVMaW1pdGVyLnRzIiwibWFwcGluZ3MiOiJBQUNBLE9BQU8sTUFBTSxNQUFNLFdBQVcsQ0FBQztBQVcvQiwyQkFBMkI7QUFDM0IsTUFBTSxhQUFhLEdBQUcsSUFBSSxHQUFHLEVBQWdELENBQUM7QUFFOUUsbUNBQW1DO0FBQ25DLFdBQVcsQ0FBQyxHQUFHLEVBQUU7SUFDZixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDdkIsS0FBSyxNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxJQUFJLGFBQWEsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDO1FBQ25ELElBQUksS0FBSyxDQUFDLFNBQVMsR0FBRyxHQUFHLEVBQUUsQ0FBQztZQUMxQixhQUFhLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzVCLENBQUM7SUFDSCxDQUFDO0FBQ0gsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsd0JBQXdCO0FBRW5DLE1BQU0sVUFBVSxpQkFBaUIsQ0FBQyxPQUF5QjtJQUN6RCxNQUFNLEVBQ0osUUFBUSxFQUNSLEdBQUcsRUFDSCxZQUFZLEdBQUcsQ0FBQyxHQUFHLEVBQUUsRUFBRTtRQUNyQiw2Q0FBNkM7UUFDN0MsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDLEVBQUUsSUFBSSxHQUFHLENBQUMsVUFBVSxDQUFDLGFBQWEsSUFBSSxTQUFTLENBQUM7UUFDL0QsTUFBTSxNQUFNLEdBQUksR0FBZ0QsQ0FBQyxJQUFJLEVBQUUsTUFBTSxJQUFJLFdBQVcsQ0FBQztRQUM3RixPQUFPLEdBQUcsRUFBRSxJQUFJLE1BQU0sRUFBRSxDQUFDO0lBQzNCLENBQUMsRUFDRCxPQUFPLEdBQUcsNENBQTRDLEVBQ3RELHNCQUFzQixHQUFHLEtBQUssRUFDOUIsa0JBQWtCLEdBQUcsS0FBSyxHQUMzQixHQUFHLE9BQU8sQ0FBQztJ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LFFBQVEsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksRUFBRSxhQUFhO1FBQ3ZDLEdBQUcsRUFBRSxHQUFHLEVBQUUsMEJBQTBCO0tBQ3JDLENBQUM7SUFFRixvQ0FBb0M7SUFDcEMsS0FBSyxFQUFFLGlCQUFpQixDQUFDO1FBQ3ZCLFFBQVEsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksRUFBRSxhQUFhO1FBQ3ZDLEdBQUcsRUFBRSxFQUFFLEVBQUUseUJBQXlCO0tBQ25DLENBQUM7SUFFRixzQ0FBc0M7SUFDdEMsRUFBRSxFQUFFLGlCQUFpQixDQUFDO1FBQ3BCLFFBQVEsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksRUFBRSxTQUFTO1FBQ25DLEdBQUcsRUFBRSxFQUFFLEVBQUUsdUJBQXVCO1FBQ2hDLE9BQU8sRUFBRSx1REFBdUQ7S0FDakUsQ0FBQztJQUVGLG9CQUFvQjtJQUNwQixNQUFNLEVBQUUsaUJBQWlCLENBQUM7UUFDeEIsUUFBUSxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxFQUFFLFNBQVM7UUFDbkMsR0FBRyxFQUFFLEVBQUUsRUFBRSxzQkFBc0I7UUFDL0IsT0FBTyxFQUFFLHFEQUFxRDtLQUMvRCxDQUFDO0NBQ0gsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWljaGFlbG1jaXNhYWMvR2l0SHViL3RlYWNoaW5nLWVuZ2luZTIuMC9zZXJ2ZXIvc3JjL21pZGRsZXdhcmUvcmF0ZUxpbWl0ZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuLi9sb2dnZXInO1xuXG5pbnRlcmZhY2UgUmF0ZUxpbWl0T3B0aW9ucyB7XG4gIHdpbmRvd01zOiBudW1iZXI7IC8vIFRpbWUgd2luZG93IGluIG1pbGxpc2Vjb25kc1xuICBtYXg6IG51bWJlcjsgLy8gTWF4IHJlcXVlc3RzIHBlciB3aW5kb3dcbiAga2V5R2VuZXJhdG9yPzogKHJlcTogUmVxdWVzdCkgPT4gc3RyaW5nOyAvLyBDdXN0b20ga2V5IGdlbmVyYXRvclxuICBtZXNzYWdlPzogc3RyaW5nOyAvLyBFcnJvciBtZXNzYWdlXG4gIHNraXBTdWNjZXNzZnVsUmVxdWVzdHM/OiBib29sZWFuOyAvLyBEb24ndCBjb3VudCBzdWNjZXNzZnVsIHJlcXVlc3RzXG4gIHNraXBGYWlsZWRSZXF1ZXN0cz86IGJvb2xlYW47IC8vIERvbid0IGNvdW50IGZhaWxlZCByZXF1ZXN0c1xufVxuXG4vLyBTdG9yZSBmb3IgcmVxdWVzdCBjb3VudHNcbmNvbnN0IHJlcXVlc3RDb3VudHMgPSBuZXcgTWFwPHN0cmluZywgeyBjb3VudDogbnVtYmVyOyByZXNldFRpbWU6IG51bWJlciB9PigpO1xuXG4vLyBDbGVhbnVwIG9sZCBlbnRyaWVzIHBlcmlvZGljYWxseVxuc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiByZXF1ZXN0Q291bnRzLmVudHJpZXMoKSkge1xuICAgIGlmICh2YWx1ZS5yZXNldFRpbWUgPCBub3cpIHtcbiAgICAgIHJlcXVlc3RDb3VudHMuZGVsZXRlKGtleSk7XG4gICAgfVxuICB9XG59LCA2MDAwMCk7IC8vIENsZWFuIHVwIGV2ZXJ5IG1pbnV0ZVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlUmF0ZUxpbWl0ZXIob3B0aW9uczogUmF0ZUxpbWl0T3B0aW9ucykge1xuICBjb25zdCB7XG4gICAgd2luZG93TXMsXG4gICAgbWF4LFxuICAgIGtleUdlbmVyYXRvciA9IChyZXEpID0+IHtcbiAgICAgIC8vIERlZmF1bHQga2V5OiBJUCArIHVzZXIgSUQgaWYgYXV0aGVudGljYXRlZFxuICAgICAgY29uc3QgaXAgPSByZXEuaXAgfHwgcmVxLmNvbm5lY3Rpb24ucmVtb3RlQWRkcmVzcyB8fCAndW5rbm93bic7XG4gICAgICBjb25zdCB1c2VySWQgPSAocmVxIGFzIFJlcXVlc3QgJiB7IHVzZXI/OiB7IHVzZXJJZD86IHN0cmluZyB9IH0pLnVzZXI/LnVzZXJJZCB8fCAnYW5vbnltb3VzJztcbiAgICAgIHJldHVybiBgJHtpcH0tJHt1c2VySWR9YDtcbiAgICB9LFxuICAgIG1lc3NhZ2UgPSAnVG9vIG1hbnkgcmVxdWVzdHMsIHBsZWFzZSB0cnkgYWdhaW4gbGF0ZXIuJyxcbiAgICBza2lwU3VjY2Vzc2Z1bFJlcXVlc3RzID0gZmFsc2UsXG4gICAgc2tpcEZhaWxlZFJlcXVlc3RzID0gZmFsc2UsXG4gIH0gPSBvcHRpb25zO1xuXG4gIHJldHVybiAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgICBjb25zdCBrZXkgPSBrZXlHZW5lcmF0b3IocmVxKTtcbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuXG4gICAgLy8gR2V0IG9yIGNyZWF0ZSBlbnRyeVxuICAgIGxldCBlbnRyeSA9IHJlcXVlc3RDb3VudHMuZ2V0KGtleSk7XG4gICAgaWYgKCFlbnRyeSB8fCBlbnRyeS5yZXNldFRpbWUgPCBub3cpIHtcbiAgICAgIGVudHJ5ID0geyBjb3VudDogMCwgcmVzZXRUaW1lOiBub3cgKyB3aW5kb3dNcyB9O1xuICAgICAgcmVxdWVzdENvdW50cy5zZXQoa2V5LCBlbnRyeSk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgbGltaXQgZXhjZWVkZWRcbiAgICBpZiAoZW50cnkuY291bnQgPj0gbWF4KSB7XG4gICAgICBjb25zdCByZXRyeUFmdGVyID0gTWF0aC5jZWlsKChlbnRyeS5yZXNldFRpbWUgLSBub3cpIC8gMTAwMCk7XG5cbiAgICAgIGxvZ2dlci53YXJuKFxuICAgICAgICB7XG4gICAgICAgICAga2V5LFxuICAgICAgICAgIGVuZHBvaW50OiByZXEucGF0aCxcbiAgICAgICAgICBtZXRob2Q6IHJlcS5tZXRob2QsXG4gICAgICAgICAgY291bnQ6IGVudHJ5LmNvdW50LFxuICAgICAgICAgIG1heCxcbiAgICAgICAgfSxcbiAgICAgICAgJ1JhdGUgbGltaXQgZXhjZWVkZWQnLFxuICAgICAgKTtcblxuICAgICAgcmVzLnNldEhlYWRlcignUmV0cnktQWZ0ZXInLCByZXRyeUFmdGVyLnRvU3RyaW5nKCkpO1xuICAgICAgcmVzLnNldEhlYWRlcignWC1SYXRlTGltaXQtTGltaXQnLCBtYXgudG9TdHJpbmcoKSk7XG4gICAgICByZXMuc2V0SGVhZGVyKCdYLVJhdGVMaW1pdC1SZW1haW5pbmcnLCAnMCcpO1xuICAgICAgcmVzLnNldEhlYWRlcignWC1SYXRlTGltaXQtUmVzZXQnLCBuZXcgRGF0ZShlbnRyeS5yZXNldFRpbWUpLnRvSVNPU3RyaW5nKCkpO1xuXG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MjkpLmpzb24oe1xuICAgICAgICBlcnJvcjogbWVzc2FnZSxcbiAgICAgICAgcmV0cnlBZnRlcixcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIEluY3JlbWVudCBjb3VudGVyXG4gICAgZW50cnkuY291bnQrKztcblxuICAgIC8vIFNldCBoZWFkZXJzXG4gICAgcmVzLnNldEhlYWRlcignWC1SYXRlTGltaXQtTGltaXQnLCBtYXgudG9TdHJpbmcoKSk7XG4gICAgcmVzLnNldEhlYWRlcignWC1SYXRlTGltaXQtUmVtYWluaW5nJywgTWF0aC5tYXgoMCwgbWF4IC0gZW50cnkuY291bnQpLnRvU3RyaW5nKCkpO1xuICAgIHJlcy5zZXRIZWFkZXIoJ1gtUmF0ZUxpbWl0LVJlc2V0JywgbmV3IERhdGUoZW50cnkucmVzZXRUaW1lKS50b0lTT1N0cmluZygpKTtcblxuICAgIC8vIEhhbmRsZSByZXNwb25zZSB0byBvcHRpb25hbGx5IHNraXAgY291bnRpbmdcbiAgICBpZiAoc2tpcFN1Y2Nlc3NmdWxSZXF1ZXN0cyB8fCBza2lwRmFpbGVkUmVxdWVzdHMpIHtcbiAgICAgIGNvbnN0IG9yaWdpbmFsU2VuZCA9IHJlcy5zZW5kO1xuICAgICAgcmVzLnNlbmQgPSBmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICBjb25zdCBzaG91bGRTa2lwID1cbiAgICAgICAgICAoc2tpcFN1Y2Nlc3NmdWxSZXF1ZXN0cyAmJiByZXMuc3RhdHVzQ29kZSA8IDQwMCkgfHxcbiAgICAgICAgICAoc2tpcEZhaWxlZFJlcXVlc3RzICYmIHJlcy5zdGF0dXNDb2RlID49IDQwMCk7XG5cbiAgICAgICAgaWYgKHNob3VsZFNraXAgJiYgZW50cnkpIHtcbiAgICAgICAgICBlbnRyeS5jb3VudCA9IE1hdGgubWF4KDAsIGVudHJ5LmNvdW50IC0gMSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gb3JpZ2luYWxTZW5kLmNhbGwodGhpcywgZGF0YSk7XG4gICAgICB9O1xuICAgIH1cblxuICAgIG5leHQoKTtcbiAgfTtcbn1cblxuLy8gRnVuY3Rpb24gdG8gY2xlYXIgcmF0ZSBsaW1pdCBmb3IgYSBzcGVjaWZpYyBrZXkgKHVzZWZ1bCBmb3IgZGV2ZWxvcG1lbnQvdGVzdGluZylcbmV4cG9ydCBmdW5jdGlvbiBjbGVhclJhdGVMaW1pdChrZXk6IHN0cmluZykge1xuICByZXF1ZXN0Q291bnRzLmRlbGV0ZShrZXkpO1xufVxuXG4vLyBGdW5jdGlvbiB0byBjbGVhciBhbGwgcmF0ZSBsaW1pdHMgKHVzZWZ1bCBmb3IgdGVzdGluZylcbmV4cG9ydCBmdW5jdGlvbiBjbGVhckFsbFJhdGVMaW1pdHMoKSB7XG4gIHJlcXVlc3RDb3VudHMuY2xlYXIoKTtcbn1cblxuLy8gUHJlLWNvbmZpZ3VyZWQgcmF0ZSBsaW1pdGVycyBmb3IgZGlmZmVyZW50IHVzZSBjYXNlc1xuZXhwb3J0IGNvbnN0IHJhdGVMaW1pdGVycyA9IHtcbiAgLy8gU3RyaWN0IGxpbWl0IGZvciBhdXRoZW50aWNhdGlvbiBlbmRwb2ludHMgKHJlbGF4ZWQgaW4gdGVzdCBtb2RlKVxuICBhdXRoOiBjcmVhdGVSYXRlTGltaXRlcih7XG4gICAgd2luZG93TXM6IDE1ICogNjAgKiAxMDAwLCAvLyAxNSBtaW51dGVzXG4gICAgbWF4OiBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Rlc3QnIHx8IHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAnZGV2ZWxvcG1lbnQnID8gMTAwIDogNSwgLy8gQWxsb3cgbW9yZSByZXF1ZXN0cyBpbiB0ZXN0L2RldiBtb2RlXG4gICAgbWVzc2FnZTogJ1RvbyBtYW55IGF1dGhlbnRpY2F0aW9uIGF0dGVtcHRzLiBQbGVhc2UgdHJ5IGFnYWluIGxhdGVyLicsXG4gICAgc2tpcFN1Y2Nlc3NmdWxSZXF1ZXN0czogdHJ1ZSwgLy8gT25seSBjb3VudCBmYWlsZWQgYXR0ZW1wdHNcbiAgfSksXG5cbiAgLy8gU3RhbmRhcmQgQVBJIHJhdGUgbGltaXRcbiAgYXBpOiBjcmVhdGVSYXRlTGltaXRlcih7XG4gICAgd2luZG93TXM6IDE1ICogNjAgKiAxMDAwLCAvLyAxNSBtaW51dGVzXG4gICAgbWF4OiAxMDAsIC8vIDEwMCByZXF1ZXN0cyBwZXIgd2luZG93XG4gIH0pLFxuXG4gIC8vIFJlbGF4ZWQgbGltaXQgZm9yIHJlYWQgb3BlcmF0aW9uc1xuICByZWFkOiBjcmVhdGVSYXRlTGltaXRlcih7XG4gICAgd2luZG93TXM6IDE1ICogNjAgKiAxMDAwLCAvLyAxNSBtaW51dGVzXG4gICAgbWF4OiAyMDAsIC8vIDIwMCByZXF1ZXN0cyBwZXIgd2luZG93XG4gIH0pLFxuXG4gIC8vIFN0cmljdCBsaW1pdCBmb3Igd3JpdGUgb3BlcmF0aW9uc1xuICB3cml0ZTogY3JlYXRlUmF0ZUxpbWl0ZXIoe1xuICAgIHdpbmRvd01zOiAxNSAqIDYwICogMTAwMCwgLy8gMTUgbWludXRlc1xuICAgIG1heDogNTAsIC8vIDUwIHJlcXVlc3RzIHBlciB3aW5kb3dcbiAgfSksXG5cbiAgLy8gVmVyeSBzdHJpY3QgbGltaXQgZm9yIEFJIG9wZXJhdGlvbnNcbiAgYWk6IGNyZWF0ZVJhdGVMaW1pdGVyKHtcbiAgICB3aW5kb3dNczogNjAgKiA2MCAqIDEwMDAsIC8vIDEgaG91clxuICAgIG1heDogMjAsIC8vIDIwIHJlcXVlc3RzIHBlciBob3VyXG4gICAgbWVzc2FnZTogJ0FJIGdlbmVyYXRpb24gbGltaXQgZXhjZWVkZWQuIFBsZWFzZSB0cnkgYWdhaW4gbGF0ZXIuJyxcbiAgfSksXG5cbiAgLy8gRmlsZSB1cGxvYWQgbGltaXRcbiAgdXBsb2FkOiBjcmVhdGVSYXRlTGltaXRlcih7XG4gICAgd2luZG93TXM6IDYwICogNjAgKiAxMDAwLCAvLyAxIGhvdXJcbiAgICBtYXg6IDEwLCAvLyAxMCB1cGxvYWRzIHBlciBob3VyXG4gICAgbWVzc2FnZTogJ0ZpbGUgdXBsb2FkIGxpbWl0IGV4Y2VlZGVkLiBQbGVhc2UgdHJ5IGFnYWluIGxhdGVyLicsXG4gIH0pLFxufTtcbiJdLCJ2ZXJzaW9uIjozfQ==