{"file":"/Users/michaelmcisaac/GitHub/teaching-engine2.0/server/src/index.ts","mappings":"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","names":[],"sources":["/Users/michaelmcisaac/GitHub/teaching-engine2.0/server/src/index.ts"],"sourcesContent":["import express, { Request, Response, NextFunction } from 'express';\nimport cors from 'cors';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\nimport jwt, { JwtPayload } from 'jsonwebtoken';\nimport cookieParser from 'cookie-parser';\nimport bcrypt from 'bcryptjs';\nimport debug from 'debug';\nimport { config } from 'dotenv';\n\n// Load environment variables\nconfig();\n\n// Create debug logger\nconst log = debug('server:main');\nconst error = debug('server:error');\n\n// Get directory name in ES module\nconst __filename_index = fileURLToPath(import.meta.url);\nconst __dirname_index = path.dirname(__filename_index);\n\n// Extend the Express Request type to include the user property\ninterface AuthenticatedRequest extends Request {\n  user?: {\n    userId: string;\n  };\n}\n\n// ETFO-aligned route imports\nimport curriculumImportRoutes from './routes/curriculumImport';\nimport curriculumDiscoveryRoutes from './routes/curriculum-discovery';\nimport discoverySchedulerRoutes from './routes/discovery-scheduler';\nimport studentRoutes from './routes/student';\nimport parentSummaryRoutes from './routes/parentSummary';\nimport newsletterRoutes from './routes/newsletters';\nimport curriculumExpectationRoutes from './routes/curriculum-expectations';\nimport longRangePlanRoutes from './routes/long-range-plans';\nimport unitPlanRoutes from './routes/unit-plans';\nimport etfoLessonPlanRoutes from './routes/etfo-lesson-plans';\nimport daybookEntryRoutes from './routes/daybook-entries';\nimport etfoProgressRoutes from './routes/etfo-progress';\nimport plannerStateRoutes from './routes/planner-state';\nimport workflowStateRoutes from './routes/workflow-state';\nimport aiPlanningRoutes from './routes/ai-planning';\nimport activityDiscoveryRoutes from './routes/activity-discovery';\nimport activityCollectionsRoutes from './routes/activity-collections';\nimport aiActivityGenerationRoutes from './routes/ai-activity-generation';\nimport batchProcessingRoutes from './routes/batch-processing';\nimport templateRoutes from './routes/templates';\nimport calendarEventRoutes from './routes/calendar-events';\nimport recentPlansRoutes from './routes/recent-plans';\nimport batchApiRoutes from './routes/batch';\nimport { authRoutes } from './routes/auth';\nimport {\n  initializeServices,\n  shutdownServices,\n  getServiceHealth,\n} from './services/initializeServices';\nimport logger from './logger';\nimport { prisma } from './prisma';\nimport { rateLimiters } from './middleware/rateLimiter';\nimport { errorHandler, notFoundHandler } from './middleware/errorHandler';\nimport { sanitizeInput } from './middleware/inputSanitization';\nimport performanceMonitoring, { performanceMonitor } from './middleware/performanceMonitoring';\n\n// Initialize Express app\nlog('Initializing Express application...');\nconst app = express();\n\n// Security middleware\nlog('Configuring security headers...');\napp.use((req, res, next) => {\n  // Content Security Policy\n  res.setHeader(\n    'Content-Security-Policy',\n    [\n      \"default-src 'self'\",\n      \"script-src 'self' 'unsafe-inline' 'unsafe-eval'\", // Allow inline scripts for dev\n      \"style-src 'self' 'unsafe-inline'\", // Allow inline styles for CSS-in-JS\n      \"img-src 'self' data: https:\",\n      \"font-src 'self' data:\",\n      \"connect-src 'self'\",\n      \"frame-src 'none'\",\n      \"object-src 'none'\",\n      \"base-uri 'self'\",\n      \"form-action 'self'\",\n      'upgrade-insecure-requests',\n    ].join('; '),\n  );\n\n  // Additional security headers\n  res.setHeader('X-Content-Type-Options', 'nosniff');\n  res.setHeader('X-Frame-Options', 'DENY');\n  res.setHeader('X-XSS-Protection', '1; mode=block');\n  res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');\n  res.setHeader('Permissions-Policy', 'geolocation=(), microphone=(), camera=()');\n\n  next();\n});\n\n// Configure CORS with credentials support\nlog('Configuring CORS...');\n// CORS options\nconst corsOptions: cors.CorsOptions = {\n  origin: (origin, callback) => {\n    // In production, replace with your actual domain\n    const allowedOrigins = process.env.ALLOWED_ORIGINS?.split(',') || [\n      'http://localhost:5173',\n      'http://localhost:3000',\n      'http://127.0.0.1:5173',\n      'http://127.0.0.1:3000',\n    ];\n\n    if (!origin || allowedOrigins.includes(origin)) {\n      callback(null, true);\n    } else {\n      callback(new Error('Not allowed by CORS'));\n    }\n  },\n  credentials: true,\n  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],\n  allowedHeaders: ['Content-Type', 'Authorization'],\n  exposedHeaders: ['Content-Range', 'X-Total-Count'],\n};\n\n// Handle preflight requests\nlog('Configuring CORS preflight...');\napp.options('*', cors(corsOptions));\n\n// Apply CORS to all routes\nlog('Applying CORS and JSON middleware...');\napp.use(cors(corsOptions));\napp.use(express.json({ limit: '10mb' })); // Set reasonable payload limit\napp.use(cookieParser());\n\n// Apply input sanitization middleware\nlog('Applying input sanitization...');\napp.use(sanitizeInput);\n\n// Apply performance monitoring\nlog('Applying performance monitoring...');\napp.use(performanceMonitoring);\n\n// Health check endpoints\napp.get('/health', (_req, res) => {\n  res.status(200).json({ status: 'ok' });\n});\n\napp.get('/api/health', (_req, res) => {\n  const healthStatus = performanceMonitor.getHealthStatus();\n  res.status(healthStatus.healthy ? 200 : 503).json({\n    status: healthStatus.healthy ? 'ok' : 'degraded',\n    ...healthStatus,\n  });\n});\n\n// Performance metrics endpoint (admin only)\napp.get('/api/metrics', (req, res) => {\n  // Simple admin token check\n  const token = req.headers.authorization?.replace('Bearer ', '');\n  if (token !== process.env.WIZARD_TOKEN) {\n    return res.status(403).json({ error: 'Admin access required' });\n  }\n\n  const summary = performanceMonitor.getPerformanceSummary();\n  const slowestEndpoints = performanceMonitor.getSlowestEndpoints();\n\n  res.json({\n    summary,\n    slowestEndpoints,\n    timestamp: new Date().toISOString(),\n  });\n});\n\n// Middleware to verify JWT token with enhanced security\nconst authenticateToken = (req: AuthenticatedRequest, res: Response, next: NextFunction) => {\n  // First try to get token from httpOnly cookie\n  let token = req.cookies?.authToken;\n\n  // Fallback to Authorization header for backward compatibility\n  if (!token) {\n    const authHeader = req.headers['authorization'];\n    if (authHeader && authHeader.startsWith('Bearer ')) {\n      token = authHeader.split(' ')[1];\n    }\n  }\n\n  if (!token) {\n    return res.status(401).json({ error: 'Authentication required' });\n  }\n  if (!token || token.length > 1000) {\n    // Prevent extremely long tokens\n    return res.status(401).json({ error: 'Invalid token format' });\n  }\n\n  try {\n    const secret = process.env.JWT_SECRET;\n    if (!secret) {\n      logger.error('CRITICAL: JWT_SECRET environment variable not configured');\n      return res.status(500).json({ error: 'Server configuration error' });\n    }\n    const decoded = jwt.verify(token, secret, {\n      algorithms: ['HS256'], // Explicitly specify allowed algorithms\n      maxAge: '7d', // Maximum token age\n    }) as JwtPayload;\n\n    if (!decoded?.userId || !decoded?.email || !decoded?.iat) {\n      return res.status(403).json({ error: 'Invalid token payload' });\n    }\n\n    // Check token age (extra protection)\n    const now = Math.floor(Date.now() / 1000);\n    const maxAge = 7 * 24 * 60 * 60; // 7 days in seconds\n    if (now - decoded.iat > maxAge) {\n      return res.status(403).json({ error: 'Token expired' });\n    }\n\n    req.user = { userId: String(decoded.userId) };\n    next();\n  } catch (err) {\n    if (err instanceof jwt.TokenExpiredError) {\n      return res.status(403).json({ error: 'Token expired' });\n    } else if (err instanceof jwt.JsonWebTokenError) {\n      return res.status(403).json({ error: 'Invalid token' });\n    } else {\n      logger.error('JWT verification error:', err);\n      return res.status(403).json({ error: 'Token verification failed' });\n    }\n  }\n};\n\n// Login rate limiting is now handled by the rateLimiters.auth middleware\n\n// Login endpoint with enhanced rate limiting\napp.post('/api/login', rateLimiters.auth, async (req, res) => {\n  try {\n    const { email, password: passwordInput } = req.body as { email: string; password: string };\n    // Input validation and sanitization\n    if (\n      !email ||\n      !passwordInput ||\n      typeof email !== 'string' ||\n      typeof passwordInput !== 'string'\n    ) {\n      return res.status(400).json({ error: 'Email and password are required' });\n    }\n\n    const sanitizedEmail = email.trim().toLowerCase().slice(0, 255);\n    if (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(sanitizedEmail)) {\n      return res.status(400).json({ error: 'Invalid email format' });\n    }\n\n    // Rate limiting is handled by middleware\n\n    const user = await prisma.user.findUnique({\n      where: { email: sanitizedEmail },\n      select: { id: true, email: true, name: true, role: true, password: true },\n    });\n\n    if (!user) {\n      return res.status(401).json({ error: 'Invalid credentials' });\n    }\n\n    // Compare the provided password with the hashed password in the database\n    const isPasswordValid = await bcrypt.compare(passwordInput, user.password);\n\n    if (!isPasswordValid) {\n      return res.status(401).json({ error: 'Invalid credentials' });\n    }\n\n    const secret = process.env.JWT_SECRET;\n    if (!secret) {\n      logger.error('CRITICAL: JWT_SECRET environment variable not configured');\n      return res.status(500).json({ error: 'Server configuration error' });\n    }\n\n    const token = jwt.sign(\n      {\n        userId: user.id.toString(),\n        email: user.email,\n        iat: Math.floor(Date.now() / 1000),\n      },\n      secret,\n      {\n        expiresIn: process.env.JWT_EXPIRES_IN || '7d',\n        algorithm: 'HS256',\n      } as jwt.SignOptions,\n    );\n\n    // Return user data without password\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    const { password, ...userData } = user;\n\n    // Set JWT in httpOnly cookie for security\n    const isProduction = process.env.NODE_ENV === 'production';\n    const cookieOptions = {\n      httpOnly: true,\n      secure: isProduction, // Use secure flag in production\n      sameSite: 'strict' as const,\n      maxAge: 7 * 24 * 60 * 60 * 1000, // 7 days\n      path: '/',\n    };\n\n    res.cookie('authToken', token, cookieOptions);\n\n    const response = {\n      user: userData,\n      token: token, // Include token in response for E2E tests\n    };\n\n    res.json(response);\n  } catch (error) {\n    logger.error('Login error:', error);\n    res.status(500).json({ error: 'Internal server error' });\n  }\n});\n\n// Auth check endpoint\napp.get('/api/auth/me', authenticateToken, async (req: AuthenticatedRequest, res: Response) => {\n  try {\n    if (!req.user?.userId) {\n      return res.status(401).json({ error: 'Unauthorized' });\n    }\n    const user = await prisma.user.findUnique({\n      where: { id: Number(req.user.userId) },\n      select: { id: true, email: true, name: true, role: true },\n    });\n    if (!user) return res.status(404).json({ error: 'User not found' });\n    res.json(user);\n  } catch (error) {\n    logger.error('Auth check error:', error);\n    res.status(500).json({ error: 'Internal server error' });\n  }\n});\n\napp.get('/api/auth/check', authenticateToken, (req: AuthenticatedRequest, res: Response) => {\n  res.json({ userId: req.user?.userId });\n});\n\n// Logout endpoint to clear httpOnly cookie\napp.post('/api/logout', (_req, res) => {\n  res.clearCookie('authToken', {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'strict',\n    path: '/',\n  });\n  res.json({ message: 'Logged out successfully' });\n});\n\n// Removed duplicate health endpoint - using the one with performance monitoring above\n\n// Mount test routes (only available in test environment)\nlog(`NODE_ENV is: ${process.env.NODE_ENV}`);\nif (process.env.NODE_ENV === 'test' || process.env.NODE_ENV === 'development') {\n  log('Skipping test routes - disabled in ETFO-aligned implementation');\n} else {\n  log('Skipping test routes - not in test or development mode');\n}\n\n// Mount auth routes (no authentication required)\nlog('Mounting auth routes...');\napp.use('/api', authRoutes(prisma));\n\n// Apply authentication and rate limiting to all API routes\nlog('Mounting ETFO-aligned API routes...');\napp.use('/api/students', authenticateToken, rateLimiters.api, studentRoutes);\napp.use('/api/parent-summary', authenticateToken, rateLimiters.write, parentSummaryRoutes);\napp.use('/api/newsletters', authenticateToken, rateLimiters.write, newsletterRoutes);\napp.use('/api/curriculum-import', authenticateToken, rateLimiters.upload, curriculumImportRoutes);\napp.use(\n  '/api/curriculum-discovery',\n  authenticateToken,\n  rateLimiters.read,\n  curriculumDiscoveryRoutes,\n);\napp.use('/api/discovery-scheduler', authenticateToken, rateLimiters.api, discoverySchedulerRoutes);\n\n// ETFO-aligned Planning Routes\napp.use(\n  '/api/curriculum-expectations',\n  authenticateToken,\n  rateLimiters.read,\n  curriculumExpectationRoutes,\n);\napp.use('/api/long-range-plans', authenticateToken, rateLimiters.write, longRangePlanRoutes);\napp.use('/api/unit-plans', authenticateToken, rateLimiters.write, unitPlanRoutes);\napp.use('/api/etfo-lesson-plans', authenticateToken, rateLimiters.write, etfoLessonPlanRoutes);\napp.use('/api/daybook-entries', authenticateToken, rateLimiters.write, daybookEntryRoutes);\napp.use('/api/etfo', authenticateToken, rateLimiters.read, etfoProgressRoutes);\n\n// State Management Routes\napp.use('/api/planner', authenticateToken, rateLimiters.api, plannerStateRoutes);\napp.use('/api/workflow', authenticateToken, rateLimiters.api, workflowStateRoutes);\napp.use('/api/ai-planning', authenticateToken, rateLimiters.ai, aiPlanningRoutes);\n\n// Template System Routes\napp.use('/api/templates', authenticateToken, rateLimiters.api, templateRoutes);\n\n// Calendar Routes\napp.use('/api/calendar-events', authenticateToken, rateLimiters.api, calendarEventRoutes);\n\n// Recent Plans Routes\napp.use('/api/recent-plans', authenticateToken, rateLimiters.api, recentPlansRoutes);\n\n// AI status endpoint (maps to ai-planning/status for backward compatibility)\napp.get('/api/ai/status', authenticateToken, async (req, res) => {\n  // Forward to ai-planning routes handler\n  req.url = '/status';\n  aiPlanningRoutes(req, res, () => {});\n});\n\n// Planner State Routes\napp.use('/api/planner', authenticateToken, plannerStateRoutes);\n\n// Activity Discovery Routes\napp.use('/api/activities', authenticateToken, rateLimiters.read, activityDiscoveryRoutes);\napp.use(\n  '/api/activity-collections',\n  authenticateToken,\n  rateLimiters.write,\n  activityCollectionsRoutes,\n);\napp.use('/api/ai-activities', authenticateToken, rateLimiters.ai, aiActivityGenerationRoutes);\n\n// Batch Processing Routes\napp.use('/api/batch-processing', authenticateToken, rateLimiters.write, batchProcessingRoutes);\n\n// Batch API Routes (for request batching)\napp.use('/api', authenticateToken, rateLimiters.api, batchApiRoutes);\n\n// Service health check endpoint (no auth required for monitoring)\napp.get('/api/health/services', async (_req, res) => {\n  try {\n    const health = await getServiceHealth();\n    res.status(health.healthy ? 200 : 503).json(health);\n  } catch (error) {\n    res.status(500).json({ error: 'Failed to get service health' });\n  }\n});\n\nlog('All API routes mounted successfully.');\n\n// 404 handler for API routes\napp.use('/api/*', notFoundHandler);\n\nconst clientDist = path.join(__dirname_index, '../../client/dist');\nlog('Configuring URL-encoded and cookie parser middleware...');\napp.use(express.urlencoded({ extended: true }));\napp.use(cookieParser());\nlog('Configuring static file serving for uploads...');\napp.use('/uploads', express.static(path.join(__dirname_index, '../uploads')));\nlog('Configuring static file serving for client distribution...');\napp.use(express.static(clientDist));\nlog('Configuring catch-all route for client-side routing...');\napp.get('*', (_req, res) => {\n  res.sendFile(path.join(clientDist, 'index.html'));\n});\n\n// Global error handler - must be last middleware\napp.use(errorHandler);\n\nconst PORT = process.env.PORT ? parseInt(process.env.PORT, 10) : 3000;\nlog(`Starting server on port ${PORT}...`);\n// Export app before starting the server\nexport { app };\n\n// Only start the server if this file is run directly\n// Also start if running in test mode for E2E tests (unless IS_TEST_SERVER is set)\nconst isDirectRun = import.meta.url === `file://${process.argv[1]}`;\nconst isE2ETest =\n  process.env.NODE_ENV === 'test' && process.env.E2E_TEST === 'true' && !process.env.IS_TEST_SERVER;\n// Check if running in development mode\nconst isDevelopment = process.env.NODE_ENV !== 'production';\n\nif (isDirectRun || isE2ETest || isDevelopment) {\n  console.log('Starting server because:', { isDirectRun, isE2ETest, isDevelopment });\n  // Initialize services before starting the server\n  initializeServices()\n    .then(() => {\n      const server = app.listen(PORT, '0.0.0.0', () => {\n        console.log(`Server is running on port ${PORT}`);\n        console.log('Server address:', server.address());\n        log('Server started successfully');\n\n        // Background jobs disabled - ETFO approach uses manual workflow\n      });\n\n      server.on('error', (err) => {\n        console.error('Server error:', err);\n      });\n    })\n    .catch((err) => {\n      error('Failed to initialize services:', err);\n      process.exit(1);\n    });\n\n  // Graceful shutdown\n  process.on('SIGTERM', async () => {\n    log('SIGTERM received, shutting down gracefully...');\n    await shutdownServices();\n    process.exit(0);\n  });\n\n  process.on('SIGINT', async () => {\n    log('SIGINT received, shutting down gracefully...');\n    await shutdownServices();\n    process.exit(0);\n  });\n}\n// test\n"],"version":3}