4138300da2c78a3c99492ff8e38ec1c2
import PDFDocument from 'pdfkit';
/**
 * Generate a PDF buffer for an emergency substitute plan.
 */
export function generateSubPlanPDF(data, doc) {
    return new Promise((resolve) => {
        const d = doc ?? new PDFDocument();
        const chunks = [];
        if (!doc) {
            d.on('data', (chunk) => chunks.push(chunk));
            d.on('end', () => resolve(Buffer.concat(chunks)));
        }
        d.fontSize(16).text('Emergency Sub Plan', { align: 'center' });
        d.moveDown();
        d.fontSize(12).text('Today', { underline: true });
        data.today.forEach((item) => {
            d.text(`${item.time} - ${item.activity}`);
        });
        d.moveDown();
        d.text('Next 3 Days', { underline: true });
        data.upcoming.forEach((day) => {
            d.text(`${day.date}: ${day.summary}`);
        });
        d.moveDown();
        d.text('Classroom Procedures', { underline: true });
        d.text(data.procedures);
        d.moveDown();
        d.text('Student Notes', { underline: true });
        d.text(data.studentNotes);
        d.moveDown();
        d.text('Emergency Contacts', { underline: true });
        d.text(data.emergencyContacts);
        d.moveDown();
        // Add class routines section if available
        if (data.routines && data.routines.length > 0) {
            d.text('Class Routines', { underline: true });
            // Group routines by category
            const byCategory = {};
            data.routines.forEach((routine) => {
                if (!byCategory[routine.category]) {
                    byCategory[routine.category] = [];
                }
                byCategory[routine.category].push(routine);
            });
            // Print routines by category
            Object.entries(byCategory).forEach(([category, routines]) => {
                d.font('Helvetica-Bold').text(category.charAt(0).toUpperCase() + category.slice(1));
                d.font('Helvetica');
                routines.forEach((routine) => {
                    const timeStr = routine.timeOfDay ? ` (${routine.timeOfDay})` : '';
                    d.text(`• ${routine.title}${timeStr}`, {
                        indent: 20,
                        continued: true,
                    });
                    d.text(` - ${routine.description}`, {
                        indent: 30,
                        continued: false,
                    });
                });
                d.moveDown(0.5);
            });
            d.moveDown();
        }
        // Add student goals section if available
        if (data.goals && data.goals.length > 0) {
            d.text('Current Student Goals', { underline: true });
            data.goals.forEach((goal) => {
                const studentStr = goal.studentName ? `${goal.studentName}: ` : '';
                d.text(`• ${studentStr}${goal.text}`, {
                    indent: 20,
                    continued: false,
                });
            });
            d.moveDown();
        }
        // Add curriculum outcomes section if available
        if (data.curriculumOutcomes && data.curriculumOutcomes.length > 0) {
            d.text('Learning Goals (Curriculum Outcomes)', { underline: true });
            // Group outcomes by subject
            const bySubject = {};
            data.curriculumOutcomes.forEach((outcome) => {
                if (!bySubject[outcome.subject]) {
                    bySubject[outcome.subject] = [];
                }
                bySubject[outcome.subject].push({
                    code: outcome.code,
                    description: outcome.description,
                });
            });
            // Print outcomes by subject
            Object.entries(bySubject).forEach(([subject, outcomes]) => {
                d.font('Helvetica-Bold').text(subject);
                d.font('Helvetica');
                outcomes.forEach((outcome) => {
                    d.text(`• ${outcome.code} – ${outcome.description}`, {
                        indent: 20,
                        continued: false,
                    });
                });
                d.moveDown(0.5);
            });
            d.moveDown();
        }
        // Add fallback plan section if available
        if (data.fallbackPlan) {
            d.text('Emergency Fallback Plan', { underline: true });
            d.text(data.fallbackPlan);
            d.moveDown();
        }
        if (!doc) {
            d.end();
        }
        else {
            resolve();
        }
    });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9zZXJ2aWNlcy9zdWJQbGFuR2VuZXJhdG9yLnRzIiwibWFwcGluZ3MiOiJBQUFBLE9BQU8sV0FBVyxNQUFNLFFBQVEsQ0FBQztBQXdDakM7O0dBRUc7QUFDSCxNQUFNLFVBQVUsa0JBQWtCLENBQ2hDLElBQWtCLEVBQ2xCLEdBQXdCO0lBRXhCLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtRQUM3QixNQUFNLENBQUMsR0FBRyxHQUFHLElBQUksSUFBSSxXQUFXLEVBQUUsQ0FBQztRQUNuQyxNQUFNLE1BQU0sR0FBYSxFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ1QsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxLQUFhLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNwRCxDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDcEQsQ0FBQztRQUVELENBQUMsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLG9CQUFvQixFQUFFLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDL0QsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBRWIsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFDbEQsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUMxQixDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUks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QUMsQ0FBQztZQUNILENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNmLENBQUM7UUFFRCx5Q0FBeUM7UUFDekMsSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDdEIsQ0FBQyxDQUFDLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQ3ZELENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQzFCLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNmLENBQUM7UUFFRCxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDVCxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDVixDQUFDO2FBQU0sQ0FBQztZQUNOLE9BQU8sRUFBRSxDQUFDO1FBQ1osQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWljaGFlbG1jaXNhYWMvR2l0SHViL3RlYWNoaW5nLWVuZ2luZTIuMC9zZXJ2ZXIvc3JjL3NlcnZpY2VzL3N1YlBsYW5HZW5lcmF0b3IudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFBERkRvY3VtZW50IGZyb20gJ3BkZmtpdCc7XG5pbXBvcnQgdHlwZSAqIGFzIFBERktpdCBmcm9tICdwZGZraXQnO1xuXG5leHBvcnQgaW50ZXJmYWNlIERheVNjaGVkdWxlIHtcbiAgdGltZTogc3RyaW5nO1xuICBhY3Rpdml0eTogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFVwY29taW5nT3ZlcnZpZXcge1xuICBkYXRlOiBzdHJpbmc7XG4gIHN1bW1hcnk6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTdWJQbGFuSW5wdXQge1xuICB0b2RheTogRGF5U2NoZWR1bGVbXTtcbiAgdXBjb21pbmc6IFVwY29taW5nT3ZlcnZpZXdbXTtcbiAgcHJvY2VkdXJlczogc3RyaW5nO1xuICBzdHVkZW50Tm90ZXM6IHN0cmluZztcbiAgZW1lcmdlbmN5Q29udGFjdHM6IHN0cmluZztcbiAgY3VycmljdWx1bU91dGNvbWVzPzogQXJyYXk8e1xuICAgIGNvZGU6IHN0cmluZztcbiAgICBkZXNjcmlwdGlvbjogc3RyaW5nO1xuICAgIHN1YmplY3Q6IHN0cmluZztcbiAgfT47XG4gIGdvYWxzPzogQXJyYXk8e1xuICAgIGlkOiBudW1iZXI7XG4gICAgdGV4dDogc3RyaW5nO1xuICAgIHN0YXR1czogc3RyaW5nO1xuICAgIHN0dWRlbnROYW1lPzogc3RyaW5nO1xuICB9PjtcbiAgcm91dGluZXM/OiBBcnJheTx7XG4gICAgaWQ6IG51bWJlcjtcbiAgICB0aXRsZTogc3RyaW5nO1xuICAgIGRlc2NyaXB0aW9uOiBzdHJpbmc7XG4gICAgY2F0ZWdvcnk6IHN0cmluZztcbiAgICB0aW1lT2ZEYXk/OiBzdHJpbmc7XG4gIH0+O1xuICBmYWxsYmFja1BsYW4/OiBzdHJpbmc7XG59XG5cbi8qKlxuICogR2VuZXJhdGUgYSBQREYgYnVmZmVyIGZvciBhbiBlbWVyZ2VuY3kgc3Vic3RpdHV0ZSBwbGFuLlxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2VuZXJhdGVTdWJQbGFuUERGKFxuICBkYXRhOiBTdWJQbGFuSW5wdXQsXG4gIGRvYz86IFBERktpdC5QREZEb2N1bWVudCxcbik6IFByb21pc2U8QnVmZmVyIHwgdm9pZD4ge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICBjb25zdCBkID0gZG9jID8/IG5ldyBQREZEb2N1bWVudCgpO1xuICAgIGNvbnN0IGNodW5rczogQnVmZmVyW10gPSBbXTtcbiAgICBpZiAoIWRvYykge1xuICAgICAgZC5vbignZGF0YScsIChjaHVuazogQnVmZmVyKSA9PiBjaHVua3MucHVzaChjaHVuaykpO1xuICAgICAgZC5vbignZW5kJywgKCkgPT4gcmVzb2x2ZShCdWZmZXIuY29uY2F0KGNodW5rcykpKTtcbiAgICB9XG5cbiAgICBkLmZvbnRTaXplKDE2KS50ZXh0KCdFbWVyZ2VuY3kgU3ViIFBsYW4nLCB7IGFsaWduOiAnY2VudGVyJyB9KTtcbiAgICBkLm1vdmVEb3duKCk7XG5cbiAgICBkLmZvbnRTaXplKDEyKS50ZXh0KCdUb2RheScsIHsgdW5kZXJsaW5lOiB0cnVlIH0pO1xuICAgIGRhdGEudG9kYXkuZm9yRWFjaCgoaXRlbSkgPT4ge1xuICAgICAgZC50ZXh0KGAke2l0ZW0udGltZX0gLSAke2l0ZW0uYWN0aXZpdHl9YCk7XG4gICAgfSk7XG4gICAgZC5tb3ZlRG93bigpO1xuXG4gICAgZC50ZXh0KCdOZXh0IDMgRGF5cycsIHsgdW5kZXJsaW5lOiB0cnVlIH0pO1xuICAgIGRhdGEudXBjb21pbmcuZm9yRWFjaCgoZGF5KSA9PiB7XG4gICAgICBkLnRleHQoYCR7ZGF5LmRhdGV9OiAke2RheS5zdW1tYXJ5fWApO1xuICAgIH0pO1xuICAgIGQubW92ZURvd24oKTtcblxuICAgIGQudGV4dCgnQ2xhc3Nyb29tIFByb2NlZHVyZXMnLCB7IHVuZGVybGluZTogdHJ1ZSB9KTtcbiAgICBkLnRleHQoZGF0YS5wcm9jZWR1cmVzKTtcbiAgICBkLm1vdmVEb3duKCk7XG5cbiAgICBkLnRleHQoJ1N0dWRlbnQgTm90ZXMnLCB7IHVuZGVybGluZTogdHJ1ZSB9KTtcbiAgICBkLnRleHQoZGF0YS5zdHVkZW50Tm90ZXMpO1xuICAgIGQubW92ZURvd24oKTtcblxuICAgIGQudGV4dCgnRW1lcmdlbmN5IENvbnRhY3RzJywgeyB1bmRlcmxpbmU6IHRydWUgfSk7XG4gICAgZC50ZXh0KGRhdGEuZW1lcmdlbmN5Q29udGFjdHMpO1xuICAgIGQubW92ZURvd24oKTtcblxuICAgIC8vIEFkZCBjbGFzcyByb3V0aW5lcyBzZWN0aW9uIGlmIGF2YWlsYWJsZVxuICAgIGlmIChkYXRhLnJvdXRpbmVzICYmIGRhdGEucm91dGluZXMubGVuZ3RoID4gMCkge1xuICAgICAgZC50ZXh0KCdDbGFzcyBSb3V0aW5lcycsIHsgdW5kZXJsaW5lOiB0cnVlIH0pO1xuICAgICAgXG4gICAgICAvLyBHcm91cCByb3V0aW5lcyBieSBjYXRlZ29yeVxuICAgICAgY29uc3QgYnlDYXRlZ29yeTogUmVjb3JkPHN0cmluZywgdHlwZW9mIGRhdGEucm91dGluZXM+ID0ge307XG4gICAgICBkYXRhLnJvdXRpbmVzLmZvckVhY2goKHJvdXRpbmUpID0+IHtcbiAgICAgICAgaWYgKCFieUNhdGVnb3J5W3JvdXRpbmUuY2F0ZWdvcnldKSB7XG4gICAgICAgICAgYnlDYXRlZ29yeVtyb3V0aW5lLmNhdGVnb3J5XSA9IFtdO1xuICAgICAgICB9XG4gICAgICAgIGJ5Q2F0ZWdvcnlbcm91dGluZS5jYXRlZ29yeV0ucHVzaChyb3V0aW5lKTtcbiAgICAgIH0pO1xuXG4gICAgICAvLyBQcmludCByb3V0aW5lcyBieSBjYXRlZ29yeVxuICAgICAgT2JqZWN0LmVudHJpZXMoYnlDYXRlZ29yeSkuZm9yRWFjaCgoW2NhdGVnb3J5LCByb3V0aW5lc10pID0+IHtcbiAgICAgICAgZC5mb250KCdIZWx2ZXRpY2EtQm9sZCcpLnRleHQoY2F0ZWdvcnkuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBjYXRlZ29yeS5zbGljZSgxKSk7XG4gICAgICAgIGQuZm9udCgnSGVsdmV0aWNhJyk7XG5cbiAgICAgICAgcm91dGluZXMuZm9yRWFjaCgocm91dGluZSkgPT4ge1xuICAgICAgICAgIGNvbnN0IHRpbWVTdHIgPSByb3V0aW5lLnRpbWVPZkRheSA/IGAgKCR7cm91dGluZS50aW1lT2ZEYXl9KWAgOiAnJztcbiAgICAgICAgICBkLnRleHQoYOKAoiAke3JvdXRpbmUudGl0bGV9JHt0aW1lU3RyfWAsIHtcbiAgICAgICAgICAgIGluZGVudDogMjAsXG4gICAgICAgICAgICBjb250aW51ZWQ6IHRydWUsXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgZC50ZXh0KGAgLSAke3JvdXRpbmUuZGVzY3JpcHRpb259YCwge1xuICAgICAgICAgICAgaW5kZW50OiAzMCxcbiAgICAgICAgICAgIGNvbnRpbnVlZDogZmFsc2UsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICBkLm1vdmVEb3duKDAuNSk7XG4gICAgICB9KTtcbiAgICAgIGQubW92ZURvd24oKTtcbiAgICB9XG5cbiAgICAvLyBBZGQgc3R1ZGVudCBnb2FscyBzZWN0aW9uIGlmIGF2YWlsYWJsZVxuICAgIGlmIChkYXRhLmdvYWxzICYmIGRhdGEuZ29hbHMubGVuZ3RoID4gMCkge1xuICAgICAgZC50ZXh0KCdDdXJyZW50IFN0dWRlbnQgR29hbHMnLCB7IHVuZGVybGluZTogdHJ1ZSB9KTtcbiAgICAgIGRhdGEuZ29hbHMuZm9yRWFjaCgoZ29hbCkgPT4ge1xuICAgICAgICBjb25zdCBzdHVkZW50U3RyID0gZ29hbC5zdHVkZW50TmFtZSA/IGAke2dvYWwuc3R1ZGVudE5hbWV9OiBgIDogJyc7XG4gICAgICAgIGQudGV4dChg4oCiICR7c3R1ZGVudFN0cn0ke2dvYWwudGV4dH1gLCB7XG4gICAgICAgICAgaW5kZW50OiAyMCxcbiAgICAgICAgICBjb250aW51ZWQ6IGZhbHNlLFxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgICAgZC5tb3ZlRG93bigpO1xuICAgIH1cblxuICAgIC8vIEFkZCBjdXJyaWN1bHVtIG91dGNvbWVzIHNlY3Rpb24gaWYgYXZhaWxhYmxlXG4gICAgaWYgKGRhdGEuY3VycmljdWx1bU91dGNvbWVzICYmIGRhdGEuY3VycmljdWx1bU91dGNvbWVzLmxlbmd0aCA+IDApIHtcbiAgICAgIGQudGV4dCgnTGVhcm5pbmcgR29hbHMgKEN1cnJpY3VsdW0gT3V0Y29tZXMpJywgeyB1bmRlcmxpbmU6IHRydWUgfSk7XG5cbiAgICAgIC8vIEdyb3VwIG91dGNvbWVzIGJ5IHN1YmplY3RcbiAgICAgIGNvbnN0IGJ5U3ViamVjdDogUmVjb3JkPHN0cmluZywgQXJyYXk8eyBjb2RlOiBzdHJpbmc7IGRlc2NyaXB0aW9uOiBzdHJpbmcgfT4+ID0ge307XG4gICAgICBkYXRhLmN1cnJpY3VsdW1PdXRjb21lcy5mb3JFYWNoKChvdXRjb21lKSA9PiB7XG4gICAgICAgIGlmICghYnlTdWJqZWN0W291dGNvbWUuc3ViamVjdF0pIHtcbiAgICAgICAgICBieVN1YmplY3Rbb3V0Y29tZS5zdWJqZWN0XSA9IFtdO1xuICAgICAgICB9XG4gICAgICAgIGJ5U3ViamVjdFtvdXRjb21lLnN1YmplY3RdLnB1c2goe1xuICAgICAgICAgIGNvZGU6IG91dGNvbWUuY29kZSxcbiAgICAgICAgICBkZXNjcmlwdGlvbjogb3V0Y29tZS5kZXNjcmlwdGlvbixcbiAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgICAgLy8gUHJpbnQgb3V0Y29tZXMgYnkgc3ViamVjdFxuICAgICAgT2JqZWN0LmVudHJpZXMoYnlTdWJqZWN0KS5mb3JFYWNoKChbc3ViamVjdCwgb3V0Y29tZXNdKSA9PiB7XG4gICAgICAgIGQuZm9udCgnSGVsdmV0aWNhLUJvbGQnKS50ZXh0KHN1YmplY3QpO1xuICAgICAgICBkLmZvbnQoJ0hlbHZldGljYScpO1xuXG4gICAgICAgIG91dGNvbWVzLmZvckVhY2goKG91dGNvbWUpID0+IHtcbiAgICAgICAgICBkLnRleHQoYOKAoiAke291dGNvbWUuY29kZX0g4oCTICR7b3V0Y29tZS5kZXNjcmlwdGlvbn1gLCB7XG4gICAgICAgICAgICBpbmRlbnQ6IDIwLFxuICAgICAgICAgICAgY29udGludWVkOiBmYWxzZSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIGQubW92ZURvd24oMC41KTtcbiAgICAgIH0pO1xuICAgICAgZC5tb3ZlRG93bigpO1xuICAgIH1cblxuICAgIC8vIEFkZCBmYWxsYmFjayBwbGFuIHNlY3Rpb24gaWYgYXZhaWxhYmxlXG4gICAgaWYgKGRhdGEuZmFsbGJhY2tQbGFuKSB7XG4gICAgICBkLnRleHQoJ0VtZXJnZW5jeSBGYWxsYmFjayBQbGFuJywgeyB1bmRlcmxpbmU6IHRydWUgfSk7XG4gICAgICBkLnRleHQoZGF0YS5mYWxsYmFja1BsYW4pO1xuICAgICAgZC5tb3ZlRG93bigpO1xuICAgIH1cblxuICAgIGlmICghZG9jKSB7XG4gICAgICBkLmVuZCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXNvbHZlKCk7XG4gICAgfVxuICB9KTtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==