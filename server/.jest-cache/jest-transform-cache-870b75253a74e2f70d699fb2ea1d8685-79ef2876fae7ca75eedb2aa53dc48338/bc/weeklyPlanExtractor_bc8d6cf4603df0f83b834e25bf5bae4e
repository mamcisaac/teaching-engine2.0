c17502f7183eb827685bd66143839ed2
import { prisma } from '../prisma';
import { buildSubPlanData } from './subPlanService';
/**
 * Extract a comprehensive weekly substitute plan with cross-day continuity
 */
export async function extractWeeklyPlan(startDate, numDays = 5, options = {}) {
    const { userId = 1 } = options;
    // Generate data for each day
    const days = [];
    const startDateObj = new Date(startDate);
    for (let i = 0; i < numDays; i++) {
        const currentDate = new Date(startDateObj);
        currentDate.setUTCDate(startDateObj.getUTCDate() + i);
        const dateStr = currentDate.toISOString().split('T')[0];
        const dayData = await buildSubPlanData(dateStr, options);
        days.push(dayData);
    }
    // Calculate end date
    const endDateObj = new Date(startDateObj);
    endDateObj.setUTCDate(startDateObj.getUTCDate() + numDays - 1);
    const endDate = endDateObj.toISOString().split('T')[0];
    // Extract weekly overview data
    const weeklyOverview = await extractWeeklyOverview(startDate, endDate, userId);
    // Generate continuity notes
    const continuityNotes = generateContinuityNotes(days);
    // Create emergency backup plans
    const emergencyBackupPlans = await generateEmergencyBackupPlans();
    return {
        startDate,
        endDate,
        days,
        weeklyOverview,
        continuityNotes,
        emergencyBackupPlans,
    };
}
/**
 * Extract weekly overview with subjects, milestones, and assessments
 */
async function extractWeeklyOverview(startDate, endDate, userId) {
    const weekStart = new Date(startDate);
    weekStart.setUTCHours(0, 0, 0, 0);
    const weekEnd = new Date(endDate);
    weekEnd.setUTCHours(23, 59, 59, 999);
    // Get all daily plans for the week
    // DISABLED: Legacy dailyPlan model removed in ETFO migration
    const weeklyPlans = []; // Legacy dailyPlan query disabled
    // Get unit plans for the period using ETFO framework
    const unitPlans = await prisma.unitPlan.findMany({
        where: {
            userId,
            OR: [
                {
                    startDate: {
                        gte: weekStart,
                        lte: weekEnd,
                    },
                },
                {
                    endDate: {
                        gte: weekStart,
                        lte: weekEnd,
                    },
                },
                {
                    AND: [{ startDate: { lte: weekStart } }, { endDate: { gte: weekEnd } }],
                },
            ],
        },
        include: {
            longRangePlan: {
                select: {
                    subject: true,
                    grade: true,
                },
            },
            lessonPlans: {
                include: {
                    daybookEntry: true,
                },
            },
        },
    });
    // Assessment functionality removed
    // const assessments: Array<Record<string, unknown>> = [];
    // Get special events
    const specialEvents = await prisma.calendarEvent.findMany({
        where: {
            start: {
                gte: weekStart,
            },
            end: {
                lte: weekEnd,
            },
        },
    });
    // Process subjects and calculate hours
    const subjectMap = new Map();
    for (const plan of weeklyPlans) {
        for (const item of plan.items) {
            const subject = item.slot?.subject || item.activity?.milestone?.subject;
            if (!subject)
                continue;
            if (!subjectMap.has(subject.name)) {
                subjectMap.set(subject.name, {
                    name: subject.name,
                    totalHours: 0,
                    keyTopics: new Set(),
                    outcomes: new Map(),
                });
            }
            const subjectData = subjectMap.get(subject.name);
            // Add duration (assuming 15-minute slots, could be made configurable)
            subjectData.totalHours += 0.25;
            // Add activity topics
            if (item.activity?.title) {
                subjectData.keyTopics.add(item.activity.title);
            }
            // Add outcomes
            if (item.activity?.outcomes) {
                for (const outcomeRel of item.activity.outcomes) {
                    const outcome = outcomeRel.outcome;
                    subjectData.outcomes.set(outcome.id, {
                        code: outcome.code,
                        description: outcome.description,
                    });
                }
            }
        }
    }
    // Convert to final format
    const subjects = Array.from(subjectMap.values()).map((s) => ({
        name: s.name,
        totalHours: Math.round(s.totalHours * 4) / 4, // Round to nearest quarter hour
        keyTopics: Array.from(s.keyTopics).slice(0, 5), // Limit to top 5
        outcomes: Array.from(s.outcomes.values()),
    }));
    // Process milestones - DISABLED: Legacy milestone model removed in ETFO migration
    // const processedMilestones: any[] = []; // Legacy milestone processing disabled
    // Assessment functionality removed
    const processedAssessments = [];
    // Process special events
    const processedEvents = specialEvents.map((event) => ({
        title: event.title,
        date: event.start.toISOString().split('T')[0],
        time: event.allDay ? undefined : event.start.toISOString().split('T')[1].slice(0, 5),
        impact: determineEventImpact(event.title, event.allDay),
    }));
    return {
        subjects,
        unitPlans, // Changed from milestones to unitPlans (ETFO alignment)
        assessments: processedAssessments,
        specialEvents: processedEvents,
    };
}
/**
 * Generate continuity notes showing how each day builds on the previous
 */
function generateContinuityNotes(days) {
    const notes = [];
    for (let i = 0; i < days.length; i++) {
        const currentDay = days[i];
        const previousDay = i > 0 ? days[i - 1] : undefined;
        const connections = [];
        const preparations = [];
        if (previousDay) {
            // Find subject connections
            const currentSubjects = extractSubjectsFromSchedule(currentDay.schedule);
            const previousSubjects = extractSubjectsFromSchedule(previousDay.schedule);
            const commonSubjects = currentSubjects.filter((s) => previousSubjects.some((ps) => ps.subject === s.subject));
            for (const subject of commonSubjects) {
                const prevActivity = previousSubjects.find((ps) => ps.subject === subject.subject);
                if (prevActivity && subject.activity !== prevActivity.activity) {
                    connections.push(`${subject.subject}: Continue from "${prevActivity.activity}" to "${subject.activity}"`);
                }
            }
            // Check for materials/setup needed
            const currentActivities = currentDay.schedule
                .filter((s) => s.activity)
                .map((s) => s.activity);
            if (currentActivities.some((a) => a.toLowerCase().includes('project'))) {
                preparations.push('Ensure project materials from previous day are available');
            }
            if (currentActivities.some((a) => a.toLowerCase().includes('presentation'))) {
                preparations.push('Set up presentation equipment and student work displays');
            }
        }
        // Add general preparations for the day
        const dayActivities = currentDay.schedule.filter((s) => s.activity);
        if (dayActivities.length > 0) {
            preparations.push('Review daily schedule and prepare transition materials');
        }
        notes.push({
            day: currentDay.date,
            previousDay: previousDay?.date,
            connections,
            preparations,
        });
    }
    return notes;
}
/**
 * Generate emergency backup plans by subject
 */
async function generateEmergencyBackupPlans() {
    const subjects = await prisma.subject.findMany({});
    return subjects.map((subject) => {
        // DISABLED: Legacy milestone/activity models removed in ETFO migration
        const fallbackActivities = [];
        return {
            subject: subject.name,
            activities: fallbackActivities.slice(0, 3).map((a) => a.title),
            materials: generateSubjectMaterials(subject.name),
        };
    });
}
/**
 * Extract subjects from schedule entries
 */
function extractSubjectsFromSchedule(schedule) {
    return schedule
        .filter((entry) => entry.activity && !entry.note)
        .map((entry) => ({
        time: entry.time,
        activity: entry.activity,
        subject: inferSubjectFromActivity(entry.activity),
    }));
}
/**
 * Infer subject from activity name (basic heuristic)
 */
function inferSubjectFromActivity(activity) {
    const lower = activity.toLowerCase();
    if (lower.includes('math') || lower.includes('number') || lower.includes('calculation')) {
        return 'Mathematics';
    }
    if (lower.includes('read') || lower.includes('writing') || lower.includes('language')) {
        return 'Language Arts';
    }
    if (lower.includes('science') || lower.includes('experiment') || lower.includes('nature')) {
        return 'Science';
    }
    if (lower.includes('social') || lower.includes('history') || lower.includes('geography')) {
        return 'Social Studies';
    }
    if (lower.includes('art') || lower.includes('draw') || lower.includes('paint')) {
        return 'Arts';
    }
    if (lower.includes('pe') || lower.includes('physical') || lower.includes('sport')) {
        return 'Physical Education';
    }
    return 'General';
}
/**
 * Determine impact of calendar events on schedule
 */
function determineEventImpact(title, allDay) {
    const lower = title.toLowerCase();
    if (allDay) {
        if (lower.includes('holiday') || lower.includes('break')) {
            return 'No classes - school closed';
        }
        if (lower.includes('pd') || lower.includes('development')) {
            return 'No students - professional development day';
        }
        if (lower.includes('assembly')) {
            return 'Modified schedule for all-school assembly';
        }
    }
    if (lower.includes('fire drill')) {
        return 'Brief interruption - practice emergency procedures';
    }
    if (lower.includes('photo')) {
        return 'Students may be called out for individual/class photos';
    }
    if (lower.includes('visit') || lower.includes('guest')) {
        return 'Special visitor - may affect regular activities';
    }
    return 'May affect regular schedule - check with office';
}
/**
 * Generate common materials list by subject
 */
function generateSubjectMaterials(subject) {
    const commonMaterials = ['Whiteboard markers', 'Paper and pencils', 'Timer for activities'];
    switch (subject.toLowerCase()) {
        case 'mathematics':
            return [...commonMaterials, 'Calculators', 'Math manipulatives', 'Graph paper'];
        case 'language arts':
            return [...commonMaterials, 'Reading books', 'Writing journals', 'Dictionary'];
        case 'science':
            return [...commonMaterials, 'Science notebooks', 'Safety goggles', 'Basic lab supplies'];
        case 'social studies':
            return [...commonMaterials, 'Maps', 'Timeline materials', 'Research books'];
        case 'arts':
            return [...commonMaterials, 'Art supplies', 'Drawing paper', 'Colored pencils'];
        default:
            return commonMaterials;
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9zZXJ2aWNlcy93ZWVrbHlQbGFuRXh0cmFjdG9yLnRzIiwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDbkMsT0FBTyxFQUErQixnQkFBZ0IsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBMkRqRjs7R0FFRztBQUNILE1BQU0sQ0FBQyxLQUFLLFVBQVUsaUJBQWlCLENBQ3JDLFNBQWlCLEVBQ2pCLFVBQWtCLENBQUMsRUFDbkIsVUFBMEIsRUFBRTtJQUU1QixNQUFNLEVBQUUsTUFBTSxHQUFHLENBQUMsRUFBRSxHQUFHLE9BQU8sQ0FBQztJQUUvQiw2QkFBNkI7SUFDN0IsTUFBTSxJQUFJLEdBQWtCLEVBQUUsQ0FBQztJQUMvQixNQUFNLFlBQVksR0FBRyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUV6QyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsT0FBTyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDakMsTUFBTSxXQUFXLEdBQUcsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDM0MsV0FBVyxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDdEQsTUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLFdBQVcsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUV4RCxNQUFNLE9BQU8sR0FBRyxNQUFNLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztRQUN6RCxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3JCLENBQUM7SUFFRCxxQkFBcUI7SUFDckIsTUFBTSxVQUFVLEdBQUcsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDMUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFFLEdBQUcsT0FBTyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQy9ELE1BQU0sT0FBTyxHQUFHLFVBQVUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFdkQsK0JBQStCO0lBQy9CLE1BQU0sY0FBYyxHQUFHLE1BQU0scUJBQXFCLENBQUMsU0FBUyxFQUFFLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQztJQUUvRSw0QkFBNEI7SUFDNUIsTUFBTSxlQUFlLEdBQUcsdUJBQXVCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFdEQsZ0NBQWdDO0lBQ2hDLE1BQU0sb0JBQW9CLEdBQUcsTUFBTSw0QkFBNEIsRUFBRSxDQUFDO0lBRWxFLE9BQU87UUFDTCxTQUFTO1FBQ1QsT0FBTztRQUNQLElBQUk7UUFDSixjQUFjO1FBQ2QsZUFBZTtRQUNmLG9CQUFvQjtLQUNyQixDQUFDO0FBQ0osQ0FBQztBQUVEOztHQUVHO0FBQ0gsS0FBSyxVQUFVLHFCQUFxQixDQUNsQyxTQUFpQixFQUNqQixPQUFlLEVBQ2YsTUFBYztJQXlDZCxNQUFNLFNBQVMsR0FBRyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN0QyxTQUFTLENBQUMsV0FBVyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ2xDLE1BQU0sT0FBTyxHQUFHLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2xDLE9BQU8sQ0FBQyxXQUFXLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFFckMsbUNBQW1DO0lBQ25DLDZEQUE2RDtJQUM3RCxNQUFNLFdBQVcsR0FlWixFQUFFLENBQUMsQ0FBQyxrQ0FBa0M7SUFFM0MscURBQXFEO0lBQ3JELE1BQU0sU0FBUyxHQUFHLE1BQU0sTUFBTSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUM7UUFDL0MsS0FBSyxFQUFFO1lBQ0wsTUFBTTtZQUNOLEVBQUUsRUFBRTtnQkFDRjtvQkFDRSxTQUFTLEVBQUU7d0JBQ1QsR0FBRyxFQUFFLFNBQVM7d0JBQ2QsR0FBRyxFQUFFLE9BQU87cUJBQ2I7aUJBQ0Y7Z0JBQ0Q7b0JBQ0UsT0FBTyxFQUFFO3dCQUNQLEdBQUcsRUFBRSxTQUFTO3dCQUNkLEdBQUcsRUFBRSxPQUFPO3FCQUNiO2lCQUNGO2dCQUNEO29CQUNFLEdBQUcsRUFBRSxDQUFDLEVBQUUsU0FBUyxFQUFFLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxFQUFFLEVBQUUsRUFBRSxPQUFPLEVBQUUsRUFBRSxHQUFHLEVBQUUsT0FBTyxFQUFFLEVBQUUsQ0FBQztpQkFDeEU7YUFDRjtTQUNGO1FBQ0QsT0FBTyxFQUFFO1lBQ1AsYUFBYSxFQUFFO2dCQUNiLE1BQU0sRUFBRTtvQkFDTixPQUFPLEVBQUUsSUFBSTtvQkFDYixLQUFLLEVBQUUsSUFBSTtpQkFDWjthQUNGO1lBQ0QsV0FBVyxFQUFFO2dCQUNYLE9BQU8sRUFBRTtvQkFDUCxZQUFZLEVBQUUsSUFBSTtpQkFDbkI7YUFDRjtTQUNGO0tBQ0YsQ0FBQyxDQUFDO0lBRUgsbUNBQW1DO0lBQ25DLDBEQUEwRDtJQUUxRCxxQkFBcUI7SUFDckIsTUFBTSxhQUFhLEdBQUcsTUFBTSxNQUFNLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQztRQUN4RCxLQUFLLEVBQUU7WUFDTCxLQUFLLEVBQUU7Z0JBQ0wsR0FBRyxFQUFFLFNBQVM7YUFDZjtZQUNELEdBQUcsRUFBRTtnQkFDSCxHQUFHLEVBQUUsT0FBTzthQUNiO1NBQ0Y7S0FDRixDQUFDLENBQUM7SUFFSCx1Q0FBdUM7SUFDdkMsTUFBTSxVQUFVLEdBQUcsSUFBSSxHQUFHLEVBUXZCLENBQUM7SUFFSixLQUFLLE1BQU0sSUFBSSxJQUFJLFdBQVcsRUFBRSxDQUFDO1FBQy9CLEtBQUssTUFBTSxJQUFJLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQzlCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLEVBQUUsT0FBTyxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLE9BQU8sQ0FBQztZQUN4RSxJQUFJLENBQUMsT0FBTztnQkFBRSxTQUFTO1lBRXZCLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO2dCQUNsQyxVQUFVLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUU7b0JBQzNCLElBQUksRUFBRSxPQUFPLENBQUMsSUFBSTtvQkFDbEIsVUFBVSxFQUFFLENBQUM7b0JBQ2IsU0FBUyxFQUFFLElBQUksR0FBRyxFQUFFO29CQUNwQixRQUFRLEVBQUUsSUFBSSxHQUFHLEVBQUU7aUJBQ3BCLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCxNQUFNLFdBQVcsR0FBRyxVQUFVLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUUsQ0FBQztZQUVsRCxzRUFBc0U7WUFDdEUsV0FBVyxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUM7WUFFL0Isc0JBQXNCO1lBQ3RCLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRSxLQUFLLEVBQUUsQ0FBQztnQkFDekIsV0FBVyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNqRCxDQUFDO1lBRUQsZUFBZTtZQUNmLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUUsQ0FBQztnQkFDNUIsS0FBSyxNQUFNLFVBQVUsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDO29CQUNoRCxNQUFNLE9BQU8sR0FBRyxVQUFVLENBQUMsT0FBTyxDQUFDO29CQUNuQyxXQUFXLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFO3dCQUNuQyxJQUFJLEVBQUUsT0FBTyxDQUFDLElBQUk7d0JBQ2xCLFdBQVcsRUFBRSxPQUFPLENBQUMsV0FBVztxQkFDakMsQ0FBQyxDQUFDO2dCQUNMLENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7SUFFRCwwQkFBMEI7SUFDMUIsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDM0QsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJO1FBQ1osVUFBVSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsZ0NBQWdDO1FBQzlFLFNBQVMsRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLGlCQUFpQjtRQUNqRSxRQUFRLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDO0tBQzFDLENBQUMsQ0FBQyxDQUFDO0lBRUosa0ZBQWtGO0lBQ2xGLGlGQUFpRjtJQUVqRixtQ0FBbUM7SUFDbkMsTUFBTSxvQkFBb0IsR0FLckIsRUFBRSxDQUFDO0lBRVIseUJBQXlCO0lBQ3pCLE1BQU0sZUFBZSxHQUFHLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDcEQsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLO1FBQ2xCLElBQUksRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDN0MsSUFBSSxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDcEYsTUFBTSxFQUFFLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQztLQUN4RCxDQUFDLENBQUMsQ0FBQztJQUVKLE9BQU87UUFDTCxRQUFRO1FBQ1IsU0FBUyxFQUFFLHdEQUF3RDtRQUNuRSxXQUFXLEVBQUUsb0JBQW9CO1FBQ2pDLGFBQWEsRUFBRSxlQUFlO0tBQy9CLENBQUM7QUFDSixDQUFDO0FBRUQ7O0dBRUc7QUFDSCxTQUFTLHVCQUF1QixDQUFDLElBQW1CO0lBTWxELE1BQU0sS0FBSyxHQUFHLEVBQUUsQ0FBQztJQUVqQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3JDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMzQixNQUFNLFdBQVcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFFcEQsTUFBTSxXQUFXLEdBQWEsRUFBRSxDQUFDO1FBQ2pDLE1BQU0sWUFBWSxHQUFhLEVBQUUsQ0FBQztRQUVsQyxJQUFJLFdBQVcsRUFBRSxDQUFDO1lBQ2hCLDJCQUEyQjtZQUMzQixNQUFNLGVBQWUsR0FBRywyQkFBMkIsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDekUsTUFBTSxnQkFBZ0IsR0FBRywyQkFBMkIsQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFM0UsTUFBTSxjQUFjLEdBQUcsZUFBZSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQ2xELGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLE9BQU8sS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQ3hELENBQUM7WUFFRixLQUFLLE1BQU0sT0FBTyxJQUFJLGNBQWMsRUFBRSxDQUFDO2dCQUNyQyxNQUFNLFlBQVksR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEtBQUssT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUNuRixJQUFJLFlBQVksSUFBSSxPQUFPLENBQUMsUUFBUSxLQUFLLFlBQVksQ0FBQyxRQUFRLEVBQUUsQ0FBQztvQkFDL0QsV0FBVyxDQUFDLElBQUksQ0FDZCxHQUFHLE9BQU8sQ0FBQyxPQUFPLG9CQUFvQixZQUFZLENBQUMsUUFBUSxTQUFTLE9BQU8sQ0FBQyxRQUFRLEdBQUcsQ0FDeEYsQ0FBQztnQkFDSixDQUFDO1lBQ0gsQ0FBQztZQUVELG1DQUFtQztZQUNuQyxNQUFNLGlCQUFpQixHQUFHLFVBQVUsQ0FBQyxRQUFRO2lCQUMxQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUM7aUJBQ3pCLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVMsQ0FBQyxDQUFDO1lBRTNCLElBQUksaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztnQkFDdkUsWUFBWSxDQUFDLElBQUksQ0FBQywwREFBMEQsQ0FBQyxDQUFDO1lBQ2hGLENBQUM7WUFFRCxJQUFJLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsQ0FBQyxFQUFFLENBQUM7Z0JBQzVFLFlBQVksQ0FBQyxJQUFJLENBQUMseURBQXlELENBQUMsQ0FBQztZQUMvRSxDQUFDO1FBQ0gsQ0FBQztRQUVELHVDQUF1QztRQUN2QyxNQUFNLGFBQWEsR0FBRyxVQUFVLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3BFLElBQUksYUFBYSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUM3QixZQUFZLENBQUMsSUFBSSxDQUFDLHdEQUF3RCxDQUFDLENBQUM7UUFDOUUsQ0FBQztRQUVELEtBQUssQ0FBQyxJQUFJLENBQUM7WUFDVCxHQUFHLEVBQUUsVUFBVSxDQUFDLElBQUk7WUFDcEIsV0FBVyxFQUFFLFdBQVcsRUFBRSxJQUFJO1lBQzlCLFdBQVc7WUFDWCxZQUFZO1NBQ2IsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELE9BQU8sS0FBSyxDQUFDO0FBQ2YsQ0FBQztBQUVEOztHQUVHO0FBQ0gsS0FBSyxVQUFVLDRCQUE0QjtJQU96QyxNQUFNLFFBQVEsR0FBRyxNQUFNLE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBRW5ELE9BQU8sUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1FBQzlCLHVFQUF1RTtRQUN2RSxNQUFNLGtCQUFrQixHQUE2QixFQUFFLENBQUM7UUFFeEQsT0FBTztZQUNMLE9BQU8sRUFBRSxPQUFPLENBQUMsSUFBSTtZQUNyQixVQUFVLEVBQUUsa0JBQWtCLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7WUFDOUQsU0FBUyxFQUFFLHdCQUF3QixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7U0FDbEQsQ0FBQztJQUNKLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVEOztHQUVHO0FBQ0gsU0FBUywyQkFBMkIsQ0FDbEMsUUFBbUU7SUFFbkUsT0FBTyxRQUFRO1NBQ1osTUFBTSxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsUUFBUSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQztTQUNoRCxHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDZixJQUFJLEVBQUUsS0FBSyxDQUFDLElBQUk7UUFDaEIsUUFBUSxFQUFFLEtBQUssQ0FBQyxRQUFTO1FBQ3pCLE9BQU8sRUFBRSx3QkFBd0IsQ0FBQyxLQUFLLENBQUMsUUFBUyxDQUFDO0tBQ25ELENBQUMsQ0FBQyxDQUFDO0FBQ1IsQ0FBQztBQUVEOztHQUVHO0FBQ0gsU0FBUyx3QkFBd0IsQ0FBQyxRQUFnQjtJQUNoRCxNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsV0FBVyxFQUFFLENBQUM7SUFFckMsSUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDO1FBQ3hGLE9BQU8sYUFBYSxDQUFDO0lBQ3ZCLENBQUM7SUFDRCxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsSUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUM7UUFDdEYsT0FBTyxlQUFlLENBQUM7SUFDekIsQ0FBQztJQUNELElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsSUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztRQUMxRixPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0lBQ0QsSUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDO1FBQ3pGLE9BQU8sZ0JBQWdCLENBQUM7SUFDMUIsQ0FBQztJQUNELElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztRQUMvRSxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBQ0QsSUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1FBQ2xGLE9BQU8sb0JBQW9CLENBQUM7SUFDOUIsQ0FBQztJQUVELE9BQU8sU0FBUyxDQUFDO0FBQ25CLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMsb0JBQW9CLENBQUMsS0FBYSxFQUFFLE1BQWU7SUFDMUQsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBRWxDLElBQUksTUFBTSxFQUFFLENBQUM7UUFDWCxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1lBQ3pELE9BQU8sNEJBQTRCLENBQUM7UUFDdEMsQ0FBQztRQUNELElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUM7WUFDMUQsT0FBTyw0Q0FBNEMsQ0FBQztRQUN0RCxDQUFDO1FBQ0QsSUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUM7WUFDL0IsT0FBTywyQ0FBMkMsQ0FBQztRQUNyRCxDQUFDO0lBQ0gsQ0FBQztJQUVELElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDO1FBQ2pDLE9BQU8sb0RBQW9ELENBQUM7SUFDOUQsQ0FBQztJQUNELElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1FBQzVCLE9BQU8sd0RBQXdELENBQUM7SUFDbEUsQ0FBQztJQUNELElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7UUFDdkQsT0FBTyxpREFBaUQsQ0FBQztJQUMzRCxDQUFDO0lBRUQsT0FBTyxpREFBaUQsQ0FBQztBQUMzRCxDQUFDO0FBRUQ7O0dBRUc7QUFDSCxTQUFTLHdCQUF3QixDQUFDLE9BQWU7SUFDL0MsTUFBTSxlQUFlLEdBQUcsQ0FBQyxvQkFBb0IsRUFBRSxtQkFBbUIsRUFBRSxzQkFBc0IsQ0FBQyxDQUFDO0lBRTVGLFFBQVEsT0FBTyxDQUFDLFdBQVcsRUFBRSxFQUFFLENBQUM7UUFDOUIsS0FBSyxhQUFhO1lBQ2hCLE9BQU8sQ0FBQyxHQUFHLGVBQWUsRUFBRSxhQUFhLEVBQUUsb0JBQW9CLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFDbEYsS0FBSyxlQUFlO1lBQ2xCLE9BQU8sQ0FBQyxHQUFHLGVBQWUsRUFBRSxlQUFlLEVBQUUsa0JBQWtCLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFDakYsS0FBSyxTQUFTO1lBQ1osT0FBTyxDQUFDLEdBQUcsZUFBZSxFQUFFLG1CQUFtQixFQUFFLGdCQUFnQixFQUFFLG9CQUFvQixDQUFDLENBQUM7UUFDM0YsS0FBSyxnQkFBZ0I7WUFDbkIsT0FBTyxDQUFDLEdBQUcsZUFBZSxFQUFFLE1BQU0sRUFBRSxvQkFBb0IsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1FBQzlFLEtBQUssTUFBTTtZQUNULE9BQU8sQ0FBQyxHQUFHLGVBQWUsRUFBRSxjQUFjLEVBQUUsZUFBZSxFQUFFLGlCQUFpQixDQUFDLENBQUM7UUFDbEY7WUFDRSxPQUFPLGVBQWUsQ0FBQztJQUMzQixDQUFDO0FBQ0gsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWljaGFlbG1jaXNhYWMvR2l0SHViL3RlYWNoaW5nLWVuZ2luZTIuMC9zZXJ2ZXIvc3JjL3NlcnZpY2VzL3dlZWtseVBsYW5FeHRyYWN0b3IudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcHJpc21hIH0gZnJvbSAnLi4vcHJpc21hJztcbmltcG9ydCB7IFN1YlBsYW5EYXRhLCBTdWJQbGFuT3B0aW9ucywgYnVpbGRTdWJQbGFuRGF0YSB9IGZyb20gJy4vc3ViUGxhblNlcnZpY2UnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFdlZWtseVBsYW5EYXRhIHtcbiAgc3RhcnREYXRlOiBzdHJpbmc7XG4gIGVuZERhdGU6IHN0cmluZztcbiAgZGF5czogU3ViUGxhbkRhdGFbXTtcbiAgd2Vla2x5T3ZlcnZpZXc6IHtcbiAgICBzdWJqZWN0czogQXJyYXk8e1xuICAgICAgbmFtZTogc3RyaW5nO1xuICAgICAgdG90YWxIb3VyczogbnVtYmVyO1xuICAgICAga2V5VG9waWNzOiBzdHJpbmdbXTtcbiAgICAgIG91dGNvbWVzOiBBcnJheTx7XG4gICAgICAgIGNvZGU6IHN0cmluZztcbiAgICAgICAgZGVzY3JpcHRpb246IHN0cmluZztcbiAgICAgIH0+O1xuICAgIH0+O1xuICAgIHVuaXRQbGFuczogQXJyYXk8e1xuICAgICAgaWQ6IHN0cmluZztcbiAgICAgIHRpdGxlOiBzdHJpbmc7XG4gICAgICBzdGFydERhdGU6IERhdGU7XG4gICAgICBlbmREYXRlOiBEYXRlO1xuICAgICAgc3ViamVjdD86IHN0cmluZztcbiAgICAgIGxvbmdSYW5nZVBsYW46IHtcbiAgICAgICAgc3ViamVjdDogc3RyaW5nO1xuICAgICAgICBncmFkZTogbnVtYmVyO1xuICAgICAgfTtcbiAgICAgIGxlc3NvblBsYW5zOiBBcnJheTx7XG4gICAgICAgIGlkOiBzdHJpbmc7XG4gICAgICAgIHRpdGxlOiBzdHJpbmc7XG4gICAgICAgIGR1cmF0aW9uOiBudW1iZXI7XG4gICAgICAgIGRheWJvb2tFbnRyeTogdW5rbm93bjtcbiAgICAgIH0+O1xuICAgIH0+O1xuICAgIGFzc2Vzc21lbnRzOiBBcnJheTx7XG4gICAgICB0aXRsZTogc3RyaW5nO1xuICAgICAgZGF0ZTogc3RyaW5nO1xuICAgICAgc3ViamVjdDogc3RyaW5nO1xuICAgICAgdHlwZTogc3RyaW5nO1xuICAgIH0+O1xuICAgIHNwZWNpYWxFdmVudHM6IEFycmF5PHtcbiAgICAgIHRpdGxlOiBzdHJpbmc7XG4gICAgICBkYXRlOiBzdHJpbmc7XG4gICAgICB0aW1lPzogc3RyaW5nO1xuICAgICAgaW1wYWN0OiBzdHJpbmc7IC8vIEhvdyBpdCBhZmZlY3RzIHRoZSByZWd1bGFyIHNjaGVkdWxlXG4gICAgfT47XG4gIH07XG4gIGNvbnRpbnVpdHlOb3RlczogQXJyYXk8e1xuICAgIGRheTogc3RyaW5nO1xuICAgIHByZXZpb3VzRGF5Pzogc3RyaW5nO1xuICAgIGNvbm5lY3Rpb25zOiBzdHJpbmdbXTtcbiAgICBwcmVwYXJhdGlvbnM6IHN0cmluZ1tdO1xuICB9PjtcbiAgZW1lcmdlbmN5QmFja3VwUGxhbnM6IEFycmF5PHtcbiAgICBzdWJqZWN0OiBzdHJpbmc7XG4gICAgYWN0aXZpdGllczogc3RyaW5nW107XG4gICAgbWF0ZXJpYWxzOiBzdHJpbmdbXTtcbiAgfT47XG59XG5cbi8qKlxuICogRXh0cmFjdCBhIGNvbXByZWhlbnNpdmUgd2Vla2x5IHN1YnN0aXR1dGUgcGxhbiB3aXRoIGNyb3NzLWRheSBjb250aW51aXR5XG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBleHRyYWN0V2Vla2x5UGxhbihcbiAgc3RhcnREYXRlOiBzdHJpbmcsXG4gIG51bURheXM6IG51bWJlciA9IDUsXG4gIG9wdGlvbnM6IFN1YlBsYW5PcHRpb25zID0ge30sXG4pOiBQcm9taXNlPFdlZWtseVBsYW5EYXRhPiB7XG4gIGNvbnN0IHsgdXNlcklkID0gMSB9ID0gb3B0aW9ucztcblxuICAvLyBHZW5lcmF0ZSBkYXRhIGZvciBlYWNoIGRheVxuICBjb25zdCBkYXlzOiBTdWJQbGFuRGF0YVtdID0gW107XG4gIGNvbnN0IHN0YXJ0RGF0ZU9iaiA9IG5ldyBEYXRlKHN0YXJ0RGF0ZSk7XG5cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1EYXlzOyBpKyspIHtcbiAgICBjb25zdCBjdXJyZW50RGF0ZSA9IG5ldyBEYXRlKHN0YXJ0RGF0ZU9iaik7XG4gICAgY3VycmVudERhdGUuc2V0VVRDRGF0ZShzdGFydERhdGVPYmouZ2V0VVRDRGF0ZSgpICsgaSk7XG4gICAgY29uc3QgZGF0ZVN0ciA9IGN1cnJlbnREYXRlLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXTtcblxuICAgIGNvbnN0IGRheURhdGEgPSBhd2FpdCBidWlsZFN1YlBsYW5EYXRhKGRhdGVTdHIsIG9wdGlvbnMpO1xuICAgIGRheXMucHVzaChkYXlEYXRhKTtcbiAgfVxuXG4gIC8vIENhbGN1bGF0ZSBlbmQgZGF0ZVxuICBjb25zdCBlbmREYXRlT2JqID0gbmV3IERhdGUoc3RhcnREYXRlT2JqKTtcbiAgZW5kRGF0ZU9iai5zZXRVVENEYXRlKHN0YXJ0RGF0ZU9iai5nZXRVVENEYXRlKCkgKyBudW1EYXlzIC0gMSk7XG4gIGNvbnN0IGVuZERhdGUgPSBlbmREYXRlT2JqLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXTtcblxuICAvLyBFeHRyYWN0IHdlZWtseSBvdmVydmlldyBkYXRhXG4gIGNvbnN0IHdlZWtseU92ZXJ2aWV3ID0gYXdhaXQgZXh0cmFjdFdlZWtseU92ZXJ2aWV3KHN0YXJ0RGF0ZSwgZW5kRGF0ZSwgdXNlcklkKTtcblxuICAvLyBHZW5lcmF0ZSBjb250aW51aXR5IG5vdGVzXG4gIGNvbnN0IGNvbnRpbnVpdHlOb3RlcyA9IGdlbmVyYXRlQ29udGludWl0eU5vdGVzKGRheXMpO1xuXG4gIC8vIENyZWF0ZSBlbWVyZ2VuY3kgYmFja3VwIHBsYW5zXG4gIGNvbnN0IGVtZXJnZW5jeUJhY2t1cFBsYW5zID0gYXdhaXQgZ2VuZXJhdGVFbWVyZ2VuY3lCYWNrdXBQbGFucygpO1xuXG4gIHJldHVybiB7XG4gICAgc3RhcnREYXRlLFxuICAgIGVuZERhdGUsXG4gICAgZGF5cyxcbiAgICB3ZWVrbHlPdmVydmlldyxcbiAgICBjb250aW51aXR5Tm90ZXMsXG4gICAgZW1lcmdlbmN5QmFja3VwUGxhbnMsXG4gIH07XG59XG5cbi8qKlxuICogRXh0cmFjdCB3ZWVrbHkgb3ZlcnZpZXcgd2l0aCBzdWJqZWN0cywgbWlsZXN0b25lcywgYW5kIGFzc2Vzc21lbnRzXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGV4dHJhY3RXZWVrbHlPdmVydmlldyhcbiAgc3RhcnREYXRlOiBzdHJpbmcsXG4gIGVuZERhdGU6IHN0cmluZyxcbiAgdXNlcklkOiBudW1iZXIsXG4pOiBQcm9taXNlPHtcbiAgc3ViamVjdHM6IEFycmF5PHtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgdG90YWxIb3VyczogbnVtYmVyO1xuICAgIGtleVRvcGljczogc3RyaW5nW107XG4gICAgb3V0Y29tZXM6IEFycmF5PHtcbiAgICAgIGNvZGU6IHN0cmluZztcbiAgICAgIGRlc2NyaXB0aW9uOiBzdHJpbmc7XG4gICAgfT47XG4gIH0+O1xuICB1bml0UGxhbnM6IEFycmF5PHtcbiAgICBpZDogc3RyaW5nO1xuICAgIHRpdGxlOiBzdHJpbmc7XG4gICAgc3RhcnREYXRlOiBEYXRlO1xuICAgIGVuZERhdGU6IERhdGU7XG4gICAgc3ViamVjdD86IHN0cmluZztcbiAgICBsb25nUmFuZ2VQbGFuOiB7XG4gICAgICBzdWJqZWN0OiBzdHJpbmc7XG4gICAgICBncmFkZTogbnVtYmVyO1xuICAgIH07XG4gICAgbGVzc29uUGxhbnM6IEFycmF5PHtcbiAgICAgIGlkOiBzdHJpbmc7XG4gICAgICB0aXRsZTogc3RyaW5nO1xuICAgICAgZHVyYXRpb246IG51bWJlcjtcbiAgICAgIGRheWJvb2tFbnRyeTogdW5rbm93bjtcbiAgICB9PjtcbiAgfT47XG4gIGFzc2Vzc21lbnRzOiBBcnJheTx7XG4gICAgdGl0bGU6IHN0cmluZztcbiAgICBkYXRlOiBzdHJpbmc7XG4gICAgc3ViamVjdDogc3RyaW5nO1xuICAgIHR5cGU6IHN0cmluZztcbiAgfT47XG4gIHNwZWNpYWxFdmVudHM6IEFycmF5PHtcbiAgICB0aXRsZTogc3RyaW5nO1xuICAgIGRhdGU6IHN0cmluZztcbiAgICB0aW1lPzogc3RyaW5nO1xuICAgIGltcGFjdDogc3RyaW5nO1xuICB9Pjtcbn0+IHtcbiAgY29uc3Qgd2Vla1N0YXJ0ID0gbmV3IERhdGUoc3RhcnREYXRlKTtcbiAgd2Vla1N0YXJ0LnNldFVUQ0hvdXJzKDAsIDAsIDAsIDApO1xuICBjb25zdCB3ZWVrRW5kID0gbmV3IERhdGUoZW5kRGF0ZSk7XG4gIHdlZWtFbmQuc2V0VVRDSG91cnMoMjMsIDU5LCA1OSwgOTk5KTtcblxuICAvLyBHZXQgYWxsIGRhaWx5IHBsYW5zIGZvciB0aGUgd2Vla1xuICAvLyBESVNBQkxFRDogTGVnYWN5IGRhaWx5UGxhbiBtb2RlbCByZW1vdmVkIGluIEVURk8gbWlncmF0aW9uXG4gIGNvbnN0IHdlZWtseVBsYW5zOiBBcnJheTx7XG4gICAgaXRlbXM6IEFycmF5PHtcbiAgICAgIHNsb3Q/OiB7IHN1YmplY3Q/OiB7IG5hbWU6IHN0cmluZyB9IH07XG4gICAgICBhY3Rpdml0eT86IHtcbiAgICAgICAgdGl0bGU/OiBzdHJpbmc7XG4gICAgICAgIG1pbGVzdG9uZT86IHsgc3ViamVjdD86IHsgbmFtZTogc3RyaW5nIH0gfTtcbiAgICAgICAgb3V0Y29tZXM/OiBBcnJheTx7XG4gICAgICAgICAgb3V0Y29tZToge1xuICAgICAgICAgICAgaWQ6IHN0cmluZztcbiAgICAgICAgICAgIGNvZGU6IHN0cmluZztcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBzdHJpbmc7XG4gICAgICAgICAgfTtcbiAgICAgICAgfT47XG4gICAgICB9O1xuICAgIH0+O1xuICB9PiA9IFtdOyAvLyBMZWdhY3kgZGFpbHlQbGFuIHF1ZXJ5IGRpc2FibGVkXG5cbiAgLy8gR2V0IHVuaXQgcGxhbnMgZm9yIHRoZSBwZXJpb2QgdXNpbmcgRVRGTyBmcmFtZXdvcmtcbiAgY29uc3QgdW5pdFBsYW5zID0gYXdhaXQgcHJpc21hLnVuaXRQbGFuLmZpbmRNYW55KHtcbiAgICB3aGVyZToge1xuICAgICAgdXNlcklkLFxuICAgICAgT1I6IFtcbiAgICAgICAge1xuICAgICAgICAgIHN0YXJ0RGF0ZToge1xuICAgICAgICAgICAgZ3RlOiB3ZWVrU3RhcnQsXG4gICAgICAgICAgICBsdGU6IHdlZWtFbmQsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGVuZERhdGU6IHtcbiAgICAgICAgICAgIGd0ZTogd2Vla1N0YXJ0LFxuICAgICAgICAgICAgbHRlOiB3ZWVrRW5kLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBBTkQ6IFt7IHN0YXJ0RGF0ZTogeyBsdGU6IHdlZWtTdGFydCB9IH0sIHsgZW5kRGF0ZTogeyBndGU6IHdlZWtFbmQgfSB9XSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSxcbiAgICBpbmNsdWRlOiB7XG4gICAgICBsb25nUmFuZ2VQbGFuOiB7XG4gICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgIHN1YmplY3Q6IHRydWUsXG4gICAgICAgICAgZ3JhZGU6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgbGVzc29uUGxhbnM6IHtcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIGRheWJvb2tFbnRyeTogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSxcbiAgfSk7XG5cbiAgLy8gQXNzZXNzbWVudCBmdW5jdGlvbmFsaXR5IHJlbW92ZWRcbiAgLy8gY29uc3QgYXNzZXNzbWVudHM6IEFycmF5PFJlY29yZDxzdHJpbmcsIHVua25vd24+PiA9IFtdO1xuXG4gIC8vIEdldCBzcGVjaWFsIGV2ZW50c1xuICBjb25zdCBzcGVjaWFsRXZlbnRzID0gYXdhaXQgcHJpc21hLmNhbGVuZGFyRXZlbnQuZmluZE1hbnkoe1xuICAgIHdoZXJlOiB7XG4gICAgICBzdGFydDoge1xuICAgICAgICBndGU6IHdlZWtTdGFydCxcbiAgICAgIH0sXG4gICAgICBlbmQ6IHtcbiAgICAgICAgbHRlOiB3ZWVrRW5kLFxuICAgICAgfSxcbiAgICB9LFxuICB9KTtcblxuICAvLyBQcm9jZXNzIHN1YmplY3RzIGFuZCBjYWxjdWxhdGUgaG91cnNcbiAgY29uc3Qgc3ViamVjdE1hcCA9IG5ldyBNYXA8XG4gICAgc3RyaW5nLFxuICAgIHtcbiAgICAgIG5hbWU6IHN0cmluZztcbiAgICAgIHRvdGFsSG91cnM6IG51bWJlcjtcbiAgICAgIGtleVRvcGljczogU2V0PHN0cmluZz47XG4gICAgICBvdXRjb21lczogTWFwPHN0cmluZywgeyBjb2RlOiBzdHJpbmc7IGRlc2NyaXB0aW9uOiBzdHJpbmcgfT47XG4gICAgfVxuICA+KCk7XG5cbiAgZm9yIChjb25zdCBwbGFuIG9mIHdlZWtseVBsYW5zKSB7XG4gICAgZm9yIChjb25zdCBpdGVtIG9mIHBsYW4uaXRlbXMpIHtcbiAgICAgIGNvbnN0IHN1YmplY3QgPSBpdGVtLnNsb3Q/LnN1YmplY3QgfHwgaXRlbS5hY3Rpdml0eT8ubWlsZXN0b25lPy5zdWJqZWN0O1xuICAgICAgaWYgKCFzdWJqZWN0KSBjb250aW51ZTtcblxuICAgICAgaWYgKCFzdWJqZWN0TWFwLmhhcyhzdWJqZWN0Lm5hbWUpKSB7XG4gICAgICAgIHN1YmplY3RNYXAuc2V0KHN1YmplY3QubmFtZSwge1xuICAgICAgICAgIG5hbWU6IHN1YmplY3QubmFtZSxcbiAgICAgICAgICB0b3RhbEhvdXJzOiAwLFxuICAgICAgICAgIGtleVRvcGljczogbmV3IFNldCgpLFxuICAgICAgICAgIG91dGNvbWVzOiBuZXcgTWFwKCksXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzdWJqZWN0RGF0YSA9IHN1YmplY3RNYXAuZ2V0KHN1YmplY3QubmFtZSkhO1xuXG4gICAgICAvLyBBZGQgZHVyYXRpb24gKGFzc3VtaW5nIDE1LW1pbnV0ZSBzbG90cywgY291bGQgYmUgbWFkZSBjb25maWd1cmFibGUpXG4gICAgICBzdWJqZWN0RGF0YS50b3RhbEhvdXJzICs9IDAuMjU7XG5cbiAgICAgIC8vIEFkZCBhY3Rpdml0eSB0b3BpY3NcbiAgICAgIGlmIChpdGVtLmFjdGl2aXR5Py50aXRsZSkge1xuICAgICAgICBzdWJqZWN0RGF0YS5rZXlUb3BpY3MuYWRkKGl0ZW0uYWN0aXZpdHkudGl0bGUpO1xuICAgICAgfVxuXG4gICAgICAvLyBBZGQgb3V0Y29tZXNcbiAgICAgIGlmIChpdGVtLmFjdGl2aXR5Py5vdXRjb21lcykge1xuICAgICAgICBmb3IgKGNvbnN0IG91dGNvbWVSZWwgb2YgaXRlbS5hY3Rpdml0eS5vdXRjb21lcykge1xuICAgICAgICAgIGNvbnN0IG91dGNvbWUgPSBvdXRjb21lUmVsLm91dGNvbWU7XG4gICAgICAgICAgc3ViamVjdERhdGEub3V0Y29tZXMuc2V0KG91dGNvbWUuaWQsIHtcbiAgICAgICAgICAgIGNvZGU6IG91dGNvbWUuY29kZSxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBvdXRjb21lLmRlc2NyaXB0aW9uLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8gQ29udmVydCB0byBmaW5hbCBmb3JtYXRcbiAgY29uc3Qgc3ViamVjdHMgPSBBcnJheS5mcm9tKHN1YmplY3RNYXAudmFsdWVzKCkpLm1hcCgocykgPT4gKHtcbiAgICBuYW1lOiBzLm5hbWUsXG4gICAgdG90YWxIb3VyczogTWF0aC5yb3VuZChzLnRvdGFsSG91cnMgKiA0KSAvIDQsIC8vIFJvdW5kIHRvIG5lYXJlc3QgcXVhcnRlciBob3VyXG4gICAga2V5VG9waWNzOiBBcnJheS5mcm9tKHMua2V5VG9waWNzKS5zbGljZSgwLCA1KSwgLy8gTGltaXQgdG8gdG9wIDVcbiAgICBvdXRjb21lczogQXJyYXkuZnJvbShzLm91dGNvbWVzLnZhbHVlcygpKSxcbiAgfSkpO1xuXG4gIC8vIFByb2Nlc3MgbWlsZXN0b25lcyAtIERJU0FCTEVEOiBMZWdhY3kgbWlsZXN0b25lIG1vZGVsIHJlbW92ZWQgaW4gRVRGTyBtaWdyYXRpb25cbiAgLy8gY29uc3QgcHJvY2Vzc2VkTWlsZXN0b25lczogYW55W10gPSBbXTsgLy8gTGVnYWN5IG1pbGVzdG9uZSBwcm9jZXNzaW5nIGRpc2FibGVkXG5cbiAgLy8gQXNzZXNzbWVudCBmdW5jdGlvbmFsaXR5IHJlbW92ZWRcbiAgY29uc3QgcHJvY2Vzc2VkQXNzZXNzbWVudHM6IEFycmF5PHtcbiAgICB0aXRsZTogc3RyaW5nO1xuICAgIGRhdGU6IHN0cmluZztcbiAgICBzdWJqZWN0OiBzdHJpbmc7XG4gICAgdHlwZTogc3RyaW5nO1xuICB9PiA9IFtdO1xuXG4gIC8vIFByb2Nlc3Mgc3BlY2lhbCBldmVudHNcbiAgY29uc3QgcHJvY2Vzc2VkRXZlbnRzID0gc3BlY2lhbEV2ZW50cy5tYXAoKGV2ZW50KSA9PiAoe1xuICAgIHRpdGxlOiBldmVudC50aXRsZSxcbiAgICBkYXRlOiBldmVudC5zdGFydC50b0lTT1N0cmluZygpLnNwbGl0KCdUJylbMF0sXG4gICAgdGltZTogZXZlbnQuYWxsRGF5ID8gdW5kZWZpbmVkIDogZXZlbnQuc3RhcnQudG9JU09TdHJpbmcoKS5zcGxpdCgnVCcpWzFdLnNsaWNlKDAsIDUpLFxuICAgIGltcGFjdDogZGV0ZXJtaW5lRXZlbnRJbXBhY3QoZXZlbnQudGl0bGUsIGV2ZW50LmFsbERheSksXG4gIH0pKTtcblxuICByZXR1cm4ge1xuICAgIHN1YmplY3RzLFxuICAgIHVuaXRQbGFucywgLy8gQ2hhbmdlZCBmcm9tIG1pbGVzdG9uZXMgdG8gdW5pdFBsYW5zIChFVEZPIGFsaWdubWVudClcbiAgICBhc3Nlc3NtZW50czogcHJvY2Vzc2VkQXNzZXNzbWVudHMsXG4gICAgc3BlY2lhbEV2ZW50czogcHJvY2Vzc2VkRXZlbnRzLFxuICB9O1xufVxuXG4vKipcbiAqIEdlbmVyYXRlIGNvbnRpbnVpdHkgbm90ZXMgc2hvd2luZyBob3cgZWFjaCBkYXkgYnVpbGRzIG9uIHRoZSBwcmV2aW91c1xuICovXG5mdW5jdGlvbiBnZW5lcmF0ZUNvbnRpbnVpdHlOb3RlcyhkYXlzOiBTdWJQbGFuRGF0YVtdKTogQXJyYXk8e1xuICBkYXk6IHN0cmluZztcbiAgcHJldmlvdXNEYXk/OiBzdHJpbmc7XG4gIGNvbm5lY3Rpb25zOiBzdHJpbmdbXTtcbiAgcHJlcGFyYXRpb25zOiBzdHJpbmdbXTtcbn0+IHtcbiAgY29uc3Qgbm90ZXMgPSBbXTtcblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGRheXMubGVuZ3RoOyBpKyspIHtcbiAgICBjb25zdCBjdXJyZW50RGF5ID0gZGF5c1tpXTtcbiAgICBjb25zdCBwcmV2aW91c0RheSA9IGkgPiAwID8gZGF5c1tpIC0gMV0gOiB1bmRlZmluZWQ7XG5cbiAgICBjb25zdCBjb25uZWN0aW9uczogc3RyaW5nW10gPSBbXTtcbiAgICBjb25zdCBwcmVwYXJhdGlvbnM6IHN0cmluZ1tdID0gW107XG5cbiAgICBpZiAocHJldmlvdXNEYXkpIHtcbiAgICAgIC8vIEZpbmQgc3ViamVjdCBjb25uZWN0aW9uc1xuICAgICAgY29uc3QgY3VycmVudFN1YmplY3RzID0gZXh0cmFjdFN1YmplY3RzRnJvbVNjaGVkdWxlKGN1cnJlbnREYXkuc2NoZWR1bGUpO1xuICAgICAgY29uc3QgcHJldmlvdXNTdWJqZWN0cyA9IGV4dHJhY3RTdWJqZWN0c0Zyb21TY2hlZHVsZShwcmV2aW91c0RheS5zY2hlZHVsZSk7XG5cbiAgICAgIGNvbnN0IGNvbW1vblN1YmplY3RzID0gY3VycmVudFN1YmplY3RzLmZpbHRlcigocykgPT5cbiAgICAgICAgcHJldmlvdXNTdWJqZWN0cy5zb21lKChwcykgPT4gcHMuc3ViamVjdCA9PT0gcy5zdWJqZWN0KSxcbiAgICAgICk7XG5cbiAgICAgIGZvciAoY29uc3Qgc3ViamVjdCBvZiBjb21tb25TdWJqZWN0cykge1xuICAgICAgICBjb25zdCBwcmV2QWN0aXZpdHkgPSBwcmV2aW91c1N1YmplY3RzLmZpbmQoKHBzKSA9PiBwcy5zdWJqZWN0ID09PSBzdWJqZWN0LnN1YmplY3QpO1xuICAgICAgICBpZiAocHJldkFjdGl2aXR5ICYmIHN1YmplY3QuYWN0aXZpdHkgIT09IHByZXZBY3Rpdml0eS5hY3Rpdml0eSkge1xuICAgICAgICAgIGNvbm5lY3Rpb25zLnB1c2goXG4gICAgICAgICAgICBgJHtzdWJqZWN0LnN1YmplY3R9OiBDb250aW51ZSBmcm9tIFwiJHtwcmV2QWN0aXZpdHkuYWN0aXZpdHl9XCIgdG8gXCIke3N1YmplY3QuYWN0aXZpdHl9XCJgLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgZm9yIG1hdGVyaWFscy9zZXR1cCBuZWVkZWRcbiAgICAgIGNvbnN0IGN1cnJlbnRBY3Rpdml0aWVzID0gY3VycmVudERheS5zY2hlZHVsZVxuICAgICAgICAuZmlsdGVyKChzKSA9PiBzLmFjdGl2aXR5KVxuICAgICAgICAubWFwKChzKSA9PiBzLmFjdGl2aXR5ISk7XG5cbiAgICAgIGlmIChjdXJyZW50QWN0aXZpdGllcy5zb21lKChhKSA9PiBhLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ3Byb2plY3QnKSkpIHtcbiAgICAgICAgcHJlcGFyYXRpb25zLnB1c2goJ0Vuc3VyZSBwcm9qZWN0IG1hdGVyaWFscyBmcm9tIHByZXZpb3VzIGRheSBhcmUgYXZhaWxhYmxlJyk7XG4gICAgICB9XG5cbiAgICAgIGlmIChjdXJyZW50QWN0aXZpdGllcy5zb21lKChhKSA9PiBhLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ3ByZXNlbnRhdGlvbicpKSkge1xuICAgICAgICBwcmVwYXJhdGlvbnMucHVzaCgnU2V0IHVwIHByZXNlbnRhdGlvbiBlcXVpcG1lbnQgYW5kIHN0dWRlbnQgd29yayBkaXNwbGF5cycpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEFkZCBnZW5lcmFsIHByZXBhcmF0aW9ucyBmb3IgdGhlIGRheVxuICAgIGNvbnN0IGRheUFjdGl2aXRpZXMgPSBjdXJyZW50RGF5LnNjaGVkdWxlLmZpbHRlcigocykgPT4gcy5hY3Rpdml0eSk7XG4gICAgaWYgKGRheUFjdGl2aXRpZXMubGVuZ3RoID4gMCkge1xuICAgICAgcHJlcGFyYXRpb25zLnB1c2goJ1JldmlldyBkYWlseSBzY2hlZHVsZSBhbmQgcHJlcGFyZSB0cmFuc2l0aW9uIG1hdGVyaWFscycpO1xuICAgIH1cblxuICAgIG5vdGVzLnB1c2goe1xuICAgICAgZGF5OiBjdXJyZW50RGF5LmRhdGUsXG4gICAgICBwcmV2aW91c0RheTogcHJldmlvdXNEYXk/LmRhdGUsXG4gICAgICBjb25uZWN0aW9ucyxcbiAgICAgIHByZXBhcmF0aW9ucyxcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiBub3Rlcztcbn1cblxuLyoqXG4gKiBHZW5lcmF0ZSBlbWVyZ2VuY3kgYmFja3VwIHBsYW5zIGJ5IHN1YmplY3RcbiAqL1xuYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVFbWVyZ2VuY3lCYWNrdXBQbGFucygpOiBQcm9taXNlPFxuICBBcnJheTx7XG4gICAgc3ViamVjdDogc3RyaW5nO1xuICAgIGFjdGl2aXRpZXM6IHN0cmluZ1tdO1xuICAgIG1hdGVyaWFsczogc3RyaW5nW107XG4gIH0+XG4+IHtcbiAgY29uc3Qgc3ViamVjdHMgPSBhd2FpdCBwcmlzbWEuc3ViamVjdC5maW5kTWFueSh7fSk7XG5cbiAgcmV0dXJuIHN1YmplY3RzLm1hcCgoc3ViamVjdCkgPT4ge1xuICAgIC8vIERJU0FCTEVEOiBMZWdhY3kgbWlsZXN0b25lL2FjdGl2aXR5IG1vZGVscyByZW1vdmVkIGluIEVURk8gbWlncmF0aW9uXG4gICAgY29uc3QgZmFsbGJhY2tBY3Rpdml0aWVzOiBBcnJheTx7IHRpdGxlOiBzdHJpbmcgfT4gPSBbXTtcblxuICAgIHJldHVybiB7XG4gICAgICBzdWJqZWN0OiBzdWJqZWN0Lm5hbWUsXG4gICAgICBhY3Rpdml0aWVzOiBmYWxsYmFja0FjdGl2aXRpZXMuc2xpY2UoMCwgMykubWFwKChhKSA9PiBhLnRpdGxlKSxcbiAgICAgIG1hdGVyaWFsczogZ2VuZXJhdGVTdWJqZWN0TWF0ZXJpYWxzKHN1YmplY3QubmFtZSksXG4gICAgfTtcbiAgfSk7XG59XG5cbi8qKlxuICogRXh0cmFjdCBzdWJqZWN0cyBmcm9tIHNjaGVkdWxlIGVudHJpZXNcbiAqL1xuZnVuY3Rpb24gZXh0cmFjdFN1YmplY3RzRnJvbVNjaGVkdWxlKFxuICBzY2hlZHVsZTogQXJyYXk8eyB0aW1lOiBzdHJpbmc7IGFjdGl2aXR5Pzogc3RyaW5nOyBub3RlPzogc3RyaW5nIH0+LFxuKSB7XG4gIHJldHVybiBzY2hlZHVsZVxuICAgIC5maWx0ZXIoKGVudHJ5KSA9PiBlbnRyeS5hY3Rpdml0eSAmJiAhZW50cnkubm90ZSlcbiAgICAubWFwKChlbnRyeSkgPT4gKHtcbiAgICAgIHRpbWU6IGVudHJ5LnRpbWUsXG4gICAgICBhY3Rpdml0eTogZW50cnkuYWN0aXZpdHkhLFxuICAgICAgc3ViamVjdDogaW5mZXJTdWJqZWN0RnJvbUFjdGl2aXR5KGVudHJ5LmFjdGl2aXR5ISksXG4gICAgfSkpO1xufVxuXG4vKipcbiAqIEluZmVyIHN1YmplY3QgZnJvbSBhY3Rpdml0eSBuYW1lIChiYXNpYyBoZXVyaXN0aWMpXG4gKi9cbmZ1bmN0aW9uIGluZmVyU3ViamVjdEZyb21BY3Rpdml0eShhY3Rpdml0eTogc3RyaW5nKTogc3RyaW5nIHtcbiAgY29uc3QgbG93ZXIgPSBhY3Rpdml0eS50b0xvd2VyQ2FzZSgpO1xuXG4gIGlmIChsb3dlci5pbmNsdWRlcygnbWF0aCcpIHx8IGxvd2VyLmluY2x1ZGVzKCdudW1iZXInKSB8fCBsb3dlci5pbmNsdWRlcygnY2FsY3VsYXRpb24nKSkge1xuICAgIHJldHVybiAnTWF0aGVtYXRpY3MnO1xuICB9XG4gIGlmIChsb3dlci5pbmNsdWRlcygncmVhZCcpIHx8IGxvd2VyLmluY2x1ZGVzKCd3cml0aW5nJykgfHwgbG93ZXIuaW5jbHVkZXMoJ2xhbmd1YWdlJykpIHtcbiAgICByZXR1cm4gJ0xhbmd1YWdlIEFydHMnO1xuICB9XG4gIGlmIChsb3dlci5pbmNsdWRlcygnc2NpZW5jZScpIHx8IGxvd2VyLmluY2x1ZGVzKCdleHBlcmltZW50JykgfHwgbG93ZXIuaW5jbHVkZXMoJ25hdHVyZScpKSB7XG4gICAgcmV0dXJuICdTY2llbmNlJztcbiAgfVxuICBpZiAobG93ZXIuaW5jbHVkZXMoJ3NvY2lhbCcpIHx8IGxvd2VyLmluY2x1ZGVzKCdoaXN0b3J5JykgfHwgbG93ZXIuaW5jbHVkZXMoJ2dlb2dyYXBoeScpKSB7XG4gICAgcmV0dXJuICdTb2NpYWwgU3R1ZGllcyc7XG4gIH1cbiAgaWYgKGxvd2VyLmluY2x1ZGVzKCdhcnQnKSB8fCBsb3dlci5pbmNsdWRlcygnZHJhdycpIHx8IGxvd2VyLmluY2x1ZGVzKCdwYWludCcpKSB7XG4gICAgcmV0dXJuICdBcnRzJztcbiAgfVxuICBpZiAobG93ZXIuaW5jbHVkZXMoJ3BlJykgfHwgbG93ZXIuaW5jbHVkZXMoJ3BoeXNpY2FsJykgfHwgbG93ZXIuaW5jbHVkZXMoJ3Nwb3J0JykpIHtcbiAgICByZXR1cm4gJ1BoeXNpY2FsIEVkdWNhdGlvbic7XG4gIH1cblxuICByZXR1cm4gJ0dlbmVyYWwnO1xufVxuXG4vKipcbiAqIERldGVybWluZSBpbXBhY3Qgb2YgY2FsZW5kYXIgZXZlbnRzIG9uIHNjaGVkdWxlXG4gKi9cbmZ1bmN0aW9uIGRldGVybWluZUV2ZW50SW1wYWN0KHRpdGxlOiBzdHJpbmcsIGFsbERheTogYm9vbGVhbik6IHN0cmluZyB7XG4gIGNvbnN0IGxvd2VyID0gdGl0bGUudG9Mb3dlckNhc2UoKTtcblxuICBpZiAoYWxsRGF5KSB7XG4gICAgaWYgKGxvd2VyLmluY2x1ZGVzKCdob2xpZGF5JykgfHwgbG93ZXIuaW5jbHVkZXMoJ2JyZWFrJykpIHtcbiAgICAgIHJldHVybiAnTm8gY2xhc3NlcyAtIHNjaG9vbCBjbG9zZWQnO1xuICAgIH1cbiAgICBpZiAobG93ZXIuaW5jbHVkZXMoJ3BkJykgfHwgbG93ZXIuaW5jbHVkZXMoJ2RldmVsb3BtZW50JykpIHtcbiAgICAgIHJldHVybiAnTm8gc3R1ZGVudHMgLSBwcm9mZXNzaW9uYWwgZGV2ZWxvcG1lbnQgZGF5JztcbiAgICB9XG4gICAgaWYgKGxvd2VyLmluY2x1ZGVzKCdhc3NlbWJseScpKSB7XG4gICAgICByZXR1cm4gJ01vZGlmaWVkIHNjaGVkdWxlIGZvciBhbGwtc2Nob29sIGFzc2VtYmx5JztcbiAgICB9XG4gIH1cblxuICBpZiAobG93ZXIuaW5jbHVkZXMoJ2ZpcmUgZHJpbGwnKSkge1xuICAgIHJldHVybiAnQnJpZWYgaW50ZXJydXB0aW9uIC0gcHJhY3RpY2UgZW1lcmdlbmN5IHByb2NlZHVyZXMnO1xuICB9XG4gIGlmIChsb3dlci5pbmNsdWRlcygncGhvdG8nKSkge1xuICAgIHJldHVybiAnU3R1ZGVudHMgbWF5IGJlIGNhbGxlZCBvdXQgZm9yIGluZGl2aWR1YWwvY2xhc3MgcGhvdG9zJztcbiAgfVxuICBpZiAobG93ZXIuaW5jbHVkZXMoJ3Zpc2l0JykgfHwgbG93ZXIuaW5jbHVkZXMoJ2d1ZXN0JykpIHtcbiAgICByZXR1cm4gJ1NwZWNpYWwgdmlzaXRvciAtIG1heSBhZmZlY3QgcmVndWxhciBhY3Rpdml0aWVzJztcbiAgfVxuXG4gIHJldHVybiAnTWF5IGFmZmVjdCByZWd1bGFyIHNjaGVkdWxlIC0gY2hlY2sgd2l0aCBvZmZpY2UnO1xufVxuXG4vKipcbiAqIEdlbmVyYXRlIGNvbW1vbiBtYXRlcmlhbHMgbGlzdCBieSBzdWJqZWN0XG4gKi9cbmZ1bmN0aW9uIGdlbmVyYXRlU3ViamVjdE1hdGVyaWFscyhzdWJqZWN0OiBzdHJpbmcpOiBzdHJpbmdbXSB7XG4gIGNvbnN0IGNvbW1vbk1hdGVyaWFscyA9IFsnV2hpdGVib2FyZCBtYXJrZXJzJywgJ1BhcGVyIGFuZCBwZW5jaWxzJywgJ1RpbWVyIGZvciBhY3Rpdml0aWVzJ107XG5cbiAgc3dpdGNoIChzdWJqZWN0LnRvTG93ZXJDYXNlKCkpIHtcbiAgICBjYXNlICdtYXRoZW1hdGljcyc6XG4gICAgICByZXR1cm4gWy4uLmNvbW1vbk1hdGVyaWFscywgJ0NhbGN1bGF0b3JzJywgJ01hdGggbWFuaXB1bGF0aXZlcycsICdHcmFwaCBwYXBlciddO1xuICAgIGNhc2UgJ2xhbmd1YWdlIGFydHMnOlxuICAgICAgcmV0dXJuIFsuLi5jb21tb25NYXRlcmlhbHMsICdSZWFkaW5nIGJvb2tzJywgJ1dyaXRpbmcgam91cm5hbHMnLCAnRGljdGlvbmFyeSddO1xuICAgIGNhc2UgJ3NjaWVuY2UnOlxuICAgICAgcmV0dXJuIFsuLi5jb21tb25NYXRlcmlhbHMsICdTY2llbmNlIG5vdGVib29rcycsICdTYWZldHkgZ29nZ2xlcycsICdCYXNpYyBsYWIgc3VwcGxpZXMnXTtcbiAgICBjYXNlICdzb2NpYWwgc3R1ZGllcyc6XG4gICAgICByZXR1cm4gWy4uLmNvbW1vbk1hdGVyaWFscywgJ01hcHMnLCAnVGltZWxpbmUgbWF0ZXJpYWxzJywgJ1Jlc2VhcmNoIGJvb2tzJ107XG4gICAgY2FzZSAnYXJ0cyc6XG4gICAgICByZXR1cm4gWy4uLmNvbW1vbk1hdGVyaWFscywgJ0FydCBzdXBwbGllcycsICdEcmF3aW5nIHBhcGVyJywgJ0NvbG9yZWQgcGVuY2lscyddO1xuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4gY29tbW9uTWF0ZXJpYWxzO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=