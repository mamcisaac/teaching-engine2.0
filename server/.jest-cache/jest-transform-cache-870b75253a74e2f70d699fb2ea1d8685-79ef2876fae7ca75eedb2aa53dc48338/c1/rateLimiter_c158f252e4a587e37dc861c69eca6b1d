c5b5f4e8737ffce1760367e05be033d0
import logger from '../logger';
// Store for request counts
const requestCounts = new Map();
// Cleanup old entries periodically
setInterval(() => {
    const now = Date.now();
    for (const [key, value] of requestCounts.entries()) {
        if (value.resetTime < now) {
            requestCounts.delete(key);
        }
    }
}, 60000); // Clean up every minute
export function createRateLimiter(options) {
    const { windowMs, max, keyGenerator = (req) => {
        // Default key: IP + user ID if authenticated
        const ip = req.ip || req.connection.remoteAddress || 'unknown';
        const userId = req.user?.userId || 'anonymous';
        return `${ip}-${userId}`;
    }, message = 'Too many requests, please try again later.', skipSuccessfulRequests = false, skipFailedRequests = false, } = options;
    return (req, res, next) => {
        const key = keyGenerator(req);
        const now = Date.now();
        // Get or create entry
        let entry = requestCounts.get(key);
        if (!entry || entry.resetTime < now) {
            entry = { count: 0, resetTime: now + windowMs };
            requestCounts.set(key, entry);
        }
        // Check if limit exceeded
        if (entry.count >= max) {
            const retryAfter = Math.ceil((entry.resetTime - now) / 1000);
            logger.warn({
                key,
                endpoint: req.path,
                method: req.method,
                count: entry.count,
                max,
            }, 'Rate limit exceeded');
            res.setHeader('Retry-After', retryAfter.toString());
            res.setHeader('X-RateLimit-Limit', max.toString());
            res.setHeader('X-RateLimit-Remaining', '0');
            res.setHeader('X-RateLimit-Reset', new Date(entry.resetTime).toISOString());
            return res.status(429).json({
                error: message,
                retryAfter,
            });
        }
        // Increment counter
        entry.count++;
        // Set headers
        res.setHeader('X-RateLimit-Limit', max.toString());
        res.setHeader('X-RateLimit-Remaining', Math.max(0, max - entry.count).toString());
        res.setHeader('X-RateLimit-Reset', new Date(entry.resetTime).toISOString());
        // Handle response to optionally skip counting
        if (skipSuccessfulRequests || skipFailedRequests) {
            const originalSend = res.send;
            res.send = function (data) {
                const shouldSkip = (skipSuccessfulRequests && res.statusCode < 400) ||
                    (skipFailedRequests && res.statusCode >= 400);
                if (shouldSkip && entry) {
                    entry.count = Math.max(0, entry.count - 1);
                }
                return originalSend.call(this, data);
            };
        }
        next();
    };
}
// Pre-configured rate limiters for different use cases
export const rateLimiters = {
    // Strict limit for authentication endpoints
    auth: createRateLimiter({
        windowMs: 15 * 60 * 1000, // 15 minutes
        max: 5, // 5 requests per window
        message: 'Too many authentication attempts. Please try again later.',
        skipSuccessfulRequests: true, // Only count failed attempts
    }),
    // Standard API rate limit
    api: createRateLimiter({
        windowMs: 15 * 60 * 1000, // 15 minutes
        max: 100, // 100 requests per window
    }),
    // Relaxed limit for read operations
    read: createRateLimiter({
        windowMs: 15 * 60 * 1000, // 15 minutes
        max: 200, // 200 requests per window
    }),
    // Strict limit for write operations
    write: createRateLimiter({
        windowMs: 15 * 60 * 1000, // 15 minutes
        max: 50, // 50 requests per window
    }),
    // Very strict limit for AI operations
    ai: createRateLimiter({
        windowMs: 60 * 60 * 1000, // 1 hour
        max: 20, // 20 requests per hour
        message: 'AI generation limit exceeded. Please try again later.',
    }),
    // File upload limit
    upload: createRateLimiter({
        windowMs: 60 * 60 * 1000, // 1 hour
        max: 10, // 10 uploads per hour
        message: 'File upload limit exceeded. Please try again later.',
    }),
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9taWRkbGV3YXJlL3JhdGVMaW1pdGVyLnRzIiwibWFwcGluZ3MiOiJBQUNBLE9BQU8sTUFBTSxNQUFNLFdBQVcsQ0FBQztBQVcvQiwyQkFBMkI7QUFDM0IsTUFBTSxhQUFhLEdBQUcsSUFBSSxHQUFHLEVBQWdELENBQUM7QUFFOUUsbUNBQW1DO0FBQ25DLFdBQVcsQ0FBQyxHQUFHLEVBQUU7SUFDZixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDdkIsS0FBSyxNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxJQUFJLGFBQWEsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDO1FBQ25ELElBQUksS0FBSyxDQUFDLFNBQVMsR0FBRyxHQUFHLEVBQUUsQ0FBQztZQUMxQixhQUFhLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzVCLENBQUM7SUFDSCxDQUFDO0FBQ0gsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsd0JBQXdCO0FBRW5DLE1BQU0sVUFBVSxpQkFBaUIsQ0FBQyxPQUF5QjtJQUN6RCxNQUFNLEVBQ0osUUFBUSxFQUNSLEdBQUcsRUFDSCxZQUFZLEdBQUcsQ0FBQyxHQUFHLEVBQUUsRUFBRTtRQUNyQiw2Q0FBNkM7UUFDN0MsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDLEVBQUUsSUFBSSxHQUFHLENBQUMsVUFBVSxDQUFDLGFBQWEsSUFBSSxTQUFTLENBQUM7UUFDL0QsTUFBTSxNQUFNLEdBQUksR0FBVyxDQUFDLElBQUksRUFBRSxNQUFNLElBQUksV0FBVyxDQUFDO1FBQ3hELE9BQU8sR0FBRyxFQUFFLElBQUksTUFBTSxFQUFFLENBQUM7SUFDM0IsQ0FBQyxFQUNELE9BQU8sR0FBRyw0Q0FBNEMsRUFDdEQsc0JBQXNCLEdBQUcsS0FBSyxFQUM5QixrQkFBa0IsR0FBRyxLQUFLLEdBQzNCLEdBQUcsT0FBTyxDQUFDO0lBRVosT0FBTyxDQUFDLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBa0IsRUFBRSxFQUFFO1FBQ3pELE1BQU0sR0FBRyxHQUFHLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM5QixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFFdkIsc0JBQXNCO1FBQ3RCLElBQUksS0FBSyxHQUFHLGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbkMsSUFBSSxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUMsU0FBUyxHQUFHLEdBQUcsRUFBRSxDQUFDO1lBQ3BDLEtBQUssR0FBRyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsU0FBUyxFQUFFLEdBQUcsR0FBRyxRQUFRLEVBQUUsQ0FBQztZQUNoRCxhQUFhLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNoQyxDQUFDO1FBRUQsMEJBQTBCO1FBQzFCLElBQUksS0FBSyxDQUFDLEtBQUssSUFBSSxHQUFHLEVBQUUsQ0FBQztZQUN2QixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBRyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQztZQUU3RCxNQUFNLENBQUMsSUFBSSxDQUFDO2dCQUNWLEdBQUc7Z0JBQ0gsUUFBUSxFQUFFLEdBQUcsQ0FBQyxJQUFJO2dCQUNsQixNQUFNLEVBQUUsR0FBRyxDQUFDLE1BQU07Z0JBQ2xCLEtBQUssRUFBRSxLQUFLLENBQUMsS0FBSztnQkFDbEIsR0FBRzthQUNKLEVBQUUscUJBQXFCLENBQUMsQ0FBQztZQUUxQixHQUFHLENBQUMsU0FBUyxDQUFDLGFBQWEsRUFBRSxVQUFVLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztZQUNwRCxHQUFHLENBQUMsU0FBUyxDQUFDLG1CQUFtQixFQUFFLEdBQUcsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO1lBQ25ELEdBQUcsQ0FBQyxTQUFTLENBQUMsdUJBQXVCLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDNUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxtQkFBbUIsRUFBRSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztZQUU1RSxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUMxQixLQUFLLEVBQUUsT0FBTztnQkFDZCxVQUFVO2FBQ1gsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELG9CQUFvQjtRQUNwQixLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7UUFFZCxjQUFjO1FBQ2QsR0FBRyxDQUFDLFNBQVMsQ0FBQyxtQkFBbUIsRUFBRSxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztRQUNuRCxHQUFHLENBQUMsU0FBUyxDQUFDLHVCQUF1QixFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLEdBQUcsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztRQUNsRixHQUFHLENBQUMsU0FBUyxDQUFDLG1CQUFtQixFQUFFLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO1FBRTVFLDhDQUE4QztRQUM5QyxJQUFJLHNCQUFzQixJQUFJLGtCQUFrQixFQUFFLENBQUM7WUFDakQsTUFBTSxZQUFZLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztZQUM5QixHQUFHLENBQUMsSUFBSSxHQUFHLFVBQVMsSUFBSTtnQkFDdEIsTUFBTSxVQUFVLEdBQ2QsQ0FBQyxzQkFBc0IsSUFBSSxHQUFHLENBQUMsVUFBVSxHQUFHLEdBQUcsQ0FBQztvQkFDaEQsQ0FBQyxrQkFBa0IsSUFBSSxHQUFHLENBQUMsVUFBVSxJQUFJLEdBQUcsQ0FBQyxDQUFDO2dCQUVoRCxJQUFJLFVBQVUsSUFBSSxLQUFLLEVBQUUsQ0FBQztvQkFDeEIsS0FBSyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUM3QyxDQUFDO2dCQUVELE9BQU8sWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDdkMsQ0FBQyxDQUFDO1FBQ0osQ0FBQztRQUVELElBQUksRUFBRSxDQUFDO0lBQ1QsQ0FBQyxDQUFDO0FBQ0osQ0FBQztBQUVELHVEQUF1RDtBQUN2RCxNQUFNLENBQUMsTUFBTSxZQUFZLEdBQUc7SUFDMUIsNENBQTRDO0lBQzVDLElBQUksRUFBRSxpQkFBaUIsQ0FBQztRQUN0QixRQUFRLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLEVBQUUsYUFBYTtRQUN2QyxHQUFHLEVBQUUsQ0FBQyxFQUFFLHdCQUF3QjtRQUNoQyxPQUFPLEVBQUUsMkRBQTJEO1FBQ3BFLHNCQUFzQixFQUFFLElBQUksRUFBRSw2QkFBNkI7S0FDNUQsQ0FBQztJQUVGLDBCQUEwQjtJQUMxQixHQUFHLEVBQUUsaUJBQWlCLENBQUM7UUFDckIsUUFBUSxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxFQUFFLGFBQWE7UUFDdkMsR0FBRyxFQUFFLEdBQUcsRUFBRSwwQkFBMEI7S0FDckMsQ0FBQztJQUVGLG9DQUFvQztJQUNwQyxJQUFJLEVBQUUsaUJBQWlCLENBQUM7UUFDdEIsUUFBUSxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxFQUFFLGFBQWE7UUFDdkMsR0FBRyxFQUFFLEdBQUcsRUFBRSwwQkFBMEI7S0FDckMsQ0FBQztJQUVGLG9DQUFvQztJQUNwQyxLQUFLLEVBQUUsaUJBQWlCLENBQUM7UUFDdkIsUUFBUSxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxFQUFFLGFBQWE7UUFDdkMsR0FBRyxFQUFFLEVBQUUsRUFBRSx5QkFBeUI7S0FDbkMsQ0FBQztJQUVGLHNDQUFzQztJQUN0QyxFQUFFLEVBQUUsaUJBQWlCLENBQUM7UUFDcEIsUUFBUSxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxFQUFFLFNBQVM7UUFDbkMsR0FBRyxFQUFFLEVBQUUsRUFBRSx1QkFBdUI7UUFDaEMsT0FBTyxFQUFFLHVEQUF1RDtLQUNqRSxDQUFDO0lBRUYsb0JBQW9CO0lBQ3BCLE1BQU0sRUFBRSxpQkFBaUIsQ0FBQztRQUN4QixRQUFRLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLEVBQUUsU0FBUztRQUNuQyxHQUFHLEVBQUUsRUFBRSxFQUFFLHNCQUFzQjtRQUMvQixPQUFPLEVBQUUscURBQXFEO0tBQy9ELENBQUM7Q0FDSCxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9taWNoYWVsbWNpc2FhYy9HaXRIdWIvdGVhY2hpbmctZW5naW5lMi4wL3NlcnZlci9zcmMvbWlkZGxld2FyZS9yYXRlTGltaXRlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSwgTmV4dEZ1bmN0aW9uIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4uL2xvZ2dlcic7XG5cbmludGVyZmFjZSBSYXRlTGltaXRPcHRpb25zIHtcbiAgd2luZG93TXM6IG51bWJlcjsgLy8gVGltZSB3aW5kb3cgaW4gbWlsbGlzZWNvbmRzXG4gIG1heDogbnVtYmVyOyAvLyBNYXggcmVxdWVzdHMgcGVyIHdpbmRvd1xuICBrZXlHZW5lcmF0b3I/OiAocmVxOiBSZXF1ZXN0KSA9PiBzdHJpbmc7IC8vIEN1c3RvbSBrZXkgZ2VuZXJhdG9yXG4gIG1lc3NhZ2U/OiBzdHJpbmc7IC8vIEVycm9yIG1lc3NhZ2VcbiAgc2tpcFN1Y2Nlc3NmdWxSZXF1ZXN0cz86IGJvb2xlYW47IC8vIERvbid0IGNvdW50IHN1Y2Nlc3NmdWwgcmVxdWVzdHNcbiAgc2tpcEZhaWxlZFJlcXVlc3RzPzogYm9vbGVhbjsgLy8gRG9uJ3QgY291bnQgZmFpbGVkIHJlcXVlc3RzXG59XG5cbi8vIFN0b3JlIGZvciByZXF1ZXN0IGNvdW50c1xuY29uc3QgcmVxdWVzdENvdW50cyA9IG5ldyBNYXA8c3RyaW5nLCB7IGNvdW50OiBudW1iZXI7IHJlc2V0VGltZTogbnVtYmVyIH0+KCk7XG5cbi8vIENsZWFudXAgb2xkIGVudHJpZXMgcGVyaW9kaWNhbGx5XG5zZXRJbnRlcnZhbCgoKSA9PiB7XG4gIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIHJlcXVlc3RDb3VudHMuZW50cmllcygpKSB7XG4gICAgaWYgKHZhbHVlLnJlc2V0VGltZSA8IG5vdykge1xuICAgICAgcmVxdWVzdENvdW50cy5kZWxldGUoa2V5KTtcbiAgICB9XG4gIH1cbn0sIDYwMDAwKTsgLy8gQ2xlYW4gdXAgZXZlcnkgbWludXRlXG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVSYXRlTGltaXRlcihvcHRpb25zOiBSYXRlTGltaXRPcHRpb25zKSB7XG4gIGNvbnN0IHtcbiAgICB3aW5kb3dNcyxcbiAgICBtYXgsXG4gICAga2V5R2VuZXJhdG9yID0gKHJlcSkgPT4ge1xuICAgICAgLy8gRGVmYXVsdCBrZXk6IElQICsgdXNlciBJRCBpZiBhdXRoZW50aWNhdGVkXG4gICAgICBjb25zdCBpcCA9IHJlcS5pcCB8fCByZXEuY29ubmVjdGlvbi5yZW1vdGVBZGRyZXNzIHx8ICd1bmtub3duJztcbiAgICAgIGNvbnN0IHVzZXJJZCA9IChyZXEgYXMgYW55KS51c2VyPy51c2VySWQgfHwgJ2Fub255bW91cyc7XG4gICAgICByZXR1cm4gYCR7aXB9LSR7dXNlcklkfWA7XG4gICAgfSxcbiAgICBtZXNzYWdlID0gJ1RvbyBtYW55IHJlcXVlc3RzLCBwbGVhc2UgdHJ5IGFnYWluIGxhdGVyLicsXG4gICAgc2tpcFN1Y2Nlc3NmdWxSZXF1ZXN0cyA9IGZhbHNlLFxuICAgIHNraXBGYWlsZWRSZXF1ZXN0cyA9IGZhbHNlLFxuICB9ID0gb3B0aW9ucztcblxuICByZXR1cm4gKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gICAgY29uc3Qga2V5ID0ga2V5R2VuZXJhdG9yKHJlcSk7XG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICBcbiAgICAvLyBHZXQgb3IgY3JlYXRlIGVudHJ5XG4gICAgbGV0IGVudHJ5ID0gcmVxdWVzdENvdW50cy5nZXQoa2V5KTtcbiAgICBpZiAoIWVudHJ5IHx8IGVudHJ5LnJlc2V0VGltZSA8IG5vdykge1xuICAgICAgZW50cnkgPSB7IGNvdW50OiAwLCByZXNldFRpbWU6IG5vdyArIHdpbmRvd01zIH07XG4gICAgICByZXF1ZXN0Q291bnRzLnNldChrZXksIGVudHJ5KTtcbiAgICB9XG4gICAgXG4gICAgLy8gQ2hlY2sgaWYgbGltaXQgZXhjZWVkZWRcbiAgICBpZiAoZW50cnkuY291bnQgPj0gbWF4KSB7XG4gICAgICBjb25zdCByZXRyeUFmdGVyID0gTWF0aC5jZWlsKChlbnRyeS5yZXNldFRpbWUgLSBub3cpIC8gMTAwMCk7XG4gICAgICBcbiAgICAgIGxvZ2dlci53YXJuKHtcbiAgICAgICAga2V5LFxuICAgICAgICBlbmRwb2ludDogcmVxLnBhdGgsXG4gICAgICAgIG1ldGhvZDogcmVxLm1ldGhvZCxcbiAgICAgICAgY291bnQ6IGVudHJ5LmNvdW50LFxuICAgICAgICBtYXgsXG4gICAgICB9LCAnUmF0ZSBsaW1pdCBleGNlZWRlZCcpO1xuICAgICAgXG4gICAgICByZXMuc2V0SGVhZGVyKCdSZXRyeS1BZnRlcicsIHJldHJ5QWZ0ZXIudG9TdHJpbmcoKSk7XG4gICAgICByZXMuc2V0SGVhZGVyKCdYLVJhdGVMaW1pdC1MaW1pdCcsIG1heC50b1N0cmluZygpKTtcbiAgICAgIHJlcy5zZXRIZWFkZXIoJ1gtUmF0ZUxpbWl0LVJlbWFpbmluZycsICcwJyk7XG4gICAgICByZXMuc2V0SGVhZGVyKCdYLVJhdGVMaW1pdC1SZXNldCcsIG5ldyBEYXRlKGVudHJ5LnJlc2V0VGltZSkudG9JU09TdHJpbmcoKSk7XG4gICAgICBcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQyOSkuanNvbih7XG4gICAgICAgIGVycm9yOiBtZXNzYWdlLFxuICAgICAgICByZXRyeUFmdGVyLFxuICAgICAgfSk7XG4gICAgfVxuICAgIFxuICAgIC8vIEluY3JlbWVudCBjb3VudGVyXG4gICAgZW50cnkuY291bnQrKztcbiAgICBcbiAgICAvLyBTZXQgaGVhZGVyc1xuICAgIHJlcy5zZXRIZWFkZXIoJ1gtUmF0ZUxpbWl0LUxpbWl0JywgbWF4LnRvU3RyaW5nKCkpO1xuICAgIHJlcy5zZXRIZWFkZXIoJ1gtUmF0ZUxpbWl0LVJlbWFpbmluZycsIE1hdGgubWF4KDAsIG1heCAtIGVudHJ5LmNvdW50KS50b1N0cmluZygpKTtcbiAgICByZXMuc2V0SGVhZGVyKCdYLVJhdGVMaW1pdC1SZXNldCcsIG5ldyBEYXRlKGVudHJ5LnJlc2V0VGltZSkudG9JU09TdHJpbmcoKSk7XG4gICAgXG4gICAgLy8gSGFuZGxlIHJlc3BvbnNlIHRvIG9wdGlvbmFsbHkgc2tpcCBjb3VudGluZ1xuICAgIGlmIChza2lwU3VjY2Vzc2Z1bFJlcXVlc3RzIHx8IHNraXBGYWlsZWRSZXF1ZXN0cykge1xuICAgICAgY29uc3Qgb3JpZ2luYWxTZW5kID0gcmVzLnNlbmQ7XG4gICAgICByZXMuc2VuZCA9IGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgY29uc3Qgc2hvdWxkU2tpcCA9IFxuICAgICAgICAgIChza2lwU3VjY2Vzc2Z1bFJlcXVlc3RzICYmIHJlcy5zdGF0dXNDb2RlIDwgNDAwKSB8fFxuICAgICAgICAgIChza2lwRmFpbGVkUmVxdWVzdHMgJiYgcmVzLnN0YXR1c0NvZGUgPj0gNDAwKTtcbiAgICAgICAgXG4gICAgICAgIGlmIChzaG91bGRTa2lwICYmIGVudHJ5KSB7XG4gICAgICAgICAgZW50cnkuY291bnQgPSBNYXRoLm1heCgwLCBlbnRyeS5jb3VudCAtIDEpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gb3JpZ2luYWxTZW5kLmNhbGwodGhpcywgZGF0YSk7XG4gICAgICB9O1xuICAgIH1cbiAgICBcbiAgICBuZXh0KCk7XG4gIH07XG59XG5cbi8vIFByZS1jb25maWd1cmVkIHJhdGUgbGltaXRlcnMgZm9yIGRpZmZlcmVudCB1c2UgY2FzZXNcbmV4cG9ydCBjb25zdCByYXRlTGltaXRlcnMgPSB7XG4gIC8vIFN0cmljdCBsaW1pdCBmb3IgYXV0aGVudGljYXRpb24gZW5kcG9pbnRzXG4gIGF1dGg6IGNyZWF0ZVJhdGVMaW1pdGVyKHtcbiAgICB3aW5kb3dNczogMTUgKiA2MCAqIDEwMDAsIC8vIDE1IG1pbnV0ZXNcbiAgICBtYXg6IDUsIC8vIDUgcmVxdWVzdHMgcGVyIHdpbmRvd1xuICAgIG1lc3NhZ2U6ICdUb28gbWFueSBhdXRoZW50aWNhdGlvbiBhdHRlbXB0cy4gUGxlYXNlIHRyeSBhZ2FpbiBsYXRlci4nLFxuICAgIHNraXBTdWNjZXNzZnVsUmVxdWVzdHM6IHRydWUsIC8vIE9ubHkgY291bnQgZmFpbGVkIGF0dGVtcHRzXG4gIH0pLFxuICBcbiAgLy8gU3RhbmRhcmQgQVBJIHJhdGUgbGltaXRcbiAgYXBpOiBjcmVhdGVSYXRlTGltaXRlcih7XG4gICAgd2luZG93TXM6IDE1ICogNjAgKiAxMDAwLCAvLyAxNSBtaW51dGVzXG4gICAgbWF4OiAxMDAsIC8vIDEwMCByZXF1ZXN0cyBwZXIgd2luZG93XG4gIH0pLFxuICBcbiAgLy8gUmVsYXhlZCBsaW1pdCBmb3IgcmVhZCBvcGVyYXRpb25zXG4gIHJlYWQ6IGNyZWF0ZVJhdGVMaW1pdGVyKHtcbiAgICB3aW5kb3dNczogMTUgKiA2MCAqIDEwMDAsIC8vIDE1IG1pbnV0ZXNcbiAgICBtYXg6IDIwMCwgLy8gMjAwIHJlcXVlc3RzIHBlciB3aW5kb3dcbiAgfSksXG4gIFxuICAvLyBTdHJpY3QgbGltaXQgZm9yIHdyaXRlIG9wZXJhdGlvbnNcbiAgd3JpdGU6IGNyZWF0ZVJhdGVMaW1pdGVyKHtcbiAgICB3aW5kb3dNczogMTUgKiA2MCAqIDEwMDAsIC8vIDE1IG1pbnV0ZXNcbiAgICBtYXg6IDUwLCAvLyA1MCByZXF1ZXN0cyBwZXIgd2luZG93XG4gIH0pLFxuICBcbiAgLy8gVmVyeSBzdHJpY3QgbGltaXQgZm9yIEFJIG9wZXJhdGlvbnNcbiAgYWk6IGNyZWF0ZVJhdGVMaW1pdGVyKHtcbiAgICB3aW5kb3dNczogNjAgKiA2MCAqIDEwMDAsIC8vIDEgaG91clxuICAgIG1heDogMjAsIC8vIDIwIHJlcXVlc3RzIHBlciBob3VyXG4gICAgbWVzc2FnZTogJ0FJIGdlbmVyYXRpb24gbGltaXQgZXhjZWVkZWQuIFBsZWFzZSB0cnkgYWdhaW4gbGF0ZXIuJyxcbiAgfSksXG4gIFxuICAvLyBGaWxlIHVwbG9hZCBsaW1pdFxuICB1cGxvYWQ6IGNyZWF0ZVJhdGVMaW1pdGVyKHtcbiAgICB3aW5kb3dNczogNjAgKiA2MCAqIDEwMDAsIC8vIDEgaG91clxuICAgIG1heDogMTAsIC8vIDEwIHVwbG9hZHMgcGVyIGhvdXJcbiAgICBtZXNzYWdlOiAnRmlsZSB1cGxvYWQgbGltaXQgZXhjZWVkZWQuIFBsZWFzZSB0cnkgYWdhaW4gbGF0ZXIuJyxcbiAgfSksXG59OyJdLCJ2ZXJzaW9uIjozfQ==