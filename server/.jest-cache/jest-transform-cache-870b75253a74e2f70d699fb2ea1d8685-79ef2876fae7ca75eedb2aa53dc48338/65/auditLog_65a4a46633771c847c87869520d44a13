d7887bf54dd248ecd94fe5831986aa74
import logger from '../logger';
export function createAuditLog(options) {
    return async (req, res, next) => {
        const startTime = Date.now();
        const auditEntry = {
            action: options.action,
            resourceType: options.resourceType,
            resourceId: req.params.id || req.params.studentId || null,
            userId: req.user?.id || null,
            ipAddress: req.ip || req.connection.remoteAddress || 'unknown',
            userAgent: req.headers['user-agent'] || 'unknown',
            method: req.method,
            path: req.path,
            timestamp: new Date(),
            requestBody: options.includeRequestBody && !options.sensitiveData ? req.body : undefined,
            responseStatus: 0,
            duration: 0,
        };
        // Log response when it's sent
        const originalSend = res.send;
        res.send = function (data) {
            auditEntry.responseStatus = res.statusCode;
            auditEntry.duration = Date.now() - startTime;
            // Log to database asynchronously
            if (options.sensitiveData || auditEntry.responseStatus < 400) {
                logAuditEntry(auditEntry).catch((error) => {
                    logger.error({ error, auditEntry }, 'Failed to create audit log entry');
                });
            }
            return originalSend.call(this, data);
        };
        next();
    };
}
async function logAuditEntry(entry) {
    try {
        // AuditLog model archived - audit logging disabled in ETFO migration
        console.log('Audit log entry (model archived):', {
            action: entry.action,
            resourceType: entry.resourceType,
            resourceId: entry.resourceId,
            userId: entry.userId,
            ipAddress: entry.ipAddress,
            userAgent: entry.userAgent,
            method: entry.method,
            path: entry.path,
            requestBody: entry.requestBody ? '[LOGGED TO CONSOLE ONLY]' : null,
            responseStatus: entry.responseStatus,
            duration: entry.duration,
            timestamp: entry.timestamp,
        });
    }
    catch (error) {
        // If audit log table doesn't exist, just log to console
        logger.warn({ entry }, 'Audit log entry (table may not exist)');
    }
}
// Pre-configured audit loggers for different operations
export const auditLoggers = {
    // Student data access
    studentView: createAuditLog({
        action: 'VIEW_STUDENT',
        resourceType: 'student',
        sensitiveData: true,
    }),
    studentCreate: createAuditLog({
        action: 'CREATE_STUDENT',
        resourceType: 'student',
        sensitiveData: true,
        includeRequestBody: true,
    }),
    studentUpdate: createAuditLog({
        action: 'UPDATE_STUDENT',
        resourceType: 'student',
        sensitiveData: true,
        includeRequestBody: true,
    }),
    studentDelete: createAuditLog({
        action: 'DELETE_STUDENT',
        resourceType: 'student',
        sensitiveData: true,
    }),
    // Parent communication
    parentSummaryView: createAuditLog({
        action: 'VIEW_PARENT_SUMMARY',
        resourceType: 'parent_summary',
        sensitiveData: true,
    }),
    parentSummaryCreate: createAuditLog({
        action: 'CREATE_PARENT_SUMMARY',
        resourceType: 'parent_summary',
        sensitiveData: true,
    }),
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9taWRkbGV3YXJlL2F1ZGl0TG9nLnRzIiwibWFwcGluZ3MiOiJBQUNBLE9BQU8sTUFBTSxNQUFNLFdBQVcsQ0FBQztBQVUvQixNQUFNLFVBQVUsY0FBYyxDQUFDLE9BQXdCO0lBQ3JELE9BQU8sS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBa0IsRUFBRSxFQUFFO1FBQy9ELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUM3QixNQUFNLFVBQVUsR0FBRztZQUNqQixNQUFNLEVBQUUsT0FBTyxDQUFDLE1BQU07WUFDdEIsWUFBWSxFQUFFLE9BQU8sQ0FBQyxZQUFZO1lBQ2xDLFVBQVUsRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLFNBQVMsSUFBSSxJQUFJO1lBQ3pELE1BQU0sRUFBRSxHQUFHLENBQUMsSUFBSSxFQUFFLEVBQUUsSUFBSSxJQUFJO1lBQzVCLFNBQVMsRUFBRSxHQUFHLENBQUMsRUFBRSxJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUMsYUFBYSxJQUFJLFNBQVM7WUFDOUQsU0FBUyxFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUksU0FBUztZQUNqRCxNQUFNLEVBQUUsR0FBRyxDQUFDLE1BQU07WUFDbEIsSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJO1lBQ2QsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO1lBQ3JCLFdBQVcsRUFBRSxPQUFPLENBQUMsa0JBQWtCLElBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxTQUFTO1lBQ3hGLGNBQWMsRUFBRSxDQUFDO1lBQ2pCLFFBQVEsRUFBRSxDQUFDO1NBQ1osQ0FBQztRQUVGLDhCQUE4QjtRQUM5QixNQUFNLFlBQVksR0FBRyxHQUFH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QztJQUVGLG1CQUFtQixFQUFFLGNBQWMsQ0FBQztRQUNsQyxNQUFNLEVBQUUsdUJBQXVCO1FBQy9CLFlBQVksRUFBRSxnQkFBZ0I7UUFDOUIsYUFBYSxFQUFFLElBQUk7S0FDcEIsQ0FBQztDQUNILENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9taWRkbGV3YXJlL2F1ZGl0TG9nLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlcXVlc3QsIFJlc3BvbnNlLCBOZXh0RnVuY3Rpb24gfSBmcm9tICdleHByZXNzJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi4vbG9nZ2VyJztcblxuaW50ZXJmYWNlIEF1ZGl0TG9nT3B0aW9ucyB7XG4gIGFjdGlvbjogc3RyaW5nO1xuICByZXNvdXJjZVR5cGU6ICdzdHVkZW50JyB8ICdwYXJlbnRfc3VtbWFyeScgfCAnbGVzc29uX3BsYW4nIHwgJ3VuaXRfcGxhbicgfCAnY3VycmljdWx1bScgfCAndXNlcic7XG4gIHNlbnNpdGl2ZURhdGE/OiBib29sZWFuO1xuICBpbmNsdWRlUmVxdWVzdEJvZHk/OiBib29sZWFuO1xuICBpbmNsdWRlUmVzcG9uc2VTdGF0dXM/OiBib29sZWFuO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlQXVkaXRMb2cob3B0aW9uczogQXVkaXRMb2dPcHRpb25zKSB7XG4gIHJldHVybiBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIGNvbnN0IGF1ZGl0RW50cnkgPSB7XG4gICAgICBhY3Rpb246IG9wdGlvbnMuYWN0aW9uLFxuICAgICAgcmVzb3VyY2VUeXBlOiBvcHRpb25zLnJlc291cmNlVHlwZSxcbiAgICAgIHJlc291cmNlSWQ6IHJlcS5wYXJhbXMuaWQgfHwgcmVxLnBhcmFtcy5zdHVkZW50SWQgfHwgbnVsbCxcbiAgICAgIHVzZXJJZDogcmVxLnVzZXI/LmlkIHx8IG51bGwsXG4gICAgICBpcEFkZHJlc3M6IHJlcS5pcCB8fCByZXEuY29ubmVjdGlvbi5yZW1vdGVBZGRyZXNzIHx8ICd1bmtub3duJyxcbiAgICAgIHVzZXJBZ2VudDogcmVxLmhlYWRlcnNbJ3VzZXItYWdlbnQnXSB8fCAndW5rbm93bicsXG4gICAgICBtZXRob2Q6IHJlcS5tZXRob2QsXG4gICAgICBwYXRoOiByZXEucGF0aCxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgIHJlcXVlc3RCb2R5OiBvcHRpb25zLmluY2x1ZGVSZXF1ZXN0Qm9keSAmJiAhb3B0aW9ucy5zZW5zaXRpdmVEYXRhID8gcmVxLmJvZHkgOiB1bmRlZmluZWQsXG4gICAgICByZXNwb25zZVN0YXR1czogMCxcbiAgICAgIGR1cmF0aW9uOiAwLFxuICAgIH07XG5cbiAgICAvLyBMb2cgcmVzcG9uc2Ugd2hlbiBpdCdzIHNlbnRcbiAgICBjb25zdCBvcmlnaW5hbFNlbmQgPSByZXMuc2VuZDtcbiAgICByZXMuc2VuZCA9IGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICBhdWRpdEVudHJ5LnJlc3BvbnNlU3RhdHVzID0gcmVzLnN0YXR1c0NvZGU7XG4gICAgICBhdWRpdEVudHJ5LmR1cmF0aW9uID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcblxuICAgICAgLy8gTG9nIHRvIGRhdGFiYXNlIGFzeW5jaHJvbm91c2x5XG4gICAgICBpZiAob3B0aW9ucy5zZW5zaXRpdmVEYXRhIHx8IGF1ZGl0RW50cnkucmVzcG9uc2VTdGF0dXMgPCA0MDApIHtcbiAgICAgICAgbG9nQXVkaXRFbnRyeShhdWRpdEVudHJ5KS5jYXRjaCgoZXJyb3IpID0+IHtcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoeyBlcnJvciwgYXVkaXRFbnRyeSB9LCAnRmFpbGVkIHRvIGNyZWF0ZSBhdWRpdCBsb2cgZW50cnknKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBvcmlnaW5hbFNlbmQuY2FsbCh0aGlzLCBkYXRhKTtcbiAgICB9O1xuXG4gICAgbmV4dCgpO1xuICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBsb2dBdWRpdEVudHJ5KGVudHJ5OiB7XG4gIGFjdGlvbjogc3RyaW5nO1xuICByZXNvdXJjZVR5cGU6IHN0cmluZztcbiAgcmVzb3VyY2VJZDogc3RyaW5nIHwgbnVsbDtcbiAgdXNlcklkOiBudW1iZXIgfCBudWxsO1xuICBpcEFkZHJlc3M6IHN0cmluZztcbiAgdXNlckFnZW50OiBzdHJpbmc7XG4gIG1ldGhvZDogc3RyaW5nO1xuICBwYXRoOiBzdHJpbmc7XG4gIHRpbWVzdGFtcDogRGF0ZTtcbiAgcmVxdWVzdEJvZHk/OiB1bmtub3duO1xuICByZXNwb25zZVN0YXR1czogbnVtYmVyO1xuICBkdXJhdGlvbjogbnVtYmVyO1xufSkge1xuICB0cnkge1xuICAgIC8vIEF1ZGl0TG9nIG1vZGVsIGFyY2hpdmVkIC0gYXVkaXQgbG9nZ2luZyBkaXNhYmxlZCBpbiBFVEZPIG1pZ3JhdGlvblxuICAgIGNvbnNvbGUubG9nKCdBdWRpdCBsb2cgZW50cnkgKG1vZGVsIGFyY2hpdmVkKTonLCB7XG4gICAgICBhY3Rpb246IGVudHJ5LmFjdGlvbixcbiAgICAgIHJlc291cmNlVHlwZTogZW50cnkucmVzb3VyY2VUeXBlLFxuICAgICAgcmVzb3VyY2VJZDogZW50cnkucmVzb3VyY2VJZCxcbiAgICAgIHVzZXJJZDogZW50cnkudXNlcklkLFxuICAgICAgaXBBZGRyZXNzOiBlbnRyeS5pcEFkZHJlc3MsXG4gICAgICB1c2VyQWdlbnQ6IGVudHJ5LnVzZXJBZ2VudCxcbiAgICAgIG1ldGhvZDogZW50cnkubWV0aG9kLFxuICAgICAgcGF0aDogZW50cnkucGF0aCxcbiAgICAgIHJlcXVlc3RCb2R5OiBlbnRyeS5yZXF1ZXN0Qm9keSA/ICdbTE9HR0VEIFRPIENPTlNPTEUgT05MWV0nIDogbnVsbCxcbiAgICAgIHJlc3BvbnNlU3RhdHVzOiBlbnRyeS5yZXNwb25zZVN0YXR1cyxcbiAgICAgIGR1cmF0aW9uOiBlbnRyeS5kdXJhdGlvbixcbiAgICAgIHRpbWVzdGFtcDogZW50cnkudGltZXN0YW1wLFxuICAgIH0pO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIC8vIElmIGF1ZGl0IGxvZyB0YWJsZSBkb2Vzbid0IGV4aXN0LCBqdXN0IGxvZyB0byBjb25zb2xlXG4gICAgbG9nZ2VyLndhcm4oeyBlbnRyeSB9LCAnQXVkaXQgbG9nIGVudHJ5ICh0YWJsZSBtYXkgbm90IGV4aXN0KScpO1xuICB9XG59XG5cbi8vIFByZS1jb25maWd1cmVkIGF1ZGl0IGxvZ2dlcnMgZm9yIGRpZmZlcmVudCBvcGVyYXRpb25zXG5leHBvcnQgY29uc3QgYXVkaXRMb2dnZXJzID0ge1xuICAvLyBTdHVkZW50IGRhdGEgYWNjZXNzXG4gIHN0dWRlbnRWaWV3OiBjcmVhdGVBdWRpdExvZyh7XG4gICAgYWN0aW9uOiAnVklFV19TVFVERU5UJyxcbiAgICByZXNvdXJjZVR5cGU6ICdzdHVkZW50JyxcbiAgICBzZW5zaXRpdmVEYXRhOiB0cnVlLFxuICB9KSxcblxuICBzdHVkZW50Q3JlYXRlOiBjcmVhdGVBdWRpdExvZyh7XG4gICAgYWN0aW9uOiAnQ1JFQVRFX1NUVURFTlQnLFxuICAgIHJlc291cmNlVHlwZTogJ3N0dWRlbnQnLFxuICAgIHNlbnNpdGl2ZURhdGE6IHRydWUsXG4gICAgaW5jbHVkZVJlcXVlc3RCb2R5OiB0cnVlLFxuICB9KSxcblxuICBzdHVkZW50VXBkYXRlOiBjcmVhdGVBdWRpdExvZyh7XG4gICAgYWN0aW9uOiAnVVBEQVRFX1NUVURFTlQnLFxuICAgIHJlc291cmNlVHlwZTogJ3N0dWRlbnQnLFxuICAgIHNlbnNpdGl2ZURhdGE6IHRydWUsXG4gICAgaW5jbHVkZVJlcXVlc3RCb2R5OiB0cnVlLFxuICB9KSxcblxuICBzdHVkZW50RGVsZXRlOiBjcmVhdGVBdWRpdExvZyh7XG4gICAgYWN0aW9uOiAnREVMRVRFX1NUVURFTlQnLFxuICAgIHJlc291cmNlVHlwZTogJ3N0dWRlbnQnLFxuICAgIHNlbnNpdGl2ZURhdGE6IHRydWUsXG4gIH0pLFxuXG4gIC8vIFBhcmVudCBjb21tdW5pY2F0aW9uXG4gIHBhcmVudFN1bW1hcnlWaWV3OiBjcmVhdGVBdWRpdExvZyh7XG4gICAgYWN0aW9uOiAnVklFV19QQVJFTlRfU1VNTUFSWScsXG4gICAgcmVzb3VyY2VUeXBlOiAncGFyZW50X3N1bW1hcnknLFxuICAgIHNlbnNpdGl2ZURhdGE6IHRydWUsXG4gIH0pLFxuXG4gIHBhcmVudFN1bW1hcnlDcmVhdGU6IGNyZWF0ZUF1ZGl0TG9nKHtcbiAgICBhY3Rpb246ICdDUkVBVEVfUEFSRU5UX1NVTU1BUlknLFxuICAgIHJlc291cmNlVHlwZTogJ3BhcmVudF9zdW1tYXJ5JyxcbiAgICBzZW5zaXRpdmVEYXRhOiB0cnVlLFxuICB9KSxcbn07XG4iXSwidmVyc2lvbiI6M30=