f5571b11dbd50a64f060363244e1885b
import request from 'supertest';
import bcrypt from 'bcryptjs';
import jwt from 'jsonwebtoken';
import { getTestPrismaClient } from './jest.setup.js';
/**
 * Helper to create a test user and get authentication token
 */
export async function getAuthToken(app, email) {
    const prisma = getTestPrismaClient();
    // Generate unique email if not provided
    const userEmail = email || `test-${Date.now()}-${Math.random().toString(36).substring(7)}@example.com`;
    // Create a test user with hashed password
    const hashedPassword = await bcrypt.hash('testpassword', 10);
    const user = await prisma.user.create({
        data: {
            email: userEmail,
            name: 'Test User',
            password: hashedPassword,
            role: 'teacher',
        },
    });
    // Login to get token
    const loginResponse = await request(app).post('/api/login').send({
        email: userEmail,
        password: 'testpassword',
    });
    if (loginResponse.status !== 200) {
        throw new Error(`Login failed: ${loginResponse.status} ${loginResponse.text}`);
    }
    return { token: loginResponse.body.token, userId: user.id };
}
/**
 * Helper to make authenticated requests
 */
export function authRequest(app) {
    let token = null;
    let userId = null;
    return {
        async setup() {
            const authData = await getAuthToken(app);
            token = authData.token;
            userId = authData.userId;
        },
        get userId() {
            return userId;
        },
        get(url) {
            return request(app).get(url).set('Authorization', `Bearer ${token}`);
        },
        post(url) {
            return request(app).post(url).set('Authorization', `Bearer ${token}`);
        },
        put(url) {
            return request(app).put(url).set('Authorization', `Bearer ${token}`);
        },
        delete(url) {
            return request(app).delete(url).set('Authorization', `Bearer ${token}`);
        },
        patch(url) {
            return request(app).patch(url).set('Authorization', `Bearer ${token}`);
        },
    };
}
/**
 * Create a test user without going through HTTP
 */
export async function createTestUser(email) {
    const prisma = getTestPrismaClient();
    // Generate unique email if not provided
    const userEmail = email || `test-${Date.now()}-${Math.random().toString(36).substring(7)}@example.com`;
    const hashedPassword = await bcrypt.hash('testpassword', 10);
    return await prisma.user.create({
        data: {
            email: userEmail,
            name: 'Test User',
            password: hashedPassword,
            role: 'teacher',
        },
    });
}
/**
 * Create an auth token for a user ID
 */
export function createAuthToken(userId) {
    const secret = process.env.JWT_SECRET;
    if (!secret) {
        throw new Error('JWT_SECRET environment variable is required for testing');
    }
    return jwt.sign({ userId: userId.toString() }, secret, { expiresIn: '24h' });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3Rlc3RzL3Rlc3QtYXV0aC1oZWxwZXIudHMiLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxPQUFPLE1BQU0sV0FBVyxDQUFDO0FBRWhDLE9BQU8sTUFBTSxNQUFNLFVBQVUsQ0FBQztBQUM5QixPQUFPLEdBQUcsTUFBTSxjQUFjLENBQUM7QUFDL0IsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFdEQ7O0dBRUc7QUFDSCxNQUFNLENBQUMsS0FBSyxVQUFVLFlBQVksQ0FBQyxHQUFnQixFQUFFLEtBQWM7SUFDakUsTUFBTSxNQUFNLEdBQUcsbUJBQW1CLEVBQUUsQ0FBQztJQUVyQyx3Q0FBd0M7SUFDeEMsTUFBTSxTQUFTLEdBQUcsS0FBSyxJQUFJLFFBQVEsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUM7SUFFdkcsMENBQTBDO0lBQzFDLE1BQU0sY0FBYyxHQUFHLE1BQU0sTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDN0QsTUFBTSxJQUFJLEdBQUcsTUFBTSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUNwQyxJQUFJLEVBQUU7WUFDSixLQUFLLEVBQUUsU0FBUztZQUNoQixJQUFJLEVBQUUsV0FBVztZQUNqQixRQUFRLEVBQUUsY0FBYztZQUN4QixJQUFJLEVBQUUsU0FBUztTQUNoQjtLQUNGLENBQUMsQ0FBQztJQUVILHFCQUFxQjtJQUNyQixNQUFNLGFBQWEsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQy9ELEtBQUssRUFBRSxTQUFTO1FBQ2hCLFFBQVEsRUFBRSxjQUFjO0tBQ3pC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QUM1QyxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQztJQUN0QyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDWixNQUFNLElBQUksS0FBSyxDQUFDLHlEQUF5RCxDQUFDLENBQUM7SUFDN0UsQ0FBQztJQUNELE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUMsUUFBUSxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztBQUMvRSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9taWNoYWVsbWNpc2FhYy9HaXRIdWIvdGVhY2hpbmctZW5naW5lMi4wL3NlcnZlci90ZXN0cy90ZXN0LWF1dGgtaGVscGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCByZXF1ZXN0IGZyb20gJ3N1cGVydGVzdCc7XG5pbXBvcnQgdHlwZSB7IEFwcGxpY2F0aW9uIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgYmNyeXB0IGZyb20gJ2JjcnlwdGpzJztcbmltcG9ydCBqd3QgZnJvbSAnanNvbndlYnRva2VuJztcbmltcG9ydCB7IGdldFRlc3RQcmlzbWFDbGllbnQgfSBmcm9tICcuL2plc3Quc2V0dXAuanMnO1xuXG4vKipcbiAqIEhlbHBlciB0byBjcmVhdGUgYSB0ZXN0IHVzZXIgYW5kIGdldCBhdXRoZW50aWNhdGlvbiB0b2tlblxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0QXV0aFRva2VuKGFwcDogQXBwbGljYXRpb24sIGVtYWlsPzogc3RyaW5nKTogUHJvbWlzZTx7IHRva2VuOiBzdHJpbmc7IHVzZXJJZDogbnVtYmVyIH0+IHtcbiAgY29uc3QgcHJpc21hID0gZ2V0VGVzdFByaXNtYUNsaWVudCgpO1xuXG4gIC8vIEdlbmVyYXRlIHVuaXF1ZSBlbWFpbCBpZiBub3QgcHJvdmlkZWRcbiAgY29uc3QgdXNlckVtYWlsID0gZW1haWwgfHwgYHRlc3QtJHtEYXRlLm5vdygpfS0ke01hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cmluZyg3KX1AZXhhbXBsZS5jb21gO1xuXG4gIC8vIENyZWF0ZSBhIHRlc3QgdXNlciB3aXRoIGhhc2hlZCBwYXNzd29yZFxuICBjb25zdCBoYXNoZWRQYXNzd29yZCA9IGF3YWl0IGJjcnlwdC5oYXNoKCd0ZXN0cGFzc3dvcmQnLCAxMCk7XG4gIGNvbnN0IHVzZXIgPSBhd2FpdCBwcmlzbWEudXNlci5jcmVhdGUoe1xuICAgIGRhdGE6IHtcbiAgICAgIGVtYWlsOiB1c2VyRW1haWwsXG4gICAgICBuYW1lOiAnVGVzdCBVc2VyJyxcbiAgICAgIHBhc3N3b3JkOiBoYXNoZWRQYXNzd29yZCxcbiAgICAgIHJvbGU6ICd0ZWFjaGVyJyxcbiAgICB9LFxuICB9KTtcblxuICAvLyBMb2dpbiB0byBnZXQgdG9rZW5cbiAgY29uc3QgbG9naW5SZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKS5wb3N0KCcvYXBpL2xvZ2luJykuc2VuZCh7XG4gICAgZW1haWw6IHVzZXJFbWFpbCxcbiAgICBwYXNzd29yZDogJ3Rlc3RwYXNzd29yZCcsXG4gIH0pO1xuXG4gIGlmIChsb2dpblJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBMb2dpbiBmYWlsZWQ6ICR7bG9naW5SZXNwb25zZS5zdGF0dXN9ICR7bG9naW5SZXNwb25zZS50ZXh0fWApO1xuICB9XG5cbiAgcmV0dXJuIHsgdG9rZW46IGxvZ2luUmVzcG9uc2UuYm9keS50b2tlbiwgdXNlcklkOiB1c2VyLmlkIH07XG59XG5cbi8qKlxuICogSGVscGVyIHRvIG1ha2UgYXV0aGVudGljYXRlZCByZXF1ZXN0c1xuICovXG5leHBvcnQgZnVuY3Rpb24gYXV0aFJlcXVlc3QoYXBwOiBBcHBsaWNhdGlvbikge1xuICBsZXQgdG9rZW46IHN0cmluZyB8IG51bGwgPSBudWxsO1xuICBsZXQgdXNlcklkOiBudW1iZXIgfCBudWxsID0gbnVsbDtcblxuICByZXR1cm4ge1xuICAgIGFzeW5jIHNldHVwKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgY29uc3QgYXV0aERhdGEgPSBhd2FpdCBnZXRBdXRoVG9rZW4oYXBwKTtcbiAgICAgIHRva2VuID0gYXV0aERhdGEudG9rZW47XG4gICAgICB1c2VySWQgPSBhdXRoRGF0YS51c2VySWQ7XG4gICAgfSxcbiAgICBnZXQgdXNlcklkKCkge1xuICAgICAgcmV0dXJuIHVzZXJJZDtcbiAgICB9LFxuICAgIGdldCh1cmw6IHN0cmluZykge1xuICAgICAgcmV0dXJuIHJlcXVlc3QoYXBwKS5nZXQodXJsKS5zZXQoJ0F1dGhvcml6YXRpb24nLCBgQmVhcmVyICR7dG9rZW59YCk7XG4gICAgfSxcbiAgICBwb3N0KHVybDogc3RyaW5nKSB7XG4gICAgICByZXR1cm4gcmVxdWVzdChhcHApLnBvc3QodXJsKS5zZXQoJ0F1dGhvcml6YXRpb24nLCBgQmVhcmVyICR7dG9rZW59YCk7XG4gICAgfSxcbiAgICBwdXQodXJsOiBzdHJpbmcpIHtcbiAgICAgIHJldHVybiByZXF1ZXN0KGFwcCkucHV0KHVybCkuc2V0KCdBdXRob3JpemF0aW9uJywgYEJlYXJlciAke3Rva2VufWApO1xuICAgIH0sXG4gICAgZGVsZXRlKHVybDogc3RyaW5nKSB7XG4gICAgICByZXR1cm4gcmVxdWVzdChhcHApLmRlbGV0ZSh1cmwpLnNldCgnQXV0aG9yaXphdGlvbicsIGBCZWFyZXIgJHt0b2tlbn1gKTtcbiAgICB9LFxuICAgIHBhdGNoKHVybDogc3RyaW5nKSB7XG4gICAgICByZXR1cm4gcmVxdWVzdChhcHApLnBhdGNoKHVybCkuc2V0KCdBdXRob3JpemF0aW9uJywgYEJlYXJlciAke3Rva2VufWApO1xuICAgIH0sXG4gIH07XG59XG5cbi8qKlxuICogQ3JlYXRlIGEgdGVzdCB1c2VyIHdpdGhvdXQgZ29pbmcgdGhyb3VnaCBIVFRQXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVUZXN0VXNlcihlbWFpbD86IHN0cmluZykge1xuICBjb25zdCBwcmlzbWEgPSBnZXRUZXN0UHJpc21hQ2xpZW50KCk7XG4gIFxuICAvLyBHZW5lcmF0ZSB1bmlxdWUgZW1haWwgaWYgbm90IHByb3ZpZGVkXG4gIGNvbnN0IHVzZXJFbWFpbCA9IGVtYWlsIHx8IGB0ZXN0LSR7RGF0ZS5ub3coKX0tJHtNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHJpbmcoNyl9QGV4YW1wbGUuY29tYDtcbiAgXG4gIGNvbnN0IGhhc2hlZFBhc3N3b3JkID0gYXdhaXQgYmNyeXB0Lmhhc2goJ3Rlc3RwYXNzd29yZCcsIDEwKTtcbiAgcmV0dXJuIGF3YWl0IHByaXNtYS51c2VyLmNyZWF0ZSh7XG4gICAgZGF0YToge1xuICAgICAgZW1haWw6IHVzZXJFbWFpbCxcbiAgICAgIG5hbWU6ICdUZXN0IFVzZXInLFxuICAgICAgcGFzc3dvcmQ6IGhhc2hlZFBhc3N3b3JkLFxuICAgICAgcm9sZTogJ3RlYWNoZXInLFxuICAgIH0sXG4gIH0pO1xufVxuXG4vKipcbiAqIENyZWF0ZSBhbiBhdXRoIHRva2VuIGZvciBhIHVzZXIgSURcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUF1dGhUb2tlbih1c2VySWQ6IG51bWJlcik6IHN0cmluZyB7XG4gIGNvbnN0IHNlY3JldCA9IHByb2Nlc3MuZW52LkpXVF9TRUNSRVQ7XG4gIGlmICghc2VjcmV0KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdKV1RfU0VDUkVUIGVudmlyb25tZW50IHZhcmlhYmxlIGlzIHJlcXVpcmVkIGZvciB0ZXN0aW5nJyk7XG4gIH1cbiAgcmV0dXJuIGp3dC5zaWduKHsgdXNlcklkOiB1c2VySWQudG9TdHJpbmcoKSB9LCBzZWNyZXQsIHsgZXhwaXJlc0luOiAnMjRoJyB9KTtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==