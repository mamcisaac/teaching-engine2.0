75306ff32d28b5b6ec2887314d4c7751
import * as nodemailer from 'nodemailer';
import { createEmailTestProvider, InMemoryTestProvider } from './emailTestHelper';
export class TestEmailService {
    transporter = null;
    testProvider;
    constructor() {
        this.testProvider = createEmailTestProvider();
        this.setupTransporter();
    }
    setupTransporter() {
        if (this.testProvider instanceof InMemoryTestProvider) {
            // For in-memory provider, we'll intercept the send calls
            this.transporter = nodemailer.createTransport({
                streamTransport: true,
                newline: 'unix',
                buffer: true,
            });
        }
        else {
            // For MailHog, use real SMTP
            this.transporter = nodemailer.createTransport({
                host: this.testProvider.host,
                port: this.testProvider.port,
                secure: false,
                auth: this.testProvider.user ? {
                    user: this.testProvider.user,
                    pass: this.testProvider.pass,
                } : undefined,
            });
        }
    }
    async sendEmail(to, subject, text, html, attachment) {
        if (!this.transporter) {
            throw new Error('Email transporter not configured');
        }
        // Basic email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(to)) {
            throw new Error(`Invalid email address: ${to}`);
        }
        if (this.testProvider instanceof InMemoryTestProvider) {
            // For in-memory testing, add directly to provider
            this.testProvider.addEmail({
                from: process.env.EMAIL_FROM || 'no-reply@example.com',
                to: [to],
                subject,
                text,
                html,
                attachments: attachment ? [{
                        filename: attachment.filename,
                        content: attachment.content,
                        contentType: 'application/pdf',
                    }] : undefined,
            });
        }
        else {
            // For MailHog, send via SMTP
            await this.transporter.sendMail({
                from: process.env.EMAIL_FROM || 'no-reply@example.com',
                to,
                subject,
                text,
                html,
                attachments: attachment ? [attachment] : undefined,
            });
        }
    }
    async sendBulkEmails(recipients, subject, text, attachment) {
        const failed = [];
        let sent = 0;
        for (const recipient of recipients) {
            try {
                await this.sendEmail(recipient, subject, text, undefined, attachment);
                sent++;
            }
            catch (error) {
                console.error(`Failed to send email to ${recipient}:`, error);
                failed.push(recipient);
            }
        }
        return { sent, failed };
    }
    async sendEmailWithRetry(to, subject, text, attachment, maxRetries = 3, retryDelay = 1000) {
        let lastError = null;
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                await this.sendEmail(to, subject, text, undefined, attachment);
                return; // Success
            }
            catch (error) {
                lastError = error;
                console.warn(`Email send attempt ${attempt} failed:`, error);
                if (attempt < maxRetries) {
                    await new Promise(resolve => setTimeout(resolve, retryDelay * attempt));
                }
            }
        }
        throw new Error(`Failed to send email after ${maxRetries} attempts: ${lastError?.message}`);
    }
    // Test helper methods
    async getTestProvider() {
        return this.testProvider;
    }
    async clearEmails() {
        await this.testProvider.clearEmails();
    }
    async waitForEmail(to, timeout) {
        return this.testProvider.waitForEmail(to, timeout);
    }
    async getEmails() {
        return this.testProvider.getEmails();
    }
    async close() {
        if (this.transporter) {
            this.transporter.close();
        }
    }
}
// Global instance for tests
let testEmailService = null;
export function getTestEmailService() {
    if (!testEmailService) {
        testEmailService = new TestEmailService();
    }
    return testEmailService;
}
export async function resetTestEmailService() {
    if (testEmailService) {
        await testEmailService.clearEmails();
        await testEmailService.close();
        testEmailService = null;
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3Rlc3RzL2hlbHBlcnMvdGVzdEVtYWlsU2VydmljZS50cyIsIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssVUFBVSxNQUFNLFlBQVksQ0FBQztBQUV6QyxPQUFPLEVBQUUsdUJBQXVCLEVBQXFCLG9CQUFvQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFckcsTUFBTSxPQUFPLGdCQUFnQjtJQUNuQixXQUFXLEdBQWtDLElBQUksQ0FBQztJQUNsRCxZQUFZLENBQW9CO0lBRXhDO1FBQ0UsSUFBSSxDQUFDLFlBQVksR0FBRyx1QkFBdUIsRUFBRSxDQUFDO1FBQzlDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFFTyxnQkFBZ0I7UUFDdEIsSUFBSSxJQUFJLENBQUMsWUFBWSxZQUFZLG9CQUFvQixFQUFFLENBQUM7WUFDdEQseURBQXlEO1lBQ3pELElBQUksQ0FBQyxXQUFXLEdBQUcsVUFBVSxDQUFDLGVBQWUsQ0FBQztnQkFDNUMsZUFBZSxFQUFFLElBQUk7Z0JBQ3JCLE9BQU8sRUFBRSxNQUFNO2dCQUNmLE1BQU0sRUFBRSxJQUFJO2FBQ2IsQ0FBQyxDQUFDO1FBQ0wsQ0FBQzthQUFNLENBQUM7WUFDTiw2QkFBNkI7WUFDN0IsSUFBSSxDQUFDLFdBQVcsR0FBRyxVQUFVLENBQUMsZUFBZSxDQUFDO2dCQUM1QyxJQUFJLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJO2dCQUM1QixJQUFJLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJO2dCQUM1QixNQUFNLEVBQUUsS0FBSztnQkFDYixJQUFJLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO29CQUM3QixJQUFJLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJO29CQUM1QixJQUFJLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJO2lCQUM3QixDQUFDLENBQUMsQ0FBQyxTQUFTO2FBQ2QsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztJQUNILENBQUM7SUFFRCxLQUFLLENBQUMsU0FBUyxDQUNiLEVBQVUsRUFDVixPQUFlLEVBQ2YsSUFBWSxFQUNaLElBQWEsRUFDYixVQUE0QjtRQUU1QixJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ3RCLE1BQU0sSUFBSSxLQUFLLENBQUMsa0NBQWtDLENBQUMsQ0FBQztRQUN0RCxDQUFDO1FBRUQseUJBQXlCO1FBQ3pCLE1BQU0sVUFBVSxHQUFHLDRCQUE0QixDQUFDO1FBQ2hELElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUM7WUFDekIsTUFBTSxJQUFJLEtBQUssQ0FBQywwQkFBMEIsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNsRCxDQUFDO1FBRUQsSUFBSSxJQUFJLENBQUMsWUFBWSxZQUFZLG9CQUFvQixFQUFFLENBQUM7WUFDdEQsa0RBQWtEO1lBQ2xELElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDO2dCQUN6QixJQUFJLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksc0JBQXNCO2dCQUN0RCxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUM7Z0JBQ1IsT0FBTztnQkFDUCxJQUFJO2dCQUNKLElBQUk7Z0JBQ0osV0FBVyxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDekIsUUFBUSxFQUFFLFVBQVUsQ0FBQyxRQUFRO3dCQUM3QixPQUFPLEVBQUUsVUFBVSxDQUFDLE9BQU87d0JBQzNCLFdBQVcsRUFBRSxpQkFBaUI7cUJBQy9CLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUzthQUNmLENBQUMsQ0FBQztRQUNMLENBQUM7YUFBTSxDQUFDO1lBQ04sNkJBQTZCO1lBQzdCLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUM7Z0JBQzlCLElBQUksRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsSUFBSSxzQkFBc0I7Z0JBQ3RELEVBQUU7Z0JBQ0YsT0FBTztnQkFDUCxJQUFJO2dCQUNKLElBQUk7Z0JBQ0osV0FBVyxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUzthQUNuRCxDQUFDLENBQUM7UUFDTCxDQUFDO0lBQ0gsQ0FBQztJQUVELEtBQUssQ0FBQyxjQUFjLENBQ2xCLFVBQW9CLEVBQ3BCLE9BQWUsRUFDZixJQUFZLEVBQ1osVUFBNEI7UUFFNUIsTUFBTSxNQUFNLEdBQWEsRUFBRSxDQUFDO1FBQzVCLElBQUksSUFBSSxHQUFHLENBQUMsQ0FBQztRQUViLEtBQUssTUFBTSxTQUFTLElBQUksVUFBVSxFQUFFLENBQUM7WUFDbkMsSUFBSSxDQUFDO2dCQUNILE1BQU0sSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsVUFBVSxDQUFDLENBQUM7Z0JBQ3RFLElBQUksRUFBRSxDQUFDO1lBQ1QsQ0FBQztZQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7Z0JBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQywyQkFBMkIsU0FBUyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7Z0JBQzlELE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDekIsQ0FBQztRQUNILENBQUM7UUFFRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFFRCxLQUFLLENBQUMsa0JBQWtCLENBQ3RCLEVBQVUsRUFDVixPQUFlLEVBQ2YsSUFBWSxFQUNaLFVBQTRCLEVBQzVCLFVBQVUsR0FBRyxDQUFDLEVBQ2QsVUFBVSxHQUFHLElBQUk7UUFFakIsSUFBSSxTQUFTLEdBQWlCLElBQUksQ0FBQztRQUVuQyxLQUFLLElBQUksT0FBTyxHQUFHLENBQUMsRUFBRSxPQUFPLElBQUksVUFBVSxFQUFFLE9BQU8sRUFBRSxFQUFFLENBQUM7WUFDdkQsSUFBSSxDQUFDO2dCQUNILE1BQU0sSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsVUFBVSxDQUFDLENBQUM7Z0JBQy9ELE9BQU8sQ0FBQyxVQUFVO1lBQ3BCLENBQUM7WUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO2dCQUNmLFNBQVMsR0FBRyxLQUFjLENBQUM7Z0JBQzNCLE9BQU8sQ0FBQyxJQUFJLENBQUMsc0JBQXNCLE9BQU8sVUFBVSxFQUFFLEtBQUssQ0FBQyxDQUFDO2dCQUU3RCxJQUFJLE9BQU8sR0FBRyxVQUFVLEVBQUUsQ0FBQztvQkFDekIsTUFBTSxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsVUFBVSxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUM7Z0JBQzFFLENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQztRQUVELE1BQU0sSUFBSSxLQUFLLENBQUMsOEJBQThCLFVBQVUsY0FBYyxTQUFTLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQztJQUM5RixDQUFDO0lBRUQsc0JBQXNCO0lBQ3RCLEtBQUssQ0FBQyxlQUFlO1FBQ25CLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQztJQUMzQixDQUFDO0lBRUQsS0FBSyxDQUFDLFdBQVc7UUFDZixNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDeEMsQ0FBQztJQUVELEtBQUssQ0FBQyxZQUFZLENBQUMsRUFBVSxFQUFFLE9BQWdCO1FBQzdDLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3JELENBQUM7SUFFRCxLQUFLLENBQUMsU0FBUztRQUNiLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUN2QyxDQUFDO0lBRUQsS0FBSyxDQUFDLEtBQUs7UUFDVCxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNyQixJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQzNCLENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUFFRCw0QkFBNEI7QUFDNUIsSUFBSSxnQkFBZ0IsR0FBNEIsSUFBSSxDQUFDO0FBRXJELE1BQU0sVUFBVSxtQkFBbUI7SUFDakMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDdEIsZ0JBQWdCLEdBQUcsSUFBSSxnQkFBZ0IsRUFBRSxDQUFDO0lBQzVDLENBQUM7SUFDRCxPQUFPLGdCQUFnQixDQUFDO0FBQzFCLENBQUM7QUFFRCxNQUFNLENBQUMsS0FBSyxVQUFVLHFCQUFxQjtJQUN6QyxJQUFJLGdCQUFnQixFQUFFLENBQUM7UUFDckIsTUFBTSxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNyQyxNQUFNLGdCQUFnQixDQUFDLEtBQUssRUFBRSxDQUFDO1FBQy9CLGdCQUFnQixHQUFHLElBQUksQ0FBQztJQUMxQixDQUFDO0FBQ0gsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWljaGFlbG1jaXNhYWMvR2l0SHViL3RlYWNoaW5nLWVuZ2luZTIuMC9zZXJ2ZXIvdGVzdHMvaGVscGVycy90ZXN0RW1haWxTZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIG5vZGVtYWlsZXIgZnJvbSAnbm9kZW1haWxlcic7XG5pbXBvcnQgeyBFbWFpbEF0dGFjaG1lbnQgfSBmcm9tICcuLi8uLi9zcmMvc2VydmljZXMvZW1haWxTZXJ2aWNlJztcbmltcG9ydCB7IGNyZWF0ZUVtYWlsVGVzdFByb3ZpZGVyLCBUZXN0RW1haWxQcm92aWRlciwgSW5NZW1vcnlUZXN0UHJvdmlkZXIgfSBmcm9tICcuL2VtYWlsVGVzdEhlbHBlcic7XG5cbmV4cG9ydCBjbGFzcyBUZXN0RW1haWxTZXJ2aWNlIHtcbiAgcHJpdmF0ZSB0cmFuc3BvcnRlcjogbm9kZW1haWxlci5UcmFuc3BvcnRlciB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIHRlc3RQcm92aWRlcjogVGVzdEVtYWlsUHJvdmlkZXI7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy50ZXN0UHJvdmlkZXIgPSBjcmVhdGVFbWFpbFRlc3RQcm92aWRlcigpO1xuICAgIHRoaXMuc2V0dXBUcmFuc3BvcnRlcigpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXR1cFRyYW5zcG9ydGVyKCkge1xuICAgIGlmICh0aGlzLnRlc3RQcm92aWRlciBpbnN0YW5jZW9mIEluTWVtb3J5VGVzdFByb3ZpZGVyKSB7XG4gICAgICAvLyBGb3IgaW4tbWVtb3J5IHByb3ZpZGVyLCB3ZSdsbCBpbnRlcmNlcHQgdGhlIHNlbmQgY2FsbHNcbiAgICAgIHRoaXMudHJhbnNwb3J0ZXIgPSBub2RlbWFpbGVyLmNyZWF0ZVRyYW5zcG9ydCh7XG4gICAgICAgIHN0cmVhbVRyYW5zcG9ydDogdHJ1ZSxcbiAgICAgICAgbmV3bGluZTogJ3VuaXgnLFxuICAgICAgICBidWZmZXI6IHRydWUsXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gRm9yIE1haWxIb2csIHVzZSByZWFsIFNNVFBcbiAgICAgIHRoaXMudHJhbnNwb3J0ZXIgPSBub2RlbWFpbGVyLmNyZWF0ZVRyYW5zcG9ydCh7XG4gICAgICAgIGhvc3Q6IHRoaXMudGVzdFByb3ZpZGVyLmhvc3QsXG4gICAgICAgIHBvcnQ6IHRoaXMudGVzdFByb3ZpZGVyLnBvcnQsXG4gICAgICAgIHNlY3VyZTogZmFsc2UsXG4gICAgICAgIGF1dGg6IHRoaXMudGVzdFByb3ZpZGVyLnVzZXIgPyB7XG4gICAgICAgICAgdXNlcjogdGhpcy50ZXN0UHJvdmlkZXIudXNlcixcbiAgICAgICAgICBwYXNzOiB0aGlzLnRlc3RQcm92aWRlci5wYXNzLFxuICAgICAgICB9IDogdW5kZWZpbmVkLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2VuZEVtYWlsKFxuICAgIHRvOiBzdHJpbmcsXG4gICAgc3ViamVjdDogc3RyaW5nLFxuICAgIHRleHQ6IHN0cmluZyxcbiAgICBodG1sPzogc3RyaW5nLFxuICAgIGF0dGFjaG1lbnQ/OiBFbWFpbEF0dGFjaG1lbnRcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCF0aGlzLnRyYW5zcG9ydGVyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VtYWlsIHRyYW5zcG9ydGVyIG5vdCBjb25maWd1cmVkJyk7XG4gICAgfVxuXG4gICAgLy8gQmFzaWMgZW1haWwgdmFsaWRhdGlvblxuICAgIGNvbnN0IGVtYWlsUmVnZXggPSAvXlteXFxzQF0rQFteXFxzQF0rXFwuW15cXHNAXSskLztcbiAgICBpZiAoIWVtYWlsUmVnZXgudGVzdCh0bykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBlbWFpbCBhZGRyZXNzOiAke3RvfWApO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnRlc3RQcm92aWRlciBpbnN0YW5jZW9mIEluTWVtb3J5VGVzdFByb3ZpZGVyKSB7XG4gICAgICAvLyBGb3IgaW4tbWVtb3J5IHRlc3RpbmcsIGFkZCBkaXJlY3RseSB0byBwcm92aWRlclxuICAgICAgdGhpcy50ZXN0UHJvdmlkZXIuYWRkRW1haWwoe1xuICAgICAgICBmcm9tOiBwcm9jZXNzLmVudi5FTUFJTF9GUk9NIHx8ICduby1yZXBseUBleGFtcGxlLmNvbScsXG4gICAgICAgIHRvOiBbdG9dLFxuICAgICAgICBzdWJqZWN0LFxuICAgICAgICB0ZXh0LFxuICAgICAgICBodG1sLFxuICAgICAgICBhdHRhY2htZW50czogYXR0YWNobWVudCA/IFt7XG4gICAgICAgICAgZmlsZW5hbWU6IGF0dGFjaG1lbnQuZmlsZW5hbWUsXG4gICAgICAgICAgY29udGVudDogYXR0YWNobWVudC5jb250ZW50LFxuICAgICAgICAgIGNvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vcGRmJyxcbiAgICAgICAgfV0gOiB1bmRlZmluZWQsXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gRm9yIE1haWxIb2csIHNlbmQgdmlhIFNNVFBcbiAgICAgIGF3YWl0IHRoaXMudHJhbnNwb3J0ZXIuc2VuZE1haWwoe1xuICAgICAgICBmcm9tOiBwcm9jZXNzLmVudi5FTUFJTF9GUk9NIHx8ICduby1yZXBseUBleGFtcGxlLmNvbScsXG4gICAgICAgIHRvLFxuICAgICAgICBzdWJqZWN0LFxuICAgICAgICB0ZXh0LFxuICAgICAgICBodG1sLFxuICAgICAgICBhdHRhY2htZW50czogYXR0YWNobWVudCA/IFthdHRhY2htZW50XSA6IHVuZGVmaW5lZCxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHNlbmRCdWxrRW1haWxzKFxuICAgIHJlY2lwaWVudHM6IHN0cmluZ1tdLFxuICAgIHN1YmplY3Q6IHN0cmluZyxcbiAgICB0ZXh0OiBzdHJpbmcsXG4gICAgYXR0YWNobWVudD86IEVtYWlsQXR0YWNobWVudFxuICApOiBQcm9taXNlPHsgc2VudDogbnVtYmVyOyBmYWlsZWQ6IHN0cmluZ1tdIH0+IHtcbiAgICBjb25zdCBmYWlsZWQ6IHN0cmluZ1tdID0gW107XG4gICAgbGV0IHNlbnQgPSAwO1xuXG4gICAgZm9yIChjb25zdCByZWNpcGllbnQgb2YgcmVjaXBpZW50cykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5zZW5kRW1haWwocmVjaXBpZW50LCBzdWJqZWN0LCB0ZXh0LCB1bmRlZmluZWQsIGF0dGFjaG1lbnQpO1xuICAgICAgICBzZW50Kys7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gc2VuZCBlbWFpbCB0byAke3JlY2lwaWVudH06YCwgZXJyb3IpO1xuICAgICAgICBmYWlsZWQucHVzaChyZWNpcGllbnQpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB7IHNlbnQsIGZhaWxlZCB9O1xuICB9XG5cbiAgYXN5bmMgc2VuZEVtYWlsV2l0aFJldHJ5KFxuICAgIHRvOiBzdHJpbmcsXG4gICAgc3ViamVjdDogc3RyaW5nLFxuICAgIHRleHQ6IHN0cmluZyxcbiAgICBhdHRhY2htZW50PzogRW1haWxBdHRhY2htZW50LFxuICAgIG1heFJldHJpZXMgPSAzLFxuICAgIHJldHJ5RGVsYXkgPSAxMDAwXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGxldCBsYXN0RXJyb3I6IEVycm9yIHwgbnVsbCA9IG51bGw7XG5cbiAgICBmb3IgKGxldCBhdHRlbXB0ID0gMTsgYXR0ZW1wdCA8PSBtYXhSZXRyaWVzOyBhdHRlbXB0KyspIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuc2VuZEVtYWlsKHRvLCBzdWJqZWN0LCB0ZXh0LCB1bmRlZmluZWQsIGF0dGFjaG1lbnQpO1xuICAgICAgICByZXR1cm47IC8vIFN1Y2Nlc3NcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGxhc3RFcnJvciA9IGVycm9yIGFzIEVycm9yO1xuICAgICAgICBjb25zb2xlLndhcm4oYEVtYWlsIHNlbmQgYXR0ZW1wdCAke2F0dGVtcHR9IGZhaWxlZDpgLCBlcnJvcik7XG4gICAgICAgIFxuICAgICAgICBpZiAoYXR0ZW1wdCA8IG1heFJldHJpZXMpIHtcbiAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgcmV0cnlEZWxheSAqIGF0dGVtcHQpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIHNlbmQgZW1haWwgYWZ0ZXIgJHttYXhSZXRyaWVzfSBhdHRlbXB0czogJHtsYXN0RXJyb3I/Lm1lc3NhZ2V9YCk7XG4gIH1cblxuICAvLyBUZXN0IGhlbHBlciBtZXRob2RzXG4gIGFzeW5jIGdldFRlc3RQcm92aWRlcigpOiBQcm9taXNlPFRlc3RFbWFpbFByb3ZpZGVyPiB7XG4gICAgcmV0dXJuIHRoaXMudGVzdFByb3ZpZGVyO1xuICB9XG5cbiAgYXN5bmMgY2xlYXJFbWFpbHMoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy50ZXN0UHJvdmlkZXIuY2xlYXJFbWFpbHMoKTtcbiAgfVxuXG4gIGFzeW5jIHdhaXRGb3JFbWFpbCh0bzogc3RyaW5nLCB0aW1lb3V0PzogbnVtYmVyKSB7XG4gICAgcmV0dXJuIHRoaXMudGVzdFByb3ZpZGVyLndhaXRGb3JFbWFpbCh0bywgdGltZW91dCk7XG4gIH1cblxuICBhc3luYyBnZXRFbWFpbHMoKSB7XG4gICAgcmV0dXJuIHRoaXMudGVzdFByb3ZpZGVyLmdldEVtYWlscygpO1xuICB9XG5cbiAgYXN5bmMgY2xvc2UoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKHRoaXMudHJhbnNwb3J0ZXIpIHtcbiAgICAgIHRoaXMudHJhbnNwb3J0ZXIuY2xvc2UoKTtcbiAgICB9XG4gIH1cbn1cblxuLy8gR2xvYmFsIGluc3RhbmNlIGZvciB0ZXN0c1xubGV0IHRlc3RFbWFpbFNlcnZpY2U6IFRlc3RFbWFpbFNlcnZpY2UgfCBudWxsID0gbnVsbDtcblxuZXhwb3J0IGZ1bmN0aW9uIGdldFRlc3RFbWFpbFNlcnZpY2UoKTogVGVzdEVtYWlsU2VydmljZSB7XG4gIGlmICghdGVzdEVtYWlsU2VydmljZSkge1xuICAgIHRlc3RFbWFpbFNlcnZpY2UgPSBuZXcgVGVzdEVtYWlsU2VydmljZSgpO1xuICB9XG4gIHJldHVybiB0ZXN0RW1haWxTZXJ2aWNlO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVzZXRUZXN0RW1haWxTZXJ2aWNlKCk6IFByb21pc2U8dm9pZD4ge1xuICBpZiAodGVzdEVtYWlsU2VydmljZSkge1xuICAgIGF3YWl0IHRlc3RFbWFpbFNlcnZpY2UuY2xlYXJFbWFpbHMoKTtcbiAgICBhd2FpdCB0ZXN0RW1haWxTZXJ2aWNlLmNsb3NlKCk7XG4gICAgdGVzdEVtYWlsU2VydmljZSA9IG51bGw7XG4gIH1cbn0iXSwidmVyc2lvbiI6M30=