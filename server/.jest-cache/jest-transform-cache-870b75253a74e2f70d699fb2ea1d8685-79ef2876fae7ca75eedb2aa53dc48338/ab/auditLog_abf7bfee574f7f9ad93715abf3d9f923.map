{"version":3,"names":["cov_11zrpaiq3f","actualCoverage","logger","createAuditLog","options","f","s","req","res","next","startTime","Date","now","auditEntry","action","resourceType","resourceId","b","params","id","studentId","userId","user","ipAddress","ip","connection","remoteAddress","userAgent","headers","method","path","timestamp","requestBody","includeRequestBody","sensitiveData","body","undefined","responseStatus","duration","originalSend","send","data","statusCode","logAuditEntry","catch","error","call","entry","console","log","warn","auditLoggers","studentView","studentCreate","studentUpdate","studentDelete","parentSummaryView","parentSummaryCreate"],"sources":["/Users/michaelmcisaac/GitHub/teaching-engine2.0/server/src/middleware/auditLog.ts"],"sourcesContent":["import { Request, Response, NextFunction } from 'express';\nimport logger from '../logger';\n\ninterface AuditLogOptions {\n  action: string;\n  resourceType: 'student' | 'parent_summary' | 'lesson_plan' | 'unit_plan' | 'curriculum' | 'user';\n  sensitiveData?: boolean;\n  includeRequestBody?: boolean;\n  includeResponseStatus?: boolean;\n}\n\nexport function createAuditLog(options: AuditLogOptions) {\n  return async (req: Request, res: Response, next: NextFunction) => {\n    const startTime = Date.now();\n    const auditEntry = {\n      action: options.action,\n      resourceType: options.resourceType,\n      resourceId: req.params.id || req.params.studentId || null,\n      userId: req.user?.id || null,\n      ipAddress: req.ip || req.connection.remoteAddress || 'unknown',\n      userAgent: req.headers['user-agent'] || 'unknown',\n      method: req.method,\n      path: req.path,\n      timestamp: new Date(),\n      requestBody: options.includeRequestBody && !options.sensitiveData ? req.body : undefined,\n      responseStatus: 0,\n      duration: 0,\n    };\n\n    // Log response when it's sent\n    const originalSend = res.send;\n    res.send = function (data) {\n      auditEntry.responseStatus = res.statusCode;\n      auditEntry.duration = Date.now() - startTime;\n\n      // Log to database asynchronously\n      if (options.sensitiveData || auditEntry.responseStatus < 400) {\n        logAuditEntry(auditEntry).catch((error) => {\n          logger.error({ error, auditEntry }, 'Failed to create audit log entry');\n        });\n      }\n\n      return originalSend.call(this, data);\n    };\n\n    next();\n  };\n}\n\nasync function logAuditEntry(entry: {\n  action: string;\n  resourceType: string;\n  resourceId: string | null;\n  userId: number | null;\n  ipAddress: string;\n  userAgent: string;\n  method: string;\n  path: string;\n  timestamp: Date;\n  requestBody?: unknown;\n  responseStatus: number;\n  duration: number;\n}) {\n  try {\n    // AuditLog model archived - audit logging disabled in ETFO migration\n    console.log('Audit log entry (model archived):', {\n      action: entry.action,\n      resourceType: entry.resourceType,\n      resourceId: entry.resourceId,\n      userId: entry.userId,\n      ipAddress: entry.ipAddress,\n      userAgent: entry.userAgent,\n      method: entry.method,\n      path: entry.path,\n      requestBody: entry.requestBody ? '[LOGGED TO CONSOLE ONLY]' : null,\n      responseStatus: entry.responseStatus,\n      duration: entry.duration,\n      timestamp: entry.timestamp,\n    });\n  } catch (error) {\n    // If audit log table doesn't exist, just log to console\n    logger.warn({ entry }, 'Audit log entry (table may not exist)');\n  }\n}\n\n// Pre-configured audit loggers for different operations\nexport const auditLoggers = {\n  // Student data access\n  studentView: createAuditLog({\n    action: 'VIEW_STUDENT',\n    resourceType: 'student',\n    sensitiveData: true,\n  }),\n\n  studentCreate: createAuditLog({\n    action: 'CREATE_STUDENT',\n    resourceType: 'student',\n    sensitiveData: true,\n    includeRequestBody: true,\n  }),\n\n  studentUpdate: createAuditLog({\n    action: 'UPDATE_STUDENT',\n    resourceType: 'student',\n    sensitiveData: true,\n    includeRequestBody: true,\n  }),\n\n  studentDelete: createAuditLog({\n    action: 'DELETE_STUDENT',\n    resourceType: 'student',\n    sensitiveData: true,\n  }),\n\n  // Parent communication\n  parentSummaryView: createAuditLog({\n    action: 'VIEW_PARENT_SUMMARY',\n    resourceType: 'parent_summary',\n    sensitiveData: true,\n  }),\n\n  parentSummaryCreate: createAuditLog({\n    action: 'CREATE_PARENT_SUMMARY',\n    resourceType: 'parent_summary',\n    sensitiveData: true,\n  }),\n};\n"],"mappings":"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","ignoreList":[]}