fa9b92bd5a7027ebe45591881d7ca8ac
import { BaseConnector } from './baseConnector';
/**
 * Open Educational Resources (OER) connector
 * Searches OER Commons and other open educational resource repositories
 * Free, openly licensed educational materials
 */
export class OERConnector extends BaseConnector {
    apiKey;
    baseUrl = 'https://www.oercommons.org/api/v1';
    constructor() {
        super('oer');
        this.apiKey = process.env.OER_API_KEY || '';
        if (!this.apiKey) {
            console.warn('OER API key not configured. OER search will not be available.');
        }
    }
    async search(params) {
        if (!this.apiKey)
            return [];
        try {
            // Build OER search parameters
            const searchParams = new URLSearchParams({
                q: params.query || '',
                limit: String(params.limit || 20),
                offset: String(params.offset || 0),
                has_materials: 'true',
            });
            // Add grade level filter
            if (params.grade) {
                searchParams.append('grade_level', this.mapGradeToOER(params.grade));
            }
            // Add subject filter
            if (params.subject) {
                searchParams.append('subject', this.mapSubjectToOER(params.subject));
            }
            const url = `${this.baseUrl}/search?${searchParams.toString()}`;
            const response = await this.fetchWithTimeout(url, {
                headers: {
                    Authorization: `Bearer ${this.apiKey}`,
                    Accept: 'application/json',
                },
            }, 30000); // 30 second timeout
            if (!response.ok) {
                throw new Error(`OER API error: ${response.statusText}`);
            }
            const data = await response.json();
            // Transform OER results to our format
            const activities = data.results
                .map((item) => this.transformOERResource(item, params))
                .filter((activity) => activity !== null);
            return activities;
        }
        catch (error) {
            console.error('OER search error:', error);
            return [];
        }
    }
    async getActivityDetails(externalId) {
        if (!this.apiKey)
            return null;
        try {
            const url = `${this.baseUrl}/resources/${externalId}`;
            const response = await this.fetchWithTimeout(url, {
                headers: {
                    Authorization: `Bearer ${this.apiKey}`,
                    Accept: 'application/json',
                },
            }, 30000); // 30 second timeout
            if (!response.ok)
                return null;
            const data = await response.json();
            return this.transformOERResource(data, {});
        }
        catch (error) {
            console.error('OER getActivityDetails error:', error);
            return null;
        }
    }
    mapGradeToOER(grade) {
        // OER uses different grade level naming
        if (grade === 0)
            return 'kindergarten';
        if (grade >= 1 && grade <= 12)
            return `grade_${grade}`;
        return 'primary';
    }
    mapSubjectToOER(subject) {
        const subjectMap = {
            math: 'mathematics',
            francais: 'world_languages',
            english: 'english_language_arts',
            science: 'science',
            'social-studies': 'social_studies',
            'physical-education': 'health_physical_education',
            arts: 'arts',
        };
        return subjectMap[subject.toLowerCase()] || subject;
    }
    transformOERResource(resource, _params) {
        if (!resource)
            return null;
        // Determine activity type based on material types
        const activityType = this.inferActivityTypeFromMaterialTypes(resource.material_types || []);
        // Extract grade range
        const gradeRange = this.extractGradeRangeFromOER(resource.grade_levels || []);
        // Extract subject
        const subject = this.extractSubjectFromOER(resource.subjects || []);
        return this.transformToExternalActivity({}, {
            externalId: String(resource.id),
            url: resource.url || `https://www.oercommons.org/courses/${resource.id}`,
            title: resource.title,
            description: resource.abstract || resource.description,
            thumbnailUrl: resource.thumbnail_url,
            duration: this.estimateDurationFromDescription(resource.abstract),
            activityType,
            gradeMin: gradeRange.min,
            gradeMax: gradeRange.max,
            subject: this.normalizeSubject(subject),
            language: resource.language || 'en',
            materials: this.extractMaterialsFromDescription(resource.abstract || ''),
            technology: this.extractTechnologyRequirements(resource),
            groupSize: null,
            sourceRating: resource.rating ? resource.rating * 5 : null, // Convert to 5-star scale
            sourceReviews: resource.reviews_count || null,
            curriculumTags: this.extractStandardsFromOER(resource.standards || []),
            learningGoals: resource.learning_objectives || null,
            isFree: true,
            license: resource.license || 'Open Educational Resource',
            isActive: true,
        });
    }
    inferActivityTypeFromMaterialTypes(materialTypes) {
        const typeMap = {
            video: 'video',
            interactive: 'game',
            worksheet: 'worksheet',
            activity: 'handson',
            experiment: 'experiment',
            lesson_plan: 'worksheet',
            assessment: 'worksheet',
        };
        for (const materialType of materialTypes) {
            const normalized = materialType.toLowerCase();
            if (typeMap[normalized]) {
                return typeMap[normalized];
            }
        }
        return 'worksheet'; // default
    }
    extractGradeRangeFromOER(gradeLevels) {
        if (!gradeLevels || gradeLevels.length === 0) {
            return { min: 1, max: 1 };
        }
        const grades = [];
        for (const level of gradeLevels) {
            if (level.includes('kindergarten')) {
                grades.push(0);
            }
            else {
                const match = level.match(/\d+/);
                if (match) {
                    grades.push(parseInt(match[0]));
                }
            }
        }
        if (grades.length === 0)
            return { min: 1, max: 1 };
        return {
            min: Math.min(...grades),
            max: Math.max(...grades),
        };
    }
    extractSubjectFromOER(subjects) {
        if (!subjects || subjects.length === 0)
            return 'general';
        // Take the first subject and normalize it
        return subjects[0].toLowerCase().replace(/_/g, '-');
    }
    extractTechnologyRequirements(resource) {
        const tech = [];
        if (resource.requires_internet)
            tech.push('internet');
        if (resource.material_types?.includes('interactive'))
            tech.push('ordinateur');
        if (resource.material_types?.includes('video'))
            tech.push('projecteur');
        return tech.length > 0 ? tech : null;
    }
    estimateDurationFromDescription(description) {
        if (!description)
            return null;
        // Look for duration mentions in description
        const durationMatch = description.match(/(\d+)\s*(?:minutes?|mins?|hours?)/i);
        if (durationMatch) {
            return this.parseDuration(durationMatch[0]);
        }
        // Estimate based on content length
        const wordCount = description.split(/\s+/).length;
        if (wordCount < 100)
            return 15;
        if (wordCount < 300)
            return 25;
        return 35;
    }
    extractStandardsFromOER(standards) {
        if (!standards || standards.length === 0)
            return [];
        return standards
            .map((s) => s.notation || s.code)
            .filter((s) => s)
            .slice(0, 5); // Limit to 5 standards
    }
    extractMaterialsFromDescription(description) {
        const materials = this.extractMaterials(description);
        // Add common materials for open resources
        if (materials.length === 0) {
            materials.push('papier', 'crayons');
        }
        return materials;
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9zZXJ2aWNlcy9jb25uZWN0b3JzL29lckNvbm5lY3Rvci50cyIsIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUEwQ2hEOzs7O0dBSUc7QUFDSCxNQUFNLE9BQU8sWUFBYSxTQUFRLGFBQWE7SUFDckMsTUFBTSxDQUFTO0lBQ2YsT0FBTyxHQUFHLG1DQUFtQyxDQUFDO0lBRXREO1FBQ0UsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2IsSUFBSSxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsSUFBSSxFQUFFLENBQUM7UUFFNUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNqQixPQUFPLENBQUMsSUFBSSxDQUFDLCtEQUErRCxDQUFDLENBQUM7UUFDaEYsQ0FBQztJQUNILENBQUM7SUFFRCxLQUFLLENBQUMsTUFBTSxDQUFDLE1BQW9CO1FBQy9CLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTTtZQUFFLE9BQU8sRUFBRSxDQUFDO1FBRTVCLElBQUksQ0FBQztZQUNILDhCQUE4QjtZQUM5QixNQUFNLFlBQVksR0FBRyxJQUFJLGVBQWUsQ0FBQztnQkFDdkMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxLQUFLLElBQUksRUFBRTtnQkFDckIsS0FBSyxFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQztnQkFDakMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQztnQkFDbEMsYUFBYSxFQUFFLE1BQU07YUFDdEIsQ0FBQyxDQUFDO1lBRUgseUJBQXlCO1lBQ3pCLElBQUksTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUNqQixZQUFZLENBQUMsTUFBTSxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ3ZFLENBQUM7WUFFRCxxQkFBcUI7WUFDckIsSUFBSSxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQ25CLFlBQVksQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDdkUsQ0FBQztZQUVELE1BQU0sR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLE9BQU8sV0FBVyxZQUFZLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQztZQUVoRSxNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUU7Z0JBQ2hELE9BQU8sRUFBRTtvQkFDUCxhQUFhLEVBQUUsVUFBVSxJQUFJLENBQUMsTUFBTSxFQUFFO29CQUN0QyxNQUFNLEVBQUUsa0JBQWtCO2lCQUMzQjthQUNGLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxvQkFBb0I7WUFFL0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEVBQUUsQ0FBQztnQkFDakIsTUFBTSxJQUFJLEtBQUssQ0FBQyxrQkFBa0IsUUFBUSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUM7WUFDM0QsQ0FBQztZQUVELE1BQU0sSUFBSSxHQUFzQixNQUFNLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUV0RCxzQ0FBc0M7WUFDdEMsTUFBTSxVQUFVLEdBQXVCLElBQUksQ0FBQyxPQUFPO2lCQUNoRCxHQUFHLENBQUMsQ0FBQyxJQUFpQixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO2lCQUNuRSxNQUFNLENBQ0wsQ0FBQyxRQUFpQyxFQUFnQyxFQUFFLENBQUMsUUFBUSxLQUFLLElBQUksQ0FDdkYsQ0FBQztZQUVKLE9BQU8sVUFBZ0MsQ0FBQztRQUMxQyxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsbUJBQW1CLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDMUMsT0FBTyxFQUFFLENBQUM7UUFDWixDQUFDO0lBQ0gsQ0FBQztJQUVELEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxVQUFrQjtRQUN6QyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU07WUFBRSxPQUFPLElBQUksQ0FBQztRQUU5QixJQUFJLENBQUM7WUFDSCxNQUFNLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxPQUFPLGNBQWMsVUFBVSxFQUFFLENBQUM7WUFFdEQsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxFQUFFO2dCQUNoRCxPQUFPLEVBQUU7b0JBQ1AsYUFBYSxFQUFFLFVBQVUsSUFBSSxDQUFDLE1BQU0sRUFBRTtvQkFDdEMsTUFBTSxFQUFFLGtCQUFrQjtpQkFDM0I7YUFDRixFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsb0JBQW9CO1lBRS9CLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRTtnQkFBRSxPQUFPLElBQUksQ0FBQztZQUU5QixNQUFNLElBQUksR0FBRyxNQUFNLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNuQyxPQUFPLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFxQixDQUFDO1FBQ2pFLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQywrQkFBK0IsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUN0RCxPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7SUFDSCxDQUFDO0lBRU8sYUFBYSxDQUFDLEtBQWE7UUFDakMsd0NBQXdDO1FBQ3hDLElBQUksS0FBSyxLQUFLLENBQUM7WUFBRSxPQUFPLGNBQWMsQ0FBQztRQUN2QyxJQUFJLEtBQUssSUFBSSxDQUFDLElBQUksS0FBSyxJQUFJLEVBQUU7WUFBRSxPQUFPLFNBQVMsS0FBSyxFQUFFLENBQUM7UUFDdkQsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUVPLGVBQWUsQ0FBQyxPQUFlO1FBQ3JDLE1BQU0sVUFBVSxHQUEyQjtZQUN6QyxJQUFJLEVBQUUsYUFBYTtZQUNuQixRQUFRLEVBQUUsaUJBQWlCO1lBQzNCLE9BQU8sRUFBRSx1QkFBdUI7WUFDaEMsT0FBTyxFQUFFLFNBQVM7WUFDbEIsZ0JBQWdCLEVBQUUsZ0JBQWdCO1lBQ2xDLG9CQUFvQixFQUFFLDJCQUEyQjtZQUNqRCxJQUFJLEVBQUUsTUFBTTtTQUNiLENBQUM7UUFFRixPQUFPLFVBQVUsQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUMsSUFBSSxPQUFPLENBQUM7SUFDdEQsQ0FBQztJQUVPLG9CQUFvQixDQUMxQixRQUFxQixFQUNyQixPQUFxQjtRQUVyQixJQUFJLENBQUMsUUFBUTtZQUFFLE9BQU8sSUFBSSxDQUFDO1FBRTNCLGtEQUFrRDtRQUNsRCxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsa0NBQWtDLENBQUMsUUFBUSxDQUFDLGNBQWMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUU1RixzQkFBc0I7UUFDdEIsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixDQUFDLFFBQVEsQ0FBQyxZQUFZLElBQUksRUFBRSxDQUFDLENBQUM7UUFFOUUsa0JBQWtCO1FBQ2xCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxRQUFRLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRXBFLE9BQU8sSUFBSSxDQUFDLDJCQUEyQixDQUNyQyxFQUFzQixFQUN0QjtZQUNFLFVBQVUsRUFBRSxNQUFNLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztZQUMvQixHQUFHLEVBQUUsUUFBUSxDQUFDLEdBQUcsSUFBSSxzQ0FBc0MsUUFBUSxDQUFDLEVBQUUsRUFBRTtZQUN4RSxLQUFLLEVBQUUsUUFBUSxDQUFDLEtBQUs7WUFDckIsV0FBVyxFQUFFLFFBQVEsQ0FBQyxRQUFRLElBQUksUUFBUSxDQUFDLFdBQVc7WUFDdEQsWUFBWSxFQUFFLFFBQVEsQ0FBQyxhQUFhO1lBQ3BDLFFBQVEsRUFBRSxJQUFJLENBQUMsK0JBQStCLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQztZQUNqRSxZQUFZO1lBQ1osUUFBUSxFQUFFLFVBQVUsQ0FBQyxHQUFHO1lBQ3hCLFFBQVEsRUFBRSxVQUFVLENBQUMsR0FBRztZQUN4QixPQUFPLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQztZQUN2QyxRQUFRLEVBQUUsUUFBUSxDQUFDLFFBQVEsSUFBSSxJQUFJO1lBQ25DLFNBQVMsRUFBRSxJQUFJLENBQUMsK0JBQStCLENBQUMsUUFBUSxDQUFDLFFBQVEsSUFBSSxFQUFFLENBQUM7WUFDeEUsVUFBVSxFQUFFLElBQUksQ0FBQyw2QkFBNkIsQ0FBQyxRQUFRLENBQUM7WUFDeEQsU0FBUyxFQUFFLElBQUk7WUFDZixZQUFZLEVBQUUsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSwwQkFBMEI7WUFDdEYsYUFBYSxFQUFFLFFBQVEsQ0FBQyxhQUFhLElBQUksSUFBSTtZQUM3QyxjQUFjLEVBQUUsSUFBSSxDQUFDLHVCQUF1QixDQUFDLFFBQVEsQ0FBQyxTQUFTLElBQUksRUFBRSxDQUFDO1lBQ3RFLGFBQWEsRUFBRSxRQUFRLENBQUMsbUJBQW1CLElBQUksSUFBSTtZQUNuRCxNQUFNLEVBQUUsSUFBSTtZQUNaLE9BQU8sRUFBRSxRQUFRLENBQUMsT0FBTyxJQUFJLDJCQUEyQjtZQUN4RCxRQUFRLEVBQUUsSUFBSTtTQUNmLENBQ0YsQ0FBQztJQUNKLENBQUM7SUFFTyxrQ0FBa0MsQ0FBQyxhQUF1QjtRQUNoRSxNQUFNLE9BQU8sR0FBMkI7WUFDdEMsS0FBSyxFQUFFLE9BQU87WUFDZCxXQUFXLEVBQUUsTUFBTTtZQUNuQixTQUFTLEVBQUUsV0FBVztZQUN0QixRQUFRLEVBQUUsU0FBUztZQUNuQixVQUFVLEVBQUUsWUFBWTtZQUN4QixXQUFXLEVBQUUsV0FBVztZQUN4QixVQUFVLEVBQUUsV0FBVztTQUN4QixDQUFDO1FBRUYsS0FBSyxNQUFNLFlBQVksSUFBSSxhQUFhLEVBQUUsQ0FBQztZQUN6QyxNQUFNLFVBQVUsR0FBRyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDOUMsSUFBSSxPQUFPLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQztnQkFDeEIsT0FBTyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDN0IsQ0FBQztRQUNILENBQUM7UUFFRCxPQUFPLFdBQVcsQ0FBQyxDQUFDLFVBQVU7SUFDaEMsQ0FBQztJQUVPLHdCQUF3QixDQUFDLFdBQXFCO1FBQ3BELElBQUksQ0FBQyxXQUFXLElBQUksV0FBVyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztZQUM3QyxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUM7UUFDNUIsQ0FBQztRQUVELE1BQU0sTUFBTSxHQUFhLEVBQUUsQ0FBQztRQUU1QixLQUFLLE1BQU0sS0FBSyxJQUFJLFdBQVcsRUFBRSxDQUFDO1lBQ2hDLElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsRUFBRSxDQUFDO2dCQUNuQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2pCLENBQUM7aUJBQU0sQ0FBQztnQkFDTixNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNqQyxJQUFJLEtBQUssRUFBRSxDQUFDO29CQUNWLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2xDLENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQztRQUVELElBQUksTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDO1lBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDO1FBRW5ELE9BQU87WUFDTCxHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQztZQUN4QixHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQztTQUN6QixDQUFDO0lBQ0osQ0FBQztJQUVPLHFCQUFxQixDQUFDLFFBQWtCO1FBQzlDLElBQUksQ0FBQyxRQUFRLElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxDQUFDO1lBQUUsT0FBTyxTQUFTLENBQUM7UUFFekQsMENBQTBDO1FBQzFDLE9BQU8sUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVPLDZCQUE2QixDQUFDLFFBQXFCO1FBQ3pELE1BQU0sSUFBSSxHQUFhLEVBQUUsQ0FBQztRQUUxQixJQUFJLFFBQVEsQ0FBQyxpQkFBaUI7WUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3RELElBQUksUUFBUSxDQUFDLGNBQWMsRUFBRSxRQUFRLENBQUMsYUFBYSxDQUFDO1lBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUM5RSxJQUFJLFFBQVEsQ0FBQyxjQUFjLEVBQUUsUUFBUSxDQUFDLE9BQU8sQ0FBQztZQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFeEUsT0FBTyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDdkMsQ0FBQztJQUVPLCtCQUErQixDQUFDLFdBQW1CO1FBQ3pELElBQUksQ0FBQyxXQUFXO1lBQUUsT0FBTyxJQUFJLENBQUM7UUFFOUIsNENBQTRDO1FBQzVDLE1BQU0sYUFBYSxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsb0NBQW9DLENBQUMsQ0FBQztRQUM5RSxJQUFJLGFBQWEsRUFBRSxDQUFDO1lBQ2xCLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM5QyxDQUFDO1FBRUQsbUNBQW1DO1FBQ25DLE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ2xELElBQUksU0FBUyxHQUFHLEdBQUc7WUFBRSxPQUFPLEVBQUUsQ0FBQztRQUMvQixJQUFJLFNBQVMsR0FBRyxHQUFHO1lBQUUsT0FBTyxFQUFFLENBQUM7UUFDL0IsT0FBTyxFQUFFLENBQUM7SUFDWixDQUFDO0lBRU8sdUJBQXVCLENBQUMsU0FBd0I7UUFDdEQsSUFBSSxDQUFDLFNBQVMsSUFBSSxTQUFTLENBQUMsTUFBTSxLQUFLLENBQUM7WUFBRSxPQUFPLEVBQUUsQ0FBQztRQUVwRCxPQUFPLFNBQVM7YUFDYixHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQzthQUNoQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQzthQUNoQixLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsdUJBQXVCO0lBQ3pDLENBQUM7SUFFTywrQkFBK0IsQ0FBQyxXQUFtQjtRQUN6RCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFckQsMENBQTBDO1FBQzFDLElBQUksU0FBUyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztZQUMzQixTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUN0QyxDQUFDO1FBRUQsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztDQUNGIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9taWNoYWVsbWNpc2FhYy9HaXRIdWIvdGVhY2hpbmctZW5naW5lMi4wL3NlcnZlci9zcmMvc2VydmljZXMvY29ubmVjdG9ycy9vZXJDb25uZWN0b3IudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXh0ZXJuYWxBY3Rpdml0eSB9IGZyb20gJ0B0ZWFjaGluZy1lbmdpbmUvZGF0YWJhc2UnO1xuaW1wb3J0IHsgQmFzZUNvbm5lY3RvciB9IGZyb20gJy4vYmFzZUNvbm5lY3Rvcic7XG5pbXBvcnQgeyBTZWFyY2hQYXJhbXMgfSBmcm9tICcuLi9hY3Rpdml0eURpc2NvdmVyeVNlcnZpY2UnO1xuXG5pbnRlcmZhY2UgT0VSUmVzb3VyY2Uge1xuICBpZDogbnVtYmVyO1xuICB0aXRsZTogc3RyaW5nO1xuICBhYnN0cmFjdD86IHN0cmluZztcbiAgZGVzY3JpcHRpb24/OiBzdHJpbmc7XG4gIHVybD86IHN0cmluZztcbiAgdGh1bWJuYWlsX3VybD86IHN0cmluZztcbiAgbWF0ZXJpYWxfdHlwZXM/OiBzdHJpbmdbXTtcbiAgZ3JhZGVfbGV2ZWxzPzogc3RyaW5nW107XG4gIHN1YmplY3RzPzogc3RyaW5nW107XG4gIGtleXdvcmRzPzogc3RyaW5nW107XG4gIGxhbmd1YWdlcz86IHN0cmluZ1tdO1xuICBsYW5ndWFnZT86IHN0cmluZztcbiAgYXV0aG9ycz86IHN0cmluZ1tdO1xuICBsaWNlbnNlPzogc3RyaW5nO1xuICByYXRpbmc/OiBudW1iZXI7XG4gIHJldmlld3NfY291bnQ/OiBudW1iZXI7XG4gIHZpc2l0cz86IG51bWJlcjtcbiAgcmVxdWlyZXNfaW50ZXJuZXQ/OiBib29sZWFuO1xuICBsZWFybmluZ19vYmplY3RpdmVzPzogc3RyaW5nW107XG4gIHN0YW5kYXJkcz86IE9FUlN0YW5kYXJkW107XG59XG5cbmludGVyZmFjZSBPRVJTZWFyY2hSZXNwb25zZSB7XG4gIG1ldGE6IHtcbiAgICBwYWdpbmF0aW9uOiB7XG4gICAgICBjb3VudDogbnVtYmVyO1xuICAgICAgcGFnZTogbnVtYmVyO1xuICAgICAgcGVyX3BhZ2U6IG51bWJlcjtcbiAgICB9O1xuICB9O1xuICByZXN1bHRzOiBPRVJSZXNvdXJjZVtdO1xufVxuXG5pbnRlcmZhY2UgT0VSU3RhbmRhcmQge1xuICBub3RhdGlvbj86IHN0cmluZztcbiAgY29kZT86IHN0cmluZztcbn1cblxuLyoqXG4gKiBPcGVuIEVkdWNhdGlvbmFsIFJlc291cmNlcyAoT0VSKSBjb25uZWN0b3JcbiAqIFNlYXJjaGVzIE9FUiBDb21tb25zIGFuZCBvdGhlciBvcGVuIGVkdWNhdGlvbmFsIHJlc291cmNlIHJlcG9zaXRvcmllc1xuICogRnJlZSwgb3Blbmx5IGxpY2Vuc2VkIGVkdWNhdGlvbmFsIG1hdGVyaWFsc1xuICovXG5leHBvcnQgY2xhc3MgT0VSQ29ubmVjdG9yIGV4dGVuZHMgQmFzZUNvbm5lY3RvciB7XG4gIHByaXZhdGUgYXBpS2V5OiBzdHJpbmc7XG4gIHByaXZhdGUgYmFzZVVybCA9ICdodHRwczovL3d3dy5vZXJjb21tb25zLm9yZy9hcGkvdjEnO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCdvZXInKTtcbiAgICB0aGlzLmFwaUtleSA9IHByb2Nlc3MuZW52Lk9FUl9BUElfS0VZIHx8ICcnO1xuXG4gICAgaWYgKCF0aGlzLmFwaUtleSkge1xuICAgICAgY29uc29sZS53YXJuKCdPRVIgQVBJIGtleSBub3QgY29uZmlndXJlZC4gT0VSIHNlYXJjaCB3aWxsIG5vdCBiZSBhdmFpbGFibGUuJyk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2VhcmNoKHBhcmFtczogU2VhcmNoUGFyYW1zKTogUHJvbWlzZTxFeHRlcm5hbEFjdGl2aXR5W10+IHtcbiAgICBpZiAoIXRoaXMuYXBpS2V5KSByZXR1cm4gW107XG5cbiAgICB0cnkge1xuICAgICAgLy8gQnVpbGQgT0VSIHNlYXJjaCBwYXJhbWV0ZXJzXG4gICAgICBjb25zdCBzZWFyY2hQYXJhbXMgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHtcbiAgICAgICAgcTogcGFyYW1zLnF1ZXJ5IHx8ICcnLFxuICAgICAgICBsaW1pdDogU3RyaW5nKHBhcmFtcy5saW1pdCB8fCAyMCksXG4gICAgICAgIG9mZnNldDogU3RyaW5nKHBhcmFtcy5vZmZzZXQgfHwgMCksXG4gICAgICAgIGhhc19tYXRlcmlhbHM6ICd0cnVlJyxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBBZGQgZ3JhZGUgbGV2ZWwgZmlsdGVyXG4gICAgICBpZiAocGFyYW1zLmdyYWRlKSB7XG4gICAgICAgIHNlYXJjaFBhcmFtcy5hcHBlbmQoJ2dyYWRlX2xldmVsJywgdGhpcy5tYXBHcmFkZVRvT0VSKHBhcmFtcy5ncmFkZSkpO1xuICAgICAgfVxuXG4gICAgICAvLyBBZGQgc3ViamVjdCBmaWx0ZXJcbiAgICAgIGlmIChwYXJhbXMuc3ViamVjdCkge1xuICAgICAgICBzZWFyY2hQYXJhbXMuYXBwZW5kKCdzdWJqZWN0JywgdGhpcy5tYXBTdWJqZWN0VG9PRVIocGFyYW1zLnN1YmplY3QpKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgdXJsID0gYCR7dGhpcy5iYXNlVXJsfS9zZWFyY2g/JHtzZWFyY2hQYXJhbXMudG9TdHJpbmcoKX1gO1xuXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuZmV0Y2hXaXRoVGltZW91dCh1cmwsIHtcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0aGlzLmFwaUtleX1gLFxuICAgICAgICAgIEFjY2VwdDogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICB9LFxuICAgICAgfSwgMzAwMDApOyAvLyAzMCBzZWNvbmQgdGltZW91dFxuXG4gICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgT0VSIEFQSSBlcnJvcjogJHtyZXNwb25zZS5zdGF0dXNUZXh0fWApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBkYXRhOiBPRVJTZWFyY2hSZXNwb25zZSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcblxuICAgICAgLy8gVHJhbnNmb3JtIE9FUiByZXN1bHRzIHRvIG91ciBmb3JtYXRcbiAgICAgIGNvbnN0IGFjdGl2aXRpZXM6IEV4dGVybmFsQWN0aXZpdHlbXSA9IGRhdGEucmVzdWx0c1xuICAgICAgICAubWFwKChpdGVtOiBPRVJSZXNvdXJjZSkgPT4gdGhpcy50cmFuc2Zvcm1PRVJSZXNvdXJjZShpdGVtLCBwYXJhbXMpKVxuICAgICAgICAuZmlsdGVyKFxuICAgICAgICAgIChhY3Rpdml0eTogRXh0ZXJuYWxBY3Rpdml0eSB8IG51bGwpOiBhY3Rpdml0eSBpcyBFeHRlcm5hbEFjdGl2aXR5ID0+IGFjdGl2aXR5ICE9PSBudWxsLFxuICAgICAgICApO1xuXG4gICAgICByZXR1cm4gYWN0aXZpdGllcyBhcyBFeHRlcm5hbEFjdGl2aXR5W107XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ09FUiBzZWFyY2ggZXJyb3I6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldEFjdGl2aXR5RGV0YWlscyhleHRlcm5hbElkOiBzdHJpbmcpOiBQcm9taXNlPEV4dGVybmFsQWN0aXZpdHkgfCBudWxsPiB7XG4gICAgaWYgKCF0aGlzLmFwaUtleSkgcmV0dXJuIG51bGw7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgdXJsID0gYCR7dGhpcy5iYXNlVXJsfS9yZXNvdXJjZXMvJHtleHRlcm5hbElkfWA7XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5mZXRjaFdpdGhUaW1lb3V0KHVybCwge1xuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3RoaXMuYXBpS2V5fWAsXG4gICAgICAgICAgQWNjZXB0OiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgIH0sXG4gICAgICB9LCAzMDAwMCk7IC8vIDMwIHNlY29uZCB0aW1lb3V0XG5cbiAgICAgIGlmICghcmVzcG9uc2Uub2spIHJldHVybiBudWxsO1xuXG4gICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpO1xuICAgICAgcmV0dXJuIHRoaXMudHJhbnNmb3JtT0VSUmVzb3VyY2UoZGF0YSwge30pIGFzIEV4dGVybmFsQWN0aXZpdHk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ09FUiBnZXRBY3Rpdml0eURldGFpbHMgZXJyb3I6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBtYXBHcmFkZVRvT0VSKGdyYWRlOiBudW1iZXIpOiBzdHJpbmcge1xuICAgIC8vIE9FUiB1c2VzIGRpZmZlcmVudCBncmFkZSBsZXZlbCBuYW1pbmdcbiAgICBpZiAoZ3JhZGUgPT09IDApIHJldHVybiAna2luZGVyZ2FydGVuJztcbiAgICBpZiAoZ3JhZGUgPj0gMSAmJiBncmFkZSA8PSAxMikgcmV0dXJuIGBncmFkZV8ke2dyYWRlfWA7XG4gICAgcmV0dXJuICdwcmltYXJ5JztcbiAgfVxuXG4gIHByaXZhdGUgbWFwU3ViamVjdFRvT0VSKHN1YmplY3Q6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3Qgc3ViamVjdE1hcDogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHtcbiAgICAgIG1hdGg6ICdtYXRoZW1hdGljcycsXG4gICAgICBmcmFuY2FpczogJ3dvcmxkX2xhbmd1YWdlcycsXG4gICAgICBlbmdsaXNoOiAnZW5nbGlzaF9sYW5ndWFnZV9hcnRzJyxcbiAgICAgIHNjaWVuY2U6ICdzY2llbmNlJyxcbiAgICAgICdzb2NpYWwtc3R1ZGllcyc6ICdzb2NpYWxfc3R1ZGllcycsXG4gICAgICAncGh5c2ljYWwtZWR1Y2F0aW9uJzogJ2hlYWx0aF9waHlzaWNhbF9lZHVjYXRpb24nLFxuICAgICAgYXJ0czogJ2FydHMnLFxuICAgIH07XG5cbiAgICByZXR1cm4gc3ViamVjdE1hcFtzdWJqZWN0LnRvTG93ZXJDYXNlKCldIHx8IHN1YmplY3Q7XG4gIH1cblxuICBwcml2YXRlIHRyYW5zZm9ybU9FUlJlc291cmNlKFxuICAgIHJlc291cmNlOiBPRVJSZXNvdXJjZSxcbiAgICBfcGFyYW1zOiBTZWFyY2hQYXJhbXMsXG4gICk6IE9taXQ8RXh0ZXJuYWxBY3Rpdml0eSwgJ2lkJyB8ICdjcmVhdGVkQXQnIHwgJ3VwZGF0ZWRBdCc+IHwgbnVsbCB7XG4gICAgaWYgKCFyZXNvdXJjZSkgcmV0dXJuIG51bGw7XG5cbiAgICAvLyBEZXRlcm1pbmUgYWN0aXZpdHkgdHlwZSBiYXNlZCBvbiBtYXRlcmlhbCB0eXBlc1xuICAgIGNvbnN0IGFjdGl2aXR5VHlwZSA9IHRoaXMuaW5mZXJBY3Rpdml0eVR5cGVGcm9tTWF0ZXJpYWxUeXBlcyhyZXNvdXJjZS5tYXRlcmlhbF90eXBlcyB8fCBbXSk7XG5cbiAgICAvLyBFeHRyYWN0IGdyYWRlIHJhbmdlXG4gICAgY29uc3QgZ3JhZGVSYW5nZSA9IHRoaXMuZXh0cmFjdEdyYWRlUmFuZ2VGcm9tT0VSKHJlc291cmNlLmdyYWRlX2xldmVscyB8fCBbXSk7XG5cbiAgICAvLyBFeHRyYWN0IHN1YmplY3RcbiAgICBjb25zdCBzdWJqZWN0ID0gdGhpcy5leHRyYWN0U3ViamVjdEZyb21PRVIocmVzb3VyY2Uuc3ViamVjdHMgfHwgW10pO1xuXG4gICAgcmV0dXJuIHRoaXMudHJhbnNmb3JtVG9FeHRlcm5hbEFjdGl2aXR5KFxuICAgICAge30gYXMgRXh0ZXJuYWxBY3Rpdml0eSxcbiAgICAgIHtcbiAgICAgICAgZXh0ZXJuYWxJZDogU3RyaW5nKHJlc291cmNlLmlkKSxcbiAgICAgICAgdXJsOiByZXNvdXJjZS51cmwgfHwgYGh0dHBzOi8vd3d3Lm9lcmNvbW1vbnMub3JnL2NvdXJzZXMvJHtyZXNvdXJjZS5pZH1gLFxuICAgICAgICB0aXRsZTogcmVzb3VyY2UudGl0bGUsXG4gICAgICAgIGRlc2NyaXB0aW9uOiByZXNvdXJjZS5hYnN0cmFjdCB8fCByZXNvdXJjZS5kZXNjcmlwdGlvbixcbiAgICAgICAgdGh1bWJuYWlsVXJsOiByZXNvdXJjZS50aHVtYm5haWxfdXJsLFxuICAgICAgICBkdXJhdGlvbjogdGhpcy5lc3RpbWF0ZUR1cmF0aW9uRnJvbURlc2NyaXB0aW9uKHJlc291cmNlLmFic3RyYWN0KSxcbiAgICAgICAgYWN0aXZpdHlUeXBlLFxuICAgICAgICBncmFkZU1pbjogZ3JhZGVSYW5nZS5taW4sXG4gICAgICAgIGdyYWRlTWF4OiBncmFkZVJhbmdlLm1heCxcbiAgICAgICAgc3ViamVjdDogdGhpcy5ub3JtYWxpemVTdWJqZWN0KHN1YmplY3QpLFxuICAgICAgICBsYW5ndWFnZTogcmVzb3VyY2UubGFuZ3VhZ2UgfHwgJ2VuJyxcbiAgICAgICAgbWF0ZXJpYWxzOiB0aGlzLmV4dHJhY3RNYXRlcmlhbHNGcm9tRGVzY3JpcHRpb24ocmVzb3VyY2UuYWJzdHJhY3QgfHwgJycpLFxuICAgICAgICB0ZWNobm9sb2d5OiB0aGlzLmV4dHJhY3RUZWNobm9sb2d5UmVxdWlyZW1lbnRzKHJlc291cmNlKSxcbiAgICAgICAgZ3JvdXBTaXplOiBudWxsLFxuICAgICAgICBzb3VyY2VSYXRpbmc6IHJlc291cmNlLnJhdGluZyA/IHJlc291cmNlLnJhdGluZyAqIDUgOiBudWxsLCAvLyBDb252ZXJ0IHRvIDUtc3RhciBzY2FsZVxuICAgICAgICBzb3VyY2VSZXZpZXdzOiByZXNvdXJjZS5yZXZpZXdzX2NvdW50IHx8IG51bGwsXG4gICAgICAgIGN1cnJpY3VsdW1UYWdzOiB0aGlzLmV4dHJhY3RTdGFuZGFyZHNGcm9tT0VSKHJlc291cmNlLnN0YW5kYXJkcyB8fCBbXSksXG4gICAgICAgIGxlYXJuaW5nR29hbHM6IHJlc291cmNlLmxlYXJuaW5nX29iamVjdGl2ZXMgfHwgbnVsbCxcbiAgICAgICAgaXNGcmVlOiB0cnVlLFxuICAgICAgICBsaWNlbnNlOiByZXNvdXJjZS5saWNlbnNlIHx8ICdPcGVuIEVkdWNhdGlvbmFsIFJlc291cmNlJyxcbiAgICAgICAgaXNBY3RpdmU6IHRydWUsXG4gICAgICB9LFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGluZmVyQWN0aXZpdHlUeXBlRnJvbU1hdGVyaWFsVHlwZXMobWF0ZXJpYWxUeXBlczogc3RyaW5nW10pOiBzdHJpbmcge1xuICAgIGNvbnN0IHR5cGVNYXA6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7XG4gICAgICB2aWRlbzogJ3ZpZGVvJyxcbiAgICAgIGludGVyYWN0aXZlOiAnZ2FtZScsXG4gICAgICB3b3Jrc2hlZXQ6ICd3b3Jrc2hlZXQnLFxuICAgICAgYWN0aXZpdHk6ICdoYW5kc29uJyxcbiAgICAgIGV4cGVyaW1lbnQ6ICdleHBlcmltZW50JyxcbiAgICAgIGxlc3Nvbl9wbGFuOiAnd29ya3NoZWV0JyxcbiAgICAgIGFzc2Vzc21lbnQ6ICd3b3Jrc2hlZXQnLFxuICAgIH07XG5cbiAgICBmb3IgKGNvbnN0IG1hdGVyaWFsVHlwZSBvZiBtYXRlcmlhbFR5cGVzKSB7XG4gICAgICBjb25zdCBub3JtYWxpemVkID0gbWF0ZXJpYWxUeXBlLnRvTG93ZXJDYXNlKCk7XG4gICAgICBpZiAodHlwZU1hcFtub3JtYWxpemVkXSkge1xuICAgICAgICByZXR1cm4gdHlwZU1hcFtub3JtYWxpemVkXTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gJ3dvcmtzaGVldCc7IC8vIGRlZmF1bHRcbiAgfVxuXG4gIHByaXZhdGUgZXh0cmFjdEdyYWRlUmFuZ2VGcm9tT0VSKGdyYWRlTGV2ZWxzOiBzdHJpbmdbXSk6IHsgbWluOiBudW1iZXI7IG1heDogbnVtYmVyIH0ge1xuICAgIGlmICghZ3JhZGVMZXZlbHMgfHwgZ3JhZGVMZXZlbHMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4geyBtaW46IDEsIG1heDogMSB9O1xuICAgIH1cblxuICAgIGNvbnN0IGdyYWRlczogbnVtYmVyW10gPSBbXTtcblxuICAgIGZvciAoY29uc3QgbGV2ZWwgb2YgZ3JhZGVMZXZlbHMpIHtcbiAgICAgIGlmIChsZXZlbC5pbmNsdWRlcygna2luZGVyZ2FydGVuJykpIHtcbiAgICAgICAgZ3JhZGVzLnB1c2goMCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBtYXRjaCA9IGxldmVsLm1hdGNoKC9cXGQrLyk7XG4gICAgICAgIGlmIChtYXRjaCkge1xuICAgICAgICAgIGdyYWRlcy5wdXNoKHBhcnNlSW50KG1hdGNoWzBdKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoZ3JhZGVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHsgbWluOiAxLCBtYXg6IDEgfTtcblxuICAgIHJldHVybiB7XG4gICAgICBtaW46IE1hdGgubWluKC4uLmdyYWRlcyksXG4gICAgICBtYXg6IE1hdGgubWF4KC4uLmdyYWRlcyksXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgZXh0cmFjdFN1YmplY3RGcm9tT0VSKHN1YmplY3RzOiBzdHJpbmdbXSk6IHN0cmluZyB7XG4gICAgaWYgKCFzdWJqZWN0cyB8fCBzdWJqZWN0cy5sZW5ndGggPT09IDApIHJldHVybiAnZ2VuZXJhbCc7XG5cbiAgICAvLyBUYWtlIHRoZSBmaXJzdCBzdWJqZWN0IGFuZCBub3JtYWxpemUgaXRcbiAgICByZXR1cm4gc3ViamVjdHNbMF0udG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9fL2csICctJyk7XG4gIH1cblxuICBwcml2YXRlIGV4dHJhY3RUZWNobm9sb2d5UmVxdWlyZW1lbnRzKHJlc291cmNlOiBPRVJSZXNvdXJjZSk6IHN0cmluZ1tdIHwgbnVsbCB7XG4gICAgY29uc3QgdGVjaDogc3RyaW5nW10gPSBbXTtcblxuICAgIGlmIChyZXNvdXJjZS5yZXF1aXJlc19pbnRlcm5ldCkgdGVjaC5wdXNoKCdpbnRlcm5ldCcpO1xuICAgIGlmIChyZXNvdXJjZS5tYXRlcmlhbF90eXBlcz8uaW5jbHVkZXMoJ2ludGVyYWN0aXZlJykpIHRlY2gucHVzaCgnb3JkaW5hdGV1cicpO1xuICAgIGlmIChyZXNvdXJjZS5tYXRlcmlhbF90eXBlcz8uaW5jbHVkZXMoJ3ZpZGVvJykpIHRlY2gucHVzaCgncHJvamVjdGV1cicpO1xuXG4gICAgcmV0dXJuIHRlY2gubGVuZ3RoID4gMCA/IHRlY2ggOiBudWxsO1xuICB9XG5cbiAgcHJpdmF0ZSBlc3RpbWF0ZUR1cmF0aW9uRnJvbURlc2NyaXB0aW9uKGRlc2NyaXB0aW9uOiBzdHJpbmcpOiBudW1iZXIgfCBudWxsIHtcbiAgICBpZiAoIWRlc2NyaXB0aW9uKSByZXR1cm4gbnVsbDtcblxuICAgIC8vIExvb2sgZm9yIGR1cmF0aW9uIG1lbnRpb25zIGluIGRlc2NyaXB0aW9uXG4gICAgY29uc3QgZHVyYXRpb25NYXRjaCA9IGRlc2NyaXB0aW9uLm1hdGNoKC8oXFxkKylcXHMqKD86bWludXRlcz98bWlucz98aG91cnM/KS9pKTtcbiAgICBpZiAoZHVyYXRpb25NYXRjaCkge1xuICAgICAgcmV0dXJuIHRoaXMucGFyc2VEdXJhdGlvbihkdXJhdGlvbk1hdGNoWzBdKTtcbiAgICB9XG5cbiAgICAvLyBFc3RpbWF0ZSBiYXNlZCBvbiBjb250ZW50IGxlbmd0aFxuICAgIGNvbnN0IHdvcmRDb3VudCA9IGRlc2NyaXB0aW9uLnNwbGl0KC9cXHMrLykubGVuZ3RoO1xuICAgIGlmICh3b3JkQ291bnQgPCAxMDApIHJldHVybiAxNTtcbiAgICBpZiAod29yZENvdW50IDwgMzAwKSByZXR1cm4gMjU7XG4gICAgcmV0dXJuIDM1O1xuICB9XG5cbiAgcHJpdmF0ZSBleHRyYWN0U3RhbmRhcmRzRnJvbU9FUihzdGFuZGFyZHM6IE9FUlN0YW5kYXJkW10pOiBzdHJpbmdbXSB7XG4gICAgaWYgKCFzdGFuZGFyZHMgfHwgc3RhbmRhcmRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIFtdO1xuXG4gICAgcmV0dXJuIHN0YW5kYXJkc1xuICAgICAgLm1hcCgocykgPT4gcy5ub3RhdGlvbiB8fCBzLmNvZGUpXG4gICAgICAuZmlsdGVyKChzKSA9PiBzKVxuICAgICAgLnNsaWNlKDAsIDUpOyAvLyBMaW1pdCB0byA1IHN0YW5kYXJkc1xuICB9XG5cbiAgcHJpdmF0ZSBleHRyYWN0TWF0ZXJpYWxzRnJvbURlc2NyaXB0aW9uKGRlc2NyaXB0aW9uOiBzdHJpbmcpOiBzdHJpbmdbXSB7XG4gICAgY29uc3QgbWF0ZXJpYWxzID0gdGhpcy5leHRyYWN0TWF0ZXJpYWxzKGRlc2NyaXB0aW9uKTtcblxuICAgIC8vIEFkZCBjb21tb24gbWF0ZXJpYWxzIGZvciBvcGVuIHJlc291cmNlc1xuICAgIGlmIChtYXRlcmlhbHMubGVuZ3RoID09PSAwKSB7XG4gICAgICBtYXRlcmlhbHMucHVzaCgncGFwaWVyJywgJ2NyYXlvbnMnKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbWF0ZXJpYWxzO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=