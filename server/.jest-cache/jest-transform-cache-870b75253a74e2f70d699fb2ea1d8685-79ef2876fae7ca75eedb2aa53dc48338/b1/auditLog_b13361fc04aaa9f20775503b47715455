3c3fbc0b50f5f018dc57896f6285a3e7
import logger from '../logger';
export function createAuditLog(options) {
    return async (req, res, next) => {
        const startTime = Date.now();
        const auditEntry = {
            action: options.action,
            resourceType: options.resourceType,
            resourceId: req.params.id || req.params.studentId || null,
            userId: req.user?.userId ? parseInt(req.user.userId) : null,
            ipAddress: req.ip || req.connection.remoteAddress || 'unknown',
            userAgent: req.headers['user-agent'] || 'unknown',
            method: req.method,
            path: req.path,
            timestamp: new Date(),
            requestBody: options.includeRequestBody && !options.sensitiveData ? req.body : undefined,
            responseStatus: 0,
            duration: 0,
        };
        // Log response when it's sent
        const originalSend = res.send;
        res.send = function (data) {
            auditEntry.responseStatus = res.statusCode;
            auditEntry.duration = Date.now() - startTime;
            // Log to database asynchronously
            if (options.sensitiveData || auditEntry.responseStatus < 400) {
                logAuditEntry(auditEntry).catch(error => {
                    logger.error({ error, auditEntry }, 'Failed to create audit log entry');
                });
            }
            return originalSend.call(this, data);
        };
        next();
    };
}
async function logAuditEntry(entry) {
    try {
        // AuditLog model archived - audit logging disabled in ETFO migration
        console.log('Audit log entry (model archived):', {
            action: entry.action,
            resourceType: entry.resourceType,
            resourceId: entry.resourceId,
            userId: entry.userId,
            ipAddress: entry.ipAddress,
            userAgent: entry.userAgent,
            method: entry.method,
            path: entry.path,
            requestBody: entry.requestBody ? '[LOGGED TO CONSOLE ONLY]' : null,
            responseStatus: entry.responseStatus,
            duration: entry.duration,
            timestamp: entry.timestamp,
        });
    }
    catch (error) {
        // If audit log table doesn't exist, just log to console
        logger.warn({ entry }, 'Audit log entry (table may not exist)');
    }
}
// Pre-configured audit loggers for different operations
export const auditLoggers = {
    // Student data access
    studentView: createAuditLog({
        action: 'VIEW_STUDENT',
        resourceType: 'student',
        sensitiveData: true,
    }),
    studentCreate: createAuditLog({
        action: 'CREATE_STUDENT',
        resourceType: 'student',
        sensitiveData: true,
        includeRequestBody: true,
    }),
    studentUpdate: createAuditLog({
        action: 'UPDATE_STUDENT',
        resourceType: 'student',
        sensitiveData: true,
        includeRequestBody: true,
    }),
    studentDelete: createAuditLog({
        action: 'DELETE_STUDENT',
        resourceType: 'student',
        sensitiveData: true,
    }),
    // Parent communication
    parentSummaryView: createAuditLog({
        action: 'VIEW_PARENT_SUMMARY',
        resourceType: 'parent_summary',
        sensitiveData: true,
    }),
    parentSummaryCreate: createAuditLog({
        action: 'CREATE_PARENT_SUMMARY',
        resourceType: 'parent_summary',
        sensitiveData: true,
    }),
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9taWRkbGV3YXJlL2F1ZGl0TG9nLnRzIiwibWFwcGluZ3MiOiJBQUNBLE9BQU8sTUFBTSxNQUFNLFdBQVcsQ0FBQztBQWdCL0IsTUFBTSxVQUFVLGNBQWMsQ0FBQyxPQUF3QjtJQUNyRCxPQUFPLEtBQUssRUFBRSxHQUF5QixFQUFFLEdBQWEsRUFBRSxJQUFrQixFQUFFLEVBQUU7UUFDNUUsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQzdCLE1BQU0sVUFBVSxHQUFHO1lBQ2pCLE1BQU0sRUFBRSxPQUFPLENBQUMsTUFBTTtZQUN0QixZQUFZLEVBQUUsT0FBTyxDQUFDLFlBQVk7WUFDbEMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsU0FBUyxJQUFJLElBQUk7WUFDekQsTUFBTSxFQUFFLEdBQUcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSTtZQUMzRCxTQUFTLEVBQUUsR0FBRyxDQUFDLEVBQUUsSUFBSSxHQUFHLENBQUMsVUFBVSxDQUFDLGFBQWEsSUFBSSxTQUFTO1lBQzlELFNBQVMsRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxJQUFJLFNBQVM7WUFDakQsTUFBTSxFQUFFLEdBQUcsQ0FBQyxNQUFNO1lBQ2xCLElBQUksRUFBRSxHQUFHLENBQUMsSUFBSTtZQUNkLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtZQUNyQixXQUFXLEVBQUUsT0FBTyxDQUFDLGtCQUFrQixJQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsU0FBUztZQUN4RixjQUFjLEVBQUUsQ0FBQztZ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RSxxQkFBcUI7UUFDN0IsWUFBWSxFQUFFLGdCQUFnQjtRQUM5QixhQUFhLEVBQUUsSUFBSTtLQUNwQixDQUFDO0lBRUYsbUJBQW1CLEVBQUUsY0FBYyxDQUFDO1FBQ2xDLE1BQU0sRUFBRSx1QkFBdUI7UUFDL0IsWUFBWSxFQUFFLGdCQUFnQjtRQUM5QixhQUFhLEVBQUUsSUFBSTtLQUNwQixDQUFDO0NBQ0gsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWljaGFlbG1jaXNhYWMvR2l0SHViL3RlYWNoaW5nLWVuZ2luZTIuMC9zZXJ2ZXIvc3JjL21pZGRsZXdhcmUvYXVkaXRMb2cudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuLi9sb2dnZXInO1xuXG5pbnRlcmZhY2UgQXV0aGVudGljYXRlZFJlcXVlc3QgZXh0ZW5kcyBSZXF1ZXN0IHtcbiAgdXNlcj86IHtcbiAgICB1c2VySWQ6IHN0cmluZztcbiAgfTtcbn1cblxuaW50ZXJmYWNlIEF1ZGl0TG9nT3B0aW9ucyB7XG4gIGFjdGlvbjogc3RyaW5nO1xuICByZXNvdXJjZVR5cGU6ICdzdHVkZW50JyB8ICdwYXJlbnRfc3VtbWFyeScgfCAnbGVzc29uX3BsYW4nIHwgJ3VuaXRfcGxhbicgfCAnY3VycmljdWx1bScgfCAndXNlcic7XG4gIHNlbnNpdGl2ZURhdGE/OiBib29sZWFuO1xuICBpbmNsdWRlUmVxdWVzdEJvZHk/OiBib29sZWFuO1xuICBpbmNsdWRlUmVzcG9uc2VTdGF0dXM/OiBib29sZWFuO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlQXVkaXRMb2cob3B0aW9uczogQXVkaXRMb2dPcHRpb25zKSB7XG4gIHJldHVybiBhc3luYyAocmVxOiBBdXRoZW50aWNhdGVkUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICBjb25zdCBhdWRpdEVudHJ5ID0ge1xuICAgICAgYWN0aW9uOiBvcHRpb25zLmFjdGlvbixcbiAgICAgIHJlc291cmNlVHlwZTogb3B0aW9ucy5yZXNvdXJjZVR5cGUsXG4gICAgICByZXNvdXJjZUlkOiByZXEucGFyYW1zLmlkIHx8IHJlcS5wYXJhbXMuc3R1ZGVudElkIHx8IG51bGwsXG4gICAgICB1c2VySWQ6IHJlcS51c2VyPy51c2VySWQgPyBwYXJzZUludChyZXEudXNlci51c2VySWQpIDogbnVsbCxcbiAgICAgIGlwQWRkcmVzczogcmVxLmlwIHx8IHJlcS5jb25uZWN0aW9uLnJlbW90ZUFkZHJlc3MgfHwgJ3Vua25vd24nLFxuICAgICAgdXNlckFnZW50OiByZXEuaGVhZGVyc1sndXNlci1hZ2VudCddIHx8ICd1bmtub3duJyxcbiAgICAgIG1ldGhvZDogcmVxLm1ldGhvZCxcbiAgICAgIHBhdGg6IHJlcS5wYXRoLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgcmVxdWVzdEJvZHk6IG9wdGlvbnMuaW5jbHVkZVJlcXVlc3RCb2R5ICYmICFvcHRpb25zLnNlbnNpdGl2ZURhdGEgPyByZXEuYm9keSA6IHVuZGVmaW5lZCxcbiAgICAgIHJlc3BvbnNlU3RhdHVzOiAwLFxuICAgICAgZHVyYXRpb246IDAsXG4gICAgfTtcblxuICAgIC8vIExvZyByZXNwb25zZSB3aGVuIGl0J3Mgc2VudFxuICAgIGNvbnN0IG9yaWdpbmFsU2VuZCA9IHJlcy5zZW5kO1xuICAgIHJlcy5zZW5kID0gZnVuY3Rpb24oZGF0YSkge1xuICAgICAgYXVkaXRFbnRyeS5yZXNwb25zZVN0YXR1cyA9IHJlcy5zdGF0dXNDb2RlO1xuICAgICAgYXVkaXRFbnRyeS5kdXJhdGlvbiA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG5cbiAgICAgIC8vIExvZyB0byBkYXRhYmFzZSBhc3luY2hyb25vdXNseVxuICAgICAgaWYgKG9wdGlvbnMuc2Vuc2l0aXZlRGF0YSB8fCBhdWRpdEVudHJ5LnJlc3BvbnNlU3RhdHVzIDwgNDAwKSB7XG4gICAgICAgIGxvZ0F1ZGl0RW50cnkoYXVkaXRFbnRyeSkuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgICAgIGxvZ2dlci5lcnJvcih7IGVycm9yLCBhdWRpdEVudHJ5IH0sICdGYWlsZWQgdG8gY3JlYXRlIGF1ZGl0IGxvZyBlbnRyeScpO1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIG9yaWdpbmFsU2VuZC5jYWxsKHRoaXMsIGRhdGEpO1xuICAgIH07XG5cbiAgICBuZXh0KCk7XG4gIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGxvZ0F1ZGl0RW50cnkoZW50cnk6IHtcbiAgYWN0aW9uOiBzdHJpbmc7XG4gIHJlc291cmNlVHlwZTogc3RyaW5nO1xuICByZXNvdXJjZUlkOiBzdHJpbmcgfCBudWxsO1xuICB1c2VySWQ6IG51bWJlciB8IG51bGw7XG4gIGlwQWRkcmVzczogc3RyaW5nO1xuICB1c2VyQWdlbnQ6IHN0cmluZztcbiAgbWV0aG9kOiBzdHJpbmc7XG4gIHBhdGg6IHN0cmluZztcbiAgdGltZXN0YW1wOiBEYXRlO1xuICByZXF1ZXN0Qm9keT86IHVua25vd247XG4gIHJlc3BvbnNlU3RhdHVzOiBudW1iZXI7XG4gIGR1cmF0aW9uOiBudW1iZXI7XG59KSB7XG4gIHRyeSB7XG4gICAgLy8gQXVkaXRMb2cgbW9kZWwgYXJjaGl2ZWQgLSBhdWRpdCBsb2dnaW5nIGRpc2FibGVkIGluIEVURk8gbWlncmF0aW9uXG4gICAgY29uc29sZS5sb2coJ0F1ZGl0IGxvZyBlbnRyeSAobW9kZWwgYXJjaGl2ZWQpOicsIHtcbiAgICAgIGFjdGlvbjogZW50cnkuYWN0aW9uLFxuICAgICAgcmVzb3VyY2VUeXBlOiBlbnRyeS5yZXNvdXJjZVR5cGUsXG4gICAgICByZXNvdXJjZUlkOiBlbnRyeS5yZXNvdXJjZUlkLFxuICAgICAgdXNlcklkOiBlbnRyeS51c2VySWQsXG4gICAgICBpcEFkZHJlc3M6IGVudHJ5LmlwQWRkcmVzcyxcbiAgICAgIHVzZXJBZ2VudDogZW50cnkudXNlckFnZW50LFxuICAgICAgbWV0aG9kOiBlbnRyeS5tZXRob2QsXG4gICAgICBwYXRoOiBlbnRyeS5wYXRoLFxuICAgICAgcmVxdWVzdEJvZHk6IGVudHJ5LnJlcXVlc3RCb2R5ID8gJ1tMT0dHRUQgVE8gQ09OU09MRSBPTkxZXScgOiBudWxsLFxuICAgICAgcmVzcG9uc2VTdGF0dXM6IGVudHJ5LnJlc3BvbnNlU3RhdHVzLFxuICAgICAgZHVyYXRpb246IGVudHJ5LmR1cmF0aW9uLFxuICAgICAgdGltZXN0YW1wOiBlbnRyeS50aW1lc3RhbXAsXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgLy8gSWYgYXVkaXQgbG9nIHRhYmxlIGRvZXNuJ3QgZXhpc3QsIGp1c3QgbG9nIHRvIGNvbnNvbGVcbiAgICBsb2dnZXIud2Fybih7IGVudHJ5IH0sICdBdWRpdCBsb2cgZW50cnkgKHRhYmxlIG1heSBub3QgZXhpc3QpJyk7XG4gIH1cbn1cblxuLy8gUHJlLWNvbmZpZ3VyZWQgYXVkaXQgbG9nZ2VycyBmb3IgZGlmZmVyZW50IG9wZXJhdGlvbnNcbmV4cG9ydCBjb25zdCBhdWRpdExvZ2dlcnMgPSB7XG4gIC8vIFN0dWRlbnQgZGF0YSBhY2Nlc3NcbiAgc3R1ZGVudFZpZXc6IGNyZWF0ZUF1ZGl0TG9nKHtcbiAgICBhY3Rpb246ICdWSUVXX1NUVURFTlQnLFxuICAgIHJlc291cmNlVHlwZTogJ3N0dWRlbnQnLFxuICAgIHNlbnNpdGl2ZURhdGE6IHRydWUsXG4gIH0pLFxuICBcbiAgc3R1ZGVudENyZWF0ZTogY3JlYXRlQXVkaXRMb2coe1xuICAgIGFjdGlvbjogJ0NSRUFURV9TVFVERU5UJyxcbiAgICByZXNvdXJjZVR5cGU6ICdzdHVkZW50JyxcbiAgICBzZW5zaXRpdmVEYXRhOiB0cnVlLFxuICAgIGluY2x1ZGVSZXF1ZXN0Qm9keTogdHJ1ZSxcbiAgfSksXG4gIFxuICBzdHVkZW50VXBkYXRlOiBjcmVhdGVBdWRpdExvZyh7XG4gICAgYWN0aW9uOiAnVVBEQVRFX1NUVURFTlQnLFxuICAgIHJlc291cmNlVHlwZTogJ3N0dWRlbnQnLFxuICAgIHNlbnNpdGl2ZURhdGE6IHRydWUsXG4gICAgaW5jbHVkZVJlcXVlc3RCb2R5OiB0cnVlLFxuICB9KSxcbiAgXG4gIHN0dWRlbnREZWxldGU6IGNyZWF0ZUF1ZGl0TG9nKHtcbiAgICBhY3Rpb246ICdERUxFVEVfU1RVREVOVCcsXG4gICAgcmVzb3VyY2VUeXBlOiAnc3R1ZGVudCcsXG4gICAgc2Vuc2l0aXZlRGF0YTogdHJ1ZSxcbiAgfSksXG4gIFxuICAvLyBQYXJlbnQgY29tbXVuaWNhdGlvblxuICBwYXJlbnRTdW1tYXJ5VmlldzogY3JlYXRlQXVkaXRMb2coe1xuICAgIGFjdGlvbjogJ1ZJRVdfUEFSRU5UX1NVTU1BUlknLFxuICAgIHJlc291cmNlVHlwZTogJ3BhcmVudF9zdW1tYXJ5JyxcbiAgICBzZW5zaXRpdmVEYXRhOiB0cnVlLFxuICB9KSxcbiAgXG4gIHBhcmVudFN1bW1hcnlDcmVhdGU6IGNyZWF0ZUF1ZGl0TG9nKHtcbiAgICBhY3Rpb246ICdDUkVBVEVfUEFSRU5UX1NVTU1BUlknLFxuICAgIHJlc291cmNlVHlwZTogJ3BhcmVudF9zdW1tYXJ5JyxcbiAgICBzZW5zaXRpdmVEYXRhOiB0cnVlLFxuICB9KSxcbn07Il0sInZlcnNpb24iOjN9