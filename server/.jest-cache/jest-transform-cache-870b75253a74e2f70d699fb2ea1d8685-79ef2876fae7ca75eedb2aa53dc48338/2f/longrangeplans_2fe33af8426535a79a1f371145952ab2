7256eff6c914f847912fa23ebdb20119
import { Router } from 'express';
import { prisma } from '../prisma';
import { validate } from '../validation';
import { z } from 'zod';
import { generateLongRangePlanDraft, generatePlanSuggestions } from '../services/aiDraftService';
const router = Router();
// Validation schemas
const longRangePlanCreateSchema = z.object({
    title: z.string().min(1),
    titleFr: z.string().optional(),
    academicYear: z.string().regex(/^\d{4}-\d{4}$/), // e.g., "2024-2025"
    term: z.string().optional(),
    grade: z.number().int().min(1).max(12),
    subject: z.string().min(1),
    description: z.string().optional(),
    descriptionFr: z.string().optional(),
    goals: z.string().optional(),
    goalsFr: z.string().optional(),
    themes: z.array(z.string()).optional(),
    expectationIds: z.array(z.string()).optional(),
    // ETFO-aligned fields
    overarchingQuestions: z.string().optional(),
    assessmentOverview: z.string().optional(),
    resourceNeeds: z.string().optional(),
    professionalGoals: z.string().optional(),
});
const longRangePlanUpdateSchema = longRangePlanCreateSchema.partial();
// Get all long-range plans for the authenticated user
router.get('/', async (req, res, _next) => {
    try {
        const userId = req.user?.id || 0;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const { academicYear, subject, grade } = req.query;
        const where = { userId };
        if (academicYear)
            where.academicYear = String(academicYear);
        if (subject)
            where.subject = String(subject);
        if (grade)
            where.grade = Number(grade);
        const plans = await prisma.longRangePlan.findMany({
            where,
            orderBy: [{ academicYear: 'desc' }, { subject: 'asc' }, { grade: 'asc' }],
            include: {
                _count: {
                    select: {
                        unitPlans: true,
                        expectations: true,
                    },
                },
            },
        });
        res.json(plans);
    }
    catch (err) {
        _next(err);
    }
});
// Get a single long-range plan
router.get('/:id', async (req, res, _next) => {
    try {
        const userId = req.user?.id || 0;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const plan = await prisma.longRangePlan.findFirst({
            where: {
                id: req.params.id,
                userId,
            },
            include: {
                expectations: {
                    include: {
                        expectation: true,
                    },
                    orderBy: {
                        expectation: { code: 'asc' },
                    },
                },
                unitPlans: {
                    orderBy: { startDate: 'asc' },
                    include: {
                        _count: {
                            select: {
                                lessonPlans: true,
                                expectations: true,
                            },
                        },
                    },
                },
            },
        });
        if (!plan) {
            return res.status(404).json({ error: 'Long-range plan not found' });
        }
        res.json(plan);
    }
    catch (err) {
        _next(err);
    }
});
// Create a new long-range plan
router.post('/', validate(longRangePlanCreateSchema), async (req, res, _next) => {
    try {
        const userId = req.user?.id || 0;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const { expectationIds, themes, ...planData } = req.body;
        const plan = await prisma.longRangePlan.create({
            data: {
                ...planData,
                userId,
                themes: themes || [],
            },
            include: {
                expectations: {
                    include: { expectation: true },
                },
                _count: {
                    select: { unitPlans: true },
                },
            },
        });
        // Link curriculum expectations if provided
        if (expectationIds && expectationIds.length > 0) {
            // Validate expectation IDs exist
            const validExpectations = await prisma.curriculumExpectation.findMany({
                where: { id: { in: expectationIds } },
                select: { id: true },
            });
            if (validExpectations.length !== expectationIds.length) {
                return res.status(400).json({
                    error: 'One or more curriculum expectations not found',
                    provided: expectationIds,
                    found: validExpectations.map((e) => e.id),
                });
            }
            await prisma.longRangePlanExpectation.createMany({
                data: expectationIds.map((expectationId) => ({
                    longRangePlanId: plan.id,
                    expectationId,
                })),
            });
            // Refetch with expectations
            const updatedPlan = await prisma.longRangePlan.findUnique({
                where: { id: plan.id },
                include: {
                    expectations: {
                        include: { expectation: true },
                    },
                    _count: {
                        select: { unitPlans: true },
                    },
                },
            });
            return res.status(201).json(updatedPlan);
        }
        res.status(201).json(plan);
    }
    catch (err) {
        _next(err);
    }
});
// Update a long-range plan
router.put('/:id', validate(longRangePlanUpdateSchema), async (req, res, _next) => {
    try {
        const userId = req.user?.id || 0;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const { expectationIds, themes, ...updateData } = req.body;
        // Verify ownership
        const existing = await prisma.longRangePlan.findFirst({
            where: { id: req.params.id, userId },
        });
        if (!existing) {
            return res.status(404).json({ error: 'Long-range plan not found' });
        }
        // Update the plan
        const plan = await prisma.longRangePlan.update({
            where: { id: req.params.id },
            data: {
                ...updateData,
                themes: themes !== undefined ? themes : existing.themes,
            },
        });
        // Update expectations if provided
        if (expectationIds !== undefined) {
            // Remove existing expectations
            await prisma.longRangePlanExpectation.deleteMany({
                where: { longRangePlanId: plan.id },
            });
            // Add new expectations
            if (expectationIds.length > 0) {
                await prisma.longRangePlanExpectation.createMany({
                    data: expectationIds.map((expectationId) => ({
                        longRangePlanId: plan.id,
                        expectationId,
                    })),
                });
            }
        }
        // Refetch with updated relationships
        const updatedPlan = await prisma.longRangePlan.findUnique({
            where: { id: plan.id },
            include: {
                expectations: {
                    include: { expectation: true },
                },
                unitPlans: {
                    orderBy: { startDate: 'asc' },
                    include: {
                        _count: {
                            select: {
                                lessonPlans: true,
                                expectations: true,
                            },
                        },
                    },
                },
            },
        });
        res.json(updatedPlan);
    }
    catch (err) {
        _next(err);
    }
});
// Delete a long-range plan
router.delete('/:id', async (req, res, _next) => {
    try {
        const userId = req.user?.id || 0;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        // Verify ownership and check for dependencies
        const plan = await prisma.longRangePlan.findFirst({
            where: { id: req.params.id, userId },
            include: {
                _count: { select: { unitPlans: true } },
            },
        });
        if (!plan) {
            return res.status(404).json({ error: 'Long-range plan not found' });
        }
        if (plan._count.unitPlans > 0) {
            return res.status(400).json({
                error: 'Cannot delete long-range plan with existing unit plans',
            });
        }
        await prisma.longRangePlan.delete({
            where: { id: req.params.id },
        });
        res.status(204).end();
    }
    catch (err) {
        _next(err);
    }
});
// Generate AI draft for long-range plan
router.post('/ai-draft', async (req, res, _next) => {
    try {
        const userId = req.user?.id || 0;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const { expectationIds, subject, grade, academicYear, termStructure } = req.body;
        if (!expectationIds || !Array.isArray(expectationIds) || expectationIds.length === 0) {
            return res.status(400).json({ error: 'Expectation IDs are required' });
        }
        // Fetch the curriculum expectations
        const expectations = await prisma.curriculumExpectation.findMany({
            where: { id: { in: expectationIds } },
        });
        if (expectations.length === 0) {
            return res.status(400).json({ error: 'No valid expectations found' });
        }
        const draft = await generateLongRangePlanDraft({
            expectations: expectations.map((exp) => ({
                code: exp.code,
                description: exp.description,
                type: 'specific', // Default to specific since we don't store this
                strand: exp.strand,
                substrand: exp.substrand || undefined,
                subject: exp.subject,
                grade: exp.grade,
            })),
            subject: subject || expectations[0].subject,
            grade: grade || expectations[0].grade,
            academicYear: academicYear || '2024-2025',
            termStructure: termStructure || 'semester',
        });
        res.json(draft);
    }
    catch (err) {
        console.error('AI draft generation error:', err);
        res.status(500).json({ error: 'Failed to generate AI draft' });
    }
});
// Generate AI suggestions for existing plan
router.post('/:id/ai-suggestions', async (req, res, _next) => {
    try {
        const userId = req.user?.id || 0;
        if (!userId) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const plan = await prisma.longRangePlan.findFirst({
            where: { id: req.params.id, userId },
            include: {
                expectations: { include: { expectation: true } },
            },
        });
        if (!plan) {
            return res.status(404).json({ error: 'Long-range plan not found' });
        }
        const existingContent = `
Title: ${plan.title}
Subject: ${plan.subject}
Grade: ${plan.grade}
Goals: ${plan.goals || 'None specified'}
Themes: ${Array.isArray(plan.themes) ? plan.themes.join(', ') : 'None specified'}
Expectations: ${plan.expectations.map((e) => `${e.expectation.code}: ${e.expectation.description}`).join('\n')}
    `;
        const suggestions = await generatePlanSuggestions('long-range', existingContent);
        res.json({ suggestions });
    }
    catch (err) {
        console.error('AI suggestions error:', err);
        res.status(500).json({ error: 'Failed to generate suggestions' });
    }
});
export default router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21pY2hhZWxtY2lzYWFjL0dpdEh1Yi90ZWFjaGluZy1lbmdpbmUyLjAvc2VydmVyL3NyYy9yb3V0ZXMvbG9uZy1yYW5nZS1wbGFucy50cyIsIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFXLE1BQU0sU0FBUyxDQUFDO0FBRTFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDbkMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN6QyxPQUFPLEVBQUUsQ0FBQyxFQUFFLE1BQU0sS0FBSyxDQUFDO0FBQ3hCLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSx1QkFBdUIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBR2pHLE1BQU0sTUFBTSxHQUFHLE1BQU0sRUFBRSxDQUFDO0FBRXhCLHFCQUFxQjtBQUNyQixNQUFNLHlCQUF5QixHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDekMsS0FBSyxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ3hCLE9BQU8sRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0lBQzlCLFlBQVksRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxFQUFFLG9CQUFvQjtJQUNyRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsRUFBRTtJQUMzQixLQUFLLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO0lBQ3RDLE9BQU8sRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUMxQixXQUFXLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsRUFBRTtJQUNsQyxhQUFhLEVBQUUsQ0FBQyxDQUFDLE1BQU0s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QUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSwyQkFBMkIsRUFBRSxDQUFDLENBQUM7UUFDdEUsQ0FBQztRQUVELE1BQU0sZUFBZSxHQUFHO1NBQ25CLElBQUksQ0FBQyxLQUFLO1dBQ1IsSUFBSSxDQUFDLE9BQU87U0FDZCxJQUFJLENBQUMsS0FBSztTQUNWLElBQUksQ0FBQyxLQUFLLElBQUksZ0JBQWdCO1VBQzdCLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsZ0JBQWdCO2dCQUNoRSxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsV0FBVyxDQUFDLElBQUksS0FBSyxDQUFDLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztLQUN6RyxDQUFDO1FBRUYsTUFBTSxXQUFXLEdBQUcsTUFBTSx1QkFBdUIsQ0FBQyxZQUFZLEVBQUUsZUFBZSxDQUFDLENBQUM7UUFFakYsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDYixPQUFPLENBQUMsS0FBSyxDQUFDLHVCQUF1QixFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQzVDLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLGdDQUFnQyxFQUFFLENBQUMsQ0FBQztJQUNwRSxDQUFDO0FBQ0gsQ0FBQyxDQUFDLENBQUM7QUFFSCxlQUFlLE1BQU0sQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWljaGFlbG1jaXNhYWMvR2l0SHViL3RlYWNoaW5nLWVuZ2luZTIuMC9zZXJ2ZXIvc3JjL3JvdXRlcy9sb25nLXJhbmdlLXBsYW5zLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJvdXRlciwgUmVxdWVzdCB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgUHJpc21hIH0gZnJvbSAnLi4vcHJpc21hJztcbmltcG9ydCB7IHByaXNtYSB9IGZyb20gJy4uL3ByaXNtYSc7XG5pbXBvcnQgeyB2YWxpZGF0ZSB9IGZyb20gJy4uL3ZhbGlkYXRpb24nO1xuaW1wb3J0IHsgeiB9IGZyb20gJ3pvZCc7XG5pbXBvcnQgeyBnZW5lcmF0ZUxvbmdSYW5nZVBsYW5EcmFmdCwgZ2VuZXJhdGVQbGFuU3VnZ2VzdGlvbnMgfSBmcm9tICcuLi9zZXJ2aWNlcy9haURyYWZ0U2VydmljZSc7XG5cblxuY29uc3Qgcm91dGVyID0gUm91dGVyKCk7XG5cbi8vIFZhbGlkYXRpb24gc2NoZW1hc1xuY29uc3QgbG9uZ1JhbmdlUGxhbkNyZWF0ZVNjaGVtYSA9IHoub2JqZWN0KHtcbiAgdGl0bGU6IHouc3RyaW5nKCkubWluKDEpLFxuICB0aXRsZUZyOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gIGFjYWRlbWljWWVhcjogei5zdHJpbmcoKS5yZWdleCgvXlxcZHs0fS1cXGR7NH0kLyksIC8vIGUuZy4sIFwiMjAyNC0yMDI1XCJcbiAgdGVybTogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuICBncmFkZTogei5udW1iZXIoKS5pbnQoKS5taW4oMSkubWF4KDEyKSxcbiAgc3ViamVjdDogei5zdHJpbmcoKS5taW4oMSksXG4gIGRlc2NyaXB0aW9uOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gIGRlc2NyaXB0aW9uRnI6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgZ29hbHM6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgZ29hbHNGcjogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuICB0aGVtZXM6IHouYXJyYXkoei5zdHJpbmcoKSkub3B0aW9uYWwoKSxcbiAgZXhwZWN0YXRpb25JZHM6IHouYXJyYXkoei5zdHJpbmcoKSkub3B0aW9uYWwoKSxcbiAgLy8gRVRGTy1hbGlnbmVkIGZpZWxkc1xuICBvdmVyYXJjaGluZ1F1ZXN0aW9uczogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuICBhc3Nlc3NtZW50T3ZlcnZpZXc6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgcmVzb3VyY2VOZWVkczogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuICBwcm9mZXNzaW9uYWxHb2Fsczogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxufSk7XG5cbmNvbnN0IGxvbmdSYW5nZVBsYW5VcGRhdGVTY2hlbWEgPSBsb25nUmFuZ2VQbGFuQ3JlYXRlU2NoZW1hLnBhcnRpYWwoKTtcblxuLy8gR2V0IGFsbCBsb25nLXJhbmdlIHBsYW5zIGZvciB0aGUgYXV0aGVudGljYXRlZCB1c2VyXG5yb3V0ZXIuZ2V0KCcvJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzLCBfbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyPy5pZCB8fCAwO1xuICAgIGlmICghdXNlcklkKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBlcnJvcjogJ1VuYXV0aG9yaXplZCcgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgeyBhY2FkZW1pY1llYXIsIHN1YmplY3QsIGdyYWRlIH0gPSByZXEucXVlcnk7XG5cbiAgICBjb25zdCB3aGVyZTogUHJpc21hLkxvbmdSYW5nZVBsYW5XaGVyZUlucHV0ID0geyB1c2VySWQgfTtcbiAgICBpZiAoYWNhZGVtaWNZZWFyKSB3aGVyZS5hY2FkZW1pY1llYXIgPSBTdHJpbmcoYWNhZGVtaWNZZWFyKTtcbiAgICBpZiAoc3ViamVjdCkgd2hlcmUuc3ViamVjdCA9IFN0cmluZyhzdWJqZWN0KTtcbiAgICBpZiAoZ3JhZGUpIHdoZXJlLmdyYWRlID0gTnVtYmVyKGdyYWRlKTtcblxuICAgIGNvbnN0IHBsYW5zID0gYXdhaXQgcHJpc21hLmxvbmdSYW5nZVBsYW4uZmluZE1hbnkoe1xuICAgICAgd2hlcmUsXG4gICAgICBvcmRlckJ5OiBbeyBhY2FkZW1pY1llYXI6ICdkZXNjJyB9LCB7IHN1YmplY3Q6ICdhc2MnIH0sIHsgZ3JhZGU6ICdhc2MnIH1dLFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBfY291bnQ6IHtcbiAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgIHVuaXRQbGFuczogdHJ1ZSxcbiAgICAgICAgICAgIGV4cGVjdGF0aW9uczogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHJlcy5qc29uKHBsYW5zKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgX25leHQoZXJyKTtcbiAgfVxufSk7XG5cbi8vIEdldCBhIHNpbmdsZSBsb25nLXJhbmdlIHBsYW5cbnJvdXRlci5nZXQoJy86aWQnLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXMsIF9uZXh0KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXI/LmlkIHx8IDA7XG4gICAgaWYgKCF1c2VySWQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAnVW5hdXRob3JpemVkJyB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBwbGFuID0gYXdhaXQgcHJpc21hLmxvbmdSYW5nZVBsYW4uZmluZEZpcnN0KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIGlkOiByZXEucGFyYW1zLmlkLFxuICAgICAgICB1c2VySWQsXG4gICAgICB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBleHBlY3RhdGlvbnM6IHtcbiAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICBleHBlY3RhdGlvbjogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIG9yZGVyQnk6IHtcbiAgICAgICAgICAgIGV4cGVjdGF0aW9uOiB7IGNvZGU6ICdhc2MnIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgdW5pdFBsYW5zOiB7XG4gICAgICAgICAgb3JkZXJCeTogeyBzdGFydERhdGU6ICdhc2MnIH0sXG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgX2NvdW50OiB7XG4gICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgIGxlc3NvblBsYW5zOiB0cnVlLFxuICAgICAgICAgICAgICAgIGV4cGVjdGF0aW9uczogdHJ1ZSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXBsYW4pIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IGVycm9yOiAnTG9uZy1yYW5nZSBwbGFuIG5vdCBmb3VuZCcgfSk7XG4gICAgfVxuXG4gICAgcmVzLmpzb24ocGxhbik7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIF9uZXh0KGVycik7XG4gIH1cbn0pO1xuXG4vLyBDcmVhdGUgYSBuZXcgbG9uZy1yYW5nZSBwbGFuXG5yb3V0ZXIucG9zdChcbiAgJy8nLFxuICB2YWxpZGF0ZShsb25nUmFuZ2VQbGFuQ3JlYXRlU2NoZW1hKSxcbiAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzLCBfbmV4dCkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB1c2VySWQgPSByZXEudXNlcj8uaWQgfHwgMDtcbiAgICAgIGlmICghdXNlcklkKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAnVW5hdXRob3JpemVkJyB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgeyBleHBlY3RhdGlvbklkcywgdGhlbWVzLCAuLi5wbGFuRGF0YSB9ID0gcmVxLmJvZHk7XG5cbiAgICAgIGNvbnN0IHBsYW4gPSBhd2FpdCBwcmlzbWEubG9uZ1JhbmdlUGxhbi5jcmVhdGUoe1xuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgLi4ucGxhbkRhdGEsXG4gICAgICAgICAgdXNlcklkLFxuICAgICAgICAgIHRoZW1lczogdGhlbWVzIHx8IFtdLFxuICAgICAgICB9LFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgZXhwZWN0YXRpb25zOiB7XG4gICAgICAgICAgICBpbmNsdWRlOiB7IGV4cGVjdGF0aW9uOiB0cnVlIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBfY291bnQ6IHtcbiAgICAgICAgICAgIHNlbGVjdDogeyB1bml0UGxhbnM6IHRydWUgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIExpbmsgY3VycmljdWx1bSBleHBlY3RhdGlvbnMgaWYgcHJvdmlkZWRcbiAgICAgIGlmIChleHBlY3RhdGlvbklkcyAmJiBleHBlY3RhdGlvbklkcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIC8vIFZhbGlkYXRlIGV4cGVjdGF0aW9uIElEcyBleGlzdFxuICAgICAgICBjb25zdCB2YWxpZEV4cGVjdGF0aW9ucyA9IGF3YWl0IHByaXNtYS5jdXJyaWN1bHVtRXhwZWN0YXRpb24uZmluZE1hbnkoe1xuICAgICAgICAgIHdoZXJlOiB7IGlkOiB7IGluOiBleHBlY3RhdGlvbklkcyB9IH0sXG4gICAgICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICh2YWxpZEV4cGVjdGF0aW9ucy5sZW5ndGggIT09IGV4cGVjdGF0aW9uSWRzLmxlbmd0aCkge1xuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgICBlcnJvcjogJ09uZSBvciBtb3JlIGN1cnJpY3VsdW0gZXhwZWN0YXRpb25zIG5vdCBmb3VuZCcsXG4gICAgICAgICAgICBwcm92aWRlZDogZXhwZWN0YXRpb25JZHMsXG4gICAgICAgICAgICBmb3VuZDogdmFsaWRFeHBlY3RhdGlvbnMubWFwKChlKSA9PiBlLmlkKSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IHByaXNtYS5sb25nUmFuZ2VQbGFuRXhwZWN0YXRpb24uY3JlYXRlTWFueSh7XG4gICAgICAgICAgZGF0YTogZXhwZWN0YXRpb25JZHMubWFwKChleHBlY3RhdGlvbklkOiBzdHJpbmcpID0+ICh7XG4gICAgICAgICAgICBsb25nUmFuZ2VQbGFuSWQ6IHBsYW4uaWQsXG4gICAgICAgICAgICBleHBlY3RhdGlvbklkLFxuICAgICAgICAgIH0pKSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gUmVmZXRjaCB3aXRoIGV4cGVjdGF0aW9uc1xuICAgICAgICBjb25zdCB1cGRhdGVkUGxhbiA9IGF3YWl0IHByaXNtYS5sb25nUmFuZ2VQbGFuLmZpbmRVbmlxdWUoe1xuICAgICAgICAgIHdoZXJlOiB7IGlkOiBwbGFuLmlkIH0sXG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgZXhwZWN0YXRpb25zOiB7XG4gICAgICAgICAgICAgIGluY2x1ZGU6IHsgZXhwZWN0YXRpb246IHRydWUgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBfY291bnQ6IHtcbiAgICAgICAgICAgICAgc2VsZWN0OiB7IHVuaXRQbGFuczogdHJ1ZSB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cygyMDEpLmpzb24odXBkYXRlZFBsYW4pO1xuICAgICAgfVxuXG4gICAgICByZXMuc3RhdHVzKDIwMSkuanNvbihwbGFuKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIF9uZXh0KGVycik7XG4gICAgfVxuICB9LFxuKTtcblxuLy8gVXBkYXRlIGEgbG9uZy1yYW5nZSBwbGFuXG5yb3V0ZXIucHV0KFxuICAnLzppZCcsXG4gIHZhbGlkYXRlKGxvbmdSYW5nZVBsYW5VcGRhdGVTY2hlbWEpLFxuICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXMsIF9uZXh0KSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyPy5pZCB8fCAwO1xuICAgICAgaWYgKCF1c2VySWQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICdVbmF1dGhvcml6ZWQnIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB7IGV4cGVjdGF0aW9uSWRzLCB0aGVtZXMsIC4uLnVwZGF0ZURhdGEgfSA9IHJlcS5ib2R5O1xuXG4gICAgICAvLyBWZXJpZnkgb3duZXJzaGlwXG4gICAgICBjb25zdCBleGlzdGluZyA9IGF3YWl0IHByaXNtYS5sb25nUmFuZ2VQbGFuLmZpbmRGaXJzdCh7XG4gICAgICAgIHdoZXJlOiB7IGlkOiByZXEucGFyYW1zLmlkLCB1c2VySWQgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIWV4aXN0aW5nKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IGVycm9yOiAnTG9uZy1yYW5nZSBwbGFuIG5vdCBmb3VuZCcgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIFVwZGF0ZSB0aGUgcGxhblxuICAgICAgY29uc3QgcGxhbiA9IGF3YWl0IHByaXNtYS5sb25nUmFuZ2VQbGFuLnVwZGF0ZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkOiByZXEucGFyYW1zLmlkIH0sXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAuLi51cGRhdGVEYXRhLFxuICAgICAgICAgIHRoZW1lczogdGhlbWVzICE9PSB1bmRlZmluZWQgPyB0aGVtZXMgOiBleGlzdGluZy50aGVtZXMsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgLy8gVXBkYXRlIGV4cGVjdGF0aW9ucyBpZiBwcm92aWRlZFxuICAgICAgaWYgKGV4cGVjdGF0aW9uSWRzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgLy8gUmVtb3ZlIGV4aXN0aW5nIGV4cGVjdGF0aW9uc1xuICAgICAgICBhd2FpdCBwcmlzbWEubG9uZ1JhbmdlUGxhbkV4cGVjdGF0aW9uLmRlbGV0ZU1hbnkoe1xuICAgICAgICAgIHdoZXJlOiB7IGxvbmdSYW5nZVBsYW5JZDogcGxhbi5pZCB9LFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBBZGQgbmV3IGV4cGVjdGF0aW9uc1xuICAgICAgICBpZiAoZXhwZWN0YXRpb25JZHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGF3YWl0IHByaXNtYS5sb25nUmFuZ2VQbGFuRXhwZWN0YXRpb24uY3JlYXRlTWFueSh7XG4gICAgICAgICAgICBkYXRhOiBleHBlY3RhdGlvbklkcy5tYXAoKGV4cGVjdGF0aW9uSWQ6IHN0cmluZykgPT4gKHtcbiAgICAgICAgICAgICAgbG9uZ1JhbmdlUGxhbklkOiBwbGFuLmlkLFxuICAgICAgICAgICAgICBleHBlY3RhdGlvbklkLFxuICAgICAgICAgICAgfSkpLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFJlZmV0Y2ggd2l0aCB1cGRhdGVkIHJlbGF0aW9uc2hpcHNcbiAgICAgIGNvbnN0IHVwZGF0ZWRQbGFuID0gYXdhaXQgcHJpc21hLmxvbmdSYW5nZVBsYW4uZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkOiBwbGFuLmlkIH0sXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICBleHBlY3RhdGlvbnM6IHtcbiAgICAgICAgICAgIGluY2x1ZGU6IHsgZXhwZWN0YXRpb246IHRydWUgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHVuaXRQbGFuczoge1xuICAgICAgICAgICAgb3JkZXJCeTogeyBzdGFydERhdGU6ICdhc2MnIH0sXG4gICAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICAgIF9jb3VudDoge1xuICAgICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgICAgbGVzc29uUGxhbnM6IHRydWUsXG4gICAgICAgICAgICAgICAgICBleHBlY3RhdGlvbnM6IHRydWUsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICByZXMuanNvbih1cGRhdGVkUGxhbik7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBfbmV4dChlcnIpO1xuICAgIH1cbiAgfSxcbik7XG5cbi8vIERlbGV0ZSBhIGxvbmctcmFuZ2UgcGxhblxucm91dGVyLmRlbGV0ZSgnLzppZCcsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlcywgX25leHQpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlcj8uaWQgfHwgMDtcbiAgICBpZiAoIXVzZXJJZCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICdVbmF1dGhvcml6ZWQnIH0pO1xuICAgIH1cblxuICAgIC8vIFZlcmlmeSBvd25lcnNoaXAgYW5kIGNoZWNrIGZvciBkZXBlbmRlbmNpZXNcbiAgICBjb25zdCBwbGFuID0gYXdhaXQgcHJpc21hLmxvbmdSYW5nZVBsYW4uZmluZEZpcnN0KHtcbiAgICAgIHdoZXJlOiB7IGlkOiByZXEucGFyYW1zLmlkLCB1c2VySWQgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgX2NvdW50OiB7IHNlbGVjdDogeyB1bml0UGxhbnM6IHRydWUgfSB9LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghcGxhbikge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgZXJyb3I6ICdMb25nLXJhbmdlIHBsYW4gbm90IGZvdW5kJyB9KTtcbiAgICB9XG5cbiAgICBpZiAocGxhbi5fY291bnQudW5pdFBsYW5zID4gMCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgZXJyb3I6ICdDYW5ub3QgZGVsZXRlIGxvbmctcmFuZ2UgcGxhbiB3aXRoIGV4aXN0aW5nIHVuaXQgcGxhbnMnLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgYXdhaXQgcHJpc21hLmxvbmdSYW5nZVBsYW4uZGVsZXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiByZXEucGFyYW1zLmlkIH0sXG4gICAgfSk7XG5cbiAgICByZXMuc3RhdHVzKDIwNCkuZW5kKCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIF9uZXh0KGVycik7XG4gIH1cbn0pO1xuXG4vLyBHZW5lcmF0ZSBBSSBkcmFmdCBmb3IgbG9uZy1yYW5nZSBwbGFuXG5yb3V0ZXIucG9zdCgnL2FpLWRyYWZ0JywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzLCBfbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyPy5pZCB8fCAwO1xuICAgIGlmICghdXNlcklkKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBlcnJvcjogJ1VuYXV0aG9yaXplZCcgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgeyBleHBlY3RhdGlvbklkcywgc3ViamVjdCwgZ3JhZGUsIGFjYWRlbWljWWVhciwgdGVybVN0cnVjdHVyZSB9ID0gcmVxLmJvZHk7XG5cbiAgICBpZiAoIWV4cGVjdGF0aW9uSWRzIHx8ICFBcnJheS5pc0FycmF5KGV4cGVjdGF0aW9uSWRzKSB8fCBleHBlY3RhdGlvbklkcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiAnRXhwZWN0YXRpb24gSURzIGFyZSByZXF1aXJlZCcgfSk7XG4gICAgfVxuXG4gICAgLy8gRmV0Y2ggdGhlIGN1cnJpY3VsdW0gZXhwZWN0YXRpb25zXG4gICAgY29uc3QgZXhwZWN0YXRpb25zID0gYXdhaXQgcHJpc21hLmN1cnJpY3VsdW1FeHBlY3RhdGlvbi5maW5kTWFueSh7XG4gICAgICB3aGVyZTogeyBpZDogeyBpbjogZXhwZWN0YXRpb25JZHMgfSB9LFxuICAgIH0pO1xuXG4gICAgaWYgKGV4cGVjdGF0aW9ucy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiAnTm8gdmFsaWQgZXhwZWN0YXRpb25zIGZvdW5kJyB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBkcmFmdCA9IGF3YWl0IGdlbmVyYXRlTG9uZ1JhbmdlUGxhbkRyYWZ0KHtcbiAgICAgIGV4cGVjdGF0aW9uczogZXhwZWN0YXRpb25zLm1hcCgoZXhwKSA9PiAoe1xuICAgICAgICBjb2RlOiBleHAuY29kZSxcbiAgICAgICAgZGVzY3JpcHRpb246IGV4cC5kZXNjcmlwdGlvbixcbiAgICAgICAgdHlwZTogJ3NwZWNpZmljJyBhcyBjb25zdCwgLy8gRGVmYXVsdCB0byBzcGVjaWZpYyBzaW5jZSB3ZSBkb24ndCBzdG9yZSB0aGlzXG4gICAgICAgIHN0cmFuZDogZXhwLnN0cmFuZCxcbiAgICAgICAgc3Vic3RyYW5kOiBleHAuc3Vic3RyYW5kIHx8IHVuZGVmaW5lZCxcbiAgICAgICAgc3ViamVjdDogZXhwLnN1YmplY3QsXG4gICAgICAgIGdyYWRlOiBleHAuZ3JhZGUsXG4gICAgICB9KSksXG4gICAgICBzdWJqZWN0OiBzdWJqZWN0IHx8IGV4cGVjdGF0aW9uc1swXS5zdWJqZWN0LFxuICAgICAgZ3JhZGU6IGdyYWRlIHx8IGV4cGVjdGF0aW9uc1swXS5ncmFkZSxcbiAgICAgIGFjYWRlbWljWWVhcjogYWNhZGVtaWNZZWFyIHx8ICcyMDI0LTIwMjUnLFxuICAgICAgdGVybVN0cnVjdHVyZTogdGVybVN0cnVjdHVyZSB8fCAnc2VtZXN0ZXInLFxuICAgIH0pO1xuXG4gICAgcmVzLmpzb24oZHJhZnQpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBjb25zb2xlLmVycm9yKCdBSSBkcmFmdCBnZW5lcmF0aW9uIGVycm9yOicsIGVycik7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0ZhaWxlZCB0byBnZW5lcmF0ZSBBSSBkcmFmdCcgfSk7XG4gIH1cbn0pO1xuXG4vLyBHZW5lcmF0ZSBBSSBzdWdnZXN0aW9ucyBmb3IgZXhpc3RpbmcgcGxhblxucm91dGVyLnBvc3QoJy86aWQvYWktc3VnZ2VzdGlvbnMnLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXMsIF9uZXh0KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXI/LmlkIHx8IDA7XG4gICAgaWYgKCF1c2VySWQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAnVW5hdXRob3JpemVkJyB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBwbGFuID0gYXdhaXQgcHJpc21hLmxvbmdSYW5nZVBsYW4uZmluZEZpcnN0KHtcbiAgICAgIHdoZXJlOiB7IGlkOiByZXEucGFyYW1zLmlkLCB1c2VySWQgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgZXhwZWN0YXRpb25zOiB7IGluY2x1ZGU6IHsgZXhwZWN0YXRpb246IHRydWUgfSB9LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghcGxhbikge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgZXJyb3I6ICdMb25nLXJhbmdlIHBsYW4gbm90IGZvdW5kJyB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBleGlzdGluZ0NvbnRlbnQgPSBgXG5UaXRsZTogJHtwbGFuLnRpdGxlfVxuU3ViamVjdDogJHtwbGFuLnN1YmplY3R9XG5HcmFkZTogJHtwbGFuLmdyYWRlfVxuR29hbHM6ICR7cGxhbi5nb2FscyB8fCAnTm9uZSBzcGVjaWZpZWQnfVxuVGhlbWVzOiAke0FycmF5LmlzQXJyYXkocGxhbi50aGVtZXMpID8gcGxhbi50aGVtZXMuam9pbignLCAnKSA6ICdOb25lIHNwZWNpZmllZCd9XG5FeHBlY3RhdGlvbnM6ICR7cGxhbi5leHBlY3RhdGlvbnMubWFwKChlKSA9PiBgJHtlLmV4cGVjdGF0aW9uLmNvZGV9OiAke2UuZXhwZWN0YXRpb24uZGVzY3JpcHRpb259YCkuam9pbignXFxuJyl9XG4gICAgYDtcblxuICAgIGNvbnN0IHN1Z2dlc3Rpb25zID0gYXdhaXQgZ2VuZXJhdGVQbGFuU3VnZ2VzdGlvbnMoJ2xvbmctcmFuZ2UnLCBleGlzdGluZ0NvbnRlbnQpO1xuXG4gICAgcmVzLmpzb24oeyBzdWdnZXN0aW9ucyB9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgY29uc29sZS5lcnJvcignQUkgc3VnZ2VzdGlvbnMgZXJyb3I6JywgZXJyKTtcbiAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiAnRmFpbGVkIHRvIGdlbmVyYXRlIHN1Z2dlc3Rpb25zJyB9KTtcbiAgfVxufSk7XG5cbmV4cG9ydCBkZWZhdWx0IHJvdXRlcjtcbiJdLCJ2ZXJzaW9uIjozfQ==