# Test info

- Name: ical import blocks planner and sub plan lists event
- Location: /Users/michaelmcisaac/GitHub/teaching-engine2.0/tests/e2e/subplan-ical.spec.ts:14:5

# Error details

```
Error: expect(received).toBe(expected) // Object.is equality

Expected: true
Received: false
    at /Users/michaelmcisaac/GitHub/teaching-engine2.0/tests/e2e/subplan-ical.spec.ts:48:21
```

# Page snapshot

```yaml
- heading "Teacher Planner" [level=1]
- button:
    - img
- text: Planning Tools
- link "Year Plan":
    - /url: /planner/year
    - img
    - text: Year Plan
- link "Unit Planner":
    - /url: /subjects
    - img
    - text: Unit Planner
- link "Weekly Planner":
    - /url: /planner/week
    - img
    - text: Weekly Planner
- link "Daily Planner":
    - /url: /planner/day
    - img
    - text: Daily Planner
- link "Outcomes":
    - /url: /outcomes
    - img
    - text: Outcomes
- link "Coverage":
    - /url: /coverage
    - img
    - text: Coverage
- text: Resources
- link "Notes":
    - /url: /notes
    - img
    - text: Notes
- link "Reflections":
    - /url: /reflections
    - img
    - text: Reflections
- link "Settings":
    - /url: /settings
    - img
    - text: Settings
- button "Logout":
    - img
    - text: Logout
- text: Weekly Planner TP
- heading "Weekly Planner" [level=1]
- paragraph: Dec 29 - Jan 2, 2024
- textbox: 2024-12-30
- button "Auto Fill"
- checkbox "Preserve daily buffer block" [checked]
- text: Preserve daily buffer block
- checkbox "Skip lowest priority activity on short weeks" [checked]
- text: Skip lowest priority activity on short weeks Mon Monday Tue Tuesday Wed Wednesday Thu Thursday Fri Friday ðŸš«
- paragraph: No time slots
- text: ðŸš«
- paragraph: No time slots
- text: ðŸ“… Test Event ðŸš«
- paragraph: No time slots
- text: ðŸ“‹
- paragraph: Drag activities here
- text: ðŸš«
- paragraph: No time slots
- text: ðŸ“…
- heading "No plan available for this week" [level=3]
- paragraph: Generate a lesson plan to start scheduling activities
- button "Auto Fill"
- status
- region "Notifications alt+T"
```

# Test source

```ts
   1 | import { test, expect } from '@playwright/test';
   2 | import { login, API_BASE } from './helpers';
   3 | import http from 'http';
   4 | import fs from 'fs';
   5 | import path from 'path';
   6 |
   7 | const icsPath = path.join(__dirname, '../../server/tests/fixtures/sample.ics');
   8 |
   9 | /**
  10 |  * E2E scenario: Teacher imports iCal feed, planner blocks event, and sub plan includes it
  11 |  * Previously skipped due to dependency on external iCal feed in test environment.
  12 |  * Now enabled with a local test fixture for reliable testing.
  13 |  */
  14 | test('ical import blocks planner and sub plan lists event', async ({ page }) => {
  15 |   const ics = fs.readFileSync(icsPath);
  16 |   const srv = http.createServer((req, res) => {
  17 |     res.writeHead(200, { 'Content-Type': 'text/calendar' });
  18 |     res.end(ics);
  19 |   });
  20 |   await new Promise((r) => srv.listen(0, r));
  21 |   const { port } = srv.address() as import('net').AddressInfo;
  22 |   const feedUrl = `http://127.0.0.1:${port}/sample.ics`;
  23 |
  24 |   const token = await login(page);
  25 |   await page.request.post(`${API_BASE}/api/calendar-events/sync/ical`, {
  26 |     headers: { Authorization: `Bearer ${token}` },
  27 |     data: { feedUrl },
  28 |   });
  29 |
  30 |   await page.goto('/planner');
  31 |   await page.waitForSelector('.planner-grid', { timeout: 10000 });
  32 |   await page
  33 |     .waitForResponse((r) => r.url().includes('/api/calendar-events') && r.status() === 200, {
  34 |       timeout: 5000,
  35 |     })
  36 |     .catch(() => console.log('Calendar events API timeout, proceeding...'));
  37 |   const dateInput = page.locator('input[type="date"]');
  38 |   await dateInput.waitFor({ state: 'visible' });
  39 |   await dateInput.fill('2025-01-01', { force: true });
  40 |   await page.waitForResponse(
  41 |     (r) => r.url().includes('/api/calendar-events') && r.request().method() === 'GET',
  42 |   );
  43 |   await expect(page.getByText('Test Event').first()).toBeVisible();
  44 |
  45 |   const resp = await page.request.post(`${API_BASE}/api/subplan/generate?date=2025-01-01`, {
  46 |     headers: { Authorization: `Bearer ${token}` },
  47 |   });
> 48 |   expect(resp.ok()).toBe(true);
     |                     ^ Error: expect(received).toBe(expected) // Object.is equality
  49 |
  50 |   srv.close();
  51 | });
  52 |
```
